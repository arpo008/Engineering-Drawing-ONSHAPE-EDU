"use strict";(self.webpackChunkNewton=self.webpackChunkNewton||[]).push([[88],{43693:function(e,t,i){i.d(t,{d:function(){return s}});class s{constructor(){this.activeMateConnectorMap=new Map}addMateConnector(e){e&&e.length>0&&this.activeMateConnectorMap.set(e,null)}removeMateConnector(e){if(e&&e.length>0&&this.activeMateConnectorMap.has(e)){const t=this.activeMateConnectorMap.get(e);this.activeMateConnectorMap.delete(e),t&&!t.isHidden&&t.muteIfActive()}}removeAllMateConnectors(){for(const e of this.activeMateConnectorMap.keys())this.removeMateConnector(e)}resetMateConnectors(e){this.removeAllMateConnectors();for(const t of e)this.addMateConnector(t)}isMateConnectorActive(e,t){const i=this.activeMateConnectorMap.has(e);return i&&!this.activeMateConnectorMap.get(e)&&this.activeMateConnectorMap.set(e,t),i}destroy(){this.removeAllMateConnectors()}}},51937:function(e,t,i){i.d(t,{$D:function(){return x},$R:function(){return Me},$d:function(){return Ee},CO:function(){return F},IG:function(){return ye},JO:function(){return ve},Jq:function(){return b},Mm:function(){return Ae},Ro:function(){return de},SM:function(){return me},U8:function(){return Oe},Xk:function(){return fe},_p:function(){return se},io:function(){return L},j$:function(){return Re},mI:function(){return pe},nl:function(){return De},t_:function(){return ie},uU:function(){return Ce},wN:function(){return ge},z$:function(){return Pe}});var s=i(25077),n=i(17922),r=i(26738),a=i(98061),o=i(83057),h=i(13469),c=i(81194);if(666==i.j)var l=i(16696);var u=i(60036),d=i(21592),g=i(95417);if(666==i.j)var p=i(55858);if(666==i.j)var m=i(45666);if(666==i.j)var f=i(18265);if(666==i.j)var I=i(60939);if(666==i.j)var E=i(16153);if(666==i.j)var S=i(90342);var T=i(80462),D=i(90316),M=i(72751),C=i(31286),y=i(51232);const P="value",A="expression",O="tolerance",v="icon",R="line";let w=!0,_=!1,N=!1;function b(e){w=e}function L(e){_=e}function F(e){N=e}function x(e){return"degree"===e?"°":"radian"===e?" radian":""}const B={isVisible:!0,isTwoSided:!0,priority:g.RenderOrderPriority.HIGHER,primitiveType:g.PrimitiveType.TRIANGLES,isShowThrough:!0,isDepthTested:!1,isMuted:!1,isStencilTested:!1,isStencilWritten:!1},V=[Object.assign((0,s.Z)(B),{isPickable:!0}),Object.assign((0,s.Z)(B),{isPickable:!1,priority:g.RenderOrderPriority.HIGHEST}),Object.assign((0,s.Z)(B),{isPickable:!0,priority:g.RenderOrderPriority.DEFAULT,isShowThrough:!1,isDepthTested:!0,isStencilWritten:!0}),Object.assign((0,s.Z)(B),{isPickable:!0,priority:g.RenderOrderPriority.LOWER,isMuted:!0,isStencilTested:!0})],U="value",G="expression",H="tolerance",k="icon",W="arc_length",z={isVisible:!0,isTwoSided:!0,primitiveType:g.PrimitiveType.LINES},X=[new g.NodeProperties(Object.assign({isShowThrough:!0,isDepthTested:!1,isPickable:!0,priority:g.RenderOrderPriority.LOWER,isStencilTested:!1},z)),new g.NodeProperties(Object.assign({isShowThrough:!0,isDepthTested:!1,isPickable:!1,priority:g.RenderOrderPriority.LOWER,isStencilTested:!1},z)),new g.NodeProperties(Object.assign({isShowThrough:!1,isDepthTested:!0,isPickable:!0,priority:g.RenderOrderPriority.DEFAULT,isStencilTested:!1},z)),new g.NodeProperties(Object.assign({isShowThrough:!0,isDepthTested:!1,isPickable:!1,priority:g.RenderOrderPriority.LOWER,isStencilTested:!0},z))],Z="arrows",q={isVisible:!0,isPickable:!1,isTwoSided:!0,material:g.UNLIT_COLOR_FROM_ATTRIBUTE,primitiveType:g.PrimitiveType.TRIANGLES},Y=[new g.NodeProperties(Object.assign({isShowThrough:!0,isDepthTested:!1,priority:g.RenderOrderPriority.LOWER},q)),new g.NodeProperties(Object.assign({isShowThrough:!0,isDepthTested:!1,priority:g.RenderOrderPriority.LOWER},q)),new g.NodeProperties(Object.assign({isShowThrough:!1,isDepthTested:!0,priority:g.RenderOrderPriority.DEFAULT,isStencilWritten:!0},q)),new g.NodeProperties(Object.assign({isShowThrough:!0,isDepthTested:!1,priority:g.RenderOrderPriority.LOWER,isStencilTested:!0},q))],K="witness0",j="witness1",Q="dimensionLine0",$=1.25*u.W.MAX_MODEL_SIZE,J="dt.",ee="#",te=/^\s*-?[0-9]*[.,]?[0-9]*([eE]-?[0-9]+)?[fFdD]?\s*\*?\s*[a-z]*\s*$/;var ie;function se(e){return e.includes(ee)?ie.WITH_VARIABLES:te.test(e)?ie.VALUE_ONLY:ie.WITHOUT_VARIABLES}!function(e){e[e.VALUE_ONLY=0]="VALUE_ONLY",e[e.WITH_VARIABLES=1]="WITH_VARIABLES",e[e.WITHOUT_VARIABLES=2]="WITHOUT_VARIABLES"}(ie||(ie={}));const ne=n.default.getManager();class re{constructor(e,t,i){this.valueWorldSize={height:0,width:0},this.toleranceWorldSize={height:0,width:0},this.combinedWorldSize={height:0,width:0},this.interGap=0,t&&(this.valueWorldSize.height=e*t.filledHeightPx,this.valueWorldSize.width=e*t.filledWidthPx),i&&(this.toleranceWorldSize.height=e*i.filledHeightPx,this.toleranceWorldSize.width=e*i.filledWidthPx),t&&i&&(this.interGap=ne.getNumber("DIMENSION_VALUE_TOLERANCE_OFFSET_PIXELS")*e),this.combinedWorldSize.height=Math.max(this.toleranceWorldSize.height,this.valueWorldSize.height),this.combinedWorldSize.width=this.toleranceWorldSize.width+this.valueWorldSize.width+this.interGap}getValueCorners(e,t,i,s){const n=.5*(this.combinedWorldSize.height-this.valueWorldSize.height),r=p.add(p.create(),p.scale(p.create(),t,n),e);return s&&p.add(r,r,p.scale(p.create(),i,this.toleranceWorldSize.width+this.interGap)),{lowerLeft:r,lowerRight:p.add(p.create(),p.scale(p.create(),i,this.valueWorldSize.width),r),upperLeft:p.add(p.create(),p.scale(p.create(),t,this.valueWorldSize.height),r)}}getToleranceCorners(e,t,i,s){const n=.5*(this.combinedWorldSize.height-this.toleranceWorldSize.height),r=p.add(p.create(),p.scale(p.create(),t,n),e);return s||p.add(r,r,p.scale(p.create(),i,this.valueWorldSize.width+this.interGap)),{lowerLeft:r,lowerRight:p.add(p.create(),p.scale(p.create(),i,this.toleranceWorldSize.width),r),upperLeft:p.add(p.create(),p.scale(p.create(),t,this.toleranceWorldSize.height),r)}}}class ae{constructor(){this.standardTexture=null,this.mutedTexture=null,this.mutedMaterial=null,this.mutedTextureOptions=null,this.mutedTextureText="",this.standardMaterial=(0,g.createTextureMaterial)()}destroyTextures(){this.standardTexture&&(this.standardTexture.destroy(),this.standardTexture=null),this.mutedTexture&&(this.mutedTexture.destroy(),this.mutedTexture=null)}hasTexture(){return!!this.standardTexture}getTexture(){return this.standardTexture}getStandardMaterial(){return this.standardMaterial}getMutedMaterial(e){return!this.mutedMaterial&&this.mutedTextureOptions&&(this.mutedMaterial=(0,g.createTextureMaterial)(),this.mutedTexture=(0,g.createTextureFromText)(e,this.mutedTextureText,this.mutedTextureOptions),this.mutedMaterial.ambientTexture=this.mutedTexture),this.mutedMaterial}destroyAll(){this.destroyTextures(),this.standardMaterial&&(this.standardMaterial.destroy(),this.standardMaterial=null),this.mutedMaterial&&(this.mutedMaterial.destroy(),this.mutedMaterial=null)}createTextures(e,t,i){this.destroyTextures(),this.standardTexture=(0,g.createTextureFromText)(e,t,i),this.standardMaterial.ambientTexture=this.standardTexture,this.mutedTextureOptions={...i,color:ne.getColor("DIMENSION_INACTIVE_OCCLUDED_COLOR")},this.mutedTextureText=t,this.mutedMaterial&&(this.mutedTexture=(0,g.createTextureFromText)(e,t,this.mutedTextureOptions),this.mutedMaterial.ambientTexture=this.mutedTexture)}}function oe(e,t){return e===ie.VALUE_ONLY?"":"expression-"+(e===ie.WITH_VARIABLES?"external":"internal")+(t?":bad":":normal")}function he(e){const t=(e,t)=>{const i=new g.ImageData;return i.id=oe(e,t),i.svgToStyle=function(e,t){if(e===ie.VALUE_ONLY)return"";let i=e===ie.WITH_VARIABLES?"dimension-expression":"function";return t&&(i+="-error"),i+=".svg",i}(e,t),i},i=[t(ie.WITH_VARIABLES,!1),t(ie.WITHOUT_VARIABLES,!1),t(ie.WITH_VARIABLES,!0),t(ie.WITHOUT_VARIABLES,!0)];return(0,g.createAtlasFromResources)(e,ne.getNumber("DIMENSION_ICON_SIZE_PIXELS"),i,{sourcesHaveTransparency:!0})}const ce=666==i.j?[]:null;let le=0;function ue(e,t){if(null==e.getResources().dimensionAtlas&&ce.push(t),e.getResources().dimensionAtlasCreationInitiated)return;e.getResources().dimensionAtlasCreationInitiated=!0;const i=le++;e.getResources().dimensionAtlasCreationId=i;e.getTextureAtlasFactory().getAtlas(g.DIMENSION_ATLAS,he.bind(void 0,e)).then((t=>{i===e.getResources().dimensionAtlasCreationId&&(t?(e.getResources().dimensionAtlas=t,e.getResources().dimensionMaterial.ambientTexture=t.texture,ce.forEach((e=>e())),ce.length=0):M.log.warn("Could not load texture atlas"))}),(e=>M.log.error(e)))}class de extends(666==i.j?g.UIElement:null){constructor(e,t,i){super(e),this.displayData=null,this.updateOnNextDraw=!0,this.lastPixelSizeWorld=0,this.lastFlips=[],this.lastFadeAlphaScaling=1,this.featureIsActive=!1,this.isBad=!1,this.isDriven=!1,this.value=0,this.expression="",this.expressionType=ie.VALUE_ONLY,this.hovered=!1,this.isConfigured=!1,this.lastValueProperties=null,this.lastExpressionProperties=null,this.lastToleranceProperties=null,this.valueTextureInfo=new ae,this.expressionTextureInfo=new ae,this.toleranceTextureInfo=new ae,this.textDragging=!1,this.textDragOffset=m.create(),this.preferences=null,this.selected=!1,this.pushedMoveCursor=!1,this.forPreview=t??!1,this.listenTo(this,g.UiEvents.MOUSE_ENTER+R,this.onMouseEnterLines),this.listenTo(this,g.UiEvents.MOUSE_LEAVE+R,this.onMouseLeaveLines),this.listenTo(this,g.UiEvents.CLICK+R,this.onClick),this.listenTo(this,g.UiEvents.SELECT+R,this.onSelect),this.listenTo(this,g.UiEvents.DESELECT+R,this.onDeselect),this.listenTo(this,g.UiEvents.MOUSE_ENTER+P,this.onMouseEnterText),this.listenTo(this,g.UiEvents.MOUSE_ENTER+A,this.onMouseEnterText),this.listenTo(this,g.UiEvents.MOUSE_ENTER+O,this.onMouseEnterText),this.listenTo(this,g.UiEvents.MOUSE_ENTER+v,this.onMouseEnterText),this.listenTo(this,g.UiEvents.MOUSE_LEAVE+P,this.onMouseLeaveText),this.listenTo(this,g.UiEvents.MOUSE_LEAVE+A,this.onMouseLeaveText),this.listenTo(this,g.UiEvents.MOUSE_LEAVE+O,this.onMouseLeaveText),this.listenTo(this,g.UiEvents.MOUSE_LEAVE+v,this.onMouseLeaveText),this.listenTo(this,g.UiEvents.CLICK+P,this.onClick),this.listenTo(this,g.UiEvents.CLICK+A,this.onClick),this.listenTo(this,g.UiEvents.CLICK+O,this.onClick),this.listenTo(this,g.UiEvents.CLICK+v,this.onClick),this.listenTo(this,g.UiEvents.SELECT+P,this.onSelect),this.listenTo(this,g.UiEvents.SELECT+A,this.onSelect),this.listenTo(this,g.UiEvents.SELECT+O,this.onSelect),this.listenTo(this,g.UiEvents.SELECT+v,this.onSelect),this.listenTo(this,g.UiEvents.DESELECT+P,this.onDeselect),this.listenTo(this,g.UiEvents.DESELECT+A,this.onDeselect),this.listenTo(this,g.UiEvents.DESELECT+O,this.onDeselect),this.listenTo(this,g.UiEvents.DESELECT+v,this.onDeselect),this.listenTo(this,g.UiEvents.DOUBLE_CLICK+R,this.onDoubleClick),this.listenTo(this,g.UiEvents.DOUBLE_CLICK+P,this.onDoubleClick),this.listenTo(this,g.UiEvents.DOUBLE_CLICK+A,this.onDoubleClick),this.listenTo(this,g.UiEvents.DOUBLE_CLICK+O,this.onDoubleClick),this.listenTo(this,g.UiEvents.DOUBLE_CLICK+v,this.onDoubleClick),this.listenTo(this,g.UiEvents.DRAG_START+P,this.onDragStartText),this.listenTo(this,g.UiEvents.DRAG_START+A,this.onDragStartText),this.listenTo(this,g.UiEvents.DRAG_START+O,this.onDragStartText),this.listenTo(this,g.UiEvents.DRAG_START+v,this.onDragStartText),this.listenTo(this,g.UiEvents.DRAG+P,this.onDragText),this.listenTo(this,g.UiEvents.DRAG+A,this.onDragText),this.listenTo(this,g.UiEvents.DRAG+O,this.onDragText),this.listenTo(this,g.UiEvents.DRAG+v,this.onDragText),this.listenTo(this,g.UiEvents.DRAG_STOP+P,this.onDragStopText),this.listenTo(this,g.UiEvents.DRAG_STOP+A,this.onDragStopText),this.listenTo(this,g.UiEvents.DRAG_STOP+O,this.onDragStopText),this.listenTo(this,g.UiEvents.DRAG_STOP+v,this.onDragStopText),this.listenTo(this.viewer.getEventDispatcher(),g.DIMENSION_EDIT_CLOSED,this.onDimensionEditClosed),this.listenTo(this.viewer.getEventDispatcher(),g.SHOW_DIMENSION_EXPRESSIONS_CHANGED,this.onShowExpressionsChanged),this.elementId=i??"",this.valueTextureInfo=new ae,this.expressionTextureInfo=new ae,this.toleranceTextureInfo=new ae,this.dimensionMatrix=f.create(),this.planeMatrix=f.create(),this.computedInverse=f.create(),this.appliedTransform=f.create(),this.valueNodeProperties=V.map((e=>{const t=e.isMuted?null:this.valueTextureInfo.getStandardMaterial();return new g.NodeProperties(Object.assign({material:t},e))})),this.expressionNodeProperties=V.map((e=>{const t=e.isMuted?null:this.expressionTextureInfo.getStandardMaterial();return new g.NodeProperties(Object.assign({material:t},e))})),this.toleranceNodeProperties=V.map((e=>{const t=e.isMuted?null:this.toleranceTextureInfo.getStandardMaterial();return new g.NodeProperties(Object.assign({material:t},e))})),ue(this.viewer,this.onTextureAtlasChanged.bind(this))}isDimension(){return!0}hide(){this.isHighlighted()||(super.hide(),this.hovered=!1,this.selected=!1,this.textDragging=!1)}setFeatureActive(e){this.featureIsActive=e,this.viewer.requestDraw()}setAppliedTransform(e){this.appliedTransform=e,T.w$.inverse(this.getPlaneMatrix(),this.computedInverse)}getPlaneMatrix(){return T.w$.multiply(this.appliedTransform,this.planeMatrix,f.create())}getPlaneMatrixInverse(){return this.computedInverse}onDevicePixelRatioChanged(e){this.lastValueProperties&&(this.valueTextureInfo.destroyTextures(),this.updateRawValueTexture(this.lastValueProperties.textRendered)),this.lastExpressionProperties&&(this.expressionTextureInfo.destroyTextures(),this.updateRawExpressionTexture(this.lastExpressionProperties.textRendered)),this.lastToleranceProperties&&(this.toleranceTextureInfo.destroyTextures(),this.updateRawToleranceTexture(this.lastToleranceProperties.textRendered)),ue(this.viewer,this.onTextureAtlasChanged.bind(this))}remove(){this.hovered&&!N&&this.viewer.popCursor(),this.pushedMoveCursor&&this.removeMoveCursor(),this.valueTextureInfo.destroyAll(),this.expressionTextureInfo.destroyAll(),this.toleranceTextureInfo.destroyAll(),super.remove()}hasValueChanged(e){return!this.valueTextureInfo.hasTexture()||null==this.lastValueProperties||this.lastValueProperties.textRendered!==e||this.lastValueProperties.isBad!==this.isBad||this.lastValueProperties.hoveredOrTextDragging!==(this.hovered||this.textDragging)||this.lastValueProperties.isDriven!==this.isDriven||this.lastValueProperties.isConfigured!==this.isConfigured}hasExpressionChanged(e){return!this.expressionTextureInfo.hasTexture()||null==this.lastExpressionProperties||this.lastExpressionProperties.textRendered!==e||this.lastExpressionProperties.isBad!==this.isBad||this.lastExpressionProperties.hoveredOrTextDragging!==(this.hovered||this.textDragging)||this.lastExpressionProperties.selected!==this.selected}hasToleranceChanged(e){return!this.toleranceTextureInfo.hasTexture()||null==this.lastToleranceProperties||this.lastToleranceProperties.textRendered!==e||this.lastToleranceProperties.isBad!==this.isBad||this.lastToleranceProperties.hoveredOrTextDragging!==(this.hovered||this.textDragging)||this.lastToleranceProperties.selected!==this.selected||this.lastToleranceProperties.isDriven!==this.isDriven}getPickPriority(e){return _?g.PickPriority.REDUCED_DIMENSION_PRIORITY:g.PickPriority.DIMENSION}updateDimensionMatrices(){this.displayData&&(this.updateOnNextDraw=!0,this.dimensionMatrix=this.displayData.coordinateSystem.getGlMatrix(),this.planeMatrix=this.displayData.planeMatrix.getGlMatrix(),T.w$.inverse(this.getPlaneMatrix(),this.computedInverse),this.value=this.displayData.value)}getFeatureId(){return this.displayData?this.displayData.featureId:""}getPartId(){return this.displayData?this.displayData.partId:""}getElementId(){return this.elementId}getDimensionId(){return this.displayData?this.displayData.id:""}getParameterId(){return this.displayData?this.displayData.parameterId:""}getIsAnnotationDimension(){return!!this.displayData&&this.displayData.isAnnotationDimension}getHasTolerances(){return!!this.displayData&&(this.displayData.toleranceType!==o.gkc.NONE&&this.displayData.toleranceType!==o.gkc.UNKNOWN)}canPickThrough(){return!this.isInteractionEnabled()||_}isInteractionEnabled(){return!this.forPreview&&w&&this.lastFadeAlphaScaling>0}isForPreview(){return this.forPreview}isSelected(){return this.selected}destroyAllTextures(){this.destroyValueTexture(),this.destroyExpressionTexture(),this.destroyToleranceTexture()}destroyValueTexture(){this.valueTextureInfo&&(this.valueTextureInfo.destroyTextures(),this.updateOnNextDraw=!0)}destroyExpressionTexture(){this.expressionTextureInfo&&(this.expressionTextureInfo.destroyTextures(),this.updateOnNextDraw=!0)}destroyToleranceTexture(){this.toleranceTextureInfo&&(this.toleranceTextureInfo.destroyTextures(),this.updateOnNextDraw=!0)}onDefaultUnitsChanged(){this.destroyAllTextures(),this.viewer.requestDraw()}onTextureAtlasChanged(){this.expressionType!==ie.VALUE_ONLY&&(this.updateOnNextDraw=!0,this.viewer.requestDraw())}onViewWillDraw(e,t){if(this.isHidden||!this.displayData)return;const i=this.getPosition(),s=e.getPixelSizeAtWorldPoint(this.transformPoint(this.getModelPoint(i[0],i[1]))),n=(0,g.orientText)(e,this.getVisualRightVector(),this.getVisualUpVector(),this.transform),r=this.calculateFadeAlphaScaling(e);r!==this.lastFadeAlphaScaling&&(this.lastFadeAlphaScaling=r,this.updateOnNextDraw=!0);const a=this.preferences&&this.preferences.displayLimitRangeTicks;(this.updateOnNextDraw||Math.abs(this.lastPixelSizeWorld-s)>u.W.ZERO_LENGTH||!(0,h.arraysEqual)(this.lastFlips,n)||a)&&(this.update(e,t),this.updateOnNextDraw=!1,this.lastPixelSizeWorld=s,this.lastFlips=n)}textIsReadOnly(){return this.preferences?.textReadOnly??!1}onMouseEnterText(e,t){this.textIsReadOnly()||(this.hovered=!0,this.destroyAllTextures(),this.pushMoveCursor(),(0,g.requestDraw)())}onMouseLeaveText(e,t){this.textIsReadOnly()||(this.hovered=!1,this.destroyAllTextures(),this.removeMoveCursor(),(0,g.requestDraw)())}pushMoveCursor(){N||this.pushedMoveCursor||(this.viewer.pushCursor(g.Cursor.MOVE),this.pushedMoveCursor=!0)}removeMoveCursor(){this.pushedMoveCursor&&(this.viewer.removeTopOccurrenceOfCursor(g.Cursor.MOVE),this.pushedMoveCursor=!1)}onDoubleClick(e,t){if(r.Jq.FeatureConfigurationService.getIsInConfigureFeatureMode())return;if(this.isConfigured)return void r.Jq.MessageBubbleService.showMessageWithAutoDismiss(i18n("Configured dimensions can be edited in the configuration table"));if(this.textIsReadOnly())return;const i=this.getLabelCanvasCoordinates();this.viewer.getEventDispatcher()?.trigger(g.DIMENSION_TEXT_DOUBLE_CLICKED,{featureId:this.getFeatureId(),dimensionId:this.getDimensionId(),parameterId:this.getParameterId(),positionX:i[0],positionY:i[1],dimension:this}),(0,g.requestDraw)()}onDragStartText(e,t,i){if(N)return;const s=this.mouseToDimensionCoordinates(t.mouseX,t.mouseY,t.camera);s?m.subtract(this.textDragOffset,s,this.getPosition()):m.zero(this.textDragOffset),this.textDragging=!0,this.destroyAllTextures(),i.requestDrag=!0}onDragText(e,t){if(N)return;const i=this.mouseToDimensionCoordinates(t.mouseX,t.mouseY,t.camera);i&&(m.subtract(i,i,this.textDragOffset),this.setPosition(i),this.updateOnNextDraw=!0,(0,g.requestDraw)())}onMouseEnterLines(e,t){this.textIsReadOnly()||(this.hovered=!0,this.destroyAllTextures(),N||this.viewer.pushCursor(g.Cursor.DEFAULT),(0,g.requestDraw)())}onMouseLeaveLines(e,t){this.textIsReadOnly()||(this.hovered=!1,this.destroyAllTextures(),N||this.viewer.removeTopOccurrenceOfCursor(g.Cursor.DEFAULT),(0,g.requestDraw)())}onClick(e,t,i){N||(i.requestSelectedStatus=!0);const s=this.getLabelCanvasCoordinates();this.viewer.getEventDispatcher()?.trigger(g.DIMENSION_TEXT_SINGLE_CLICKED,{featureId:this.getFeatureId(),dimensionId:this.getDimensionId(),parameterId:this.getParameterId(),positionX:s[0],positionY:s[1],dimension:this})}onSelect(e,t){r.Jq.CapabilitiesService.checkConstraintManagerCurrentlyEnabled()&&((0,g.getActiveViewerEventDispatcher)().trigger(g.PICK_CONSTRAINT_SELECTED,e.sourcePick),e.uiElement instanceof de&&(0,C.m)().trigger(y.C.CONSTRAINT_MANAGER_FOCUS_CONSTRAINT,e.uiElement.getDisplayData().id)),this.selected=!0,this.destroyAllTextures(),(0,g.requestDraw)()}onDeselect(e,t){r.Jq.CapabilitiesService.checkConstraintManagerCurrentlyEnabled()&&e.uiElement instanceof de&&(0,C.m)().trigger(y.C.CONSTRAINT_MANAGER_UNFOCUS_CONSTRAINT,e.uiElement.getDisplayData().id),this.selected=!1,this.destroyAllTextures(),(0,g.requestDraw)()}onDragStopText(e,t){if(N)return;if(""===this.getElementId())return;const i=this.getLabelPositionInPlane();this.viewer.getEventDispatcher()?.trigger(g.DIMENSION_TEXT_DRAG_ENDED,{featureId:this.getFeatureId(),dimensionId:this.getDimensionId(),parameterId:this.getParameterId(),positionX:i[0],positionY:i[1],isAnnotationDimension:this.getIsAnnotationDimension(),featureIsActive:this.featureIsActive,partId:this.getPartId()}),this.textDragging=!1,m.zero(this.textDragOffset),this.destroyAllTextures()}onDimensionEditClosed(e){!this.textIsReadOnly()&&this.hovered&&!N&&this.pushedMoveCursor&&(this.viewer.removeTopOccurrenceOfCursor(g.Cursor.MOVE),this.viewer.pushCursor(g.Cursor.MOVE),(0,g.requestDraw)())}addPointToBounds(e,t){for(let t=0;t<3;++t)if(e[t]>$||e[t]<-$)return;t.addPoint(e)}isDrivenDimension(){return this.isDriven}setIsDriven(e){this.isDriven=e,this.viewer.requestDraw()}canBeDrivenDimension(){return!0}isConfiguredDimension(){return this.isConfigured}setIsConfigured(e){this.isConfigured!==e&&(this.isConfigured=e,this.updateOnNextDraw=!0,this.viewer.requestDraw())}setExpression(e){this.expression!==e&&(this.expression=e,this.expressionType=se(e),this.updateOnNextDraw=!0,this.viewer.requestDraw())}onShowExpressionsChanged(e){this.updateOnNextDraw=!0,this.viewer.requestDraw()}getIsBad(){return this.isBad}setIsBad(e){this.isBad=e,this.updateOnNextDraw=!0,this.viewer.requestDraw()}getLabelPositionInPlane(){return[0,0]}getPlaneOrigin(){return T.w$.multiplyVec3(this.getPlaneMatrix(),[0,0,0],p.create())}getVisualVector(e){const t=this.getPlaneOrigin(),i=p.transformMat4(p.create(),e,this.getPlaneMatrix());return p.subtract(i,i,t),p.normalize(i,i)}getVisualUpVector(){return this.getVisualVector([0,1,0])}getVisualRightVector(){return this.getVisualVector([1,0,0])}getVisualNormal(){return this.getVisualVector([0,0,1])}getModelPoint(e,t){const i=T.xB.multiplyVec2(this.dimensionMatrix,[e,t],I.create());return T.w$.multiplyVec3(this.getPlaneMatrix(),[i[0],i[1],0],p.create())}getUiSelectionForText(){return new g.UISelection(this,P,"")}planeToDimensionCoordinates(e,t){const i=E.fromValues(this.dimensionMatrix[0],this.dimensionMatrix[3],this.dimensionMatrix[1],this.dimensionMatrix[4]),s=m.fromValues(this.dimensionMatrix[6],this.dimensionMatrix[7]);return m.subtract(s,m.fromValues(e,t),s),m.transformMat2(s,s,i)}mouseToDimensionCoordinates(e,t,i){const s=i.getRay(e,t),n=(0,g.intersectRayPlaneMatrix)(s,this.getPlaneMatrix()),r=T.w$.multiplyVec3(this.getPlaneMatrixInverse(),n,p.create());return r?this.planeToDimensionCoordinates(r[0],r[1]):null}getLabelCanvasCoordinates(){const e=this.getLabelPositionInPlane(),t=T.w$.multiplyVec3(this.getPlaneMatrix(),[e[0],e[1],0]),i=this.viewer.getPrimaryViewController().camera.projectWorldPointToCanvas(t),s=(0,l.x_)();return i[0]/=s,i[1]/=s,i}onAppearanceConstantsUpdated(){this.destroyAllTextures(),ue(this.viewer,this.onTextureAtlasChanged.bind(this)),this.updateOnNextDraw=!0}ensureMutedTexturePresence(e,t){!this.getIsAnnotationDimension()||this.featureIsActive||t[3].material||(t[3].material=e.getMutedMaterial(this.viewer),t[3].updateId())}updateValueDimensionComponent(e,t,i,s,n){!this.needsValueTexture()||this.lastFadeAlphaScaling<u.W.ZERO_LENGTH?this.removeDimensionComponent(U):(this.ensureMutedTexturePresence(this.valueTextureInfo,this.valueNodeProperties),this.updateDimensionComponent(U,P,(0,g.createQuad)(t,i,s,void 0,[n[0]?e.rightCoordinate:e.leftCoordinate,n[1]?e.topCoordinate:e.bottomCoordinate],[n[0]?e.leftCoordinate:e.rightCoordinate,n[1]?e.bottomCoordinate:e.topCoordinate]),this.valueNodeProperties))}updateExpressionDimensionComponent(e,t,i,s,n){if(this.expressionType===ie.VALUE_ONLY||!this.hovered&&!this.viewer.getSketch()?.showDimensionExpressions||this.lastFadeAlphaScaling<u.W.ZERO_LENGTH)return void this.removeDimensionComponent(G);this.updateExpressionTexture();const r=this.expressionTextureInfo.getTexture(),a=e*r.filledWidthPx,o=e*r.filledHeightPx,h=p.scale(p.create(),i,.5*a),c=p.scale(p.create(),s,n[1]?-o:o),l=p.subtract(p.create(),t,h),d=p.add(p.create(),t,h),m=p.add(p.create(),l,c);this.ensureMutedTexturePresence(this.expressionTextureInfo,this.expressionNodeProperties),this.updateDimensionComponent(G,A,(0,g.createQuad)(l,d,m,void 0,[n[0]?r.rightCoordinate:r.leftCoordinate,r.bottomCoordinate],[n[0]?r.leftCoordinate:r.rightCoordinate,r.topCoordinate]),this.expressionNodeProperties)}removeToleranceDimensionComponent(){this.removeDimensionComponent(H)}updateToleranceDimensionComponent(e,t,i,s,n){!this.needsToleranceTexture()||this.lastFadeAlphaScaling<u.W.ZERO_LENGTH?this.removeDimensionComponent(H):(this.ensureMutedTexturePresence(this.toleranceTextureInfo,this.toleranceNodeProperties),this.updateDimensionComponent(H,O,(0,g.createQuad)(t,i,s,void 0,[n[0]?e.rightCoordinate:e.leftCoordinate,n[1]?e.topCoordinate:e.bottomCoordinate],[n[0]?e.leftCoordinate:e.rightCoordinate,n[1]?e.bottomCoordinate:e.topCoordinate]),this.toleranceNodeProperties))}updateIconDimensionComponent(e,t,i,s,n){if(null==this.viewer.getResources().dimensionAtlas)return 0;if(this.expressionType===ie.VALUE_ONLY)return this.removeDimensionComponent(k),0;const r=this.viewer.getResources().dimensionAtlas?.getTextureCoords(oe(this.expressionType,this.isBad));if(!r)return 0;const a=e*ne.getNumber("DIMENSION_ICON_SIZE_PIXELS"),o=p.scale(p.create(),i,n[0]?-a:a),h=p.scale(p.create(),s,.5*a),c=p.scale(p.create(),s,a),l=p.subtract(p.create(),t,h),u=p.subtract(p.create(),l,o),d=p.add(p.create(),u,c),m=(0,g.createQuad)(u,l,d,void 0,[r.lowS,n[1]?r.lowT:r.highT],[r.highS,n[1]?r.highT:r.lowT]);return this.updateDimensionComponent(k,v,m,this.viewer.getResources().dimensionNodeProperties),a}updateValueTexture(e,t,i,s){const n=i??"";let r=s??"";if(!this.preferences||this.preferences&&this.preferences.displayLimitRangeText){if(this.displayData?.hasMinimumLimit){const e=(0,a.KZ)(this.displayData.minimumLimit,this.getDimensionUnits(t));r+=", "+i18n("Min")+": "+this.getRoundedDimensionValueForTextDisplay(e,t),s&&(r+=s)}if(this.displayData?.hasMaximumLimit){const e=(0,a.KZ)(this.displayData.maximumLimit,this.getDimensionUnits(t));r+=", "+i18n("Max")+": "+this.getRoundedDimensionValueForTextDisplay(e,t),s&&(r+=s)}}this.getHasTolerances()&&(r+=this.getInlineToleranceText(t,s??""));const o=this.getRoundedDimensionValueForTextDisplay(e,t);let h=n+this.convertNumberToTextWithCommasAndPadding(o,t)+r;this.hasLimitTolerance()&&(h=n),this.updateRawValueTexture(h)}updateRawValueTexture(e){if(!this.hasValueChanged(e))return;if(this.destroyValueTexture(),!this.needsValueTexture())return;this.lastValueProperties={textRendered:e,isBad:this.isBad,hoveredOrTextDragging:this.hovered||this.textDragging,selected:this.selected,isDriven:this.isDriven,isConfigured:this.isConfigured};const{borderColor:t,borderThickness:i}=this.getValueBorderProperties(),s={color:this.getValueTextColor(),font:ne.getString("DIMENSION_VALUE_FONT"),size:ne.getNumber("DIMENSION_VALUE_HEIGHT_PIXELS"),paddingWithinBorder:ne.getNumber("DIMENSION_VALUE_BACKGROUND_PADDING"),backgroundColor:this.getValueBackgroundColor(),backgroundOpacity:ne.getNumber("DIMENSION_VALUE_BACKGROUND_OPACITY"),backgroundRadius:ne.getNumber("DIMENSION_VALUE_BACKGROUND_BORDER_RADIUS"),borderColor:t,borderThickness:i,dashLength:ne.getNumber("DIMENSION_CONFIGURED_DASH_LENGTH"),dashGapLength:ne.getNumber("DIMENSION_CONFIGURED_DASH_GAP_LENGTH")};this.valueTextureInfo.createTextures(this.viewer,e,s)}updateExpressionTexture(){const e=(0,D.truncate)(this.expression,70);this.updateRawExpressionTexture(e)}updateRawExpressionTexture(e){if(!this.hasExpressionChanged(e))return;this.destroyExpressionTexture(),this.lastExpressionProperties={textRendered:e,isBad:this.isBad,hoveredOrTextDragging:this.hovered||this.textDragging,selected:this.selected};const{borderColor:t,borderThickness:i}=this.getExpressionBorderProperties();let s=ne.getNumber("DIMENSION_EXPRESSION_BACKGROUND_PADDING");i&&(s-=i);const n={color:this.getExpressionTextColor(),font:ne.getString("DIMENSION_EXPRESSION_FONT"),size:ne.getNumber("DIMENSION_EXPRESSION_HEIGHT_PIXELS"),paddingWithinBorder:s,backgroundColor:this.getExpressionBackgroundColor(),backgroundOpacity:ne.getNumber("DIMENSION_EXPRESSION_BACKGROUND_OPACITY"),backgroundRadius:ne.getNumber("DIMENSION_EXPRESSION_BACKGROUND_BORDER_RADIUS"),borderColor:t,borderThickness:i};this.expressionTextureInfo.createTextures(this.viewer,e,n)}getInlineToleranceText(e,t){return this.displayData.toleranceType===o.gkc.MIN?" MIN":this.displayData.toleranceType===o.gkc.MAX?" MAX":this.displayData.toleranceType===o.gkc.FIT||this.displayData.toleranceType===o.gkc.FIT_WITH_TOLERANCE?""!==this.displayData.fitClass?" "+this.displayData.fitClass:"":this.displayData.toleranceType!==o.gkc.SYMMETRICAL?"":"±"+this.convertDimensionValueToText(e,this.displayData.upperTolerance)+t}convertDimensionValueToText(e,t){const i=(0,a.KZ)(t,this.getDimensionUnits(e)),s=this.getRoundedDimensionValueForTextDisplay(i,e);return this.convertNumberToTextWithCommasAndPadding(s,e)}convertNumberToTextWithCommasAndPadding(e,t){let i=e+"";return(this.getHasTolerances()||this.hasPrecisionOverride())&&(i=e.toFixed(this.getPrecision(t))),d.c.convertToCommaFormatIfNeeded(i)}needsToleranceTexture(){return this.getHasTolerances()&&(this.displayData.toleranceType===o.gkc.LIMITS||this.displayData.toleranceType===o.gkc.DEVIATION||this.displayData.toleranceType===o.gkc.FIT_TOLERANCE_ONLY||this.displayData.toleranceType===o.gkc.FIT_WITH_TOLERANCE)}needsValueTexture(){return!this.hasLimitTolerance()}hasLimitTolerance(){return this.getHasTolerances()&&this.displayData.toleranceType===o.gkc.LIMITS}updateToleranceTexture(e){this.updateToleranceTextureWithSuffix(e,"")}getNumberTextWithGuaranteedPlusOrMinus(e,t,i){const s=this.convertDimensionValueToText(e,Math.abs(t));return t>(i?-u.W.ZERO_LENGTH:u.W.ZERO_LENGTH)?"+"+s:"−"+s}updateToleranceTextureWithSuffix(e,t){if(this.needsToleranceTexture()){if(this.displayData.toleranceType===o.gkc.DEVIATION||this.displayData.toleranceType===o.gkc.FIT_TOLERANCE_ONLY||this.displayData.toleranceType===o.gkc.FIT_WITH_TOLERANCE){const i=this.getNumberTextWithGuaranteedPlusOrMinus(e,this.displayData.upperTolerance,!0),s=this.getNumberTextWithGuaranteedPlusOrMinus(e,this.displayData.lowerTolerance,!1);return this.updateRawToleranceTexture(i+t+"\n"+s+t)}if(this.displayData.toleranceType===o.gkc.LIMITS){const i=this.convertDimensionValueToText(e,this.displayData.value+this.displayData.upperTolerance),s=this.convertDimensionValueToText(e,this.displayData.value+this.displayData.lowerTolerance);this.updateRawToleranceTexture(i+t+"\n"+s+t)}}}updateRawToleranceTexture(e){if(!this.hasToleranceChanged(e))return;if(this.destroyToleranceTexture(),this.lastToleranceProperties={textRendered:e,isBad:this.isBad,hoveredOrTextDragging:this.hovered||this.textDragging,selected:this.selected,isDriven:this.isDriven},!this.needsToleranceTexture())return;const{borderColor:t,borderThickness:i}=this.getValueBorderProperties(),s={color:this.getValueTextColor(),font:ne.getString("DIMENSION_VALUE_FONT"),size:ne.getNumber("DIMENSION_VALUE_HEIGHT_PIXELS"),paddingWithinBorder:ne.getNumber("DIMENSION_VALUE_BACKGROUND_PADDING"),backgroundColor:this.getValueBackgroundColor(),backgroundOpacity:ne.getNumber("DIMENSION_VALUE_BACKGROUND_OPACITY"),backgroundRadius:ne.getNumber("DIMENSION_VALUE_BACKGROUND_BORDER_RADIUS"),borderColor:t,borderThickness:0,dashLength:ne.getNumber("DIMENSION_CONFIGURED_DASH_LENGTH"),dashGapLength:ne.getNumber("DIMENSION_CONFIGURED_DASH_GAP_LENGTH")};this.toleranceTextureInfo.createTextures(this.viewer,e,s)}getValueTextColor(){let e;return e=this.preferences?.colorName?this.preferences.colorName:this.isBad?"OVERCONSTRAINED_LINE_POINT_COLOR":this.isDriven?this.shouldHighlightDimensionWithSelectedColor()?"DIMENSION_DRIVING_VALUE_TEXT_COLOR":"DIMENSION_DRIVEN_LINE_POINT_COLOR":"DIMENSION_DRIVING_VALUE_TEXT_COLOR",ne.getColor(e)}shouldHighlightDimensionWithSelectedColor(){return!(!this.selected&&this.getHighlight()?.type!==g.HighlightType.SECONDARY)}getValueBackgroundColor(){return this.shouldHighlightDimensionWithSelectedColor()?ne.getColor("DIMENSION_VALUE_SELECTED_BACKGROUND_COLOR"):this.hovered||this.textDragging?this.isDriven?ne.getColor("DIMENSION_DRIVEN_VALUE_HOVERED_BACKGROUND_COLOR"):ne.getColor("DIMENSION_DRIVING_VALUE_HOVERED_BACKGROUND_COLOR"):null}getValueBorderProperties(){return this.isConfigured?{borderColor:ne.getColor("DIMENSION_CONFIGURED_COLOR"),borderThickness:ne.getNumber("DIMENSION_CONFIGURED_BORDER_THICKNESS")}:{}}getExpressionTextColor(){let e;return e=this.isBad?this.shouldHighlightDimensionWithSelectedColor()?"DIMENSION_EXPRESSION_BAD_SELECTED_TEXT_COLOR":this.hovered||this.textDragging?"DIMENSION_EXPRESSION_BAD_HOVERED_TEXT_COLOR":"DIMENSION_EXPRESSION_BAD_TEXT_COLOR":"DIMENSION_EXPRESSION_TEXT_COLOR",ne.getColor(e)}getExpressionBackgroundColor(){let e;return e=this.isBad?this.shouldHighlightDimensionWithSelectedColor()?"DIMENSION_EXPRESSION_BAD_SELECTED_BACKGROUND_COLOR":this.hovered||this.textDragging?"DIMENSION_EXPRESSION_BAD_HOVERED_BACKGROUND_COLOR":"DIMENSION_EXPRESSION_BAD_BACKGROUND_COLOR":this.expressionType===ie.WITH_VARIABLES?this.shouldHighlightDimensionWithSelectedColor()?"DIMENSION_EXPRESSION_WITH_VARIABLES_SELECTED_BACKGROUND_COLOR":this.hovered||this.textDragging?"DIMENSION_EXPRESSION_WITH_VARIABLES_HOVERED_BACKGROUND_COLOR":"DIMENSION_EXPRESSION_WITH_VARIABLES_BACKGROUND_COLOR":this.shouldHighlightDimensionWithSelectedColor()?"DIMENSION_EXPRESSION_WITHOUT_VARIABLES_SELECTED_BACKGROUND_COLOR":this.hovered||this.textDragging?"DIMENSION_EXPRESSION_WITHOUT_VARIABLES_HOVERED_BACKGROUND_COLOR":"DIMENSION_EXPRESSION_WITHOUT_VARIABLES_BACKGROUND_COLOR",ne.getColor(e)}getExpressionBorderProperties(){return this.expressionType!==ie.WITHOUT_VARIABLES||this.isBad||this.selected||this.hovered||this.textDragging?{}:{borderColor:ne.getColor("DIMENSION_EXPRESSION_WITHOUT_VARIABLES_BACKGROUND_BORDER_COLOR"),borderThickness:ne.getNumber("DIMENSION_EXPRESSION_BACKGROUND_BORDER_THICKNESS")}}getScreenSpaceParameters(e,t){const i={gap:ne.getNumber("DIMENSION_WITNESS_MODEL_GAP"),extension:ne.getNumber("DIMENSION_WITNESS_EXTENSION")};return this.preferences&&this.preferences.ignoreSpaceParameters?(i.gap=0,i.extension=0):t&&(i.gap*=t,i.extension*=t),i}getAlphaAdjustedArrowColor(e,t){if(!t.opaque){const t=ne.getNumber("DIMENSION_VALUE_ARROW_OPACITY");e[3]=t}return t.fade?this.applyAngleFadeToColor(e):e}getArrowColor(){return this.preferences&&this.preferences.colorName?ne.getColor(this.preferences.colorName):this.shouldHighlightDimensionWithSelectedColor()?this.getAlphaAdjustedArrowColor(ne.getColor("DIMENSION_SELECTED_LINE_ARROW_COLOR"),{opaque:!1,fade:!1}):this.hovered?this.isDriven?this.getAlphaAdjustedArrowColor(ne.getColor("DIMENSION_DRIVEN_HOVERED_LINE_ARROW_COLOR"),{opaque:!1,fade:!1}):this.getAlphaAdjustedArrowColor(ne.getColor("DIMENSION_DRIVING_HOVERED_LINE_ARROW_COLOR"),{opaque:!1,fade:!1}):this.isBad?this.getAlphaAdjustedArrowColor(ne.getColor("OVERCONSTRAINED_LINE_POINT_COLOR"),{opaque:!0,fade:!0}):this.isDriven?this.getAlphaAdjustedArrowColor(ne.getColor("DIMENSION_DRIVEN_LINE_POINT_COLOR"),{opaque:!1,fade:!0}):this.getAlphaAdjustedArrowColor(ne.getColor("DIMENSION_DRIVING_LINE_ARROW_COLOR"),{opaque:!0,fade:!0})}addHighlight(e){super.addHighlight(e),this.destroyAllTextures(),this.updateHideState(),this.viewer.requestDraw()}removeHighlight(e){return!!e&&(!!super.removeHighlight(e)&&(this.destroyAllTextures(),this.viewer.requestDraw(),this.updateHideState(),!0))}updateHideState(){!this.isVisibleToUser()&&this.isHighlighted()&&this.show()}getLineColor(){return this.getArrowColor()}calculateFadeAlphaScaling(e){const t=Math.abs(p.dot(this.getVisualNormal(),e.getDirection())),i=ne.getNumber("DIMENSION_SIDE_FADE_UPPER_DOT"),s=ne.getNumber("DIMENSION_SIDE_FADE_LOWER_DOT");let n=1;return t<s?n=0:t<i&&(n=(t-s)/(i-s)),n}applyAngleFadeToColor(e){return[e[0],e[1],e[2],e[3]*this.lastFadeAlphaScaling]}getLineWidth(){return this.selected||this.hovered?ne.getNumber("DIMENSION_SELECTED_LINE_WIDTH"):ne.getNumber("DIMENSION_LINE_WIDTH")}getLineStyle(){return this.preferences?this.preferences.lineStyle:null}getTextGap(e,t,i,s){let n=i,r=(0,c.acos)(p.dot(e,t),u.W.ZERO_LENGTH);r>Math.PI/2&&(r=(0,c.acos)(p.dot(T.S4.scale(e,-1,p.create()),t),u.W.ZERO_LENGTH));const a=s/2/(i/2);return n=Math.tan(r)>a?s/Math.sin(r):i/Math.cos(r),n}getValueGapWithIcon(e,t,i,s,n,r){const a=i+2*(n+r);return this.getTextGap(e,t,a,s)}getIconPadding(e){return ne.getNumber("DIMENSION_VALUE_BACKGROUND_PADDING")*e}createComponentLine(e,t){return(0,g.createLine)(e,t,void 0,this.getLineColor(),this.getLineWidth(),this.getLineStyle())}updateDimensionComponent(e,t,i,s){let n=0;this.forPreview?n=1:this.getIsAnnotationDimension()&&!this.featureIsActive&&(n=3);const r=i.clone();3===n&&((0,g.addStyleToIncrement)(ne.getStipple("DIMENSION_INACTIVE_OCCLUDED_WITNESS_STIPPLE"),r),(0,g.addColorToIncrement)(this.applyAngleFadeToColor(ne.getColor("DIMENSION_INACTIVE_OCCLUDED_COLOR")),r)),this.updateMeshIncrement("st."+e,t,r,s[n]),3===n?this.updateMeshIncrement(J+e,t,i.clone(),s[2]):this.removeMeshIncrement(J+e)}removeDimensionComponent(e){this.removeMeshIncrement("st."+e),this.removeMeshIncrement(J+e)}updateDimensionLineComponent(e,t,i){this.updateDimensionComponent(e,R,this.createComponentLine(t,i),X)}makeThreePointArc(e,t,i,s){const n=(0,g.createArcPolyline)(e.slice(),t.slice(),i.slice(),[],!0);if(n){const e=n.linePoints,t=new Array(3*e.length),i=new Array(2*(e.length-1)),r=s.getIndexOffset();i[0]=r;for(let t=1;t<e.length-1;t++)i[2*t-1]=t+r,i[2*t]=t+r;for(let i=0;i<e.length;i++){const s=e[i],n=this.getModelPoint(s[0],s[1]);for(let e=0;e<3;++e)t[3*i+e]=n[e]}i[i.length-1]=i.length-1+r,s.concat(t,i)}}getValuePrefix(e){return this.preferences?.textPrefix??""}isOfType(e){return this.constructor===e}setPreferences(e){this.preferences=e}getDisplayData(){return this.displayData}getRoundedDimensionValueForTextDisplay(e,t){return(0,c.roundTo)(e,this.getPrecision(t))}hasPrecisionOverride(){return this.displayData?.precision!==o.d_N.DEFAULT&&this.displayData?.precision!==o.d_N.UNKNOWN}getPrecision(e){const t=this.getDefaultPrecision(e);return this.hasPrecisionOverride()?de.getPrecisionDigitCount(this.displayData.precision):t}static getPrecisionDigitCount(e){switch(e){case o.d_N.DEFAULT:case o.d_N.UNKNOWN:return 3;case o.d_N.ONES:return 0;case o.d_N.TENTHS:return 1;case o.d_N.HUNDREDTHS:return 2;case o.d_N.THOUSANDTHS:return 3;case o.d_N.TEN_THOUSANDTHS:return 4;case o.d_N.HUNDRED_THOUSANDTHS:return 5;case o.d_N.MILLIONTHS:return 6}}updateBasicBox(e){const t=Q+"_BASIC";this.getHasTolerances()&&this.displayData.toleranceType===o.gkc.BASIC?this.updateDimensionComponent(t,R,(0,g.createLineLoop)(e,void 0,this.getLineColor(),this.getLineWidth()),X):this.removeDimensionComponent(t)}}class ge{constructor(){this.points=[],this.indices=[]}concat(e,t){this.points=this.points.concat(e),this.indices=this.indices.concat(t)}getIndexOffset(){return this.points.length/3}}class pe extends(666==i.j?de:null){constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="LinearDimension"}updateFromDisplayData(e){this.displayData=e,this.isBad=e.isOverDefined,this.isDriven=e.isDriven,this.updateDimensionMatrices(),this.viewer.requestDraw()}setPosition(e){this.displayData.positionX=e[0],this.displayData.positionY=e[1]}getPosition(){return m.fromValues(this.displayData.positionX,this.displayData.positionY)}getDefaultPrecision(e){return e.getLengthUnitsDisplayPrecision()}getDimensionUnits(e){return e.getLengthUnits()}update(e,t){if(!this.displayData)return;let i;const s=[this.displayData.witnessEndPoint0X,this.displayData.witnessEndPoint0Y],n=[this.displayData.witnessEndPoint1X,this.displayData.witnessEndPoint1Y],r=this.getPosition(),o=e.getPixelSizeAtWorldPoint(this.transformPoint(this.getModelPoint(r[0],r[1]))),h=this.getModelPoint(s[0],s[1]),c=this.getModelPoint(n[0],s[1]),l=this.getModelPoint(s[0],s[1]+n[0]-s[0]);let d=T.S4.normalize(T.S4.subtract(c,h)),f=T.S4.normalize(T.S4.subtract(l,h));(p.dot(d,d)<u.W.ZERO_LENGTH_SQUARED||p.dot(f,f)<u.W.ZERO_LENGTH_SQUARED)&&(d=T.S4.normalize(T.S4.subtract(this.getModelPoint(1,0),h)),f=T.S4.normalize(T.S4.subtract(this.getModelPoint(0,1),h)));const I=this.getVisualRightVector(),E=this.getVisualUpVector(),S=Math.abs(this.displayData.value);let D=ne.getNumber("DIMENSION_ARROW_HEIGHT_PIXELS")*o,M=ne.getNumber("DIMENSION_ARROW_WIDTH_PIXELS")*o;const C=M;M>S*ne.getNumber("DIMENSION_ARROW_MAX_PROPORTION")&&(i=S*ne.getNumber("DIMENSION_ARROW_MAX_PROPORTION")/M,D*=i,M*=i);const y=[],P=this;function A(e,t,i,s){const n=P.getModelPoint(i,s);return T.S4.add(n,T.S4.add(T.S4.scale(d,e,p.create()),T.S4.scale(f,t,p.create())))}function O(e,t,i,s){const n=A(e,t,i,s);for(let e=0;e<3;++e)y.push(n[e])}O(0,0,s[0],r[1]),O(M,.5*-D,s[0],r[1]),O(M,.5*D,s[0],r[1]),O(0,0,n[0],r[1]),O(-M,.5*-D,n[0],r[1]),O(-M,.5*D,n[0],r[1]),this.updateDimensionComponent(Z,"",(0,g.createTriangles)(y,[0,1,2,3,4,5],void 0,this.getArrowColor()),Y);const v=(0,a.KZ)(this.displayData.value,t.getLengthUnits());this.updateValueTexture(v,t,this.getValuePrefix(t)),this.updateToleranceTexture(t);const w=this.valueTextureInfo.getTexture(),_=this.toleranceTextureInfo.getTexture(),N=new re(o,w,_),b=p.scale(p.create(),E,.5*N.combinedWorldSize.height),L=this.getModelPoint(r[0],r[1]);p.subtract(L,L,b);const F=p.scale(p.create(),E,N.combinedWorldSize.height),x=p.scale(p.create(),I,.5*N.combinedWorldSize.width),B=p.subtract(p.create(),L,x),V=p.add(p.create(),L,x),U=p.add(p.create(),B,F),G=p.add(p.create(),V,F),H=(0,g.orientText)(e,I,E,this.transform),k=p.add(p.create(),H[0]?V:B,b),W=this.updateIconDimensionComponent(o,k,I,E,H),z=this.getTextGap(d,I,N.combinedWorldSize.width,N.combinedWorldSize.height),q=W>0?this.getValueGapWithIcon(d,I,N.combinedWorldSize.width,N.combinedWorldSize.height,W,this.getIconPadding(o)):z,$=this.getScreenSpaceParameters(t,o);let J=$.extension;z>S&&(J=0);const ee=s[1]+(r[1]>s[1]?$.gap:-$.gap),te=n[1]+(r[1]>n[1]?$.gap:-$.gap),ie=r[1]+(r[1]>0?J:-J);this.updateDimensionLineComponent(K,this.getModelPoint(s[0],ee),this.getModelPoint(s[0],ie)),this.updateDimensionLineComponent(j,this.getModelPoint(n[0],te),this.getModelPoint(n[0],ie));let se=s[0],ae=n[0];s[0]>n[0]&&(se=n[0],ae=s[0]);const{leftGapLength:oe,rightGapLength:he}=this.getLeftAndRightGapLengthInDimensionCoordinates(z,q,m.fromValues(se,r[1]),m.fromValues(ae,r[1]),H[0]);let ce=r[0]+he/2>ae+M/2,le=r[0]-oe/2<se-M/2,ue=[];const de=[];function ge(e,t,i,s,n){const r=A(e,t,i,s);n.push(r)}if(ce||le?(this.updateDimensionLineComponent(Q,this.getModelPoint(s[0],r[1]),this.getModelPoint(n[0],r[1])),ce?this.updateDimensionLineComponent(Q,this.getModelPoint(se,r[1]),this.getModelPoint(r[0]-oe/2,r[1])):le&&this.updateDimensionLineComponent(Q,this.getModelPoint(ae,r[1]),this.getModelPoint(r[0]+he/2,r[1]))):(ce=r[0]+he/2>ae-M/2,le=r[0]-oe/2<se+M/2,ce?(ue.push(this.getModelPoint(se,r[1])),ue.push(this.getModelPoint(r[0]-oe/2,r[1]))):le?(ue.push(this.getModelPoint(r[0]+he/2,r[1])),ue.push(this.getModelPoint(ae,r[1]))):ue=[this.getModelPoint(se,r[1]),this.getModelPoint(r[0]-oe/2,r[1]),this.getModelPoint(r[0]+he/2,r[1]),this.getModelPoint(ae,r[1])]),this.updateBasicBox([B,U,G,V]),this.preferences&&this.preferences.displayLimitRangeTicks){const e=this.displayData.value<0?-1:1;if(this.displayData.hasMinimumLimit){if(this.displayData.minimumLimit<0){const t=e<0?n:s;ge(0,0,t[0],t[1],ue),ge(e*this.displayData.minimumLimit,0,s[0],s[1],ue)}ge(e*this.displayData.minimumLimit,-C,s[0],s[1],de),ge(e*this.displayData.minimumLimit,C,s[0],s[1],de)}if(this.displayData.hasMaximumLimit){if(this.displayData.maximumLimit>0){const t=e<0?s:n;ge(0,0,t[0],t[1],ue),ge(e*this.displayData.maximumLimit,0,s[0],r[1],ue)}ge(e*this.displayData.maximumLimit,-C,s[0],s[1],de),ge(e*this.displayData.maximumLimit,C,s[0],s[1],de)}}ue.length>0&&this.updateDimensionComponent(Q,R,(0,g.createLines)(ue,void 0,this.getLineColor(),this.getLineWidth(),this.getLineStyle()),X);const pe=Q+"_TICK";if(de.length>0?this.updateDimensionComponent(pe,R,(0,g.createLines)(de,void 0,this.getLineColor(),this.getLineWidth()),X):this.removeDimensionComponent(pe),_){const e=N.getValueCorners(B,E,I,H[0]);this.updateValueDimensionComponent(w,e.lowerLeft,e.lowerRight,e.upperLeft,H);const t=N.getToleranceCorners(B,E,I,H[0]);this.updateToleranceDimensionComponent(_,t.lowerLeft,t.lowerRight,t.upperLeft,H)}else this.updateValueDimensionComponent(w,B,V,U,H),this.removeToleranceDimensionComponent();const me=H[1]?L:p.add(p.create(),L,F);this.updateExpressionDimensionComponent(o,me,I,E,H)}getLeftAndRightGapLengthInDimensionCoordinates(e,t,i,s,n){if(e===t)return{leftGapLength:e,rightGapLength:e};let r=t,a=e;n&&(r=e,a=t);const o=m.transformMat3(m.create(),i,this.dimensionMatrix),h=m.transformMat3(m.create(),s,this.dimensionMatrix);return o[0]>h[0]?{leftGapLength:a,rightGapLength:r}:{leftGapLength:r,rightGapLength:a}}getLabelPositionInPlane(){return T.xB.multiplyVec2(this.dimensionMatrix,[this.displayData.positionX,this.displayData.positionY],I.create())}getFitBounds(){const e=new g.BoundingBox;return this.addPointToBounds(this.getModelPoint(this.displayData.positionX,this.displayData.positionY),e),this.addPointToBounds(this.getModelPoint(this.displayData.witnessEndPoint0X,this.displayData.witnessEndPoint0Y),e),this.addPointToBounds(this.getModelPoint(this.displayData.witnessEndPoint1X,this.displayData.witnessEndPoint1X),e),e}}class me extends(666==i.j?pe:null){constructor(e,t,i){super(e,t,i),this.id="CenterlineDimension"}getValuePrefix(e){return"Ø"}}class fe extends(666==i.j?pe:null){constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="EllipseDiameterDimension"}}const Ie=function(e,t){return m.fromValues(Math.cos(e)*t,Math.sin(e)*t)};class Ee extends(666==i.j?de:null){constructor(e,t,i){super(e,t,i),this.displayData=null}setPosition(e){this.displayData.positionR=Math.sqrt(e[0]*e[0]+e[1]*e[1]),this.displayData.positionT=Math.atan2(e[1],e[0])}getLabelPositionInPlane(){const e=Ie(this.displayData.positionT,this.displayData.positionR);return T.xB.multiplyVec2(this.dimensionMatrix,[e[0],e[1]],I.create())}getModelPointFromPolar(e,t){return this.getModelPoint(t*Math.cos(e),t*Math.sin(e))}}const Se=function(e){return e-2*(0,g.floorTowardsZero)(e/(2*Math.PI))*Math.PI},Te=function(e,t,i){const s=(e+t)/2,n=(0,g.closestAngle)(i,s),r=Math.abs(t-e);let a=0,o=0,h=0;if(2*Math.abs(n-s)>r){h=i;const s=(0,g.closestAngle)(e,h),n=(0,g.closestAngle)(t,h);a=Math.abs(s-h)<Math.abs(n-h)?s:n,o=Math.floor(1+(ne.getNumber("DIMENSION_ARC_WITNESS_SEGMENTS")-1)*Math.abs(h-a)/(2*Math.PI))}return{firstAngle:a,secondAngle:h,segments:o}};class De extends(666==i.j?Ee:null){constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="RadialDimension"}updateFromDisplayData(e){this.displayData=e,this.isBad=e.isOverDefined,this.isDriven=e.isDriven,this.updateDimensionMatrices(),this.viewer.requestDraw()}getPosition(){return m.clone(Ie(this.displayData.positionT,this.displayData.positionR))}getDefaultPrecision(e){return e.getLengthUnitsDisplayPrecision()}getDimensionUnits(e){return e.getLengthUnits()}update(e,t){if(!this.displayData)return;const i=this.displayData.value,s=this.getPosition(),n=Ie(this.displayData.positionT,1),r=e.getPixelSizeAtWorldPoint(this.transformPoint(this.getModelPoint(s[0],s[1]))),h=this.getModelPoint(0,0),c=Ie(this.displayData.positionT+Math.PI/2,1),l=T.S4.normalize(T.S4.subtract(this.getModelPoint(n[0],n[1]),h)),u=T.S4.normalize(T.S4.subtract(this.getModelPoint(c[0],c[1]),h)),d=this.getVisualRightVector(),m=this.getVisualUpVector();let f=ne.getNumber("DIMENSION_ARROW_HEIGHT_PIXELS")*r,I=ne.getNumber("DIMENSION_ARROW_WIDTH_PIXELS")*r;if(I>i*ne.getNumber("DIMENSION_ARROW_MAX_PROPORTION")){const e=i*ne.getNumber("DIMENSION_ARROW_MAX_PROPORTION")/I;f*=e,I*=e}const E=[],D=this,M=function(e,t,i,s){const n=D.getModelPoint(i,s),r=T.S4.add(n,T.S4.add(T.S4.scale(l,e,p.create()),T.S4.scale(u,t,p.create())));for(let e=0;e<3;++e)E.push(r[e])};let C=(0,a.KZ)(i,t.getLengthUnits()),y=i;const P=this.displayData.radiusDisplay===o.MEf.DIAMETRAL,A=P&&!this.displayData.realDiameter;let O="R";P&&(O="Ø",A?C*=2:y/=2),this.updateValueTexture(C,t,O),this.updateToleranceTexture(t);const v=this.valueTextureInfo.getTexture(),w=this.toleranceTextureInfo.getTexture(),_=new re(r,v,w),N=p.scale(p.create(),m,.5*_.combinedWorldSize.height),b=this.getModelPoint(s[0],s[1]);p.subtract(b,b,N);const L=p.scale(p.create(),d,.5*_.combinedWorldSize.width),F=p.scale(p.create(),m,_.combinedWorldSize.height),x=p.subtract(p.create(),b,L),B=p.add(p.create(),b,L),V=p.add(p.create(),x,F),U=p.add(p.create(),B,F),G=(0,g.orientText)(e,d,m,this.transform),H=p.add(p.create(),G[0]?B:x,N),k=this.updateIconDimensionComponent(r,H,d,m,G);let W,z;const q=this.getTextGap(l,d,_.combinedWorldSize.width,_.combinedWorldSize.height),Q=k>0?this.getValueGapWithIcon(l,d,_.combinedWorldSize.width,_.combinedWorldSize.height,k,this.getIconPadding(r)):q,$=G[0]?q:Q,J=G[0]?Q:q,ee=n[0]>0?$:J,te=n[0]>0?J:$;if(this.displayData.positionR-ee/2>y)W=Ie(this.displayData.positionT,y),z=Ie(this.displayData.positionT,this.displayData.positionR-ee/2),M(0,0,W[0],W[1]),M(I,.5*-f,W[0],W[1]),M(I,.5*f,W[0],W[1]),this.updateDimensionComponent(Z,"",(0,g.createTriangles)(E,[0,1,2],void 0,this.getArrowColor()),Y),this.updateDimensionLineComponent(K,this.getModelPoint(W[0],W[1]),this.getModelPoint(z[0],z[1]));else{W=[0,0],P&&(W=Ie(Math.PI+this.displayData.positionT,y)),z=Ie(this.displayData.positionT,y),M(0,0,W[0],W[1]),M(I,.5*-f,W[0],W[1]),M(I,.5*f,W[0],W[1]),M(0,0,z[0],z[1]),M(-I,.5*-f,z[0],z[1]),M(-I,.5*f,z[0],z[1]),this.updateDimensionComponent(Z,"",(0,g.createTriangles)(E,[0,1,2,3,4,5],void 0,this.getArrowColor()),Y);const e=Ie(this.displayData.positionT,this.displayData.positionR-ee/2),t=Ie(this.displayData.positionT,this.displayData.positionR+te/2),i=[],s=this.getModelPoint(W[0],W[1]),n=this.getModelPoint(z[0],z[1]),r=this.getModelPoint(e[0],e[1]),a=this.getModelPoint(t[0],t[1]);(!P&&this.displayData.positionR-ee/2>0||P)&&(i.push(s),i.push(r)),this.displayData.positionR+te/2<y&&(i.push(a),i.push(n)),this.updateDimensionComponent(K,R,(0,g.createLines)(i,void 0,this.getLineColor(),this.getLineWidth(),this.getLineStyle()),X)}if(!P){const e=Te(this.displayData.witnessEndPoint0t,this.displayData.witnessEndPoint1t,this.displayData.positionT),t=(0,g.createArc)(h,this.displayData.witnessEndPoint1r,T.w$.multiplyVec4(this.getPlaneMatrix(),[0,0,1,0],S.create()),d,e.firstAngle,e.secondAngle,e.segments);(0,g.addColorToIncrement)(this.getLineColor(),t),this.getLineStyle()&&(0,g.addStyleToIncrement)(this.getLineStyle(),t),this.updateDimensionComponent(j,R,t,X)}if(this.updateBasicBox([x,V,U,B]),w){const e=_.getValueCorners(x,m,d,G[0]);this.updateValueDimensionComponent(v,e.lowerLeft,e.lowerRight,e.upperLeft,G);const t=_.getToleranceCorners(x,m,d,G[0]);this.updateToleranceDimensionComponent(w,t.lowerLeft,t.lowerRight,t.upperLeft,G)}else this.updateValueDimensionComponent(v,x,B,V,G),this.removeToleranceDimensionComponent();const ie=G[1]?b:p.add(p.create(),b,F);this.updateExpressionDimensionComponent(r,ie,d,m,G)}getFitBounds(){const e=new g.BoundingBox;return this.addPointToBounds(this.getModelPointFromPolar(this.displayData.positionT,this.displayData.positionR),e),e}}class Me extends(666==i.j?Ee:null){constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="AngularDimension"}updateFromDisplayData(e){this.displayData=e,this.isBad=e.isOverDefined,this.isDriven=e.isDriven,this.updateDimensionMatrices(),this.viewer.requestDraw()}getDisplayValue(e,t){return(0,a.KZ)(e,t.getAngleUnits())}getValueSuffix(e){const t=e.getAngleUnits();t?.toLowerCase();return x(t)}addArcLengthAnnotation(e,t,i,s,n,r,a,o){return 0}isArcLengthDimension(){return!1}getPosition(){return Ie(this.displayData.positionT,this.displayData.positionR)}getDefaultPrecision(e){return this.isArcLengthDimension()?e.getLengthUnitsDisplayPrecision():e.getAngleUnitsDisplayPrecision()}getDimensionUnits(e){return e.getAngleUnits()}update(e,t){if(!this.displayData)return;const i=this.displayData.value,s=this.getPosition(),n=Se(this.displayData.witnessEndPoint0t),r=Se(this.displayData.witnessEndPoint1t),a=e.getPixelSizeAtWorldPoint(this.transformPoint(this.getModelPoint(s[0],s[1]))),o=this.getValuePrefix(t),h=this.getValueSuffix(t),c=this.getDisplayValue(i,t);this.updateValueTexture(c,t,o,h),this.updateToleranceTextureWithSuffix(t,h);const l=this.valueTextureInfo.getTexture(),u=this.toleranceTextureInfo.getTexture(),d=new re(a,l,u);let f=ne.getNumber("DIMENSION_ARROW_HEIGHT_PIXELS")*a,I=ne.getNumber("DIMENSION_ARROW_WIDTH_PIXELS")*a;const E=r-n,S=Math.abs(E*this.displayData.positionR)*ne.getNumber("DIMENSION_ARROW_MAX_PROPORTION");if(I>S){const e=S/I;f*=e,I*=e}let D=1;n>r&&(D=-1);const M=[],C=this,y=function(e,t,i,s){let n=Ie(i,s);const r=[Math.cos(i),Math.sin(i)],a=[-r[1]*D,r[0]*D];n=T.gv.add(n,T.gv.add(T.gv.scale(r,t,m.create()),T.gv.scale(a,e,m.create())));const o=C.getModelPoint(n[0],n[1]);for(let e=0;e<3;++e)M.push(o[e])},P=I/this.displayData.positionR;y(0,0,n,this.displayData.positionR),y(0,.5*-f,n+P*D,this.displayData.positionR),y(0,.5*f,n+P*D,this.displayData.positionR),y(0,0,r,this.displayData.positionR),y(0,.5*-f,r-P*D,this.displayData.positionR),y(0,.5*f,r-P*D,this.displayData.positionR),this.updateDimensionComponent(Z,"",(0,g.createTriangles)(M,[0,1,2,3,4,5],void 0,this.getArrowColor()),Y);const A=this.getScreenSpaceParameters(t,a),O=this.displayData.positionR+(this.displayData.witnessEndPoint0r<this.displayData.positionR?A.extension:-A.extension),v=this.displayData.positionR+(this.displayData.witnessEndPoint1r<this.displayData.positionR?A.extension:-A.extension);let w,_;if(this.isArcLengthDimension())w=this.displayData.witnessEndPoint0r+(this.displayData.witnessEndPoint0r>this.displayData.positionR?-A.gap:A.gap),_=this.displayData.witnessEndPoint1r+(this.displayData.witnessEndPoint1r>this.displayData.positionR?-A.gap:A.gap);else{const e=this.displayData.witnessMaxPoint0r+A.gap,t=this.displayData.witnessMinPoint0r-A.gap,i=this.displayData.witnessMaxPoint1r+A.gap,s=this.displayData.witnessMinPoint1r-A.gap;w=this.displayData.positionR>e?e:this.displayData.positionR<t?t:O,_=this.displayData.positionR>i?i:this.displayData.positionR<s?s:v}const N=(e,t,i,s)=>{this.updateDimensionLineComponent(e,this.getModelPointFromPolar(t,i),this.getModelPointFromPolar(t,s))};N(K,n,w,O),N(j,r,_,v);const b=this.getModelPointFromPolar(this.displayData.positionT,this.displayData.positionR),L=-Math.sin(this.displayData.positionT),F=Math.cos(this.displayData.positionT),x=T.S4.normalize(T.S4.subtract(this.getModelPoint(s[0]+L,s[1]+F),b)),B=this.getVisualRightVector(),V=this.getVisualUpVector(),U=new ge,G=this.displayData.positionR,H=(0,g.orientText)(e,B,V,this.transform),k=this.addArcLengthAnnotation(H[1],-this.displayData.coordinateSystem.m00,-this.displayData.coordinateSystem.m01,d.combinedWorldSize.width,d.combinedWorldSize.height,this.displayData.positionT,G,this.displayData.clockwise),W=p.scale(p.create(),V,.5*d.combinedWorldSize.height),z=p.subtract(p.create(),b,W),q=p.scale(p.create(),B,.5*d.combinedWorldSize.width),Q=p.subtract(p.create(),z,q),$=p.add(p.create(),z,q),J=p.scale(p.create(),V,d.combinedWorldSize.height),ee=p.add(p.create(),Q,J),te=p.add(p.create(),$,J),ie=p.add(p.create(),H[0]?$:Q,W),se=this.updateIconDimensionComponent(a,ie,B,V,H),ae=(this.getValueGapWithIcon(x,B,d.combinedWorldSize.width,d.combinedWorldSize.height,.5*se,0)+k)/2/this.displayData.positionR;let oe=Math.abs(2*Math.asin(ae));isNaN(oe)&&(oe=0);let he=this.displayData.positionT;if(D>0)for(;he+oe/2<0;)he+=2*Math.PI;else for(;he-oe/2>0;)he-=2*Math.PI;const ce=he+oe/2,le=he-oe/2;if(Math.abs(ae)>1||D>0&&ce<n||D>0&&le>r||D<0&&le>n||D<0&&ce<r){const e=Te(Se(this.displayData.witnessEndPoint0t),Se(this.displayData.witnessEndPoint1t),he);0!==e.secondAngle&&(e.secondAngle+=e.firstAngle>e.secondAngle?oe/2:-oe/2),this.makeArc(e.firstAngle,e.secondAngle,U),this.makeArc(n,r,U)}else(D>0&&he-oe/2>n||D<0&&he+oe/2<n)&&this.makeArc(n,he-D*oe/2,U),(D>0&&he+oe/2<r||D<0&&he-oe/2>r)&&this.makeArc(he+D*oe/2,r,U);const ue=new g.MeshIncrement(g.PrimitiveType.LINES,U.points,U.indices);if((0,g.addColorToIncrement)(this.getLineColor(),ue),(0,g.addSizeToIncrement)(this.getLineWidth(),ue),this.getLineStyle()&&(0,g.addStyleToIncrement)(this.getLineStyle(),ue),this.updateDimensionComponent("arc",R,ue,X),this.updateBasicBox([Q,ee,te,$]),u){const e=d.getValueCorners(Q,V,B,H[0]);this.updateValueDimensionComponent(l,e.lowerLeft,e.lowerRight,e.upperLeft,H);const t=d.getToleranceCorners(Q,V,B,H[0]);this.updateToleranceDimensionComponent(u,t.lowerLeft,t.lowerRight,t.upperLeft,H)}else this.updateValueDimensionComponent(l,Q,$,ee,H),this.removeToleranceDimensionComponent();const de=H[1]?z:p.add(p.create(),z,J);this.updateExpressionDimensionComponent(a,de,B,V,H)}getFitBounds(){const e=new g.BoundingBox;return this.addPointToBounds(this.getModelPointFromPolar(this.displayData.witnessEndPoint0t,this.displayData.witnessEndPoint0r),e),this.addPointToBounds(this.getModelPointFromPolar(this.displayData.witnessEndPoint1t,this.displayData.witnessEndPoint1r),e),this.addPointToBounds(this.getModelPointFromPolar(this.displayData.witnessEndPoint0t,this.displayData.positionR),e),this.addPointToBounds(this.getModelPointFromPolar(this.displayData.witnessEndPoint1t,this.displayData.positionR),e),this.addPointToBounds(this.getModelPointFromPolar(this.displayData.positionT,this.displayData.positionR),e),e}makeArc(e,t,i){const s=i.getIndexOffset();let n=e,r=Math.max(Math.floor(u.W.NUMBER_OF_POINTS_IN_FULL_CIRCLE*Math.abs(t-e)/(2*Math.PI)+1),0);isNaN(r)&&(r=0);const a=new Array(3*(r+1)),o=(t-e)/r;for(let e=0;e<r+1;++e){const t=this.getModelPointFromPolar(n,this.displayData.positionR);for(let i=0;i<3;++i)a[3*e+i]=t[i];n+=o}const h=new Array(2*r);let c;for(h[0]=s,c=1;c<r;c++)h[2*c-1]=c+s,h[2*c]=c+s;h[h.length-1]=c+s,i.concat(a,h)}}class Ce extends(666==i.j?Me:null){constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="ArcLengthDimension"}getDisplayValue(e,t){return(0,a.KZ)(e,t.getLengthUnits())}getValueSuffix(e){return""}isArcLengthDimension(){return!0}getDimensionUnits(e){return e.getLengthUnits()}addArcLengthAnnotation(e,t,i,s,n,r,a,o){const h=new ge,c=m.fromValues(t,i),l=m.fromValues(i,-t),u=ne.getNumber("DIMENSION_ARC_LENGTH_SCALE"),d=Ie(this.displayData.positionT,a);o&&(T.gv.scale(c,-1),T.gv.scale(l,-1)),e&&(T.gv.scale(c,-1),T.gv.scale(l,-1));const p=m.create();T.gv.add(d,T.gv.scale(c,u*s/2,m.create()),p),T.gv.add(p,T.gv.scale(l,n/2,m.create()),p);const f=m.create();T.gv.add(d,T.gv.scale(c,-u*s/2,m.create()),f),T.gv.add(f,T.gv.scale(l,n/2,m.create()),f),T.gv.add(d,T.gv.scale(l,n*u,m.create()),d),this.makeThreePointArc(p,d,f,h);const I=new g.MeshIncrement(g.PrimitiveType.LINES,h.points,h.indices);return(0,g.addColorToIncrement)(this.getLineColor(),I),(0,g.addSizeToIncrement)(this.getLineWidth(),I),this.updateDimensionComponent(W,P,I,X),n*(u-.5+ne.getNumber("DIMENSION_TEXT_GAP"))}}class ye extends(666==i.j?de:null){constructor(e,t,i){super(e,t,i),this.id="PointDimension"}updateFromDisplayData(e){this.isBad=e.isOverDefined,this.isDriven=e.isDriven,this.updateDimensionMatrices(),this.viewer.requestDraw()}isLengthDimension(){return!0}update(e,t){const i=this.getDisplayData();if(!i)return;let s;const n=this.getPosition(),r=e.getPixelSizeAtWorldPoint(this.transformPoint(this.getModelPoint(n[0],n[1]))),a=i.value;let o=ne.getNumber("DIMENSION_ARROW_HEIGHT_PIXELS")*r,h=ne.getNumber("DIMENSION_ARROW_WIDTH_PIXELS")*r;h>a*ne.getNumber("DIMENSION_ARROW_MAX_PROPORTION")&&this.isLengthDimension()&&(s=a*ne.getNumber("DIMENSION_ARROW_MAX_PROPORTION")/h,o*=s,h*=s);const c=this.getModelPoint(0,0),l=T.S4.normalize(T.S4.subtract(this.getModelPoint(1,0),c)),u=T.S4.normalize(T.S4.subtract(this.getModelPoint(0,1),c)),d=this.getTextureInfoForLabel(a,t),m=r*d.filledWidthPx,f=r*d.filledHeightPx,I=(0,g.orientText)(e,l,u,this.transform),E=this.wantArcLengthSymbol()?this.addArcLengthSymbol(n,m,f,I[1]):.5*f,S=this.getModelPoint(n[0],n[1]),D=p.scale(p.create(),l,.5*m),M=p.scale(p.create(),u,.5*f),C=p.subtract(p.create(),S,D),y=p.add(p.create(),S,D),P=p.subtract(p.create(),C,M),A=p.subtract(p.create(),y,M),O=p.add(p.create(),C,M),v=this.getModelPoint(0,0),w=p.scale(p.create(),u,E),_=this.updateIconDimensionComponent(r,I[0]?y:C,l,u,I),N=_>0?p.scale(p.create(),l,.5*m+_+this.getIconPadding(r)):D,b=[p.subtract(p.create(),S,I[0]?D:N),p.add(p.create(),S,I[0]?N:D),p.subtract(p.create(),S,I[1]?w:M),p.add(p.create(),S,I[1]?M:w)];let L=null,F=null;for(const e of b){const t=p.squaredLength(p.subtract(p.create(),e,v));(!L||t<L)&&(L=t,F=e)}const x=[],B=p.normalize(p.create(),p.subtract(p.create(),F,v)),V=p.transformMat4(p.create(),[0,0,1],this.getPlaneMatrix()),U=p.normalize(p.create(),p.cross(p.create(),B,V)),G=this,H=function(e,t,i,s){const n=G.getModelPoint(i,s),r=p.add(p.create(),n,p.add(p.create(),p.scale(p.create(),B,e),p.scale(p.create(),U,t)));for(let e=0;e<3;++e)x.push(r[e])};H(0,0,0,0),H(h,.5*-o,0,0),H(h,.5*o,0,0),this.updateDimensionComponent(Z,"",(0,g.createTriangles)(x,[0,1,2],void 0,this.getArrowColor()),Y),this.updateDimensionComponent(K,R,this.createComponentLine(v,F),X),this.updateValueDimensionComponent(d,P,A,O,I);const k=I[1]?p.subtract(p.create(),S,w):p.add(p.create(),S,w);this.updateExpressionDimensionComponent(r,k,l,u,I)}getTextureInfoForLabel(e,t){const i=(0,a.KZ)(e,t.getLengthUnits());return this.updateValueTexture(i,t),this.valueTextureInfo.getTexture()}getFitBounds(){const e=new g.BoundingBox;this.addPointToBounds(this.getModelPoint(0,0),e);const t=this.getPosition();return this.addPointToBounds(this.getModelPoint(t[0],t[1]),e),e}wantArcLengthSymbol(){return!1}getDisplayData(){return null}addArcLengthSymbol(e,t,i,s){const n=ne.getNumber("DIMENSION_ARC_LENGTH_SCALE"),r=n*t/2,a=s?-i:i,o=m.fromValues(e[0]-r,e[1]+a/2),h=m.fromValues(e[0],e[1]+n*a),c=m.fromValues(e[0]+r,o[1]),l=new ge;this.makeThreePointArc(o,h,c,l);const u=new g.MeshIncrement(g.PrimitiveType.LINES,l.points,l.indices);return(0,g.addColorToIncrement)(this.getLineColor(),u),(0,g.addSizeToIncrement)(this.getLineWidth(),u),this.updateDimensionComponent(W,P,u,X),i*(n+ne.getNumber("DIMENSION_TEXT_GAP"))}getLabelPositionInPlane(){return T.xB.multiplyVec2(this.dimensionMatrix,this.getPosition(),I.create())}}class Pe extends(666==i.j?ye:null){constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="BezierDegreeDimension"}isLengthDimension(){return!1}updateFromDisplayData(e){this.displayData=e,super.updateFromDisplayData(e)}getDisplayData(){return this.displayData}getPosition(){return m.fromValues(this.displayData.positionX,this.displayData.positionY)}setPosition(e){this.displayData.positionX=e[0],this.displayData.positionY=e[1]}getDefaultPrecision(e){return 0}getDimensionUnits(e){return""}getTextureInfoForLabel(e,t){return this.updateValueTexture(e,t,"Deg "),this.valueTextureInfo.getTexture()}canBeDrivenDimension(){return!1}}class Ae extends(666==i.j?ye:null){constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="RhoDimension"}isLengthDimension(){return!1}updateFromDisplayData(e){this.displayData=e,super.updateFromDisplayData(e)}getDisplayData(){return this.displayData}getPosition(){return m.fromValues(this.displayData.positionX,this.displayData.positionY)}setPosition(e){this.displayData.positionX=e[0],this.displayData.positionY=e[1]}getDefaultPrecision(e){return e.getLengthUnitsDisplayPrecision()}getDimensionUnits(e){return""}getTextureInfoForLabel(e,t){return this.updateValueTexture(e,t,"Rho "),this.valueTextureInfo.getTexture()}}class Oe extends(666==i.j?ye:null){constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="CurveLengthDimension"}wantArcLengthSymbol(){return!0}isLengthDimension(){return!0}getDefaultPrecision(e){return e.getLengthUnitsDisplayPrecision()}getDimensionUnits(e){return e.getLengthUnits()}getTextureInfoForLabel(e,t){if(void 0===e)this.updateRawValueTexture("⌒");else{const i=(0,a.KZ)(e,t.getLengthUnits());this.updateValueTexture(i,t)}return this.valueTextureInfo.getTexture()}updateFromDisplayData(e){this.displayData=e,super.updateFromDisplayData(e)}getDisplayData(){return this.displayData}getPosition(){return m.fromValues(this.displayData.positionX,this.displayData.positionY)}setPosition(e){this.displayData.positionX=e[0],this.displayData.positionY=e[1]}}class ve extends(666==i.j?ye:null){constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="CountDimension"}getTextureInfoForLabel(e,t){return this.updateValueTexture(e,t,void 0,"x"),this.valueTextureInfo.getTexture()}getDefaultPrecision(e){return 0}getDimensionUnits(e){return""}updateFromDisplayData(e){this.displayData=e,super.updateFromDisplayData(e)}getDisplayData(){return this.displayData}getPosition(){return m.fromValues(this.displayData.positionX,this.displayData.positionY)}setPosition(e){this.displayData.positionX=e[0],this.displayData.positionY=e[1]}canBeDrivenDimension(){return!1}}function Re(e,t,i,s){s||(s={forPreview:void 0,isMateValue:void 0});let n=null;return e instanceof o.Vh_?n=new Ce(i,!!s.forPreview,t):e instanceof o.eor?n=new me(i,!!s.forPreview,t):e instanceof o.ktz?n=new fe(i,!!s.forPreview,t):e instanceof o.Ye1?n=new pe(i,!!s.forPreview,t):e instanceof o.oTb?n=new Me(i,!!s.forPreview,t):e instanceof o.lAf?n=new De(i,!!s.forPreview,t):e instanceof o.oUi?n=new Oe(i,!!s.forPreview,t):e instanceof o.ohc?n=new ve(i,!!s.forPreview,t):e instanceof o.Id4?n=new Ae(i,!!s.forPreview,t):e instanceof o.jJ2&&(n=new Pe(i,!!s.forPreview,t)),s.isMateValue&&(n.getClearModelSelectionsOnPrehilite=function(){return!1}),n}},44634:function(e,t,i){i.d(t,{IK:function(){return m},XH:function(){return S},l_:function(){return E},lv:function(){return T},po:function(){return p}});var s=i(36316),n=i(17922),r=i(72751),a=i(83057),o=i(45705),h=i(44497),c=i(31675),l=i(85036),u=i(95417);const d=[a.ls1.ANGULAR_TOLERANCE_COARSE,a.ls1.ANGULAR_TOLERANCE_MEDIUM,a.ls1.ANGULAR_TOLERANCE_FINE,a.ls1.ANGULAR_TOLERANCE_VERY_FINE,a.ls1.ANGULAR_TOLERANCE_CURVATURE_ANALYSIS],g=[a.ls1.CHORDAL_TOLERANCE_RATIO_COARSE,a.ls1.CHORDAL_TOLERANCE_RATIO_MEDIUM,a.ls1.CHORDAL_TOLERANCE_RATIO_FINE,a.ls1.CHORDAL_TOLERANCE_RATIO_VERY_FINE,a.ls1.CHORDAL_TOLERANCE_RATIO_CURVATURE_ANALYSIS];var p;function m(e,t){switch(e){case p.PART:return t?i18n("parts"):i18n("part");case p.SURFACE:return t?i18n("surfaces"):i18n("surface");case p.MESH:return t?i18n("meshes"):i18n("mesh");case p.CURVE:return t?i18n("curves"):i18n("curve");case p.POINT:return t?i18n("points"):i18n("point");case p.SKETCH:return t?i18n("sketches"):i18n("sketch");default:return""}}function f(e){const t=1/e;return a.ls1.ESTIMATION_COEFFICIENT_0+a.ls1.ESTIMATION_COEFFICIENT_1*t+a.ls1.ESTIMATION_COEFFICIENT_2*t*t}!function(e){e[e.PART=0]="PART",e[e.SURFACE=1]="SURFACE",e[e.MESH=2]="MESH",e[e.CURVE=3]="CURVE",e[e.POINT=4]="POINT",e[e.SKETCH=5]="SKETCH",e[e.NUMBER_OF_TYPES=6]="NUMBER_OF_TYPES"}(p||(p={}));const I=f(a.ls1.ANGULAR_TOLERANCE_COARSE);function E(e,t,i){const s=f(d[i]);return t/I*s+e}class S{constructor(e){this.id=e,this.name="",this.meshState=a.W6T.NO_MESH,this.constituentsContainMesh=!1,this.isModifiable=!0,this.foundInPreview=!1,this.appearance=null,this.defaultColorHash="",this.meshIncrement=null,this.tessellationSettings=null,this.isFlattenedSheetMetalBody=!1,this.isBendCenterLineBody=!1,this.ownerFlattenedBodyId="",this.sheetMetalModelId="",this.isActiveSheetMetal=!1,this.sheetMetalOrderId="",this.sheetMetalOrder=0,this.isTessellationLoaded=!1,this.coarseTriangleCount=0,this.coarsePlanarFaceTriangleCount=0,this.isAssociatedWithFlat=!1,this.colorCycle=null,this.totalEntityCount=0,this.lastViewTime=0,this.lastViewportOccupancy=0,this.partStudioVisibility=u.Visibility.VISIBLE,this.isComposite=!1,this.isClosedComposite=!1,this.constituentBodyIds_=null,this.consumingClosedCompositeData=null,this.referencingOpenCompositeData_=null,this.isSketchBody=!1,this.type=a.wG2.UNKNOWN,this.bounds=new u.BoundingBox,this.bestAvailableTessellationSetting=a.XiJ.UNKNOWN,this.tessellationSettingOverride=a.XiJ.AUTO,this.constituentTypeCounts=new Array(p.NUMBER_OF_TYPES).fill(0)}getId(){return this.id}setAppearanceFromDisplayData(e){e?(e.appearance&&e.appearance.color&&(this.appearance=(0,l.shallowClone)(e.appearance),this.appearance.color=new Uint8Array(e.appearance.color)),this.defaultColorHash=e.defaultColorHash):r.log.warn("setAppearanceFromDisplayData called without valid display data")}setColorCycle(e){this.colorCycle=e}getColorCycle(){return this.colorCycle}getColor(){const e=n.default.getManager();if(this.containsOnlyWireBodies()){if(!this.isModifiableBody())return e.getColor("REFERENCE_GEOMETRY_COLOR");if(!(0,s.r)())return e.getColor("LINE_POINT_COLOR");if(3!==this.appearance?.color?.length)return e.getColor("LINE_POINT_COLOR")}if(3===this.appearance?.color?.length){const e=this.appearance.color;return[e[0]/255,e[1]/255,e[2]/255,this.appearance.opacity/255]}{if(!this.isModifiableBody())return e.getColor("REFERENCE_GEOMETRY_COLOR");const t=(0,c.ek)(this.defaultColorHash,this.colorCycle);return this.appearance?this.appearance.color=new Uint8Array(t.slice(0,3)):r.log.warn("No appearance object associated with BodyMetaData"),(0,u.convertRGBA255ToRGBA)(t)}}isTranslucent(){return null!==this.appearance&&this.appearance.opacity<255}clone(){const e=new S(this.id);return(0,l.overwriteMatchingProperties)(e,this),e.bounds=new u.BoundingBox(this.bounds.getMin(),this.bounds.getMax()),this.referencingOpenCompositeData_&&(e.referencingOpenCompositeData_=new Map(this.referencingOpenCompositeData_)),e}setIsTessellationLoaded(e){this.isTessellationLoaded=e}getIsTessellationLoaded(){return this.consumingClosedCompositeData?this.consumingClosedCompositeData.getIsTessellationLoaded():this.isTessellationLoaded}setLastViewTime(e){this.lastViewTime=e}getLastViewTime(){return this.lastViewTime}setLastViewportOccupancy(e){this.lastViewportOccupancy=e}getLastViewportOccupancy(){return this.lastViewportOccupancy}getType(){return this.type}isSolidBody(){return!this.isComposite&&this.containsOnlySolidBodies()}containsOnlySolidBodies(){return this.type===a.wG2.SOLID}isSheetBody(){return!this.isComposite&&this.containsOnlySheetBodies()}containsOnlySheetBodies(){return this.type===a.wG2.SHEET}isWireBody(){return!this.isComposite&&this.containsOnlyWireBodies()}containsOnlyWireBodies(){return this.type===a.wG2.WIRE}isPointBody(){return!this.isComposite&&this.containsOnlyPointBodies()}containsOnlyPointBodies(){return this.type===a.wG2.POINT}containsMesh(){return this.constituentsContainMesh||a.QsM.containsMesh(this.meshState)}getMeshState(){return this.meshState}getMeshIncrement(){return this.meshIncrement}isModifiableBody(){return this.isModifiable}getBounds(){return this.bounds}resetMeshIncrement(){this.meshIncrement=null}getIsFlattenedSheetMetalBody(){return this.isFlattenedSheetMetalBody}getIsActiveSheetMetal(){return this.isActiveSheetMetal}getIsBendCenterLineBody(){return this.isBendCenterLineBody}isForFlattenedView(){return this.isFlattenedSheetMetalBody||this.isBendCenterLineBody||this.isAssociatedWithFlat}isSubsidiaryBody(){return this.isBendCenterLineBody}getOwnerBodyId(){return this.ownerFlattenedBodyId}get isOpenCompositeBody(){return this.isComposite&&!this.isClosedComposite}get constituentBodyIds(){return this.constituentBodyIds_}removeOpenCompositeBodyReferences(e){if(this.constituentBodyIds_)for(let t=0;t<this.constituentBodyIds_.length;++t){const i=e[this.constituentBodyIds_[t]];i&&i.removeReferencingOpenCompositeBody(this.id)}}updateConstituentBodyIds(e,t){if(this.removeOpenCompositeBodyReferences(t),this.constituentBodyIds_=e,this.constituentBodyIds_&&this.isOpenCompositeBody)for(let e=0;e<this.constituentBodyIds_.length;++e){const i=t[this.constituentBodyIds_[e]];i&&i.addReferencingOpenCompositeBody(this)}}get referencingOpenCompositeData(){return this.referencingOpenCompositeData_}addReferencingOpenCompositeBody(e){this.referencingOpenCompositeData_||(this.referencingOpenCompositeData_=new Map),this.referencingOpenCompositeData_.set(e.id,e)}removeReferencingOpenCompositeBody(e){this.referencingOpenCompositeData_&&this.referencingOpenCompositeData_.delete(e)}get isCompositeConstituent(){return this.isClosedCompositeConstituent||this.hasReferencingOpenCompositeBody}get hasReferencingOpenCompositeBody(){return!!this.referencingOpenCompositeData_&&this.referencingOpenCompositeData_.size>0}get isClosedCompositeConstituent(){return!!this.consumingClosedCompositeData}get closedCompositeParentId(){return this.consumingClosedCompositeData?this.consumingClosedCompositeData.id:null}get isGroupableCompositeBody(){return this.isClosedComposite&&this.type!==a.wG2.UNKNOWN}get isNonGroupingCompositeBody(){return!!this.isComposite&&(!this.isClosedComposite||!this.isGroupableCompositeBody)}get canBeGroupedWithOtherConstituents(){return!!this.consumingClosedCompositeData&&this.consumingClosedCompositeData.isGroupableCompositeBody}get meshGroupId(){return this.canBeGroupedWithOtherConstituents?this.consumingClosedCompositeData.id:this.id}hasFaces(){return this.containsOnlySolidBodies()||this.containsOnlySheetBodies()}hasEdges(){return this.hasFaces()||this.containsOnlyWireBodies()}hasPoints(){return this.hasEdges()||this.containsOnlyPointBodies()}hasTessellationSettings(){return null!==this.getFinestTessellationSettingInMemory()}canEntitiesBeLoaded(){return this.hasTessellationSettings()||this.isWireBody()||this.isClosedComposite&&this.containsOnlyWireBodies()}getFinestTessellationSettingInMemory(){let e=null;for(let t=0;this.tessellationSettings&&t<this.tessellationSettings.length;++t)this.tessellationSettings[t]!==a.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING&&(null===e||this.tessellationSettings[t]>e)&&(e=this.tessellationSettings[t]);return e}getBestAvailableTessellationSettingIndex(e){return e?a.ls1.getTessellationSettingIndexFromEnum(a.XiJ.VERY_FINE):this.bestAvailableTessellationSetting===a.XiJ.AUTO||this.bestAvailableTessellationSetting===a.XiJ.UNKNOWN?null:Math.min(this.bestAvailableTessellationSetting,a.XiJ.VERY_FINE)-1}getTessellationSettingOverride(){return this.tessellationSettingOverride}getChordalTolerance(){const e=this.getFinestTessellationSettingInMemory();return null===e?null:this.getChordalToleranceForSetting(e)}getChordalToleranceForSetting(e){return e<0||e>=g.length?(r.log.warn("Attempt to retrieve chordal tolerance for invalid tessellation setting"),0):this.getBounds().diameter()/2*g[e]}estimateTriangleCountAtSettingIndex(e){return E(this.coarsePlanarFaceTriangleCount,this.coarseTriangleCount,e)}getEstimatedMemoryUsage(e){if(!e&&this.hasTessellationSettings()&&(e=this.tessellationSettings),!e||0===e.length)return 0;let t=0,i=!1;for(let s=0;s<e.length;++s)e[s]!==a.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING&&(t+=this.estimateTriangleCountAtSettingIndex(e[s])*a.ls1.BYTES_PER_TRIANGLE,i=!0);return t+(i?this.totalEntityCount*a.ls1.BYTES_PER_ENTITY:0)}shouldProduceLocalThumbnail(){const e=!this.isOpenCompositeBody;return this.isModifiable&&!this.isClosedCompositeConstituent&&!this.isForFlattenedView()&&(!e||this.hasTessellationSettings())}updateConstituentTypeCounts(e){if(!this.isComposite)return;this.constituentTypeCounts.fill(0);const t=new Set;for(let i=0;i<this.constituentBodyIds_.length;i++){const s=this.constituentBodyIds_[i],n=e.getBodyType(s);n===a.wG2.SOLID?this.constituentTypeCounts[p.PART]++:n===a.wG2.SHEET?this.constituentTypeCounts[p.SURFACE]++:n===a.wG2.WIRE?this.constituentTypeCounts[p.CURVE]++:n===a.wG2.POINT?this.constituentTypeCounts[p.POINT]++:null===n&&e.accumulateSketchIdsFromBodyId(s,t)}this.constituentTypeCounts[p.SKETCH]=t.size}updateDataDerivedFromConstituents(e,t){if(!this.isComposite)return;this.constituentsContainMesh=!1,this.type=null;const i=e=>{null===this.type?this.type=e:this.type!==e&&(this.type=a.wG2.UNKNOWN)};for(let s=0;s<this.constituentBodyIds_.length;++s){const n=this.constituentBodyIds_[s],r=t[n];if(r){this.constituentsContainMesh=this.constituentsContainMesh||a.QsM.containsMesh(r.closedConstituentPartData.meshState),i(r.closedConstituentPartData.bodyType);continue}const o=e[n];o&&(this.constituentsContainMesh=this.constituentsContainMesh||a.QsM.containsMesh(o.meshState),i(o.type))}null===this.type&&(this.type=a.wG2.UNKNOWN)}getConstituentsContainMesh(){return this.constituentsContainMesh}getName(){return this.name}getIsFromSketch(){return this.isSketchBody}}function T(e){return(0,h.dS)(e?e.type:a.wG2.UNKNOWN)}(0,o.s)((function(e,t){const i=t.getBodyId(),s=t.getMeshIncrement();if(!i||!s)return null;const n=new S(i);return n.type=e,n.bounds=s.getBounds(),n}))},98883:function(e,t,i){i.d(t,{BW:function(){return v},EH:function(){return O},QQ:function(){return R},QV:function(){return N},XX:function(){return P},gm:function(){return w},ol:function(){return A},rY:function(){return _},wA:function(){return b}});var s=i(94014),n=i(47178),r=i(17922),a=i(55858);if(666==i.j)var o=i(60939);if(666==i.j)var h=i(18265);var c=i(72751);if(666==i.j)var l=i(37654);var u=i(83057),d=i(81194),g=i(99826),p=i(90645),m=i(23056),f=i(80462),I=i(95417),E=i(21324);if(666==i.j)var S=i(11525);const T=r.default.getManager();let D=1;const M=a.fromValues(1,0,0),C=a.fromValues(0,1,0),y=a.fromValues(0,0,1);class P extends(666==i.j?n.T:null){constructor(e){super(),this.viewer=e,this.dragManipulator=null,this.lockedManipulator=null,this.sequenceId=0,(0,I.viewerCheck)(e)}remove(){this.stopListening(),this.removeGraphicsManipulator()}show(){this.lockedManipulator?.show(),this.dragManipulator?.show()}hide(){this.lockedManipulator?.hide(),this.dragManipulator?.hide()}removeGraphicsManipulator(){this.dragManipulator&&(this.dragManipulator.remove(),this.dragManipulator=null),this.lockedManipulator&&(this.lockedManipulator.remove(),this.lockedManipulator=null)}getManipulatorId(){return this.manipulatorData?this.manipulatorData.manipulatorId:""}removeGraphicsManipulatorIfCannotBeDisplayed(){return!(0,I.canPointBeDisplayed)(this.manipulatorData.getDisplayLocation())&&(this.removeGraphicsManipulator(),c.log.info("Did not display feature manipulator(s), likely because it was out of bounds."),!0)}setManipulatorData(e,t){this.manipulatorData=e,this.removeGraphicsManipulatorIfCannotBeDisplayed()||(this.dragManipulator&&this.dragManipulator.isBeingManipulated()?this.updateLockedManipulator():this.updateDragManipulator(t))}updateDragManipulator(e){}updateLockedManipulator(){}sendValue(e,t){this.manipulatorData&&this.trigger(g.jC.VALUE_CHANGED,this.manipulatorData.manipulatorId,e,this.sequenceId,!!t)}onManipulationStarted(){this.sequenceId=D++,this.trigger(g.jC.MANIPULATION_STARTED,this.manipulatorData.manipulatorId,this.sequenceId,this.manipulatorData.primaryParameterId)}onManipulationEnded(){this.lockedManipulator&&(this.lockedManipulator.remove(),this.lockedManipulator=null),this.trigger(g.jC.MANIPULATION_ENDED,this.manipulatorData.manipulatorId,this.sequenceId,this.manipulatorData.primaryParameterId)}sendValueWithNoDrag(e){this.onManipulationStarted(),this.sendValue(e,!0),this.onManipulationEnded()}computeCenterOfOccurrenceBounds(e,t){let i=0,s=a.create();return e.forEach((e=>{const n=u._oC.getOccurrenceFromPathString(e),r=t.getOccurrenceBounds(n);let a=null;r&&r.isFinite()&&(a=r.center(),f.S4.add(a,s,s),++i)})),i<1?null:(i>1&&(s=f.S4.scale(s,1/i)),s)}}class A extends(666==i.j?P:null){constructor(e){super(e),this.dragManipulator=null,this.lockedManipulator=null,this.manipulatorData=null,this.cachedBaseOccurrenceTransform=null}isManipulatorInGlobalCoordinateSystem(e){return!e.useCenterOfBoundsOfSourceIds&&(null===e.baseOccurrencePath||0===e.baseOccurrencePath.length)}convertLocalToWorldManipulatorData(e){if(this.isManipulatorInGlobalCoordinateSystem(e))return e;const t=e.clone(),i=(0,E.uQ)();if(!i)return e;const s=i.getModelViewManagers().getManager();if(!s)return e;if(!u._oC.getOccurrenceFromPathString(e.baseOccurrencePath))return e;if(0===e.sourceIds.length)return e;const n=i.getOccurrenceIdManager().getIdForName(e.baseOccurrencePath);if(n===m.Qy)return e;const r=this.viewer.getOccurrenceDataManager().getOccurrenceTransform(n),h=new u.d0F,c=f.w$.toMat3(r,o.create());let l=f.xB.multiplyVec3(c,e.direction.getVec3(),a.create());l=f.S4.normalize(l,a.create()),h.updateFromArray(l),t.direction=h;const d=new u.d0F,g=this.computeCenterOfOccurrenceBounds(e.sourceIds,s);return g&&(d.updateFromArray(g),t.base=d),t}updateManipulatorFromDefinition(e){if(this.manipulatorData){if(e.setId(this.manipulatorData.manipulatorId),e.setStyle(this.manipulatorData.style),this.isManipulatorInGlobalCoordinateSystem(this.manipulatorData))e.updateDefinition(this.manipulatorData.base.getVec3(),this.manipulatorData.direction.getVec3(),this.manipulatorData.getValue().offset);else{const t=this.cachedBaseOccurrenceTransform?this.cachedBaseOccurrenceTransform:this.convertLocalToWorldManipulatorData(this.manipulatorData);if(this.cachedBaseOccurrenceTransform)e.updateDefinition(t.base.getVec3(),t.direction.getVec3(),this.manipulatorData.getValue().offset);else{const i=this.manipulatorData.getValue().offset<0;e.updateDefinitionForLocalManipulatorAtRest(t.base.getVec3(),t.direction.getVec3(),i)}}e.updateLimits(this.manipulatorData.minValue,this.manipulatorData.maxValue)}}setManipulatorData(e){this.manipulatorData=e,this.removeGraphicsManipulatorIfCannotBeDisplayed()||(!this.isManipulatorInGlobalCoordinateSystem(this.manipulatorData)&&this.dragManipulator||this.updateDragManipulator(),this.isManipulatorInGlobalCoordinateSystem(this.manipulatorData)&&this.dragManipulator&&this.dragManipulator.isBeingManipulated()&&this.updateLockedManipulator())}onManipulationStarted(){super.onManipulationStarted(),this.isManipulatorInGlobalCoordinateSystem(this.manipulatorData)||(this.cachedBaseOccurrenceTransform=this.convertLocalToWorldManipulatorData(this.manipulatorData))}onManipulationEnded(){super.onManipulationEnded(),this.cachedBaseOccurrenceTransform&&(this.cachedBaseOccurrenceTransform=null,this.updateManipulatorFromDefinition(this.dragManipulator))}getFlipDirectionWhenNegative(){return this.manipulatorData?.style!==u.xKD.SIMPLE}updateDragManipulator(){this.dragManipulator||(this.dragManipulator=new I.Linear(this.viewer),this.dragManipulator.setFlipDirectionWhenNegative(this.getFlipDirectionWhenNegative()),this.listenTo(this.dragManipulator,g.Wb.VALUE_CHANGED,this.onManipulatorValueChanged),this.listenTo(this.dragManipulator,g.Wb.VALUE_EDITED,this.onManipulatorValueEdited),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_STARTED,this.onManipulationStarted),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_ENDED,this.onManipulationEnded),this.listenTo(this.dragManipulator,g.Wb.CLICKED,this.onManipulatorFlipped)),this.updateManipulatorFromDefinition(this.dragManipulator)}updateLockedManipulator(){this.lockedManipulator||(this.lockedManipulator=new I.Linear(this.viewer),this.lockedManipulator.setFlipDirectionWhenNegative(this.getFlipDirectionWhenNegative()),this.lockedManipulator.setIsEnabled(!1)),this.updateManipulatorFromDefinition(this.lockedManipulator)}onManipulatorValueChanged(){if(!this.dragManipulator)return;const e=new u.Ygf;e.offset=this.dragManipulator.getOffset(),this.sendValue(e)}onManipulatorValueEdited(){if(!this.dragManipulator)return;const e=new u.Ygf;e.offset=this.dragManipulator.getEditOffset(),this.sendValueWithNoDrag(e)}onManipulatorFlipped(){if(!this.dragManipulator)return;const e=-this.manipulatorData.getValue().offset;if(e<this.manipulatorData.minValue||e>this.manipulatorData.maxValue||0===e)return;const t=new u.Ygf;t.offset=e,this.sendValueWithNoDrag(t);const i=this.manipulatorData?.getValue();i.offset=-i.offset,this.manipulatorData?.updateClientGraphicsOnFlip&&this.updateDragManipulator(),this.viewer.doPreHighlightPick()}}class O extends(666==i.j?P:null){constructor(e){super(e),this.dragManipulator=null,this.lockedManipulator=null,this.manipulatorData=null,this.cachedManipulatorData=null}setManipulatorData(e){this.manipulatorData=e,this.removeGraphicsManipulatorIfCannotBeDisplayed()||(this.updateDragManipulator(),this.dragManipulator&&this.dragManipulator.isBeingManipulated()&&this.updateLockedManipulator())}isManipulatorInGlobalCoordinateSystem(e){return!e.useCenterOfBoundsOfSourceIds&&(null===e.baseOccurrencePath||0===e.baseOccurrencePath.length)}convertLocalToWorldManipulatorData(e){if(this.isManipulatorInGlobalCoordinateSystem(e))return e;const t=(0,E.uQ)();if(!t)return e;const i=t.getModelViewManagers().getManager();if(!i)return e;if(!u._oC.getOccurrenceFromPathString(e.baseOccurrencePath))return e;if(0===e.sourceIds.length)return e;const s=t.getOccurrenceIdManager().getIdForName(e.baseOccurrencePath);if(s===m.Qy)return e;const n=this.viewer.getOccurrenceDataManager().getOccurrenceTransform(s),r=f.w$.toMat3(n,o.create()),c=e.axisDirection.getVec3(),l=f.xB.multiplyVec3(r,c,a.create());f.S4.normalize(l);const g=e.clone();g.axisDirection.updateFromArray(l);const p=this.computeCenterOfOccurrenceBounds(e.sourceIds,i);if(!p)return e;let I=null,S=f.w$.multiplyVec3(n,e.axisOrigin.getVec3(),a.create());const T=f.S4.subtract(p,S,a.create()),D=(0,d.areUnitVectorsParallel)(f.S4.normalize(T,a.create()),l);if((0,d.arePointsCoincident)(S,p)||D){I=this.getVectorNormalTo(c);const e=.01;f.S4.scale(I,e),I=f.xB.multiplyVec3(r,I,a.create()),g.axisOrigin.updateFromArray(p),S=p}else{const e=a.dot(T,l),t=f.S4.add(S,f.S4.scale(l,e,a.create()));g.axisOrigin.updateFromArray(t),I=f.S4.subtract(p,t,a.create())}if(I){const t=f.Jb.toMat4(f.Jb.fromAngleAxis(-e.getValue().angle,l),h.create());I=f.w$.multiplyVec3(t,I);const i=f.S4.add(I,S,a.create());g.rotationOrigin.updateFromArray(i)}return g}getVectorNormalTo(e){return(0,d.areUnitVectorsParallel)(M,e)?a.clone(C):(0,d.areUnitVectorsParallel)(C,e)?a.clone(y):(0,d.areUnitVectorsParallel)(y,e)?a.clone(M):f.S4.normalize(f.S4.getAPerpendicularVector(e))}updateManipulatorFromDefinition(e){if(this.manipulatorData)if(this.isManipulatorInGlobalCoordinateSystem(this.manipulatorData)){const t=f.S4.subtract(this.manipulatorData.rotationOrigin.getVec3(),this.manipulatorData.axisOrigin.getVec3(),a.create()),i=f.S4.length(t);f.S4.normalize(t),e.setId(this.manipulatorData.manipulatorId),e.updateDefinition(this.manipulatorData.axisOrigin.getVec3(),this.manipulatorData.axisDirection.getVec3(),t,i,this.manipulatorData.getValue().angle),e.updateLimits(this.manipulatorData.minValue,this.manipulatorData.maxValue),e.setStyle(this.manipulatorData.style),e.setDisableMinimumOffset(this.manipulatorData.disableMinimumOffset)}else{const t=this.cachedManipulatorData?this.cachedManipulatorData:this.convertLocalToWorldManipulatorData(this.manipulatorData),i=f.S4.subtract(t.rotationOrigin.getVec3(),t.axisOrigin.getVec3(),a.create()),s=f.S4.length(i);f.S4.normalize(i),e.setId(t.manipulatorId),e.updateDefinition(t.axisOrigin.getVec3(),t.axisDirection.getVec3(),i,s,t.getValue().angle),e.updateLimits(t.minValue,t.maxValue),e.setStyle(t.style),e.setDisableMinimumOffset(t.disableMinimumOffset)}}createManipulator(){return this.manipulatorData?.style===u.xKD.SIMPLE?new I.Angular(this.viewer):new I.AngularWithArrow(this.viewer)}updateDragManipulator(){this.dragManipulator||(this.dragManipulator=this.createManipulator(),this.listenTo(this.dragManipulator,g.Wb.VALUE_CHANGED,this.onManipulatorValueChanged),this.listenTo(this.dragManipulator,g.Wb.VALUE_EDITED,this.onManipulatorValueEdited),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_STARTED,this.onManipulationStarted),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_ENDED,this.onManipulationEnded),this.listenTo(this.dragManipulator,g.Wb.CLICKED,this.onManipulatorFlipped)),this.updateManipulatorFromDefinition(this.dragManipulator)}updateLockedManipulator(){this.lockedManipulator||(this.lockedManipulator=this.createManipulator(),this.lockedManipulator.setIsEnabled(!1)),this.updateManipulatorFromDefinition(this.lockedManipulator)}onManipulationStarted(){super.onManipulationStarted(),this.isManipulatorInGlobalCoordinateSystem(this.manipulatorData)||(this.cachedManipulatorData=this.convertLocalToWorldManipulatorData(this.manipulatorData))}onManipulationEnded(){super.onManipulationEnded(),this.cachedManipulatorData&&(this.cachedManipulatorData=null,this.updateManipulatorFromDefinition(this.dragManipulator))}onManipulatorValueChanged(){if(!this.dragManipulator)return;const e=new u.N1L;e.angle=this.dragManipulator.getAngle(),this.sendValue(e)}onManipulatorValueEdited(){if(!this.dragManipulator)return;const e=new u.N1L;e.angle=this.dragManipulator.getAngle(),this.sendValueWithNoDrag(e)}onManipulatorFlipped(){if(!this.dragManipulator||this.manipulatorData.minValue*this.manipulatorData.maxValue>=0)return;const e=new u.N1L;e.angle=-this.manipulatorData.getValue().angle,this.sendValueWithNoDrag(e);const t=this.manipulatorData.getValue();t.angle=-t.angle,this.manipulatorData?.updateClientGraphicsOnFlip&&this.updateDragManipulator(),this.viewer.doPreHighlightPick()}}class v extends(666==i.j?P:null){constructor(e){super(e),this.dragManipulator=null,this.lockedManipulator=null,this.manipulatorData=null}updateManipulatorFromDefinition(e){if(!this.manipulatorData)return;let t=this.manipulatorData.direction.getVec3();if(this.manipulatorData.getValue().flipped){const e=this.manipulatorData.otherDirection.getVec3();f.S4.length(e)>0?t=e:f.S4.scale(t,-1)}e.setId(this.manipulatorData.manipulatorId),e.setStyle(this.manipulatorData.style),e.updateDefinition(this.manipulatorData.base.getVec3(),t,0)}updateDragManipulator(){this.dragManipulator||(this.dragManipulator=new I.Linear(this.viewer),this.dragManipulator.setShaftLength(T.getNumber("MANIPULATOR_FLIP_SHAFT_LENGTH_PX")),this.dragManipulator.setIsDraggable(!1),this.listenTo(this.dragManipulator,g.Wb.CLICKED,this.onManipulatorFlipped)),this.updateManipulatorFromDefinition(this.dragManipulator)}updateLockedManipulator(){this.lockedManipulator||(this.lockedManipulator=new I.Linear(this.viewer),this.lockedManipulator.setShaftLength(T.getNumber("MANIPULATOR_FLIP_SHAFT_LENGTH_PX")),this.dragManipulator?.setIsDraggable(!1),this.lockedManipulator.setFlipDirectionWhenNegative(!0),this.lockedManipulator.setIsEnabled(!1)),this.updateManipulatorFromDefinition(this.lockedManipulator)}onManipulatorFlipped(){if(!this.dragManipulator)return;const e=new u.OHR;e.flipped=!this.manipulatorData?.getValue().flipped,this.sendValueWithNoDrag(e);const t=this.manipulatorData?.getValue();t.flipped=!t?.flipped,this.manipulatorData?.updateClientGraphicsOnFlip&&this.updateDragManipulator(),this.viewer.doPreHighlightPick()}}class R extends(666==i.j?P:null){constructor(e){super(e),this.manipulatorData=null,this.dragManipulator=null}updateManipulatorFromDefinition(e){if(!this.manipulatorData)return;const t=this.manipulatorData.points.map((e=>a.fromValues(e.x,e.y,e.z)));e.setId(this.manipulatorData.manipulatorId),e.setStyle(this.manipulatorData.style),e.updateDefinition(t,new Set([this.manipulatorData.getValue().index]))}updateDragManipulator(){this.dragManipulator||(this.dragManipulator=new I.PointSelection(this.viewer,!1),this.listenTo(this.dragManipulator,g.Wb.VALUE_CHANGED,this.onManipulatorValueChanged)),this.updateManipulatorFromDefinition(this.dragManipulator)}onManipulatorValueChanged(e){const t=new u.DxO;t.index=e.findIndex((e=>e)),this.sendValueWithNoDrag(t)}}class w extends(666==i.j?P:null){constructor(e){super(e),this.manipulatorData=null,this.dragManipulator=null}updateManipulatorFromDefinition(e){if(!this.manipulatorData)return;const t=this.manipulatorData.points.map((e=>a.fromValues(e.x,e.y,e.z)));e.setId(this.manipulatorData.manipulatorId),e.setStyle(this.manipulatorData.style);const i=this.manipulatorData.getValue();e.updateDefinition(t,new Set(i?.selectedIndices),new Set(this.manipulatorData.suppressedIndices))}updateDragManipulator(e){this.dragManipulator||(this.dragManipulator=new I.PointSelection(this.viewer,!0,e),this.listenTo(this.dragManipulator,g.Wb.VALUE_CHANGED,this.onManipulatorValueChanged)),this.updateManipulatorFromDefinition(this.dragManipulator)}onManipulatorValueChanged(e){const t=new u.kr3;t.selectedIndices=e.reduce(((e,t,i)=>(t&&e.push(i),e)),[]),this.sendValueWithNoDrag(t)}}class _ extends(666==i.j?P:null){constructor(e,t){super(t),this.dragManipulator=null,this.lockedManipulator=null,this.manipulatorData=null,this.dragStart=e.getValue().offset.getVec3()}updateManipulatorFromDefinition(e){if(!this.manipulatorData)return;const t=this.manipulatorData.base,i=this.manipulatorData.getValue().offset,s=h.create();s[12]=i.x+t.x,s[13]=i.y+t.y,s[14]=i.z+t.z,e.setId(this.manipulatorData.manipulatorId),e.setStyle(this.manipulatorData.style),e.updateDefinition(s)}updateDragManipulator(){if(!this.dragManipulator){const e={displayEditView:!1};this.dragManipulator=new I.Triad(this.viewer,g.Ak.DRAG,e),this.dragManipulator.setDisableInactiveComponents(!0),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_STARTED,this.onManipulationStarted),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_ENDED,this.onManipulationEnded),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_START,this.translationStart),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_CHANGE,this.translationChange),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_END,this.translationEnd)}this.dragStart=this.manipulatorData?.getValue().offset.getVec3(),this.updateManipulatorFromDefinition(this.dragManipulator)}updateLockedManipulator(){this.lockedManipulator||(this.lockedManipulator=new I.Triad(this.viewer,g.Ak.DRAG),this.lockedManipulator.setIsEnabled(!1)),this.updateManipulatorFromDefinition(this.lockedManipulator)}translationStart(){this.dragManipulator.isDragging=!0}translationChange(e){if(!this.dragManipulator)return;const t=new u.Kxj;t.offset=new u.d0F,t.offset.x=e[0]+this.dragStart[0],t.offset.y=e[1]+this.dragStart[1],t.offset.z=e[2]+this.dragStart[2],this.sendValue(t)}translationEnd(){this.dragManipulator.isDragging=!1}}class N extends(666==i.j?P:null){constructor(e,t,i){super(t),this.dragManipulator=null,this.lockedManipulator=null,this.manipulatorData=null,this.inferenceController=null,this.baseTransform=null,this.valueTransform=null,this.preRepositionTransform=null,this.lastSentPosition=null,this.receivedLastUpdate=!1,this.activeManipulatorEnum=u.pMe.NONE,this.editViewInputSubject=new l.x,this.editViewInputSubscription=null,this.manipulatorData=e,this.valueTransform=h.clone(e.getValue().transform.getGlMatrix()),this.baseTransform=h.clone(e.base.getGlMatrix()),this.coordinateDisplayFactory=(e,t)=>t.createInferenceDisplay(e),this.inferenceController=new s.ae(i,this.coordinateDisplayFactory,!0,!0,this.viewer,!0),this.listenTo(this.inferenceController,s.lp.MOUSE_ENTER,this.onEnterInference),this.listenTo(this.inferenceController,s.lp.MOUSE_LEAVE,this.onLeaveInference)}sendEditValue(){const e=new u.SP9;e.transform=new u.u8g;const t=h.multiply(h.create(),h.invert(h.create(),this.baseTransform),this.dragManipulator.transform);e.transform.updateFromGlMatrix(t),e.dragType=u.pMe.NONE,this.sendValueWithNoDrag(e),this.lastSentPosition=t,this.receivedLastUpdate=!1,this.editViewInputSubscription.unsubscribe()}updateManipulatorFromDefinition(e){if(!this.manipulatorData)return;const t=this.manipulatorData.getValue().transform.getGlMatrix(),i=this.manipulatorData.base.getGlMatrix();e.setId(this.manipulatorData.manipulatorId),e.setStyle(this.manipulatorData.style),e.updateDefinition(h.multiply(h.create(),i,t)),h.equals(i,this.baseTransform)||(this.valueTransform=h.clone(t),this.baseTransform=h.clone(i),e.removeEditViewAndHighlights()),this.lastSentPosition&&(h.equals(t,this.lastSentPosition)?this.receivedLastUpdate=!0:this.receivedLastUpdate&&e.removeEditViewAndHighlights())}updateDragManipulator(){if(!this.dragManipulator){const e={displayEditView:this.manipulatorData.displayEditView};this.dragManipulator=new I.Triad(this.viewer,g.Ak.FULL,e),this.dragManipulator.updateAngleRange(-2*Math.PI,2*Math.PI),this.dragManipulator.updateEditAngleRange(-2*Math.PI,2*Math.PI),this.dragManipulator.setDisableInactiveComponents(!0),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_STARTED,this.onManipulationStarted),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_ENDED,this.onManipulationEnded),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_START,this.onDragStart),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_CHANGE,this.onTransformDragEdit),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_EDIT,this.onTransformEdit),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_END,this.onDragEnd),this.listenTo(this.dragManipulator,p.w0.ROTATION_START,this.onDragStart),this.listenTo(this.dragManipulator,p.w0.ROTATION_CHANGE,this.onTransformDragEdit),this.listenTo(this.dragManipulator,p.w0.ROTATION_EDIT,this.onTransformEdit),this.listenTo(this.dragManipulator,p.w0.ROTATION_END,this.onDragEnd),this.listenTo(this.dragManipulator,p.w0.REPOSITION_START,this.onTriadRepositionStarted),this.listenTo(this.dragManipulator,p.w0.REPOSITION_END,this.onTriadRepositionEnded)}this.updateManipulatorFromDefinition(this.dragManipulator),this.valueTransform=h.clone(this.manipulatorData?.getValue()?.transform?.getGlMatrix()),this.baseTransform=h.clone(this.manipulatorData?.base?.getGlMatrix())}updateLockedManipulator(){this.lockedManipulator||(this.lockedManipulator=new I.Triad(this.viewer,g.Ak.FULL),this.lockedManipulator.setIsEnabled(!1)),this.updateManipulatorFromDefinition(this.lockedManipulator)}getActiveManipulatorDragType(){switch(this.dragManipulator.activeManipulator.getId()){case"TRIAD_X_ROTATION":return u.pMe.ROTATION_X;case"TRIAD_Y_ROTATION":return u.pMe.ROTATION_Y;case"TRIAD_Z_ROTATION":return u.pMe.ROTATION_Z;case"TRIAD_X_DIRECTION":return u.pMe.LINEAR_X;case"TRIAD_Y_DIRECTION":return u.pMe.LINEAR_Y;case"TRIAD_Z_DIRECTION":return u.pMe.LINEAR_Z;case"TRIAD_XY_PLANE":return u.pMe.PLANAR_XY;case"TRIAD_XZ_PLANE":return u.pMe.PLANAR_XZ;case"TRIAD_YZ_PLANE":return u.pMe.PLANAR_YZ;case"TRIAD_FREE_DRAG":return u.pMe.REPOSITION;default:return u.pMe.NONE}}onDragStart(){this.dragManipulator.isDragging=!0,this.receivedLastUpdate=!1,this.activeManipulatorEnum=this.getActiveManipulatorDragType()}onTransformDragEdit(){if(!this.dragManipulator||!this.dragManipulator.isDragging||this.dragManipulator.getIsLocked())return;const e=new u.SP9;e.transform=new u.u8g,e.transform.updateFromGlMatrix(h.multiply(h.create(),h.invert(h.create(),this.baseTransform),this.dragManipulator.transform)),e.dragType=this.activeManipulatorEnum,this.sendValue(e)}onDragEnd(){this.dragManipulator.isDragging=!1,this.lastSentPosition=h.multiply(h.create(),h.invert(h.create(),this.baseTransform),this.dragManipulator.transform),this.activeManipulatorEnum=u.pMe.NONE}onTransformEdit(){this.editViewInputSubscription&&!this.editViewInputSubscription.closed||(this.editViewInputSubscription=this.editViewInputSubject.pipe((0,S.b)(250)).subscribe((()=>this.sendEditValue()))),this.editViewInputSubject.next()}onTriadRepositionStarted(){this.inferenceController?.startInferencing(),this.preRepositionTransform=h.clone(this.valueTransform)}sendRepositionStartTranform(){if(null===this.preRepositionTransform)return;const e=new u.SP9;e.transform=new u.u8g,e.transform.updateFromGlMatrix(this.preRepositionTransform),this.sendValue(e)}onTriadRepositionEnded(e){this.inferenceController?.stopInferencing(),this.preRepositionTransform=null}onEnterInference(e){if(!e)return;const t=new u.SP9;t.transform=new u.u8g;const i=e.coordinateSystem.getGlMatrix();t.transform.updateFromGlMatrix(h.mul(h.create(),h.invert(h.create(),this.baseTransform),i)),this.sendValue(t),this.dragManipulator?.setIsLocked(!0)}onLeaveInference(e){this.dragManipulator?.setIsLocked(!1),this.sendRepositionStartTranform()}stopInferencing(){this.inferenceController?.stopInferencing()}}function b(e,t,i){return e instanceof u.EyX?new A(t):e instanceof u.AyX?new O(t):e instanceof u.bD3?new v(t):e instanceof u.CXU?new _(e,t):e instanceof u.Y6l?new R(t):e instanceof u.GR3?new w(t):e instanceof u.nBh?new N(e,t,i):null}},29396:function(e,t,i){function s(e,t,i){e.enable(e.STENCIL_TEST),e.stencilFunc(e.GREATER,t,i),e.stencilMask(0),e.stencilOp(e.KEEP,e.KEEP,e.KEEP)}function n(e,t,i){e.enable(e.STENCIL_TEST),e.stencilFunc(e.ALWAYS,t,255),e.stencilMask(i),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE)}function r(e,t,i){e.enable(e.STENCIL_TEST),e.stencilFunc(e.GREATER,t,i),e.stencilMask(i),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE)}function a(e){e.clearStencil(0),e.stencilMask(255),e.clear(e.STENCIL_BUFFER_BIT)}function o(e,t){e.clearStencil(0),e.stencilMask(t),e.clear(e.STENCIL_BUFFER_BIT)}i.d(t,{EZ:function(){return a},Ig:function(){return r},LL:function(){return s},Pq:function(){return o},U$:function(){return n}})},5852:function(e,t,i){var s;i.d(t,{Z:function(){return s}}),function(e){e[e.ONGOING=0]="ONGOING",e[e.COMPLETE=1]="COMPLETE"}(s||(s={}))},80285:function(e,t,i){var s;i.d(t,{H:function(){return s}}),function(e){e.Top="Top",e.Front="Front",e.Right="Right",e.UseFace="UseFace"}(s||(s={}))},65270:function(e,t,i){var s;i.d(t,{I:function(){return s}}),function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INSIDE=1]="INSIDE",e[e.INTERSECTING=2]="INTERSECTING"}(s||(s={}))},49258:function(e,t,i){i.d(t,{Wz:function(){return n},w:function(){return r},xV:function(){return s}});const s="curvatureColorMap",n="curvature-analysis-canvas-controls-preferred-location",r="curvatureAnalysis-canvas-controls"},93759:function(e,t,i){i.d(t,{DA:function(){return u},FZ:function(){return s},Xc:function(){return h},Yn:function(){return o},dN:function(){return a},je:function(){return r},nY:function(){return c},rx:function(){return d},uA:function(){return l},vM:function(){return n}});class s{constructor(){this.ignoreSpaceParameters=!1,this.displayLimitRangeText=!0,this.displayLimitRangeTicks=!1,this.textReadOnly=!1,this.textPrefix=""}}function n(e){return e&&e.isDimension()}function r(e){return e&&"AngularDimension"===e.getId()}function a(e){return e&&"ArcLengthDimension"===e.getId()}function o(e){return e&&"CurveLengthDimension"===e.getId()}function h(e){return e&&"EllipseDiameterDimension"===e.getId()}function c(e){return e&&"LinearDimension"===e.getId()}function l(e){return e&&"CenterlineDimension"===e.getId()}function u(e){return e&&"RadialDimension"===e.getId()}function d(e){return e&&"CountDimension"===e.getId()}},39212:function(e,t,i){i.d(t,{i:function(){return s}});const s=function(e){return e.isEdge()&&!e.isInternalEdge()&&e.isFromBody()&&!e.isFromWireBody()&&e.getBodyMetaData()?.isModifiableBody()}},84605:function(e,t,i){var s;i.d(t,{Q:function(){return s}}),function(e){e.FULL="full",e.INTERACTIVE="interactive",e.MANIPULATING="manipulating"}(s||(s={}))},72459:function(e,t,i){i.d(t,{M:function(){return s}});const s=.3},44398:function(e,t,i){var s;i.d(t,{Po:function(){return n},aU:function(){return r},o2:function(){return s}}),function(e){e.UI="UI",e.RELATED_OCCURRENCE="RELATED_OCCURRENCE",e.RELATED_OCCURRENCE_MATE="RELATED_OCCURRENCE_MATE",e.ACCUMULATED_SMART_SELECTION="ACCUMULATED_SMART_SELECTION",e.SMART_SELECTION="SMART_SELECTION",e.ENTITY="ENTITY",e.UI_RELATED_ENTITY="UI_RELATED_ENTITY",e.FEATURE="FEATURE",e.PART="PART",e.OCCURRENCE="OCCURRENCE",e.OCCURRENCE_COMMENT="OCCURRENCE_COMMENT",e.COMMENT="COMMENT",e.FILTERED_ENTITIES="FILTERED_ENTITIES",e.OCCURRENCE_PRE="OCCURRENCE_PRE",e.PRE="PRE",e.ERROR="ERROR",e.SECONDARY="SECONDARY",e.SECONDARY_PRE="SECONDARY_PRE",e.OCCURRENCE_SECONDARY_PRE="OCCURRENCE_SECONDARY_PRE",e.ASSOCIATED_OCCURRENCE="ASSOCIATED_OCCURRENCE",e.ASSOCIATED_OCCURRENCE_PRE="ASSOCIATED_OCCURRENCE_PRE",e.INCONTEXT_REFERENCE="INCONTEXT_REFERENCE",e.INCONTEXT_REFERENCE_PRE="INCONTEXT_REFERENCE_PRE",e.RETRIEVAL="RETRIEVAL",e.OPERATION_PERSISTENT="OPERATION_PERSISTENT",e.REPAIR="REPAIR",e.REPAIR_HOVER="REPAIR_HOVER",e.PROFILE_INSPECTOR="PROFILE_INSPECTOR",e.PROFILE_INSPECTOR_FOCUS="PROFILE_INSPECTOR_FOCUS"}(s||(s={}));const n=[s.UI,s.ACCUMULATED_SMART_SELECTION,s.SMART_SELECTION,s.ENTITY,s.FEATURE,s.PART,s.OCCURRENCE,s.SECONDARY];var r;!function(e){e[e.REMOVE=0]="REMOVE",e[e.ADD=1]="ADD"}(r||(r={}))},33257:function(e,t,i){var s;i.d(t,{t:function(){return s}}),function(e){e[e.LEFT=1]="LEFT",e[e.MIDDLE=2]="MIDDLE",e[e.RIGHT=3]="RIGHT"}(s||(s={}))},81172:function(e,t,i){var s;i.d(t,{P:function(){return s}}),function(e){e[e.MAKE_TRANSPARENT=0]="MAKE_TRANSPARENT",e[e.ISOLATE=1]="ISOLATE"}(s||(s={}))},99826:function(e,t,i){var s,n,r;function a(e){return e.isManipulator()}function o(e){return void 0!==e.getAngle}function h(e){return void 0!==e.ray}function c(e){return void 0!==e.origin}function l(e){return void 0!==e.lastMouseRay}i.d(t,{Ak:function(){return s},Kg:function(){return o},Kl:function(){return h},LD:function(){return a},MJ:function(){return l},Wb:function(){return n},jC:function(){return r},xD:function(){return c}}),function(e){e.EXPLODE_CONVENIENCE_MANIPULATOR="explodeConvenienceManipulator",e.DRAG="drag",e.FULL="full",e.PLANE="plane",e.SKETCH="sketch",e.UNKNOWN="unknown"}(s||(s={})),function(e){e.MANIPULATION_STARTED="manipulationstarted",e.MANIPULATION_ENDED="manipulationended",e.VALUE_CHANGED="valuechanged",e.VALUE_EDITED="valueedited",e.CACHE_TRANSFORM="cachetransform",e.CLICKED="clicked",e.DOUBLE_CLICKED="doubleclicked",e.MANIPULATOR_ENTER="enter",e.MANIPULATOR_LEAVE="leave"}(n||(n={})),function(e){e.MANIPULATION_STARTED="manipulationstarted",e.VALUE_CHANGED="valuechanged",e.MANIPULATION_ENDED="manipulationended"}(r||(r={}))},33212:function(e,t,i){i.d(t,{G2:function(){return a},X5:function(){return n},ZB:function(){return r},s_:function(){return s}});const s="sectionPlaneSelection";let n=!1;function r(){n=!0}function a(){n=!1}},44505:function(e,t,i){i.d(t,{I:function(){return n},S:function(){return s}});const s="simulationColorMap",n="sim-canvas-controls"},70523:function(e,t,i){i.d(t,{LI:function(){return n},_s:function(){return r},bY:function(){return a},d0:function(){return s}});const s="thicknessColorMap",n="thickness-analysis-canvas-controls-panel",r="thicknessAnalysis-canvas-controls";var a;!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.PROCESSING=1]="PROCESSING",e[e.RETRIEVING=2]="RETRIEVING",e[e.PREPARING=3]="PREPARING",e[e.CALCULATING=4]="CALCULATING",e[e.REFINING=5]="REFINING",e[e.POSTPROCESSING=6]="POSTPROCESSING",e[e.COMPLETE=7]="COMPLETE"}(a||(a={}))},90645:function(e,t,i){var s,n,r;i.d(t,{tF:function(){return r},vn:function(){return n},w0:function(){return s}}),function(e){e.REPOSITION_START="repositionStart",e.REPOSITION="reposition",e.REPOSITION_END="repositionEnd",e.ROTATION_START="rotationStart",e.ROTATION_CHANGE="rotationChange",e.ROTATION_END="rotationEnd",e.ROTATION_EDIT="rotationEdit",e.TRANSLATION_START="translationStart",e.TRANSLATION_CHANGE="translationChange",e.TRANSLATION_END="translationEnd",e.TRANSLATION_EDIT="translationEdit",e.SCALING_START="scalingStart",e.SCALING_CHANGE="scalingChange",e.SCALING_END="scalingEnd",e.SCALING_EDIT="scalingEdit",e.COMMAND="componentCommand",e.ENTER_INFERENCE="enterInference",e.LEAVE_INFERENCE="leaveInference",e.DOUBLE_CLICKED="doubleClicked"}(s||(s={})),function(e){e.X_ROTATION="TRIAD_X_ROTATION",e.Y_ROTATION="TRIAD_Y_ROTATION",e.Z_ROTATION="TRIAD_Z_ROTATION",e.X_DIRECTION="TRIAD_X_DIRECTION",e.Y_DIRECTION="TRIAD_Y_DIRECTION",e.Z_DIRECTION="TRIAD_Z_DIRECTION",e.XY_PLANE="TRIAD_XY_PLANE",e.XZ_PLANE="TRIAD_XZ_PLANE",e.YZ_PLANE="TRIAD_YZ_PLANE",e.FREE_DRAG="TRIAD_FREE_DRAG",e.SCALING="SCALING"}(n||(n={})),function(e){e[e.Origin=0]="Origin",e[e.X=1]="X",e[e.Y=2]="Y",e[e.Z=3]="Z"}(r||(r={}))},98609:function(e,t,i){function s(e){return e&&e.getId&&"image"===e.getId()}i.d(t,{AW:function(){return r},Eg:function(){return s},Wf:function(){return n}});class n{constructor(e,t,i,s,n,r,a,o,h){this.deterministicId=e,this.secondDeterministicId=t,this.occurrence=i,this.inferenceType=s,this.coordinateSystem=n,this.sourceIsFeature=r,this.meshPointData=null,this.isInContextEntity=!!a,this.isPartStudioMateConnector=!!o,this.isInstanceOrigin=!!h}}const r="clicked"},64089:function(e,t,i){var s;i.d(t,{k:function(){return s}}),function(e){e.NONE="none",e.ROTATE="rotate",e.AXIS_ROTATE="axisRotate",e.PAN="pan",e.ZOOM="zoom"}(s||(s={}))},76618:function(e,t,i){var s,n;i.d(t,{C:function(){return n},V:function(){return s}}),function(e){e[e.DEFAULT=0]="DEFAULT",e[e.COARSE=1]="COARSE",e[e.FINE=2]="FINE"}(s||(s={})),function(e){e.DEFAULT="default",e.CROSSHAIR="url(/images/crosshair-cursor.svg) 7.5 7.5,crosshair",e.HAND="hand",e.GRAB="grab",e.GRABBING="grabbing",e.POINTER="pointer",e.ZOOM_IN="zoom-in",e.MOVE="move",e.TEXT="text",e.WAIT="wait",e.HELP="help",e.N_RESIZE="n-resize",e.NE_RESIZE="ne-resize",e.NS_RESIZE="ns-resize",e.E_RESIZE="e-resize",e.EW_RESIZE="ew-resize",e.SE_RESIZE="se-resize",e.S_RESIZE="s-resize",e.SW_RESIZE="sw-resize",e.W_RESIZE="w-resize",e.NW_RESIZE="nw-resize",e.PROGRESS="progress",e.NOT_ALLOWED="not-allowed",e.NO_DROP="no-drop",e.VERTICAL_TEXT="vertical-text",e.ALL_SCROLL="all-scroll",e.COL_RESIZE="col-resize",e.ROW_RESIZE="row-resize",e.SNAPMATE_GENERIC="url(/images/cursors/macSnapMate_Cursor.svg) 7.5 7.5,url(/images/cursors/SnapMate_Cursor.png) 7.5 7.5,nesw-resize",e.CONFIRMATION_GENERIC="url(/images/cursors/macConfirmation_Cursor.svg) 1 1,url(/images/cursors/Confirmation_Cursor.png) 1 1,default",e.SNAPMATE_WINDOWS="url(/images/cursors/winSnapMate_Cursor.svg) 7.5 7.5,url(/images/cursors/SnapMate_Cursor.png) 7.5 7.5,nesw-resize",e.CONFIRMATION_WINDOWS="url(/images/cursors/winConfirmation_Cursor.svg) 1 1,url(/images/cursors/Confirmation_Cursor.png) 1 1,default",e.BOXDESELECTION_CURSORS_GENERIC="url(/images/cursors/macRemoveSelectionCursor.svg) 3 3,url(/images/cursors/macRemoveSelectionCursor-mdpi.png) 3 3,auto",e.BOXDESELECTION_CURSORS_WINDOWS="url(/images/cursors/winRemoveSelectionCursor.svg) 1 2,url(/images/cursors/winRemoveSelectionCursor-mdpi.png) 1 2,auto"}(n||(n={}))},32775:function(e,t,i){var s;i.d(t,{$:function(){return s}}),function(e){e.VR="immersive-vr",e.AR="immersive-ar"}(s||(s={}))},81621:function(e,t,i){var s;i.d(t,{L:function(){return s}}),function(e){e[e.BASE=0]="BASE",e[e.PREVIEW=1]="PREVIEW"}(s||(s={}))},66366:function(e,t,i){var s;i.d(t,{N:function(){return s}}),function(e){e.MINIMUM_RADIUS="minimum_radius",e.CURVATURE_COMBS="show_curvature",e.INFLECTION_POINTS="inflection_points",e.U_CURVES="u_curves",e.V_CURVES="v_curves",e.CROSS_FACE="cross_face",e.CPT_GRIDS="control_point_grids"}(s||(s={}))},97627:function(e,t,i){var s;i.d(t,{K:function(){return s},Y:function(){return n}}),function(e){e[e.EDGE_U=0]="EDGE_U",e[e.FACE_U=1]="FACE_U",e[e.FACE_V=2]="FACE_V"}(s||(s={}));class n{constructor(e,t){this.curvatureType=e,this.curvatureData=t}isEdgeCurvature(){return this.curvatureType===s.EDGE_U}isFaceUCurve(){return this.curvatureType===s.FACE_U}isFaceVCurve(){return this.curvatureType===s.FACE_V}isFaceCurvature(){return this.isFaceUCurve()||this.isFaceVCurve()}}},78613:function(e,t,i){i.d(t,{$_:function(){return S},A1:function(){return je},AD:function(){return V},Aw:function(){return et},CD:function(){return W},CJ:function(){return he},Cg:function(){return ve},Cr:function(){return ue},Cv:function(){return Xe},F5:function(){return pe},FM:function(){return d},Fc:function(){return Me},GO:function(){return nt},Gf:function(){return it},Hq:function(){return Ne},Hv:function(){return m},Ip:function(){return Ue},JF:function(){return G},JH:function(){return Ke},Jm:function(){return xe},Jp:function(){return we},KB:function(){return ht},KO:function(){return fe},LA:function(){return j},M1:function(){return me},Mp:function(){return ot},NM:function(){return F},Nf:function(){return tt},Nw:function(){return Qe},P1:function(){return te},PX:function(){return Ve},Q6:function(){return P},Qe:function(){return Oe},R1:function(){return st},RV:function(){return ye},Sr:function(){return de},Sz:function(){return re},T$:function(){return ce},TN:function(){return Ce},Uj:function(){return _e},V1:function(){return De},Vp:function(){return C},W2:function(){return k},WB:function(){return ze},WY:function(){return K},Wp:function(){return D},Xc:function(){return Ae},YW:function(){return ke},_h:function(){return U},a:function(){return x},aI:function(){return Ze},ad:function(){return Z},am:function(){return Re},b3:function(){return ne},b9:function(){return f},bh:function(){return Ie},bs:function(){return B},cW:function(){return b},cp:function(){return M},cu:function(){return A},cy:function(){return X},d:function(){return Ge},dP:function(){return v},eR:function(){return g},f4:function(){return at},fd:function(){return Ye},fu:function(){return Ee},gV:function(){return Pe},gW:function(){return Je},h0:function(){return ie},hj:function(){return Y},i$:function(){return y},iH:function(){return $e},ib:function(){return qe},kl:function(){return Te},m2:function(){return be},nh:function(){return Le},nu:function(){return lt},oG:function(){return ee},oL:function(){return oe},og:function(){return ct},ox:function(){return $},pB:function(){return c},pF:function(){return T},pK:function(){return O},pO:function(){return L},pU:function(){return Q},pj:function(){return Be},rw:function(){return ae},s4:function(){return _},sJ:function(){return z},sd:function(){return se},so:function(){return N},t0:function(){return q},tS:function(){return Se},u:function(){return R},u5:function(){return J},u9:function(){return I},uv:function(){return E},v9:function(){return ut},vk:function(){return We},vu:function(){return He},wf:function(){return H},xA:function(){return u},xy:function(){return Fe},yB:function(){return w},ye:function(){return le},zK:function(){return ge},zT:function(){return p},zi:function(){return rt}});var s=i(21324),n=i(47178);if(666==i.j)var r=i(16460);if(666==i.j)var a=i(39986);if(666==i.j)var o=i(2670);if(666==i.j)var h=i(49712);class c extends n.T{constructor(){super()}}let l=new c;function u(){if(s.uQ){const e=(0,s.uQ)();if(e)return e.getEventDispatcher()}return l}function d(e,t){t&&(t.setEventDispatcher(l),l=new c),e&&!t&&(l=e.getEventDispatcher(),e.setEventDispatcher(new c))}function g(e){return(0,r.R)((function(t){return u().on(e,t)}),(function(t){return u().off(e,t)}),(function(e){return arguments}))}const p="ACTIVE_VIEWER_SET",m="VIEW_WILL_DRAW",f="VIEW_WILL_PICK",I="VIEW_DID_DRAW",E="ASSEMBLY_TIMES",S="PART_STUDIO_TIMES",T="EVENT_NEEDS_ANGULAR_BROADCAST",D="ELEMENT_GRAPHICS_LOADING",M="ELEMENT_VIEW_INITIALIZED",C="ELEMENT_PREVIEW_GRAPHICS_LOADED",y="CLOSE_ANNOTATION_EDIT",P="DIMENSION_TEXT_SINGLE_CLICKED",A="DIMENSION_TEXT_DOUBLE_CLICKED",O="DIMENSION_EDIT_CLOSED",v="CLOSE_DIMENSION_EDIT",R="DIMENSION_DELETE_REQUEST",w="SHOW_DIMENSION_EXPRESSIONS_CHANGED",_="DIMENSION_TEXT_DRAG_ENDED",N="SESSION_ENDED",b="GL_CONTEXT_LOST",L="GL_CONTEXT_RESTORED",F="SELECT_OTHER",x="SELECT_OTHER_REVERSE",B="SHOW_SMART_SELECTION",V="CLOSE_SELECT_OTHER",U="SHOW_SKETCH_TEXT",G="SKETCH_COMMAND_ACTIVATED",H="CLOSE_SKETCH_SUB_DIALOG",k="NEW_PART_LIST",W="NON_TRIVIAL_PART_STUDIO_DATA_PROCESSED",z="PART_STUDIO_PART_VISIBILITY_CHANGED",X="PART_STUDIO_DATA_AND_SELECTION_REMAP_PROCESSED",Z="DISPLAYED_PART_STUDIO",q="DISPLAYED_ASSEMBLY",Y="ASSEMBLY_DATA_PROCESSED",K="DIMENSION_VALUE_CHANGED",j="BODIES_LOADED",Q="CANVAS_CLICK",$="CANVAS_MOUSEENTER",J="CANVAS_MOUSELEAVE",ee="CANVAS_MOUSEMOVE",te="CHANGE_FEATURE_APPEARANCE",ie="CHANGE_VIEW",se="GRAPHICS_HANDLED_CLICK_EVENT",ne="DEVICE_PIXEL_RATIO_CHANGED",re="SELECTION_REJECTED",ae="CLOSE_MATE_DOF_CHOOSER",oe="VIEW_CONTAINER_MENU_INVOKED",he="ANALYSIS_MENU_INVOKED",ce="CREATE_SECTION_PLANE_INFERENCE_CONTROLLER",le="DESTROY_SECTION_PLANE_INFERENCE_CONTROLLER",ue="DEFAULT_UNITS_CHANGED",de="SECTION_PLANE_ADDED",ge="SECTION_PLANE_REMOVED",pe="MAXIMUM_NUMBER_OF_SECTION_PLANES_REACHED",me="SECTION_VIEW_DIALOG_OPENED",fe="SECTION_VIEW_DIALOG_CLOSED",Ie="UPDATE_INCONTEXT_ISOLATION",Ee="UI_ELEMENT_CLICK",Se="VIEWER_CANVAS_ATTACHED_TO_CONTAINER",Te="ASSEMBLY_ANIMATE_MATE_STARTED",De="ASSEMBLY_ANIMATE_MATE_ENDED",Me="SPACEMOUSE_ACTION_SET_CHANGED",Ce="SPACEMOUSE_COMMANDS_RECEIVED",ye="SPACEMOUSE_COMMAND",Pe="WILL_RENDER_THUMBNAILS",Ae="DID_RENDER_THUMBNAILS",Oe="RETRIEVE_OCCURRENCE_DISPLAY_DATA",ve="RETRIEVE_ELEMENT_DISPLAY_DATA",Re="ADD_TEMPORARY_TESSELLATION_OVERRIDE",we="CLEAR_TEMPORARY_TESSELLATION_OVERRIDES",_e="RETRIEVE_SMOOTH_EDGE_INFORMATION",Ne="ACTIVE_SHEETMETAL_MODEL_CHANGED",be="BEFORE_PRINT_IMAGE_GENERATION",Le="AFTER_PRINT_IMAGE_GENERATION",Fe="SIMULATION_MINIMUM_CLICKED",xe="SIMULATION_MAXIMUM_CLICKED",Be="SIMULATION_RANGE_CHANGED",Ve="SIMULATION_LEGEND_OPENED",Ue="SIMULATION_LEGEND_CLOSED",Ge="THICKNESS_ANALYSIS_COLOR_MAPPING_CHANGED",He="THICKNESS_ANALYSIS_DISPLAYED_FIELD_CHANGED",ke="THICKNESS_ANALYSIS_MINIMUM_CLICKED",We="THICKNESS_ANALYSIS_MAXIMUM_CLICKED",ze="THICKNESS_ANALYSIS_RANGE_CHANGED",Xe="THICKNESS_ANALYSIS_LEGEND_OPENED",Ze="THICKNESS_ANALYSIS_LEGEND_CLOSED",qe="CURVATURE_ANALYSIS_LEGEND_MINIMUM_CLICKED",Ye="CURVATURE_ANALYSIS_LEGEND_MAXIMUM_CLICKED",Ke="CURVATURE_ANALYSIS_RANGE_CHANGED",je="CURVATURE_ANALYSIS_LEGEND_OPENED",Qe="CURVATURE_ANALYSIS_LEGEND_CLOSED",$e="CURVATURE_ANALYSIS_COLOR_MAPPING_CHANGED",Je="CURVATURE_ANALYSIS_CURVATURE_CONTROL_CHANGED",et="FOLLOW_MODE_LEADER_MOUSE_MOVED",tt="FOLLOW_MODE_LEADER_MOUSE_OUT",it="FOLLOW_MODE_DEACTIVATED",st="SIMULATION_RESULTS_DISPLAYED",nt="SIMULATION_CONNECTIONS_DISPLAYED",rt="NAMED_VIEW_APPLIED",at="PICKS_BOX_SELECTED",ot="PICK_CONSTRAINT_SELECTED",ht="BOX_SELECTION_FINISHED",ct="ANNOTATION_DRAG_COMPLETE",lt="ANNOTATION_DRAG_LEADER_COMPLETE";function ut(){const e=g(Z).pipe((0,a.h)((e=>e[1]))),t=g(q).pipe((0,a.h)((e=>e[1])));return e.pipe((0,o.b)(t),(0,h.q)(1))}},70026:function(e,t,i){i.d(t,{JE:function(){return n},U2:function(){return h},UQ:function(){return g},_6:function(){return o},c2:function(){return p},lm:function(){return a},nD:function(){return u},qR:function(){return l},rp:function(){return d},s:function(){return m},si:function(){return c},vN:function(){return r}});var s=i(13469);const n=666==i.j?[]:null,r=0,a=[1];var o,h;!function(e){e[e.DEFAULT=32]="DEFAULT",e[e.ENTITY=20]="ENTITY",e[e.OCCURRENCE_SLICE=12]="OCCURRENCE_SLICE",e[e.OCCURRENCE_ID=24]="OCCURRENCE_ID",e[e.HIGHLIGHT=16]="HIGHLIGHT"}(o||(o={})),function(e){e[e.ENTITY=1048575]="ENTITY",e[e.OCCURRENCE_SLICE=4095]="OCCURRENCE_SLICE"}(h||(h={}));class c{constructor(e){this.freeIds=[],this.nextId=a.slice(0);const t=e||o.DEFAULT;this.maximumElementSize=Math.pow(2,t)-1}clone(){const e=new c;return e.nextId=this.nextId.slice(0),e.freeIds=this.freeIds.slice(0),e.maximumElementSize=this.maximumElementSize,e}reset(){this.nextId=a.slice(0),this.freeIds=[]}getId(){if(this.freeIds.length>1)return this.freeIds.pop();const e=this.nextId.slice(0);let t,i=!1;for(t=0;t<this.nextId.length;++t)if(this.nextId[t]<this.maximumElementSize){this.nextId[t]=this.nextId[t]+1;for(let e=0;e<t;++e)this.nextId[e]=1;i=!0;break}if(!i){for(t=0;t<this.nextId.length;++t)this.nextId[t]=1;this.nextId.push(1)}return e}freeId(e){d(e)&&this.freeIds.push(e)}}function l(e){return e}function u(e,t){return(0,s.arraysEqual)(e,t)}function d(e){if(!e||e.length<1)return!1;for(let t=0;t<e.length;++t)if(e[t]===r)return!1;return!0}function g(e){const t=e.split(","),i=[];for(let e=0;e<t.length;e++)i.push(+t[e]);return i}const p=0;class m{constructor(e){this.freeIds=[],this.nextId=1;const t=e||o.DEFAULT;this.maximumNumberSize=Math.pow(2,t)-1}reset(){this.nextId=1,this.freeIds=[]}getId(){if(this.freeIds.length>1)return this.freeIds.pop();if(this.nextId===p)return p;const e=this.nextId++;return this.nextId>=this.maximumNumberSize&&(this.nextId=p),e}isIdValid(e){return e!==p}freeId(e){this.isIdValid(e)&&this.freeIds.push(e)}}},90631:function(e,t,i){i.d(t,{HqE:function(){return n.Hq},zTe:function(){return n.zT},am2:function(){return n.am},nhj:function(){return n.nh},ogA:function(){return n.og},nuS:function(){return n.nu},V11:function(){return n.V1},klk:function(){return n.kl},hjy:function(){return n.hj},uvd:function(){return n.uv},aUM:function(){return d.aU},ZK6:function(){return r.Z},m2d:function(){return n.m2},KB0:function(){return n.KB},AWD:function(){return D.AW},Pmj:function(){return p.P},LgS:function(){return O.L},pUS:function(){return n.pU},oxn:function(){return n.ox},u5l:function(){return n.u5},oGi:function(){return n.oG},P1w:function(){return n.P1},h02:function(){return n.h0},JpA:function(){return n.Jp},i$n:function(){return n.i$},dPN:function(){return n.dP},rwQ:function(){return n.rw},AD7:function(){return n.AD},wfd:function(){return n.wf},T$E:function(){return n.T$},Wzm:function(){return I.Wz},wao:function(){return I.w},iHz:function(){return n.iH},gWk:function(){return n.gW},Nwl:function(){return n.Nw},fdd:function(){return n.fd},ibh:function(){return n.ib},A1q:function(){return n.A1},JHq:function(){return n.JH},xV6:function(){return I.xV},CF9:function(){return P.C},CrY:function(){return n.Cr},ye3:function(){return n.ye},b3:function(){return n.b3},Xc0:function(){return n.Xc},uav:function(){return n.u},pKY:function(){return n.pK},cu9:function(){return n.cu},s4e:function(){return n.s4},Q6T:function(){return n.Q6},WYs:function(){return n.WY},t0J:function(){return n.t0},adC:function(){return n.ad},FZj:function(){return o.FZ},Wp_:function(){return n.Wp},Vpt:function(){return n.Vp},cpE:function(){return n.cp},pFt:function(){return n.pF},Gfg:function(){return n.Gf},Awy:function(){return n.Aw},NfU:function(){return n.Nf},QpP:function(){return c.Q},cWC:function(){return n.cW},pOz:function(){return n.pO},sdI:function(){return n.sd},Rng:function(){return s},$Ky:function(){return _.$K},o2L:function(){return d.o2},JE9:function(){return w.JE},Qyk:function(){return R.Qy},UKE:function(){return u},siw:function(){return w.si},_6$:function(){return w._6},Wfq:function(){return D.Wf},IiW:function(){return a.I},i8U:function(){return h.i},lLv:function(){return _.lL},F59:function(){return n.F5},kJR:function(){return y.k},tcH:function(){return g.t},ziX:function(){return n.zi},W2m:function(){return n.W2},CDm:function(){return n.CD},EBu:function(){return v.E},M81:function(){return l.M},sJs:function(){return n.sJ},$_3:function(){return n.$_},f4Y:function(){return n.f4},Mpj:function(){return n.Mp},Cgl:function(){return n.Cg},Qeo:function(){return n.Qe},Uj6:function(){return n.Uj},Vf$:function(){return P.V},s_Y:function(){return E.s_},Srw:function(){return n.Sr},zKA:function(){return n.zK},KOV:function(){return n.KO},M1t:function(){return n.M1},SzR:function(){return n.Sz},NMw:function(){return n.NM},aat:function(){return n.a},_hB:function(){return n._h},bsB:function(){return n.bs},GOH:function(){return n.GO},Ipz:function(){return n.Ip},PXv:function(){return n.PX},Jml:function(){return n.Jm},xy2:function(){return n.xy},pjn:function(){return n.pj},R1N:function(){return n.R1},JFj:function(){return n.JF},TN9:function(){return n.TN},vjd:function(){return S},LIN:function(){return T.LI},_s_:function(){return T._s},daY:function(){return n.d},vu3:function(){return n.vu},aIt:function(){return n.aI},CvC:function(){return n.Cv},vkO:function(){return n.vk},YWe:function(){return n.YW},WBF:function(){return n.WB},d07:function(){return T.d0},bY7:function(){return T.bY},bhj:function(){return n.bh},tSV:function(){return n.tS},oLC:function(){return n.oL},u9p:function(){return n.u9},Hvz:function(){return n.Hv},gV9:function(){return n.gV},dPT:function(){return M},qT7:function(){return C},$Xk:function(){return A.$},ZBF:function(){return E.ZB},G29:function(){return E.G2},uQB:function(){return b.uQ},xA2:function(){return n.xA},IOg:function(){return b.IO},v93:function(){return n.v9},N9r:function(){return b.N9},eRd:function(){return n.eR},PoX:function(){return d.Po},rp5:function(){return w.rp},nD6:function(){return w.nD},jeL:function(){return o.je},jep:function(){return o.dN},uAu:function(){return o.uA},rxY:function(){return o.rx},Yn_:function(){return o.Yn},vMe:function(){return o.vM},Xc1:function(){return o.Xc},Egl:function(){return D.Eg},nYd:function(){return o.nY},wLR:function(){return f},DAH:function(){return o.DA},tYI:function(){return N.t},Ykz:function(){return b.Yk}});var s,n=i(78613);!function(e){e[e.NORMAL=0]="NORMAL",e[e.AGGRESSIVE_USER_CAUSED=1]="AGGRESSIVE_USER_CAUSED"}(s||(s={}));var r=i(5852),a=i(65270);if(666==i.j)var o=i(93759);if(666==i.j)var h=i(39212);var c=i(84605);if(666==i.j)var l=i(72459);var u,d=i(44398),g=i(33257),p=i(81172),m=i(83057);function f(e){return e&&e.getElementType()===m.GNh.PARTSTUDIO}if(666==i.j)var I=i(49258);if(666==i.j)var E=i(33212);!function(e){e[e.NOT_SELECTED=0]="NOT_SELECTED",e[e.PREHILITE=1]="PREHILITE",e[e.SELECTED=2]="SELECTED",e[e.MUTED=3]="MUTED"}(u||(u={}));class S{constructor(){this.lowerLeft=null,this.lowerRight=null,this.upperLeft=null,this.pixelSize=1}}var T=i(70523);if(666==i.j)var D=i(98609);var M,C,y=i(64089),P=i(76618),A=i(32775);!function(e){e[e.DOMINANT=0]="DOMINANT",e[e.NON_DOMINANT=1]="NON_DOMINANT"}(M||(M={})),function(e){e[e.TRIGGER=0]="TRIGGER",e[e.SQUEEZE=1]="SQUEEZE",e[e.TOUCH_PAD_PRESS=2]="TOUCH_PAD_PRESS",e[e.THUMBSTICK_PRESS=3]="THUMBSTICK_PRESS",e[e.A=4]="A",e[e.B=5]="B"}(C||(C={}));var O=i(81621),v=i(64733),R=i(23056),w=i(70026);i(29307);if(666==i.j)var _=i(49192);var N=i(53574),b=i(21324);i(80285)},64733:function(e,t,i){if(i.d(t,{E:function(){return r}}),666==i.j)var s=i(25077);var n=i(90631);class r{constructor(e){this.nameToId={},this.idToName={},this.idManager=new n.siw(e)}reset(){this.nameToId={},this.idToName={},this.idManager.reset()}clone(){const e=new r;return e.nameToId=(0,s.Z)(this.nameToId),e.idToName=(0,s.Z)(this.idToName),e.idManager=this.idManager.clone(),e}getOrCreateIdForName(e){let t=this.nameToId[e];return t||(t=this.idManager.getId(),this.nameToId[e]=t,this.idToName[t]=e),t}getIdForName(e){const t=this.nameToId[e];return t||n.JE9}getNameForId(e){const t=this.idToName[e];return t||null}removeName(e){const t=this.nameToId[e];t&&(this.idManager.freeId(t),delete this.nameToId[e],delete this.idToName[t])}}},23056:function(e,t,i){i.d(t,{$J:function(){return d},KF:function(){return c},QC:function(){return h},Qy:function(){return o},yx:function(){return u}});var s=i(21324),n=i(70026),r=i(64733),a=i(72751);const o=666==i.j?-1:null,h=0,c=0,l=1<<n._6.OCCURRENCE_SLICE;class u{constructor(e){this.viewer=e,(0,s.Yk)(e),this.namedIdManager=new r.E(n._6.OCCURRENCE_ID)}reset(){this.namedIdManager.reset()}convertToOccurrenceId(e){if(!(0,n.rp)(e))return o;if(e.length>1)return a.log.warn("More than the allowed number of occurrences have been allocated"),o;let t=e[0],i=1;for(;t>=l;)++i,t/=l;return this.viewer.notifyOfPickPassCount(i),e[0]}getOrCreateIdForName(e){return this.convertToOccurrenceId(this.namedIdManager.getOrCreateIdForName(e))}getIdForName(e){return this.convertToOccurrenceId(this.namedIdManager.getIdForName(e))}getNameForId(e){return this.namedIdManager.getNameForId([e])}removeName(e){this.namedIdManager.removeName(e)}}function d(e){return null!=e&&e!==o}},82077:function(e,t,i){var s;i.d(t,{E1:function(){return r},JB:function(){return a},MX:function(){return s},ip:function(){return n}}),function(e){e[e.POINTS=0]="POINTS",e[e.LINES=1]="LINES",e[e.INFINITE_LINES=2]="INFINITE_LINES",e[e.TRIANGLES=3]="TRIANGLES",e[e.TRIANGLE_STRIP=4]="TRIANGLE_STRIP",e[e.SILHOUETTES=5]="SILHOUETTES",e[e.COUNT=6]="COUNT",e[e.PRIMITIVE_UNKNOWN=-1]="PRIMITIVE_UNKNOWN"}(s||(s={}));const n=Math.ceil(Math.log(s.COUNT)/Math.log(2));function r(e){switch(e){case s.POINTS:return"POINTS";case s.LINES:return"LINES";case s.INFINITE_LINES:return"INFINITE_LINES";case s.TRIANGLES:return"TRIANGLES";case s.TRIANGLE_STRIP:return"TRIANGLE_STRIP";case s.SILHOUETTES:return"SILHOUETTES";default:return"PRIMITIVE_UNKNOWN"}}function a(e){switch(e){case s.POINTS:return s.POINTS;case s.LINES:return s.LINES;case s.INFINITE_LINES:return s.INFINITE_LINES;case s.TRIANGLES:return s.TRIANGLES;case s.TRIANGLE_STRIP:return s.TRIANGLE_STRIP;case s.SILHOUETTES:return s.SILHOUETTES}return s.PRIMITIVE_UNKNOWN}},29307:function(e,t,i){i.d(t,{HN:function(){return l},Vp:function(){return c},Xd:function(){return h},oA:function(){return s}});var s,n=i(16696);!function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON",e[e.AUTO=2]="AUTO"}(s||(s={}));let r,a=s.AUTO,o=null;function h(e){switch(a=e,a){case s.OFF:(0,n.Ko)(!0);break;case s.ON:(0,n.Ko)(!1);break;case s.AUTO:l()}}function c(e){o=e,l()}function l(){if(a!==s.AUTO)return;let e=(void 0===r&&(r=navigator.platform.indexOf("Mac")>-1),!r);const t=new RegExp(".*intel.*","i");o&&t.test(o.glRenderer)&&(e=!0),(0,n.Ko)(e)}l()},49192:function(e,t,i){i.d(t,{$K:function(){return a},EG:function(){return r},Jh:function(){return o},Vv:function(){return n},lL:function(){return s}});const s="mainSceneGraph",n="previewSceneGraph",r="hudSceneGraph",a="hudModelSceneGraph",o="inferencePickerSceneGraph"},51372:function(e,t,i){i.d(t,{kW:function(){return s},qn:function(){return o},xv:function(){return r}});var s,n=i(37654);!function(e){e.UPDATES="counter updates",e.DRAW_CALLS="draw calls",e.TRIANGLES="triangles",e.LINES="lines",e.POINTS="points"}(s||(s={}));class r{constructor(){this.countersSubject=new n.x,this.counters={}}increment(e,t){void 0===t&&(t=1);let i=this.counters[e];i||(i=0),this.counters[e]=i+t}resetCounters(){this.counters={}}updateModel(){this.increment(s.UPDATES),this.countersSubject.next(this.counters)}get countersObservable(){return this.countersSubject.asObservable()}}const a=new r;function o(){return a}},53574:function(e,t,i){i.d(t,{t:function(){return o}});var s=i(29307),n=i(21324);class r{constructor(){this.retinaDisplaySetting=s.oA.AUTO}getRetinaDisplaySetting(){return this.retinaDisplaySetting}setRetinaDisplaySetting(e){this.retinaDisplaySetting=e,(0,s.Xd)(this.retinaDisplaySetting),(0,n.uQ)().requestDraw()}setUserWebPreference(e){const t=s.oA[e.retinaDisplaySetting];this.setRetinaDisplaySetting(t)}}let a=null;function o(){return a||(a=new r),a}},21324:function(e,t,i){i.d(t,{IO:function(){return l},KO:function(){return o},N9:function(){return u},Yk:function(){return d},e$:function(){return h},uQ:function(){return c}});var s=i(72751),n=i(78613);let r=null,a=null;function o(e){a=e,a?a.getPrimaryViewController()&&r?.getPrimaryViewController()&&(a.getPrimaryViewController().forcedManipulationMode=r.getPrimaryViewController().forcedManipulationMode):a=r}function h(e){(0,n.FM)(r,e),r&&e&&s.log.warn("A second viewer was set to be active before the first was deactivated."),r=e,o(e)}function c(){return r}function l(){const e=c();return e?e.getModelViewManagers():null}function u(){return a}function d(e){return!!e||(s.log.warn("viewer is null or undefined"),!1)}},96802:function(e,t,i){i.d(t,{G9:function(){return r},SG:function(){return n},zp:function(){return s}});class s{isFromWireBody(){return!1}isFromPointBody(){return!1}isCompositeBody(){return!1}isFromConstructionGeometry(){return!1}isInternalEdge(){return!1}isAnnotation(){return!1}isPlanar(){return!1}getPlanarNormal(){return null}isFromBody(){return!1}isFromSolidBody(){return!1}isFromSheetBody(){return!1}isFace(){return!1}canContainFace(){return!1}isEdge(){return!1}canContainEdge(){return!1}isVertex(){return!1}canContainVertex(){return!1}isDegenerateEdge(){return!1}isDefinedBySMVertex(){return!1}isDefinedBySMEdge(){return!1}isDefinedBySMFace(){return!1}isMateConnector(){return!1}isMate(){return!1}containsMesh(){return!1}isFlattened(){return!1}isFromActiveSheetMetal(){return!1}isBody(){return!1}isFromSketch(){return!1}isSketchTextEntity(){return!1}isSketchTextStroke(){return!1}isSketchImageEntity(){return!1}isSketchGroup(){return!1}getSketchGroupSelection(){return null}isUserSketchEntity(){return!1}getFeatureIds(){return[]}makeBodySelection(){return null}makeCompositeBodySelections(){return null}makeSketchFeatureSelection(){return null}isFromOccurrence(){return!1}isOccurrence(){return!1}makeOccurrenceSelection(e){return null}isClosedCurve(){return!1}isFromClick(){return!1}isEntity(){return!1}hasMateQueryData(){return!1}isGeometryMate(){return!1}getMateType(){return null}isMateGroup(){return!1}isMateConnectorBasedMate(){return!1}isFeature(){return!1}getFeatureType(){return null}isLine(){return!1}isCircle(){return!1}isEllipse(){return!1}isConic(){return!1}isCylinder(){return!1}isCone(){return!1}isSphere(){return!1}isTorus(){return!1}isRevolved(){return!1}isExtruded(){return!1}isAssemblyPattern(){return!1}isParametricInstance(){return!1}isParametricPartStudioInstance(){return!1}isParametricPartStudioChildInstance(){return!1}isParametricChildInstance(){return!1}isReplicatedInstance(){return!1}isNonSolidPartOccurrence(){return!1}isTemporaryGeometry(){return!1}isModifiable(){return!1}isNonModifiable(){return!1}isEdgePoint(){return!1}isPatternedOccurrence(){return!1}isAssemblyOccurrence(){return!1}isPartOccurrence(){return!1}isSuppressedOccurrence(){return!1}isFlattenedOccurrence(){return!1}isStandardContentOccurrence(){return!1}getOccurrence(){return null}getOwnerAssemblyOccurrence(){return null}makeMateConnectorSelection(){return null}isSpline(){return!1}isAssemblySketch(){return!1}isFromSplineHandle(){return!1}isInternalSplinePoint(){return!1}isFromSplineControlPolygon(){return!1}isSolveStatusUnknown(){return!1}isSolveStatusUnderDefined(){return!1}isSolveStatusWellDefined(){return!1}isSolveStatusFixed(){return!1}isSolveStatusOverDefined(){return!1}isSolveStatusNotConsistent(){return!1}isSectionEntity(){return!1}getBodyId(){return""}getIdString(){return""}getType(){}getUsage(){}isConstructionPlane(){return!1}getDeterministicId(e){return""}getBodyMetaData(){}getSketchGroupFeatureId(){return null}isProperty(){return!1}isTableItem(){return!1}getChildSelections(){return[]}getDeterministicIdList(){return[]}}class n extends(666==i.j?s:null){isFromBody(){return!0}isFromSolidBody(){return!0}isVertex(){return!0}canContainVertex(){return!0}isEntity(){return!0}}class r extends(666==i.j?n:null){isEdgePoint(){return!0}isInContextSelection(){return!1}}},80462:function(e,t,i){i.d(t,{Jb:function(){return c},S4:function(){return n},cD:function(){return a},gv:function(){return s},jA:function(){return r},w$:function(){return h},xB:function(){return o}});var s,n,r,a,o,h,c,l=i(45666),u=i(55858),d=i(90342),g=i(18265),p=i(16153),m=i(60939),f=i(14293),I=i(60036);function E(e){return(t,i,s)=>(s||(s=t),e(s,t,i))}function S(e){return t=>e(t)}function T(e){return(t,i,s)=>(s||(s=t),e(s,t,i))}function D(e){return(t,i)=>e(t,i)}function M(e){return(t,i)=>(i||(i=t),e(i,t))}function C(e){return(t,i)=>(i||(i=t),e(i,t))}function y(e){return(t,i)=>e(t,i)}function P(e){return(t,i)=>e(i,t)}function A(e){return(t,i)=>e(t,i)}function O(e){return(t,i,s)=>(s||(s=i),e(s,i,t))}function v(e){return(t,i)=>(i||(i=t),e(i,t))}function R(e){return(t,i,s)=>(s||(s=t),e(s,t,i))}function w(e){return(t,i,s)=>(s||(s=t),e(s,t,i))}!function(e){var t;e.subtract=E(l.subtract),e.length=S(l.length),e.scale=T(l.scale),e.add=(t=l.add,(e,i,s)=>(s||(s=i),t(s,e,i))),e.dot=D(l.dot),e.normalize=M(l.normalize),e.negate=C(l.negate),e.dist=y(l.dist),e.direction=(e,t,i)=>{i||(i=e);const s=e[0]-t[0],n=e[1]-t[1];let r=s*s+n*n;return r?(r=1/Math.sqrt(r),i[0]=s*r,i[1]=n*r,i):(i[0]=0,i[1]=0,i[2]=0,i)},e.squaredLength=e=>l.squaredLength(e),e.set=P(l.copy),e.distanceSquared=A(l.squaredDistance),e.cross=(e,t)=>{const i=u.create();return l.cross(i,e,t),i[2]}}(s||(s={})),function(e){e.getAPerpendicularVector=e=>{const t=e[0],i=e[1];return Math.abs(t)<I.W.ZERO_LENGTH&&Math.abs(i)<I.W.ZERO_LENGTH?u.fromValues(1,0,0):u.fromValues(-i,t,0)},e.equal=u.equals,e.subtract=E(u.subtract),e.dist=y(u.dist),e.setXYZ=(e,t,i,s)=>(u.set(s,e,t,i),s),e.set=P(u.copy),e.scale=T(u.scale),e.dot=D(u.dot),e.add=(e,t,i)=>(i||(i=e),u.add(i,e,t)),e.negate=C(u.negate),e.normalize=M(u.normalize),e.length=S(u.length),e.cross=(e,t,i)=>(i||(i=e),u.cross(i,e,t)),e.distanceSquared=A(u.squaredDistance),e.squaredLength=e=>u.squaredLength(e),e.linComb=(e,t,i,s,n)=>(n||(n=e),n[0]=e[0]*t+i[0]*s,n[1]=e[1]*t+i[1]*s,n[2]=e[2]*t+i[2]*s,n);let t=null;const i=d.create();e.unproject=(e,s,n,r,a)=>{a||(a=e),t||(t=g.create());const o=t,h=i;return h[0]=2*(e[0]-r[0])/r[2]-1,h[1]=2*(e[1]-r[1])/r[3]-1,h[2]=2*e[2]-1,h[3]=1,g.multiply(o,n,s),g.invert(o,o)?(d.transformMat4(h,h,o),0===h[3]?null:(a[0]=h[0]/h[3],a[1]=h[1]/h[3],a[2]=h[2]/h[3],a)):null}}(n||(n={})),function(e){e.negate=C(d.negate),e.setXYZW=(e,t,i,s,n)=>(d.set(n,e,t,i,s),n),e.distanceSquared=A(d.squaredDistance),e.subtract=E(d.subtract),e.set=P(d.copy)}(r||(r={})),function(e){e.multiplyVec2=(e,t,i)=>{i||(i=t);const s=t[0],n=t[1];return i[0]=s*e[0]+n*e[1],i[1]=s*e[2]+n*e[3],i},e.transpose=v(p.transpose)}(a||(a={})),function(e){e.multiplyVec2=O(l.transformMat3),e.transpose=v(m.transpose),e.multiply=R(m.multiply),e.multiplyVec3=O(u.transformMat3)}(o||(o={})),function(e){e.createFrom=g.fromValues,e.equal=g.equals,e.multiply=R(g.multiply),e.multiplyVec4=O(d.transformMat4),e.multiplyVec3=O(u.transformMat4),e.inverse=(e,t)=>(t||(t=e),g.invert(t,e)),e.toRotationMat=(e,t)=>(t||(t=g.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=0,t[13]=0,t[14]=0,t[15]=1,t),e.translate=(e,t,i)=>(i||(i=e),g.translate(i,e,t)),e.rotate=(e,t,i,s)=>(s||(s=e),g.rotate(s,e,t,i)),e.toMat3=(e,t)=>(t||(t=m.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t),e.fromRotationTranslation=(e,t,i)=>(i||(i=g.create()),g.fromRotationTranslation(i,e,t)),e.scale=(e,t,i)=>(i||(i=e),g.scale(i,e,t)),e.rotateX=w(g.rotateX),e.rotateY=w(g.rotateY),e.rotateZ=w(g.rotateZ),e.lookAt=(e,t,i,s)=>(s||(s=g.create()),g.lookAt(s,e,t,i)),e.perspective=(e,t,i,s,n)=>{n||(n=g.create());const r=i*Math.tan(e*Math.PI/360),a=r*t;return g.frustum(n,-a,a,-r,r,i,s)},e.ortho=(e,t,i,s,n,r,a)=>(a||(a=g.create()),g.ortho(a,e,t,i,s,n,r)),e.set=(e,t)=>g.copy(t,t)}(h||(h={})),function(e){e.normalize=M(f.normalize),e.multiply=(e,t,i)=>(i||(i=e),f.multiply(i,e,t)),e.toMat4=(e,t)=>(t||(t=g.create()),g.fromQuat(t,e)),e.dot=f.dot,e.multiplyVec3=(e,t,i)=>(i||(i=t),u.transformQuat(i,t,e)),e.fromAngleAxis=(e,t,i)=>{i||(i=f.create());const s=.5*e,n=Math.sin(s);return i[3]=Math.cos(s),i[0]=n*t[0],i[1]=n*t[1],i[2]=n*t[2],i}}(c||(c={}))},92944:function(e,t,i){i.d(t,{m:function(){return c}});var s=i(17922),n=i(95417);if(666==i.j)var r=i(45666);if(666==i.j)var a=i(55858);if(666==i.j)var o=i(18265);var h=i(80462);class c extends(666==i.j?n.UIElement:null){constructor(e,t,i){super(i,n.HUD_SCENEGRAPH_ID),this.iconNodeProperties=this.viewer.getResources().typeToNodeProperties[n.sketchinformation.nodePropertiesTypes.OK],this.worldLocation=t;const r=s.default.getManager();this.iconSizeConstantName="CONSTRAINT_INDICATOR_PIXEL_SIZE",this.iconSize=r.getNumber(this.iconSizeConstantName),this.icon=e,this.listenTo(this.viewer.getEventDispatcher(),n.VIEW_WILL_PICK,this.onViewWillDraw),(0,n.ensureTextureAtlas)(this.viewer),this.invalidateDisplay()}invalidateDisplay(){this.removeMeshIncrements(),(0,n.requestDraw)()}getOffset(e){const t=r.fromValues(0,1),i=function(e,i){return r.dot(r.fromValues(e,i),t)},a=-Math.abs(i(.5,.5)),o=-Math.abs(i(.5,-.5)),h=s.default.getManager().getNumber("TEMPORARY_INFERENCE_OFFSET")-Math.min(a,o),c=-.99*(0,n.getHudLayerDepthRange)(e.getViewport())[1];return[t[0]*h,t[1]*h,c]}onDevicePixelRatioChanged(e){const t=s.default.getManager();this.iconSize=t.getNumber(this.iconSizeConstantName),this.invalidateDisplay()}onViewWillDraw(e,t){if(!this.viewer.getResources().constraintAtlas)return;const i=this.getOffset(e),s=this.getDefaultTransform(e);h.w$.translate(s,i),s[12]=Math.floor(s[12]),s[13]=Math.floor(s[13]),this.setTransform(s),this.updateIconGraphics()}getDefaultTransform(e){let t=e.projectWorldPointToViewport(this.worldLocation);t[2]=0;const i=a.fromValues(0,0,0);t=h.S4.add(t,i);const s=h.w$.translate(o.create(),t),n=this.iconSize;return h.w$.scale(s,[n,n,1]),s}updateIconGraphics(){if(!this.viewer.getResources().constraintAtlas)return;const e=-.5,t=this.icon.id,i=this.viewer.getResources().constraintAtlas.getTextureCoords(t);if(!i)return;const s=(0,n.createQuad)([e,-.5,0],[.5,-.5,0],[e,.5,0],t,[i.lowS,i.highT],[i.highS,i.lowT]);this.updateMeshIncrement(t,"0",s,this.iconNodeProperties)}}},65754:function(e,t,i){i.r(t),i.d(t,{ACTIVE_SHEETMETAL_MODEL_CHANGED:function(){return o.HqE},ACTIVE_VIEWER_SET:function(){return o.zTe},ADD_TEMPORARY_TESSELLATION_OVERRIDES:function(){return o.am2},ASSEMBLY_ANIMATE_MATE_ENDED:function(){return o.V11},ASSEMBLY_ANIMATE_MATE_STARTED:function(){return o.klk},ASSEMBLY_DATA_PROCESSED:function(){return o.hjy},Action:function(){return o.aUM},AnimationCallbackStatus:function(){return o.ZK6},BTGraphicsUsage:function(){return o.LgS},CANVAS_CLICK:function(){return o.pUS},CANVAS_MOUSELEAVE:function(){return o.u5l},CANVAS_MOUSEMOVE:function(){return o.oGi},CHANGE_FEATURE_APPEARANCE:function(){return o.P1w},CHANGE_VIEW:function(){return o.h02},CLEAR_TEMPORARY_TESSELLATION_OVERRIDES:function(){return o.JpA},CLOSE_ANNOTATION_EDIT:function(){return o.i$n},CLOSE_DIMENSION_EDIT:function(){return o.dPN},CLOSE_MATE_DOF_CHOOSER:function(){return o.rwQ},CLOSE_SELECT_OTHER:function(){return o.AD7},CLOSE_SKETCH_SUB_DIALOG:function(){return o.wfd},CREATE_SECTION_PLANE_INFERENCE_CONTROLLER:function(){return o.T$E},CursorAppendage:function(){return a.CursorAppendage},CursorAppendageLeader:function(){return a.CursorAppendageLeader},DEFAULT_PREVIEW_OPACITY:function(){return a.DEFAULT_PREVIEW_OPACITY},DEFAULT_SIMULATION_COLOR_MAPPING:function(){return a.DEFAULT_SIMULATION_COLOR_MAPPING},DEFAULT_UNITS_CHANGED:function(){return o.CrY},DESTROY_SECTION_PLANE_INFERENCE_CONTROLLER:function(){return o.ye3},DEVICE_PIXEL_RATIO_CHANGED:function(){return o.b3},DID_RENDER_THUMBNAILS:function(){return o.Xc0},DIMENSION_DELETE_REQUEST:function(){return o.uav},DIMENSION_EDIT_CLOSED:function(){return o.pKY},DIMENSION_TEXT_DOUBLE_CLICKED:function(){return o.cu9},DIMENSION_TEXT_SINGLE_CLICKED:function(){return o.Q6T},DIMENSION_VALUE_CHANGED:function(){return o.WYs},DISPLAYED_PART_STUDIO:function(){return o.adC},DragTrimLine:function(){return a.DragTrimLine},ELEMENT_GRAPHICS_LOADING:function(){return o.Wp_},ELEMENT_PREVIEW_GRAPHICS_LOADED:function(){return o.Vpt},ELEMENT_VIEW_INITIALIZED:function(){return o.cpE},EntityData:function(){return a.EntityData},ExplodeLine:function(){return a.ExplodeLine},ExplodeLineArcSegment:function(){return a.ExplodeLineArcSegment},ExplodeLineLineSegment:function(){return a.ExplodeLineLineSegment},FrameType:function(){return o.QpP},GL_CONTEXT_LOST:function(){return o.cWC},GL_CONTEXT_RESTORED:function(){return o.pOz},GRAPHICS_HANDLED_CLICK_EVENT:function(){return o.sdI},GraphicsRefinementMode:function(){return o.Rng},HUD_MODEL_SCENEGRAPH_ID:function(){return o.$Ky},HighlightType:function(){return o.o2L},INVALID_ID:function(){return o.JE9},INVALID_OCCURRENCE_ID:function(){return o.Qyk},IdManager:function(){return o.siw},IdSizes:function(){return o._6$},IntersectionType:function(){return o.IiW},IsolatedOccurrencesManager:function(){return a.IsolatedOccurrencesManager},MAIN_SCENEGRAPH_ID:function(){return o.lLv},MAXIMUM_NUMBER_OF_SECTION_PLANES_REACHED:function(){return o.F59},ManipulationMode:function(){return o.kJR},NAMED_VIEW_APPLIED:function(){return o.ziX},NEW_PART_LIST:function(){return o.W2m},NON_TRIVIAL_PART_STUDIO_DATA_PROCESSED:function(){return o.CDm},NamedIdManager:function(){return o.EBu},PART_STUDIO_PART_VISIBILITY_CHANGED:function(){return o.sJs},PREVIOUS_VERSION_CANVAS_SELECTOR:function(){return a.PREVIOUS_VERSION_CANVAS_SELECTOR},RETRIEVE_ELEMENT_DISPLAY_DATA:function(){return o.Cgl},RETRIEVE_OCCURRENCE_DISPLAY_DATA:function(){return o.Qeo},RETRIEVE_SMOOTH_EDGE_INFORMATION:function(){return o.Uj6},SECTIONPLANE_SELECTION_ID:function(){return o.s_Y},SECTION_PLANE_ADDED:function(){return o.Srw},SECTION_PLANE_REMOVED:function(){return o.zKA},SECTION_VIEW_DIALOG_CLOSED:function(){return o.KOV},SECTION_VIEW_DIALOG_OPENED:function(){return o.M1t},SELECTION_REJECTED:function(){return o.SzR},SELECT_OTHER:function(){return o.NMw},SELECT_OTHER_REVERSE:function(){return o.aat},SHOW_SKETCH_TEXT:function(){return o._hB},SHOW_SMART_SELECTION:function(){return o.bsB},SKETCH_COMMAND_ACTIVATED:function(){return o.JFj},SPACEMOUSE_COMMANDS_RECEIVED:function(){return o.TN9},Sketch:function(){return a.Sketch},SketchPlaneDisplay:function(){return a.SketchPlaneDisplay},SplineHandle:function(){return a.SplineHandle},StandardViews:function(){return a.StandardViews},TemporarySketchComponent:function(){return a.TemporarySketchComponent},Text:function(){return a.Text},UIElement:function(){return a.UIElement},UISelection:function(){return a.UISelection},UPDATE_INCONTEXT_ISOLATION:function(){return o.bhj},UiEvents:function(){return a.UiEvents},VIEWER_CANVAS_ATTACHED_TO_CONTAINER:function(){return o.tSV},VIEW_CONTAINER_MENU_INVOKED:function(){return o.oLC},VIEW_DID_DRAW:function(){return o.u9p},VIEW_WILL_DRAW:function(){return o.Hvz},View:function(){return a.View},WILL_RENDER_THUMBNAILS:function(){return o.gV9},addStyleToIncrement:function(){return a.addStyleToIncrement},angleBetweenVectors:function(){return a.angleBetweenVectors},are2dPointsEqual:function(){return a.are2dPointsEqual},areAnySectionPlanesSelectedOrPreselected:function(){return a.areAnySectionPlanesSelectedOrPreselected},areMatricesEqual:function(){return a.areMatricesEqual},basicPickSort:function(){return h.G},btTs:function(){return c},cacheCapabilities:function(){return a.cacheCapabilities},clearSavedSectionPlaneParameters:function(){return a.clearSavedSectionPlaneParameters},collectGraphicsDataForHeapDump:function(){return a.collectGraphicsDataForHeapDump},createArcPolyline:function(){return a.createArcPolyline},createCirclePolyline:function(){return a.createCirclePolyline},createDimensionForDisplayData:function(){return a.createDimensionForDisplayData},createInferenceIcon:function(){return a.createInferenceIcon},createPolyline:function(){return a.createPolyline},createTestViewer:function(){return a.createTestViewer},deselectEntities:function(){return a.deselectEntities},disableSectionPlaneSelection:function(){return o.ZBF},displayEntity:function(){return a.displayEntity},distanceSquaredBetweenPoints:function(){return a.distanceSquaredBetweenPoints},distanceSquaredToLineSegment2d:function(){return a.distanceSquaredToLineSegment2d},enableSectionPlaneSelection:function(){return o.G29},estimateTriangleCountAtSettingIndexUsingTriangleCounts:function(){return a.estimateTriangleCountAtSettingIndexUsingTriangleCounts},forEachActiveSectionPlane:function(){return a.forEachActiveSectionPlane},getActiveSectionPlane:function(){return a.getActiveSectionPlane},getActiveSectionViewState:function(){return a.getActiveSectionViewState},getActiveViewer:function(){return o.uQB},getActiveViewerEventDispatcher:function(){return o.xA2},getActiveViewerHasSketch:function(){return a.getActiveViewerHasSketch},getActiveViewerModelViewManagers:function(){return o.IOg},getAngle:function(){return a.getAngle},getColorStringArray:function(){return a.getColorStringArray},getCounters:function(){return a.getCounters},getCurrentSectionPlaneParameters:function(){return a.getCurrentSectionPlaneParameters},getDefaultNameForBody:function(){return a.getDefaultNameForBody},getDisplayedElementObservable:function(){return o.v93},getDrawer:function(){return a.getDrawer},getDrawers:function(){return a.getDrawers},getEditState:function(){return a.getEditState},getFeatureThumbnailKey:function(){return a.getFeatureThumbnailKey},getFocusedViewer:function(){return o.N9r},getHasFeatureQLVFacePatternCapability:function(){return a.getHasFeatureQLVFacePatternCapability},getMaxSectionPlanes:function(){return a.getMaxSectionPlanes},getMostRecentActiveSectionPlaneParameters:function(){return a.getMostRecentActiveSectionPlaneParameters},getMouseSettingsManager:function(){return a.getMouseSettingsManager},getObservableFromActiveViewerForEvent:function(){return o.eRd},getOrCreateViewerSet:function(){return a.getOrCreateViewerSet},getPartStudioThumbnailKey:function(){return a.getPartStudioThumbnailKey},getPartThumbnailKey:function(){return a.getPartThumbnailKey},getPerpendicularBisector2d:function(){return a.getPerpendicularBisector2d},getPlaneIndexToAlignNormalTo:function(){return a.getPlaneIndexToAlignNormalTo},getPointAtAngle:function(){return a.getPointAtAngle},getRendererInfo:function(){return a.getRendererInfo},getSectionPlaneCount:function(){return a.getSectionPlaneCount},getSectionedItemsSize:function(){return a.getSectionedItemsSize},getSerializablePlaneData:function(){return a.getSerializablePlaneData},getSerializableSectionViewData:function(){return a.getSerializableSectionViewData},getThumbnailForKey:function(){return a.getThumbnailForKey},getTimeInMilliseconds:function(){return a.getTimeInMilliseconds},getUnavailableRendererInfo:function(){return a.getUnavailableRendererInfo},getZoomToWindowState:function(){return a.getZoomToWindowState},graphicsTakesSelectionPrecedence:function(){return a.graphicsTakesSelectionPrecedence},idIsValid:function(){return o.rp5},idsEqual:function(){return o.nD6},initializePreviousVersionViewer:function(){return a.initializePreviousVersionViewer},intersectLineSegmentRay:function(){return a.intersectLineSegmentRay},intersectTwoLineSegments2d:function(){return a.intersectTwoLineSegments2d},intersectTwoLines2d:function(){return a.intersectTwoLines2d},isInSectionPlaneMode:function(){return a.isInSectionPlaneMode},isMapEmpty:function(){return a.isMapEmpty},isRendererStringForDedicatedIntel:function(){return a.isRendererStringForDedicatedIntel},isRendererStringForIntel:function(){return a.isRendererStringForIntel},isSectionPlaneModeEnabled:function(){return a.isSectionPlaneModeEnabled},isUsageBase:function(){return a.isUsageBase},isUsageCompare:function(){return a.isUsageCompare},isUsagePreview:function(){return a.isUsagePreview},loadSectionPlanesFromParameters:function(){return a.loadSectionPlanesFromParameters},preserveViewersForDocumentId:function(){return a.preserveViewersForDocumentId},projectToLine:function(){return a.projectToLine},removeGraphicsViewers:function(){return a.removeGraphicsViewers},removeSectionPlane:function(){return a.removeSectionPlane},removeSectionPlanes:function(){return a.removeSectionPlanes},requestDraw:function(){return a.requestDraw},resetUsage:function(){return a.resetUsage},setBaseHighlightsEnabled:function(){return a.setBaseHighlightsEnabled},setBoxSelectionEnabled:function(){return a.setBoxSelectionEnabled},setDimensionToolActive:function(){return a.setDimensionToolActive},setForceHideInteriorSelections:function(){return a.setForceHideInteriorSelections},setFromSerializablePlaneData:function(){return a.setFromSerializablePlaneData},setFromSerializableSectionViewData:function(){return a.setFromSerializableSectionViewData},setInteractionEnabled:function(){return a.setInteractionEnabled},setIsInFollowMode:function(){return a.setIsInFollowMode},setIsInSectionPlaneMode:function(){return a.setIsInSectionPlaneMode},setSectionEntitiesEnabled:function(){return a.setSectionEntitiesEnabled},setSectionPlaneOnMateConnector:function(){return a.setSectionPlaneOnMateConnector},setSectionPlaneOnMatrix:function(){return a.setSectionPlaneOnMatrix},setShowDimensionsMode:function(){return a.setShowDimensionsMode},setThumbnailForKey:function(){return a.setThumbnailForKey},setTransparencyTransition:function(){return a.setTransparencyTransition},setViewCubeMenuMgrInstance:function(){return a.setViewCubeMenuMgrInstance},setZoomModeEnabled:function(){return a.setZoomModeEnabled},snapshotScenegraph:function(){return a.snapshotScenegraph},tessellateArc:function(){return a.tessellateArc},timeRendering:function(){return a.timeRendering},toggleZoomModifierEnabled:function(){return a.toggleZoomModifierEnabled},unprojectPlaneToWorld:function(){return a.unprojectPlaneToWorld},unprojectVectorToWorld:function(){return a.unprojectVectorToWorld},userWebPreferencesGetManager:function(){return o.tYI},viewerCheck:function(){return o.Ykz}});var s,n=i(61499),r=i(21324),a=i(95417);!function(e){!function(e){e.camera=a,e.frametimer=a,e.math=a,e.editstate=a,e.debugTools=a,e.eventdispatcher=a,e.utilities=(0,n.Z)({},a,{RetinaDisplayMode:a.RetinaDisplayMode},{pixelscaling:a}),e.viewcontroller=a,e.measurementdisplay=a,e.sectionplane=a,e.statistics=a,e.sketchdisplaydata=a,e.imagedisplay=a,e.sketchcomponent=a,e.splinehandle=a,e.zoomToWindowState=a,e.dimensions=a,e.coordinatesysteminference=a,e.triad=a,e.mateconnector=a,e.animationcontroller=a,e.occurrence=a,e.manipulators=a,e.idmanager=a,e.inferencepicker=a,e.mateindicator=a,e.viewerset=a,e.viewmanipulator=a,e.axes=a,e.inputhandler=a}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.getActiveViewer=r.uQ,e.viewerCheck=r.Yk,e.getFocusedViewer=a.getFocusedViewer,e.getActiveViewerModelViewManagers=r.IO,e.retrieveViewportAsImage=a.retrieveViewportAsImage,e.getActiveViewerOccurrenceDataManager=a.getActiveViewerOccurrenceDataManager}(e.viewer||(e.viewer={}))}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.setRefinementMode=a.setRefinementMode,e.RefinementMode=a.RefinementMode}(e.bodymanager||(e.bodymanager={}))}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.View=a.View}(e.sketchinformation||(e.sketchinformation={}))}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.PrimitiveType=a.PrimitiveType}(e.meshattr||(e.meshattr={}))}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.EdgePoint=a.EdgePoint}(e.edgepoint||(e.edgepoint={}))}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.Manager=a.DetailManager}(e.detail||(e.detail={}))}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.visualizePicks=a.visualizePicks}(e.debug||(e.debug={}))}(e.graphics||(e.graphics={}))}(s||(s={}));var o=i(90631),h=i(68386);const c=(0,n.Z)({},s)},95417:function(e,t,i){i.r(t),i.d(t,{ACTIVE_SHEETMETAL_MODEL_CHANGED:function(){return yD.Hq},ACTIVE_VIEWER_SET:function(){return yD.zT},ADD_TEMPORARY_TESSELLATION_OVERRIDES:function(){return yD.am},AFTER_MARKUP_IMAGE_GENERATION:function(){return yD.nh},ANALYSIS_MENU_INVOKED:function(){return yD.CJ},ANNOTATION_BASE_ELEMENT_ID:function(){return ru},ANNOTATION_BASE_SELECTION_ID:function(){return au},ANNOTATION_DETAIL_CELL_ELEMENT_ID:function(){return Su},ANNOTATION_DETAIL_CELL_SELECTION_ID:function(){return Tu},ANNOTATION_DETAIL_ELEMENT_ID:function(){return cu},ANNOTATION_DETAIL_SELECTION_ID:function(){return lu},ANNOTATION_DRAG_COMPLETE:function(){return yD.og},ANNOTATION_DRAG_LEADER_COMPLETE:function(){return yD.nu},ANNOTATION_GTOL_BOX_PROPERTIES:function(){return yu},ANNOTATION_GTOL_DETAIL_ELEMENT_ID:function(){return uu},ANNOTATION_GTOL_DETAIL_SELECTION_ID:function(){return du},ANNOTATION_ISO_LEADER_ELEMENT_ID:function(){return Iu},ANNOTATION_ISO_LEADER_SELECTION_ID:function(){return Eu},ANNOTATION_LEADER_ELEMENT_ID:function(){return ou},ANNOTATION_LEADER_PROPERTIES:function(){return Cu},ANNOTATION_LEADER_SELECTION_ID:function(){return hu},ANNOTATION_TRIANGLE_PROPERTIES_FILL:function(){return Mu},ANNOTATION_TRIANGLE_PROPERTIES_OPEN:function(){return Du},ANNOTATION_WELD_DETAIL_ELEMENT_ID:function(){return mu},ANNOTATION_WELD_DETAIL_SELECTION_ID:function(){return fu},ANNOTATION_WELD_EXTENDED_LEADER_ELEMENT_ID:function(){return gu},ANNOTATION_WELD_EXTENDED_LEADER_SELECTION_ID:function(){return pu},ASSEMBLY_ANIMATE_MATE_ENDED:function(){return yD.V1},ASSEMBLY_ANIMATE_MATE_STARTED:function(){return yD.kl},ASSEMBLY_DATA_PROCESSED:function(){return yD.hj},ASSEMBLY_PREFIX:function(){return cI},ASSEMBLY_TIMES:function(){return yD.uv},ATTRIBUTES:function(){return sS},ATTRIBUTE_LAYOUT:function(){return nS},AXES_ID:function(){return Xi},Action:function(){return dn.aU},ActionIds:function(){return ji},ActionSetController:function(){return Qi},AngleDisplay:function(){return dM},Angular:function(){return Pr},AngularDimension:function(){return BI.$R},AngularFeatureManipulator:function(){return ml.EH},AngularToolPreview:function(){return ks},AngularWithArrow:function(){return vr},AnimationController:function(){return YT},AnnotationComponent:function(){return jl},AnnotationDisplay:function(){return tu},AnnotationDisplayDatum:function(){return iu},AnnotationDisplayGTol:function(){return su},AnnotationDisplayWeld:function(){return nu},Arc:function(){return BI.wN},ArcLengthDimension:function(){return BI.uU},Arrow:function(){return Gl},Assembly:function(){return pd},AssemblyEnabledPartStudioComponent:function(){return kd},AssemblyIsolateManager:function(){return pD},AssemblyIsolateManagerBase:function(){return gD},AssemblyMakeTransparentManager:function(){return fD},AssignIdGLContext:function(){return iD},AtlasTexture:function(){return ms.KL},Attribute:function(){return eE},AttributeBinding:function(){return nf},AttributeNames:function(){return tE},AttributeProperties:function(){return iE},Attributes:function(){return sE},Axes:function(){return Yi},AxisLabel:function(){return qi},BEFORE_MARKUP_IMAGE_GENERATION:function(){return yD.m2},BODIES_LOADED:function(){return yD.LA},BODY_MANAGER_NONISOLATED_INCREMENT_GROUP_ID:function(){return Cc},BODY_MANAGER_OPAQUE_INCREMENT_GROUP_ID:function(){return Dc},BODY_MANAGER_TRANSPARENT_INCREMENT_GROUP_ID:function(){return Mc},BOUNDING_BOX_MESH_INCREMENT_NAME:function(){return XT},BOX_SELECTION_FINISHED:function(){return yD.KB},BTGraphicsUsage:function(){return fs.L},BackFaceSilhouettePass:function(){return _t},BackFaceStencilPass:function(){return Nt},Ball:function(){return Fg},Base:function(){return Ul},BezierDegreeDimension:function(){return BI.z$},BitShiftId:function(){return Mi},BlendFilter:function(){return n},BlendMode:function(){return d},BlitBlendMode:function(){return p},BlitBufferedPass:function(){return E},BlitFramebufferPass:function(){return S},BlitPass:function(){return I},BodyCheckCustomPass:function(){return pt},BodyCheckPass:function(){return mt},BodyComponent:function(){return Dp},BodyComponentId:function(){return jg},BodyLoadTasks:function(){return Yc},BodyLoader:function(){return qc},BodyManager:function(){return Hc},BodyMetaData:function(){return ph.XH},BodyOccurrence:function(){return Vc},BodyToProcess:function(){return Zc},BooleanIterator:function(){return _E.Y},BoundingBox:function(){return yi.kB},BoundingBox2D:function(){return yi.tO},BoundingSpot:function(){return yi.iK},BoxSelector:function(){return rn},BrowserRefreshRate:function(){return Tf},Budget:function(){return KT},Buffer:function(){return eS},BufferAllocationPolicy:function(){return $f},BufferSet:function(){return fS},BufferSetBase:function(){return rS},BufferedPass:function(){return T},CANVAS_CLICK:function(){return yD.pU},CANVAS_MOUSEENTER:function(){return yD.ox},CANVAS_MOUSELEAVE:function(){return yD.u5},CANVAS_MOUSEMOVE:function(){return yD.oG},CHANGE_FEATURE_APPEARANCE:function(){return yD.P1},CHANGE_VIEW:function(){return yD.h0},CLEAR_TEMPORARY_TESSELLATION_OVERRIDES:function(){return yD.Jp},CLOSE_ANNOTATION_EDIT:function(){return yD.i$},CLOSE_DIMENSION_EDIT:function(){return yD.dP},CLOSE_MATE_DOF_CHOOSER:function(){return yD.rw},CLOSE_SELECT_OTHER:function(){return yD.AD},CLOSE_SKETCH_SUB_DIALOG:function(){return yD.wf},COLLECTION_ID_PREFIX:function(){return MI.Q},COLOR_MAP_TESSELLATION_SETTING_INDEX:function(){return hc},CONSTANTS:function(){return dd},CREATE_SECTION_PLANE_INFERENCE_CONTROLLER:function(){return yD.T$},CURVATURE_ANALYSIS_COLOR_MAPPING_CHANGED:function(){return yD.iH},CURVATURE_ANALYSIS_CURVATURE_CONTROL_CHANGED:function(){return yD.gW},CURVATURE_ANALYSIS_LEGEND_CLOSED:function(){return yD.Nw},CURVATURE_ANALYSIS_LEGEND_MAXIMUM_CLICKED:function(){return yD.fd},CURVATURE_ANALYSIS_LEGEND_MINIMUM_CLICKED:function(){return yD.ib},CURVATURE_ANALYSIS_LEGEND_OPENED:function(){return yD.A1},CURVATURE_ANALYSIS_RANGE_CHANGED:function(){return yD.JH},CURVATURE_VISUALIZATION_MANAGER_NODE_ID:function(){return oc},CachedOccurrenceState:function(){return gd},CalculateOcclusionPass:function(){return Ie},CallCountingGLContext:function(){return tD},Camera:function(){return nh},CanvasTextureDefinition:function(){return no},CenterOfMassIndicator:function(){return yd},CenterlineDimension:function(){return BI.SM},ChainedOperator:function(){return xr},ClippingPlaneNames:function(){return $n},CombDisplay:function(){return gM},CombinedPickPass:function(){return ve},CommentIndicator:function(){return Cd},CompareBlendPass:function(){return Xe},ComponentNames:function(){return SC.vn},ConnectionVisualizationManager:function(){return Eh},ConstituentType:function(){return ph.po},ConstructionPlaneDisplay:function(){return AM},ControlPointGridDisplay:function(){return Vp},CosmeticThreadComponent:function(){return Pd},CosmeticThreadGeometryHandler:function(){return Ad},CountDimension:function(){return BI.JO},CounterNames:function(){return yn.kW},Counters:function(){return yn.xv},CullFace:function(){return uh},CullingState:function(){return Fs.uc},Cursor:function(){return Nn.C},CursorAppendage:function(){return ts},CursorAppendageLeader:function(){return ss},CurvatureAnalysisLegend:function(){return ec},CurvatureAnalysisManager:function(){return cc},CurvatureAnalysisScenegraphManager:function(){return uc},CurveLengthDimension:function(){return BI.U8},CustomPass:function(){return ie},CustomSwitchPass:function(){return DC},Cylindrical:function(){return bg},DEFAULT_MATERIAL:function(){return Li},DEFAULT_OPTIONS:function(){return ao},DEFAULT_PERSPECTIVE_FOV:function(){return rh},DEFAULT_PREVIEW_OPACITY:function(){return Ds},DEFAULT_SIMULATION_COLOR_MAPPING:function(){return Tm},DEFAULT_UNITS_CHANGED:function(){return yD.Cr},DEPTH_PASS_CLEAR_COLOR:function(){return Fs.XD},DESTROY_SECTION_PLANE_INFERENCE_CONTROLLER:function(){return yD.ye},DEVICE_PIXEL_RATIO_CHANGED:function(){return yD.b3},DID_RENDER_THUMBNAILS:function(){return yD.Xc},DIMENSION_ATLAS:function(){return pM.Xh},DIMENSION_DELETE_REQUEST:function(){return yD.u},DIMENSION_EDIT_CLOSED:function(){return yD.pK},DIMENSION_TEXT_DOUBLE_CLICKED:function(){return yD.cu},DIMENSION_TEXT_DRAG_ENDED:function(){return yD.s4},DIMENSION_TEXT_SINGLE_CLICKED:function(){return yD.Q6},DIMENSION_VALUE_CHANGED:function(){return yD.WY},DIRECTION:function(){return M},DISPLAYED_ASSEMBLY:function(){return yD.t0},DISPLAYED_PART_STUDIO:function(){return yD.ad},DataManager:function(){return lh},DebugPickPass:function(){return rt},Decal:function(){return _d},DecalComponent:function(){return Nd},DefaultPassUsage:function(){return we},DefaultPasses:function(){return _e},DepthClearPass:function(){return V},DepthRetrievalPass:function(){return We},DepthSamplingPass:function(){return ce},DepthTestMode:function(){return g},DetailManager:function(){return Jr},DihedralCombDisplay:function(){return Im},DihedralExtremaDisplay:function(){return Sm},Dimension:function(){return BI.Ro},DimensionComponent:function(){return Bd},DimensionPreferences:function(){return is.FZj},DirectionalScreenFacingSpaceQuadGlyphComponent:function(){return Nl},Display:function(){return Qf},DisplayElement:function(){return Pu},DisplayElementBase:function(){return Ou},DisplayElementBaseDatum:function(){return vu},DisplayElementBaseGTol:function(){return Ru},DisplayElementBaseWeld:function(){return wu},DisplayElementDetail:function(){return _u},DisplayElementDetailDatum:function(){return Nu},DisplayElementDetailGTol:function(){return Lu},DisplayElementDetailGTolCell:function(){return Fu},DisplayElementDetailGTolCellIcon:function(){return xu},DisplayElementDetailGTolCellText:function(){return Bu},DisplayElementDetailWeld:function(){return td},DisplayElementLeader:function(){return id},DisplayElementLeaderDatum:function(){return sd},DisplayElementLeaderGTol:function(){return nd},DisplayElementLeaderWeld:function(){return rd},DistanceDisplay:function(){return uM},DoubleClickHandler:function(){return DI},DraftAnalysisDrawPass:function(){return Mt},DraftAnalysisShadowTestPass:function(){return Tt},DraftAnalysisShadowTestPasses:function(){return Dt},DraftAngleRetrievalPass:function(){return ht},DragTrimLine:function(){return hn},DrawPass:function(){return f},DrawPassVisibility:function(){return o},DropdownButton:function(){return xT},ELEMENT_GRAPHICS_LOADING:function(){return yD.Wp},ELEMENT_PREVIEW_GRAPHICS_LOADED:function(){return yD.Vp},ELEMENT_PREVIEW_NODE_ID:function(){return ul},ELEMENT_VIEW_INITIALIZED:function(){return yD.cp},ELLIPSIS_ID:function(){return ms.WD},EMPTY_HIGHLIGHT_STYLE:function(){return WE},EVENT_NEEDS_ANGULAR_BROADCAST:function(){return yD.pF},EXCELLENT_GPU_RESULTS:function(){return ff},EdgeAndHiddenEdgePass:function(){return K},EdgeCurvatureDisplay:function(){return nm},EdgeDetectAndBlurPass:function(){return _},EdgeDetectBufferPass:function(){return R},EdgeDetectPass:function(){return O},EdgePoint:function(){return hd},EdgePointController:function(){return Ei},Element:function(){return cd},ElementLoadState:function(){return qS},ElementPreviewManager:function(){return dl},EllipseDiameterDimension:function(){return BI.Xk},EntityData:function(){return Fa},ErrorComponent:function(){return Mp},EventDispatcher:function(){return yD.pB},Events:function(){return ps},ExplodeLine:function(){return dC},ExplodeLineArcSegment:function(){return pC},ExplodeLineLineSegment:function(){return fC},ExpressionType:function(){return BI.t_},FALSE_INT_UNIFORM:function(){return jm},FIRST_ID:function(){return Si.lm},FOLLOW_MODE_DEACTIVATED:function(){return yD.Gf},FOLLOW_MODE_LEADER_MOUSE_MOVED:function(){return yD.Aw},FOLLOW_MODE_LEADER_MOUSE_OUT:function(){return yD.Nf},FaceAllHighlightsDrawPass:function(){return re},FaceEdgePointPass:function(){return G},FaceHighlightBufferPass:function(){return yt},FaceHighlightMaskPass:function(){return Pt},FaceSingleHighlightDrawPass:function(){return ft},FacesShadeMode:function(){return h},Factory:function(){return pM.Fk},Fastened:function(){return vg},FeatureManipulator:function(){return ml.XX},FilterCandidate:function(){return zm.zp},FilterEdgePointCandidate:function(){return zm.G9},FilterOcclusionPass:function(){return Ee},FilterVertexCandidate:function(){return zm.SG},FilteredEntitiesHighlightController:function(){return LM},Fixed:function(){return Wl},FixedMateIndicator:function(){return Vg},Flip:function(){return ml.BW},FrameBuffer:function(){return xo},FrameTimer:function(){return Fo},FreeDrag:function(){return Rr},FullTriadFeatureManipulator:function(){return ml.QV},GLContext:function(){return eD},GLYPH_SELECTION_ID:function(){return vl},GL_CONTEXT_LOST:function(){return yD.cW},GL_CONTEXT_RESTORED:function(){return yD.pO},GRAPHICS_HANDLED_CLICK_EVENT:function(){return yD.sd},Gauge:function(){return Df},GenerativeDesignManager:function(){return Wm},GeometryMate:function(){return kl},GhostParentPass:function(){return nt},GlDataType:function(){return Ft},GlPixelFormat:function(){return Gt},GlRenderBufferType:function(){return Ut},GlyphComponent:function(){return Rl},GlyphHighlightStates:function(){return Pl},GlyphResources:function(){return Ol},GlyphStateTextureSuffixes:function(){return yl},GlyphStates:function(){return Cl},GraphicsRefinementMode:function(){return is.Rng},GraphicsWebAssemblyUtils:function(){return Zm},GroupRanges:function(){return ES},HIGHLIGHTED_LINE_PROPERTIES:function(){return Jc},HIGHLIGHTED_TRIANGLE_PROPERTIES:function(){return sl},HUD_MODEL_SCENEGRAPH_ID:function(){return Zo.$K},HUD_SCENEGRAPH_ID:function(){return Zo.EG},Highlight:function(){return mn},HighlightFlag:function(){return pn},HighlightManager:function(){return Tn},HighlightPriority:function(){return gn},HighlightType:function(){return dn.o2},HudModelPass:function(){return N},HudPass:function(){return b},IDENTITY_MATRIX:function(){return yi.Ad},INFERENCE_LINE_PROPERTIES:function(){return $c},INFERENCE_PICKER_SCENEGRAPH_ID:function(){return Zo.Jh},INFERENCE_TRIANGLE_PROPERTIES:function(){return tl},INFINITE_CURVATURE_CUTOFF:function(){return ac},INVALID_FRAME_ID:function(){return NI},INVALID_ID:function(){return Si.JE},INVALID_ID_ELEMENT:function(){return Si.vN},INVALID_NUMBER_ID:function(){return Si.c2},INVALID_OCCURRENCE_ID:function(){return Jf.Qy},IconBorderState:function(){return ms.Te},IconData:function(){return ms.b2},IconSelectionType:function(){return is.UKE},IdManager:function(){return Si.si},IdMasks:function(){return Si.U2},IdSizes:function(){return Si._6},ImageComponent:function(){return pl},ImageData:function(){return Il},ImageDisplay:function(){return Gn},IncrementDetails:function(){return dS},IncrementId:function(){return rl},IncrementRanges:function(){return SS},InferenceData:function(){return is.Wfq},InferenceDisplay:function(){return Yd},InferenceDisplayWithoutHover:function(){return Kd},InferencePickPass:function(){return Re},InferencePicker:function(){return WT},InputHandler:function(){return gs},InsertableIncrementType:function(){return Gd},InteractionTypes:function(){return Lo},InterferenceDisplay:function(){return ZT},IntersectIterator:function(){return NE},IntersectOperator:function(){return bE},IntersectionType:function(){return Jn.I},IsolateContextPass:function(){return st},IsolateFlag:function(){return DD},IsolatedManagerBase:function(){return hD},IsolatedManagersUtils:function(){return TD},IsolatedOccurrencesManager:function(){return CD},LARGEST_REPRESENTABLE_INTEGER:function(){return yi.s9},LINE_PROPERTIES:function(){return Qc},LOADED_TESSELLATION_SETTING:function(){return bc},LineDisplay:function(){return Ks},LinePointAllHighlightsDrawPass:function(){return oe},LinePointSingleHighlightDrawPass:function(){return ae},Linear:function(){return Tr},Linear1d:function(){return ml.ol},LinearDimension:function(){return BI.mI},LinearDisplacement:function(){return Cr},LinearToolPreview:function(){return zs},Listener:function(){return zo},LoadTextures:function(){return ng},Lod:function(){return nE},MAIN_SCENEGRAPH_ID:function(){return Zo.lL},MANIPULATOR_BUTTONS_ID:function(){return vT},MANIPULATOR_ID:function(){return OT},MATE_INDICATOR_ATLAS:function(){return pM.Bm},MAXIMUM_NUMBER_OF_SECTION_PLANES_REACHED:function(){return yD.F5},MAX_COLLAPSED_ICONS:function(){return ms.eL},MBD_ATLAS:function(){return pM.di},MEDIUM_INTERACTIVE_BUDGET:function(){return QT},MESH_EDGE_NODE_PROPERTIES:function(){return op},MINIMUM_REFRESH_RATE_FPS:function(){return Sf},MODEL_MESH_MANAGER_SETTINGS:function(){return dI},MainDrawPass:function(){return Ct},Manager:function(){return cn.d},ManipulationMode:function(){return IC.k},Manipulator:function(){return Sr},MateConnector:function(){return hl},MateConnectorComponent:function(){return Ag},MateGroup:function(){return Hl},MateGroupMateIndicator:function(){return xg},MateIndicator:function(){return Og},MateIndicatorComponent:function(){return Vl},Material:function(){return Ni},MemoryGauge:function(){return Cf},Mesh:function(){return nI},MeshIncrement:function(){return vE},MeshManager:function(){return AS},MeshPointController:function(){return xn},ModelViewManager:function(){return th},ModelViewManagers:function(){return ih},MouseButton:function(){return is.tcH},MouseEvents:function(){return TI},NAMED_VIEW_APPLIED:function(){return yD.zi},NEW_PART_LIST:function(){return yD.W2},NON_TRIVIAL_PART_STUDIO_DATA_PROCESSED:function(){return yD.CD},NO_ID:function(){return Jf.QC},NO_RANGE_OPERATOR:function(){return $I},NO_RETRIEVAL_SENT_FOR_OCCURRENCE:function(){return vc},NO_SECTION_SHADER_ID_SUFFIX:function(){return $m},NO_SELECTION_ID:function(){return Ti.ZJ},NUMBER_INTEGER_BITS:function(){return yi.tl},NamedIdManager:function(){return eI.E},NoRangeOperator:function(){return QI},Node:function(){return xi.NB},NodeOccurrence:function(){return iS},NodeProperties:function(){return xi.hF},NodePropertiesTypes:function(){return Cn},NonInstantiatedBody:function(){return Lc},NormalDepthFilter:function(){return fe},NormalDepthPass:function(){return F},NormalDepthWithMaskPass:function(){return H},NumberIdManager:function(){return Si.s},OCCURRENCE_SOURCE:function(){return lI},OFFSET_DIRECTION_PIXEL_TOLERANCE:function(){return ms.wm},OITBufferPass:function(){return ze},OITColorPass:function(){return L},OITComponent:function(){return r},OITCompositePass:function(){return xe},OS_TO_Y_UP:function(){return aC},OccurrenceData:function(){return Vr},OccurrenceHighlights:function(){return zE},OccurrenceIdManager:function(){return Jf.yx},Opacity:function(){return a},OriginAxesIndex:function(){return SC.tF},OriginElement:function(){return Sc},OrthographicCamera:function(){return oh},OrthographicController:function(){return Qn},OutlineMeshId:function(){return PM},PART_STUDIO_DATA_AND_SELECTION_REMAP_PROCESSED:function(){return yD.cy},PART_STUDIO_ELEMENT_ID:function(){return Jf.KF},PART_STUDIO_OCCURRENCE_ID:function(){return uI},PART_STUDIO_PART_VISIBILITY_CHANGED:function(){return yD.sJ},PART_STUDIO_PREFIX:function(){return hI},PART_STUDIO_TIMES:function(){return yD.$_},PICKS_BOX_SELECTED:function(){return yD.f4},PICK_CLEAR_COLOR:function(){return Fs.o0},PICK_CONSTRAINT_SELECTED:function(){return yD.Mp},PREVIEW_SCENEGRAPH_ID:function(){return Zo.Vv},PREVIOUS_VERSION_CANVAS_SELECTOR:function(){return $D.TC},PRIMITIVE_TYPE_BITS:function(){return Di.ip},Parallel:function(){return _g},PartComparePass:function(){return He},PartPreviewPass:function(){return Ze},PartStudio:function(){return xd},PartStudioBlendPass:function(){return W},PartStudioComponent:function(){return Hd},PartStudioIsolateManager:function(){return ED},PartStudioIsolateManagerBase:function(){return ID},PartStudioMakeTransparentManager:function(){return SD},PartStudioScalarVisualizationLegend:function(){return $h},PartStudioScalarVisualizationManager:function(){return Jh},PerspectiveCamera:function(){return ah},PerspectiveController:function(){return jn},Pick:function(){return qm.D},PickAlternates:function(){return ke},PickPass:function(){return Ae},PickPriority:function(){return qm.z},PinSlot:function(){return Lg},Planar:function(){return yr},PlanarMateIndicator:function(){return wg},PlaneComponent:function(){return Xd},PlaneComponentId:function(){return Wd},PlaneIdPass:function(){return It},PlaneMeshId:function(){return yM},PlaneProperties:function(){return MM},PointBodyComponent:function(){return Xg},PointDimension:function(){return BI.IG},PointElement:function(){return Zl},PointSelection:function(){return br},PointsFeatureManipulator:function(){return ml.QQ},PolarDimension:function(){return BI.$d},PreviewBlendPass:function(){return le},Primitive:function(){return s},PrimitiveType:function(){return Di.MX},Quad:function(){return qT},QualityVisualizationPass:function(){return ne},REFRESH_RATE_MEASURE_SAMPLE_START_TIME_MS:function(){return If},REFRESH_RATE_MEASURE_TIME_MS:function(){return Ef},RETRIEVE_ELEMENT_DISPLAY_DATA:function(){return yD.Cg},RETRIEVE_OCCURRENCE_DISPLAY_DATA:function(){return yD.Qe},RETRIEVE_SMOOTH_EDGE_INFORMATION:function(){return yD.Uj},ROOT_ELEMENT_NODE_ID:function(){return rI},ROOT_ELEMENT_PREVIEW_NODE_ID:function(){return aI},RadialDimension:function(){return BI.nl},RangeSetIterator:function(){return RE.I},Ranges:function(){return wE},Ray:function(){return yi.zH},RayVisualization:function(){return hf},ReferenceHighlights:function(){return Sn},RefinementMode:function(){return Pc},RenderContext:function(){return xI},RenderOrderPriority:function(){return xi.DO},ResizeManipulator:function(){return bM},ResizeManipulatorIds:function(){return DM},ResourceManager:function(){return Yf},Resources:function(){return wn},Results:function(){return mf},RetinaDisplayMode:function(){return gh.oA},RetrievalRequestSource:function(){return Rc},Revolute:function(){return Rg},RhoDimension:function(){return BI.Mm},RotationComponentToAxesIndexMap:function(){return Fr.L},RotationPrecision:function(){return Nn.V},SCALAR_VISUALIZATION_FACE_SOLID_NODE_PROPERTIES:function(){return tp},SCALAR_VISUALIZATION_FACE_SURFACE_NODE_PROPERTIES:function(){return ip},SECTION_PLANE_ADDED:function(){return yD.Sr},SECTION_PLANE_REMOVED:function(){return yD.zK},SECTION_VIEW_DIALOG_CLOSED:function(){return yD.KO},SECTION_VIEW_DIALOG_OPENED:function(){return yD.M1},SELECTION_ID:function(){return $s},SELECTION_REJECTED:function(){return yD.Sz},SELECT_OTHER:function(){return yD.NM},SELECT_OTHER_REVERSE:function(){return yD.a},SESSION_ENDED:function(){return yD.so},SHEET_FACE_NODE_PROPERTIES:function(){return cp},SHEET_FACE_NODE_PROPERTIES_TRANSPARENT:function(){return lp},SHOW_DIMENSION_EXPRESSIONS_CHANGED:function(){return yD.yB},SHOW_SKETCH_TEXT:function(){return yD._h},SHOW_SMART_SELECTION:function(){return yD.bs},SIMULATION_CONNECTIONS_DISPLAYED:function(){return yD.GO},SIMULATION_LEGEND_CANVAS_CONTROLS_PANEL_ID:function(){return Dm},SIMULATION_LEGEND_CLOSED:function(){return yD.Ip},SIMULATION_LEGEND_OPENED:function(){return yD.PX},SIMULATION_MAXIMUM_CLICKED:function(){return yD.Jm},SIMULATION_MINIMUM_CLICKED:function(){return yD.xy},SIMULATION_RANGE_CHANGED:function(){return yD.pj},SIMULATION_RESULTS_DISPLAYED:function(){return yD.R1},SKETCH_COMMAND_ACTIVATED:function(){return yD.JF},SKETCH_CONSTRAINT_TEXTURE_ATLAS:function(){return pM.GH},SMALL_INTERACTIVE_BUDGET:function(){return jT},SOLID_FACE_NODE_PROPERTIES:function(){return ep},SOLID_FACE_NODE_PROPERTIES_TRANSPARENT:function(){return hp},SPACEMOUSE_ACTION_SET_CHANGED:function(){return yD.Fc},SPACEMOUSE_COMMAND:function(){return yD.RV},SPACEMOUSE_COMMANDS_RECEIVED:function(){return yD.TN},SVG_TOKENS_FOR_STYLE:function(){return Tl},ScalarRetrievalPass:function(){return Ot},ScalarVisualizationLegend:function(){return Yh},ScalarVisualizationManager:function(){return jh},ScalingManipulator:function(){return Lr},SceneGraph:function(){return qo},SceneGraphs:function(){return Yo},ScreenFacingSpaceQuadGlyphComponent:function(){return _l},ScreenOccupancyMap:function(){return Ri},ScreenSpaceData:function(){return is.vjd},ScreenSpaceQuadGlyphComponent:function(){return wl},SectionPlane:function(){return Sa.O},SectionPlaneEndcapDrawPass:function(){return P},SectionPlaneEndcapDrawPasses:function(){return A},SectionPlaneEndcapMaskDrawPass:function(){return ct},SectionPlaneEndcapMaskPass:function(){return Le},SectionViewState:function(){return LS.aA},SectionedItemType:function(){return LS.oj},SelectionIds:function(){return uT},SeparatedGaussianFilterBufferPass:function(){return w},SeparatedGaussianFilterPass:function(){return v},Settings:function(){return $r},ShaderProgram:function(){return af},Silhouette:function(){return iI},SilhouettePass:function(){return bt},SilhouetteTask:function(){return Zf},SimulationLegend:function(){return Mm},SimulationLoadDisplay:function(){return Dg},SimulationLoadDisplayGroup:function(){return Cg},SimulationLoadDisplayManager:function(){return yg},SimulationLoadGlyphResources:function(){return Pg},SimulationManager:function(){return Pm},Sketch:function(){return rs},SketchComponent:function(){return vp},SketchComponentId:function(){return Op},SketchPlaneDisplay:function(){return HT},SkipProgramsGLContext:function(){return sD},Slider:function(){return Ng},SnapIndicator:function(){return $d},SpaceballConnection:function(){return Pa},SplineHandle:function(){return mc},StandardViews:function(){return Zn},State:function(){return hi},StateCachingGLContext:function(){return aD},StateRepeatingGLContext:function(){return nD},StencilMode:function(){return c},StencilRefMask:function(){return u},StencilRefValue:function(){return l},Style:function(){return XI.bg},StyleMergeIterator:function(){return ZI.q},StyleModificationOperator:function(){return xE},StyleModifierIterator:function(){return FE},StyleOverwriteIterator:function(){return BE},StyleOverwriteOperator:function(){return VE},StyleResetIterator:function(){return qI},StyleResetOperator:function(){return YI},StyleUnionIterator:function(){return ZE},StyleUnionOperator:function(){return qE},StyledMeshRanges:function(){return jI},SubtractIterator:function(){return IS},SubtractMeshRanges:function(){return DS},SubtractOperator:function(){return OS},SwitchPass:function(){return TC},TEMPORARY_SKETCH_COMPONENT_NODE_ID:function(){return oI},THICKNESS_ANALYSIS_COLOR_MAPPING_CHANGED:function(){return yD.d},THICKNESS_ANALYSIS_DISPLAYED_FIELD_CHANGED:function(){return yD.vu},THICKNESS_ANALYSIS_LEGEND_CLOSED:function(){return yD.aI},THICKNESS_ANALYSIS_LEGEND_OPENED:function(){return yD.Cv},THICKNESS_ANALYSIS_MAXIMUM_CLICKED:function(){return yD.vk},THICKNESS_ANALYSIS_MINIMUM_CLICKED:function(){return yD.YW},THICKNESS_ANALYSIS_RANGE_CHANGED:function(){return yD.WB},TINT_TEST_TYPE:function(){return De},TOOL_EDGE_PROPERTIES:function(){return Vs},TOOL_FACE_PROPERTIES:function(){return Bs},TRIANGLE_PROPERTIES:function(){return il},TRUE_INT_UNIFORM:function(){return Km},Tangent:function(){return Bg},TaskManager:function(){return $T},TemporarySketchComponent:function(){return wp},Text:function(){return Ta},Text2D:function(){return Da},TextTexture:function(){return ro},Texture:function(){return $a},TextureAtlas:function(){return El},TextureDefinition:function(){return ja},ThicknessAnalysisManager:function(){return Fm},TimingDetails:function(){return bo},TintedPass:function(){return Me},TogglePointsFeatureManipulator:function(){return ml.gm},ToolDisplay:function(){return Us},TrackedGraphicsComponents:function(){return jD},TranslucentPass:function(){return Fe},TransparencySwitchPass:function(){return MC},TransparentFaceDepth:function(){return Lt},Triad:function(){return Fr._},TriadFeatureManipulator:function(){return ml.rY},UIElement:function(){return Ti.u1},UISelection:function(){return dh.i},UISelectionManager:function(){return dh.z},UI_ELEMENT_CLICK:function(){return yD.fu},UNKNOWN_DEPTH:function(){return Fs.BG},UNLIT_COLOR_FROM_ATTRIBUTE:function(){return bi},UNLOADED_BODY_OPACITY_FACTOR:function(){return wc},UPDATE_INCONTEXT_ISOLATION:function(){return yD.bh},UiEvents:function(){return Ti.zw},UniformAttribRepeatingGLContext:function(){return rD},VIEWER_CANVAS_ATTACHED_TO_CONTAINER:function(){return yD.tS},VIEW_CONTAINER_MENU_INVOKED:function(){return yD.oL},VIEW_DID_DRAW:function(){return yD.u9},VIEW_MANIPULATOR_EVENT:function(){return hT},VIEW_WILL_DRAW:function(){return yD.Hv},VIEW_WILL_PICK:function(){return yD.b9},View:function(){return ms.G7},ViewController:function(){return Kn},ViewFrustum:function(){return tr},ViewManipulator:function(){return BT},ViewManipulatorButtons:function(){return wT},Viewer:function(){return eT},ViewerUsage:function(){return Zr},Visibility:function(){return Fs.EE},WEBGL_ERROR_LOG_TAG:function(){return vD},WILL_RENDER_THUMBNAILS:function(){return yD.gV},WidthMateIndicator:function(){return Ug},WidthMateIndicatorComponent:function(){return zl},XR_POINTER_TIP_Z_OFFSET:function(){return GM},XrCamera:function(){return ch},XrCommentController:function(){return UM},XrController:function(){return BM},XrEventEnum:function(){return XM},XrGamepadButtonPressEvent:function(){return qM},XrInputDispatcher:function(){return jM},XrInputDisplay:function(){return zM},XrInputEvent:function(){return ZM},XrLineMarkup:function(){return $M},XrMarkupController:function(){return eC},XrSelectionHandler:function(){return tC},XrTeleportPreview:function(){return rC},XrViewController:function(){return lC},Y_UP_TO_OS:function(){return oC},ZoomToWindowState:function(){return jo.tG},activeViewerChanging:function(){return yD.FM},addByteColorToIncrement:function(){return Au.CO},addChildDebugObjectsFromProperties:function(){return Fs.Ir},addColorToIncrement:function(){return Au.Ab},addDebuggableChild:function(){return Fs.n9},addDrawer:function(){return Fs.jo},addHighlightToList:function(){return Dn},addLineToMesh:function(){return Au.L4},addLinesToMesh:function(){return Au.Ug},addNormalToIncrement:function(){return Au.b1},addPackedIntegerToIncrement:function(){return Au.FT},addParentlessNode:function(){return xi.hn},addQuadToMesh:function(){return Au.tn},addSizeToIncrement:function(){return Au.VQ},addStyleToIncrement:function(){return Au.KZ},addTextureCoordinateToIncrement:function(){return Au.Zx},addTriangleNormals:function(){return Au.wK},afterPrint:function(){return oi.py},angleBetweenVectors:function(){return yi.FE},are2dPointsEqual:function(){return yi.tm},areAnySectionPlanesSelectedOrPreselected:function(){return LS.cP},areMatricesEqual:function(){return yi.cl},areTexturesPendingLoad:function(){return Ka},areVectorsEqual:function(){return yi.nP},arraySubtract:function(){return Fs.iq},beforePrint:function(){return oi.lp},binarySearchRanges:function(){return CI},bindTexture:function(){return Ja},buildEdgeFromTriangleStrip:function(){return Au.Gn},buildFacesLinesPointsPasses:function(){return Te},buildHudPass:function(){return Ne},byteToMbString:function(){return Nc},cacheCapabilities:function(){return Fs.B2},canPointBeDisplayed:function(){return yi.fB},ceilAwayFromZero:function(){return yi.S_},checkError:function(){return KD},clamp:function(){return yi.uZ},cleanUpParentlessNodes:function(){return xi.Gy},clearPlaneEquationIds:function(){return Au.G0},clearSavedSectionPlaneParameters:function(){return LS.ny},clearStencilBuffer:function(){return at.EZ},clearStencilBufferBit:function(){return at.Pq},cloneStyledRangeSet:function(){return zI},closestAngle:function(){return yi._k},closestAngleGreaterThanOrEqual:function(){return yi.Tu},closestAngleInRange:function(){return yi.Kf},closestAngleLessThanOrEqual:function(){return yi.Kb},closestPointOnLine:function(){return yi.vu},collectGraphicsDataForHeapDump:function(){return QD},compareOutlineNodeProperties:function(){return IM},concatenateFloat32Arrays:function(){return Fs.Mz},concatenateUint8Arrays:function(){return Fs.Lf},constituentTypeToString:function(){return ph.IK},convertIntToUcharArray:function(){return Fs.fA},convertRGBA255ToRGBA:function(){return Fs.zF},convertRGBAToRGBA255:function(){return Fs.Db},convertRGBToRGBA255:function(){return Fs.C2},createAngularToolPreview:function(){return Ws},createArc:function(){return Au.QV},createArcPolyline:function(){return Ha},createArrow:function(){return Au.AD},createArrowPrimitives:function(){return Dr},createAtlasFromResources:function(){return Ml},createBox:function(){return Au.dO},createCircle:function(){return Au.y},createCirclePolyline:function(){return xa},createConicPolyline:function(){return ka},createDimensionForDisplayData:function(){return BI.j$},createDisc:function(){return Au.$},createDoubleHeadArrow:function(){return Au.KE},createEdgesFromTriangleStrip:function(){return Au.sp},createEdgesFromTriangles:function(){return Au.EK},createEllipsePolyline:function(){return Ba},createEntityMetaData:function(){return Xa},createInferenceIcon:function(){return ms.wg},createLine:function(){return Au.W5},createLineLoop:function(){return Au.qT},createLinearToolPreview:function(){return Xs},createLines:function(){return Au.pf},createManipulator:function(){return ml.wA},createMateIndicator:function(){return Gg},createMeshIncrementForEntityData:function(){return fI},createMeshIncrementForPolylineLines:function(){return Za},createOffsetTileViewportMatrix:function(){return yi.zD},createPickMatrix:function(){return yi.zL},createPoint:function(){return Au.Pu},createPolyline:function(){return za},createQuad:function(){return Au.fQ},createQuadOutline:function(){return Au.PU},createRGBATexture:function(){return io},createRing:function(){return Au.I$},createRoundedRectangle:function(){return Au.Dw},createSplinePolyline:function(){return Wa},createTestViewer:function(){return tT},createTextCanvas:function(){return So},createTextDebugObject:function(){return Fs.z4},createTextureFromText:function(){return _o},createTextureMaterial:function(){return Fi},createTileViewportMatrix:function(){return yi.vG},createTriangle:function(){return Au.aT},createTriangleStrip:function(){return Au.VO},createTriangles:function(){return Au.ut},createWireBox:function(){return Au.U0},crossProduct2d:function(){return yi.tV},database:function(){return Yr},debugIdCount:function(){return mS},debugToPostOnLoad:function(){return WD},decodeAngle:function(){return Fs.Pm},decodeDepth:function(){return Fs.Rg},decodeFloat:function(){return Fs.NP},decodePickingIndex:function(){return Fs.EI},deselectEntities:function(){return ms.Wt},difference2d:function(){return yi.r7},disableSectionPlaneSelection:function(){return EC.ZB},displayCanvasInDom:function(){return Oo},displayEntity:function(){return qa},distanceSquaredBetweenPoints:function(){return yi.B$},distanceSquaredToLineSegment2d:function(){return yi.o5},doesNodeContainPlaneEntities:function(){return CM},drawBackgroundIntoCanvas:function(){return To},drawBorderIntoCanvas:function(){return Do},drawTextIntoCanvas:function(){return yo},dumpShader:function(){return of},enableSectionPlaneSelection:function(){return EC.G2},encodePickingIndex:function(){return Fs.ow},ensureMateIndicatorResources:function(){return Bl},ensureTextureAtlas:function(){return ms.bt},estimateTriangleCountAtSettingIndexUsingTriangleCounts:function(){return ph.l_},executePerformanceTests:function(){return Mf},extractPlaneFromMatrix:function(){return yi.sc},fillCanvasWithTransparentColor:function(){return mo},fillHighlightWithDefault:function(){return In},fillInDefaultAttributes:function(){return Ti._J},filterActiveSectionPlanes:function(){return LS.HX},filterEntitiesWithData:function(){return EI},findTextBounds:function(){return vo},flipImageVertically:function(){return Fs.Dy},floorTowardsZero:function(){return yi.Tc},forEachActiveSectionPlane:function(){return LS.Lz},forceRequestDraw:function(){return Fs.tj},generateThumbnails:function(){return Ea},getActiveSectionPlane:function(){return LS.tz},getActiveSectionViewState:function(){return LS.Ky},getActiveViewer:function(){return oi.uQ},getActiveViewerCanvasCoordinateFromEvent:function(){return oi.P6},getActiveViewerEventDispatcher:function(){return yD.xA},getActiveViewerHasSketch:function(){return oi.aN},getActiveViewerOccurrenceDataManager:function(){return oi.x},getActiveViewerSceneGraphs:function(){return oi.KX},getAlphaModifierFunction:function(){return LE},getAngle:function(){return yi._O},getAngularValueSuffix:function(){return BI.$D},getAssemblyInContextElementId:function(){return Fs.HL},getBitForPlaneEquation:function(){return Au.X},getBitForPlaneEquationId:function(){return Au.JP},getBlankCanvas:function(){return oo},getBlendAmount:function(){return At},getChannelCountOfGlPixelFormat:function(){return kt},getCirclePoints:function(){return Au.zl},getCollectionId:function(){return Xc},getColorFromDebugEntityColor:function(){return pI},getColorString:function(){return Fs.o3},getColorStringArray:function(){return Fs.p7},getCosineOfAngleBetweenTwoVectors:function(){return yi.g7},getCounters:function(){return yn.qn},getCurrentActiveViewerSet:function(){return $D.w5},getCurrentSectionPlaneParameters:function(){return LS.nL},getDataUri:function(){return fa},getDefaultNameForBody:function(){return ph.lv},getDisplayDataTimerLoggingOptions:function(){return iT},getDisplayedElementObservable:function(){return yD.v9},getDrawer:function(){return Fs.HB},getDrawerForId:function(){return Fs.Jb},getDrawers:function(){return Fs.u4},getEditState:function(){return ys},getEntityPrimitiveType:function(){return II},getEulerAnglesFromMatrix:function(){return yi.df},getExpressionType:function(){return BI._p},getFeatureThumbnailKey:function(){return ma},getFocusedViewer:function(){return Jo.N9},getFramerateFromTime:function(){return No},getGLTarget:function(){return Vt},getGpuMemoryUsage:function(){return YD},getHasFeatureQLVFacePatternCapability:function(){return Fs.XM},getHasLongPressHandlerCapability:function(){return Fs.x4},getHudLayerDepthRange:function(){return hh},getIncrementIntersections:function(){return yi.E7},getIndexBufferType:function(){return si},getIndexElementSize:function(){return ri},getIndexElementType:function(){return ni},getIntersectionParameters:function(){return yi.dm},getLatestDisplayDataUsage:function(){return _s},getManipulatorDisplacementDisplayManager:function(){return Xo.a},getMatrixFromEulerAngles:function(){return yi.Wm},getMaxSectionPlanes:function(){return LS.j1},getMaximumVerticesPerVbo:function(){return ai},getMeshIncrementForEntityData:function(){return gI},getMostRecentActiveSectionPlaneParameters:function(){return LS.tb},getMouseSettingsManager:function(){return OD},getNewOwnerId:function(){return PS},getNextPowerOfTwo:function(){return yi.cP},getNodeProperties:function(){return jf},getObservableFromActiveViewerForEvent:function(){return yD.eR},getOrCreateViewerSet:function(){return $D.G$},getPartStudioThumbnailKey:function(){return ga},getPartThumbnailKey:function(){return pa},getPartstudioElementIdFromContextId:function(){return Fs.dV},getPerpendicularBisector2d:function(){return yi.eB},getPickUsage:function(){return vs},getPlaneEquationColor:function(){return Au.KJ},getPlaneEquationId:function(){return Au.Tf},getPlaneIndexToAlignNormalTo:function(){return LS.qT},getPointAtAngle:function(){return yi.iD},getPreviewAlpha:function(){return As},getPrimitiveTypeDescription:function(){return Di.E1},getRendererInfo:function(){return Zt},getScaleFromMatrix:function(){return yi.g9},getSceneGraphIdForUsage:function(){return Ko},getScratchSpace:function(){return $E},getSectionPlaneCount:function(){return LS.ti},getSectionPlaneOccurrenceIds:function(){return LS.WC},getSectionedItemsSize:function(){return LS.rv},getSelectedSectionPlane:function(){return Sa.C},getSerializablePlaneData:function(){return LS.OR},getSerializableSectionViewData:function(){return LS.p$},getSerializableSectionViewDataWithPersistentQueries:function(){return LS.bm},getSettingsKey:function(){return qr},getShaderIdWithExtension:function(){return sf},getSilhouetteIncrement:function(){return Xf},getSilhouettesId:function(){return zf},getStaticIncrements:function(){return cl},getTagIntCount:function(){return Fs.q7},getTestingBuffers:function(){return KE},getTextureSize:function(){return to},getThumbnailForKey:function(){return ha},getTimeElapsed:function(){return Fs.Es},getTimeInMilliseconds:function(){return Fs.Wj},getTransparencyTransition:function(){return Ke},getUnavailableRendererInfo:function(){return zt},getUnitBoxIncrement:function(){return Gc},getUtilityContext:function(){return co},getViewerFitPoints:function(){return Ia},getViewerForDebugOrTestPurposes:function(){return oi.f1},getXrSystem:function(){return hC},getZoomModeEnabled:function(){return jo.Fo},getZoomToWindowState:function(){return jo.Dx},graphicsTakesSelectionPrecedence:function(){return Fs.Ec},hasSpaceballConnected:function(){return wa},hashPoint:function(){return Au.HR},hashXYZ:function(){return Au.nw},hidePartNodesThatDoNotAddToBoundsFilter:function(){return se},hideSectionPlaneFromPick:function(){return LS.Mi},highlightsEqual:function(){return fn},idFromString:function(){return Si.UQ},idIsValid:function(){return Si.rp},idsEqual:function(){return Si.nD},imageCaptureToJpeg:function(){return Fs.Z$},inZoom:function(){return jo.aD},incrementListenerIdCounter:function(){return pS},initialize32BitIndexSupport:function(){return ii},initializePreviousVersionViewer:function(){return $D.fT},initializeSpaceballConnection:function(){return va},insertRange:function(){return yI},insertRangeStartEnd:function(){return AI},insertStyledRange:function(){return HI},interpolateInArray:function(){return yi.HO},intersectLineSegmentRay:function(){return yi.wd},intersectRayBox:function(){return yi.Lr},intersectRayPlane:function(){return yi.fE},intersectRayPlaneMatrix:function(){return yi.bZ},intersectRaySphere:function(){return yi.ss},intersectRayTriangle:function(){return yi.AF},intersectTwoLineSegments2d:function(){return yi.u3},intersectTwoLines2d:function(){return yi.TE},intervalsOverlap:function(){return yi.Ao},isCpuRenderer:function(){return Wt},isEffectivelyAnUnknownGPU:function(){return Kt},isFeatureIdCompound:function(){return SI},isFinite:function(){return yi.xV},isFiniteVector:function(){return yi.Cu},isHighPrecisionFragmentShaderSupported:function(){return Fs.J5},isIdValid:function(){return Jf.$J},isInFollowMode:function(){return Fs.sW},isInSectionPlaneMode:function(){return Fs.SU},isMapEmpty:function(){return Fs.hW},isMatrixIdentity:function(){return yi.n_},isNodeForDecal:function(){return wd},isNodeForSurfaceBody:function(){return pp},isOccurrenceNameForUi:function(){return MI.E},isOrderIndependentTransparencyEnabled:function(){return Fs.Z},isRendererStringForDedicatedIntel:function(){return jt},isRendererStringForIntel:function(){return Yt},isRetrievalDebuggingEnabled:function(){return _c},isRunningIntelGpu:function(){return qt},isSSAOSupported:function(){return Fs.pc},isSceneDebuggerWindowLoaded:function(){return kD},isSectionPlaneModeEnabled:function(){return LS.eQ},isSpaceballSupported:function(){return Fs.CF},isTrimetricCorner:function(){return dT},isUnitVector:function(){return yi.jP},isUsageBase:function(){return Rs},isUsageCompare:function(){return ws},isUsagePreview:function(){return Ns},isUsagePreviewAfter:function(){return bs},isUsagePreviewFinal:function(){return Ls},isValidForBounding:function(){return yi.rQ},lastFrameTimeRendering:function(){return ZD},loadAndApplySectionViewState:function(){return LS.Wh},loadFonts:function(){return uo},loadSectionPlanesFromParameters:function(){return LS.F6},log:function(){return Xr},logToInfo:function(){return zr},makeBufferedNormalDepthPass:function(){return B},makeBufferedNormalDepthWithMaskPass:function(){return be},makeBufferedPass:function(){return D},makeCone:function(){return Au.QF},makeCylinder:function(){return Au.Z4},makeDepthClearPass:function(){return U},makeFullId:function(){return dE},makeId:function(){return Si.qR},makePlaneEquationMatrixDirty:function(){return LS.qf},makeRoundedRectanglePath:function(){return Mo},makeSSAOPass:function(){return Se},makeSceneDebugObjectFromObject:function(){return Fs.bN},makeSphere:function(){return Au.E3},measureFontAlphabeticBaselineVerticalOffset:function(){return Eo},measureTextWidth:function(){return fo},merge:function(){return XI.TS},mix:function(){return yi.CD},nextOwnerId:function(){return yS},normalDepthClearColor:function(){return x},numberToFixedPointString:function(){return Au.PF},numberToPrimitiveType:function(){return Di.JB},occurrenceSortFunction:function(){return kc},off:function(){return Wo},on:function(){return ko},onViewerDraw:function(){return _a},orientText:function(){return Po},outlineNodeProperties:function(){return fM},packedNormalsToFloatArray:function(){return yi.w5},pickFromPreview:function(){return Os},planeToWorld:function(){return yi.qm},prepareShaderCode:function(){return tf},preserveViewersForDocumentId:function(){return $D.cv},projectToLine:function(){return yi.WW},projectWorldToPlane:function(){return yi.Oh},recordWebClientCapabilities:function(){return JD},registerDragHelper:function(){return os},releaseScratchSpace:function(){return JE},removeDrawer:function(){return Fs.Dz},removeGraphicsViewers:function(){return $D.jB},removeHighlightFromList:function(){return Mn},removeRange:function(){return OI},removeSectionPlane:function(){return LS.v5},removeSectionPlanes:function(){return LS.UB},removeStyledRange:function(){return kI},removeThumbnailForKey:function(){return la},requestDraw:function(){return Fs.vm},requestDrawForInteractiveProcessing:function(){return Fs.et},requestDrawUsingAnimationFrame:function(){return Fs.HK},requestDrawUsingTimer:function(){return Fs.Sd},resetSectionPlanesHiddenFromPick:function(){return LS.X9},resetSharedOperators:function(){return XE},resetStaticSilhouetteState:function(){return qf},resetUsage:function(){return Ps},retrieveViewportAsImage:function(){return oi.Xs},saveAndClearSectionViewState:function(){return LS.o_},sceneDebuggerWindow:function(){return HD},scratchSpaces:function(){return QE},sectionPlaneSelectionDisabled:function(){return EC.X5},setBaseHighlightsEnabled:function(){return oi.GB},setBoxSelectionEnabled:function(){return tn},setDimensionToolActive:function(){return BI.io},setFocusedViewer:function(){return Jo.KO},setForceHideInteriorSelections:function(){return oi.iM},setForcePredictableHatching:function(){return LS.jf},setFromSerializablePlaneData:function(){return LS.Rb},setFromSerializableSectionViewData:function(){return LS.rH},setIncrementOpacity:function(){return Au.Ae},setInteractionEnabled:function(){return BI.Jq},setIsInFollowMode:function(){return Fs.NC},setIsInSectionPlaneMode:function(){return Fs.km},setOrderIndependentTransparencyEnabled:function(){return Fs.uP},setPartThumbnailNeedsToBeRerendered:function(){return oa},setRefinementMode:function(){return Oc},setRendererInfo:function(){return gh.Vp},setRetinaDisplayMode:function(){return gh.Xd},setSectionEntitiesEnabled:function(){return LS.CF},setSectionPlaneOnMateConnector:function(){return LS.hJ},setSectionPlaneOnMatrix:function(){return LS.N3},setSerializableDataDirty:function(){return LS.P_},setShowDimensionsMode:function(){return BI.CO},setSketchNeedsThumbnail:function(){return ua},setSubtract:function(){return Fs.R},setTestingBuffers:function(){return jE},setThumbnailForKey:function(){return ca},setTransparencyTransition:function(){return Ye},setViewCubeMenuMgrInstance:function(){return lT},setZoomModeEnabled:function(){return jo.CR},setupContextForText:function(){return go},setupDatabase:function(){return Kr},setupStencilForTestAndWrite:function(){return at.Ig},setupStencilForTestWithoutWrite:function(){return at.LL},setupStencilForWriteWithoutTest:function(){return at.U$},shaderExistsForId:function(){return rf},sign:function(){return ar.sign},sizeOfGlRenderBufferType:function(){return Ht},sizeOfGlType:function(){return Bt},sketchinformation:function(){return _n},smoothstep:function(){return yi.CW},snapshotScenegraph:function(){return XD},sortHighlights:function(){return En},spliceRangesFromArray:function(){return vI},stopActionController:function(){return Ra},styleMapsEqual:function(){return XI.Gb},stylesEqual:function(){return XI.d8},tessellateArc:function(){return Ga},timeRendering:function(){return qD},toDegrees:function(){return yi.Ux},toRadians:function(){return yi.Yr},toRotationMat:function(){return yi.iM},toString:function(){return WI},toggleZoomModifierEnabled:function(){return jo.AA},unbindTexture:function(){return eo},unitBoxIncrement:function(){return Uc},unprojectPlaneToWorld:function(){return yi.KU},unprojectVectorToWorld:function(){return yi.$o},updateAutoSetting:function(){return gh.HN},updateMateConnectorSelectedColor:function(){return ll},updateShaderClippingUniforms:function(){return LS.qS},updateShaderEndcapPatternUniforms:function(){return LS.cV},updateShaderEndcapPickingUniforms:function(){return LS.fI},updateShaderEndcapUniforms:function(){return LS.le},userWebPreferencesGetManager:function(){return Pn.t},vec4FromVec3:function(){return yi.Ot},viewCubeMenuMgrInstance:function(){return cT},viewManipulationSettingsGetManager:function(){return GI},viewerCheck:function(){return Jo.Yk},visibilityDescriptor:function(){return Fs._I},visualizeCoordinateSystem:function(){return UD},visualizeDebugBox:function(){return BD},visualizeDebugPoint:function(){return xD},visualizeLine:function(){return VD},visualizePicks:function(){return GD},visualizeVisiblePicks:function(){return wD},worldToPlane:function(){return yi.LK},zeroOutArrayBuffer:function(){return Fs.rS}});var s,n,r,a,o,h,c,l,u,d,g,p,m=i(47178);!function(e){e[e.POINTS=0]="POINTS",e[e.EDGES=1]="EDGES",e[e.FACES=2]="FACES",e[e.SILHOUETTES=3]="SILHOUETTES"}(s||(s={})),function(e){e[e.BLEND_ONLY=0]="BLEND_ONLY",e[e.NON_BLEND_ONLY=1]="NON_BLEND_ONLY",e[e.ALL=2]="ALL"}(n||(n={})),function(e){e.ACCUMULATION="Accumulation",e.REVEALAGE="Revealage"}(r||(r={})),function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.ALL=2]="ALL"}(a||(a={})),function(e){e[e.VISIBLE=0]="VISIBLE",e[e.SHOWTHROUGH=1]="SHOWTHROUGH"}(o||(o={})),function(e){e[e.OPAQUE=0]="OPAQUE",e[e.ZEBRA_STRIPES=1]="ZEBRA_STRIPES",e[e.DRAFT=2]="DRAFT",e[e.QUALITY_VISUALIZATION=3]="QUALITY_VISUALIZATION"}(h||(h={})),function(e){e[e.WRITE=0]="WRITE",e[e.TEST=1]="TEST",e[e.WRITE_AND_TEST_ISOLATE_CONTEXT=2]="WRITE_AND_TEST_ISOLATE_CONTEXT",e[e.OFF=3]="OFF"}(c||(c={})),function(e){e[e.LOW_PRIORITY_EDGES=1]="LOW_PRIORITY_EDGES",e[e.EDGES=2]="EDGES",e[e.POINTS=4]="POINTS",e[e.FACES=8]="FACES",e[e.ISOLATE_CONTEXT=16]="ISOLATE_CONTEXT"}(l||(l={})),function(e){e[e.EDGES=3]="EDGES",e[e.POINTS=4]="POINTS",e[e.FACES=8]="FACES",e[e.ISOLATE_CONTEXT=16]="ISOLATE_CONTEXT"}(u||(u={})),function(e){e[e.OVER_WITH_SEPARATE_ALPHA=0]="OVER_WITH_SEPARATE_ALPHA",e[e.ADD=1]="ADD",e[e.DEST_ALPHA_PASSTHROUGH=2]="DEST_ALPHA_PASSTHROUGH"}(d||(d={})),function(e){e[e.NEVER=512]="NEVER",e[e.LESS=513]="LESS",e[e.EQUAL=514]="EQUAL",e[e.LEQUAL=515]="LEQUAL",e[e.GREATER=516]="GREATER",e[e.NOTEQUAL=517]="NOTEQUAL",e[e.GEQUAL=518]="GEQUAL",e[e.ALWAYS=519]="ALWAYS"}(g||(g={}));class f extends m.T{constructor(e,t){super(),this.viewer=e,this.childPasses=null,this.shaderTag=null,this.inputs={},this.enabled=!0,this.checkFrameId=!1,this.hideSelectionInterior=!1,(0,Jo.Yk)(e),this.parentPass=t,this.lastRenderedFrame=NI}reloadShaders(){if(this.shader&&this.viewer&&(this.shader=this.viewer.getShader(this.shader.getId())),this.childPasses)for(let e=0;e<this.childPasses.length;e++)this.childPasses[e].reloadShaders();Object.values(this.inputs).forEach((function(e){e.reloadShaders()}))}prepareShaders(){if(!this.shader&&this.getEnabled()&&this.viewer){if(this.usesShader()&&this.initializeShader(),this.childPasses)for(let e=0;e<this.childPasses.length;e++)this.childPasses[e].prepareShaders();Object.values(this.inputs).forEach((function(e){e.prepareShaders()}))}}usesShader(){return!1}initializeShader(){this.shader||(this.shader=this.viewer.getShader(this.getShaderId()))}setShaderUniform(e,t){if(this.childPasses)for(let i=0;i<this.childPasses.length;++i)this.childPasses[i].setShaderUniform(e,t)}onSessionEnded(){this.stopListening()}destroy(){if(this.onSessionEnded(),this.childPasses)for(let e=0;e<this.childPasses.length;++e)this.childPasses[e].destroy(),this.childPasses[e]=null;this.childPasses=null;for(const e in this.inputs)this.inputs[e].destroy(),this.inputs[e]=null;this.inputs=null,this.parentPass=null}setEnabled(e){this.enabled=e}getEnabled(){return this.enabled}setCheckFrameId(e){this.checkFrameId=e}getSceneGraph(){return this.parentPass?this.parentPass.getSceneGraph():this.viewer.getSceneGraphs().getMainSceneGraph()}getLastRenderedFrame(){return this.lastRenderedFrame}setInput(e,t){this.inputs[e]=t}drawInputs(e){if(this.getEnabled()){if(this.childPasses)for(let t=0;t<this.childPasses.length;++t)this.childPasses[t].drawInputs(e);Object.values(this.inputs).forEach((function(t){t.drawInputs(e),t.draw(e)}))}}preDraw(e){return(0,Jo.Yk)(this.viewer),(!this.checkFrameId||e.getFrameId()!==this.lastRenderedFrame)&&(this.lastRenderedFrame=e.getFrameId(),!0)}justBeforeDraw(e){this.parentPass&&this.parentPass.justBeforeDraw(e)}postDraw(e){}onShaderActivated(e,t){}justAfterDraw(e){this.parentPass&&this.parentPass.justAfterDraw(e)}draw(e){if(!this.getEnabled())return;const t=this;if(this.childPasses||this.getSceneGraph().passesNodeFilter((function(e){return t.nodeFilter(e)})))if(e.setActivePass(this),e.getState().capture(),this.preDraw(e)){if(this.childPasses)for(let t=0;t<this.childPasses.length;++t)this.childPasses[t].draw(e);else this.justBeforeDraw(e),this.getSceneGraph().draw(e),this.justAfterDraw(e);this.postDraw(e),e.getState().restore()}else e.getState().restore()}isPickPass(){return!!this.parentPass&&this.parentPass.isPickPass()}isHighlightPass(){return!!this.parentPass&&this.parentPass.isHighlightPass()}getActiveHighlightType(){return this.parentPass?this.parentPass.getActiveHighlightType():null}isShowthroughPass(){return!!this.parentPass&&this.parentPass.isShowthroughPass()}testIsolation(e){return!1}forIsolate(){return!this.parentPass||this.parentPass.forIsolate()}forSectionPlaneEndcapMask(){return!!this.parentPass&&this.parentPass.forSectionPlaneEndcapMask()}getShaderId(){let e="";return this.parentPass&&(e=this.parentPass.getShaderId()),this.shaderTag&&(e+="-"+this.shaderTag),e}needsAttribute(e){return!!this.parentPass&&this.parentPass.needsAttribute(e)}getPickIteration(){return this.parentPass?this.parentPass.getPickIteration():-1}nodeFilter(e){return!this.parentPass||this.parentPass.nodeFilter(e)}addChildPass(e){this.childPasses||(this.childPasses=[]),this.childPasses.push(e)}getChildPass(e){return this.childPasses&&e<this.childPasses.length?this.childPasses[e]:null}getChildPassCount(){return this.childPasses?this.childPasses.length:0}setBlendFilter(e){for(let t=0;this.childPasses&&t<this.childPasses.length;++t)this.childPasses[t].setBlendFilter(e)}getPerformIsolationTest(){for(let e=0;this.childPasses&&e<this.childPasses.length;++e)if(this.childPasses[e].getPerformIsolationTest())return!0;return!1}setPerformIsolationTest(e){for(let t=0;this.childPasses&&t<this.childPasses.length;++t)this.childPasses[t].setPerformIsolationTest(e)}setHideSelectionInterior(e){this.hideSelectionInterior=e}createExcludeForNonBodyFilter(e){const t=this.viewer.getModelViewManagers().getManager();return i=>i.getParent()&&t.isNodeForBody(i.getParent(),e)}createExcludeForNonBodyFilterNoDecals(e){const t=this.viewer.getModelViewManagers().getManager();return i=>i.getParent()&&t.isNodeForBody(i.getParent(),e)&&!wd(i)}createOnlyDecalsFilter(){const e=this.viewer.getModelViewManagers().getManager();return t=>t.getParent()&&e.isNodeForBody(t.getParent())&&wd(t)}createExcludeForBodyFilter(){const e=this.viewer.getModelViewManagers().getManager();return t=>t.getParent()&&!e.isNodeForBody(t.getParent())}needsFaceAppearances(){return!0}setNodeOccurrenceFilterFunction(e){if(this.childPasses)for(let t=0;t<this.childPasses.length;++t)this.childPasses[t].setNodeOccurrenceFilterFunction(e)}onAppearanceConstantsUpdated(){if(this.childPasses)for(let e=0;e<this.childPasses.length;++e)this.childPasses[e].onAppearanceConstantsUpdated()}}!function(e){e[e.BLEND_ALL=0]="BLEND_ALL",e[e.BLEND_ALPHA=1]="BLEND_ALPHA",e[e.BLEND_OFF=2]="BLEND_OFF"}(p||(p={}));class I extends f{constructor(e){super(e,null),this.blendMode=p.BLEND_ALL}usesShader(){return!0}preDraw(e){this.initializeShader(),e.getState().capture();const t=this.viewer.getGlContext();switch(this.blendMode){case p.BLEND_ALL:t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case p.BLEND_ALPHA:t.enable(t.BLEND),t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case p.BLEND_OFF:t.disable(t.BLEND)}t.disable(t.DEPTH_TEST),e.getState().callGl("depthMask",!1),e.activateShader(this.shader);const i=this;return Object.entries(this.inputs).forEach((([e,t])=>{i.shader.useTexture(e,t.getColorTexture())})),e.nodeFilter=function(e){return!0},!0}drawBlitNodes(e){this.viewer.getResources().getBlitNode().draw(e)}draw(e){this.enabled&&(e.setActivePass(this),this.preDraw(e)&&(this.justBeforeDraw(e),this.drawBlitNodes(e),this.justAfterDraw(e),this.postDraw(e)))}postDraw(e){const t=this.viewer.getGlContext();t.disable(t.BLEND),t.enable(t.DEPTH_TEST),e.getState().restore()}}class E extends I{constructor(e,t,i){super(e),i=i||{},this.shaderTag=i.shaderTag?i.shaderTag:"drawTexture",this.inputs.uTexture=t,this.performDrawInputs=void 0!==i.performDrawInputs,this.viewport=i.viewport}drawInputs(e){}preDraw(e){return this.performDrawInputs&&super.drawInputs(e),this.viewport&&e.pushViewport(this.viewport),!!super.preDraw(e)||(this.viewport&&e.popViewport(),!1)}postDraw(e){this.viewport&&e.popViewport(),super.postDraw(e)}}class S extends I{constructor(e,t){super(e),this.frameBuffer=t,this.shaderTag="drawTexture"}preDraw(e){this.initializeShader(),e.getState().capture();const t=this.viewer.getGlContext();return t.disable(t.BLEND),e.getState().callGl("depthMask",!1),e.activateShader(this.shader),this.shader.useTexture("uTexture",this.frameBuffer.getTexture()),e.nodeFilter=function(){return!0},!0}}class T extends f{constructor(e,t){super(e,null),this.clearColor=[0,0,0,0],this.viewportScale=1,this.checkFrameId=!0,this.frameBuffer=null;let i=!0;t&&(this.id=t.id,i=!t.hasOwnProperty("makeFrameBuffer")||!!t.makeFrameBuffer),this.makeFrameBuffer=!!i;const s=this.viewer.getGlContext();i&&s&&this.initializeFrameBuffer(s),this.listenTo(this.viewer.getEventDispatcher(),yD.pO,this.onGlContextRestored),this.listenTo(this.viewer.getEventDispatcher(),yD.so,this.onSessionEnded)}onGlContextRestored(e){!this.frameBuffer&&this.makeFrameBuffer&&this.initializeFrameBuffer(e),this.resetBuffer()}getColorTexture(){return this.colorTexture}getWidth(){return this.frameBuffer?.getWidth()}getHeight(){return this.frameBuffer?.getHeight()}initializeFrameBuffer(e){this.frameBuffer=this.viewer.getOrCreateFrameBuffer(this.textureType?this.textureType:e.UNSIGNED_BYTE,this.id,{storageType:this.storageType?this.storageType:e.DEPTH_STENCIL,attachmentType:this.attachmentType?this.attachmentType:e.DEPTH_STENCIL_ATTACHMENT})}resetBuffer(){this.frameBuffer?.resetBuffer()}preDraw(e){if(!super.preDraw(e))return!1;if(1!==this.viewportScale){const t=e.getViewport().slice(0);t[2]=Math.max(1,Math.floor(t[2]*this.viewportScale)),t[3]=Math.max(1,Math.floor(t[3]*this.viewportScale)),e.pushViewport(t)}this.frameBuffer?.update(e),this.colorTexture=this.frameBuffer?.getTexture();const t=this.viewer.getGlContext();return this.oldBufferBinding=t.getParameter(t.FRAMEBUFFER_BINDING),this.frameBuffer?.bindBuffer(),this.clearBuffer(e),!0}clearBuffer(e){const t=this.viewer.getGlContext();t.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]),t.clearStencil(0),t.stencilMask(255),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT)}postDraw(e){1!==this.viewportScale&&e.popViewport();const t=this.viewer.getGlContext();t.bindFramebuffer(t.FRAMEBUFFER,this.oldBufferBinding?this.oldBufferBinding:null)}getFrameBuffer(){return this.frameBuffer}setFrameBuffer(e){this.frameBuffer=e}}function D(e,t,i,s){const n=new T(e,{id:s});return n.childPasses=[t],n.viewportScale=i,n}var M,C=i(55858),y=i(90342);class P extends I{constructor(e,t,i,s,n){super(e),this.shaderTag="endcap",this.forDepthTesting=!1,this.parentPass=t,this.planeIndex=i,this.inputs.uEndcapMaskTexture=s,n&&(this.inputs.uEdgeDetectTexture=n)}setEndcapMaskPass(e){this.inputs.uEndcapMaskTexture=e}getEnabled(){return!!super.getEnabled()&&(0,LS.ti)()>this.planeIndex}isFacingTheViewer(e){const t=e.getActiveCamera().getForward(),i=(0,LS.tz)(this.planeIndex).normal;return C.dot(t,i)<0}preDraw(e){return!((0,LS.ti)()<=this.planeIndex||this.isFacingTheViewer(e)||!this.inputs.uEndcapMaskTexture.getColorTexture())&&(!!super.preDraw(e)&&(e.setOverrideFaceCullingMode(uh.NONE),!0))}justBeforeDraw(e){super.justBeforeDraw(e);const t=this.viewer.getGlContext();this.inputs.uEdgeDetectTexture&&e.detailSettings.enableSectionPlaneEdgeDetection||this.shader.useBlankTexture("uEdgeDetectTexture"),this.shader.uniformMatrix4fv("uPMatrix",!1,e.getProjectionMatrix());const i=y.create();i[this.planeIndex]=1,this.shader.uniform4fv("uPlaneSelector",i);const s=e.getActiveCamera().getSceneBounds().diameter();this.shader.uniform1f("uSceneDiameter",s),(0,LS.qS)(this.viewer,!0),(0,LS.le)(e,this.planeIndex),this.isPickPass()?(this.shader.uniform4fv("uPickRect",this.parentPass.pickRect),this.shader.uniform2f("uPickRectScale",this.parentPass.pickRect[2]/this.parentPass.pickViewportWidthHeight[0],this.parentPass.pickRect[3]/this.parentPass.pickViewportWidthHeight[1]),this.shader.uniform2f("uMaskTextureDimensions",this.inputs.uEndcapMaskTexture.getWidth(),this.inputs.uEndcapMaskTexture.getHeight()),(0,LS.fI)(e,this.planeIndex),t.disable(t.BLEND)):(0,LS.cV)(e,this.planeIndex),t.enable(t.DEPTH_TEST)}draw(e){if(!this.enabled)return;if(e.setActivePass(this),!this.preDraw(e))return;this.justBeforeDraw(e);const t=this.viewer.getGlContext();this.isPickPass()||((0,at.U$)(t,l.LOW_PRIORITY_EDGES,u.EDGES),this.forDepthTesting||this.shader.uniform1f("uDiscardPatternBackground",1),t.colorMask(!1,!1,!1,!1),e.getState().callGl("depthMask",!1),this.drawBlitNodes(e),t.colorMask(!0,!0,!0,!0),this.forDepthTesting||this.shader.uniform1f("uDiscardPatternBackground",0),t.disable(t.STENCIL_TEST)),e.getState().callGl("depthMask",!0),this.forDepthTesting&&t.colorMask(!1,!1,!1,!1),this.drawBlitNodes(e),this.justAfterDraw(e),this.postDraw(e)}postDraw(e){super.postDraw(e);const t=this.viewer.getGlContext();this.isPickPass()&&t.enable(t.BLEND),t.colorMask(!0,!0,!0,!0),e.clearOverrideFaceCullingMode()}}class A extends f{constructor(e,t,i,s){super(e,t),this.childPasses=[new P(e,t,0,i,s),new P(e,t,1,i,s),new P(e,t,2,i,s),new P(e,t,3,i,s)]}setEndcapMaskPass(e){for(let t=0;t<this.childPasses.length;++t)this.childPasses[t].setEndcapMaskPass(e)}}class O extends I{constructor(e,t){super(e),this.shaderTag="edgeDetect",this.inputs.uSourceBuffer=t}justBeforeDraw(e){super.justBeforeDraw(e);const t=e.getViewport();this.shader.uniform2f("uPixelScale",1/t[2],1/t[3]),this.shader.uniform1f("uDoEdgeDetection",1)}}!function(e){e.X="X",e.Y="Y"}(M||(M={}));class v extends I{constructor(e,t,i){super(e),this.direction=i,this.shaderTag="gaussianFilter",this.inputs.uSourceBuffer=t}justBeforeDraw(e){super.justBeforeDraw(e);const t=e.getViewport();this.shader.uniform2f("uPixelScale",1/t[2],1/t[3]),this.direction===M.X?this.shader.uniform2f("uDirection",1,0):this.shader.uniform2f("uDirection",0,1)}}class R extends T{constructor(e,t){super(e,{id:"edgeDetectAndBlurPassBufferA"}),this.childPasses=[new O(e,t)]}}class w extends T{constructor(e,t,i){super(e,{id:"edgeDetectAndBlurPassBufferB"}),this.childPasses=[new v(e,t,i)]}}class _ extends T{constructor(e,t){super(e,{id:"edgeDetectAndBlurPassBufferA"}),this.edgeDetect=new R(e,t),this.filterX=new w(e,this.edgeDetect,M.X),this.filterY=new v(e,this.filterX,M.Y),this.childPasses=[this.filterY]}preDraw(e){return!!e.detailSettings.enableSectionPlaneEdgeDetection&&super.preDraw(e)}}class N extends f{constructor(e,t){super(e,t),this.previousModelViewMatrix=null,this.previousProjectionMatrix=null;const i=new G(this.viewer,this,{opacity:a.ALL});this.childPasses=[i]}getSceneGraph(){return this.viewer.getSceneGraphs().getHudModelSceneGraph()}preDraw(e){return this.previousModelViewMatrix=e.getModelViewMatrix(),this.previousProjectionMatrix=e.getProjectionMatrix(),e.popProjectionMatrix(),e.popModelViewMatrix(),!0}postDraw(e){e.pushModelViewMatrix(this.previousModelViewMatrix),e.pushProjectionMatrix(this.previousProjectionMatrix)}}class b extends f{constructor(e,t){let i;super(e,t);const s=new _e(this.viewer,this,null,we.HUD,!0);for(this.childPasses=[],this.childPasses.push(s.opaqueFaces),this.childPasses.push(new N(this.viewer,this)),this.childPasses.push(s.nonOitTransparentFaces),this.childPasses.push(s.opaqueEdges),this.childPasses.push(s.opaquePoints),i=0;i<this.childPasses.length;++i){const e=this.childPasses[i];e instanceof ie&&(e.clipToSectionPlanes=!1)}this.childPasses.push(s.showThroughStencilTested),this.childPasses.push(s.showThroughNotStencilTested)}getSceneGraph(){return this.viewer.getSceneGraphs().getHudSceneGraph()}preDraw(e){const t=this.viewer.getGlContext();t.clear(t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT);const i=this.isPickPass()&&this.parentPass&&this.parentPass.oldViewport&&this.parentPass.pickRect;let s,n,r,a,o=i?this.parentPass.oldViewport:e.getViewport();const h=e.getActiveCamera(),c=h.getTileViewport();let l;i?l=this.parentPass.pickRect:c&&(l=c,o=h.getViewport(!0)),l?(s=l[0],n=l[0]+l[2],r=o[3]-(l[1]+l[3]),a=o[3]-l[1]):(s=o[0],n=o[0]+o[2],r=o[1],a=o[1]+o[3]);const u=hh(o),d=new oh({eye:[0,0,0],direction:[0,0,-1],up:[0,1,0],left:s,right:n,bottom:r,top:a,near:u[0],far:u[1]});return e.pushModelViewMatrix(d.getViewMatrix()),e.pushProjectionMatrix(d.getProjectionMatrix()),!0}postDraw(e){e.popProjectionMatrix(),e.popModelViewMatrix()}}class L extends f{constructor(e,t){super(e,null),this.component=t,this.applyTranslucentAlphaToAll=!1,this.sceneGraph=null,this.tintColor=[1,1,1],this.tintFactor=0,this.performIsolationTest=!1,this.shaderTag="OIT"+t,this.blendFilter=n.ALL;const i=this.component===r.ACCUMULATION?[{name:"uHighlightColorTextureWidth",value:this.viewer.getReferenceHighlights().getHighlightTextureWidth()}]:[],o={opacity:a.TRANSPARENT,blendMode:t===r.ACCUMULATION?d.ADD:d.DEST_ALPHA_PASSTHROUGH,extraShaderUniforms:i,disableDepthTest:!1,oitComponent:t,performIsolationTest:!0},h=new ie(e,this,{...o,primitiveType:s.FACES}),l=new ie(e,this,{...o,primitiveType:s.FACES,shaderTagSuffix:$m}),u=new ie(e,this,{...o,primitiveType:s.FACES,stencilMode:c.WRITE}),g=new ie(e,this,{...o,primitiveType:s.FACES,stencilMode:c.WRITE,shaderTagSuffix:$m}),p=new ie(e,this,{...o,primitiveType:s.EDGES,stencilMode:c.OFF}),m=new ie(e,this,{...o,primitiveType:s.EDGES,stencilMode:c.OFF,shaderTagSuffix:$m});this.edgePass=new DC(e,p,m,LS.eQ),this.facePass=new DC(e,h,l,LS.eQ),this.faceStencilPass=new DC(e,u,g,LS.eQ),this.silhouettesPass=new bt(e,this,this.sceneGraph,o),this.addChildPass(this.facePass),this.addChildPass(this.edgePass),this.addChildPass(this.silhouettesPass),this.addChildPass(this.faceStencilPass),this.setEdgeAndSilhouettesEnabled(!1)}justBeforeDraw(e){for(const e of this.childPasses)e.setShaderUniform("uTintFactor",this.tintFactor),e.setShaderUniform("uTintColor",this.tintColor)}setEdgeAndSilhouettesEnabled(e){this.edgePass.setEnabled(e),this.silhouettesPass.setEnabled(e)}appliesTranslucentAlphaToAll(e){this.applyTranslucentAlphaToAll=e,this.facePass.appliesTranslucentAlphaToAll(e),this.edgePass.appliesTranslucentAlphaToAll(e),this.silhouettesPass.appliesTranslucentAlphaToAll(e),this.faceStencilPass.appliesTranslucentAlphaToAll(e)}setSceneGraph(e){this.sceneGraph=e,this.facePass.setSceneGraph(e),this.edgePass.setSceneGraph(e),this.faceStencilPass.setSceneGraph(e),this.silhouettesPass.setSceneGraph(e)}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}setBlendFilter(e){this.blendFilter=e,this.facePass.setBlendFilter(e),this.edgePass.setBlendFilter(e),this.silhouettesPass.setBlendFilter(e),this.faceStencilPass.setBlendFilter(e)}setExtraMeshNodeFilter(e){this.extraMeshNodeFilter=e,this.facePass.setExtraMeshNodeFilter(e),this.edgePass.setExtraMeshNodeFilter(e),this.silhouettesPass.setExtraMeshNodeFilter(e),this.faceStencilPass.setExtraMeshNodeFilter(e)}setTintColor(e){this.tintColor=e,this.facePass.setShaderUniform("tintColor",e),this.edgePass.setShaderUniform("tintColor",e),this.silhouettesPass.setShaderUniform("tintColor",e),this.faceStencilPass.setShaderUniform("tintColor",e)}setTintFactor(e){this.tintFactor=e,this.facePass.setShaderUniform("tintFactor",e),this.edgePass.setShaderUniform("tintFactor",e),this.silhouettesPass.setShaderUniform("tintFactor",e),this.faceStencilPass.setShaderUniform("tintFactor",e)}setHideSelectionInterior(e){this.facePass.setHideSelectionInterior(e),this.edgePass.setHideSelectionInterior(e),this.silhouettesPass.setHideSelectionInterior(e),this.faceStencilPass.setHideSelectionInterior(e)}testIsolation(e){return this.performIsolationTest&&e.getHasIsolate()}}class F extends f{constructor(e){super(e,null),this.shaderTag="normalDepth",this.childPasses=[],this.points=[],this.scenegraph=null,this.opaqueFacePass=new ie(this.viewer,this,{}),this.childPasses.push(this.opaqueFacePass)}setSceneGraph(e){this.sceneGraph=e,this.opaqueFacePass.setSceneGraph(e)}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}setOpacity(e){this.opaqueFacePass.setOpacity(e)}justBeforeDraw(e){const t=this.viewer.getGlContext();t.disable(t.BLEND),super.justBeforeDraw(e)}nodeFilter(e){const t=this.viewer.getModelViewManagers().getManager();return!!(!e.isMeshNode()||t.isNodeForModel(e)&&t.isNodeForFaces(e))&&e.getIsVisible()}}const x=[.5,.5,1,1];function B(e,t,i){const s=D(e,new F(e),t,i);return s.clearColor=x,s}class V extends f{constructor(e,t){super(e,t),this.childPasses=[]}preDraw(e){const t=this.viewer.getGlContext();return t.clear(t.DEPTH_BUFFER_BIT),!0}}function U(e,t){return new V(e,t)}class G extends f{constructor(e,t,i){super(e,t),this.childPasses=Te(e,this,i)}}class H extends F{constructor(e,t){super(e),this.shaderTag="normalDepthWithMask",this.tintedEdges=new ie(this.viewer,this,{primitiveType:s.EDGES}),this.tintedEdges.setExtraMeshNodeFilter((function(e){return e.getIsTintedByCompare()})),this.tintedPoints=new ie(this.viewer,this,{primitiveType:s.POINTS}),this.tintedPoints.setExtraMeshNodeFilter((function(e){return e.getIsTintedByCompare()})),this.childPasses.push(this.tintedEdges),this.childPasses.push(this.tintedPoints),t&&(this.inputs.uMask=t)}justBeforeDraw(e){const t=e.getActiveShader();if(this.inputs.uMask){t.useTexture("uMask",this.inputs.uMask.getColorTexture());const i=e.getViewport();t.uniform2f("uMaskWidthHeight",i[2],i[3]),t.uniform1f("uUseMask",1)}else t.uniform1f("uUseMask",0),t.useBlankTexture("uMask");super.justBeforeDraw(e)}nodeFilter(e){return!!e.isMeshNode()&&e.getIsVisible()}}var k=i(83057);class W extends f{constructor(e,t){super(e,t);const i=this.viewer.getSceneGraphs().getMainSceneGraph(),n=this.viewer.getSceneGraphs().getPreviewSceneGraph();this.baseDefaultPasses=new _e(this.viewer,this,i,we.RENDERING),this.compareDefaultPasses=new _e(this.viewer,this,n,we.RENDERING),this.baseDefaultPasses.depthTransparentFaces.setEnabled(!1),this.compareDefaultPasses.depthTransparentFaces.setEnabled(!1),this.nonEditedFaceDepthPass=new ie(this.viewer,this,{primitiveType:s.FACES,disableColorWrites:!0}),this.nonEditedEdgeDepthPass=new ie(this.viewer,this,{primitiveType:s.EDGES,disableColorWrites:!0}),this.setRenderingMode(k.P1.SHADED_WITH_EDGES)}setBlendFilters(){this.baseDefaultPasses.setBlendFilter(n.BLEND_ONLY),this.compareDefaultPasses.setBlendFilter(n.BLEND_ONLY),this.nonEditedFaceDepthPass.setBlendFilter(n.NON_BLEND_ONLY),this.nonEditedEdgeDepthPass.setBlendFilter(n.NON_BLEND_ONLY)}setHideSelectionInterior(e){this.baseDefaultPasses.setHideSelectionInterior(e),this.compareDefaultPasses.setHideSelectionInterior(e)}pushOpaqueDepthPassWithAlpha(){As()>.5?(this.childPasses.push(this.compareDefaultPasses.depthFaces),this.childPasses.push(this.compareDefaultPasses.sectionPlaneEndcap),this.childPasses.push(this.compareDefaultPasses.depthEdges)):(this.childPasses.push(this.baseDefaultPasses.depthFaces),this.childPasses.push(this.baseDefaultPasses.sectionPlaneEndcap),this.childPasses.push(this.baseDefaultPasses.depthEdges))}setRenderingMode(e){this.baseDefaultPasses.setRenderingMode(e),this.compareDefaultPasses.setRenderingMode(e)}getBaseEndcapMaskPass(){return this.baseDefaultPasses.sectionPlaneEndcapMask}getPreviewEndcapMaskPass(){return this.compareDefaultPasses.sectionPlaneEndcapMask}}var z=i(25077),X=i(17922);const Z=function(e){if(!e.isMeshNode())return!1;if(this.blendFilter===n.BLEND_ONLY){if(!e.getIncludedInBlend())return!1}else if(this.blendFilter===n.NON_BLEND_ONLY&&e.getIncludedInBlend())return!1;return!!e.getIsDepthTested()&&(!e.hasTransparency()&&(!(e.getIsStencilTested()||!e.getIsStencilWritten())&&(this.priority===e.getRenderOrderPriority()&&this.parentPass.nodeFilter(e))))},q=function(e){const t=this.viewer.getModelViewManagers().getManager(),i=e.getParent();return!!(e.isEdges()&&i&&t.isNodeForBody(i))&&Z.call(this,e)},Y=function(e){return!!e.isSilhouettes()&&Z.call(this,e)};class K extends f{constructor(e,t,i){super(e,t),this.childPasses=[];const n=X.default.getManager(),r=(0,z.Z)(i);r.extraShaderUniforms=[{name:"uBackgroundMixProportion",value:0}];const a=(0,z.Z)(i);a.stencilMode=c.TEST,a.stencilRefValue=l.LOW_PRIORITY_EDGES,a.visibility=o.SHOWTHROUGH,a.disableDepthTest=!0,a.extraShaderUniforms=[{name:"uBackgroundMixProportion",value:n.getNumber("HIDDEN_LINE_FADE_AMOUNT")}],this.visibleEdgePass1=new ie(this.viewer,this,r),r.shaderTagSuffix=$m,this.visibleEdgePass2=new ie(this.viewer,this,r),this.visibleEdgePass=new DC(this.viewer,this.visibleEdgePass1,this.visibleEdgePass2,LS.eQ),this.childPasses.push(this.visibleEdgePass),this.hiddenEdgePass=new ie(this.viewer,this,a),i.primitiveType===s.EDGES?this.hiddenEdgePass.setNodeFilter(q):this.hiddenEdgePass.setNodeFilter(Y),this.hiddenEdgePass.setEnabled(!1),this.childPasses.push(this.hiddenEdgePass)}setDrawHidden(e){this.hiddenEdgePass.setEnabled(e),this.updateMixColor()}onAppearanceConstantsUpdated(){this.updateMixColor()}updateMixColor(){this.hiddenEdgePass.getEnabled()&&this.setShaderUniform("uBackgroundColor",X.default.getManager().getColor("BACKGROUND_COLOR"))}setDrawVisibleParts(e){e?this.visibleEdgePass.setNodeFilter(null):this.visibleEdgePass.setNodeFilter(se)}setBlendFilter(e){this.visibleEdgePass.setBlendFilter(e),this.hiddenEdgePass.setBlendFilter(e)}setExtraMeshNodeFilter(e){this.visibleEdgePass.setExtraMeshNodeFilter(e),this.hiddenEdgePass.setExtraMeshNodeFilter(e)}set nodeOccurrenceFilterFunction(e){this.visibleEdgePass1.nodeOccurrenceFilterFunction=e,this.visibleEdgePass1.nodeOccurrenceFilterFunction=e,this.hiddenEdgePass.nodeOccurrenceFilterFunction=e}appliesTranslucentAlphaToAll(e){this.visibleEdgePass.appliesTranslucentAlphaToAll(e)}setSceneGraph(e){this.visibleEdgePass.setSceneGraph(e)}}var j=i(85036),Q=i(45666);const $=X.default.getManager(),J=Q.create(),ee=C.create(),te=y.create();class ie extends f{constructor(e,t,i){switch(super(e,t),this.stencilRefValue=null,this.extraShaderUniforms=[],this.disableColorWrites=!1,this.clipToSectionPlanes=!0,this.disableDepthTest=!1,this.performIsolationTest=!1,this.sceneGraph=null,this.shaderTag="points",this.forDepth=!1,this.oitComponent=null,this.shader=null,this.occlusionMapTextureUnit=0,this.applyTranslucentAlphaToAll=!1,this.nodeOccurrenceFilterFunction=null,this.primitiveType=s.FACES,this.opacity=a.OPAQUE,this.visibility=o.VISIBLE,this.stencilMode=c.WRITE,this.priority=xi.DO.DEFAULT,this.facesShader=h.OPAQUE,this.blendMode=d.OVER_WITH_SEPARATE_ALPHA,this.blendFilter=n.ALL,this.depthTestMode=g.LESS,i&&(0,j.overwriteMatchingProperties)(this,i),this.primitiveType){case s.POINTS:break;case s.EDGES:this.shaderTag="edges";break;case s.FACES:switch(this.facesShader){case h.OPAQUE:this.shaderTag="faces";break;case h.ZEBRA_STRIPES:this.shaderTag="zebraStripes";break;case h.DRAFT:this.shaderTag="draftAnalysis";break;case h.QUALITY_VISUALIZATION:this.shaderTag="qualityVisualization"}break;case s.SILHOUETTES:this.shaderTag="silhouettes"}i.shaderTagSuffix&&(this.shaderTag=this.shaderTag+i.shaderTagSuffix),this.primitiveType!==s.FACES||i.hasOwnProperty("stencilMode")||(this.stencilMode=c.OFF)}setExtraMeshNodeFilter(e){this.extraMeshNodeFilter=e}setSceneGraph(e){this.sceneGraph=e}setBlendFilter(e){this.blendFilter=e}getPerformIsolationTest(){return this.performIsolationTest}setPerformIsolationTest(e){this.performIsolationTest=e}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}setEnableColorWrites(e){this.disableColorWrites=!e}setOpacity(e){this.opacity=e}setShaderUniform(e,t){for(const i of this.extraShaderUniforms)if(i.name===e)return void(i.value=t);this.extraShaderUniforms.push({name:e,value:t})}appliesTranslucentAlphaToAll(e){this.applyTranslucentAlphaToAll=e}isShowthroughPass(){return this.visibility===o.SHOWTHROUGH||!!this.parentPass&&this.parentPass.isShowthroughPass()}rendersPoints(){return this.primitiveType===s.POINTS}rendersEdges(){return this.primitiveType===s.EDGES||this.primitiveType===s.SILHOUETTES}rendersFaces(){return this.primitiveType===s.FACES}testIsolation(e){return this.performIsolationTest&&e.getHasIsolate()}usesShader(){return!0}setNodeOccurrenceFilterFunction(e){this.nodeOccurrenceFilterFunction=e}preDraw(e){if(!super.preDraw(e))return!1;const t=this.viewer.getGlContext();this.initializeShader(),e.activateShader(this.shader),this.isPickPass()||e.setMaterial();const i=this;switch(e.nodeFilter=function(e){return i.nodeFilter(e)},this.blendMode){case d.OVER_WITH_SEPARATE_ALPHA:t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case d.ADD:t.blendFunc(t.ONE,t.ONE);break;case d.DEST_ALPHA_PASSTHROUGH:t.blendFunc(t.ZERO,t.ONE_MINUS_SRC_ALPHA);break;default:throw"Unrecognized blend mode"}t.enable(t.BLEND),this.updateIsolationUniform(e,this.shader);const s=this.parentPass&&"depth"===this.parentPass.shaderTag,n=this.opacity===a.TRANSPARENT&&!this.disableColorWrites,r=this.rendersPoints()||this.rendersEdges(),o=s||this.forDepth||!n&&!r;e.getState().callGl("depthMask",o),this.disableDepthTest||this.applyTranslucentAlphaToAll?(t.disable(t.DEPTH_TEST),e.getState().callGl("depthMask",!1)):(t.enable(t.DEPTH_TEST),e.getState().callGl("depthMask",o),t.depthFunc(this.depthTestMode));const h=!this.isPickPass()&&!this.isHighlightPass(),l=(this.rendersEdges()||this.rendersPoints())&&h,u=this.rendersFaces()&&h;return this.stencilMode===c.TEST&&(l||u)?(0,at.LL)(t,this.getStencilRefValue(),this.getStencilRefMask()):this.stencilMode===c.WRITE&&(l||u)?(0,at.U$)(t,this.getStencilRefValue(),this.getStencilRefMask()):this.stencilMode===c.WRITE_AND_TEST_ISOLATE_CONTEXT&&u?(0,at.Ig)(t,this.getStencilRefValue(),this.getStencilRefMask()):t.disable(t.STENCIL_TEST),this.isPickPass()&&(e.getState().callGl("depthMask",!0),t.disable(t.BLEND)),this.disableColorWrites&&t.colorMask(!1,!1,!1,!1),this.rendersPoints()&&this.shader.uniform1f("uPointFilterWidth",$.getNumber("POINT_FILTER_WIDTH")),this.rendersEdges()&&(this.forDepth?this.shader.uniform1f("uLineFilterWidth",0):this.shader.uniform1f("uLineFilterWidth",$.getNumber("LINE_FILTER_WIDTH"))),this.nodeOccurrenceFilterFunction&&e.setNodeOccurrenceFilterFunction(this.nodeOccurrenceFilterFunction),!0}onShaderActivated(e,t){e.getDetailSettings().enableSSAO&&this.inputs.hasOwnProperty("uOcclusionMap")&&!e.getHasIsolate()?(t.useTexture("uOcclusionMap",this.inputs.uOcclusionMap.getColorTexture()),t.uniform1f("uOcclusionFactor",$.getNumber("AMBIENT_OCCLUSION_EFFECT_FACTOR"))):t.uniform1f("uOcclusionFactor",0),this.updateIsolationUniform(e,t);const i=this.viewer.getResources().getHighlightTexture();t.useTexture("uHighlightColorTexture",i),t.uniform1f("uHighlightColorTextureWidth",this.viewer.getReferenceHighlights().getHighlightTextureWidth()),(0,LS.qS)(this.viewer,this.clipToSectionPlanes),this.rendersFaces()&&(t.uniform1f("uTintFactor",0),t.uniform3f("uTintColor",1,1,1),t.uniform1i("uApplyTranslucentAlphaToAll",this.applyTranslucentAlphaToAll?1:0),t.uniform1i("uHideSelectionInterior",this.hideSelectionInterior?1:0)),this.applyExtraUniforms(t)}updateIsolationUniform(e,t){this.testIsolation(e)?t.uniform1i("uOutsideIsolation",this.forIsolate()?0:1):t.uniform1i("uOutsideIsolation",0)}getStencilRefValue(){return this.stencilRefValue?this.stencilRefValue:this.stencilMode===c.WRITE_AND_TEST_ISOLATE_CONTEXT?l.ISOLATE_CONTEXT:this.rendersEdges()?l.EDGES:this.rendersFaces()?l.FACES:l.POINTS}getStencilRefMask(){return this.stencilMode===c.WRITE_AND_TEST_ISOLATE_CONTEXT?u.ISOLATE_CONTEXT:this.rendersEdges()?u.EDGES:this.rendersFaces()?u.FACES:u.POINTS}justBeforeDraw(e){super.justBeforeDraw(e),this.applyExtraUniforms(this.shader)}applyExtraUniforms(e){for(const t of this.extraShaderUniforms)if(t.value)switch(t.value.length){case 4:e.uniform4fv(t.name,t.value);break;case 3:e.uniform3fv(t.name,t.value);break;case 2:e.uniform2fv(t.name,t.value);break;default:e.uniform1f(t.name,t.value)}}justAfterDraw(e){super.justAfterDraw(e);const t=e.getActiveShader();this.extraShaderUniforms.forEach((function(e){if(e.value)switch(e.value.length){case 4:t.uniform4fv(e.name,te);break;case 3:t.uniform3fv(e.name,ee);break;case 2:t.uniform2fv(e.name,J);break;default:t.uniform1f(e.name,0)}}),this)}postDraw(e){const t=this.viewer.getGlContext();t.disable(t.STENCIL_TEST),t.enable(t.DEPTH_TEST),t.disable(t.BLEND),t.colorMask(!0,!0,!0,!0),this.nodeOccurrenceFilterFunction&&e.setNodeOccurrenceFilterFunction(null)}nodeFilter(e){if(!e.isMeshNode())return!1;if(this.blendFilter===n.BLEND_ONLY){if(!e.getIncludedInBlend())return!1}else if(this.blendFilter===n.NON_BLEND_ONLY&&e.getIncludedInBlend())return!1;if(this.extraMeshNodeFilter&&!this.extraMeshNodeFilter(e))return!1;if(this.disableDepthTest===e.getIsDepthTested())return!1;switch(this.primitiveType){case s.POINTS:if(!e.isPoints())return!1;break;case s.EDGES:if(!e.isEdges())return!1;break;case s.FACES:if(!e.isFaces())return!1;break;case s.SILHOUETTES:if(!e.isSilhouettes())return!1}switch(this.visibility){case o.VISIBLE:if(e.getIsShowThrough())return!1;switch(this.opacity){case a.OPAQUE:if(e.hasTransparency())return!1;break;case a.TRANSPARENT:if(!e.hasTransparency()&&!this.applyTranslucentAlphaToAll)return!1}break;case o.SHOWTHROUGH:if(!e.getIsShowThrough())return!1}const t=e.getIsStencilTested(),i=e.getIsStencilWritten();return!(this.stencilMode===c.TEST&&!t)&&(!(this.stencilMode===c.WRITE&&(!i||t))&&((this.stencilMode!==c.OFF||!t&&!i)&&(this.priority===e.getRenderOrderPriority()&&this.parentPass.nodeFilter(e))))}setNodeFilter(e){this.nodeFilter=e||ie.prototype.nodeFilter}}function se(e){const t=this.viewer.getModelViewManagers().getManager(),i=e.getParent();return!(i&&t.isNodeForBody(i)&&!e.getAddsToBounds())&&ie.prototype.nodeFilter.call(this,e)}class ne extends ie{constructor(e,t,i,s){super(e,t,{facesShader:h.QUALITY_VISUALIZATION,performIsolationTest:i}),this.setSceneGraph(s)}}class re extends f{constructor(e,t,i,s,n){super(e,t),this.childPasses=[];const r=!!n;this.scenegraph=this.viewer.getSceneGraphs().getMainSceneGraph(),s===fs.L.PREVIEW&&(this.scenegraph=this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.usage=s||fs.L.BASE;const a=this.viewer.getReferenceHighlights().sortedHighlights;for(let e=0;e<a.length;++e){const t=a[e].type;if(n&&!n.has(t))continue;dn.o2.FILTERED_ENTITIES;const s=t===dn.o2.FILTERED_ENTITIES&&!r,o=new ft(this.viewer,t,i,s);o.setSceneGraph(this.scenegraph),this.childPasses.push(o)}}setInteriorHighlightOpacity(e){for(let t=0;t<this.childPasses.length;++t)this.childPasses[t].setInteriorHighlightOpacity(e)}getSceneGraph(){return this.scenegraph}drawInputs(e){}draw(e){if(this.usage!==fs.L.BASE||e.getBaseHighlightsEnabled())for(let t=0;t<this.childPasses.length;++t)this.viewer.getHighlightManager(this.usage).highlightHasSelections(this.childPasses[t].highlightType)&&(this.childPasses[t].drawInputs(e),this.childPasses[t].draw(e))}setHideSelectionInterior(e){for(let t=0;t<this.childPasses.length;++t)this.childPasses[t].setHideSelectionInterior(!!e&&this.childPasses[t].highlightType!==dn.o2.PRE)}setMaskOpaqueFaces(e){for(let t=0;t<this.childPasses.length;t++)this.childPasses[t].setMaskOpaqueFaces(e)}}class ae extends f{constructor(e,t,i,n,r,h,l){let u;super(e,i),this.highlightType=t,this.useDepthTest=n,this.stippleOverride=r,this.clipAgainstSectionPlane=h,this.disableDuringPreview=l,this.shaderTag="highlightDraw",this.childPasses=[],h||(u=$m);const d=X.default.getManager();for(let e=0;e<xi.DO.COUNT;++e)this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.EDGES,visibility:o.SHOWTHROUGH,stencilMode:c.TEST,disableDepthTest:!0,priority:e,shaderTagSuffix:u})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.POINTS,visibility:o.SHOWTHROUGH,stencilMode:c.TEST,disableDepthTest:!0,priority:e,shaderTagSuffix:u})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.EDGES,visibility:o.SHOWTHROUGH,disableDepthTest:!0,priority:e,shaderTagSuffix:u})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.POINTS,visibility:o.SHOWTHROUGH,disableDepthTest:!0,priority:e,shaderTagSuffix:u})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.EDGES,visibility:o.SHOWTHROUGH,priority:e,shaderTagSuffix:u})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.POINTS,visibility:o.SHOWTHROUGH,priority:e,shaderTagSuffix:u}));this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.EDGES,shaderTagSuffix:u})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.EDGES,opacity:a.TRANSPARENT,stencilMode:c.OFF,extraShaderUniforms:[{name:"uHighlightLineWidthMin",value:d.getNumber("HIGHLIGHT_LINE_WIDTH_TRANSPARENT_MIN")}],shaderTagSuffix:u})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.POINTS,shaderTagSuffix:u}))}isHighlightPass(){return!0}getActiveHighlightType(){return this.highlightType}needsAttribute(e){const t=e===tE.HIGHLIGHT_ID;return this.parentPass?t||this.parentPass.needsAttribute(e):t}getHighlight(){return this.viewer.getReferenceHighlights().highlights[this.highlightType]}getEnabled(){return this.enabled&&(!this.disableDuringPreview||!Ns())}nodeFilter(e){return this.getHighlight().forOccurrences?e.getParent()&&!this.viewer.getModelViewManagers().getManager().isNodeForBody(e.getParent()):f.prototype.nodeFilter.apply(this,[e])}justBeforeDraw(e){const t=X.default.getManager();super.justBeforeDraw(e);const i=e.getActiveShader(),s=this.getHighlight(),n=s.type===dn.o2.FILTERED_ENTITIES;i.uniform1f("uActiveHighlightIndex",s.index),i.uniform4fv("uHighlightColor",s.color1),i.uniform1f("uHighlightLineWidthMin",n?t.getNumber("HIGHLIGHT_LINE_WIDTH_REDUCED_PX"):t.getNumber("HIGHLIGHT_LINE_WIDTH_MIN_PX")),i.uniform1f("uHighlightPointSizeMin",t.getNumber("HIGHLIGHT_POINT_SIZE_MIN_PX")),this.stippleOverride?(i.uniform4fv("uHighlightLineStipple",this.stippleOverride),i.uniform1f("uUseHighlightLineStipple",1),e.setUseHiddenOpacityForEdgeHighlights(!0)):(i.uniform1f("uUseHighlightLineStipple",0),e.setUseHiddenOpacityForEdgeHighlights(!1)),i.uniform1i("uClippedBySectionPlanes",this.clipAgainstSectionPlane?1:0);const r=this.viewer.getGlContext();r.enable(r.BLEND),r.blendFuncSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA),this.useDepthTest?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),e.getState().callGl("depthMask",!1)}}class oe extends f{constructor(e,t,i,s){super(e,null),this.childPasses=[];const n=X.default.getManager();this.usage=t||fs.L.BASE,this.scenegraph=this.viewer.getSceneGraphs().getMainSceneGraph(),t===fs.L.PREVIEW&&(this.scenegraph=this.viewer.getSceneGraphs().getPreviewSceneGraph());const r=!!s;for(let e=0;e<this.viewer.getReferenceHighlights().sortedHighlights.length;++e){const t=this.viewer.getReferenceHighlights().sortedHighlights[e].type;if(s&&!s.has(t))continue;const a=t===dn.o2.FILTERED_ENTITIES,o=t===dn.o2.FILTERED_ENTITIES,h=t===dn.o2.FILTERED_ENTITIES&&!r;i?a&&this.childPasses.push(new ae(this.viewer,t,this,!0,null,o,h)):a?this.childPasses.push(new ae(this.viewer,t,this,!1,n.getStipple("HIGHLIGHT_HIDDEN_LINE_STIPPLE"),o,h)):this.childPasses.push(new ae(this.viewer,t,this,!1,null,o,h))}}preDraw(e){return!(this.usage===fs.L.BASE&&!e.getBaseHighlightsEnabled())&&super.preDraw(e)}drawInputs(e){for(let e=0;e<this.childPasses.length;++e)this.childPasses[e].setEnabled(this.viewer.getHighlightManager(this.usage).highlightHasSelections(this.childPasses[e].highlightType));f.prototype.drawInputs.apply(this,[e])}setSceneGraph(e){this.scenegraph=e}getSceneGraph(){return this.scenegraph}}const he=X.default.getManager();class ce extends T{constructor(e){super(e),this.checkFrameId=!1,this.shaderTag="depth",this.useHighlightsOnly=!1,this.childPasses=[],this.points=[],this.numSamples=0,this.includePlanes=!0,this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0,extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.FACES,opacity:a.TRANSPARENT,performIsolationTest:!0,extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.EDGES,performIsolationTest:!0,extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.EDGES,performIsolationTest:!0,opacity:a.TRANSPARENT,stencilMode:c.OFF,extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.POINTS,performIsolationTest:!0,extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.POINTS,performIsolationTest:!0,visibility:o.SHOWTHROUGH,extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0,sceneGraph:this.viewer.getSceneGraphs().getPreviewSceneGraph(),extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0,opacity:a.TRANSPARENT,sceneGraph:this.viewer.getSceneGraphs().getPreviewSceneGraph(),extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.clearColor=Fs.XD}setIncludePlanes(e){this.includePlanes=e}nodeFilter(e){return!!e.getIsVisible()&&(!e.isMeshNode()||!CM(e)||this.includePlanes)}needsAttribute(e){const t=e===tE.HIGHLIGHT_ID&&this.useHighlightsOnly;return this.parentPass?t||this.parentPass.needsAttribute(e):t}isHighlightPass(){return this.useHighlightsOnly}getActiveHighlightType(){return dn.o2.ENTITY}setUseHighlightsOnly(e){this.useHighlightsOnly=e;const t=e?1:0;for(let e=0;e<this.childPasses.length;e++)this.childPasses[e].setShaderUniform("uUseHighlightsOnly",t)}draw(e){throw"Use DepthSamplingPass retrieve method instead"}retrieve(e,t){t=t||{},this.numSamples=void 0===t.numSamples?he.getNumber("DEPTH_SAMPLES_PER_VIEWPORT"):t.numSamples,this.includePlanes=void 0===t.includePlanes||t.includePlanes,this.setPerformIsolationTest(void 0===t.performIsolationTest||t.performIsolationTest),this.setUseHighlightsOnly(void 0!==t.useHighlightsOnly&&t.useHighlightsOnly),super.draw(e)}preDraw(e){const t=e.getViewport(),i=Math.min(Math.sqrt(this.numSamples/(t[2]*t[3])),1);return this.horizontalScale=Math.ceil(t[2]*i)/t[2],this.verticalScale=Math.ceil(t[3]*i)/t[3],this.fullViewport=t,this.shrunkViewport=[0,0,Math.max(Math.round(this.horizontalScale*t[2]),1),Math.max(Math.round(this.verticalScale*t[3]),1)],e.pushViewport(this.shrunkViewport),super.preDraw(e)}postDraw(e){const t=this.shrunkViewport[2]*this.shrunkViewport[3]*4,i=new Uint8Array(t),s=this.viewer.getGlContext();s.readPixels(0,0,this.shrunkViewport[2],this.shrunkViewport[3],s.RGBA,s.UNSIGNED_BYTE,i),this.points=[];for(let e=0;e<t/4;e++){const t=4*e,s=(0,Fs.Rg)([i[t],i[t+1],i[t+2],i[t+3]],this.viewer.isHighPrecisionSupportedInFragmentShader());if(s===Fs.BG)continue;const n=e%this.shrunkViewport[2]+.5,r=this.shrunkViewport[3]-Math.floor(e/this.shrunkViewport[2])-.5,a=this.fullViewport[0]+n/this.horizontalScale,o=this.fullViewport[1]+r/this.verticalScale;this.points.push([a,o,s])}e.popViewport(),super.postDraw(e)}}class le extends I{constructor(e,t,i){super(e),this.shaderTag="previewBlend",this.inputs.uBaseTexture=t,this.inputs.uPreviewTexture=i,this.blendMode=p.BLEND_ALPHA}justBeforeDraw(e){super.justBeforeDraw(e),this.shader.uniform1f("uPreviewAlpha",ys().previewAlpha)}}var ue=i(15198),de=i(18265),ge=i(80462);const pe=64,me=function(e){const t=new ue.H(0),i=new Uint8Array(4096);for(let e=0;e<4096;++e)i[e]=Math.floor(256*t.random());const s=new ja(e);return s.internalFormat=e.LUMINANCE,s.format=e.LUMINANCE,s.bytes=i,s.width=pe,s.height=pe,s.minificationFilter=e.LINEAR,s.magnificationFilter=e.LINEAR,s.wrapS=e.REPEAT,s.wrapT=e.REPEAT,s};class fe extends I{constructor(e,t){super(e),this.shaderTag="normalDepthFilter",this.blendMode=p.BLEND_OFF,this.inputs.uNormalDepthTexture=t}}class Ie extends I{constructor(e,t,i){super(e),this.shaderTag="occlusion",this.inputs.uNormalDepthTexture=i||t,this.normalDepthPass=t,this.filteredNormalDepthPass=i,this.randomTexture=new $a(this.viewer,me)}drawInputs(e){const t=e.getDetailSettings();this.filteredNormalDepthPass&&t.enableSSAOFilter?this.inputs.uNormalDepthTexture=this.filteredNormalDepthPass:this.inputs.uNormalDepthTexture=this.normalDepthPass,I.prototype.drawInputs.call(this,e)}justBeforeDraw(e){const t=X.default.getManager();super.justBeforeDraw(e),this.shader.useTexture("uRandomTexture",this.randomTexture);const i=e.getViewport(),s=i[2],n=i[3],r=Math.sqrt(s*s+n*n);this.shader.uniform2fv("uRandomTextureScale",[(s-1)/pe,(n-1)/pe]);const a=ge.w$.inverse(e.getProjectionMatrix(),de.create());a&&this.shader.uniformMatrix4fv("uPMatrixInv_fs",!1,a),this.shader.uniform1f("uIntensity",t.getNumber("AMBIENT_OCCLUSION_INTENSITY")),this.shader.uniform1f("uBias",t.getNumber("AMBIENT_OCCLUSION_BIAS")),this.shader.uniform1f("uScale",t.getNumber("AMBIENT_OCCLUSION_SCALE")),this.shader.uniform1f("uRadiusNear",Math.max(t.getNumber("AMBIENT_OCCLUSION_RADIUS_NEAR")*r,2)),this.shader.uniform1f("uRadiusFar",Math.max(t.getNumber("AMBIENT_OCCLUSION_RADIUS_FAR")*r,2))}}class Ee extends I{constructor(e,t){super(e),this.shaderTag="occlusionFilter",this.blendMode=p.BLEND_OFF,this.inputs.uOcclusionMap=t}}function Se(e){const t=X.default.getManager(),i=B(e,t.getNumber("AMBIENT_OCCLUSION_VIEWPORT_RATIO"),"ssaoBuffer1");let s=null;if(e.isSSAOFilteringSupported()){s=D(e,new fe(e,i),t.getNumber("AMBIENT_OCCLUSION_VIEWPORT_RATIO"),"ssaoFilterBuffer")}const n=D(e,new Ie(e,i,s),t.getNumber("AMBIENT_OCCLUSION_VIEWPORT_RATIO"),"ssaoBuffer2");return D(e,new Ee(e,n),t.getNumber("AMBIENT_OCCLUSION_VIEWPORT_RATIO"),"ssaoBuffer1")}function Te(e,t,i){const n=[],r=!!i.hasOwnProperty("usePickAlternates")&&i.usePickAlternates;return i.primitiveType=s.FACES,n.push(new ie(e,t,i)),r&&n.push(new ke(e,t,i)),i.primitiveType=s.EDGES,n.push(new ie(e,t,i)),r&&n.push(new ke(e,t,i)),i.primitiveType=s.POINTS,n.push(new ie(e,t,i)),n}var De;!function(e){e[e.DEPTH_AND_NORMAL=0]="DEPTH_AND_NORMAL",e[e.DEPTH_ONLY=1]="DEPTH_ONLY",e[e.PLANE_ID=2]="PLANE_ID"}(De||(De={}));class Me extends ie{constructor(e,t,i,n,r,o){super(e,t,i),this.tintOpacity=1,this.tintColor=n,this.matchesCompareColor=r,this.inputs.uCompareBuffer=o,this.tintTestType=De.DEPTH_ONLY,this.primitiveType===s.FACES&&(this.opacity===a.TRANSPARENT?this.tintTestType=De.PLANE_ID:this.tintTestType=De.DEPTH_AND_NORMAL),this.opacity===a.TRANSPARENT&&(this.tintOpacity=X.default.getManager().getNumber("COMPARE_TRANSLUCENT_FACE_OPACITY")),this.tintTestType===De.DEPTH_ONLY&&this.setExtraMeshNodeFilter((function(e){return e.getIsTintedByCompare()}))}getShaderId(){return this.tintTestType===De.PLANE_ID?"-tintByPlaneId-"+this.shaderTag:this.tintTestType===De.DEPTH_AND_NORMAL?"-tintByNormalDepth-"+this.shaderTag:"-tintByDepth-"+this.shaderTag}onShaderActivated(e,t){super.onShaderActivated(e,t),t.uniform3f("uTintColor",this.tintColor[0],this.tintColor[1],this.tintColor[2]),t.uniform1f("uTintOpacity",this.tintOpacity),t.uniform1f("uBlendOverdrawAdjustment",1/(1+At())),t.uniform3f("uMatchesCompareColor",this.matchesCompareColor[0],this.matchesCompareColor[1],this.matchesCompareColor[2]),this.inputs.uCompareBuffer&&t.useTexture("uCompareBuffer",this.inputs.uCompareBuffer.getColorTexture())}}var Ce=i(45454),ye=i(39986);const Pe=X.default.getManager();class Ae extends T{constructor(e,t){super(e),this.mainDrawPass=t,this.TEMP_VEC4=y.create(),this.TEMP_MAT4=de.create(),this.shaderTag="pick",this.checkFrameId=!1,this.pickBuffer=null,this.pickRect=[0,0,1,1],this.pickViewportWidthHeight=[1,1],this.enablePickViewportScaling=!0,this.oldViewport=[0,0,1,1],this.hitlist=[],this.isBoxSelecting=!1,this.suppressNonIsolatedPicks=!0,this.childrenPerformIsolationTest=null,this.childPassIsolateTests=[],this.nodeFilterOverride=null,this.pickFromPreview=!1,this.pickFrustum=new tr;const i=new _e(this.viewer,this,null,we.PICKING);this.opaqueFacePass=i.opaqueFaces,this.opaqueFaceAlternatePass=new ke(this.viewer,this,{performIsolationTest:!0}),this.previewStateChangeSubscription=ys().stateChangedObservable.pipe((0,ye.h)((e=>e===ps.PREVIEW_STATE_CHANGE))).subscribe((()=>this.onPreviewStateChange())),this.childPasses=[],this.childPasses.push(this.opaqueFacePass),this.childPasses.push(this.opaqueFaceAlternatePass),this.childPasses.push(i.stencilWritingOpaqueFaces);const n=new ke(this.viewer,this,{performIsolationTest:!0,stencilMode:c.WRITE});this.childPasses.push(n),t&&(this.sectionPlaneEndcapDrawPasses=new A(this.viewer,this,t.sectionPlaneEndcapMaskPass),this.childPasses.push(this.sectionPlaneEndcapDrawPasses)),this.transparentFacePass=i.nonOitTransparentFaces,this.transparentFaceAlternatePass=new ke(this.viewer,this,{opacity:a.TRANSPARENT,performIsolationTest:!0}),this.childPasses.push(this.transparentFacePass),this.childPasses.push(this.transparentFaceAlternatePass),this.childPasses.push(i.sketchImageFaces),this.postOpaqueFaceDepthClearPass=U(this.viewer,this),this.postOpaqueFaceDepthClearPass.setEnabled(!1),this.childPasses.push(this.postOpaqueFaceDepthClearPass),this.opaqueEdgesPass=new ie(this.viewer,this,{primitiveType:s.EDGES,performIsolationTest:!0}),this.opaqueEdgesAlternatesPass=new ke(this.viewer,this,{primitiveType:s.EDGES,performIsolationTest:!0}),this.childPasses.push(this.opaqueEdgesPass),this.childPasses.push(this.opaqueEdgesAlternatesPass),this.childPasses.push(i.transparentEdges),this.childPasses.push(new ke(this.viewer,this,{primitiveType:s.EDGES,opacity:a.TRANSPARENT,performIsolationTest:!0})),this.opaquePointsPass=i.opaquePoints,this.childPasses.push(this.opaquePointsPass),this.childPasses.push(U(this.viewer,this));for(let e=0;e<xi.DO.COUNT;++e)this.childPasses.push(i.showThroughStencilTested.getChildPass(e)),this.childPasses.push(i.showThroughNotStencilTested.getChildPass(e)),this.childPasses.push(i.showThroughDepthTested.getChildPass(e));this.childPasses.push(Ne(this.viewer,this)),this.clearColor=Fs.o0;for(let e=0;e<this.childPasses.length;e++)this.childPassIsolateTests[e]=this.childPasses[e].getPerformIsolationTest();this.isolatedNodeOccurrenceFilter=e=>{const t=this.viewer.getIsolatedOccurrenceManager();if(e.occurrenceData.getIsolated()||!t?.isInIsolateOrMakeTransparentMode()||t?.isInIsolateOrMakeTransparentMode()&&t.isInPickingMode()||this.viewer.getIsForFlattenedDisplay())return!0;const i=e.occurrenceData.getOccurrenceId();return i===Jf.KF||!(!this.viewer.getModelViewManagers().getManager().isDisplayingIncontextAssembly()||!this.viewer.getModelViewManagers().getManager().isOccurrenceIdForInContext(i))}}onSessionEnded(){this.previewStateChangeSubscription.unsubscribe(),super.onSessionEnded()}setPickFromPreview(e){this.pickFromPreview!==e&&(this.pickFromPreview=e,this.onPreviewStateChange())}setPickAlternatesEnabled(e){for(let t=0;t<this.childPasses.length;++t)if(this.childPasses[t]instanceof ke)this.childPasses[t].setEnabled(e);else if(this.childPasses[t]instanceof G)for(let i=0;i<this.childPasses[t].childPasses.length;++i)this.childPasses[t].childPasses[i]instanceof ke&&this.childPasses[t].childPasses[i].setEnabled(e)}setPerformIsolationTest(e){if(this.childrenPerformIsolationTest!==e)if(this.childrenPerformIsolationTest=e,this.childrenPerformIsolationTest)for(let e=0;e<this.childPasses.length;e++)this.childPasses[e].setPerformIsolationTest(this.childPassIsolateTests[e]);else for(let e=0;e<this.childPasses.length;e++)this.childPasses[e].setPerformIsolationTest(!1)}setSuppressNonIsolatedPicks(e){this.suppressNonIsolatedPicks=e}setIsBoxSelecting(e){this.isBoxSelecting=e}setRenderingMode(e){const t=this,i=function(e){e?(t.opaqueEdgesPass.setNodeFilter(null),t.opaqueEdgesAlternatesPass.setNodeFilter(null),t.opaquePointsPass.setNodeFilter(null)):(t.opaqueEdgesPass.setNodeFilter(se),t.opaqueEdgesAlternatesPass.setNodeFilter(se),t.opaquePointsPass.setNodeFilter(se))};switch(e){case k.P1.SHADED_WITH_EDGES:case k.P1.DRAFT_ANALYSIS:case k.P1.SHADED_CURVATURE_VISUALIZATION:case k.P1.CURVATURE_VISUALIZATION:case k.P1.SIMULATION_RESULTS:case k.P1.SHADED_WITHOUT_EDGES:this.postOpaqueFaceDepthClearPass.setEnabled(!1),i(!0);break;case k.P1.SHADED_WITH_HIDDEN_EDGES:this.postOpaqueFaceDepthClearPass.setEnabled(!0),i(!0);break;case k.P1.HIDDEN_LINE_REMOVED:this.postOpaqueFaceDepthClearPass.setEnabled(!1),i(!0);break;case k.P1.HIDDEN_LINE_VISIBLE:case k.P1.WIREFRAME:case k.P1.TRANSLUCENT:this.postOpaqueFaceDepthClearPass.setEnabled(!0),i(!0)}}isPickPass(){return!0}setEnablePickViewportScaling(e){this.enablePickViewportScaling=e}getMaxHighResPickViewportSamples(){return Pe.getNumber("MAX_HIGH_RES_PICKING_RECT_SAMPLES")}setPickRect(e,t,i,s,n){this.pickRect=[e,t,i,s];const r=i*s;if(n&&r>n){const e=Math.sqrt(n/r),t=Math.floor((i-1)*e)+1,a=Math.floor((s-1)*e)+1;this.pickViewportWidthHeight=[t,a]}else if(this.enablePickViewportScaling&&r>this.getMaxHighResPickViewportSamples()){const e=Pe.getNumber("LOW_RES_PICKING_RECT_SCALE"),t=1/Math.min(i,s),n=Math.max(e,t),r=Math.floor((i-1)*n)+1,a=Math.floor((s-1)*n)+1;this.pickViewportWidthHeight=[r,a]}else this.pickViewportWidthHeight=[i,s]}getPickRect(){return this.pickRect}getPickViewportWidthHeight(){return this.pickViewportWidthHeight}getPickFrustum(e,t){const i=this.TEMP_VEC4;i[0]=this.pickRect[0]-t,i[1]=this.pickRect[1]-t,i[2]=this.pickRect[2]+2*t,i[3]=this.pickRect[3]+2*t;const s=(0,yi.zL)(i,e.getViewport(),e.getActiveCamera().getCanvasHeight()),n=ge.w$.multiply(s,e.getProjectionMatrix(),this.TEMP_MAT4);return this.pickFrustum.updateClippingPlanes(e.getModelViewMatrix(),n),this.pickFrustum}preDraw(e){e.setNodeOccurrenceFilterFunction(this.isolatedNodeOccurrenceFilter);const t=this.getAllowedSelections(),i=this.suppressNonIsolatedPicks||!1===t.allowsNonModifiableGeometry;this.setPerformIsolationTest(i),this.oldViewport=e.getViewport();const s=(0,yi.zL)(this.pickRect,this.oldViewport,e.getActiveCamera().getCanvasHeight()),n=ge.w$.multiply(s,e.getProjectionMatrix(),this.TEMP_MAT4);return e.pushProjectionMatrix(n),e.pushViewport([0,0,this.pickViewportWidthHeight[0],this.pickViewportWidthHeight[1]]),super.preDraw(e)}getAllowedSelections(){return this.isBoxSelecting?(0,Ce.Ac)():(0,Ce.y0)()}setNodeFilterOverride(e){this.nodeFilterOverride=e||null}nodeFilter(e){if(this.nodeFilterOverride)return this.nodeFilterOverride(e);const t=this.getAllowedSelections(),i=this.viewer.getModelViewManagers().getManagerForUsage(this.getUsage());if(t&&i.isNodeForModel(e)){const s=e.getParent();if(!1===t.allowsBodies&&!1===t.allowsSketchEntities&&i.isNodeForSketch(s))return!1;if(!1===t.allowsBodyEntities&&!1===t.allowsBodies&&i.isNodeForBody(s))return!1;if(e.isMeshNode()){if(!1===t.allowsBodies&&!1===t.allowsEdges&&i.isNodeForEdges(e))return!1;if(!1===t.allowsBodies&&!1===t.allowsVertices&&i.isNodeForPoints(e))return!1}}return e.getIsPickable()}postDraw(e){e.setNodeOccurrenceFilterFunction(null);const t=this.pickViewportWidthHeight[0]*this.pickViewportWidthHeight[1]*4;(!this.pickBuffer||this.pickBuffer.length<t)&&(this.pickBuffer=new Uint8Array(t));const i=this.viewer.getGlContext();i.readPixels(0,0,this.pickViewportWidthHeight[0],this.pickViewportWidthHeight[1],i.RGBA,i.UNSIGNED_BYTE,this.pickBuffer),this.hitlist=[];for(let e=0;e<t/4;e++){const t=4*e,i=(0,Fs.EI)(this.pickBuffer[t],this.pickBuffer[t+1],this.pickBuffer[t+2],this.pickBuffer[t+3]);this.hitlist.push(i)}e.popProjectionMatrix(),e.popViewport(),super.postDraw(e)}getPositionForPickHit(e){const t=this.pickRect[0],i=this.pickRect[1],s=this.pickRect[2],n=this.pickRect[3],r=s/this.pickViewportWidthHeight[0],a=n/this.pickViewportWidthHeight[1],o=e%this.pickViewportWidthHeight[0]*r,h=Math.floor(e/this.pickViewportWidthHeight[0])*a;return Q.fromValues(t+o,i+(n-1-h))}getSceneGraph(){return this.pickFromPreview?this.viewer.getSceneGraphs().getPreviewSceneGraph():this.viewer.getSceneGraphs().getMainSceneGraph()}getUsage(){return this.pickFromPreview?fs.L.PREVIEW:fs.L.BASE}onPreviewStateChange(){this.sectionPlaneEndcapDrawPasses&&this.sectionPlaneEndcapDrawPasses.setEndcapMaskPass(this.mainDrawPass.getSectionEndcapMaskPassForPicking(this.pickFromPreview))}}const Oe=X.default.getManager();class ve extends Ae{constructor(e,t){super(e,t),this.primitivePickIds=[],this.occurrencePickIds=[],this.primitiveIdPool=[],this.currentPass=0,this.pickMask=null}setEmptyHitList(){this.hitlist=[];const e=this.pickRect[2]*this.pickRect[3],t=Si.JE.slice(0);for(let i=0;i<e;++i)this.primitivePickIds[i]=t,this.occurrencePickIds[i]=Jf.Qy}getPickIteration(){return this.currentPass}justBeforeDraw(e){e.getActiveShader().uniform1f("uPickPassIteration",this.getPickIteration())}draw(e){if(this.primitiveIdPool=this.primitivePickIds,this.primitivePickIds=[],this.occurrencePickIds=[],!this.enabled)return void this.setEmptyHitList();e.setActivePass(this);const t=[];let i,s;for(i=this.viewer.getPickPassCount()-1;i>=0;--i)this.currentPass=i,super.draw(e),t.unshift(this.hitlist);if(t.length<1)return void this.setEmptyHitList();const n=t[0].length;for(i=0;i<n;++i){const e=this.primitiveIdPool.length>0?this.primitiveIdPool.pop():[];let n=0,r=-1;for(s=0;s<t.length;++s){const a=t[s][i],o=a&Si.U2.ENTITY;o!==Si.vN&&(e[s]=o,r=s);n|=(a>>>Si._6.ENTITY&Si.U2.OCCURRENCE_SLICE)<<s*Si._6.OCCURRENCE_SLICE}e.length!==r+1&&(e.length=r+1),this.primitivePickIds.push((0,Si.qR)(e)),this.occurrencePickIds.push(n)}}gatherPicksFromPickPass(){const e={};let t,i,s;const n=this.getPickRect(),r=n[2],a=n[3],o=[n[0]+.5*r,n[1]+.5*a],h=this.getPickViewportWidthHeight(),c=2/Math.sqrt((r-1)*(r-1)+(a-1)*(a-1)),l=1/(h[0]*h[1]);for(let n=0;n<this.primitivePickIds.length;++n){if(null!==this.pickMask&&0!==this.pickMask[n])continue;const r=this.getPositionForPickHit(n);if(i=this.primitivePickIds[n],t=this.occurrencePickIds[n],(0,Si.rp)(i)&&t!==Jf.Qy){s=e[t],s||(s={},e[t]=s);let n=s[i];n?n.incorporateLocation(r):(n=new qm.D(i,t,r,this.getUsage()),s[i]=n),n.distance=Math.min(n.distance,ge.gv.length(ge.gv.subtract(r,o,Q.create()))*c),n.coverage+=l}}for(t in e)for(i in s=e[t],s)s[i].determineBestLocation();return e}clearPickMask(){this.pickMask=null}updatePickMask(e,t,i){this.pickMask||(this.pickMask=new Uint8Array(this.primitivePickIds.length));let s,n=!1;for(s=0;s<this.primitivePickIds.length;++s){if(0!==this.pickMask[s])continue;const r=this.primitivePickIds[s],a=this.occurrencePickIds[s];if(!(0,Si.rp)(r)||a===Jf.Qy)this.pickMask[s]=1;else for(let o=0;o<e.length;++o){const h=e[o];if((0,Si.nD)(r,h.primitiveId)&&a===h.pickedOccurrenceId){h.canPickThrough(t,this.viewer,i)?n=!0:this.pickMask[s]=1;break}}}return!n}}class Re extends ve{constructor(e){super(e,null),this.childPasses=[],this.sceneGraph=null;for(let e=0;e<xi.DO.COUNT;++e)this.childPasses.push(new G(this.viewer,this,{visibility:o.SHOWTHROUGH,usePickAlternates:!0,disableDepthTest:!0,priority:e}))}getMaxHighResPickViewportSamples(){return Oe.getNumber("MAX_INFERENCE_PICKING_RECT_SAMPLES")}setSceneGraph(e){this.sceneGraph=e}getSceneGraph(){return this.sceneGraph}setPerformIsolationTest(e){}}var we;!function(e){e[e.RENDERING=0]="RENDERING",e[e.HUD=1]="HUD",e[e.ISOLATION=2]="ISOLATION",e[e.PICKING=3]="PICKING"}(we||(we={}));class _e extends f{constructor(e,t,i,n,r){super(e,t),this.opaqueFaces=null,this.stencilWritingOpaqueFaces=null,this.opaqueFacesZebraStripes=null,this.draftAnalysisFaces=null,this.qualityVisualization=null,this.opaqueEdges=null,this.silhouettes=null,this.opaquePoints=null,this.nonOitTransparentFaces=null,this.transparentPass=null,this.transparentEdges=null,this.depthFaces=null,this.depthTransparentFaces=null,this.depthEdges=null,this.showThroughStencilTested=null,this.showThroughNotStencilTested=null,this.showThroughDepthTested=null,this.sectionPlaneEndcapEdge=null,this.sectionPlaneEndcapMask=null,this.sectionPlaneEndcap=null,this.sketchImageFaces=null,this.isolatePass=null,this.contextPass=null,this.compareTransparentFaces=null,this.compareTintedEdges=null,this.compareTintedPoints=null;const l=t.isPickPass(),u=new ie(e,t,{performIsolationTest:!r}),d=new ie(e,t,{performIsolationTest:!r,shaderTagSuffix:"-nosection"}),g=new DC(e,u,d,LS.eQ);g.setSceneGraph(i),this.opaqueFaces=g;const p=X.default.getManager();this.stencilWritingOpaqueFaces=new ie(e,t,{stencilMode:c.WRITE,performIsolationTest:!r});const m=new ie(e,t,{facesShader:h.ZEBRA_STRIPES,sceneGraph:i,performIsolationTest:!r,extraShaderUniforms:[{name:"uStripeCount",value:p.getNumber("ZEBRA_STRIPE_COUNT")},{name:"uStripeRotation",value:p.getNumber("ZEBRA_STRIPE_ROTATION")},{name:"uFilterWidth",value:p.getNumber("ZEBRA_STRIPE_FILTER_WIDTH")},{name:"uRespectOrthographic",value:p.getNumber("ZEBRA_STRIPE_RESPECT_ORTHOGRAPHIC")}]});this.opaqueFacesZebraStripes=m;const I=new Mt(e,t,!r,i);this.draftAnalysisFaces=I,this.qualityVisualization=new ne(e,t,!r,i);const E=new K(e,t,{primitiveType:s.EDGES,performIsolationTest:!r,sceneGraph:i});this.opaqueEdges=E,l||(this.silhouettes=new bt(e,t,i));const S=new ie(e,t,{primitiveType:s.POINTS,performIsolationTest:!r});S.setSceneGraph(i),this.opaquePoints=S;const T=new ie(e,t,{primitiveType:s.FACES,opacity:a.TRANSPARENT,performIsolationTest:!r}),D=new ie(e,t,{primitiveType:s.FACES,opacity:a.TRANSPARENT,performIsolationTest:!r,shaderTagSuffix:$m}),M=new DC(e,T,D,LS.eQ);if(M.setSceneGraph(i),this.nonOitTransparentFaces=M,e.supportsOrderIndependentTranslucency()){const s=new Fe(e,t,i);s.setPerformIsolationTest(!r),M.performIsolationTest=!r,this.transparentPass=new MC(e,s,M,Fs.Z)}else this.transparentPass=M;const C=new ie(e,t,{primitiveType:s.EDGES,opacity:a.TRANSPARENT,stencilMode:c.OFF,clipToSectionPlanes:!1,performIsolationTest:!r});C.setSceneGraph(i),this.transparentEdges=C;const y=new ie(e,t,{primitiveType:s.FACES,disableColorWrites:!0});y.setSceneGraph(i),this.depthFaces=y,this.depthTransparentFaces=new Lt(e,t,i,!r);const P=new ie(e,t,{primitiveType:s.EDGES,disableColorWrites:!0});P.setSceneGraph(i),this.depthEdges=P;const O=new f(e,t);for(let s=0;s<xi.DO.COUNT;++s){const n=new G(e,t,{visibility:o.SHOWTHROUGH,disableDepthTest:!0,stencilMode:c.TEST,priority:s,sceneGraph:i,usePickAlternates:l,performIsolationTest:!r});O.addChildPass(n)}this.showThroughStencilTested=O;const v=new f(e,t);for(let s=0;s<=xi.DO.HIGHEST;++s){const n=new G(e,t,{disableDepthTest:!0,visibility:o.SHOWTHROUGH,priority:s,sceneGraph:i,usePickAlternates:l});v.addChildPass(n)}this.showThroughNotStencilTested=v;const R=new f(e,t);for(let s=0;s<=xi.DO.HIGHEST;++s){const n=new G(e,t,{visibility:o.SHOWTHROUGH,priority:s,sceneGraph:i,usePickAlternates:l});R.addChildPass(n)}this.showThroughDepthTested=R;const w=new Le(e,i),N=new _(e,w);this.sectionPlaneEndcapEdge=N,this.sectionPlaneEndcapMask=w,this.sectionPlaneEndcap=new A(e,t,w,N);const b=new ie(e,t,{primitiveType:s.FACES,opacity:a.TRANSPARENT,disableDepthTest:!0,sceneGraph:i,performIsolationTest:!r});this.sketchImageFaces=b,n===we.RENDERING&&(this.isolatePass=new nt(e,t,!1,i),this.contextPass=new nt(e,t,!0,i))}setBlendFilter(e){this.opaqueFaces.setBlendFilter(e),this.opaqueFacesZebraStripes.setBlendFilter(e),this.draftAnalysisFaces.setBlendFilter(e),this.qualityVisualization.setBlendFilter(e),this.sketchImageFaces.setBlendFilter(e),this.opaqueEdges.setBlendFilter(e),this.silhouettes.setBlendFilter(e),this.depthTransparentFaces.setBlendFilter(e),this.transparentPass.setBlendFilter(e),this.transparentEdges.setBlendFilter(e),this.opaquePoints.setBlendFilter(e),this.isolatePass&&this.isolatePass.setBlendFilter(e),this.contextPass&&this.contextPass.setBlendFilter(e),this.showThroughStencilTested.setBlendFilter(e),this.showThroughNotStencilTested.setBlendFilter(e),this.showThroughDepthTested.setBlendFilter(e),this.depthFaces.setBlendFilter(e),this.depthEdges.setBlendFilter(e)}setHideSelectionInterior(e){this.opaqueFaces.setHideSelectionInterior(e),this.transparentPass.setHideSelectionInterior(e),this.draftAnalysisFaces.setHideSelectionInterior(e),this.qualityVisualization.setHideSelectionInterior(e),this.isolatePass&&this.isolatePass.setHideSelectionInterior(e),this.contextPass&&this.contextPass.setHideSelectionInterior(e)}setRenderingMode(e){switch(this.isolatePass&&this.isolatePass.setRenderingMode(e),this.contextPass&&this.contextPass.setRenderingMode(e),e){case k.P1.SHADED_WITH_EDGES:case k.P1.SIMULATION_RESULTS:case k.P1.THICKNESS_ANALYSIS_VISUALIZATION:this.enableOpaqueFaces(!0,!0,h.OPAQUE),this.enableEdges(!0,!1,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!1),this.adjustTransparentFacePass(!1,null,a.OPAQUE,!0));break;case k.P1.SHADED_WITHOUT_EDGES:this.enableOpaqueFaces(!0,!0,h.OPAQUE),this.enableEdges(!1,!1,!1),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!1),this.adjustTransparentFacePass(!1,null,a.OPAQUE,!0));break;case k.P1.SHADED_WITH_HIDDEN_EDGES:this.enableOpaqueFaces(!0,!0,h.OPAQUE),this.enableEdges(!0,!0,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!1),this.adjustTransparentFacePass(!1,null,a.OPAQUE,!0));break;case k.P1.HIDDEN_LINE_REMOVED:this.enableOpaqueFaces(!0,!1,h.OPAQUE),this.enableEdges(!0,!1,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!0),this.adjustTransparentFacePass(!1,this.createExcludeForBodyFilter(),a.ALL,!0));break;case k.P1.HIDDEN_LINE_VISIBLE:this.enableOpaqueFaces(!0,!1,h.OPAQUE),this.enableEdges(!0,!0,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!0),this.adjustTransparentFacePass(!1,this.createExcludeForBodyFilter(),a.ALL,!0));break;case k.P1.WIREFRAME:this.enableOpaqueFaces(!1,!1,h.OPAQUE),this.enableEdges(!0,!1,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!1),this.adjustTransparentFacePass(!1,this.createExcludeForBodyFilter(),a.OPAQUE,!1));break;case k.P1.TRANSLUCENT:this.enableOpaqueFaces(!1,!0,h.OPAQUE),this.enableEdges(!0,!1,!1),this.enableFullOpacity(!1),this.adjustTransparentFacePass(!0,null,a.OPAQUE,!0);break;case k.P1.SHADED_CURVATURE_VISUALIZATION:this.enableOpaqueFaces(!0,!0,h.OPAQUE),this.enableEdges(!0,!1,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!1),this.adjustTransparentFacePass(!1,null,a.OPAQUE,!0));break;case k.P1.CURVATURE_VISUALIZATION:this.enableOpaqueFaces(!0,!0,h.ZEBRA_STRIPES),this.enableEdges(this.viewer.getZebraStripeEdgesOn(),!1,!0),this.enableFullOpacity(!0),this.viewer.supportsOrderIndependentTranslucency()&&this.adjustTransparentFacePass(!1,this.createExcludeForBodyFilter(),a.ALL,!0);break;case k.P1.DRAFT_ANALYSIS:this.enableOpaqueFaces(!0,!0,h.DRAFT),this.enableEdges(!0,!1,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!0),this.adjustTransparentFacePass(!1,this.createExcludeForBodyFilter(),a.ALL,!0));break;case k.P1.DEBUG_QUALITY_VISUALIZATION:this.enableOpaqueFaces(!0,!0,h.QUALITY_VISUALIZATION),this.enableEdges(!0,!1,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!0),this.adjustTransparentFacePass(!1,this.createExcludeForBodyFilter(),a.ALL,!0))}}enableEdges(e,t,i){this.opaqueEdges.setDrawVisibleParts(e),this.silhouettes.setEnabled(e),this.opaqueEdges.setDrawHidden(t),this.silhouettes.setDrawHidden(t),this.silhouettes.setDrawBackFaceSilhouettes(i)}enableOpaqueFaces(e,t,i){let s;switch(i){case h.OPAQUE:s=this.opaqueFaces;break;case h.DRAFT:s=this.draftAnalysisFaces;break;case h.QUALITY_VISUALIZATION:s=this.qualityVisualization;break;case h.ZEBRA_STRIPES:s=this.opaqueFacesZebraStripes}const n=this.getFacePasses();for(let i=0;i<n.length;++i){const r=n[i];r===s?(r.setEnabled(e),r.setEnableColorWrites(t)):r.setEnabled(!1)}}enableFullOpacity(e){let t,i,s;e?(t=a.ALL,i=this.createExcludeForNonBodyFilter(),s=this.createExcludeForNonBodyFilterNoDecals()):(t=a.OPAQUE,i=null,s=null);const n=this.getFacePasses();for(let e=0;e<n.length;++e)n[e].setOpacity(t),n[e]===this.opaqueFaces?n[e].setExtraMeshNodeFilter(i):n[e].setExtraMeshNodeFilter(s)}adjustTransparentFacePass(e,t,i,s){this.transparentPass.setExtraMeshNodeFilter(t),(this.transparentPass instanceof MC||this.transparentPass instanceof Fe)&&(this.transparentPass.appliesTranslucentAlphaToAll(e),this.transparentPass.setDepthOpacity(i),this.transparentPass.setDepthPassEnabled(s))}enableTransparentDepth(e){this.depthTransparentFaces.setEnabled(e),e?this.depthTransparentFaces.setNodeFilter(this.createExcludeForNonBodyFilter()):this.depthTransparentFaces.setNodeFilter(null)}getFacePasses(){return[this.opaqueFaces,this.opaqueFacesZebraStripes,this.draftAnalysisFaces,this.qualityVisualization]}setZebraStripeCount(e){this.opaqueFacesZebraStripes.setShaderUniform("uStripeCount",e),this.contextPass?.setZebraStripeCount(e),this.isolatePass?.setZebraStripeCount(e)}setZebraStripeRotation(e){this.opaqueFacesZebraStripes.setShaderUniform("uStripeRotation",e),this.contextPass?.setZebraStripeRotation(e),this.isolatePass?.setZebraStripeRotation(e)}}function Ne(e,t){return new b(e,t)}function be(e,t,i,s){const n=D(e,new H(e,t),i,s);return n.clearColor=x,n}class Le extends T{constructor(e,t){super(e),this.checkFrameId=!0,this.shaderTag="endcapMask",this.frameBuffer=null,this.childPasses=[],this.childPasses.push(new ct(this.viewer,this,t));const i=this.viewer.getIsolatedOccurrenceManager();this.fullyTransparentGhostedNodeOccurrenceFilter=e=>{if(e.occurrenceData.getIsolated())return!0;return this.viewer.getModelViewManagers().getManager().isOccurrenceIdForInContext(e.occurrenceData.getOccurrenceId())?!(0===i?.getContextTransparencyMultiplier()):!(i?.isInIsolateOrMakeTransparentMode()&&i?.getIsIsolateFullyTransparent())}}shouldCheckSectionPlaneCount(){return!0}forSectionPlaneEndcapMask(){return!0}preDraw(e){if(!this.frameBuffer){const e=this.viewer.getGlContext();this.frameBuffer=this.viewer.getOrCreateFrameBuffer(this.viewer.getHighPrecisionFloatTextureType(),void 0,{storageType:e.DEPTH_STENCIL,attachmentType:e.DEPTH_STENCIL_ATTACHMENT})}if(this.shouldCheckSectionPlaneCount()&&0===(0,LS.ti)())return!1;if(!super.preDraw(e))return!1;const t=this.viewer.getGlContext();t.disable(t.DEPTH_TEST),t.blendFunc(t.ONE,t.ONE),t.enable(t.BLEND),e.setOverrideFaceCullingMode(uh.NONE);const i=this.viewer.getIsolatedOccurrenceManager();return(i?.isInIsolateOrMakeTransparentMode()&&i?.getIsIsolateFullyTransparent()||(0,Ce.Eo)()&&0===i?.getContextTransparencyMultiplier())&&e.setNodeOccurrenceFilterFunction(this.fullyTransparentGhostedNodeOccurrenceFilter),!0}postDraw(e){super.postDraw(e);const t=this.viewer.getGlContext();t.enable(t.DEPTH_TEST),t.disable(t.BLEND),e.clearOverrideFaceCullingMode(),e.setNodeOccurrenceFilterFunction(null)}}class Fe extends f{setEdgesEnabled(e){this.accumulationPass.colorPass.setEdgeAndSilhouettesEnabled(e),this.revealagePass.colorPass.setEdgeAndSilhouettesEnabled(e)}constructor(e,t,i,a){super(e,t),this.childPasses=[],this.applyTranslucentAlphaToAll=!1,this.blendFilter=n.ALL,this.sceneGraph=i;const o=new ie(this.viewer,t,{primitiveType:s.FACES,disableColorWrites:!0,performIsolationTest:!0}),h=new ie(this.viewer,t,{primitiveType:s.FACES,disableColorWrites:!0,performIsolationTest:!0,shaderTagSuffix:$m}),c=new DC(e,o,h,LS.eQ);c.setCheckFrameId(!0),this.accumulationPass=new ze(this.viewer,r.ACCUMULATION,c),this.revealagePass=new ze(this.viewer,r.REVEALAGE,c),this.compositePass=new xe(this.viewer,this.accumulationPass,this.revealagePass,i,a),this.setSceneGraph(i),this.childPasses.push(this.compositePass)}appliesTranslucentAlphaToAll(e){this.applyTranslucentAlphaToAll=e,this.accumulationPass.appliesTranslucentAlphaToAll(e),this.revealagePass.appliesTranslucentAlphaToAll(e)}setSceneGraph(e){this.sceneGraph=e,this.accumulationPass.setSceneGraph(e),this.revealagePass.setSceneGraph(e),this.compositePass.setSceneGraph(e)}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}setBlendFilter(e){this.blendFilter=e,this.accumulationPass.setBlendFilter(e),this.revealagePass.setBlendFilter(e)}setDepthPassEnabled(e){this.accumulationPass.setDepthPassEnabled(e),this.revealagePass.setDepthPassEnabled(e)}setDepthOpacity(e){this.accumulationPass.setDepthOpacity(e),this.revealagePass.setDepthOpacity(e)}setExtraMeshNodeFilter(e){this.accumulationPass.setExtraMeshNodeFilter(e),this.revealagePass.setExtraMeshNodeFilter(e),this.extraMeshNodeFilter=e}setTintColor(e){this.accumulationPass.setTintColor(e)}setTintFactor(e){this.accumulationPass.setTintFactor(e)}setHideSelectionInterior(e){this.accumulationPass.setHideSelectionInterior(e)}setPerformIsolationTest(e){this.accumulationPass.setPerformIsolationTest(e),this.revealagePass.setPerformIsolationTest(e)}}class xe extends I{constructor(e,t,i,s,n){super(e),this.shaderTag="OITComposite",this.inputs.uAccumulationBuffer=t,this.inputs.uRevealageBuffer=i,this.sceneGraph=s;const r=this.viewer.getGlContext(),a={id:"transparency",storageType:r.DEPTH_COMPONENT16,attachmentType:r.DEPTH_ATTACHMENT};n=n||"";const o=this.viewer.getOrCreateFrameBuffer(this.viewer.getDefaultFloatTextureType(),n+"TranslucentBufferAccumulation",a),h=this.viewer.getOrCreateFrameBuffer(r.UNSIGNED_BYTE,n+"TranslucentBufferRevealage",a);this.inputs.uAccumulationBuffer.setFrameBuffer(o),this.inputs.uRevealageBuffer.setFrameBuffer(h)}setSceneGraph(e){this.sceneGraph=e}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}}const Be=X.default.getManager(),Ve=a,Ue=s,Ge=function(e,t,i,s,n,r){const a=new Fe(e,t,i,r);return a.setTintColor(s),a.setTintFactor(n),a};class He extends W{constructor(e,t){super(e,t),this.overBlendColorNeedsUpdate=!0;const i=this.viewer.getSceneGraphs().getPreviewSceneGraph(),s=Be.getColor("COMPARE_BASE_TINT").slice(0,3),r=Be.getColor("COMPARE_TARGET_TINT").slice(0,3),a=Be.getColor("COMPARE_SAME_LIT_TINT").slice(0,3),o=Be.getColor("COMPARE_SAME_UNLIT_TINT").slice(0,3);this.underDepthPass=be(this.viewer,null,1),this.existsInBothDepthPass=be(this.viewer,this.underDepthPass,1),this.underPlaneIdPass=D(this.viewer,new It(this.viewer,this,null),1),this.existsInBothPlaneIdPass=D(this.viewer,new It(this.viewer,this,this.underPlaneIdPass),1),this.baseDefaultPasses.opaqueFaces=new Me(this.viewer,this,{},s,a,this.existsInBothDepthPass),this.compareDefaultPasses.opaqueFaces=new Me(this.viewer,this,{sceneGraph:i},r,a,this.existsInBothDepthPass),this.viewer.supportsOrderIndependentTranslucency()&&(this.baseDefaultPasses.transparentPass=Ge(this.viewer,this,null,s,1,"CompareBase"),this.compareDefaultPasses.transparentPass=Ge(this.viewer,this,i,r,1,"CompareTarget")),this.baseDefaultPasses.opaqueEdges.setExtraMeshNodeFilter((function(e){return!e.getIsTintedByCompare()})),this.compareDefaultPasses.opaqueEdges.setExtraMeshNodeFilter((function(e){return!e.getIsTintedByCompare()})),this.baseDefaultPasses.opaquePoints.setExtraMeshNodeFilter((function(e){return!e.getIsTintedByCompare()})),this.compareDefaultPasses.opaquePoints.setExtraMeshNodeFilter((function(e){return!e.getIsTintedByCompare()})),this.baseDefaultPasses.compareTransparentFaces=new Me(this.viewer,this,{opacity:Ve.TRANSPARENT},s,o,this.existsInBothPlaneIdPass),this.compareDefaultPasses.compareTransparentFaces=new Me(this.viewer,this,{sceneGraph:i,opacity:Ve.TRANSPARENT},r,o,this.existsInBothPlaneIdPass),this.baseDefaultPasses.compareTintedEdges=new Me(this.viewer,this,{primitiveType:Ue.EDGES},s,o,this.existsInBothDepthPass),this.baseDefaultPasses.compareTintedPoints=new Me(this.viewer,this,{primitiveType:Ue.POINTS},s,o,this.existsInBothDepthPass),this.compareDefaultPasses.compareTintedEdges=new Me(this.viewer,this,{sceneGraph:i,primitiveType:Ue.EDGES},r,o,this.existsInBothDepthPass),this.compareDefaultPasses.compareTintedPoints=new Me(this.viewer,this,{sceneGraph:i,primitiveType:Ue.POINTS},r,o,this.existsInBothDepthPass);const h=function(e,t,i,s){const r=[];let a;for(r.push(i.opaqueFaces),r.push(i.opaqueFacesZebraStripes),r.push(i.draftAnalysisFaces),r.push(i.qualityVisualization),r.push(i.transparentPass),r.push(i.sketchImageFaces),r.push(i.compareTransparentFaces),r.push(i.opaqueEdges),r.push(i.silhouettes),r.push(i.compareTintedEdges),r.push(new re(e,t,!1,s)),r.push(i.opaquePoints),r.push(i.compareTintedPoints),r.push(new oe(e,s,!0)),r.push(new V(e,t)),a=0;a<=xi.DO.DEFAULT;++a)r.push(i.showThroughNotStencilTested.getChildPass(a)),r.push(i.showThroughDepthTested.getChildPass(a));for(r.push(new oe(e,s,!1)),a=xi.DO.HIGHER;a<=xi.DO.HIGHEST;++a)r.push(i.showThroughNotStencilTested.getChildPass(a)),r.push(i.showThroughDepthTested.getChildPass(a));return i.showThroughNotStencilTested.setBlendFilter(n.BLEND_ONLY),i.showThroughDepthTested.setBlendFilter(n.BLEND_ONLY),r};this.underBasePass=new f(this.viewer,this),this.underBasePass.childPasses=h(this.viewer,this.underBasePass,this.baseDefaultPasses,fs.L.BASE),this.underComparePass=new f(this.viewer,this),this.underComparePass.childPasses=h(this.viewer,this.underComparePass,this.compareDefaultPasses,fs.L.PREVIEW),this.overBufferPass=new T(this.viewer),this.overBufferPass.clearColor=[1,1,1,1],this.overBufferPass.childPasses=[];for(let e=0;e<this.underBasePass.childPasses.length;++e)this.overBufferPass.childPasses.push(this.underBasePass.childPasses[e]),this.overBufferPass.childPasses.push(this.underComparePass.childPasses[e]);this.compareBlendPass=new Xe(this.viewer,this.overBufferPass),this.previewBlendChangedSubscription=ys().stateChangedObservable.pipe((0,ye.h)((e=>e===ps.PREVIEW_BLEND_CHANGE))).subscribe((()=>this.onStateChange())),this.listenTo(this.viewer.getEventDispatcher(),yD.so,this.onSessionEnded),this.setBlendFilters()}onSessionEnded(){this.previewBlendChangedSubscription.unsubscribe(),super.onSessionEnded()}onStateChange(){this.enabled&&(0,Fs.vm)()}drawInputs(e){let t;if(As()<.5){for(t=0;t<this.underDepthPass.childPasses.length;++t)this.underDepthPass.childPasses[t].setSceneGraph(this.viewer.getSceneGraphs().getMainSceneGraph()),this.existsInBothDepthPass.childPasses[t].setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph());this.underPlaneIdPass.childPasses[0].setSceneGraph(this.viewer.getSceneGraphs().getMainSceneGraph()),this.existsInBothPlaneIdPass.childPasses[0].setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.childPasses=[this.underBasePass,this.compareBlendPass]}else{for(t=0;t<this.underDepthPass.childPasses.length;++t)this.underDepthPass.childPasses[t].setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.existsInBothDepthPass.childPasses[t].setSceneGraph(this.viewer.getSceneGraphs().getMainSceneGraph());this.underPlaneIdPass.childPasses[0].setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.existsInBothPlaneIdPass.childPasses[0].setSceneGraph(this.viewer.getSceneGraphs().getMainSceneGraph()),this.childPasses=[this.underComparePass,this.compareBlendPass]}f.prototype.drawInputs.call(this,e)}setZebraStripeCount(e){this.baseDefaultPasses.setZebraStripeCount(e),this.compareDefaultPasses.setZebraStripeCount(e)}setZebraStripeRotation(e){this.baseDefaultPasses.setZebraStripeRotation(e),this.compareDefaultPasses.setZebraStripeRotation(e)}preDraw(e){if(this.overBlendColorNeedsUpdate){const e=this.viewer.$el.css("background-color");this.overBufferPass.clearColor=X.default.getManager().parseColor(e),this.overBlendColorNeedsUpdate=!1}return super.preDraw(e)}}class ke extends ie{constructor(e,t,i){super(e,t,i),this.enabled=!1,this.shaderTag="alternates-"+this.shaderTag}usesShader(){return!0}preDraw(e){return this.initializeShader(),e.setPickPrimitiveAlternates(!0),super.preDraw(e)}postDraw(e){return e.setPickPrimitiveAlternates(!1),super.postDraw(e)}}class We extends Ae{constructor(e){super(e,null),this.shaderTag="depth",this.points=[],this.includePlanes=!0,this.childPasses=[],this.previewPasses=[],this.clearColor=Fs.XD;for(let e=0;e<this.childPasses.length;++e)this.childPasses[e].destroy();this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.FACES,opacity:a.TRANSPARENT,performIsolationTest:!0}));const t=function(e){return e.getParent().getId()===Op},i=new ie(this.viewer,this,{primitiveType:s.EDGES,performIsolationTest:!0,extraShaderUniforms:[{name:"uUsePrimitiveSize",value:1}]});i.setExtraMeshNodeFilter(t),this.childPasses.push(i);const n=new ie(this.viewer,this,{primitiveType:s.POINTS,performIsolationTest:!0,extraShaderUniforms:[{name:"uUsePrimitiveSize",value:1}]});n.setExtraMeshNodeFilter(t),this.childPasses.push(n);const r=new ie(this.viewer,this,{performIsolationTest:!0});r.setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.childPasses.push(r),this.previewPasses.push(r);const o=new ie(this.viewer,this,{opacity:a.TRANSPARENT,performIsolationTest:!0});o.setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.childPasses.push(o),this.previewPasses.push(o)}setRetrieveFromPreview(e){for(let t=0;t<this.previewPasses.length;++t)this.previewPasses[t].setEnabled(e)}nodeFilter(e){if(e.isMeshNode()){if(!e.getIncludedInBlend())return!1;if(CM(e))return this.includePlanes}return!0}draw(e){throw"Use DepthRetrievalPass retrieve method instead"}retrieve(e,t){this.includePlanes=t,super.draw(e)}postDraw(e){const t=this.pickRect[2]*this.pickRect[3]*4,i=new Uint8Array(t),s=this.viewer.getGlContext();s.readPixels(0,0,this.pickRect[2],this.pickRect[3],s.RGBA,s.UNSIGNED_BYTE,i),this.points=[];for(let e=0;e<t/4;e++){const t=4*e,s=(0,Fs.Rg)([i[t],i[t+1],i[t+2],i[t+3]],this.viewer.isHighPrecisionSupportedInFragmentShader());this.points.push([this.pickRect[0]+e%this.pickRect[2],this.pickRect[1]+(this.pickRect[3]-Math.floor(e/this.pickRect[2])),s])}T.prototype.postDraw.call(this,e),super.postDraw(e)}}class ze extends T{constructor(e,t,i){super(e,{makeFrameBuffer:!1}),this.component=t,this.depthPass=i,this.sceneGraph=null,this.clearColor=[0,0,0,0],this.colorPass=new L(this.viewer,t),this.childPasses=[this.depthPass,this.colorPass],this.component!==r.ACCUMULATION&&(this.clearColor=[1,1,1,1])}clearBuffer(e){const t=this.viewer.getGlContext();t.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]),e&&e.getFrameId()===this.depthPass.getLastRenderedFrame()?t.clear(t.COLOR_BUFFER_BIT):t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}appliesTranslucentAlphaToAll(e){this.colorPass.appliesTranslucentAlphaToAll(e)}setSceneGraph(e){this.colorPass.setSceneGraph(e),this.depthPass.setSceneGraph(e)}setBlendFilter(e){this.colorPass.setBlendFilter(e)}setDepthPassEnabled(e){this.depthPass.setEnabled(e)}setDepthOpacity(e){e===a.ALL?this.depthPass.setExtraMeshNodeFilter(this.createExcludeForNonBodyFilter()):this.depthPass.setExtraMeshNodeFilter(null),this.depthPass.setOpacity(e)}setExtraMeshNodeFilter(e){this.colorPass.setExtraMeshNodeFilter(e)}setTintColor(e){this.colorPass.setTintColor(e)}setTintFactor(e){this.colorPass.setTintFactor(e)}setHideSelectionInterior(e){this.colorPass.setHideSelectionInterior(e)}setPerformIsolationTest(e){this.colorPass.performIsolationTest=e}}class Xe extends I{constructor(e,t){super(e),this.shaderTag="compareBlend",this.inputs.uOverBufferPass=t}justBeforeDraw(e){super.justBeforeDraw(e),this.shader.uniform1f("uBlend",At())}}class Ze extends W{constructor(e,t){super(e,t);const i=[0,0,0,0];this.baseBufferPass=new T(this.viewer),this.compareBufferPass=new T(this.viewer),this.baseBufferPass.clearColor=i,this.compareBufferPass.clearColor=i;const s=new Set;s.add(dn.o2.FILTERED_ENTITIES);const n=(e,t,i)=>{const n=[this.nonEditedFaceDepthPass,this.nonEditedEdgeDepthPass,t.opaqueFaces,t.opaqueFacesZebraStripes,t.draftAnalysisFaces,t.qualityVisualization,t.stencilWritingOpaqueFaces,t.transparentPass,t.depthTransparentFaces,t.sketchImageFaces,t.sectionPlaneEndcap,t.opaqueEdges,t.silhouettes,t.transparentEdges,t.opaquePoints,t.isolatePass];t.contextPass&&n.push(t.contextPass),n.push(new re(e,null,!1,i,s)),n.push(new oe(e,i,!0,s)),n.push(new V(e,this));for(let e=0;e<xi.DO.COUNT;++e)n.push(t.showThroughStencilTested.getChildPass(e)),n.push(t.showThroughNotStencilTested.getChildPass(e)),n.push(t.showThroughDepthTested.getChildPass(e));return n.push(new oe(e,i,!1,s)),n};this.baseBufferPass.childPasses=n(this.viewer,this.baseDefaultPasses,fs.L.BASE),this.compareBufferPass.childPasses=n(this.viewer,this.compareDefaultPasses,fs.L.PREVIEW),this.previewBlendPass=new le(this.viewer,this.baseBufferPass,this.compareBufferPass),this.setBlendFilters(),this.viewer.getSupportsPreview()&&(this.previewStateChangeSubscription=ys().stateChangedObservable.subscribe((()=>this.onStateChange()))),this.listenTo(this.viewer.getEventDispatcher(),yD.so,this.onSessionEnded),this.onStateChange()}onSessionEnded(){this.previewStateChangeSubscription?.unsubscribe(),super.onSessionEnded()}onStateChange(){if(this.childPasses=[],!Rs()&&!ws())if(bs())this.pushOpaqueDepthPassWithAlpha(),this.childPasses.push(this.previewBlendPass);else for(let e=0;e<this.compareBufferPass.childPasses.length;++e){const t=this.compareBufferPass.childPasses[e];t!==this.nonEditedFaceDepthPass&&t!==this.nonEditedEdgeDepthPass&&this.childPasses.push(t)}this.viewer.requestDraw()}setDraftAnalysisPullDirection(e){this.baseDefaultPasses.draftAnalysisFaces.setPullDirection(e),this.compareDefaultPasses.draftAnalysisFaces.setPullDirection(e)}setDraftAnalysisMinimumAngle(e){this.baseDefaultPasses.draftAnalysisFaces.setMinimumAngle(e),this.compareDefaultPasses.draftAnalysisFaces.setMinimumAngle(e)}setDraftAnalysisParts(e){this.baseDefaultPasses.draftAnalysisFaces.setParts(e),this.compareDefaultPasses.draftAnalysisFaces.setParts(e)}setDraftAnalysisShowUndercut(e){this.baseDefaultPasses.draftAnalysisFaces.setShowUndercut(e),this.compareDefaultPasses.draftAnalysisFaces.setShowUndercut(e)}setZebraStripeCount(e){this.baseDefaultPasses.setZebraStripeCount(e),this.compareDefaultPasses.setZebraStripeCount(e)}setZebraStripeRotation(e){this.baseDefaultPasses.setZebraStripeRotation(e),this.compareDefaultPasses.setZebraStripeRotation(e)}}let qe=0;function Ye(e){qe=e}function Ke(){return qe}const je=X.default.getManager(),Qe="uIsolateContextOpacity",$e=je.getNumber("ISOLATE_CONTEXT_FACE_TRANSPARENCY"),Je=je.getNumber("ISOLATE_CONTEXT_EDGE_TRANSPARENCY");class et extends _e{constructor(e,t,i,n){super(e,t,i,n,!1);const r=function(e){(0,at.Pq)(e.viewer.getGlContext(),u.FACES),ie.prototype.postDraw.apply(this,[e])};this.depthFaces.postDraw=r,this.depthFaces.opacity=a.ALL,this.depthEdges.forDepth=!0,this.depthEdges.postDraw=function(e){(0,at.Pq)(e.viewer.getGlContext(),u.EDGES),ie.prototype.postDraw.apply(this,[e])},this.depthEdges.opacity=a.ALL,this.sectionPlaneEndcap.childPasses.forEach((e=>{e.forDepthTesting=!0,e.shaderTag="endcap-depth"})),this.opaqueFaces=new ie(this.viewer,this,{primitiveType:s.FACES,opacity:a.ALL,depthTestMode:g.LEQUAL,performIsolationTest:!0,stencilMode:c.WRITE_AND_TEST_ISOLATE_CONTEXT,sceneGraph:i}),this.opaqueFaces.postDraw=r,this.decalPass=new ie(this.viewer,this,{primitiveType:s.FACES,opacity:a.ALL,depthTestMode:g.LEQUAL,performIsolationTest:!0,sceneGraph:i}),this.decalPass.setExtraMeshNodeFilter(this.createOnlyDecalsFilter()),this.opaqueFacesZebraStripes=new ie(this.viewer,this,{facesShader:h.ZEBRA_STRIPES,performIsolationTest:!0,opacity:a.ALL,depthTestMode:g.LEQUAL,extraShaderUniforms:[{name:"uStripeCount",value:je.getNumber("ZEBRA_STRIPE_COUNT")},{name:"uStripeRotation",value:je.getNumber("ZEBRA_STRIPE_ROTATION")},{name:"uFilterWidth",value:je.getNumber("ZEBRA_STRIPE_FILTER_WIDTH")},{name:"uRespectOrthographic",value:je.getNumber("ZEBRA_STRIPE_RESPECT_ORTHOGRAPHIC")}]});const o=function(e){const t=this.viewer.getGlContext();t.disable(t.BLEND),ie.prototype.justBeforeDraw.apply(this,[e])};this.opaqueFaces.justBeforeDraw=o,this.opaqueFacesZebraStripes.justBeforeDraw=o,this.sketchImageFaces.justAfterDraw=o}setFilters(){const e=this.getNodeOccurrenceFilter();if(e){this.depthFaces.setNodeOccurrenceFilterFunction(e),this.opaqueFaces.setNodeOccurrenceFilterFunction(e),this.decalPass.setNodeOccurrenceFilterFunction(e),this.opaqueFacesZebraStripes.setNodeOccurrenceFilterFunction(e),this.sketchImageFaces.setNodeOccurrenceFilterFunction(e),this.opaqueEdges.setNodeOccurrenceFilterFunction(e),this.transparentEdges.setNodeOccurrenceFilterFunction(e),this.opaquePoints.setNodeOccurrenceFilterFunction(e);for(let t=xi.DO.LOWER;t<=xi.DO.HIGHEST;++t)this.showThroughStencilTested.getChildPass(t).setNodeOccurrenceFilterFunction(e)}this.depthEdges.setNodeOccurrenceFilterFunction((e=>e.occurrenceData.getIsolated()));this.depthFaces.setExtraMeshNodeFilter(this.createExcludeForNonBodyFilterNoDecals(!0))}preDraw(e){if(0===this.getTransparencyMultiplier())return!1;const t=this.getTransparencyMultiplier(),i=t*$e*qe+(1-qe),s=Math.min(1,3*i);let n=t*Je*qe+(1-qe);n=Math.sqrt(n),this.opaqueFaces.setShaderUniform(Qe,i),this.decalPass.setShaderUniform(Qe,i),this.opaqueFacesZebraStripes.setShaderUniform(Qe,i),this.sketchImageFaces.setShaderUniform(Qe,s),this.opaqueEdges.setShaderUniform(Qe,n),this.transparentEdges.setShaderUniform(Qe,n),this.opaquePoints.setShaderUniform(Qe,n);for(let e=xi.DO.LOWER;e<=xi.DO.HIGHEST;++e)this.showThroughStencilTested.getChildPass(e).setShaderUniform(Qe,i);return super.preDraw(e)}setRenderingMode(e){super.setRenderingMode(e),this.opaqueFaces.setOpacity(a.ALL),this.depthFaces.setOpacity(a.ALL),this.depthEdges.setOpacity(a.ALL);this.opaqueFaces.setExtraMeshNodeFilter(this.createExcludeForNonBodyFilterNoDecals(!0));const t=e!==k.P1.HIDDEN_LINE_REMOVED&&e!==k.P1.HIDDEN_LINE_VISIBLE;this.decalPass.setEnabled(t)}setZebraStripeCount(e){this.opaqueFacesZebraStripes.setShaderUniform("uStripeCount",e)}setZebraStripeRotation(e){this.opaqueFacesZebraStripes.setShaderUniform("uStripeRotation",e)}}class tt extends et{constructor(e,t,i,s){super(e,t,i,s),this.setFilters()}getNodeOccurrenceFilter(){const e=this.viewer.getModelViewManagers().getManager();return t=>{const i=t.occurrenceData.getOccurrenceId();return!e.isOccurrenceIdForInContext(i)}}getTransparencyMultiplier(){return this.viewer.getIsolatedOccurrenceManager()?.getIsIsolateFullyTransparent()?0:1}preDraw(e){const t=this.viewer.getModelViewManagers().getManager().getSimulationManager();return!!(this.viewer.getIsolatedOccurrenceManager()?.isInIsolateOrMakeTransparentMode()||t&&t.isIsolateEffectActive()||null!==this.viewer.getInterferenceCallId()&&""!==this.viewer.getInterferenceCallId())&&super.preDraw(e)}}class it extends et{constructor(e,t,i,s,n){super(e,t,i,s),this.filterForInContext=n,this.setFilters()}getNodeOccurrenceFilter(){const e=this.viewer.getModelViewManagers().getManager();if(this.filterForInContext){return t=>{if(!e.isDisplayingIncontextAssembly())return!1;const i=t.occurrenceData.getOccurrenceId();return e.isOccurrenceIdForInContext(i)}}return t=>{const i=this.viewer.getIsolatedOccurrenceManager();if(!i?.isInIsolateOrMakeTransparentMode())return!0;const s=t.occurrenceData;return e.isOccurrenceIdForInContext(s.getOccurrenceId())||s.getIsolated()}}getTransparencyMultiplier(){return this.viewer.getIsolatedOccurrenceManager()?.getContextTransparencyMultiplier()}preDraw(e){return!!(0,Ce.Eo)()&&super.preDraw(e)}}class st extends f{constructor(e,t,i,s){if(super(e,t),this.ghostedChildrenPasses=[],s=s||this.viewer.getSceneGraphs().getMainSceneGraph(),i){this.ghostedChildrenPasses.push(new it(this.viewer,this,s,we.ISOLATION,!1));if(s.isForPreview()){const e=this.viewer.getSceneGraphs().getMainSceneGraph();this.ghostedChildrenPasses.push(new it(this.viewer,this,e,we.ISOLATION,!0))}}else this.ghostedChildrenPasses.push(new tt(this.viewer,this,s,we.ISOLATION));this.childPasses=[],this.ghostedChildrenPasses.forEach((e=>{this.childPasses.push(e.depthFaces)})),this.ghostedChildrenPasses.forEach((e=>{this.childPasses.push(e.sectionPlaneEndcap)})),this.ghostedChildrenPasses.forEach((e=>{this.childPasses.push(e.depthEdges)})),this.ghostedChildrenPasses.forEach((e=>{this.addModelPasses(e)})),this.childPasses.push(new V(this.viewer,this)),this.ghostedChildrenPasses.forEach((e=>{this.addShowThroughPasses(e)})),this.setRenderingMode(k.P1.SHADED_WITH_EDGES)}addModelPasses(e){this.childPasses.push(e.opaqueFaces),this.childPasses.push(e.decalPass),this.childPasses.push(e.opaqueFacesZebraStripes),this.childPasses.push(e.sketchImageFaces),this.childPasses.push(e.opaqueEdges),this.childPasses.push(e.transparentEdges),this.childPasses.push(e.opaquePoints)}addShowThroughPasses(e){for(let t=xi.DO.LOWER;t<=xi.DO.HIGHEST;++t)this.childPasses.push(e.showThroughStencilTested.getChildPass(t))}forIsolate(){return!1}preDraw(e){return!!this.ghostedChildrenPasses.reduce(((t,i)=>i.preDraw(e)||t),!1)&&super.preDraw(e)}setRenderingMode(e){e!==k.P1.TRANSLUCENT&&e!==k.P1.DRAFT_ANALYSIS||(e=k.P1.SHADED_WITH_EDGES),this.ghostedChildrenPasses.forEach((t=>{t.setRenderingMode(e)}))}setHideSelectionInterior(e){this.ghostedChildrenPasses.forEach((t=>{t.setHideSelectionInterior(e)}))}setZebraStripeCount(e){this.ghostedChildrenPasses.forEach((t=>t.setZebraStripeCount(e)))}setZebraStripeRotation(e){this.ghostedChildrenPasses.forEach((t=>t.setZebraStripeRotation(e)))}}class nt extends f{constructor(e,t,i,s){super(e,t),this.isolateContextPass=new st(e,this,i,s);this.childBuffer=D(this.viewer,this.isolateContextPass,1,"highlightBuffer"),this.childBuffer.clearColor=[1,1,1,0];const n=new E(this.viewer,this.childBuffer,{performDrawInputs:!0});this.childPasses=[n]}preDraw(e){return!!this.isolateContextPass.preDraw(e)&&super.preDraw(e)}setRenderingMode(e){this.isolateContextPass.setRenderingMode(e)}setHideSelectionInterior(e){this.isolateContextPass.setHideSelectionInterior(e)}setZebraStripeCount(e){this.isolateContextPass.setZebraStripeCount(e)}setZebraStripeRotation(e){this.isolateContextPass.setZebraStripeRotation(e)}}class rt extends I{constructor(e){super(e),this.shaderTag="debugPickPass",this.pickPass=null}setPickPass(e){this.pickPass=e,this.inputs.uPickBuffer=e}drawInputs(e){}preDraw(e){if(!this.pickPass)return!1;const t=this.pickPass.getPickViewportWidthHeight();let i=10;return t[0]>50&&(i=3),t[0]>200&&(i=1),e.pushViewport([0,0,t[0]*i,t[1]*i]),super.preDraw(e)}postDraw(e){super.postDraw(e),e.popViewport()}}var at=i(29396),ot=i(35295);class ht extends Ae{constructor(e){super(e,null),this.shaderTag="draftAngle",this.clearColor=[0,0,0,0],this.nodeOccurrenceFilterFunction=null,this.direction=null,this.points=[],this.childPasses=[],this.previewPasses=[],this.nodeFilterFunction=this.createExcludeForNonBodyFilter();for(let e=0;e<this.childPasses.length;++e)this.childPasses[e].destroy();const t=[{name:"uPullDirection",value:C.fromValues(0,0,0)}];this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0,extraShaderUniforms:t})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.FACES,opacity:a.TRANSPARENT,performIsolationTest:!0,extraShaderUniforms:t}));const i=new ie(this.viewer,this,{performIsolationTest:!0,extraShaderUniforms:t});i.setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.childPasses.push(i),this.previewPasses.push(i);const n=new ie(this.viewer,this,{opacity:a.TRANSPARENT,performIsolationTest:!0,extraShaderUniforms:t});n.setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.childPasses.push(n),this.previewPasses.push(n)}nodeFilter(e){return this.nodeFilterFunction(e)}setDirection(e){this.direction=e}setOccurrenceIds(e){const t={},i=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();if(!i)return;const s=i.getBodyComponent();for(const i in e){const e=s.retrieveBodyMetaData(i);if(!e)continue;if(!e.isSolidBody()&&!e.isSheetBody())continue;const n=s.partStudioBodyIdToOccurrenceId[i];n&&(t[n]=!0)}this.nodeOccurrenceFilterFunction=e=>t[e.occurrenceData.getOccurrenceId()]}preDraw(e){return!!this.direction&&super.preDraw(e)}justBeforeDraw(e){super.justBeforeDraw(e);const t=e=>{e.setShaderUniform("uPullDirection",this.direction)};(0,ot.Z)(this.childPasses,t),this.previewPasses.forEach(t)}draw(e){throw"Use DraftAngleRetrievalPass retrieve method instead"}retrieve(e){e.setNodeOccurrenceFilterFunction(this.nodeOccurrenceFilterFunction),super.draw(e),e.setNodeOccurrenceFilterFunction(null)}postDraw(e){const t=this.pickRect[2]*this.pickRect[3]*4,i=new Uint8Array(t),s=this.viewer.getGlContext();s.readPixels(0,0,this.pickRect[2],this.pickRect[3],s.RGBA,s.UNSIGNED_BYTE,i),this.points=[];for(let e=0;e<t/4;e++){const t=4*e,s=(0,Fs.Pm)([i[t],i[t+1],i[t+2],i[t+3]],this.viewer.isHighPrecisionSupportedInFragmentShader());this.points.push({canvasCoordinate:[this.pickRect[0]+e%this.pickRect[2],this.pickRect[1]+(this.pickRect[3]-Math.floor(e/this.pickRect[2]))],angle:s})}super.postDraw(e)}}class ct extends f{constructor(e,t,i){super(e,t),this.shaderTag="faces",this.sceneGraph=i}usesShader(){return!0}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}preDraw(e){this.initializeShader(),e.activateShader(this.shader);const t=this;return e.nodeFilter=function(e){return t.nodeFilter(e)},!0}onShaderActivated(e,t){(0,LS.qS)(this.viewer,!0)}postDraw(e){}nodeFilter(e){return!(!(e.isMeshNode()&&e.getIsVisible()&&e.isFaces()&&!pp(e)&&e.getClippedBySectionPlanes())||wd(e))&&this.parentPass.nodeFilter(e)}needsFaceAppearances(){return!1}}var lt=i(37952),ut=i(72751),dt=i(1630),gt=i(39572);class pt extends ct{constructor(e,t){super(e,t,null)}preDraw(e){this.initializeShader(),e.activateShader(this.shader),this.shader.uniform1f("uSectionPlaneCount",0);const t=this;return e.nodeFilter=function(e){return t.nodeFilter(e)},!0}}class mt extends Le{constructor(e,t){super(e,null),this.reportedWarning=!1,this.reportedOnCracks=!1,this.childPasses=[],this.visualizedRays=[],this.forFullScreenVisualization=!!t,this.checkFrameId=!this.forFullScreenVisualization,this.camera=new oh,this.camera.setViewport([0,0,mt.TEST_VIEWPORT_WIDTH,mt.TEST_VIEWPORT_HEIGHT]),this.camera.setCanvasDimensions(mt.TEST_VIEWPORT_WIDTH,mt.TEST_VIEWPORT_HEIGHT),this.camera.setFrame(Zn.Isometric);const i=!(0,dt.isBrowserSafari)();this.resultBuffer=i?new Float32Array(mt.TEST_VIEWPORT_HEIGHT*mt.TEST_VIEWPORT_HEIGHT*4):new Uint8Array(mt.TEST_VIEWPORT_HEIGHT*mt.TEST_VIEWPORT_HEIGHT*4),this.childPasses.push(new pt(this.viewer,this)),this.clearColor=this.forFullScreenVisualization?[0,0,0,0]:[0,0,0,1]}shouldCheckSectionPlaneCount(){return!1}preDraw(e){if(this.reportedWarning)return!1;if(!this.forFullScreenVisualization){const e=this.viewer.getModelViewManagers().getManager().getModelBounds();if(!(e&&e.isInitialized()&&e.isFinite()&&e.isExtensive()))return!1;this.camera.setSceneBounds(e),this.camera.zoomToFit(e.getCorners()),this.camera.updateNearFar(),this.viewer.pushCameraState(this.camera)}const t=Le.prototype.preDraw.apply(this,[e]);return t||this.forFullScreenVisualization||this.viewer.popCameraState(),t}postDraw(e){this.forFullScreenVisualization||(this.viewer.popCameraState(),this.checkBuffer()),Le.prototype.postDraw.apply(this,[e])}checkBuffer(){if(this.viewer.areOptimizedBuffersEnabled)return;const e=this.viewer.getGlContext();this.resultBuffer instanceof Float32Array?e.readPixels(0,0,mt.TEST_VIEWPORT_WIDTH,mt.TEST_VIEWPORT_HEIGHT,e.RGBA,e.FLOAT,this.resultBuffer):e.readPixels(0,0,mt.TEST_VIEWPORT_WIDTH,mt.TEST_VIEWPORT_HEIGHT,e.RGBA,e.UNSIGNED_BYTE,this.resultBuffer);const t=mt.TEST_VIEWPORT_HEIGHT*mt.TEST_VIEWPORT_HEIGHT;let i=0,s=0;for(let e=0;e<t;++e)this.checkPixel(s)||++i,s+=4;if(i>=4){const e=i/t*100,s="bad pixel count: "+i+", total pixel count: "+t+", percentage of bad pixels: "+e.toFixed(1)+"%, last element and microversion interval processed: "+this.viewer.getModelViewManagers().getManager().getDescriptionOfLastProcessedPartStudio();if(e>=3){const e=lt.T.getOpenDocumentModel().get("public");ut.log.warn("Encountered body/bodies with significant display errors. "+s+"\nisPublic: "+e),this.findBadEntities(),this.reportedWarning=!0}else this.reportedOnCracks||(ut.log.info("Encountered body/bodies with display errors.  The body may have cracks in it. "+s),this.reportedOnCracks=!0)}this.reportedWarning||window.localStorage.removeItem(this.getEntityCheckKey())}checkPixel(e){for(let t=0;t<3;++t)if(Math.abs(this.resultBuffer[e+t])>=.001)return!1;return!0}getEntityCheckKey(){let e="loggedBadEntities.";const t=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();return t&&(e+=t.id),e}findBadEntities(){const e=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();if(!e)return;if(window.localStorage.getItem(this.getEntityCheckKey()))return;const t=e.bodyComponent;let i=0;const s=[],n=C.create(),r=function(e,t){return s.length=0,t&&t.isTriangles()&&(0,yi.Lr)(e,t.getBounds(),n)?(t.iteratePrimitives((function(t,i,n){if(!i||!n)return;const r=(0,yi.AF)(e,t,i,n);void 0!==r&&s.push(r)})),s):s},a=(0,Fs.Wj)(),o=new gt.StringSet;for(let e=0;e<mt.TEST_VIEWPORT_HEIGHT;++e)for(let s=0;s<mt.TEST_VIEWPORT_WIDTH;++s){if(!this.checkPixel(i)){const i=this.camera.getRay(s,mt.TEST_VIEWPORT_HEIGHT-e);for(const e in t.bodyMetaData){const s=t.bodyMetaData[e];if(!s.isSolidBody()||s.meshState===k.W6T.ALL_MESH)continue;const a=t.bodyToEntity.get(e);if(!a)continue;if(!(0,yi.Lr)(i,s.getBounds(),n))continue;const h={};a.each((function(e,s){const n=t.idToMetaData[s];if(!n)return;const a=r(i,n.getMeshIncrement());for(let e=0;e<a.length;++e){const t=(0,Au.PF)(a[e]);let i=h[t];i||(h[t]=i=new gt.StringSet),i.add(s)}return!1}),this);for(const e in h){const t=h[e];t.size()>1&&o.addAll(t.getKeyArray())}}}i+=4}const h=(0,Fs.Es)(a);if(h>400&&window.localStorage.setItem(this.getEntityCheckKey(),"true"),o.size()>0){let e="Found overlapping entities ("+h.toFixed(0)+" ms):\n";o.each((function(i){const s=(0,Ce.cF)(i),n=t.idToMetaData[i];let r=null;s&&(r=(0,Ce.fM)(s)),e+="  entityId: "+i+", bodyId: "+n.getBodyId()+", featureIds: ["+n.getFeatureIds()+"]",e+=r?", featureName: "+r.getName()+", featureType: "+r.getFeatureType()+"\n":" (parent feature not found)\n"}),this),ut.log.warn(e)}}toggleRayVisualization(){if(this.visualizedRays.length>0){for(let e=0;e<this.visualizedRays.length;++e)this.visualizedRays[e].remove();this.visualizedRays=[]}else{let e=0;for(let t=0;t<mt.TEST_VIEWPORT_HEIGHT;++t)for(let i=0;i<mt.TEST_VIEWPORT_WIDTH;++i){if(!this.checkPixel(e)){const e=this.camera.getRay(i,mt.TEST_VIEWPORT_HEIGHT-t);this.visualizedRays.push(new hf(this.viewer,e))}e+=4}}}}mt.TEST_VIEWPORT_WIDTH=100,mt.TEST_VIEWPORT_HEIGHT=100;class ft extends I{constructor(e,t,i,s){super(e),this.highlightType=t,this.disableDuringPreview=s,this.shaderTag="highlightDraw",this.interiorHighlightOpacity=.5,this.inputs.uHighlightBuffer=new yt(this.viewer,t);const n=new Pt(this.viewer,t,i),r=n.opaqueFacePass.nodeFilter;n.opaqueFacePass.setNodeFilter((e=>{this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()&&e.hasNonIsolatedOccurrences()&&this.viewer.getModelViewManagers().getManager().isNodeForModel(e)&&n.opaqueFacePass.setOpacity(a.ALL);const t=r.call(n.opaqueFacePass,e);return n.opaqueFacePass.setOpacity(a.OPAQUE),t})),n.opaqueFacePass.setNodeOccurrenceFilterFunction((e=>!(!this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()||e.occurrenceData.getIsolated())||!e.parentHasTransparency())),this.inputs.uHighlightMask=n,this.scenegraph=this.viewer.getSceneGraphs().getMainSceneGraph()}setMaskOpaqueFaces(e){this.inputs.uHighlightMask.opaqueFacePass.setEnabled(e)}setSceneGraph(e){this.scenegraph=e,this.inputs.uHighlightBuffer.setSceneGraph(e),this.inputs.uHighlightMask.setSceneGraph(e)}getSceneGraph(){return this.scenegraph}getEnabled(){return this.enabled&&(!this.disableDuringPreview||!Ns())}setInteriorHighlightOpacity(e){this.interiorHighlightOpacity=e}justBeforeDraw(e){super.justBeforeDraw(e);const t=this.viewer.getReferenceHighlights().highlights[this.highlightType];this.shader.uniform4fv("uHighlightColor1",t.color1),this.shader.uniform4fv("uHighlightColorBorder",t.colorBorder),this.shader.uniform1f("uInteriorHighlightOpacity",this.interiorHighlightOpacity),this.shader.uniform1i("uHideSelectionInterior",this.hideSelectionInterior?1:0),this.shader.uniform1i("uOutlineOverlappingInteriorRegions",t.outlineOverlappingInteriorRegions?1:0)}postDraw(e){super.postDraw(e)}}class It extends ie{constructor(e,t,i){super(e,t,{opacity:a.TRANSPARENT,blendMode:d.ADD}),this.setExtraMeshNodeFilter((function(e){return e.getIsTintedByCompare()})),i&&(this.inputs.uPlaneIdSetBuffer=i)}getShaderId(){return"-planeId-"+this.shaderTag}justBeforeDraw(e){super.justBeforeDraw(e);const t=e.getActiveShader();t.uniform1i("uDoSetTest",this.inputs.uPlaneIdSetBuffer?1:0),this.inputs.uPlaneIdSetBuffer?t.useTexture("uPlaneIdSetBuffer",this.inputs.uPlaneIdSetBuffer.getColorTexture()):t.useBlankTexture("uPlaneIdSetBuffer")}}const Et=y.fromValues(0,0,2048,2048),St=de.create();class Tt extends ie{constructor(e,t,i,n){super(e,t,{primitiveType:s.FACES,opacity:a.ALL}),this.parentPass=t,this.withDirection=i,this.setSceneGraph(n)}preDraw(e){if(this.setExtraMeshNodeFilter(this.createExcludeForNonBodyFilter()),super.preDraw(e)){e.setOverrideFaceCullingMode(uh.NONE),e.setOverridePolygonOffset(0,0);const t=this.parentPass.draftAnalysisDrawPass;return e.pushModelViewMatrix(this.withDirection?t.viewMatrixWithDirection:t.viewMatrixAgainstDirection),e.pushProjectionMatrix(this.withDirection?t.projectionMatrixWithDirection:t.projectionMatrixAgainstDirection),(0,LS.qS)(this.viewer,!0,!0),this.viewer.getGlContext().colorMask(this.withDirection,!this.withDirection,!1,!1),!0}return!1}postDraw(e){e.popModelViewMatrix(),e.popProjectionMatrix(),(0,LS.qS)(this.viewer,!0,!0),e.clearOverrideFaceCullingMode(),e.clearOverridePolygonOffset(),super.postDraw(e)}}class Dt extends T{constructor(e,t,i){super(e,{id:"draftAnalysisShadowTest"}),this.shaderTag="draftShadow",this.checkFrameId=!1,this.clearColor=[255,255,255,255],this.draftAnalysisDrawPass=t,this.childPasses=[new Tt(e,this,!0,i),new V(e,this),new Tt(e,this,!1,i)]}initializeFrameBuffer(e){this.textureType=e.FLOAT,super.initializeFrameBuffer(e)}preDraw(e){return e.pushViewport(Et),!!super.preDraw(e)||(e.popViewport(),!1)}postDraw(e){e.popViewport(),super.postDraw(e)}}class Mt extends ie{constructor(e,t,i,s){super(e,t,{facesShader:h.DRAFT,performIsolationTest:i}),this.pullDirection=null,this.showUndercut=!0,this.idToParts={},this.doDraftAnalysis=!0,this.setSceneGraph(s),this.angle=k.zG4.DEFAULT_MINIMUM_ANGLE_RADIANS,this.viewMatrixWithDirection=this.projectionMatrixWithDirection=this.viewMatrixAgainstDirection=this.projectionMatrixAgainstDirection=St,this.inputs.uDraftShadowMap=new Dt(e,this,s),this.usage=s===this.viewer.getSceneGraphs().getMainSceneGraph()?fs.L.BASE:fs.L.PREVIEW}setPullDirection(e){this.pullDirection=e}setMinimumAngle(e){this.angle=e}setParts(e){e?(this.idsToParts={},e.forEach((e=>{Object.values(e.getDeterministicIds()).forEach((t=>{this.idsToParts[t]=e}),this)}),this)):ut.log.error("Tried to set the draft analysis parts array to null.")}setShowUndercut(e){this.showUndercut=e}getIdsToParts(){return this.idsToParts}justBeforeDraw(e){let t;if(super.justBeforeDraw(e),this.shader.uniform1i("uDoDraftAnalysis",this.doDraftAnalysis&&this.pullDirection?1:0),this.pullDirection){const i=ge.w$.multiplyVec4(e.getActiveCamera().getViewMatrix(),y.fromValues(this.pullDirection[0],this.pullDirection[1],this.pullDirection[2],0));t=ge.S4.normalize(C.clone(i))}else t=C.create();this.shader.uniform3fv("uDraftAnalysisDirection",t),this.shader.uniform1f("uMinimumDraftAngle",this.angle);const i=X.default.getManager();this.shader.uniform4fv("uSteepDraftColor",i.getColor("DRAFT_ANALYSIS_STEEP_COLOR")),this.shader.uniform4fv("uUndercutColor",i.getColor("DRAFT_ANALYSIS_UNDERCUT_COLOR")),this.shader.uniform4fv("uWithDirectionColor",i.getColor("DRAFT_ANALYSIS_WITH_DIRECTION_COLOR")),this.shader.uniform4fv("uAgainstDirectionColor",i.getColor("DRAFT_ANALYSIS_AGAINST_DIRECTION_COLOR")),this.shader.uniform1i("uShowUndercut",this.showUndercut?1:0),this.shader.uniformMatrix4fv("uPMVMatrixWith",!1,ge.w$.multiply(this.projectionMatrixWithDirection,this.viewMatrixWithDirection,de.create())),this.shader.uniformMatrix4fv("uPMVMatrixAgainst",!1,ge.w$.multiply(this.projectionMatrixAgainstDirection,this.viewMatrixAgainstDirection,de.create())),this.shader.uniform1f("uDraftShadowMapPixelWidth",1/Et[2]),this.shader.uniform1f("uDraftShadowMapPixelHeight",1/Et[3]),this.shader.useTexture("uDraftShadowMap",this.inputs.uDraftShadowMap.getColorTexture())}createCamera(e,t,i){const s=new oh({direction:e,up:t});s.setViewport(y.clone(Et));const n=i.getBounds();return s.setSceneBounds(n),s.zoomToFit(n.getCorners(),1,y.fromValues(1,1,Et[2]-2,Et[3]-2)),s}addToAnalyseIfApplicable(e,t,i,s){s||(s=t.retrieveBodyMetaData(e)),s&&(s.containsOnlySolidBodies()||s.containsOnlySheetBodies())&&i.set(e,s)}draw(e){if(!this.getEnabled())return;const t=this.viewer.getModelViewManagers().getManagerForUsage(this.usage).getDisplayedPartStudio();if(!t)return;let i=0,s=function(e){return e.occurrenceData.getOccurrenceId()===i};e.setNodeOccurrenceFilterFunction(s);const n=t.getBodyComponent(),r={};this.doDraftAnalysis=!0;for(const t in this.idsToParts){const s=n.retrieveBodyMetaData(t),a=new Map;if(s&&s.isOpenCompositeBody)for(const e of s.constituentBodyIds)this.addToAnalyseIfApplicable(e,n,a);else this.addToAnalyseIfApplicable(t,n,a,s);for(const[t,s]of a.entries())if(i=n.partStudioBodyIdToOccurrenceId[t],i){if(r[i]=!0,this.pullDirection){const e=ge.S4.normalize(ge.S4.getAPerpendicularVector(this.pullDirection),C.create());let t=this.createCamera(C.clone(this.pullDirection),e,s);this.viewMatrixWithDirection=t.getViewMatrix(),this.projectionMatrixWithDirection=t.getProjectionMatrix(),t=this.createCamera(ge.S4.scale(this.pullDirection,-1,C.create()),e,s),this.viewMatrixAgainstDirection=t.getViewMatrix(),this.projectionMatrixAgainstDirection=ge.w$.scale(t.getProjectionMatrix(),[-1,1,1])}else this.viewMatrixWithDirection=this.projectionMatrixWithDirection=this.viewMatrixAgainstDirection=this.projectionMatrixAgainstDirection=St;super.drawInputs(e),super.draw(e)}}s=function(e){return!r[e.occurrenceData.getOccurrenceId()]},e.setNodeOccurrenceFilterFunction(s),this.doDraftAnalysis=!1,super.draw(e),e.setNodeOccurrenceFilterFunction(null),this.postDraw(e)}postDraw(e){this.viewMatrixWithDirection=this.projectionMatrixWithDirection=this.viewMatrixAgainstDirection=this.projectionMatrixAgainstDirection=St}}class Ct extends f{constructor(e){super(e,null),this.shaderTag="draw",this.ssaoBufferPass=null,this.inferenceDisplayPasses=[],this.clearColor=[0,0,0,0],this.forceHideInteriorSelections=!1;const t=X.default.getManager();this.defaultPasses=new _e(this.viewer,this,this.viewer.getSceneGraphs().getMainSceneGraph(),we.RENDERING),this.childPasses=[],this.childPasses.push(this.defaultPasses.opaqueFaces),this.childPasses.push(this.defaultPasses.opaqueFacesZebraStripes),this.childPasses.push(this.defaultPasses.draftAnalysisFaces),this.childPasses.push(this.defaultPasses.qualityVisualization),this.childPasses.push(this.defaultPasses.stencilWritingOpaqueFaces),t.getNumber("AMBIENT_OCCLUSION_EFFECT_FACTOR")>0&&(0,Fs.pc)(e.getGlContext())&&(this.ssaoBufferPass=Se(this.viewer),this.defaultPasses.opaqueFaces.setInput("uOcclusionMap",this.ssaoBufferPass)),this.partPreviewPass=new Ze(this.viewer,this),this.childPasses.push(this.partPreviewPass),this.partComparePass=new He(this.viewer,this),this.childPasses.push(this.partComparePass),this.childPasses.push(this.defaultPasses.transparentPass);const i=new ie(e,this,{primitiveType:s.FACES,stencilMode:c.WRITE,disableColorWrites:!0,opacity:a.TRANSPARENT});this.childPasses.push(i),this.defaultPasses.depthTransparentFaces.setEnabled(!1),this.childPasses.push(this.defaultPasses.depthTransparentFaces),this.childPasses.push(this.defaultPasses.sketchImageFaces),this.childPasses.push(this.defaultPasses.sectionPlaneEndcap),this.childPasses.push(this.defaultPasses.opaqueEdges),this.childPasses.push(this.defaultPasses.silhouettes);const n=new ie(this.viewer,this,{primitiveType:s.EDGES,stencilMode:c.OFF});this.childPasses.push(n),this.childPasses.push(this.defaultPasses.transparentEdges);const r=new oe(this.viewer,fs.L.BASE,!0);this.childPasses.push(r),this.childPasses.push(this.defaultPasses.isolatePass),this.defaultPasses.contextPass&&this.childPasses.push(this.defaultPasses.contextPass),this.childPasses.push(this.defaultPasses.opaquePoints);const h=new re(this.viewer,this,!1),l=new re(this.viewer,this,!0);this.faceHighlightDrawPass=new TC(this.viewer,h,l,LS.eQ),this.childPasses.push(this.faceHighlightDrawPass),this.childPasses.push(new V(this.viewer,this));for(let e=xi.DO.LOWER;e<=xi.DO.DEFAULT;++e)this.childPasses.push(this.defaultPasses.showThroughStencilTested.getChildPass(e)),this.childPasses.push(this.defaultPasses.showThroughNotStencilTested.getChildPass(e)),this.childPasses.push(this.defaultPasses.showThroughDepthTested.getChildPass(e));this.linePointAllHighlightsDrawPass=new oe(this.viewer,fs.L.BASE,!1),this.childPasses.push(this.linePointAllHighlightsDrawPass);for(let e=xi.DO.HIGHER;e<=xi.DO.HIGHEST;++e)this.childPasses.push(this.defaultPasses.showThroughStencilTested.getChildPass(e)),this.childPasses.push(this.defaultPasses.showThroughNotStencilTested.getChildPass(e)),this.childPasses.push(this.defaultPasses.showThroughDepthTested.getChildPass(e));if(this.childPasses.push(new b(this.viewer,this)),this.visualizeBodyCheckPass=new E(this.viewer,this.viewer.bodyCheckPass,{viewport:[0,0,mt.TEST_VIEWPORT_WIDTH,mt.TEST_VIEWPORT_HEIGHT]}),this.visualizeBodyCheckPass.setEnabled(!1),this.childPasses.push(this.visualizeBodyCheckPass),this.visualizeFullScreenBodyCheckPass=new E(this.viewer,new mt(e,!0),{shaderTag:"blitBodyCheck",performDrawInputs:!0}),this.visualizeFullScreenBodyCheckPass.setEnabled(!1),this.childPasses.push(this.visualizeFullScreenBodyCheckPass),this.debugDrawPickPass=new rt(this.viewer),this.debugDrawPickPass.setEnabled(!1),this.childPasses.push(this.debugDrawPickPass),0!==t.getNumber("DISPLAY_INFERENCE_BUFFER")){const e=new ie(this.viewer,this,{primitiveType:s.EDGES,visibility:o.SHOWTHROUGH,priority:xi.DO.LOWER,disableDepthTest:!0});e.setEnabled(!1);const t=new ie(this.viewer,this,{primitiveType:s.POINTS,visibility:o.SHOWTHROUGH,priority:xi.DO.DEFAULT,disableDepthTest:!0});t.setEnabled(!1);const i=new ie(this.viewer,this,{primitiveType:s.POINTS,visibility:o.SHOWTHROUGH,priority:xi.DO.HIGHER,disableDepthTest:!0});i.setEnabled(!1),this.childPasses.push(e),this.childPasses.push(t),this.childPasses.push(i),this.inferenceDisplayPasses.push(e),this.inferenceDisplayPasses.push(t),this.inferenceDisplayPasses.push(i)}this.setRenderingMode(k.P1.SHADED_WITH_EDGES),this.previewStateChangeSubscription=ys().stateChangedObservable.pipe((0,ye.h)((e=>e===ps.PREVIEW_STATE_CHANGE))).subscribe((()=>this.onPreviewStateChange())),this.previewBlendChangeSubscription=ys().stateChangedObservable.pipe((0,ye.h)((e=>e===ps.PREVIEW_BLEND_CHANGE))).subscribe((()=>this.updateHideInteriorSelections())),this.onPreviewStateChange(),this.listenTo(this.viewer.getEventDispatcher(),yD.so,this.onSessionEnded)}onSessionEnded(){this.previewStateChangeSubscription.unsubscribe(),this.previewBlendChangeSubscription.unsubscribe(),super.onSessionEnded()}setClearColor(e,t,i,s){this.clearColor=[e,t,i,s]}getClearColor(){return this.clearColor.slice()}onPreviewStateChange(){this.partPreviewPass.setEnabled(Ns()),this.partComparePass.setEnabled(ws()),ws()?(this.faceHighlightDrawPass.setEnabled(!1),this.linePointAllHighlightsDrawPass.setEnabled(!1)):(this.faceHighlightDrawPass.setEnabled(!0),this.linePointAllHighlightsDrawPass.setEnabled(!0)),!Rs()&&this.viewer.getSupportsPreview()?(this.defaultPasses.setBlendFilter(n.NON_BLEND_ONLY),Ls()&&this.defaultPasses.transparentPass.setEnabled(!1),this.defaultPasses.sectionPlaneEndcap.setEnabled(!1),this.defaultPasses.isolatePass.setEnabled(!1),this.defaultPasses.contextPass&&this.defaultPasses.contextPass.setEnabled(!1)):(this.defaultPasses.setBlendFilter(n.ALL),this.defaultPasses.transparentPass.setEnabled(!0),this.defaultPasses.sectionPlaneEndcap.setEnabled(!0),this.defaultPasses.isolatePass.setEnabled(!0),this.defaultPasses.contextPass&&this.defaultPasses.contextPass.setEnabled(!0)),this.updateHideInteriorSelections(),this.viewer.requestDraw()}get sectionPlaneEndcapMaskPass(){return this.defaultPasses.sectionPlaneEndcapMask}get draftAnalysisPass(){return this.defaultPasses.draftAnalysisFaces}setForceHideInteriorSelections(e){this.forceHideInteriorSelections=e,this.updateHideInteriorSelections()}updateHideInteriorSelections(){const e=bs();let t=X.default.getManager().getNumber("DEFAULT_INTERIOR_HIGHLIGHT_OVERLAY_OPACITY");this.forceHideInteriorSelections?this.setHideSelectionInterior(!0):e?(this.defaultPasses.setHideSelectionInterior(!0),this.faceHighlightDrawPass.setHideSelectionInterior(!1),this.partPreviewPass.setHideSelectionInterior(!0),t=X.default.getManager().getNumber("PREVIEW_INTERIOR_HIGHLIGHT_OVERLAY_OPACITY")):this.setHideSelectionInterior(!1),this.faceHighlightDrawPass.pass1.setInteriorHighlightOpacity(t),this.faceHighlightDrawPass.pass2.setInteriorHighlightOpacity(t)}setHideSelectionInterior(e){this.defaultPasses.setHideSelectionInterior(e),this.faceHighlightDrawPass.setHideSelectionInterior(e),this.partPreviewPass.setHideSelectionInterior(e)}visualizeInferenceSceneGraph(e){for(let t=0;t<this.inferenceDisplayPasses.length;++t)this.inferenceDisplayPasses[t].setEnabled(!!e),this.inferenceDisplayPasses[t].setSceneGraph(e)}setRenderingMode(e){this.defaultPasses.setRenderingMode(e),this.partPreviewPass.setRenderingMode(e),this.partComparePass.setRenderingMode(e)}drawInputs(e){this.ssaoBufferPass&&this.ssaoBufferPass.setEnabled(e.getDetailSettings().enableSSAO),super.drawInputs(e)}preDraw(e){if(this.viewer.getXrController().getIsXrRunning())return!0;const t=this.viewer.getGlContext();return t.stencilMask(255),t.clearStencil(0),t.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[1],this.clearColor[2]),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT),!0}nodeFilter(e){return e.isMeshNode()||e.getIsVisible()}setDraftAnalysisPullDirection(e){this.defaultPasses.draftAnalysisFaces.setPullDirection(e),this.partPreviewPass.setDraftAnalysisPullDirection(e)}setDraftAnalysisMinimumAngle(e){this.defaultPasses.draftAnalysisFaces.setMinimumAngle(e),this.partPreviewPass.setDraftAnalysisMinimumAngle(e)}setDraftAnalysisParts(e){this.defaultPasses.draftAnalysisFaces.setParts(e),this.partPreviewPass.setDraftAnalysisParts(e)}setDraftAnalysisShowUndercut(e){this.defaultPasses.draftAnalysisFaces.setShowUndercut(e),this.partPreviewPass.setDraftAnalysisShowUndercut(e)}getDebugDrawPickPass(){return this.debugDrawPickPass}setZebraStripeCount(e){this.defaultPasses.setZebraStripeCount(e),this.partComparePass.setZebraStripeCount(e),this.partPreviewPass.setZebraStripeCount(e)}setZebraStripeRotation(e){this.defaultPasses.setZebraStripeRotation(e),this.partComparePass.setZebraStripeRotation(e),this.partPreviewPass.setZebraStripeRotation(e)}setTranslucentEdgesEnabled(e){this.defaultPasses.transparentPass instanceof MC&&this.defaultPasses.transparentPass.setEdgesEnabled(e)}getSectionEndcapMaskPassForPicking(e){return Ns()?e?this.partPreviewPass.getPreviewEndcapMaskPass():this.partPreviewPass.getBaseEndcapMaskPass():ws()?e?this.partComparePass.getPreviewEndcapMaskPass():this.partComparePass.getBaseEndcapMaskPass():this.sectionPlaneEndcapMaskPass}}class yt extends T{constructor(e,t){super(e,{id:"highlightBuffer"}),this.highlightType=t,this.shaderTag="highlightBuffer",this.childPasses=[],this.clearColor=[0,0,0,0],this.childPasses.push(new ie(this.viewer,this,{})),this.childPasses.push(new ie(this.viewer,this,{opacity:a.TRANSPARENT}));for(let e=0;e<xi.DO.COUNT;++e)this.childPasses.push(new ie(this.viewer,this,{visibility:o.SHOWTHROUGH,priority:e}))}justBeforeDraw(e){super.justBeforeDraw(e);const t=this.viewer.getGlContext();t.enable(t.BLEND),t.blendFuncSeparate(t.ONE,t.ONE,t.ONE,t.ONE),t.disable(t.DEPTH_TEST),e.getState().callGl("depthMask",!1);const i=e.getActiveShader(),s=this.viewer.getReferenceHighlights().highlights[this.highlightType];i.uniform1f("uActiveHighlightIndex",s.index)}isHighlightPass(){return!0}getActiveHighlightType(){return this.highlightType}needsAttribute(e){const t=e===tE.HIGHLIGHT_ID;return this.parentPass?t||this.parentPass.needsAttribute(e):t}setSceneGraph(e){this.scenegraph=e}getSceneGraph(){return this.scenegraph}}class Pt extends T{constructor(e,t,i){super(e,{id:"highlightMask"}),this.highlightType=t,this.shaderTag="highlightMask",this.childPasses=[],this.clearColor=[255,255,255,255],this.opaqueFacePass=new ie(this.viewer,this,{shaderTagSuffix:i?$m:""}),this.childPasses.push(this.opaqueFacePass)}justBeforeDraw(e){const t=e.getActiveShader(),i=this.viewer.getReferenceHighlights().highlights[this.highlightType];t.uniform1f("uActiveHighlightIndex",i.index)}setSceneGraph(e){for(let t=0;t<this.childPasses.length;t++)this.childPasses[t].setSceneGraph(e)}needsAttribute(e){const t=e===tE.HIGHLIGHT_ID;return this.parentPass?t||this.parentPass.needsAttribute(e):t}getActiveHighlightType(){return this.highlightType}}function At(){const e=ys().previewAlpha;return e<.5?2*e:2*(1-e)}class Ot extends Ae{constructor(e,t){super(e,null),this.managerNodeId=t,this.shaderTag="retrieveScalar",this.clearColor=[0,0,0,0],this.results=[];for(let e=0;e<this.childPasses.length;++e)this.childPasses[e].destroy();const i=new ie(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0,disableColorWrites:!0});i.setNodeFilter((e=>0===(e.getParent()?.getId()??"").indexOf(jg)&&e.getIsVisible()));this.setNodeFilterOverride((e=>{const t=e.getParent();return 0===(t?t.getId():"").indexOf(this.managerNodeId)&&t.getIsVisible()}));const n=new ie(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0});this.childPasses=[i,n]}draw(e){throw"Use retrieve method instead"}retrieve(e,t){return this.scalarRange=t,super.draw(e),this.results}postDraw(e){const t=this.pickRect[2]*this.pickRect[3]*4,i=new Uint8Array(t),s=this.viewer.getGlContext();s.readPixels(0,0,this.pickRect[2],this.pickRect[3],s.RGBA,s.UNSIGNED_BYTE,i),this.results=[];const n=this.viewer.isHighPrecisionSupportedInFragmentShader();for(let e=0;e<t/4;e++){const t=4*e,s=[i[t],i[t+1],i[t+2],i[t+3]];if(i[3]===this.clearColor[3])continue;const r=(0,Fs.NP)(s,n),a=this.scalarRange.scalarFromTextureCoordinate(r);this.results.push({canvasCoordinate:[this.pickRect[0]+e%this.pickRect[2],this.pickRect[1]+(this.pickRect[3]-Math.floor(e/this.pickRect[2]))],scalar:a})}super.postDraw(e)}}var vt=i(37541),Rt=i(78914);const wt=X.default.getManager();class _t extends f{constructor(e,t,i,s){super(e,t),this.noSection=s,this.isBackFacePassEnabled=!0,this.blendFilter=n.ALL,this.sceneGraph=i}usesShader(){return!0}getShaderId(){return"-backfacesil-faces"+(this.noSection?$m:"")}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}preDraw(e){if(this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances())return!1;this.initializeShader(),super.preDraw(e);const t=this.viewer.getGlContext();e.setOverrideFaceCullingMode(uh.FRONT),e.activateShader(this.shader);const i=this;return e.nodeFilter=function(e){return i.nodeFilter(e)},(0,LS.qS)(this.viewer,!0),this.shader.uniform1f("uLineWidth",wt.getNumber("DEFAULT_LINE_WIDTH")*wt.getNumber("BACKFACE_SILHOUETTE_WIDTH_FACTOR")),this.shader.uniform4fv("uLineColor",this.viewer.getResources().PART_SURFACE_LINE_POINT_MATERIAL.color),this.shader.uniform1f("uSceneDiameter",e.getActiveCamera().getSceneBounds().diameter()),(0,at.LL)(t,l.LOW_PRIORITY_EDGES,u.EDGES),!0}postDraw(e){super.postDraw(e);const t=this.viewer.getGlContext();e.clearOverrideFaceCullingMode(),t.disable(t.STENCIL_TEST)}nodeFilter(e){const t=this.viewer.getModelViewManagers().getManager(),i=e.getParent();if(this.blendFilter===n.BLEND_ONLY){if(!e.getIncludedInBlend())return!1}else if(this.blendFilter===n.NON_BLEND_ONLY&&e.getIncludedInBlend())return!1;return!e.hasTransparency()&&(!!(e.isFaces()&&i&&t.isNodeForBody(i))&&this.parentPass.nodeFilter(e))}setBlendFilter(e){this.blendFilter=e}}class Nt extends ie{constructor(e,t,i,n){super(e,t,{primitiveType:s.FACES,sceneGraph:i,disableColorWrites:!0,performIsolationTest:!0}),this.noSection=n}getShaderId(){return"-depth-faces"+(this.noSection?$m:"")}preDraw(e){if(!super.preDraw(e))return!1;const t=this.viewer.getGlContext();return e.setOverrideFaceCullingMode(uh.FRONT),e.getState().callGl("depthMask",!1),(0,at.U$)(t,l.LOW_PRIORITY_EDGES,u.EDGES),!0}postDraw(e){super.postDraw(e),e.clearOverrideFaceCullingMode()}}class bt extends f{constructor(e,t,i,n){super(e,t),this.isBackFacePassEnabled=!0,this.edgePass=new K(e,this,{primitiveType:s.SILHOUETTES,performIsolationTest:!0,sceneGraph:i,...n??{}});const r=new Nt(e,this,i,!1),a=new Nt(e,this,i,!0);this.backFaceStencilPass=new TC(e,r,a,LS.eQ);const o=new _t(e,this,i,!1),h=new _t(e,this,i,!0);this.backfacePass=new TC(e,o,h,LS.eQ),this.childPasses=[this.edgePass,this.backFaceStencilPass,this.backfacePass]}setDrawHidden(e){this.edgePass.setDrawHidden(e)}setSceneGraph(e){this.edgePass.setSceneGraph(e)}setExtraMeshNodeFilter(e){this.edgePass.setExtraMeshNodeFilter(e)}setDrawVisibleParts(e){this.edgePass.setDrawVisibleParts(e),this.backFaceStencilPass.setEnabled(e),this.backfacePass.setEnabled(e)}setBlendFilter(e){this.edgePass.setBlendFilter(e),this.backFaceStencilPass.setBlendFilter(e),this.backfacePass.setBlendFilter(e)}setDrawBackFaceSilhouettes(e){this.isBackFacePassEnabled=e}preDraw(e){if(!this.viewer.debugIsShowingSilhouetteEdgesOnNonVisibleTangentEdgeStyle()&&this.viewer.getSmoothEdgesRenderStyle()!==Rt.Y.VISIBLE&&this.viewer.getRenderingMode()!==vt.P.HIDDEN_LINE_VISIBLE&&this.viewer.getRenderingMode()!==vt.P.HIDDEN_LINE_REMOVED)return!1;super.preDraw(e);const t=e.getDetailSettings();this.edgePass.setEnabled(t.enableEdgeSilhouettes);const i=t.enableBackfaceSilhouettes&&this.isBackFacePassEnabled;return this.backFaceStencilPass.setEnabled(i),this.backfacePass.setEnabled(i),!0}appliesTranslucentAlphaToAll(e){this.edgePass.appliesTranslucentAlphaToAll(e)}}class Lt extends ie{constructor(e,t,i,n){super(e,t,{primitiveType:s.FACES,opacity:a.TRANSPARENT,disableColorWrites:!0,performIsolationTest:n}),this.setSceneGraph(i),this.setNodeFilter(this.createExcludeForNonBodyFilter())}getEnabled(){switch(this.viewer.getRenderingMode()){case k.P1.SHADED_WITH_HIDDEN_EDGES:return!0;case k.P1.SHADED_WITH_EDGES:case k.P1.SHADED_WITHOUT_EDGES:case k.P1.TRANSLUCENT:case k.P1.SIMULATION_RESULTS:return this.viewer.getFilteredEntitiesHighlightController()?.getSelectionList()?.length>0;default:return!1}}}var Ft;!function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.INT=5124]="INT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.FLOAT=5126]="FLOAT",e[e.HALF_FLOAT=36193]="HALF_FLOAT"}(Ft||(Ft={}));const xt=["NVIDIA","AMD","Intel","Apple","Adreno","Mali","Quadro","GeForce","llvmpipe","PowerVR","Vivante","VideoCore"];function Bt(e){switch(e){case Ft.BYTE:case Ft.UNSIGNED_BYTE:return 1;case Ft.SHORT:case Ft.UNSIGNED_SHORT:case Ft.HALF_FLOAT:return 2;case Ft.INT:case Ft.UNSIGNED_INT:case Ft.FLOAT:return 4;default:return ut.log.warn("Unrecognized GL type: 0x"+e.toString(16)),0}}function Vt(e,t){return t===k.xB1.ARRAY_BUFFER?e.ARRAY_BUFFER:t===k.xB1.ELEMENT_ARRAY_BUFFER?e.ELEMENT_ARRAY_BUFFER:null}var Ut,Gt;function Ht(e){switch(e){case Ut.STENCIL_INDEX:case Ut.STENCIL_INDEX8:return 1;case Ut.RGBA4:case Ut.RGB5_A1:case Ut.RGB565:case Ut.DEPTH_COMPONENT16:return 2;case Ut.DEPTH_STENCIL:return 4;default:return ut.log.warn("Unrecognized GL render buffer type: 0x"+e.toString(16)),0}}function kt(e){switch(e){case Gt.DEPTH_COMPONENT:case Gt.ALPHA:case Gt.LUMINANCE:return 1;case Gt.LUMINANCE_ALPHA:return 2;case Gt.RGB:return 3;case Gt.RGBA:return 4;default:return ut.log.warn("Unrecognized GL pixel format: 0x"+e.toString(16)),0}}function Wt(e){if(e){const t=["swiftshader"],i=e.toLowerCase();return t.some((e=>i.includes(e)))}return!1}function zt(){return{glVendor:"unavailable",glRenderer:"unavailable",isCpuRenderer:!1}}!function(e){e[e.RGBA4=32854]="RGBA4",e[e.RGB5_A1=32855]="RGB5_A1",e[e.RGB565=36194]="RGB565",e[e.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",e[e.STENCIL_INDEX=6401]="STENCIL_INDEX",e[e.STENCIL_INDEX8=36168]="STENCIL_INDEX8",e[e.DEPTH_STENCIL=34041]="DEPTH_STENCIL"}(Ut||(Ut={})),function(e){e[e.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",e[e.ALPHA=6406]="ALPHA",e[e.RGB=6407]="RGB",e[e.RGBA=6408]="RGBA",e[e.LUMINANCE=6409]="LUMINANCE",e[e.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"}(Gt||(Gt={}));const Xt=new Map;function Zt(e){let t=null;if(e)try{if(t=Xt.get(e),t)return t;const i=e.getExtension("WEBGL_debug_renderer_info");if(i){const s=e.getParameter(i.UNMASKED_RENDERER_WEBGL);t={glVendor:e.getParameter(i.UNMASKED_VENDOR_WEBGL),glRenderer:s,isCpuRenderer:Wt(s)},Xt.set(e,t)}else t={glVendor:"unavailable",glRenderer:"unavailable",isCpuRenderer:!1}}catch(e){ut.log.warn("Web client capability - failed inside getRendererInfo -- "+e)}return t}function qt(e){return Yt(Zt(e).glRenderer)}function Yt(e){return!!e&&e.toLowerCase().indexOf("intel")>=0}function Kt(e){if(!e)return!1;const t=e.toLowerCase();return!xt.some((e=>t.includes(e)))&&t.includes("unknown")}function jt(e){if(!e)return!1;const t=e.toLowerCase();return!(t.indexOf("intel")<0)&&(t.indexOf("arc")>=0||t.indexOf("dg1")>=0)}let Qt,$t=null,Jt=null,ei=null,ti=null;function ii(e){void 0===Qt?(Qt=e,Qt?($t=Uint32Array,Jt=Ft.UNSIGNED_INT):($t=Uint16Array,Jt=Ft.UNSIGNED_SHORT),ei=Bt(Jt),ti=Math.pow(2,8*ei)):Qt!==e&&ut.log.warn("initialize32BitIndexSupport called twice with two different values")}function si(){if(!$t)throw"Attempt to get indexBufferType before gl initialized";return $t}function ni(){if(!Jt)throw"Attempt to get indexElementType before gl initialized";return Jt}function ri(){if(!ei)throw"Attempt to get indexElementSize before gl initialized";return ei}function ai(){if(!ti)throw"Attempt to get maximumVerticesPerVbo before gl initialized "+(new Error).stack;return ti}var oi=i(66115);class hi{constructor(){this.gl=null,this.state={},this.stack=[]}setGlContext(e){this.gl=e,this.callGl("depthMask",!0),this.callGl("depthFunc",this.getGl().LEQUAL)}getGl(){return this.gl}capture(){this.stack.push(this.state),this.state=Object.create(this.state)}restore(){if(0===this.stack.length)return void ut.log.warn("Graphics state restore attempted without previous capture");const e=this.state,t=this.stack.pop();for(const i in e)if(e.hasOwnProperty(i)){const e=t[i];e&&this.callGl(i,e[0],e[1],e[2],e[3])}this.state=t}callGl(e,t,i,s,n){const r=this.state[e];if(r&&r[0]===t&&r[1]===i&&r[2]===s&&r[3]===n)return;const a=[t,i,s,n];this.gl[e].apply(this.gl,a),this.state[e]=a}getState(e){return this.state[e]}}var ci=i(85332),li=i(13469),ui=i(46066);class di{constructor(){this.selected=!1,this.preSelected=!1,this.edgePreSelected=!1,this.edgePointUiElement=null,this.selectedSheetmetalModelId=null}}const gi=function(e){return e===(0,Ce.Wf)()},pi=function(e,t){if(!(t.isEdge()&&!t.isClosedCurve()))return!1;const i=e.getSketch();if(!t.getSketchEntityId()||!i)return!0;const s=t.getFeatureIds();return 1!==s.length||i.id!==s[0]},mi=function(e){return e.isEdgePoint()},fi=function(e){if(!e.isVertex())return!1;const t=lt.T.getFeatureOrSubfeatureNode((0,Ce.hN)(e));return t?.getFeatureType()===ui.T.CONSTRUCTION_POINT&&t?.getName()===Ce.o$.EDGE_POINT},Ii=function(e){const t=ci._3.getActiveFeatureController();if(t){const i=t.featureModel;if(i&&(!e||!i.get("isSketch")))return i}return null};class Ei extends m.T{constructor(e){super(),this.viewer=e,this.edgePointUiElements={},this.purgeTimer=null,this.isEnabled=!1,(0,Jo.Yk)(e),this.edgePointCandidate=new zm.G9;const t=X.default.getManager();this.edgePointPixelSize=t.getNumber("POINT_BODY_SIZE")}enable(){this.viewer.getIsForPreviousVersionDisplay()||(this.isEnabled=!0,this.stopListening(),this.listenTo((0,Ce.vi)(),"add",this.onSelectionAdded),this.listenTo((0,Ce.vi)(),"remove",this.onSelectionRemoved),this.listenTo((0,Ce.vi)(),"reset",this.onSelectionReset),this.listenTo((0,Ce.Wf)(),"add",this.onSelectionAdded),this.listenTo((0,Ce.Wf)(),"remove",this.onSelectionRemoved),this.listenTo((0,Ce.Wf)(),"reset",this.onSelectionReset))}disable(){this.isEnabled&&(this.isEnabled=!1,this.stopListening(),this.removeAllEdgePointUiElements((0,Ce.vi)()),this.removeAllEdgePointUiElements((0,Ce.Wf)()))}addEdgePointUiElement(e,t,i){let s;s=t?e.getDeterministicId():e.getIdString();let n=this.edgePointUiElements[s];if(n||(n=new di),t?n.edgePreSelected=!0:i?n.preSelected=!0:n.selected=!0,t&&i){const t=hd.getEdgePointLocation(this.viewer,e,.5),i=this.viewer.getCamera().getPixelSizeAtWorldPoint(t)*this.edgePointPixelSize;if(!t||(0,Ce.vi)().models.find((e=>{if(fi(e)){const s=this.viewer.getModelViewManagers().getManager().extractMeshIncrement(e.getDeterministicId());if(s){const e=s.points;return ge.S4.length(ge.S4.subtract(t,e,C.create()))<i}}return!1}),this))return null}return n.edgePointUiElement||(n.edgePointUiElement=new hd(Zo.lL,e,.5,this.viewer)),this.edgePointUiElements[s]=n,n.edgePointUiElement}removeEdgePointUiElementWithDeterministicId(e,t){return!!this.edgePointUiElements.hasOwnProperty(e)&&(t?(this.edgePointUiElements[e].preSelected=!1,this.edgePointUiElements[e].edgePreSelected=!1):this.edgePointUiElements[e].selected=!1,!0)}purgeEdgePointUiElements(e){this.purgeTimer&&(clearTimeout(this.purgeTimer),this.purgeTimer=null);const t=[];Object.entries(this.edgePointUiElements).forEach((function([i,s]){!e&&(s.selected||s.preSelected||s.edgePreSelected)||(s.edgePointUiElement.remove(),t.push(i))})),this.edgePointUiElements=(0,j.omitProperty)(this.edgePointUiElements,t)}delayedPurgeUiElements(){if(this.purgeTimer)return;const e=this;this.purgeTimer=window.setTimeout((function(){e.purgeEdgePointUiElements()}),0)}removeEdgePointUiElement(e,t,i){let s=e.getDeterministicId();t||(s=e.getIdString()),this.removeEdgePointUiElementWithDeterministicId(s,i)}removeAllEdgePointUiElements(e){const t=gi(e);Object.entries(this.edgePointUiElements).forEach((([e,i])=>{this.removeEdgePointUiElementWithDeterministicId(e,t)}))}addSelection(e,t){if(e.isFromOccurrence()||e.isSectionEntity())return;const i=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();if(i&&"string"==typeof e.selectionId)if(e.entityMetaData&&e.entityMetaData.isFromSketch()){if(e.isFlattened()!==this.viewer.getIsForFlattenedDisplay())return!1}else{const t=i.getBodyComponent(null).idToMetaData[e.selectionId];if(!t&&this.viewer.getIsForFlattenedDisplay())return!1;if(t&&t instanceof k.Wzw&&t.getBodyMetaData().isForFlattenedView()!==this.viewer.getIsForFlattenedDisplay())return!1;if(t&&t instanceof k.Wzw&&this.selectedSheetmetalModelId&&t.getBodyMetaData().sheetMetalModelId!==this.selectedSheetmetalModelId)return!1}const s=gi(t),n=mi(e),r=pi(this.viewer,e);if(n)this.addEdgePointUiElement(e,!1,s);else if(r){if(s){const t=(0,Ce.Nd)();if(!t||t.filter(this.edgePointCandidate)){if("string"==typeof e.selectionId&&e.entityMetaData instanceof k.Wzw&&!i?.getBodyComponent().containsEntity(e.selectionId))return!1;if("string"==typeof e.selectionId&&e.entityMetaData instanceof k.S5B&&!i?.getSketchComponent().containsEntity(e.selectionId))return!1;this.addEdgePointUiElement(e,!0,s)}}}else if(fi(e)&&!s){const t=this.viewer.getModelViewManagers().getManager();e.getFeatureIds().forEach((function(e){t.showPointBodies(e)}))}}onSelectionAdded(e,t){if(!e)return!1;const i=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio(),s=i?i.getEntityIdManager():null;s&&s.getIdForName(e.getIdString())!==Si.JE&&this.addSelection(e,t)}onSelectionRemoved(e,t){if(!e)return!1;const i=this.viewer.getModelViewManagers().getManager(),s=gi(t),n=mi(e),r=pi(this.viewer,e);if(n){this.removeEdgePointUiElement(e,!1,s);const t=e.getSubfeatureId();t&&!s&&i.hidePointBodies(t),this.delayedPurgeUiElements()}else if(r&&s)this.removeEdgePointUiElement(e,!0,s),this.delayedPurgeUiElements();else if(fi(e)&&!s&&Ii(!0)){e.getFeatureIds().forEach((function(e){i.hidePointBodies(e)}))}}addMultipleSelections(e){e.models.forEach((t=>{this.addSelection(t,e)}))}onSelectionReset(e,t){if(this.removeAllEdgePointUiElements(e),!gi(e)){const t=Ii(!0);if(t&&!t.get("isSketch")){const i=function(e){const t=e.get("featureMsg");return t&&t.subFeatures?t.subFeatures.map((function(e){return e.featureId})):[]}(t),s=function(e){return e.filter((function(e){return fi(e)&&1===e.getFeatureIds().length})).map((function(e){return e.getFeatureIds()[0]}))}(e),n=this.viewer.getModelViewManagers().getManager();(0,li.difference)(i,s).forEach((function(e){n.hidePointBodies(e)}))}}this.addMultipleSelections(e),t&&t.isForRemapping?this.purgeEdgePointUiElements(!0):this.delayedPurgeUiElements()}getUIElementsForSelection(e){if(mi(e)){const t=this.edgePointUiElements[e.getIdString()];if(t)return[t.edgePointUiElement]}return[]}hideUIElementsForSelection(e){this.getUIElementsForSelection(e).forEach((function(e){e.hide()}))}setSelectedSheetmetalModelId(e){this.selectedSheetmetalModelId=e}}var Si=i(70026),Ti=i(93103),Di=i(82077);class Mi{constructor(){this.id=0,this.shiftCount=0}getId(){return this.id}getShiftCount(){return this.shiftCount}reset(){this.id=0,this.shiftCount=0}addNumber(e,t){this.id|=e<<this.shiftCount,this.shiftCount+=t,this.shiftCount>31&&ut.log.warn("BitShiftId exceeded 31 shifts; loss of uniqueness is possible")}addBoolean(e){this.addNumber(e?1:0,1)}getIdWithIdAppended(e){e>=Math.pow(2,yi.tl-this.shiftCount)&&ut.log.warn("Lost uniqueness in creating id with getIdWithIdAppended");const t=e*Math.pow(2,this.shiftCount);return this.id+t}}var Ci=i(60036),yi=i(66607);const Pi=Q.create(),Ai=Q.create(),Oi=[];for(let e=0;e<4;++e)Oi.push(Q.create());const vi=new yi.tO;class Ri{constructor(){this.occupiedBounds=[]}clearOccupiedRegions(){this.occupiedBounds=[]}addOccupiedRegion(e){this.occupiedBounds.push(e)}getUnoccupiedOffsetAlongDirection(e,t){const i=vi;i.copyFrom(e);let s=0;for(;;){let e=-1/0,n=!1;const r=i.center(Pi);for(let s=0;s<this.occupiedBounds.length;++s)if(this.occupiedBounds[s].overlapsWith(i)){n=!0;let i=-1/0;const a=this.occupiedBounds[s].getCorners(Oi);for(let e=0;e<a.length;++e){const s=Q.dot(t,ge.gv.subtract(a[e],r,Ai));s>i&&(i=s)}i>e&&(e=i)}if(!n)break;{let n=1/0;const a=i.getCorners(Oi);for(let e=0;e<a.length;++e){const i=Q.dot(t,ge.gv.subtract(a[e],r,Ai));i<n&&(n=i)}const o=e-n;if(!(o>Ci.W.ZERO_LENGTH))break;i.translate(ge.gv.scale(t,o,Ai)),s+=o}}return s}}var wi=i(73511);const _i=new Si.s;class Ni{constructor(e){this.ambientTextureFactor=0,this.ambientTexture=null,this.shaderId=null,this.isVisible=!0,this.customFloatUniformSettings=null,this.customIntUniformSettings=null,this.customMatrixUniforms=null,this.customVectorUniforms=null;const t=X.default.getManager();this.color=t.getColor("DEFAULT_MATERIAL_COLOR"),this.specularColor=t.getColor("DEFAULT_SPECULAR"),this.diffuseFactor=t.getNumber("COLOR_DIFFUSE_FACTOR"),this.ambientFactor=t.getNumber("COLOR_AMBIENT_FACTOR"),this.shininess=t.getNumber("DEFAULT_SHININESS"),this.translucentPassAlpha=t.getNumber("TRANSLUCENT_PASS_ALPHA"),this.pointSize=t.getNumber("DEFAULT_POINT_SIZE"),this.pointFont=t.getPointFont("DEFAULT_POINT_FONT"),this.lineWidth=t.getNumber("DEFAULT_LINE_WIDTH"),this.lineStipple=t.getStipple("DEFAULT_LINE_STIPPLE"),e&&((0,j.overwriteMatchingProperties)(this,e),e.hasOwnProperty("ambientTexture")&&!e.hasOwnProperty("ambientTextureFactor")&&(this.ambientTextureFactor=1)),this.id=_i.getId(),this.specularColor=this.specularColor.slice(0,3),this.highlightSpecularContribution=t.getNumber("HIGHLIGHT_SPECULAR_CONTRIBUTION")}destroy(){_i.isIdValid(this.id)&&(_i.freeId(this.id),this.id=Si.c2)}setTexture(e){this.ambientTexture!==e&&(this.ambientTexture=e,this.ambientTextureFactor=1)}getTexture(){return this.ambientTexture}makeSceneDebugObject(){return(0,Fs.bN)(this,"Material "+this.id)}setCustomFloatUniform(e,t){this.customFloatUniformSettings||(this.customFloatUniformSettings=new wi.N),this.customFloatUniformSettings.set(e,t)}setCustomIntUniform(e,t){this.customIntUniformSettings||(this.customIntUniformSettings=new wi.N),this.customIntUniformSettings.set(e,t)}setCustomMatrixUniform(e,t){this.customMatrixUniforms||(this.customMatrixUniforms=new wi.N),this.customMatrixUniforms.set(e,t)}setCustomVectorUniform(e,t){this.customVectorUniforms||(this.customVectorUniforms=new wi.N),this.customVectorUniforms.set(e,t)}setAttributes(e,t){if(e){if(t.setLastBufferBound(null),e.vertexAttrib4fv(tE.COLOR,this.color),e.uniform3fv("uSpecular",this.specularColor),e.uniform1f("uShininess",this.shininess),e.uniform1f("uColorDiffuseFactor",this.diffuseFactor),e.uniform1f("uColorAmbientFactor",this.ambientFactor),this.ambientTexture?(this.ambientTexture.viewer=t.viewer,e.useTexture("uAmbientTexture",this.ambientTexture)):e.useBlankTexture("uAmbientTexture"),e.uniform1f("uAmbientTextureFactor",this.ambientTextureFactor),e.uniform1f("uTranslucentPassAlpha",this.translucentPassAlpha),e.uniform1f("uHighlightSpecularContribution",this.highlightSpecularContribution),this.customFloatUniformSettings){const t=this.customFloatUniformSettings.getKeyValues();for(let i=0;i<t.length;i+=2)e.setFloatUniform(t[i],t[i+1])}if(this.customIntUniformSettings){const t=this.customIntUniformSettings.getKeyValues();for(let i=0;i<t.length;i+=2)e.setIntUniform(t[i],t[i+1])}if(this.customMatrixUniforms){const t=this.customMatrixUniforms.getKeyValues();for(let i=0;i<t.length;i+=2)e.setMatrixUniform(t[i],t[i+1])}if(this.customVectorUniforms){const t=this.customVectorUniforms.getKeyValues();for(let i=0;i<t.length;i+=2)e.setVectorUniform(t[i],t[i+1])}}}hasTransparency(){return this.color[3]<1||!!this.ambientTexture&&this.ambientTexture.getHasTransparency()}getExtendedShaderId(){return this.shaderId}}const bi=new Ni({ambientFactor:1,diffuseFactor:0,specularColor:[0,0,0]}),Li=new Ni;function Fi(e){return new Ni({ambientTexture:e,diffuseFactor:0,ambientFactor:1,specularColor:[0,0,0]})}var xi=i(83861);const Bi=X.default.getManager(),Vi=new xi.hF({isShowThrough:!0,isPickable:!1,primitiveType:Di.MX.LINES}),Ui=C.fromValues(1,0,0),Gi=C.fromValues(0,1,0),Hi=C.fromValues(0,0,1),ki=new xi.hF({isPickable:!1,primitiveType:Di.MX.TRIANGLES,material:null}),Wi=(0,yi.Yr)(Bi.getNumber("VIEW_CUBE_AXIS_LABEL_FADE_START_ANGLE")),zi=(0,yi.Yr)(Bi.getNumber("VIEW_CUBE_AXIS_LABEL_FADE_END_ANGLE")),Xi="axes3D",Zi="axis_label";class qi extends Ti.u1{constructor(e,t,i,s,n){super(n,Zo.EG),this.label=e,this.direction=t,this.color=i,this.axisLength=s,this.transformedDirection=null,this.labelTexture=null,this.position=null,this.lastSetOpacity=-1,this.nodeProperties=new xi.hF(ki),this.nodeProperties.material=Fi(),this.nodeProperties.updateId(),this.ensureTexture(),this.show()}onDevicePixelRatioChanged(e){this.labelTexture=null,this.ensureTexture(),this.updateIncrements()}remove(){this.labelTexture&&(this.labelTexture.destroy(),this.labelTexture=null),this.nodeProperties.material&&(this.nodeProperties.material.destroy(),this.nodeProperties.material=null),super.remove()}updateIncrements(){const e=Bi.getNumber("VIEW_CUBE_AXIS_TEXT_HEIGHT_PX"),t=this.labelTexture.filledWidthPx,i=(0,Au.fQ)([-t/2,-e/2,0],[t/2,-e/2,0],[-t/2,e/2,0],void 0,[this.labelTexture.leftCoordinate,this.labelTexture.bottomCoordinate],[this.labelTexture.rightCoordinate,this.labelTexture.topCoordinate]);this.updateMeshIncrement(Zi,Ti.ZJ,i,this.nodeProperties)}ensureTexture(){this.viewer.getGlContext()&&(this.labelTexture||(this.labelTexture=_o(this.viewer,this.label,{color:this.color,font:Bi.getString("VIEW_CUBE_TEXT_FONT"),size:Bi.getNumber("VIEW_CUBE_AXIS_TEXT_HEIGHT_PX")}),this.nodeProperties.material.ambientTexture=this.labelTexture,this.updateIncrements()))}updateTransform(e){if(!this.position||!this.transformedDirection)return;const t=Math.acos(Math.abs(C.dot(e.getForward(),this.transformedDirection))),i=(0,yi.CW)(zi,Wi,t);this.setOpacity(i),this.setTransform(ge.w$.translate(de.create(),this.position))}setOpacity(e){if(e===this.lastSetOpacity)return;const t=new Uint8Array([255,255,255,255*e]);this.updateIncrementAttribute(Zi,sE.COLOR,t),this.lastSetOpacity=e}}class Yi extends Ti.u1{constructor(e,t){super(e),this.coordinateSystemTransform=null,this.axisLabels={},this.setId(Xi),this.highlightId=Ti.ZJ,t=t||{},this.axesName=t.hasOwnProperty("axesName")?t.axesName:null,this.hasXAxis=!t.hasOwnProperty("hasXAxis")||t.hasXAxis,this.hasYAxis=!t.hasOwnProperty("hasYAxis")||t.hasYAxis,this.hasZAxis=!t.hasOwnProperty("hasZAxis")||t.hasZAxis,this.XAxisColor=t.hasOwnProperty("XAxisColor")?t.XAxisColor:Bi.getColor("X_AXIS_COLOR"),this.YAxisColor=t.hasOwnProperty("YAxisColor")?t.YAxisColor:Bi.getColor("Y_AXIS_COLOR"),this.ZAxisColor=t.hasOwnProperty("ZAxisColor")?t.ZAxisColor:Bi.getColor("Z_AXIS_COLOR");const i=Bi.getNumber("AXIS_LINE_WIDTH_PX");this.XAxisWidth=t.hasOwnProperty("XAxisWidth")?t.XAxisWidth:i,this.YAxisWidth=t.hasOwnProperty("YAxisWidth")?t.YAxisWidth:i,this.ZAxisWidth=t.hasOwnProperty("ZAxisWidth")?t.ZAxisWidth:i;const s=Bi.getNumber("AXIS_LINE_LENGTH_PX");this.XAxisStartEndPixel=t.hasOwnProperty("XAxisStartEndPixel")?t.XAxisStartEndPixel:[0,s],this.YAxisStartEndPixel=t.hasOwnProperty("YAxisStartEndPixel")?t.YAxisStartEndPixel:[0,s],this.ZAxisStartEndPixel=t.hasOwnProperty("ZAxisStartEndPixel")?t.ZAxisStartEndPixel:[0,s],this.hasXAxis&&(this.axisLabels.X=new qi("X",Ui,Bi.getColor("X_AXIS_COLOR"),this.XAxisStartEndPixel[1],this.viewer)),this.hasYAxis&&(this.axisLabels.Y=new qi("Y",Gi,Bi.getColor("Y_AXIS_COLOR"),this.YAxisStartEndPixel[1],this.viewer)),this.hasZAxis&&(this.axisLabels.Z=new qi("Z",Hi,Bi.getColor("Z_AXIS_COLOR"),this.ZAxisStartEndPixel[1],this.viewer)),this.ensureTexture(),this.listenTo(this.viewer.getEventDispatcher(),yD.Hv,this.onViewWillDraw)}onViewWillDraw(e,t){if(this.updateGraphics(e),this.coordinateSystemTransform)for(const t in this.axisLabels){const i=this.axisLabels[t],s=i.axisLength+Bi.getNumber("AXIS_LABEL_OFFSET_PX"),n=ge.S4.scale(this.axisLabels[t].direction,s,C.create()),r=ge.w$.multiplyVec4(this.transform,y.fromValues(n[0],n[1],n[2],1),y.create()),a=e.projectWorldPointToViewport(r);i.position=a;const o=y.fromValues(i.direction[0],i.direction[1],i.direction[2],0);ge.w$.multiplyVec4(this.transform,o,y.create());i.transformedDirection||(i.transformedDirection=y.create()),C.copy(i.transformedDirection,i.direction),i.transformedDirection[3]=0,ge.w$.multiplyVec4(this.transform,i.transformedDirection),ge.S4.normalize(i.transformedDirection),i.updateTransform(e)}}addAxis(e,t,i,s,n){const r=ge.S4.scale(t,n[0],C.create()),a=ge.S4.scale(t,n[1],C.create()),o=(0,Au.W5)(r,a);(0,Au.VQ)(s,o),(0,Au.Ab)(i,o),this.updateMeshIncrement(e,Ti.ZJ,o,Vi)}updateGraphics(e){if(null===this.coordinateSystemTransform)return;!this.hasMeshIncrements()&&this.coordinateSystemTransform&&(this.hasXAxis&&this.addAxis("X_AXIS",Ui,this.XAxisColor,this.XAxisWidth,this.XAxisStartEndPixel),this.hasYAxis&&this.addAxis("Y_AXIS",Gi,this.YAxisColor,this.YAxisWidth,this.YAxisStartEndPixel),this.hasZAxis&&this.addAxis("Z_AXIS",Hi,this.ZAxisColor,this.ZAxisWidth,this.ZAxisStartEndPixel));const t=C.fromValues(this.coordinateSystemTransform[12],this.coordinateSystemTransform[13],this.coordinateSystemTransform[14]),i=e.getPixelSizeAtWorldPoint(t),s=C.fromValues(i,i,i),n=ge.w$.scale(this.coordinateSystemTransform,s,de.create());this.setTransform(n)}updateDefinition(e){this.coordinateSystemTransform=e}hide(){this.hasXAxis&&this.axisLabels.X.hide(),this.hasYAxis&&this.axisLabels.Y.hide(),this.hasZAxis&&this.axisLabels.Z.hide(),super.hide()}show(){this.hasXAxis&&this.axisLabels.X.show(),this.hasYAxis&&this.axisLabels.Y.show(),this.hasZAxis&&this.axisLabels.Z.show(),super.show()}ensureTexture(){for(const e in this.axisLabels)this.axisLabels[e].ensureTexture()}remove(){for(const e in this.axisLabels)this.axisLabels[e].remove();super.remove()}}var Ki=i(26738);const ji={ASSEMBLY:"Assembly",PART_STUDIO:"Part Studio",SKETCH:"Sketch",UNSUPPORTED:"Default"};class Qi extends m.T{constructor(e){super(),this.commands={},this.spaceBallConnection=e}startListeningToEvents(){this.listenTo((0,yD.xA)(),yD.Fc,this.setActiveCommandSet),this.listenTo((0,yD.xA)(),yD.RV,this.executeCommand),this.listenTo((0,yD.xA)(),yD.TN,this.commandSetReceived)}stopListeningToEvents(){this.stopListening()}setActiveCommandSet(e){this.spaceBallConnection.update3dcontroller({commands:{activeSet:e}})}commandSetReceived(e){const t=new _3Dconnexion.ActionTree,i=new _3Dconnexion.ImageCache,s=this;for(let s=0;s<e.length;s++){const n=e[s],r=n.tabType,a=t.push(new _3Dconnexion.ActionSet(r,"")).push(new _3Dconnexion.Category("Action_Id_"+r,"Commands"));for(let e=0;e<n.commands.length;e++){const t=n.commands[e];let s=t.command,o=t.icon?"/images/"+t.icon+".svg":"";(this.commands[s]||n.tabId===k.GNh.PARTSTUDIO&&"mateConnector"===t.command)&&(s=r+"-"+t.command),(t.command.indexOf("mate")>-1||t.command.indexOf("Mate")>-1)&&"mateConnector"!==t.command&&(t.icon&&(o="/images/mate/"+t.icon+".svg"),s=t.command+"_"+t.commandDetails),"load"===t.command&&(s=t.command+"_"+t.commandDetails),a.push(new _3Dconnexion.Action(s,i18n(t.name),"")),this.commands[s]=t,o&&i.push(_3Dconnexion.ImageItem.fromURL(o,s))}}t.push(new _3Dconnexion.ActionSet(ji.UNSUPPORTED,"")),i.onload=function(){s.spaceBallConnection.update3dcontroller({images:i.images})};let n=ji.UNSUPPORTED;(0,lt._R)()?n=ji.ASSEMBLY:(0,lt._B)()&&(n=ji.PART_STUDIO),this.spaceBallConnection.update3dcontroller({commands:{activeSet:n,tree:t}})}executeCommand(e){this.commands[e]&&Ki.Jq.SpaceballService.executeCommand(this.commands[e])}}var $i=i(20575),Ji=i(16696),es=i(35692);class ts extends m.T{constructor(e,t){super(),this.viewer=e,this.mouseMoveTextCallback=t,this.APPENDAGE_ID="cursor-appendage-user",this.addListeners()}addListeners(){const e=this.viewer.getEventDispatcher();this.listenTo(e,yD.oG,this.onMouseMove),this.listenTo(e,yD.u5,this.onMouseLeave)}destroy(){this.removeContainer(),this.stopListening()}onMouseMove(e){const t=this.viewer.getCanvasCoordinateFromEvent(e);this.updatePosition([...t])}updatePosition(e){const t=this.mouseMoveTextCallback(e[0],e[1]);if(t){const i=(0,Ji.x_)(),s=[e[0]/i,e[1]/i],n=this.getContainer();n.text(t),n.css({left:s[0]+25+"px",top:s[1]+"px"})}else this.removeContainer()}onMouseLeave(e){this.removeContainer()}getContainer(){let e=es("#"+this.APPENDAGE_ID);return 0===e.length&&(e=es("<div></div>").appendTo((0,$i.Ug)()),e.attr("class",ts.CONTAINER_CLASS),e.attr("id",this.APPENDAGE_ID)),e}removeContainer(){es("#"+this.APPENDAGE_ID).remove()}}ts.CONTAINER_CLASS="cursor-appendage";var is=i(90631);class ss extends ts{constructor(){super(...arguments),this.APPENDAGE_ID="cursor-appendage-leader"}addListeners(){const e=this.viewer.getEventDispatcher();this.listenTo(e,is.Awy,this.updatePosition),this.listenTo(e,is.NfU,this.onMouseLeave),this.listenTo(e,is.Gfg,this.removeContainer)}updatePosition(e){const t=(0,Ji.x_)(),i=e.map((e=>e*t));super.updatePosition(i)}}var ns=i(88158);class rs{constructor(e,t,i){this.viewer=i,this.dragItems=null,this.dragSequenceId=1,this.showDimensionExpressions_=!1,this.id=e,this.planeMatrix=de.create(),this.planeMatrixrixInverse=de.create(),this.appliedTransform=de.create(),this.computedPlaneMatrix=de.create(),this.computedInverse=de.create(),t?(this.planeMatrix[0]=t.m00,this.planeMatrix[1]=t.m10,this.planeMatrix[2]=t.m20,this.planeMatrix[3]=0,this.planeMatrix[4]=t.m01,this.planeMatrix[5]=t.m11,this.planeMatrix[6]=t.m21,this.planeMatrix[7]=0,this.planeMatrix[8]=t.m02,this.planeMatrix[9]=t.m12,this.planeMatrix[10]=t.m22,this.planeMatrix[11]=0,this.planeMatrix[12]=t.m03,this.planeMatrix[13]=t.m13,this.planeMatrix[14]=t.m23,this.planeMatrix[15]=1):ut.log.info("invalid plane definition"),this.planeMatrixrixInverse=ge.w$.set(this.planeMatrix,this.planeMatrixrixInverse),ge.w$.inverse(this.planeMatrixrixInverse),this.startPt=C.create(),this.endPt=C.create(),this.p0=y.create(),this.p1=y.create(),this.p2=y.create(),this.p3=y.create(),this.updateComputedTransforms()}set showDimensionExpressions(e){this.showDimensionExpressions_=e,this.viewer.getEventDispatcher().trigger(yD.yB,e)}get showDimensionExpressions(){return this.showDimensionExpressions_}updateComputedTransforms(){return ge.w$.multiply(this.appliedTransform,this.planeMatrix,this.computedPlaneMatrix),ge.w$.inverse(ge.w$.multiply(this.appliedTransform,this.planeMatrix,this.computedInverse))}getId(){return this.id}getAppliedTransform(){return this.appliedTransform}getPlaneMatrix(){return this.computedPlaneMatrix}getPlaneMatrixInverse(){return this.computedInverse}setAppliedTransform(e){this.appliedTransform=e,this.updateComputedTransforms()}startPointScreen(e){this.startPt=this.toWorld(e)}endPointScreen(e){this.endPt=this.toWorld(e)}resetState(){this.entityIds=null,this.dragItems=null}toPlane(e){const t=this.toWorld(e);if(!t)return null;let i=y.create();const s=y.create();return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=1,i=ge.w$.multiplyVec4(this.getPlaneMatrixInverse(),s,i),[i[0],i[1],0]}toWorld(e){const t=(0,j.as)(Kn,this.viewer.getPrimaryViewController()).camera.getRay(e[0],e[1]);return(0,yi.bZ)(t,this.getPlaneMatrix())}getCanvasCoordinates(e){const t=this.viewer.getCamera(),i=this.planeToWorld(e),s=t.projectWorldPointToCanvas(i);return ge.S4.scale(s,1/(0,Ji.x_)())}planeVec4ToWorld(e){let t=y.create();return t=ge.w$.multiplyVec4(this.getPlaneMatrix(),e,t),C.fromValues(t[0],t[1],t[2])}planeToWorld(e){return this.planeVec4ToWorld(y.fromValues(e[0],e[1],0,1))}planeVectorToWorld(e){return this.planeVec4ToWorld(y.fromValues(e[0],e[1],e[2],0))}worldToPlane(e){let t=y.create();const i=y.create();return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=1,t=ge.w$.multiplyVec4(this.getPlaneMatrixInverse(),i,t),[t[0],t[1],t[2]]}getSketchNormal(){const e=[],t=this.getPlaneMatrix();return e[2]=t[10],e[1]=t[9],e[0]=t[8],e}createIncludeNonParallelPlaneFilter(){const e=this.getSketchNormal();return(0,ns.iQ)(e)}}var as=i(35692);function os(){!function(e){let t=null;e(document).on("mouseup",(function(e){t=null})),e.widget("bti.mouse",{version:"1.9.2",options:{cancel:"input,textarea,button,select,option",distance:1,delay:0},_mouseInit:function(){const t=this;this.element.on("mousedown."+this.widgetName,(function(e){return t._mouseDown(e)})).on("click."+this.widgetName,(function(i){if(!0===e.data(i.target,t.widgetName+".preventClickEvent"))return e.removeData(i.target,t.widgetName+".preventClickEvent"),i.stopImmediatePropagation(),!1})),this.started=!1,this.buttonState={leftButton:!1,middleButton:!1,rightButton:!1}},_mouseDestroy:function(){if(this.element.off("."+this.widgetName),this._mouseMoveDelegate){e(document).off("mousemove."+this.widgetName,this._mouseMoveDelegate);for(let t=1;t<=3;++t)e(document).off("mouseup."+this.widgetName+t,this._mouseUpDelegate)}},_mouseDown:function(i){if(t&&t!==this)return;this._mouseDownEvent=i;const s=this;return!!("string"==typeof this.options.cancel&&i.target.nodeName&&e(i.target).closest(this.options.cancel).length||!this._mouseCapture(i))||(1===i.which?this.buttonState.leftButton=!0:2===i.which?this.buttonState.middleButton=!0:3===i.which&&(this.buttonState.rightButton=!0),this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout((function(){s.mouseDelayMet=!0}),this.options.delay)),this._mouseDistanceMet(i)&&this._mouseDelayMet(i)&&(this._mouseStarted=!1!==this._mouseStart(i),!this._mouseStarted)?(i.preventDefault(),!0):(!0===e.data(i.target,this.widgetName+".preventClickEvent")&&e.removeData(i.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate||(this._mouseMoveDelegate=function(e){return s._mouseMove(e)},e(document).on("mousemove."+this.widgetName,this._mouseMoveDelegate)),this._mouseUpDelegate=function(e){return s._mouseUp(e)},e(document).on("mouseup."+this.widgetName+i.which,this._mouseUpDelegate),i.preventDefault(),t=this,!0))},_mouseMove:function(t){return e.ui.ie&&document.documentMode<9&&!t.button?this._mouseUp(t):this._mouseStarted?(this._mouseDrag(t),t.preventDefault()):(this._mouseDistanceMet(t)&&this._mouseDelayMet(t)&&(this._mouseStarted=!1!==this._mouseStart(this._mouseDownEvent,t),this._mouseStarted?this._mouseDrag(t):this._mouseUp(t)),!this._mouseStarted)},_mouseUp:function(i){e(document).off("mouseup."+this.widgetName+i.which,this._mouseUpDelegate),1===i.which?this.buttonState.leftButton=!1:2===i.which?this.buttonState.middleButton=!1:3===i.which&&(this.buttonState.rightButton=!1);const s=!this.buttonState.leftButton&&!this.buttonState.middleButton&&!this.buttonState.rightButton;return s&&(t=null,e(document).off("mousemove."+this.widgetName,this._mouseMoveDelegate),this._mouseMoveDelegate=null),this._mouseStarted&&s?(i.target===this._mouseDownEvent.target&&e.data(i.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(i),this._mouseStarted=!1):this._mouseStarted&&this._mouseDrag(i),!1},_mouseDistanceMet:function(e){return Math.max(Math.abs(this._mouseDownEvent.pageX-e.pageX),Math.abs(this._mouseDownEvent.pageY-e.pageY))>=this.options.distance},_mouseDelayMet:function(e){return this.mouseDelayMet},_mouseStart:function(e){},_mouseDrag:function(e){},_mouseStop:function(e){},_mouseCapture:function(e){return!0}}),e.widget("bti.dragHelper",e.bti.mouse,{widgetEventPrefix:"dragHelper",options:{onStart:function(e){},onDrag:function(e){},onStop:function(e){}},_create:function(){this._mouseInit(),this._dragging=!1},destroy:function(){return this.element.off(".dragHelper"),this._mouseDestroy(),this},dragging:function(){return this._dragging},cancelDragging:function(t){return this.buttonState.leftButton=!1,this.buttonState.middleButton=!1,this.buttonState.rightButton=!1,e.bti.mouse.prototype._mouseUp.call(this,t)},_mouseStart:function(e,t){this._dragging=!0,this.lastX=e.pageX,this.lastY=e.pageY,this.options.onStart.call(this,e,t)},_mouseDrag:function(e){this.options.onDrag.call(this,e,e.pageX-this.lastX,e.pageY-this.lastY),this.lastX=e.pageX,this.lastY=e.pageY},_mouseStop:function(e){this._dragging=!1,this.options.onStop.call(this,e)}})}(as)}i(55217);var hs=i(43974),cs=i(24473),ls=i(33257),us=i(35692);class ds{constructor(e){this.cursor=Nn.C.DEFAULT,this.viewer=null,this._isActivated=!1,this.viewer=e,this.cursor=(0,dt.isPlatformWindows)()?Nn.C.BOXDESELECTION_CURSORS_WINDOWS:Nn.C.BOXDESELECTION_CURSORS_GENERIC}setDeselectionCursor(){this.viewer.peekCursor()!==this.cursor&&(this._isActivated&&this.viewer.removeTopOccurrenceOfCursor(this.cursor),this._isActivated=!0,this.viewer.pushCursor(this.cursor))}setDefaultCursor(){this._isActivated&&this.viewer.removeTopOccurrenceOfCursor(this.cursor),this._isActivated=!1}get isActivated(){return this._isActivated}}os();class gs{constructor(e,t){this.editFeatureUnderCursor=e,this.viewer=t,this.sketch=null,this.lastMouseMovedEvent=null,this.lastMouseMoveTime=-1,this.showContextMenuOnMouseUp=!1,this.timeOfRightMouseButtonDown=0,this.mouseTravelSinceRightButtonDown=0,this.preHighlightTimeout=0,this.suppressMouseMovePick=!1,this.hoveredUiSelection=null,this.draggedUiSelection=null,this.longPressedUiSelection=null,this.skipNextClickSelection=!1,this.externalDragHandler=null,this.dragHandledExternally=!1,this.initialDragEvent=null,this.leftButtonDownOnDragStart=!1,this.startedLeftButtonDrag=!1,this.forcedManipulationActive=!1,this.dragTravel=0,this.dragStartTime=0,this.mouseInCanvas=!1,this.buttonState={leftButton:!1,middleButton:!1,rightButton:!1},this.middleMouseButtonDoubleClickHandler=null,this.altHeld=!1,this.ctrlHeld=!1,this.boxDeselectionEnabled=!1,this.boxDeselectionCursorHandler=null,(0,Jo.Yk)(t),this.boxSelector=new rn(this.viewer),this.boxDeselectionCursorHandler=new ds(this.viewer),this.setupEventHandlers(),Ki.Jq.CapabilitiesService.isBoxDeselectionEnabled().then((e=>{this.boxDeselectionEnabled=e}))}setupEventHandlers(){const e=this,t=this.getViewer().$el;t.dragHelper({lastX:0,lastY:0,onStart:function(t,i){e.buttonState=this.buttonState,e.onDragStart(t,i)},onDrag:function(t,i,s){e.buttonState=this.buttonState;const n=(0,Ji.x_)();e.onDrag(t,i*n,s*n,this.lastX*n,this.lastY*n)},onStop:function(t){e.buttonState=this.buttonState,e.onDragStop(t)}});const i=function(t){return t.bind(e)};t.on("mouseenter",i(gs.prototype.onMouseEnter)),t.on("mouseleave",i(gs.prototype.onMouseLeave)),t.on("mousemove",i(gs.prototype.onMouseMove)),t.on("mousedown",i(gs.prototype.onMouseDown)),t.on("mouseup",i(gs.prototype.onMouseUp)),t.on("click",i(gs.prototype.onClick)),t.on("dblclick",i(gs.prototype.onDoubleClick)),t.on("mousewheel DOMMouseScroll",i(gs.prototype.onMouseWheelScroll)),ko(t,i(gs.prototype.onLongPress)),this.middleMouseButtonDoubleClickHandler=new DI(t,i(gs.prototype.onMiddleMouseButtonDoubleClick)),us(document).on("keyup",i(gs.prototype.onKeyUp)),us(document).on("keydown",i(gs.prototype.onKeyDown))}remove(){this.boxDeselectionCursorHandler.setDefaultCursor(),this.boxSelector&&(this.boxSelector.remove(),this.boxSelector=null),this.middleMouseButtonDoubleClickHandler&&(this.middleMouseButtonDoubleClickHandler.off(),this.middleMouseButtonDoubleClickHandler=null)}setSketch(e){this.sketch=e}setExternalDragHandler(e){this.externalDragHandler=e}setSuppressMouseMovePick(e){this.suppressMouseMovePick=e,this.suppressMouseMovePick&&this.clearPreHighlightTimeout()}getLastMouseMovedEvent(){return this.lastMouseMovedEvent}isMouseRightButtonDown(){return this.buttonState.rightButton}isMouseMiddleButtonDown(){return this.buttonState.middleButton}isMouseLeftButtonDown(){return this.buttonState.leftButton}getViewer(){return this.viewer}onMouseEnter(e){this.viewer.getEventDispatcher().trigger(yD.ox,e),this.mouseInCanvas=!0,this.lastMouseMoveTime=-1,window.focus()}trackMouseMovement(e){let t=1/0;const i=(0,Fs.Wj)(),s=i-this.lastMouseMoveTime,n=X.default.getManager(),r=n.getNumber("CONTEXT_MENU_DISTANCE_THRESHOLD"),a=this.viewer.getCanvasCoordinateFromEvent(e),o=this.viewer.getCanvasCoordinateFromEvent(this.lastMouseMovedEvent);if(this.lastMouseMoveTime>0&&this.lastMouseMovedEvent){const e=ge.gv.length([a[0]-o[0],a[1]-o[1]]);t=e/s,n.getNumber("OUTPUT_MOUSE_SPEED")&&ut.log.debug("Mouse speed: "+t.toFixed(3)+", distance since last movement: "+e.toFixed(2)+", time since last movement: "+s.toFixed(1)),this.mouseTravelSinceRightButtonDown+=e}return this.lastMouseMoveTime=i,this.lastMouseMovedEvent=e,this.showContextMenuOnMouseUp&&this.mouseTravelSinceRightButtonDown>r&&(this.showContextMenuOnMouseUp=!1),t}isViewManipulationActive(e){const t=this.getViewer().getPrimaryViewController();if(null!==t){if(t.isBeingManipulated())return!0;if(t.getManipulationMode(e,this.buttonState)!==IC.k.NONE)return!0}return(0,jo.aD)()}isNotManipulatingAndNotInZoom(e){return!this.suppressMouseMovePick&&!this.isViewManipulationActive(e)&&!this.draggedUiSelection}onMouseMove(e){if(this.viewer.getEventDispatcher().trigger(yD.oG,e),e.isPropagationStopped())return!1;if(!this.viewer.isReadyForDrawing())return!1;const t=X.default.getManager(),i=this.trackMouseMovement(e);this.clearPreHighlightTimeout();const s=this.getViewer();s.updateLastMouseLocation(e),this.isNotManipulatingAndNotInZoom(e)&&(i<t.getNumber("PREHIGHLIGHT_SPEED_THRESHOLD")?this.triggerPreHighlightPick(e):(0,Ce.Wf)().length>0?this.triggerPreHighlightPick(e,!0):this.schedulePreHighlightPick(e));const n=hs.k.getLeaderFollowModel();if(n.active){n.width=s.el.width,n.height=s.el.height;const t=s.isMouseInsideViewManipulator()?[-1,-1]:s.getCanvasCoordinateFromEvent(e);n.setCursorPosition(t)}return!0}onMouseLeave(e){this.viewer.getEventDispatcher().trigger(yD.u5,e),this.mouseInCanvas=!1,this.clearPreHighlightTimeout(),this.suppressMouseMovePick||(0,Ce.Zs)(!0,!1)}eventCanBeUsedForContextMenu(e,t={ctrlClickShouldBeTreatedAsClick:!1}){if(e.which===ls.t.LEFT&&"mouseup"===e.type&&e.ctrlKey){const i=this.getViewer(),s=i.getCanvasCoordinateFromEvent(e),n=i.pick(s[0],s[1]);for(const i of n)if(i.getUISelection()?.shouldTreatCtrlClickAsClick(e))return t.ctrlClickShouldBeTreatedAsClick=!0,!1}return e.ctrlKey||e.which===ls.t.RIGHT}onMouseDown(e){(0,jo.aD)()&&(this.hoveredUiSelection=new dh.i(this.boxSelector,$s,""),this.viewer.getUISelectionManager().setHoveredSelection(this.hoveredUiSelection,e)),this.eventCanBeUsedForContextMenu(e)&&(this.lastMouseMovedEvent=e,this.showContextMenuOnMouseUp=!0,this.mouseTravelSinceRightButtonDown=0,this.timeOfRightMouseButtonDown=(0,Fs.Wj)())}isMouseInCanvas(){return this.mouseInCanvas}onContextMenuWillHide(e,t){this.eventCanBeUsedForContextMenu(t)&&(this.lastMouseMovedEvent=null,this.showContextMenuOnMouseUp=!0,this.mouseTravelSinceRightButtonDown=0,this.timeOfRightMouseButtonDown=(0,Fs.Wj)())}onMouseUp(e){this.trackMouseMovement(e);const t=(0,Fs.Es)(this.timeOfRightMouseButtonDown)>X.default.getManager().getNumber("CONTEXT_MENU_TIME_THRESHOLD_MS"),i={ctrlClickShouldBeTreatedAsClick:!1};if(this.showContextMenuOnMouseUp&&!t&&this.eventCanBeUsedForContextMenu(e,i)){this.cancelDragging(e);const t={pickHandled:!1,contextMenuEnabled:!0,altKey:e.altKey};this.notifyGraphicsHandledClick(t),this.showContextMenu(e),us("#context-menu-layer").on("contextmenu:willhide",this.onContextMenuWillHide.bind(this))}i.ctrlClickShouldBeTreatedAsClick&&this.onClick(e,!0),this.longPressedUiSelection&&e.which===ls.t.LEFT&&(this.longPressedUiSelection.uiElement.triggerLongPressEnd(this.longPressedUiSelection,e),this.longPressedUiSelection=null,this.skipNextClickSelection=!0)}updatePicksForKeyEvent(e){if(this.isNotManipulatingAndNotInZoom(e)){const t=this.getViewer();if(!t||!t.getGlContext()||null===this.lastMouseMovedEvent)return;if(t!==(0,Jo.N9)())return;const i=t.getCanvasCoordinateFromEvent(this.lastMouseMovedEvent);t.doPick(i[0],i[1],!0,!0,{onlyRemovePreHighlight:!1,sourceEvent:e,altKey:e.altKey})}}onKeyDown(e){e.altKey&&!this.altHeld&&(this.altHeld=!0,this.updatePicksForKeyEvent(e)),e.ctrlKey&&!this.ctrlHeld&&this.boxDeselectionEnabled&&(this.ctrlHeld=!0)}onKeyUp(e){!e.altKey&&this.altHeld&&(this.altHeld=!1,this.updatePicksForKeyEvent(e)),!e.ctrlKey&&this.ctrlHeld&&this.onReleaseCtrl(),e.which===cs.R8.ALT&&e.preventDefault()}onClick(e,t=!1){if(this.viewer.getEventDispatcher().trigger(yD.pU,e),!t&&(e.isPropagationStopped()||this.showContextMenuOnMouseUp&&this.eventCanBeUsedForContextMenu(e)))return;let i={altKey:e.altKey};const s=e.which===ls.t.LEFT;if(!this.isDragging()&&s&&!this.skipNextClickSelection){const t=this.getViewer(),s=t.getCanvasCoordinateFromEvent(e);i={click:!0,shiftKey:e.shiftKey,altKey:this.altHeld,ctrlKey:e.ctrlKey,sourceEvent:e},i.pickHandled=t.doPick(s[0],s[1],!1,!0,i)}this.skipNextClickSelection=!1,this.notifyGraphicsHandledClick(i)}onDoubleClick(e){if(this.viewer.getIsForPreviousVersionDisplay())return;let t;if(!this.isDragging()){if(e.which===ls.t.LEFT){const i=this.viewer.getCanvasCoordinateFromEvent(e);t=this.viewer.onDoubleClick(i[0],i[1],e),!t&&this.viewer.getCanEdit()&&this.editFeatureUnderCursor(i[0],i[1])}}this.notifyGraphicsHandledClick({pickHandled:t,altKey:e.altKey})}onMiddleMouseButtonDoubleClick(e){this.isDragging()||this.viewer.animateZoomFit()}onMouseWheelScroll(e){if(this.viewer.performingBoxSelection())return!1;if(!this.viewer.isReadyForDrawing())return!1;return!!this.viewer.getPrimaryViewController().zoomOnMouseWheelScroll(e)&&(this.viewer.getEventDispatcher().trigger(yD.h0,e),this.viewer.setUserIsAdjustingCamera(),this.viewer.requestDraw(),!1)}cancelDragging(e){this.getViewer().$el.dragHelper("cancelDragging",e)}isDragging(){return this.getViewer().$el.dragHelper("dragging")}onDragStart(e,t){if(this.leftButtonDownOnDragStart=this.buttonState.leftButton,this.viewer.performingBoxSelection())return;if(!this.viewer.isReadyForDrawing())return;this.initialDragEvent=e,this.dragTravel=0,this.dragStartTime=(0,Fs.Wj)();const i=this.viewer.getPrimaryViewController(),s=i.onDragStart(e,t,this.buttonState);this.leftButtonDownOnDragStart&&i.isBeingForceManipulated()&&(this.forcedManipulationActive=!0,this.leftButtonDownOnDragStart=!1),s&&this.viewer.getEventDispatcher().trigger(yD.h0,e),this.draggedUiSelection=null,this.dragHandledExternally=!1,this.startedLeftButtonDrag=!1,this.preHighlightTimeout&&(this.triggerPreHighlightPick(t),this.clearPreHighlightTimeout()),this.hoveredUiSelection=this.viewer.getUISelectionManager().getHoveredSelection()}onDrag(e,t,i,s,n){this.dragTravel+=ge.gv.length([t,i]);const r=this.getViewer();if(!r.performingBoxSelection()&&r.isReadyForDrawing())if(r.getPrimaryViewController().onDrag(e,this.buttonState,t,i,s,n),r.getPrimaryViewController().isBeingManipulated()?(this.viewer.setUserIsAdjustingCamera(),(0,Ce.IQ)()):this.viewer.setUserIsManipulatingWithTimeout(),this.buttonState.leftButton||this.stopLeftMouseButtonHandlers.call(this,e),!this.startedLeftButtonDrag&&this.shouldStartLeftButtonDrag())this.startLeftButtonDrag();else if(this.draggedUiSelection){const t=r.getCanvasCoordinateFromEvent(e);this.draggedUiSelection.uiElement.triggerDrag(this.draggedUiSelection,{mouseX:t[0],mouseY:t[1],camera:r.getCamera(),shiftKey:e.shiftKey}),this.ctrlHeld&&!this.boxDeselectionCursorHandler.isActivated&&this.boxDeselectionCursorHandler.setDeselectionCursor()}else this.dragHandledExternally&&(this.sketch&&this.sketch.endPointScreen(r.getCanvasCoordinateFromEvent(e)),this.externalDragHandler&&this.externalDragHandler.onDrag(e))}onDragStop(e){const t=this.getViewer();e.ctrlKey||this.ctrlHeld&&(this.ctrlHeld=!1),this.boxDeselectionCursorHandler.setDefaultCursor(),this.leftButtonDownOnDragStart&&!this.startedLeftButtonDrag&&this.initialDragEvent&&!this.forcedManipulationActive&&this.onClick(this.initialDragEvent),this.forcedManipulationActive=!1,t.isReadyForDrawing()&&(t.getPrimaryViewController().onDragStop(e),this.stopLeftMouseButtonHandlers.call(this,e),this.suppressMouseMovePick||this.schedulePreHighlightPick(e))}schedulePreHighlightPick(e){const t=this,i=this.viewer.getAveragePickDuration()*X.default.getManager().getNumber("PAUSED_MOUSE_PREHIGHLIGHT_TIMEOUT_MULTIPLIER");this.preHighlightTimeout=window.setTimeout((function(){t.triggerPreHighlightPick(e),t.preHighlightTimeout=0}),i)}clearPreHighlightTimeout(){this.preHighlightTimeout&&(window.clearTimeout(this.preHighlightTimeout),this.preHighlightTimeout=0)}triggerPreHighlightPick(e,t){if(!e)return;const i=this.getViewer();if(!i||!i.getGlContext())return;if(this.viewer.getIsForPreviousVersionDisplay()&&"mousemove"!==e.type)return;const s=i.getCanvasCoordinateFromEvent(e);i.doPick(s[0],s[1],!0,!0,{onlyRemovePreHighlight:!!t,sourceEvent:e,altKey:this.altHeld})}shouldStartLeftButtonDrag(){const e=X.default.getManager(),t=(0,Fs.Wj)()-this.dragStartTime,i=this.getViewer().getPrimaryViewController();return!this.startedLeftButtonDrag&&!i.isBeingForceManipulated()&&this.leftButtonDownOnDragStart&&t>e.getNumber("LEFT_MOUSE_DRAG_TIME_TOLERANCE")&&this.dragTravel>e.getNumber("LEFT_MOUSE_DRAG_DISTANCE_TOLERANCE")}startLeftButtonDrag(){const e=this.getViewer();(0,jo.aD)()?this.hoveredUiSelection=new dh.i(this.boxSelector,$s,""):this.triggerPreHighlightPick(this.initialDragEvent);const t=e.getCanvasCoordinateFromEvent(this.initialDragEvent);this.hoveredUiSelection&&this.hoveredUiSelection.uiElement.triggerDragStart(this.hoveredUiSelection,{mouseX:t[0],mouseY:t[1],camera:e.getCamera()})&&(this.draggedUiSelection=this.hoveredUiSelection),this.dragHandledExternally=!1,this.draggedUiSelection||(this.sketch&&this.sketch.startPointScreen(t),!this.externalDragHandler||this.ctrlHeld&&!this.sketch||(this.dragHandledExternally=this.externalDragHandler.onDragStart(this.initialDragEvent))),this.draggedUiSelection||this.dragHandledExternally||(this.ctrlHeld&&this.boxDeselectionCursorHandler.setDeselectionCursor(),this.draggedUiSelection=new dh.i(this.boxSelector,$s,""),this.draggedUiSelection.uiElement.triggerDragStart(this.draggedUiSelection,{mouseX:t[0],mouseY:t[1],camera:e.getCamera()})||(this.draggedUiSelection=null)),this.startedLeftButtonDrag=!0}stopLeftMouseButtonHandlers(e){const t=this.getViewer();if(this.draggedUiSelection){const i=this.viewer.getCanvasCoordinateFromEvent(e);this.draggedUiSelection.uiElement.triggerDragStop(this.draggedUiSelection,{mouseX:i[0],mouseY:i[1],camera:t.getCamera()}),this.draggedUiSelection=null}this.dragHandledExternally&&(this.sketch&&this.sketch.endPointScreen([e.pageX,e.pageY]),this.externalDragHandler&&this.externalDragHandler.onDragStop(e),this.dragHandledExternally=!1)}showContextMenu(e){this.getViewer().$el.osContextMenu({x:e.pageX,y:e.pageY})}notifyGraphicsHandledClick(e){(0,yD.xA)().trigger(yD.sd,e),Ki.Jq.FlyoutService.collapseAllFlyouts(),e&&e.skipCommentClearHighlight||Ki.Jq.CommentEditService.clearCommentHighlights()}onLongPress(e,t){const i=this.viewer.getCanvasCoordinateFromEvent(t),s=this.viewer.pickIteratively(i[0],i[1],this.viewer.getDefaultPickTerminationEvaluator(),{altKey:e.altKey});let n=null;for(let e=0;e<s.length&&!n;++e)n=s[e].uiSelection;n&&(this.longPressedUiSelection=n,this.longPressedUiSelection.uiElement.triggerLongPressStart(this.longPressedUiSelection,e))}getAltHeld(){return this.altHeld}getCtrlHeld(){return this.ctrlHeld}onReleaseCtrl(){this.ctrlHeld=!1,this.boxDeselectionCursorHandler.setDefaultCursor()}}var ps,ms=i(72264),fs=i(81621),Is=i(37654),Es=i(97340),Ss=i(80387),Ts=i(42785);!function(e){e.PREVIEW_STATE_CHANGE="previewStateChange",e.PREVIEW_BLEND_CHANGE="previewBlendChange"}(ps||(ps={}));const Ds=.7;class Ms{constructor(){this.eventsSubject=new Is.x,this.stateProperties=new Es.X({previewAlpha:Ds,latestDisplayDataUsage:k.rvN.BASE,inCompareMode:!1}),Ki.Jq.StateService?this.inCompareMode=Ki.Jq.StateService.isOnDocumentCompare():this.inCompareMode=!1,this.inCompareModeChangedObservable.subscribe((()=>{this.eventsSubject.next(ps.PREVIEW_STATE_CHANGE)})),this.latestDisplayDataUsageChangedObservable.subscribe((()=>{const e=this.inCompareMode;e||this.eventsSubject.next(ps.PREVIEW_STATE_CHANGE);const t=this.latestDisplayDataUsage===k.rvN.BASE,i=this.latestDisplayDataUsage===k.rvN.COMPARE_TARGET;!e||t||i?!e&&i&&ut.log.warn("Received COMPARE_TARGET message while not in compare mode."):ut.log.warn("Received a non-BASE and non-COMPARE_TARGET message while in compare mode.")})),this.previewAlphaChangedObservable.subscribe((()=>{this.eventsSubject.next(ps.PREVIEW_BLEND_CHANGE)}))}get inCompareModeChangedObservable(){return this.stateProperties.asObservable().pipe((0,Ss.G)(),(0,ye.h)((([e,t])=>e.inCompareMode!==t.inCompareMode)),(0,Ts.U)((([e,t])=>t)))}get stateChangedObservable(){return this.eventsSubject.asObservable()}get latestDisplayDataUsageChangedObservable(){return this.stateProperties.asObservable().pipe((0,Ss.G)(),(0,ye.h)((([e,t])=>e.latestDisplayDataUsage!==t.latestDisplayDataUsage)),(0,Ts.U)((([e,t])=>t)))}get previewAlphaChangedObservable(){return this.stateProperties.asObservable().pipe((0,Ss.G)(),(0,ye.h)((([e,t])=>e.previewAlpha!==t.previewAlpha)),(0,Ts.U)((([e,t])=>t)))}get latestDisplayDataUsage(){return this.stateProperties.getValue().latestDisplayDataUsage}set latestDisplayDataUsage(e){const t={...this.stateProperties.getValue(),latestDisplayDataUsage:e};this.stateProperties.next(t)}get inCompareMode(){return this.stateProperties.getValue().inCompareMode}set inCompareMode(e){const t={...this.stateProperties.getValue(),inCompareMode:e};this.stateProperties.next(t)}get previewAlpha(){return this.stateProperties.getValue().previewAlpha}set previewAlpha(e){const t={...this.stateProperties.getValue(),previewAlpha:e};this.stateProperties.next(t)}}let Cs=null;function ys(){return Cs||(Cs=new Ms),Cs}function Ps(){ys().inCompareMode=!1,ys().latestDisplayDataUsage=k.rvN.BASE}function As(){return ys().previewAlpha}function Os(){return!!ws()&&ys().previewAlpha>.5}function vs(){return Os()?fs.L.PREVIEW:fs.L.BASE}function Rs(){return ys().latestDisplayDataUsage===k.rvN.BASE&&!ys().inCompareMode}function ws(){return ys().inCompareMode}function _s(){return ys().latestDisplayDataUsage}function Ns(){const e=_s();return e===k.rvN.PREVIEW_BEFORE||e===k.rvN.PREVIEW_AFTER||e===k.rvN.PREVIEW_FINAL}function bs(){return _s()===k.rvN.PREVIEW_AFTER}function Ls(){return _s()===k.rvN.PREVIEW_FINAL}var Fs=i(31126);const xs=new Ni({diffuseFactor:.5,ambientFactor:.5}),Bs=new xi.hF({isPickable:!1,isTwoSided:!0,primitiveType:Di.MX.TRIANGLE_STRIP,isShowThrough:!0,isDepthTested:!1,priority:xi.DO.LOWER,material:xs}),Vs=new xi.hF({isPickable:!1,primitiveType:Di.MX.LINES});class Us extends Ti.u1{constructor(e,t){super(e),this.manipulatorId=t,this.sourcePrimitives=[],this.sourceIds=[]}initialize(e){return!(e.length<1)&&(!!this.createPreviewMeshes(e)&&!!this.updateMeshes())}duplicatePrimitive(e){const t=e.clone();return t.id="",e.points&&(t.points=new Float32Array(e.points)),t}createPreviewMeshes(e){this.sourcePrimitives=[];const t=X.default.getManager().getColor("FEATURE_FAST_PREVIEW_COLOR"),i=this.viewer.getModelViewManagers().getManager();return i&&e.forEach((e=>{const s=i.extractMeshIncrement(e);if(s){const i=this.duplicatePrimitive(s);i.colors=null,(0,Au.Ab)(t,i),this.sourcePrimitives.push(i),this.sourceIds.push(e)}})),this.sourceIds.length>=1}updateMeshes(){return!1}}var Gs=i(14293),Hs=i(54884);class ks extends Us{constructor(e,t){super(e,t),this.axisDirection=null,this.axisRoot=null,this.angle=0}setAngle(e){this.update(null,e)}update(e,t,i,s){return!(e&&!(0,Hs.Z)(e,this.sourceIds))&&(t&&(this.angle=t),i&&(this.axisRoot=i),s&&(this.axisDirection=s),this.updateMeshes())}updateMeshes(){let e,t,i,s,n;const r=ge.Jb.fromAngleAxis(this.angle,this.axisDirection,Gs.create());for(let a=0;a<this.sourceIds.length;++a){for(e=this.sourcePrimitives[a],t=this.duplicatePrimitive(e),i=this.sourceIds[a],s=0;s<e.points.length;s+=3){const i=C.fromValues(e.points[s],e.points[s+1],e.points[s+2]);for(ge.S4.subtract(i,this.axisRoot),ge.Jb.multiplyVec3(r,i),ge.S4.add(i,this.axisRoot),n=0;n<3;++n)t.points[s+n]=i[n]}t.isTriangles()?this.updateMeshIncrement(i,Ti.ZJ,t,Bs):this.updateMeshIncrement(i,Ti.ZJ,t,Vs)}return!0}}function Ws(e,t,i,s,n,r){const a=new ks(r,e);return a.axisRoot=s,a.axisDirection=n,a.angle=i,a.initialize(t)?a:null}class zs extends Us{constructor(e,t){super(e,t),this.direction=null,this.distance=0,this.offset=0}setDistance(e){this.update(null,null,e)}update(e,t,i,s){return!(e&&!(0,Hs.Z)(e,this.sourceIds))&&(t&&(this.direction=t),i&&(this.distance=i),void 0!==s&&(this.offset=s),this.updateMeshes())}updateMeshes(){let e,t,i,s,n;const r=C.create();ge.S4.scale(this.direction,this.distance+this.offset,r);for(let a=0;a<this.sourceIds.length;++a){for(e=this.sourcePrimitives[a],t=this.duplicatePrimitive(e),i=this.sourceIds[a],s=0;s<e.points.length;s+=3)for(n=0;n<3;++n)t.points[s+n]=e.points[s+n]+r[n];t.isTriangles()?this.updateMeshIncrement(i,Ti.ZJ,t,Bs):this.updateMeshIncrement(i,Ti.ZJ,t,Vs)}return!0}}function Xs(e,t,i,s,n,r){const a=new zs(n,e);return a.direction=i,a.distance=s,void 0!==r&&(a.offset=r),a.initialize(t)?a:null}const Zs=new xi.hF({isPickable:!1,primitiveType:Di.MX.LINES}),qs=new xi.hF({isPickable:!1,primitiveType:Di.MX.LINES,isShowThrough:!0,isDepthTested:!1}),Ys="LINE";class Ks extends Ti.u1{constructor(e,t,i,s){super(e),this.endpoint0=t,this.endpoint1=i,this.colorConstant=s,this.activeHighlights=new Map,this.updateGraphics()}onAppearanceConstantsUpdated(){this.updateGraphics()}getFitBounds(){return this.getMeshIncrement(Ys)?.getBounds()}addHighlightWithType(e){this.activeHighlights.has(e)||this.activeHighlights.set(e,this.addNewHighlightToIncrement(Ys,e))}removeHighlightWithType(e){if(!this.activeHighlights.has(e))return;const t=this.activeHighlights.get(e);this.removeHighlightFromIncrement(Ys,t),this.activeHighlights.delete(e)}updateGraphics(){const e=(0,Au.W5)(this.endpoint0,this.endpoint1,Ys,X.default.getManager().getColor(this.colorConstant));this.updateMeshIncrement(Ys,Ti.ZJ,e,Zs);const t=e.clone();(0,Au.KZ)(X.default.getManager().getStipple("LINE_SHOW_THROUGH_STIPLE"),t),this.updateMeshIncrement(Ys+".st",Ti.ZJ,t,qs)}}var js=i(84641),Qs=i(35692);const $s="box",Js=X.default.getManager();let en=!0;function tn(e){en=e}const sn=new xi.hF({isPickable:!1,primitiveType:Di.MX.LINES}),nn=new xi.hF({isPickable:!1,primitiveType:Di.MX.TRIANGLES,primitivesHaveTransparency:!0,material:bi});class rn extends Ti.u1{constructor(e){super(e,Zo.EG),this.mouseDown=[0,0],this.lastMouse=[0,0],this.canceled=!1,this.zoomCursorOnStack=!1,this.zoomTriggeredByMenu=!1,this.zoomModifier=!1,this.dragging=!1,this.listeningToKeyDispatcher=!1,this.listeningToOutsideClick=!1,this.mouseOnCanvas=!0,this.messageBubble=Ki.Jq.MessageBubbleService.createMessageBubble(),this.listenTo(this,Ti.zw.DRAG_START+$s,this.onDragStart),this.listenTo(this,Ti.zw.DRAG+$s,this.onDrag),this.listenTo(this,Ti.zw.DRAG_STOP+$s,this.onDragStop),this.zoomModeEnabledSubscription=(0,jo.Dx)().zoomModeEnabledObservable.subscribe((()=>this.onZoomModeChange()))}remove(){this.zoomModeEnabledSubscription.unsubscribe(),super.remove()}getPositionFromEvent(e){return[e.mouseX,e.camera.getViewportHeight()-e.mouseY]}performContainmentSelection(){return this.lastMouse[0]>this.mouseDown[0]}left(){return Math.min(this.lastMouse[0],this.mouseDown[0])}right(){return Math.max(this.lastMouse[0],this.mouseDown[0])}bottom(){return Math.min(this.lastMouse[1],this.mouseDown[1])}top(){return Math.max(this.lastMouse[1],this.mouseDown[1])}onDragStart(e,t,i){this.viewer.getSuppressModelSelection()?this.canceled=!0:(this.lastMouse=this.mouseDown=this.getPositionFromEvent(t),this.updateGraphics(),i.requestDrag=!0,this.canceled=!1,this.dragging=!0,this.listenToKeyDispatcher(),(0,Fs.vm)())}onDrag(e,t){this.canceled||(this.lastMouse=this.getPositionFromEvent(t),this.updateGraphics(),(0,Fs.vm)())}onDragStop(e,t){if(this.canceled)return;this.dragging=!1;const i=this.right()-this.left(),s=this.top()-this.bottom(),n=t.camera.getViewportHeight()-this.top();if(this.zoomIsEnabled())(0,jo.CR)(!1),this.viewer.animateZoomToRectangle(this.left(),n,i,s),this.removeMeshIncrements(),this.stopListeningToKeyDispatcher(),this.tearDownOutsideClickListeners();else{const e=this.viewer.performBoxSelection(this.left(),n,i,s,this.performContainmentSelection(),this.viewer.getInputHandler().getCtrlHeld()),t=this;e?e.then((function(){t.removeMeshIncrements(),t.stopListeningToKeyDispatcher()})):(t.removeMeshIncrements(),this.stopListeningToKeyDispatcher())}}onKeyDown(e){e.which===cs.R8.CANCEL&&this.cancelSelection()}outsideClickHandler(e){!this.mouseOnCanvas&&e&&e.target&&(0,jo.CR)(!1)}setupOutsideClickListeners(){this.listeningToOutsideClick||(this.mouseOnCanvas=!0,Qs(document).on("click.boxSelector",this.outsideClickHandler.bind(this)),this.listenTo(this.viewer.getEventDispatcher(),yD.ox,this.onMouseEnter),this.listenTo(this.viewer.getEventDispatcher(),yD.u5,this.onMouseLeave),this.listeningToOutsideClick=!0)}onMouseEnter(e){this.mouseOnCanvas=!0}onMouseLeave(e){this.mouseOnCanvas=!1}tearDownOutsideClickListeners(){this.listeningToOutsideClick&&(Qs(document).off("click.boxSelector"),this.listeningToOutsideClick=!1)}listenToKeyDispatcher(){this.listeningToKeyDispatcher||(this.listenTo((0,js.getDispatcher)(),js.Events.KEYDOWN,this.onKeyDown),this.listeningToKeyDispatcher=!0)}stopListeningToKeyDispatcher(){this.listeningToKeyDispatcher&&(this.stopListening((0,js.getDispatcher)()),this.listeningToKeyDispatcher=!1)}pushZoomCursor(){this.zoomCursorOnStack||(this.viewer.pushCursor(Nn.C.ZOOM_IN),this.zoomCursorOnStack=!0)}popZoomCursor(){this.zoomCursorOnStack&&(this.viewer.removeTopOccurrenceOfCursor(Nn.C.ZOOM_IN),this.zoomCursorOnStack=!1)}cancelSelection(){this.viewer.performingBoxSelection()?this.viewer.stopBoxSelection():(this.resetZoomState(),this.canceled=!0,this.removeMeshIncrements(),this.stopListeningToKeyDispatcher(),this.tearDownOutsideClickListeners()),this.dragging=!1}getVertex(e,t){return[e,t,0]}getBoxLineColor(){if(this.zoomIsEnabled())return Js.getColor("BOX_ZOOM_COLOR");return this.performContainmentSelection()?Js.getColor("BOX_SELECT_COLOR"):Js.getColor("CROSS_SELECT_COLOR")}getBoxStipple(){if(this.zoomIsEnabled())return Js.getStipple("BOX_ZOOM_LINE_STIPPLE");return this.performContainmentSelection()?Js.getStipple("BOX_SELECT_LINE_STIPPLE"):Js.getStipple("CROSS_SELECT_LINE_STIPPLE")}updateGraphics(){const e=(0,Au.pf)([this.getVertex(this.mouseDown[0],this.mouseDown[1]),this.getVertex(this.lastMouse[0],this.mouseDown[1]),this.getVertex(this.lastMouse[0],this.mouseDown[1]),this.getVertex(this.lastMouse[0],this.lastMouse[1]),this.getVertex(this.lastMouse[0],this.lastMouse[1]),this.getVertex(this.mouseDown[0],this.lastMouse[1]),this.getVertex(this.mouseDown[0],this.lastMouse[1]),this.getVertex(this.mouseDown[0],this.mouseDown[1])]);let t;this.left()!==this.right()&&this.bottom()!==this.top()&&(t=(0,Au.fQ)(this.getVertex(this.left(),this.bottom()),this.getVertex(this.right(),this.bottom()),this.getVertex(this.left(),this.top())));const i=this.getBoxLineColor(),s=this.getBoxStipple();if((0,Au.Ab)(i,e),(0,Au.KZ)(s,e),(0,Au.VQ)(Js.getNumber("BOX_SELECT_LINE_WIDTH"),e),this.updateMeshIncrement("lines",Ti.ZJ,e,sn),t){const e=i.slice(0);e[3]=Js.getNumber("BOX_SELECT_INFILL_OPACITY"),(0,Au.Ab)(e,t),this.updateMeshIncrement("interior",Ti.ZJ,t,nn)}else this.removeMeshIncrement("interior")}triggerDragStart(e,t){const i=!!(0,Ce.VT)()&&(0,Ce.VT)().getIsAQueryList()&&1===(0,Ce.HP)();return!!(this.zoomIsEnabled()||en&&!i)&&super.triggerDragStart(e,t)}zoomIsEnabled(){return(0,jo.Fo)()}startZoom(){this.pushZoomCursor()}stopZoom(){this.popZoomCursor()}resetZoomState(){(0,jo.CR)(!1)}showZoomMessage(){this.messageBubble.showMessage(i18n("Drag to create zoom bounding box."))}dismissZoomMessage(){this.messageBubble.dismissMessage()}onZoomModeChange(){this.zoomIsEnabled()?(this.startZoom(),this.listenToKeyDispatcher(),this.setupOutsideClickListeners(),this.dragging?this.updateGraphics():this.showZoomMessage()):(this.dragging&&this.updateGraphics(),this.stopListeningToKeyDispatcher(),this.stopZoom(),this.tearDownOutsideClickListeners(),this.dismissZoomMessage())}}const an=X.default.getManager(),on=new xi.hF({isPickable:!1,primitiveType:Di.MX.LINES});class hn extends Ti.u1{constructor(e){super((0,j.as)(eT,e),Zo.EG),this.mousePositions=[],this.color=an.getColor("SKETCH_DRAG_TRIM_PATH_COLOR"),this.number=an.getNumber("SKETCH_DRAG_TRIM_PATH_WIDTH"),this.newLineSegment=!0}onAppearanceConstantsUpdated(){this.color=an.getColor("SKETCH_DRAG_TRIM_PATH_COLOR"),this.updateGraphics()}reset(){this.mousePositions=[],this.newLineSegment=!0,this.updateGraphics(),this.viewer.forceRequestDraw()}addPositionToDragTrimLine(e){const t=this.viewer.getCanvasCoordinateFromEvent(e);this.updateMousePositionsWithDragEvent(t),this.updateGraphics(),(0,Fs.vm)()}makeNewLineSegment(){this.newLineSegment=!0}updateMousePositionsWithDragEvent(e){const t=new k.YFv;t.updateFromArray(this.viewer.getCamera().viewportToCanvas(e)),this.newLineSegment||this.mousePositions.length%2!=0?(this.mousePositions.push(t),this.newLineSegment=!1):this.mousePositions[this.mousePositions.length-1].equals(t)||(this.mousePositions.push(this.mousePositions[this.mousePositions.length-1]),this.mousePositions.push(t))}updateGraphics(){if(this.mousePositions.length%2!=0)return;const e=(0,Au.pf)(this.mousePositions.map((e=>[e.x,e.y,0])),"dragTrimLine",this.color,this.number);this.updateMeshIncrement("lines",Ti.ZJ,e,on)}}var cn=i(43693),ln=i(37951),un=i(90316),dn=i(44398);var gn,pn;!function(e){e[e.OPERATION_PERSISTENT=0]="OPERATION_PERSISTENT",e[e.UI=1]="UI",e[e.FILTERED_ENTITIES=2]="FILTERED_ENTITIES",e[e.ACCUMULATED_SMART_SELECTION=3]="ACCUMULATED_SMART_SELECTION",e[e.SMART_SELECTION=4]="SMART_SELECTION",e[e.INCONTEXT_REFERENCE_PRE=5]="INCONTEXT_REFERENCE_PRE",e[e.ASSOCIATED_OCCURRENCE_PRE=6]="ASSOCIATED_OCCURRENCE_PRE",e[e.OCCURRENCE_SECONDARY_PRE=7]="OCCURRENCE_SECONDARY_PRE",e[e.PROFILE_INSPECTOR=8]="PROFILE_INSPECTOR",e[e.PROFILE_INSPECTOR_FOCUS=9]="PROFILE_INSPECTOR_FOCUS",e[e.PRE=10]="PRE",e[e.OCCURRENCE_PRE=11]="OCCURRENCE_PRE",e[e.COMMENT=12]="COMMENT",e[e.INCONTEXT_REFERENCE=13]="INCONTEXT_REFERENCE",e[e.OCCURRENCE_COMMENT=14]="OCCURRENCE_COMMENT",e[e.UI_RELATED_ENTITY=15]="UI_RELATED_ENTITY",e[e.ASSOCIATED_OCCURRENCE=16]="ASSOCIATED_OCCURRENCE",e[e.RELATED_OCCURRENCE=17]="RELATED_OCCURRENCE",e[e.OCCURRENCE=18]="OCCURRENCE",e[e.PART=19]="PART",e[e.FEATURE=20]="FEATURE",e[e.ENTITY=21]="ENTITY",e[e.ERROR=22]="ERROR",e[e.SECONDARY_PRE=23]="SECONDARY_PRE",e[e.SECONDARY=24]="SECONDARY",e[e.RETRIEVAL=25]="RETRIEVAL",e[e.REPAIR=26]="REPAIR",e[e.REPAIR_HOVER=27]="REPAIR_HOVER"}(gn||(gn={})),function(e){e[e.NO_HIGHLIGHT=0]="NO_HIGHLIGHT",e[e.HIGHLIGHT=1]="HIGHLIGHT",e[e.SUPPRESS_INTERIOR=2]="SUPPRESS_INTERIOR"}(pn||(pn={}));class mn{constructor(e,t,i,s,n,r){this.type=e,this.priority=t,this.color1=[0,0,0,0],this.colorBorder=[0,0,0,0],this.indexInstanceIdColor=[0,0,0,pn.HIGHLIGHT/255],this.style=null,this.index=0,this.idString="",this.debugStack=null,this.usage=fs.L.BASE,this.associatedPrimaryHighlightType=r||null,this.outlineOverlappingInteriorRegions=this.type===dn.o2.ENTITY||this.type===dn.o2.SMART_SELECTION||this.type===dn.o2.ACCUMULATED_SMART_SELECTION,this.forOccurrences=this.type===dn.o2.OCCURRENCE||this.type===dn.o2.OCCURRENCE_PRE||this.type===dn.o2.OCCURRENCE_COMMENT||this.type===dn.o2.OCCURRENCE_SECONDARY_PRE||this.type===dn.o2.RELATED_OCCURRENCE||this.type===dn.o2.RELATED_OCCURRENCE_MATE||this.type===dn.o2.ASSOCIATED_OCCURRENCE||this.type===dn.o2.ASSOCIATED_OCCURRENCE_PRE||this.type===dn.o2.RETRIEVAL||this.type===dn.o2.OPERATION_PERSISTENT,this.updateColors(),void 0!==i&&this.setIndex(i),this.instanceId=Si.JE,void 0!==s&&this.setInstanceId(s),this.occurrence=n}updateColors(e){const t=X.default.getManager();if(this.color1=t.getColor(this.type+"_HIGHLIGHT_COLOR1"),this.colorBorder=t.getColor(this.type+"_HIGHLIGHT_COLOR_BORDER"),e)for(let t=0;t<3;t++)this.color1[t]=e[t],this.colorBorder[t]=e[t]}getIdString(){return this.idString}cloneForOccurrence(e){return new mn(this.type,this.priority,this.index,this.instanceId,e,this.associatedPrimaryHighlightType)}cloneForInstance(e){return new mn(this.type,this.priority,this.index,e,this.occurrence,this.associatedPrimaryHighlightType)}setIndex(e){this.index=e,this.updateIndexInstanceColor()}setInstanceId(e){this.instanceId=e,this.idString=this.type+"."+this.instanceId,this.updateIndexInstanceColor()}getInstanceNumber(){return(0,Si.rp)(this.instanceId)?Math.max(255&this.instanceId[0],1):0}updateIndexInstanceColor(){this.indexInstanceIdColor[0]=(255&this.index)/255;const e=this.getInstanceNumber();this.indexInstanceIdColor[1]=(e>>>4&15)/255,this.indexInstanceIdColor[2]=(15&e)/255}getStyle(){return this.style||(this.style=new XI.bg,this.style.setAttribute(sE.HIGHLIGHT_ID,this.indexInstanceIdColor)),this.style}getIndexInstanceEncodedInFloat(){return this.index+256*this.getInstanceNumber()}}function fn(e,t){return e.type===t.type&&e.instanceId===t.instanceId&&e.associatedPrimaryHighlightType===t.associatedPrimaryHighlightType&&(0,ln.wB)(e.occurrence,t.occurrence)}function In(e){e[dn.o2.UI]=new mn(dn.o2.UI,gn.UI),e[dn.o2.RELATED_OCCURRENCE]=new mn(dn.o2.RELATED_OCCURRENCE,gn.RELATED_OCCURRENCE),e[dn.o2.RELATED_OCCURRENCE_MATE]=new mn(dn.o2.RELATED_OCCURRENCE_MATE,gn.RELATED_OCCURRENCE),e[dn.o2.ACCUMULATED_SMART_SELECTION]=new mn(dn.o2.ACCUMULATED_SMART_SELECTION,gn.ACCUMULATED_SMART_SELECTION),e[dn.o2.SMART_SELECTION]=new mn(dn.o2.SMART_SELECTION,gn.SMART_SELECTION),e[dn.o2.UI_RELATED_ENTITY]=new mn(dn.o2.UI_RELATED_ENTITY,gn.ENTITY),e[dn.o2.ENTITY]=new mn(dn.o2.ENTITY,gn.ENTITY),e[dn.o2.FEATURE]=new mn(dn.o2.FEATURE,gn.FEATURE),e[dn.o2.PART]=new mn(dn.o2.PART,gn.PART),e[dn.o2.OCCURRENCE]=new mn(dn.o2.OCCURRENCE,gn.OCCURRENCE),e[dn.o2.OCCURRENCE_PRE]=new mn(dn.o2.OCCURRENCE_PRE,gn.OCCURRENCE_PRE),e[dn.o2.PRE]=new mn(dn.o2.PRE,gn.PRE),e[dn.o2.SECONDARY]=new mn(dn.o2.SECONDARY,gn.SECONDARY),e[dn.o2.SECONDARY_PRE]=new mn(dn.o2.SECONDARY_PRE,gn.SECONDARY_PRE),e[dn.o2.OCCURRENCE_SECONDARY_PRE]=new mn(dn.o2.OCCURRENCE_SECONDARY_PRE,gn.OCCURRENCE_SECONDARY_PRE),e[dn.o2.COMMENT]=new mn(dn.o2.COMMENT,gn.COMMENT),e[dn.o2.FILTERED_ENTITIES]=new mn(dn.o2.FILTERED_ENTITIES,gn.FILTERED_ENTITIES),e[dn.o2.OCCURRENCE_COMMENT]=new mn(dn.o2.OCCURRENCE_COMMENT,gn.OCCURRENCE_COMMENT),e[dn.o2.ASSOCIATED_OCCURRENCE]=new mn(dn.o2.ASSOCIATED_OCCURRENCE,gn.ASSOCIATED_OCCURRENCE),e[dn.o2.ASSOCIATED_OCCURRENCE_PRE]=new mn(dn.o2.ASSOCIATED_OCCURRENCE_PRE,gn.ASSOCIATED_OCCURRENCE_PRE),e[dn.o2.ERROR]=new mn(dn.o2.ERROR,gn.ERROR),e[dn.o2.INCONTEXT_REFERENCE]=new mn(dn.o2.INCONTEXT_REFERENCE,gn.INCONTEXT_REFERENCE),e[dn.o2.INCONTEXT_REFERENCE_PRE]=new mn(dn.o2.INCONTEXT_REFERENCE_PRE,gn.INCONTEXT_REFERENCE_PRE),e[dn.o2.RETRIEVAL]=new mn(dn.o2.RETRIEVAL,gn.RETRIEVAL),e[dn.o2.OPERATION_PERSISTENT]=new mn(dn.o2.OPERATION_PERSISTENT,gn.OPERATION_PERSISTENT),e[dn.o2.REPAIR]=new mn(dn.o2.REPAIR,gn.REPAIR),e[dn.o2.REPAIR_HOVER]=new mn(dn.o2.REPAIR_HOVER,gn.REPAIR_HOVER),e[dn.o2.PROFILE_INSPECTOR]=new mn(dn.o2.PROFILE_INSPECTOR,gn.PROFILE_INSPECTOR),e[dn.o2.PROFILE_INSPECTOR_FOCUS]=new mn(dn.o2.PROFILE_INSPECTOR_FOCUS,gn.PROFILE_INSPECTOR_FOCUS)}function En(e,t){for(const i in e)t.push(e[i]);t.sort((function(e,t){return e.priority>t.priority?1:e.priority<t.priority?-1:0}));for(let e=0;e<t.length;++e)t[e].setIndex(e)}class Sn{constructor(e){this.viewer=e,this.highlights={},this.sortedHighlights=[],(0,Jo.Yk)(e),In(this.highlights),En(this.highlights,this.sortedHighlights)}getSortedHighlights(){return this.sortedHighlights}getHighlightTextureWidth(){return this.sortedHighlights.length}updateHighlightColor(e,t){this.highlights[e].updateColors(t),this.viewer.getResources().invalidateHighlightTexture()}destroy(){this.highlights={},this.sortedHighlights=[]}}class Tn{constructor(e){this.referenceHighlights=e,this.highlightInstanceIdManagers={},this.highlightToSelectionToInstanceId={},this.usage=fs.L.BASE;for(const e in dn.o2)this.highlightInstanceIdManagers[e]=new Si.si(Si._6.HIGHLIGHT),this.highlightToSelectionToInstanceId[e]={}}getInstanceIdForHighlightAndSelection(e,t){const i=this.highlightToSelectionToInstanceId[e][t];return i||Si.JE}constructHighlightForTypeAndInstance(e,t,i=!1){const s=this.referenceHighlights.highlights[e].cloneForInstance(t);if(s.usage=this.usage,i){(255*s.indexInstanceIdColor[3]&pn.SUPPRESS_INTERIOR)>0||(s.indexInstanceIdColor[3]+=pn.SUPPRESS_INTERIOR/255)}return s}createHighlightForSelection(e,t,i=!1){if(!this.referenceHighlights)return new mn(dn.o2.ERROR,gn.ERROR);let s=this.getInstanceIdForHighlightAndSelection(e,t);return(0,Si.rp)(s)||(s=this.highlightInstanceIdManagers[e].getId(),this.highlightToSelectionToInstanceId[e][t]=s),this.constructHighlightForTypeAndInstance(e,s,i)}freeHighlightForSelection(e,t){const i=this.getInstanceIdForHighlightAndSelection(e,t);return(0,Si.rp)(i)&&(this.highlightInstanceIdManagers[e].freeId(i),delete this.highlightToSelectionToInstanceId[e][t]),i}createSecondaryHighlight(e,t,i){const s=this.createHighlightForSelection(e,i+un.ID_SEPARATOR+t);return s.associatedPrimaryHighlightType=t,s}freeSecondaryHighlight(e,t,i){this.freeHighlightForSelection(e,i+un.ID_SEPARATOR+t)}resetHighlightInstanceIds(e){this.highlightInstanceIdManagers[e].reset(),this.highlightToSelectionToInstanceId[e]={}}highlightHasSelections(e){return!(0,Fs.hW)(this.highlightToSelectionToInstanceId[e])}}function Dn(e,t){let i=0;for(let s=0;s<t.length;++s){if(fn(t[s],e))return-1;if(e.priority<t[s].priority)break;++i}return t.splice(i,0,e),i}function Mn(e,t,i){let s=-1;for(let n=0;n<t.length;++n)if(i&&e.type===t[n].type||fn(t[n],e)){s=n;break}return s<0||t.splice(s,1),s}var Cn,yn=i(51372),Pn=i(53574);!function(e){e[e.OVERDEFINED=1]="OVERDEFINED",e[e.EXTERNAL_AND_OK=2]="EXTERNAL_AND_OK",e[e.OK=3]="OK",e[e.DRIVEN=4]="DRIVEN"}(Cn||(Cn={}));const An=function(e){const t=this.viewer.getReferenceHighlights(),i=new Uint8Array(4*t.sortedHighlights.length);for(let e=0;e<t.sortedHighlights.length;e++){const s=(0,Fs.Db)(t.sortedHighlights[e].color1);for(let t=0;t<4;t++)i[4*e+t]=s[t]}const s=new ja(e);return s.bytes=i,s.width=i.length/4,s.height=1,s},On={isVisible:!0,isTwoSided:!0,priority:xi.DO.HIGHER,primitiveType:Di.MX.TRIANGLES,isShowThrough:!0,isDepthTested:!1},vn={isVisible:!0,isTwoSided:!0,priority:xi.DO.HIGHER,primitiveType:Di.MX.TRIANGLES,isShowThrough:!0,isDepthTested:!1},Rn=X.default.getManager();class wn extends m.T{constructor(e){super(),this.viewer=e,this.blitQuad=null,this.highlightColorTexture=null,this.blankTexture=null,this.primitiveRestartBuffer=null,this.constraintAtlas=null,this.typeToNodeProperties={},this.constraintAtlasCreationInitiated=!1,this.constraintAtlasCreationId=0,this.commentIndicatorAtlas=null,this.commentIndicatorAtlasCreationInitiated=!1,this.dimensionAtlas=null,this.dimensionAtlasCreationInitiated=!1,this.dimensionAtlasCreationId=-1,this.mbdAtlas=null,this.mbdAtlasCreationInitiated=!1,this.mbdAtlasCreationId=-1,this.centerOfMassIndicatorNodeProperties=null,this.scalarVisualizationTextures=new Map,this.imageTextureCache=new Map,this.PART_SURFACE_LINE_POINT_MATERIAL=new Ni({color:Rn.getColor("LINE_POINT_COLOR")}),this.WIRE_LINE_POINT_MATERIAL=new Ni({color:Rn.getColor("LINE_POINT_COLOR")}),this.PART_EDGE_NODE_PROPERTIES=new xi.hF({debugId:"PartEdges",material:this.PART_SURFACE_LINE_POINT_MATERIAL,zOffset:Rn.getNumber("PART_EDGES_Z_OFFSET"),primitiveType:Di.MX.LINES,addsToBounds:!1,includedInBlend:!0,clippedBySectionPlanes:!0}),this.TRANSLUCENT_PART_EDGE_NODE_PROPERTIES=this.PART_EDGE_NODE_PROPERTIES.cloneAndModify({debugId:"TranslucentPartEdges",primitivesHaveTransparency:!0,includedInBlend:!1,isStencilWritten:!1}),this.SURFACE_EDGE_NODE_PROPERTIES=this.PART_EDGE_NODE_PROPERTIES.cloneAndModify({debugId:"SurfaceEdges",zOffset:Rn.getNumber("SURFACE_EDGES_Z_OFFSET")}),this.TRANSLUCENT_SURFACE_EDGE_NODE_PROPERTIES=this.SURFACE_EDGE_NODE_PROPERTIES.cloneAndModify({debugId:"TranslucentSurfaceEdges",primitivesHaveTransparency:!0,isStencilWritten:!1}),this.WIRE_EDGE_NODE_PROPERTIES=this.PART_EDGE_NODE_PROPERTIES.cloneAndModify({material:this.WIRE_LINE_POINT_MATERIAL,zOffset:Rn.getNumber("WIRE_EDGES_Z_OFFSET"),addsToBounds:!0}),this.PART_EDGE_NODE_PROPERTIES_NON_MODIFIABLE=this.PART_EDGE_NODE_PROPERTIES.cloneAndModify({zOffset:Rn.getNumber("NON_MODIFIABLE_Z_OFFSET_EDGE")}),this.SURFACE_EDGE_NODE_PROPERTIES_NON_MODIFIABLE=this.SURFACE_EDGE_NODE_PROPERTIES.cloneAndModify({zOffset:Rn.getNumber("NON_MODIFIABLE_Z_OFFSET_EDGE")}),this.SMOOTH_EDGE_MATERIAL=new Ni({}),this.TRANSLUCENT_PART_SMOOTH_EDGE_NODE_PROPERTIES=this.TRANSLUCENT_PART_EDGE_NODE_PROPERTIES.cloneAndModify({debugId:"TranslucentPartSmoothEdges",material:this.SMOOTH_EDGE_MATERIAL}),this.TRANSLUCENT_SURFACE_SMOOTH_EDGE_NODE_PROPERTIES=this.TRANSLUCENT_SURFACE_EDGE_NODE_PROPERTIES.cloneAndModify({debugId:"TranslucentSurfaceSmoothEdges",material:this.SMOOTH_EDGE_MATERIAL}),this.PART_SMOOTH_EDGE_NODE_PROPERTIES=this.PART_EDGE_NODE_PROPERTIES.cloneAndModify({debugId:"PartSmoothEdges",material:this.SMOOTH_EDGE_MATERIAL}),this.SURFACE_SMOOTH_EDGE_NODE_PROPERTIES=this.SURFACE_EDGE_NODE_PROPERTIES.cloneAndModify({debugId:"SurfaceSmoothEdges",material:this.SMOOTH_EDGE_MATERIAL}),this.PART_SMOOTH_EDGE_NODE_PROPERTIES_NON_MODIFIABLE=this.PART_EDGE_NODE_PROPERTIES_NON_MODIFIABLE.cloneAndModify({debugId:"PartSmoothEdgesNonModifiable",material:this.SMOOTH_EDGE_MATERIAL}),this.SURFACE_SMOOTH_EDGE_NODE_PROPERTIES_NON_MODIFIABLE=this.SURFACE_EDGE_NODE_PROPERTIES_NON_MODIFIABLE.cloneAndModify({debugId:"SurfaceSmoothEdgesNonModifiable",material:this.SMOOTH_EDGE_MATERIAL}),this.WIRE_EDGE_NODE_PROPERTIES_NON_MODIFIABLE=this.WIRE_EDGE_NODE_PROPERTIES.cloneAndModify({zOffset:Rn.getNumber("NON_MODIFIABLE_Z_OFFSET_EDGE")}),this.CENTER_LINE_MATERIAL=new Ni({color:Rn.getColor("LINE_POINT_COLOR"),lineStipple:Rn.getStipple("CENTER_LINE_STIPPLE")}),this.CENTER_LINE_NODE_PRPOPERTIES=this.WIRE_EDGE_NODE_PROPERTIES.cloneAndModify({material:this.CENTER_LINE_MATERIAL}),this.SILHOUETTE_NODE_PROPERTIES=new xi.hF({material:this.PART_SURFACE_LINE_POINT_MATERIAL,zOffset:Rn.getNumber("PART_EDGES_Z_OFFSET"),primitiveType:Di.MX.SILHOUETTES,addsToBounds:!1,includedInBlend:!0,clippedBySectionPlanes:!0}),this.TRANSLUCENT_SILHOUETTE_NODE_PROPERTIES=this.SILHOUETTE_NODE_PROPERTIES.cloneAndModify({primitivesHaveTransparency:!0}),(0,Jo.Yk)(e),this.constraintMaterial=Fi(),(0,ot.Z)(Cn,(e=>{this.typeToNodeProperties[e]=new xi.hF({isPickable:!0,primitiveType:Di.MX.TRIANGLES,material:this.constraintMaterial,isVisible:!0,zOffset:e})})),this.inferenceNodeProperties=new xi.hF({isPickable:!1,primitiveType:Di.MX.TRIANGLES,material:this.constraintMaterial,isVisible:!0,zOffset:0}),this.listenTo(this.viewer.getEventDispatcher(),yD.pO,this.onGlContextRestored),this.commentIndicatorMaterial=Fi(),this.commentIndicatorNodeProperties=new xi.hF({primitiveType:Di.MX.TRIANGLES,material:this.commentIndicatorMaterial}),this.dimensionMaterial=Fi(),this.dimensionNodeProperties=[new xi.hF(Object.assign({isPickable:!0,material:this.dimensionMaterial},On)),new xi.hF(Object.assign({isPickable:!1,material:this.dimensionMaterial},On))],this.mbdAtlasMaterial=Fi(),this.mbdAtlasNodeProperties=[new xi.hF(Object.assign({isPickable:!0,material:this.mbdAtlasMaterial},vn)),new xi.hF(Object.assign({isPickable:!0,material:this.mbdAtlasMaterial},vn))],this.initializeBodyEdgeResources()}initializeBodyEdgeResources(){}onGlContextRestored(){this.constraintAtlas&&(this.constraintMaterial.ambientTexture=this.constraintAtlas.texture)}reset(){this.blitQuad&&(this.blitQuad.remove(),this.blitQuad=null),this.blankTexture&&(this.blankTexture.destroy(),this.blankTexture=null),this.invalidateHighlightTexture(),this.constraintMaterial.destroy(),this.mateIndicatorGlyphResources&&this.mateIndicatorGlyphResources.destroy(),this.loadGlyphResources&&this.loadGlyphResources.destroy(),this.commentIndicatorMaterial.destroy(),this.dimensionMaterial.destroy(),this.stopListening(),this.primitiveRestartBuffer&&(this.primitiveRestartBuffer.destroy(),this.primitiveRestartBuffer=null)}getBlitNode(){if(!this.blitQuad){const e=new xi.hF({primitiveType:Di.MX.TRIANGLES,isPickable:!0,isTwoSided:!0,material:null});this.blitQuad=new qT([-1,-1,0],[1,-1,0],[-1,1,0],e,this.viewer,"blit"),this.blitQuad.getOccurrenceData().setShouldSetOccurrenceUniform(!1)}return this.blitQuad.getNode()}getHighlightTexture(){return this.highlightColorTexture||(this.highlightColorTexture=new $a(this.viewer,An)),this.highlightColorTexture}invalidateHighlightTexture(){this.highlightColorTexture&&(this.highlightColorTexture.destroy(),this.highlightColorTexture=null)}getBlankTexture(){if(!this.blankTexture){const e=this.viewer.getGlContext(),t=new ja(e);t.width=2,t.height=2,t.bytes=new Uint8Array(t.width*t.height*4),this.blankTexture=new $a(this.viewer,t)}return this.blankTexture}getImageTexture(e){let t=this.imageTextureCache.get(e);if(!t){const i=this.viewer.getGlContext(),s=new ja(i);s.imageSource=e,s.wrapS=i.CLAMP_TO_EDGE,s.wrapT=i.CLAMP_TO_EDGE,t=new $a(this.viewer,s),t.hasTransparency=!1,this.imageTextureCache.set(e,t)}return t}onDevicePixelRatioChanged(e){e||(this.resetConstraintAtlas(),this.resetDimensionAtlas(),this.loadGlyphResources?.onDevicePixelRatioChanged(),this.resetMbdAtlas())}onAppearanceConstantsUpdated(){this.resetConstraintAtlas(),this.resetDimensionAtlas(),this.loadGlyphResources?.reinitialize(),this.updateBodyEdgeColors(),this.updateSmoothEdgeMaterial(),this.resetMbdAtlas()}resetConstraintAtlas(){this.constraintAtlasCreationInitiated=!1,this.constraintAtlas&&(this.constraintAtlas.destroy(),this.constraintAtlas=null),this.viewer.getTextureAtlasFactory().clearAtlas(pM.GH)}resetDimensionAtlas(){this.dimensionAtlasCreationInitiated=!1,this.dimensionAtlas&&(this.dimensionAtlas.destroy(),this.dimensionAtlas=null),this.viewer.getTextureAtlasFactory().clearAtlas(pM.Xh)}resetMbdAtlas(){this.mbdAtlasCreationInitiated=!1,this.mbdAtlas&&(this.mbdAtlas.destroy(),this.mbdAtlas=null),this.viewer.getTextureAtlasFactory().clearAtlas(pM.di)}onRenderingModeChanged(){this.updateBodyEdgeColors(),this.updateSmoothEdgeMaterial()}updateBodyEdgeColors(){switch(this.viewer.getRenderingMode()){case k.P1.HIDDEN_LINE_REMOVED:case k.P1.HIDDEN_LINE_VISIBLE:case k.P1.WIREFRAME:this.PART_SURFACE_LINE_POINT_MATERIAL.color=Rn.getColor("UNSHADED_BODY_LINE_COLOR"),this.CENTER_LINE_MATERIAL.color=Rn.getColor("UNSHADED_BODY_LINE_COLOR");break;default:this.PART_SURFACE_LINE_POINT_MATERIAL.color=Rn.getColor("LINE_POINT_COLOR"),this.CENTER_LINE_MATERIAL.color=Rn.getColor("LINE_POINT_COLOR")}}updateSmoothEdgeMaterial(){const e=this.viewer.getSmoothEdgesRenderStyle(),t=X.default.getManager();switch(e){case k.YUG.HIDDEN:return void(this.SMOOTH_EDGE_MATERIAL.isVisible=!1);case k.YUG.PHANTOM:this.SMOOTH_EDGE_MATERIAL.lineStipple=t.getStipple("SMOOTH_EDGE_STIPPLE"),this.SMOOTH_EDGE_MATERIAL.lineWidth=t.getNumber("SMOOTH_EDGE_LINE_WIDTH");break;case k.YUG.VISIBLE:this.SMOOTH_EDGE_MATERIAL.lineStipple=t.getStipple("DEFAULT_LINE_STIPPLE"),this.SMOOTH_EDGE_MATERIAL.lineWidth=t.getNumber("DEFAULT_LINE_WIDTH")}this.SMOOTH_EDGE_MATERIAL.isVisible=!0;const i=this.viewer.getRenderingMode(),s=e===k.YUG.PHANTOM;switch(i){case k.P1.HIDDEN_LINE_REMOVED:case k.P1.HIDDEN_LINE_VISIBLE:case k.P1.WIREFRAME:this.SMOOTH_EDGE_MATERIAL.color=t.getColor("UNSHADED_BODY_LINE_COLOR");break;default:this.SMOOTH_EDGE_MATERIAL.color=s?t.getColor("SMOOTH_EDGE_PHANTOM_COLOR"):t.getColor("LINE_POINT_COLOR")}}}const _n={nodePropertiesTypes:Cn};_n.nodePropertiesTypes=Cn;var Nn=i(76618);const bn=X.default.getManager().getColor("DEFAULT_MATERIAL_COLOR"),Ln=function(e){return e===(0,Ce.Wf)()};class Fn{constructor(e,t,i){this.pointElement=e,this.highlight=t,this.isPreSelection=i}}class xn extends m.T{constructor(e){super(),this.viewer=e,this.meshPoints={},(0,Jo.Yk)(e),this.addMultipleSelections((0,Ce.Wf)()),this.addMultipleSelections((0,Ce.vi)()),this.resetSelectionListHandlers()}resetSelectionListHandlers(){this.listenTo((0,Ce.Wf)(),"add",this.onSelectionAdded),this.listenTo((0,Ce.Wf)(),"remove",this.onSelectionRemoved),this.listenTo((0,Ce.Wf)(),"reset",this.onSelectionReset),this.listenTo((0,Ce.vi)(),"add",this.onSelectionAdded),this.listenTo((0,Ce.vi)(),"remove",this.onSelectionRemoved),this.listenTo((0,Ce.vi)(),"reset",this.onSelectionReset)}onSelectionAdded(e,t){this.addSelection(e,t)}onSelectionReset(e){this.deleteAllMeshPoints(Ln(e)),this.addMultipleSelections(e)}onSelectionRemoved(e,t){this.removeSelection(e,t)}addMultipleSelections(e){e.each((t=>{this.addSelection(t,e)}))}deleteAllMeshPoints(e){Object.entries(this.meshPoints).forEach((([t,i])=>{i.isPreSelection===e&&this.deleteMeshPoint(t)}))}removeSelection(e,t){if(!e||!e.isMeshPoint()||!(e.id in this.meshPoints))return;Ln(t)===this.meshPoints[e.id].isPreSelection&&this.deleteMeshPoint(e.id)}deleteMeshPoint(e){if(e in this.meshPoints){const t=this.meshPoints[e].pointElement,i=this.meshPoints[e].highlight;this.viewer.getHighlightManager(fs.L.BASE).freeHighlightForSelection(i.type,e),t.removeHighlight(i),t.remove(),delete this.meshPoints[e]}}addSelection(e,t){if(!e||!e.isMeshPoint())return;const i=Ln(t);if(e.id in this.meshPoints){if(i)return;this.deleteMeshPoint(e.id)}const s=this.viewer.getHighlightManager(fs.L.BASE).createHighlightForSelection(function(e){return Ln(e)?dn.o2.PRE:dn.o2.ENTITY}(t),e.id),n=e.sourcePick?this.viewer.getOccurrenceDataManager().getOccurrenceTransform(e.sourcePick.getOccurrenceId()):null,r=function(e,t,i,s){if(!e)return null;let n=C.clone(e);s&&(n=ge.w$.multiplyVec3(s,n));const r=new Zl(n,Zo.lL,bn,0,i);return r.addHighlight(t),r}(e.getMeshPointData().point,s,this.viewer,n);r&&(this.meshPoints[e.id]=new Fn(r,s,i))}destroy(){this.deleteAllMeshPoints(!0),this.deleteAllMeshPoints(!1),this.stopListening()}}var Bn=i(67914);const Vn=X.default.getManager(),Un="image";class Gn extends Ti.u1{constructor(e,t,i,s,n,r,a,o,h,c,l){super(o,a===fs.L.PREVIEW?Zo.Vv:void 0),this.sketchEntityId=e,this.bottomLeftCorner=i,this.bottomRightCorner=s,this.topLeftCorner=n,this.texture=r,this.usage=a,this.isOnFlat=h,this.flattenedBodyId=c,this.transform=l,this.ownsTexture=!1,this.material=null,this.isActive=!1,this.id="image",this.url=(0,Bn.e)(t),this.listenTo(this,Ti.zw.CLICK+Un,this.onClick),this.updateImage(t,i,s,n),this.occurrenceData.setCanIsolateChange(!0)}getSource(){return{documentId:(0,Bn.a)(this.url,"/d/"),elementId:(0,Bn.a)(this.url,"/e/"),documentVersionId:(0,Bn.a)(this.url,"/v/")}}updateImage(e,t,i,s){const n=this.viewer.getGlContext();let r=(0,Bn.e)(e);if(r||(r=this.url),this.url=r,this.bottomLeftCorner=t,this.bottomRightCorner=i,this.topLeftCorner=s,!r)return void this.removeMeshIncrement("image");if(!n)return;if(this.texture&&this.url!==r&&(this.texture.destroy(),this.texture=null,this.material&&(this.material.destroy(),this.material=null)),!this.texture){const e=new ja(n);e.imageSource=r,e.minificationFilter=n.LINEAR,e.magnificationFilter=n.LINEAR,e.defersRendering=!0,this.texture=new $a(this.viewer,e),this.ownsTexture=!0}this.material||(this.material=Fi(this.texture));const a=new xi.hF({primitiveType:Di.MX.TRIANGLES,isPickable:this.isActive,isDepthTested:!1,isTwoSided:!0,includedInBlend:!0,material:this.material}),o=(0,Au.fQ)(this.bottomLeftCorner,this.bottomRightCorner,this.topLeftCorner,void 0,[0,1],[1,0]).createTransformed(this.transform),h=this.isActive?Vn.getNumber("SKETCH_IMAGE_ACTIVE_OPACITY"):Vn.getNumber("SKETCH_IMAGE_INACTIVE_OPACITY");(0,Au.Ab)([1,1,1,h],o),this.updateMeshIncrement(Un,Un,o,a),this.isHidden&&this.hideIncrements()}remove(){this.texture&&this.ownsTexture&&(this.texture.destroy(),this.texture=null,this.ownsTexture=!1),this.material&&(this.material.destroy(),this.material=null),super.remove()}getUsage(){return this.usage}onClick(e,t){(0,Ce.MO)({resetOptions:{isFromEmptyPick:!0,pickOptions:t}})}getPickPriority(e){return qm.z.SKETCH_FACE}cloneForPreview(){const e=new Gn(this.sketchEntityId,this.url,this.bottomLeftCorner,this.bottomRightCorner,this.topLeftCorner,this.texture,fs.L.PREVIEW,this.viewer,this.isOnFlat,this.flattenedBodyId,this.transform);return this.isHidden&&e.hide(),this.isActive&&e.activate(),e}activate(){this.isActive=!0,this.updateImage(this.url,this.bottomLeftCorner,this.bottomRightCorner,this.topLeftCorner)}deactivate(){this.isActive=!1,this.updateImage(this.url,this.bottomLeftCorner,this.bottomRightCorner,this.topLeftCorner)}preventsSketching(){return!1}}var Hn=i(17594),kn=i(99203),Wn=i(5852);var zn;!function(e){e[e.RIGHT_FRONT=0]="RIGHT_FRONT",e[e.RIGHT_BACK=1]="RIGHT_BACK",e[e.LEFT_BACK=2]="LEFT_BACK",e[e.LEFT_FRONT=3]="LEFT_FRONT"}(zn||(zn={}));const Xn=function(e,t){const i=de.create();return ge.w$.rotate(i,e*Math.PI/2+Math.PI/6,[0,0,1]),ge.w$.rotate(i,t?Math.PI/3:2*Math.PI/3,[1,0,0]),i},Zn={XY:de.create(),XYback:[1,0,0,0,0,-1,0,0,0,0,-1,0,0,0,0,1],YZ:[0,1,0,0,0,0,1,0,1,0,0,0,0,0,0,1],YZback:[0,-1,0,0,0,0,1,0,-1,0,0,0,0,0,0,1],XZ:[1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1],XZback:[-1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1],Isometric:function(){const e=Math.sqrt(.5),t=Math.sqrt(1/3),i=Math.sqrt(1/6);return[e,e,0,0,-i,i,2*i,0,t,-t,t,0,0,0,0,1]}(),Dimetric:function(){const e=de.create();return ge.w$.rotate(e,Math.PI/4,[0,0,1]),ge.w$.rotate(e,Math.PI/3,[1,0,0]),e}(),Trimetric:Xn(zn.RIGHT_FRONT,!0),TrimetricTopRightBack:Xn(zn.RIGHT_BACK,!0),TrimetricTopLeftBack:Xn(zn.LEFT_BACK,!0),TrimetricTopLeftFront:Xn(zn.LEFT_FRONT,!0),TrimetricBottomRightFront:Xn(zn.RIGHT_FRONT,!1),TrimetricBottomRightBack:Xn(zn.RIGHT_BACK,!1),TrimetricBottomLeftBack:Xn(zn.LEFT_BACK,!1),TrimetricBottomLeftFront:Xn(zn.LEFT_FRONT,!1)},qn=X.default.getManager();function Yn(e,t){return y.copy(y.create(),t.getViewport())}class Kn{constructor(e){this.viewer=e,this.camera=null,this.axisRotateUpAxis=[0,0,1],this.axisRotateCanvasTag="axisRotateView",this.rotateOrPanCenter=[0,0,0],this.haltPostRotationAnimation=!1,this.lastRotationTime=0,this.rotationSpeedX=0,this.rotationSpeedY=0,this.lastButtonState={leftButton:!1,middleButton:!1,rightButton:!1},this.lastCtrlState=!1,this.lastShiftState=!1,this.lastAltState=!1,this.isSpaceballMoving=!1,this.dragZoomCanvasCoordinates=[0,0],(0,Jo.Yk)(e),this.animationController=e.getAnimationController(),this.manipulationMode=IC.k.NONE,this.forcedManipulationMode=IC.k.NONE}getViewer(){return this.viewer}isPerspective(){return!1}isOrthographic(){return!1}getCamera(){return this.camera}getRotateOrPanCenter(){return this.rotateOrPanCenter}getAxisRotateUpAxis(){return this.axisRotateUpAxis}resetInputState(){this.lastButtonState={leftButton:!1,middleButton:!1,rightButton:!1},this.lastCtrlState=!1,this.lastShiftState=!1,this.lastAltState=!1}updateInputState(e,t){let i=!1;return Object.entries(t).forEach((function([e,t]){this.lastButtonState[e]!==t&&(this.lastButtonState[e]=t,i=!0)}),this),GI().usesControlKey()&&e.ctrlKey!==this.lastCtrlState&&(this.lastCtrlState=e.ctrlKey,i=!0),GI().usesShiftKey()&&e.shiftKey!==this.lastShiftState&&(this.lastShiftState=e.shiftKey,i=!0),GI().usesAltKey()&&e.altKey!==this.lastAltState&&(this.lastAltState=e.altKey,i=!0),i}getMouseKeyValues(e,t){const i=[];t.rightButton&&i.push(Hn.tc.RIGHT),t.middleButton&&i.push(Hn.tc.MIDDLE),t.leftButton&&i.push(Hn.tc.LEFT);const s=[];return GI().usesControlKey()&&e.ctrlKey&&s.push(cs.R8.CONTROL),GI().usesShiftKey()&&e.shiftKey&&s.push(cs.R8.SHIFT),GI().usesAltKey()&&e.altKey&&s.push(cs.R8.ALT),{mouseButtonSettings:i,modifierKeys:s}}getManipulationMode(e,t){if(this.forcedManipulationMode!==IC.k.NONE&&t.leftButton)return this.forcedManipulationMode;const i=this.getMouseKeyValues(e,t),s=i.mouseButtonSettings,n=i.modifierKeys,r=GI().getManipulationMode(s,n);return r!==IC.k.ZOOM&&r!==IC.k.AXIS_ROTATE&&r!==IC.k.PAN&&r!==IC.k.ROTATE?IC.k.NONE:r}forceManipulationMode(e){this.forcedManipulationMode=e}getClosestMode(e,t,i){const s=this.getMouseKeyValues(e,t),n=s.mouseButtonSettings,r=s.modifierKeys;return GI().getClosestMode(n,r,i)}updateManipulationMode(e,t){if(!this.updateInputState(e,t))return;const i=this.manipulationMode,s=this.forcedManipulationMode!==IC.k.NONE?this.forcedManipulationMode:this.getManipulationMode(e,t);if(s!==IC.k.NONE)this.manipulationMode=s;else{const i=this.getClosestMode(e,t,this.manipulationMode);i!==IC.k.NONE?this.manipulationMode=i:this.manipulationMode=this.getClosestMode(e,t)}i!==this.manipulationMode&&(!(this.isRotating()||this.isPanning()||this.isAxisRotating())||this.isRotating()&&i===IC.k.AXIS_ROTATE||this.isAxisRotating()&&i===IC.k.ROTATE||this.updateRotationPanCenter(e),this.isRotating()&&(this.lastRotationTime=(0,Fs.Wj)(),this.rotationSpeedX=0,this.rotationSpeedY=0))}setRotationPivotPosition(e){this.rotateOrPanCenter=e}setIsSpaceballMoving(e){this.isSpaceballMoving=e}isPanning(){return this.manipulationMode===IC.k.PAN}isRotating(){return this.manipulationMode===IC.k.ROTATE}isAxisRotating(){return this.manipulationMode===IC.k.AXIS_ROTATE}isZooming(){return this.manipulationMode===IC.k.ZOOM}isBeingManipulated(){return this.manipulationMode!==IC.k.NONE}isBeingForceManipulated(){return this.isBeingManipulated()&&this.manipulationMode===this.forcedManipulationMode}getRotateCenterUnderPoint(e,t){const i=qn.getNumber("ROTATION_CENTER_SEARCH_RADIUS"),s=2*i+1,n=2*i+1,r=e-i,a=t-i,o=this.viewer.findDepthsInRect(r,a,s,n,!1);let h=null,c=1/0;const l=Q.create(),u=[e,t];for(let e=0;e<o.length;++e)if(o[e][2]!==Fs.BG){const t=o[e],i=Q.squaredLength(ge.gv.subtract(t,u,l));i<c&&(h=t,c=i)}return h?this.camera.canvasToWorld(h):null}getRotateCenterBasedOnWindowDepths(e){const t=this.viewer.retrieveDepthSampling(e),i=[0,0,0],s=t.length;for(let e=0;e<s;++e)for(let s=0;s<3;++s)i[s]+=t[e][s];return s>0&&s>=qn.getNumber("MIN_SAMPLES_TO_USE_FOR_DEPTH_AVERAGED_ROTATION_CENTER")?this.camera.canvasToWorld([i[0]/s,i[1]/s,i[2]/s]):null}getRotateCenterBasedOnBounds(){const e=this.viewer.getModelViewManagers().getManager().getModelBounds();return e&&e.isInitialized()&&!e.isInfinite()?this.camera.doBoundsFitInViewport(e,this.camera.getViewport(),qn.getNumber("MODEL_SIZE_TO_VIEWPORT_ROTATE_BOUNDS_FACTOR"))?e.center():null:C.create()}getRotateCenterBasedOnCanvasLocationAndBoundsDepth(e,t){const i=this.viewer.getModelViewManagers().getManager().getModelBounds();if(!i||!i.isInitialized()||i.isInfinite())return C.create();const s=this.camera.getRay(e,t),n=.01*i.diameter();return ge.S4.add(s.point,ge.S4.scale(s.direction,Math.max(C.dot(s.direction,ge.S4.subtract(i.center(),s.point,C.create())),n),C.create()))}getRotateCenterForCanvasLocation(e,t){let i=this.getRotateCenterUnderPoint(e,t);return i||(i=this.getRotateCenterBasedOnWindowDepths({includePlanes:!1}),i||(i=this.getRotateCenterBasedOnWindowDepths({includePlanes:!0}),i||(i=this.getRotateCenterBasedOnBounds(),i||this.getRotateCenterBasedOnCanvasLocationAndBoundsDepth(e,t))))}getRotateCenterForSpaceball(){let e=this.getRotateCenterBasedOnBounds();if(e)return e;const t=[this.camera.getViewportWidth()/2,this.camera.getViewportHeight()/2];return e=this.getRotateCenterUnderPoint(t[0],t[1]),e||(e=this.getRotateCenterBasedOnWindowDepths({includePlanes:!1}),e||(e=this.getRotateCenterBasedOnWindowDepths({includePlanes:!0}),e||this.getRotateCenterBasedOnCanvasLocationAndBoundsDepth(t[0],t[1])))}updateRotationPanCenterForSpaceball(){this.setRotationPivotPosition(this.getRotateCenterForSpaceball())}updateRotationPanCenter(e){this.rotateOrPanCenter=[0,0,0];const t=this.viewer.getCanvasCoordinateFromEvent(e),i=t[0],s=t[1];(this.isRotating()||this.isAxisRotating()||this.isPanning()&&this.isPerspective())&&this.setRotationPivotPosition(this.getRotateCenterForCanvasLocation(i,s))}onDragStart(e,t,i){const s=this.isZooming();this.updateManipulationMode(t,i);if(!s&&this.isZooming()){const t=this.viewer.getCanvasCoordinateFromEvent(e);this.dragZoomCanvasCoordinates[0]=t[0],this.dragZoomCanvasCoordinates[1]=t[1]}return this.haltPostRotationAnimation=this.isBeingManipulated(),this.isBeingManipulated()}zoomOnCanvasPoint(e,t,i){const s=this.camera.viewNormalPlaneAtPoint(this.camera.focalPoint()),n=(0,yi.fE)(this.camera.getRay(e,0),s);let r,a=(0,yi.fE)(this.camera.getRay(e,t),s);n&&a?(r=ge.S4.subtract(a,this.camera.getEye(),C.create()),ge.S4.normalize(r)):(i=0,r=this.camera.getEye());const o=this.viewer.getSceneBounds().getCorners();i<0&&X.default.getManager().getNumber("USE_CENTRAL_ZOOM_OUT")&&(a=(0,yi.fE)(this.camera.getRay(this.camera.getViewportWidth()/2,this.camera.getViewportHeight()/2),s)),a?this.zoomPoint(a,{direction:r},i,o):ut.log.debug("No point intersection found for zoomOnCanvasPoint")}zoomOnMouseWheelScroll(e){e.preventDefault();const t=e.originalEvent;let i=0,s=.5;if("mousewheel"===e.type){if(0===t.wheelDelta||t.wheelDeltaX&&Math.abs(t.wheelDeltaX)>Math.abs(t.wheelDeltaY))return!1;s/=120,(0,dt.isPlatformWindows)()&&(s*=3),i=s*t.wheelDelta}else{if(0===t.detail||1===t.axis)return!1;i=-s*t.detail}const n=this.viewer.getCanvasCoordinateFromEvent(t),r=n[0],a=n[1];return OD().isScrollZoomDefault()||(i=-i),this.zoomOnCanvasPoint(r,a,i),!0}zoomOnDrag(e){if(Math.abs(e)<Ci.W.ZERO_LENGTH)return;const t=this.dragZoomCanvasCoordinates[0],i=this.dragZoomCanvasCoordinates[1];e=-1*e/X.default.getManager().getNumber("DRAG_ZOOM_FACTOR"),this.zoomOnCanvasPoint(t,i,e)}onDrag(e,t,i,s,n,r){this.forcedManipulationMode===IC.k.NONE&&this.updateManipulationMode(e,t);const a=this.viewer.$el,o=this.camera.viewNormalPlaneAtPoint(this.rotateOrPanCenter),h=()=>{const e=(0,yi.fE)(this.camera.getRay(n,r),o),t=(0,yi.fE)(this.camera.getRay(n+i,r+s),o);return e&&t?(ge.S4.subtract(t,e),t):null};if(this.isPanning()){const e=h.call(this);e&&this.pan(e)}else if(this.isRotating()){const e=[+a.attr("width"),+a.attr("height")],t=2*Math.PI*qn.getNumber("ROTATION_CYCLES_PER_SCREEN")/ge.gv.length(e);this.rotateAbout(-i*t,this.camera.getUp(),this.rotateOrPanCenter),this.rotateAbout(-s*t,this.camera.getRight(),this.rotateOrPanCenter),this.lastRotationTime=(0,Fs.Wj)(),this.rotationSpeedX=.5*(this.rotationSpeedX+i),this.rotationSpeedY=.5*(this.rotationSpeedY+s),this.tagCanvasWithView("unknown")}else if(this.isAxisRotating()){const e=a.attr("data-view-shown")===this.axisRotateCanvasTag;if(!this.animationController.isCameraAnimating())if(e){const e=[+a.attr("width"),+a.attr("height")],t=2*Math.PI*qn.getNumber("ROTATION_CYCLES_PER_SCREEN")/ge.gv.length(e),n=(0,ar.sign)(this.camera.getUp()[2])||1;this.rotateAbout(-i*n*t,this.axisRotateUpAxis,this.rotateOrPanCenter),this.rotateAbout(-s*t,this.camera.getRight(),this.rotateOrPanCenter)}else{const e=Math.asin(C.dot(this.camera.getRight(),this.axisRotateUpAxis)),t=ge.S4.cross(this.camera.getRight(),this.axisRotateUpAxis,C.create()),i=Math.abs(e);if(i<qn.getNumber("AXIS_ROTATION_SNAP_TOLERANCE"))this.rotateAbout(-e,t,this.rotateOrPanCenter),this.tagCanvasWithView(this.axisRotateCanvasTag);else{const s=this.camera.clone();s.rotateAbout(-e,t,this.rotateOrPanCenter);const n=qn.getNumber(i>Math.PI/4?"CAMERA_SHORT_ANIMATION_TIME_MS":"CAMERA_SNAP_ANIMATION_TIME_MS");this.animateToCustomView(s,n,this.axisRotateCanvasTag)}}}else this.isZooming()&&this.zoomOnDrag(s);this.updateCameraNearFar(),this.afterViewChange()}onDragStop(e){this.isRotating()&&this.performStopRotationAnimation(),this.resetInputState(),this.manipulationMode=IC.k.NONE}getPointerPosition(){return this.viewer.getCanvasCoordinateFromEvent(this.viewer.getLastMouseMovedEvent())}performStopRotationAnimation(){if(this.viewer.isInteractiveFramerateBelowThreshold())return;this.haltPostRotationAnimation=!1;const e=ge.gv.length([this.camera.getViewportWidth(),this.camera.getViewportHeight()]),t=2*Math.PI*qn.getNumber("ROTATION_CYCLES_PER_SCREEN")/e,i=qn.getNumber("ROTATION_INERTIA");let s=1;let n=(0,Fs.Wj)();(0,Fs.Wj)()-this.lastRotationTime<50&&this.animationController.startCameraAnimation((e=>{const r=(0,Fs.Wj)();s*=Math.pow(i,(r-n)/16.666666666666668),n=r;const a=this.rotationSpeedX*s,o=this.rotationSpeedY*s;return!this.haltPostRotationAnimation&&(Math.abs(a)>1||Math.abs(o)>1)?(this.rotateAbout(-a*t,this.camera.getUp(),this.rotateOrPanCenter),this.rotateAbout(-o*t,this.camera.getRight(),this.rotateOrPanCenter),Wn.Z.ONGOING):Wn.Z.COMPLETE}))}rotateAbout(e,t,i){this.camera.rotateAbout(e,t,i)}pan(e){this.camera.pan(e)}canZoom(e,t){if(t){const i=new yi.kB;for(let e=0;e<t.length;e++)i.addPoint(t[e]);if(i.diameter()>0){const t=this.camera.getPixelSizeAtWorldPoint(i.center()),s=X.default.getManager().getNumber("MIN_MODEL_PIXEL_SIZE");return!(e>=1&&i.diameter()/t<=e*s||e<=1&&1/t>=e*Math.pow(2,24))}}return!1}adjustCameraToValidZoom(e){if(!e)return!1;const t=this.viewer.getFitBounds();if(!this.canBoundsBeFit(t))return!1;const i=X.default.getManager().getNumber("MIN_MODEL_PIXEL_SIZE"),s=e.getPixelSizeAtWorldPoint(t.center());let n=1;return t.diameter()/s<=i?n=t.diameter()/s/i:1/s>=Math.pow(2,24)&&(n=1/(Math.pow(2,24)*s)),1!==n&&(ut.log.debug("Given camera would result in invalid scene zoom. Applying zoom: "+n),e.zoom(n)),!0}zoom(e){}setStandardView(e){const t=Zn[e];t&&(this.camera.setFrame(t),this.tagCanvasWithView(e))}animateToCustomView(e,t,i){this.animateTo(e,t,i)}animateViewNormalToPlaneMatrix(e,t,i){if(!e)return;let s;const n=Yn(this.viewer,this.camera);if(this.camera.canBoundsFitInViewport(t,n)){const i=this.camera.viewportToCanvas([n[0]+n[2]/2-this.camera.getViewportLeft(),n[1]+n[3]/2-this.camera.getViewportBottom(),0]);s=this.camera.getCameraRotatedToViewAndTranslated(e,t.center(),i)}else{const t=i?i[0]:this.camera.getViewportWidth()/2,n=i?i[1]:this.camera.getViewportHeight()/2,r=this.getRotateCenterForCanvasLocation(t,n);s=this.camera.getCameraRotatedToView(e,r)}this.animateToCustomView(s,qn.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"))}animateTo(e,t,i){if(this.animationController.isCameraAnimating())return;if(this.tagCanvasWithView(),this.viewer.isInteractiveFramerateBelowThreshold())return this.camera.copyFrom(e),this.updateCameraNearFar(),this.afterViewChange(),this.viewer.getAnimationController().incrementAnimationSequence(),this.tagCanvasWithView(i),void this.viewer.getBodyManager().onUserIsAdjustingCamera();const s=(0,Fs.Wj)(),n=new kn.f(this.camera,e);this.animationController.startCameraAnimation((e=>{const r=(0,Fs.Wj)();let a;const o=r-s;a=o>=t?1:o/t,a=a*a*a*(a*(6*a-15)+10);const h=n.interpolate(a);return(0,yi.nP)(this.camera.getViewport(),h.viewport)?(this.camera.copyFrom(h),this.updateCameraNearFar(),r-s<t?Wn.Z.ONGOING:(this.tagCanvasWithView(i),this.viewer.getBodyManager().onUserIsAdjustingCamera(),this.viewer.getEventDispatcher().trigger(yD.h0,null),Wn.Z.COMPLETE)):(ut.log.trace("Camera viewport changed mid-animation, terminating animation early"),Wn.Z.COMPLETE)}))}tagCanvasWithView(e){e?this.viewer.$el.attr("data-view-shown",e):this.viewer.$el.attr("data-view-shown","unknown")}getViewportCenter(){const e=Yn(this.viewer,this.camera);return Q.fromValues(e[0]+e[2]/2,e[1]+e[3]/2)}canBoundsBeFit(e){const t=e.isInitialized()&&!e.isInfinite();return t||ut.log.warn("An attempt was made to fit a camera with invalid bounds"),t}animateToFrameWithZoomFit(e,t,i,s,n,r){if(!this.canBoundsBeFit(t))return;const a=this.getZoomFitTargetCamera(e,t,n,r);this.adjustCameraToValidZoom(a)&&this.animateTo(a,i,s)}getZoomFitTargetCamera(e,t,i,s){const n=t.getCorners();let r=null;i||(r=Yn(this.viewer,this.camera));const a=this.camera.clone();a.setFrame(e);let o=s;return o||(o=qn.getNumber("CAMERA_ZOOM_TO_FIT_PADDING")),a.zoomToFit(n,o,r),a.updateNearFar(),a}animateToStandardView(e,t){if(!this.canBoundsBeFit(t))return;const i=Zn[e];i&&this.animateToFrameWithZoomFit(i,t,qn.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"),e)}animateToStandardViewIgnoringUIPanels(e,t,i){if(!this.canBoundsBeFit(t))return;const s=Zn[e];s&&this.animateToFrameWithZoomFit(s,t,qn.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"),e,!0,i)}animateZoomToFit(e){if(!this.canBoundsBeFit(e))return;const t=e.getCorners(),i=Yn(this.viewer,this.camera),s=this.camera.clone();s.zoomToFit(t,qn.getNumber("CAMERA_ZOOM_TO_FIT_PADDING"),i),this.adjustCameraToValidZoom(s)&&this.animateTo(s,qn.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"))}zoomFitCamera(e,t,i){if(!this.canBoundsBeFit(e))return;const s=e.getCorners(),n=this.camera.clone();n.zoomToFit(s,qn.getNumber("CAMERA_ZOOM_TO_FIT_PADDING"),t),n.updateNearFar(s),this.adjustCameraToValidZoom(n)&&(this.camera=n,this.afterViewChange(i))}zoomFit(e,t){this.animationController.haltCameraAnimation(),this.zoomFitCamera(e,Yn(this.viewer,this.camera),t)}zoomFitWithoutPanels(e){this.zoomFitCamera(e)}animateRotation(e,t,i,s){let n=0;const r=(0,Fs.Wj)();if(s||(s=this.camera.focalPoint()),this.tagCanvasWithView(),this.viewer.isInteractiveFramerateBelowThreshold())return this.rotateAbout(t,e,s),this.updateCameraNearFar(),void this.afterViewChange();this.animationController.startAnimation((a=>{if(Math.abs(n)<Math.abs(t)){if(!this.viewer.isReadyForDrawing())return;const a=(0,Fs.Wj)(),o=Math.min(a-r,i)/i*t,h=o-n;return this.rotateAbout(h,e,s),this.updateCameraNearFar(),n=o,a-r<=i?Wn.Z.ONGOING:(this.viewer.getEventDispatcher().trigger(yD.h0,null),Wn.Z.COMPLETE)}}))}rotateInDirection(e,t){const i=this.camera.up,s=this.camera.direction,n=ge.S4.cross(s,i,C.create());switch(e){case"left":this.animateRotation(i,t,qn.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"));break;case"right":this.animateRotation(i,-t,qn.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"));break;case"up":this.animateRotation(n,t,qn.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"));break;case"down":this.animateRotation(n,-t,qn.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"));break;case"clockwise":this.animateRotation(s,-t,qn.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"));break;case"counterclockwise":this.animateRotation(s,t,qn.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"));break;case"180":this.animateRotation(i,Math.PI,qn.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"))}}animatePan(e,t){const i=this.camera.clone(),s=i.getPixelSizeAtWorldPoint(i.getSceneBounds().center()),n=ge.S4.add(ge.S4.scale(i.getRight(),s*-e,C.create()),ge.S4.scale(i.getUp(),s*-t,C.create()));i.pan(n),this.animateTo(i,qn.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"))}panRight(){this.animatePan(qn.getNumber("DEFAULT_PAN_AMOUNT_PX"),0)}panLeft(){this.animatePan(-qn.getNumber("DEFAULT_PAN_AMOUNT_PX"),0)}panUp(){this.animatePan(0,qn.getNumber("DEFAULT_PAN_AMOUNT_PX"))}panDown(){this.animatePan(0,-qn.getNumber("DEFAULT_PAN_AMOUNT_PX"))}animateZoom(e){const t=this.camera.clone();t.zoom(e),this.adjustCameraToValidZoom(t)&&this.animateTo(t,qn.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"))}zoomIn(){this.animateZoom(1/qn.getNumber("DEFAULT_ZOOM_FACTOR"))}zoomOut(){this.animateZoom(qn.getNumber("DEFAULT_ZOOM_FACTOR"))}zoomPoint(e,t,i,s){}updateCameraNearFar(){const e=this.viewer.getSceneGraphs().getMainSceneGraph().getBounds();e.isFinite()&&this.camera.updateNearFar(e.getCorners())}getMatchingOrthographicController(){return null}getMatchingPerspectiveController(){return null}afterViewChange(e){e||this.viewer.getEventDispatcher().trigger(yD.h0,null),this.viewer.requestDraw()}}class jn extends Kn{constructor(e,t){super(e),this.camera=new ah(t)}isPerspective(){return!0}clone(){const e=new jn(this.viewer);return e.camera=this.camera.clone(),e.forcedManipulationMode=this.forcedManipulationMode,e}zoom(e){const t=this.camera,i=Math.max(t.distanceToCenter(),t.getMinDistance())*e/6;t.dolly(i),t.updateNearFar()}zoomPoint(e,t,i,s){const n=Math.pow(2,-i/6);if(this.canZoom(n,s)){const e=this.camera,n=Math.max(e.distanceToCenter(),e.getMinDistance())*i/6;e.dollyAlong(n,t.direction),e.updateNearFar(s)}}getMatchingOrthographicController(){const e=new Qn(this.viewer);return e.camera=this.camera.getOrthographicCamera(),e.forcedManipulationMode=this.forcedManipulationMode,e}}class Qn extends Kn{constructor(e,t){super(e),this.camera=new oh(t)}isOrthographic(){return!0}zoom(e){const t=Math.pow(2,-e/6);this.camera.zoom(t)}zoomPoint(e,t,i,s){const n=Math.pow(2,-i/6);this.canZoom(n,s)&&this.camera.zoomPoint(e,t,n,s)}clone(){const e=new Qn(this.viewer);return e.camera=this.camera.clone(),e.forcedManipulationMode=this.forcedManipulationMode,e}getMatchingPerspectiveController(){const e=new jn(this.viewer);return e.camera=this.camera.getPerspectiveCamera(),e.forcedManipulationMode=this.forcedManipulationMode,e}}var $n,Jn=i(65270);!function(e){e.RIGHT="Right",e.LEFT="Left",e.TOP="Top",e.BOTTOM="Bottom",e.NEAR="Near",e.FAR="Far"}($n||($n={}));class er{constructor(e,t,i,s){const n=Math.sqrt(e*e+t*t+i*i);this.normal=[e/n,t/n,i/n],this.d=s/n}}class tr{constructor(e,t){this.clippingPlanes={},this.clippingMatrix=de.create(),e&&t&&this.updateClippingPlanes(e,t)}updateClippingPlanes(e,t){e&&t&&(this.clippingMatrix[0]=e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],this.clippingMatrix[1]=e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],this.clippingMatrix[2]=e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],this.clippingMatrix[3]=e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],this.clippingMatrix[4]=e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],this.clippingMatrix[5]=e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],this.clippingMatrix[6]=e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],this.clippingMatrix[7]=e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],this.clippingMatrix[8]=e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],this.clippingMatrix[9]=e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],this.clippingMatrix[10]=e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],this.clippingMatrix[11]=e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],this.clippingMatrix[12]=e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],this.clippingMatrix[13]=e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],this.clippingMatrix[14]=e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],this.clippingMatrix[15]=e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15],this.updateClippingPlane($n.BOTTOM,this.clippingMatrix[3]+this.clippingMatrix[1],this.clippingMatrix[7]+this.clippingMatrix[5],this.clippingMatrix[11]+this.clippingMatrix[9],this.clippingMatrix[15]+this.clippingMatrix[13]),this.updateClippingPlane($n.TOP,this.clippingMatrix[3]-this.clippingMatrix[1],this.clippingMatrix[7]-this.clippingMatrix[5],this.clippingMatrix[11]-this.clippingMatrix[9],this.clippingMatrix[15]-this.clippingMatrix[13]),this.updateClippingPlane($n.LEFT,this.clippingMatrix[3]+this.clippingMatrix[0],this.clippingMatrix[7]+this.clippingMatrix[4],this.clippingMatrix[11]+this.clippingMatrix[8],this.clippingMatrix[15]+this.clippingMatrix[12]),this.updateClippingPlane($n.RIGHT,this.clippingMatrix[3]-this.clippingMatrix[0],this.clippingMatrix[7]-this.clippingMatrix[4],this.clippingMatrix[11]-this.clippingMatrix[8],this.clippingMatrix[15]-this.clippingMatrix[12]))}updateClippingPlane(e,t,i,s,n){if(this.clippingPlanes[e]){const r=Math.sqrt(t*t+i*i+s*s),a=[t/r,i/r,s/r],o=n/r;this.clippingPlanes[e].normal=a,this.clippingPlanes[e].d=o}else this.clippingPlanes[e]=new er(t,i,s,n)}getSphereFrustumIntersection(e,t){let i=this.clippingPlanes[$n.BOTTOM],s=i.normal[0]*e[0]+i.normal[1]*e[1]+i.normal[2]*e[2]+i.d;return s<-t?Jn.I.OUTSIDE:(i=this.clippingPlanes[$n.TOP],s=i.normal[0]*e[0]+i.normal[1]*e[1]+i.normal[2]*e[2]+i.d,s<-t?Jn.I.OUTSIDE:(i=this.clippingPlanes[$n.RIGHT],s=i.normal[0]*e[0]+i.normal[1]*e[1]+i.normal[2]*e[2]+i.d,s<-t?Jn.I.OUTSIDE:(i=this.clippingPlanes[$n.LEFT],s=i.normal[0]*e[0]+i.normal[1]*e[1]+i.normal[2]*e[2]+i.d,s<-t?Jn.I.OUTSIDE:Jn.I.INSIDE)))}}var ir=i(51232),sr=i(31286),nr=i(83869),rr=i(98061),ar=i(81194),or=i(99826);const hr=X.default.getManager(),cr="selection",lr="lines.",ur="outlines.",dr="lines",gr="manipulator-displacement-graphics",pr=new xi.hF({isVisible:!0,isPickable:!1,isTwoSided:!0,isShowThrough:!0,isDepthTested:!1,priority:xi.DO.DEFAULT,primitiveType:Di.MX.LINES}),mr=new xi.hF(Object.assign({},pr,{priority:xi.DO.HIGHEST})),fr=new xi.hF({isVisible:!0,isPickable:!1,isTwoSided:!0,isShowThrough:!0,isDepthTested:!1,priority:xi.DO.LOWER,primitiveType:Di.MX.LINES}),Ir=new xi.hF(Object.assign({},fr,{priority:xi.DO.HIGHER})),Er=new xi.hF({isVisible:!1,isPickable:!0,isTwoSided:!0,isShowThrough:!0,isDepthTested:!1,primitiveType:Di.MX.TRIANGLES});class Sr extends Ti.u1{constructor(e,t){super(e),this.isDragging=!1,this.isHovering=!1,this.isEnabled=!0,this.meshIncrement=null,this.pickIncrement=null,this.updateIncrement=!1,this.doSnappingBehavior=!0,this.offsetRoundDecimals=8,this.hasEditView=!1,this.isLocked=!1,t||(t={displayEditView:!1}),this.style=k.xKD.DEFAULT,this.lineColor=new Uint8Array([0,0,0,0]),this.outlineColor=new Uint8Array([0,0,0,0]),this.triadOwnerType=or.Ak.UNKNOWN,this.displayEditView=t.displayEditView,this.listenTo(this,Ti.zw.MOUSE_ENTER+cr,this.onMouseEnter),this.listenTo(this,Ti.zw.MOUSE_LEAVE+cr,this.onMouseLeave),this.listenTo(this,Ti.zw.DRAG_START+cr,this.onDragStart),this.listenTo(this,Ti.zw.DRAG+cr,this.onDrag),this.listenTo(this,Ti.zw.DRAG_STOP+cr,this.onDragStop),this.listenTo(this,Ti.zw.CLICK+cr,this.onClick),this.listenTo(this,Ti.zw.DOUBLE_CLICK+cr,this.onDoubleClick),this.listenTo(this,Ti.zw.XR_DRAG_START+cr,this.onXrDragStart),this.listenTo(this,Ti.zw.XR_DRAG+cr,this.onXrDrag),this.listenTo(this,Ti.zw.XR_DRAG_STOP+cr,this.onXrDragStop)}onAppearanceConstantsUpdated(){this.updateIncrement=!0}isManipulator(){return!0}setIsLocked(e){this.isLocked=e}getIsLocked(){return this.isLocked}onDevicePixelRatioChanged(e){this.meshIncrement=null,this.updateGraphics(e)}setStyle(e){this.style=e||k.xKD.DEFAULT}setFadeParameters(e,t){this.fadeAngleStart=(0,yi.Yr)((0,yi.uZ)(e,0,90)),this.fadeAngleEnd=(0,yi.Yr)((0,yi.uZ)(t,0,90))}setIsEnabled(e){this.isEnabled=e,(0,Fs.vm)()}getIsEnabled(){return this.isEnabled}setTriadOwnerType(e){this.triadOwnerType=e}getTriadOwnerType(){return this.triadOwnerType}onViewWillDraw(e,t){this.isHidden||this.updateGraphics(e)}onMouseEnter(e,t){this.isEnabled&&(this.isHovering=!0,this.updateIncrement=!0,this.trigger(or.Wb.MANIPULATOR_ENTER,this),(0,Fs.vm)())}onMouseLeave(e,t){this.isEnabled&&(this.isHovering=!1,this.updateIncrement=!0,this.trigger(or.Wb.MANIPULATOR_LEAVE,this),(0,Fs.vm)())}onDragStart(e,t,i){this.isEnabled&&(this.isDragging=!0,this.updateIncrement=!0,i.requestDrag=!0,this.trigger(or.Wb.MANIPULATION_STARTED,this),(0,Fs.vm)())}onDragStop(e,t){this.isDragging=!1,this.updateIncrement=!0,this.trigger(or.Wb.MANIPULATION_ENDED),(0,Fs.vm)()}onDrag(e,t){}onXrDragStart(e,t,i){this.isEnabled&&(this.isDragging=!0,this.updateIncrement=!0,i.requestDrag=!0,this.trigger(or.Wb.MANIPULATION_STARTED,this),this.viewer.requestDraw())}onXrDragStop(e,t){this.isDragging=!1,this.updateIncrement=!0,this.trigger(or.Wb.MANIPULATION_ENDED),(0,Fs.vm)()}onXrDrag(e,t){}onClick(e,t){this.isEnabled&&this.trigger(or.Wb.CLICKED,this)}onDoubleClick(e,t){this.isEnabled&&this.trigger(or.Wb.DOUBLE_CLICKED,this,e)}getOutlineColor(){return this.isEnabled?this.isDragging?hr.getColor("MANIPULATOR_OUTLINE_DRAG_COLOR"):this.isHovering?hr.getColor("MANIPULATOR_OUTLINE_HOVER_COLOR"):hr.getColor("MANIPULATOR_OUTLINE_COLOR"):hr.getColor("MANIPULATOR_OUTLINE_DISABLED_COLOR")}getLineColor(){return this.isEnabled?this.isDragging?hr.getColor("MANIPULATOR_LINE_DRAG_COLOR"):this.isHovering?hr.getColor("MANIPULATOR_LINE_HOVER_COLOR"):hr.getColor("MANIPULATOR_LINE_COLOR"):hr.getColor("MANIPULATOR_LINE_DISABLED_COLOR")}isHighlighted(){return this.isDragging||this.isHovering}updateLines(e,t,i){const s=t.clone();i=void 0!==i?i:1,this.isEnabled||(i*=hr.getNumber("MANIPULATOR_DISABLED_OPACITY"));const n=this.getLineColor();n[3]=(0,yi.uZ)(n[3]*i,1/255,1),(0,Au.Ab)(n,t),(0,Au.VQ)(hr.getNumber("MANIPULATOR_LINE_WIDTH"),t),this.updateMeshIncrement(lr+e,Ti.ZJ,t,this.isHighlighted()?mr:pr);const r=this.getOutlineColor();r[3]=(0,yi.uZ)(r[3]*i,1/255,1),(0,Au.Ab)(r,s),(0,Au.VQ)(hr.getNumber("MANIPULATOR_LINE_WIDTH")+2*hr.getNumber("MANIPULATOR_OUTLINE_WIDTH"),s),this.updateMeshIncrement(ur+e,Ti.ZJ,s,this.isHighlighted()?Ir:fr)}removeDisplacementMeshIncrements(){this.removeMeshIncrement(gr)}updatePickArea(e){this.viewer.performingBoxSelection()||((0,Au.Ab)([0,0,0,1],e),this.updateMeshIncrement("pickarea",cr,e,Er))}updateGeometry(){}updateColor(e){if(e=void 0!==e?e:1,this.isEnabled||(e*=hr.getNumber("MANIPULATOR_DISABLED_OPACITY")),e<=0?this.isTransparent||this.makeTransparent():this.isTransparent&&this.makeOpaque(),this.isHidden||this.isTransparent)return;let t=this.getLineColor();t[3]=(0,yi.uZ)(t[3]*e,1/255,1),t=[255*t[0],255*t[1],255*t[2],255*t[3]],this.lineColor[0]===t[0]&&this.lineColor[1]===t[1]&&this.lineColor[2]===t[2]&&this.lineColor[3]===t[3]||(this.lineColor.set(t),this.updateIncrementAttribute(lr+dr,sE.COLOR,this.lineColor));let i=this.getOutlineColor();i[3]=(0,yi.uZ)(i[3]*e,1/255,1),i=[255*i[0],255*i[1],255*i[2],255*i[3]],this.outlineColor[0]===i[0]&&this.outlineColor[1]===i[1]&&this.outlineColor[2]===i[2]&&this.outlineColor[3]===i[3]||(this.outlineColor.set(i),this.updateIncrementAttribute(ur+dr,sE.COLOR,this.outlineColor))}updateGraphics(e){let t=this.updateIncrement;this.meshIncrement||(this.updateGeometry(),t=!0),this.meshIncrement&&t&&(this.updateLines(dr,this.meshIncrement),this.updatePickArea(this.pickIncrement))}isBeingManipulated(){return this.isDragging}getLinearSnapValue(e,t,i){const s=e.camera.getPixelSizeAtWorldPoint(i),n=hr.getNumber("MANIPULATOR_LINEAR_SNAP_RESOLUTION_PX")*s,r=(0,nr.vx)().getLengthUnits(),a=(0,rr.KZ)(n,r);if(a<=0)return t;const o=Math.round(Math.log(a)/Math.log(10));let h=Math.pow(10,o-1);h/=hr.getNumber("MANIPULATOR_LINEAR_INCREMENT_DIVISOR");const c=(0,rr.KZ)(t,r)/h,l=Math.round(c),u=l-c,d=hr.getNumber("MANIPULATOR_LINEAR_SNAP_DEVIATION");if(Math.abs(u)<=d){const e=h*l;t=(0,rr.Fv)(e,r)}return t}onEditChange(e){}onEditCreate(){this.hasEditView=!0}onEditClose(){this.hasEditView=!1}triggerEditValueChange(e){(0,sr.m)().trigger(ir.C.SET_EDIT_VALUE,e)}triggerEditValueChangeNoUnit(e){(0,sr.m)().trigger(ir.C.SET_EDIT_VALUE_NO_UNIT,e)}triggerEditOriginChange(e,t){(0,sr.m)().trigger(ir.C.SET_EDIT_VIEW_ORIGIN,e,t)}remove(){this.hasEditView&&((0,sr.m)().trigger(ir.C.CLOSE_MANIPULATOR_EDIT_VIEW),(0,Xo.a)().setActiveManipulator(null)),super.remove()}removeEditViewAndHighlights(){this.isHovering=!1,(0,sr.m)().trigger(ir.C.CLOSE_MANIPULATOR_EDIT_VIEW),(0,Xo.a)().setActiveManipulator(null)}dragByIncrementValue(e){}}class Tr extends Sr{constructor(e,t){super(e,t),this.offset=0,this.initialRay=null,this.editOffset=0,this.visualGapPx=0,this.flipDirectionWhenNegative=!1,this.dragOffset=0,this.minOffset=-1/0,this.maxOffset=1/0,this.displacementGraphics=null,this.ray=new yi.zH([0,0,0],[0,0,1]),this.shaftLengthPx=hr.getNumber("MANIPULATOR_LINEAR_SHAFT_LENGTH_PX"),this.isDraggable=!t||!t.hasOwnProperty("isDraggable")||t.isDraggable,this.setFadeParameters(hr.getNumber("MANIPULATOR_LINEAR_FADE_ANGLE_START"),hr.getNumber("MANIPULATOR_LINEAR_FADE_ANGLE_END"))}remove(){super.remove(),this.displacementGraphics&&(this.displacementGraphics.remove(),this.displacementGraphics=null)}updateGeometry(){let e=this.shaftLengthPx,t=hr.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX"),i=hr.getNumber("MANIPULATOR_LINEAR_HEAD_RADIUS_PX");const s=hr.getNumber("MANIPULATOR_CIRCLE_SEGMENTS");if(this.style===k.xKD.TANGENTIAL){const e=hr.getNumber("MANIPULATOR_TANGENTIAL_SHAFT_LENGTH_PX"),t=hr.getNumber("MANIPULATOR_TANGENTIAL_HEAD_LENGTH_PX"),i=hr.getNumber("MANIPULATOR_TANGENTIAL_HEAD_RADIUS_PX"),n=hr.getNumber("MANIPULATOR_TANGENTIAL_BASE_RADIUS_PX"),r=2*Math.max(i,n),a=2*(t+e)+n,o=(0,Au.AD)(C.fromValues(0,0,n),C.fromValues(0,0,1),C.fromValues(1,0,0),e,t,i),h=(0,Au.AD)(C.fromValues(0,0,-n),C.fromValues(0,0,-1),C.fromValues(1,0,0),e,t,i),c=(0,Au.y)(C.fromValues(0,0,0),n,C.fromValues(0,1,0),s);this.meshIncrement=c.concatenate(o).concatenate(h),this.pickIncrement=(0,Au.fQ)(C.fromValues(-r/2,0,-a/2),C.fromValues(r/2,0,-a/2),C.fromValues(-r/2,0,a/2))}else this.style===k.xKD.SECONDARY?(e-=t*hr.getNumber("SECOND_DIRECTION_MANIPULATOR_OFFSET_PERCENT"),this.meshIncrement=(0,Au.KE)(C.fromValues(0,0,0),C.fromValues(0,0,1),C.fromValues(1,0,0),e,t,i),this.pickIncrement=(0,Au.fQ)(C.fromValues(-i,0,0),C.fromValues(i,0,0),C.fromValues(-i,0,e+t))):(this.style!==k.xKD.DEFAULT&&this.style!==k.xKD.SIMPLE&&ut.log.debug("Manipulator style "+k.sAS[this.style]+" not implemented.  Using default style"),this.style===k.xKD.SIMPLE&&(e=0,t=hr.getNumber("MANIPULATOR_LINEAR_SIMPLE_HEAD_LENGTH_PX"),i=hr.getNumber("MANIPULATOR_LINEAR_SIMPLE_HEAD_RADIUS_PX")),this.meshIncrement=(0,Au.AD)(C.fromValues(0,0,0),C.fromValues(0,0,1),C.fromValues(1,0,0),e,t,i),this.pickIncrement=(0,Au.fQ)(C.fromValues(-i,0,0),C.fromValues(i,0,0),C.fromValues(-i,0,e+t)))}setVisualGap(e){this.visualGapPx=e}setShaftLength(e){this.shaftLengthPx=e}setFlipDirectionWhenNegative(e){this.flipDirectionWhenNegative=e}setIsDraggable(e){this.isDraggable=e}getOffsetFromEvent(e){const t=e.camera.getRay(e.mouseX,e.mouseY),i=this.ray.findClosestPositionToOtherRay(t);return i||0}getOffsetFromXrInputEvent(e){const t=this.ray.findClosestPositionToOtherRay(e.modelSpaceRay);return t||0}onDefaultUnitsChanged(){this.hasEditView&&this.createEditView()}createEditView(){this.editViewUnits=(0,nr.vx)().getLengthUnits();const e=new k.wtM;e.parameterId="length",e.units=this.editViewUnits,e.value=this.offset;const t={paramQuantity:e,quantityType:k.Uqp.LENGTH,range:null};(0,sr.m)().trigger(ir.C.CREATE_MANIPULATOR_EDIT_VIEW,this,t,this.viewer)}onDragStart(e,t,i){this.dragOffset=this.getOffsetFromEvent(t)-this.offset,super.onDragStart(e,t,i),this.initializeEditView()}onXrDragStart(e,t,i){this.dragOffset=this.getOffsetFromXrInputEvent(t)-this.offset,super.onXrDragStart(e,t,i),this.initializeEditView()}initializeEditView(){this.displayEditView&&!this.hasEditView&&(this.createEditView(),this.initialRay=new yi.zH(this.ray.point,this.ray.direction),(0,Xo.a)().setActiveManipulator(this))}onEditChange(e){const t=e.units;this.editOffset=(0,rr.Fv)(e.value,t),this.trigger(or.Wb.VALUE_EDITED)}onDrag(e,t){if(this.isLocked||!this.isDraggable)return;const i=this.getOffsetFromEvent(t)-this.dragOffset,s=!t.shiftKey;this.handleDrag(i,t.camera.getRay(t.mouseX,t.mouseY),s,t)}onXrDrag(e,t){if(this.isLocked||!this.isDraggable)return;const i=this.getOffsetFromXrInputEvent(t)-this.dragOffset;this.handleDrag(i,t.modelSpaceRay,!1)}handleDrag(e,t,i,s){if(e=(0,yi.uZ)(e,this.minOffset,this.maxOffset),i&&(e=this.getLinearSnapValue(s,e,this.ray.point),e=(0,yi.uZ)(e,this.minOffset,this.maxOffset)),this.offset=parseFloat(e.toFixed(this.offsetRoundDecimals)),this.hasEditView){let e=this.initialRay?.findClosestPositionToOtherRay(t);e=e?e-this.dragOffset:0,i&&(e=this.getLinearSnapValue(s,e,this.initialRay.point),e=(0,yi.uZ)(e,this.minOffset,this.maxOffset)),this.editOffset=e}this.trigger(or.Wb.VALUE_CHANGED,this.offset,s),this.viewer.requestDraw()}updateDefinition(e,t,i){if(this.isBeingManipulated()){const i=this.ray.evaluate(this.offset);this.ray=new yi.zH(e,t);const s=this.ray.findPositionOfPoint(i);this.offset=s}else this.ray=new yi.zH(e,t),i||(i=0),this.offset=i;(0,Fs.vm)()}updateDefinitionForLocalManipulatorAtRest(e,t,i){const s=2*Ci.W.ZERO_LENGTH,n=i?-s:s;this.updateDefinition(e,t,n)}updateLimits(e,t){this.minOffset=e,this.maxOffset=t}getOffset(){return this.offset}getEditOffset(){return this.editOffset}getOffsetPosition(){return this.ray.evaluate(this.offset)}getEditOffsetPosition(){return this.initialRay.evaluate(this.editOffset)}getInitialOffsetPosition(){return this.initialRay.point}getEditTranslation(){return ge.S4.subtract(this.getOffsetPosition(),this.getInitialOffsetPosition(),C.create())}dragByIncrementValue(e){const t=this.ray.point,i=this.viewer.getCamera();if(!i)return;const s=i.projectWorldPointToCanvas(t),n={mouseX:s[0],mouseY:s[1],camera:i};this.onDragStart(null,n,{requestDrag:!1});const r=(0,nr.vx)().getLengthUnits(),a=(0,rr.Fv)(e,r),o=this.ray.evaluate(a),h=i.projectWorldPointToCanvas(o);n.mouseX=h[0],n.mouseY=h[1],this.onDrag(null,n),this.onDragStop(null,n)}updateGraphics(e){super.updateGraphics(e);const t=Math.acos(Math.min(Math.abs(C.dot(e.getForward(),this.ray.direction)),1)),i=this.isBeingManipulated()?1:(0,yi.CW)(this.fadeAngleEnd,this.fadeAngleStart,t);if(this.updateColor(i),!this.isHidden){const t=e.getPixelSizeAtWorldPoint(this.ray.evaluate(this.offset)),i=this.offset<0&&this.flipDirectionWhenNegative?-1:1,s=this.visualGapPx*t+this.offset,n=this.ray.evaluate(s),r=ge.S4.scale(ge.S4.normalize(this.ray.direction,C.create()),i*t),a=ge.S4.scale(ge.S4.normalize(ge.S4.cross(e.getForward(),r,C.create())),t),o=ge.S4.scale(ge.S4.normalize(ge.S4.cross(r,a,C.create())),t),h=de.fromValues(a[0],a[1],a[2],0,o[0],o[1],o[2],0,r[0],r[1],r[2],0,n[0],n[1],n[2],1);if(this.hasEditView){const i=(0,nr.vx)().getLengthUnits(),s=this.getEditTranslation(),r=C.dot(this.initialRay.direction,s)<0?-1:1,o=ge.S4.length(s)*r,h=(0,rr.KZ)(o,i);this.triggerEditValueChange({value:h,isLength:!0});const c=(0,Ji.x_)(),l=this.shaftLengthPx*t*c,u=this.ray.evaluate(this.offset+l),d=e.projectWorldPointToCanvas(u),g=Mr(e.projectWorldPointToCanvas(n),d);d[0]=g.x+d[0]/(0,Ji.x_)(),d[1]=g.y+d[1]/(0,Ji.x_)(),this.triggerEditOriginChange(d[0],d[1]),this.displacementGraphics||(this.displacementGraphics=new Cr(this.viewer,this)),this.displacementGraphics.updateGraphics(e,a,o)}this.setTransform(h)}}removeDisplacementMeshIncrements(){this.displacementGraphics&&this.displacementGraphics.removeMeshIncrement(gr)}}function Dr(e,t,i,s,n,r){r=r||k.xKD.DEFAULT;const a=e.point,o=e.evaluate(t),h=ge.S4.cross(e.direction,n.getForward(),C.create());ge.S4.normalize(h);const c=ge.S4.add(ge.S4.scale(h,i,C.create()),o),l=ge.S4.add(ge.S4.scale(h,-i,C.create()),o),u=e.evaluate(t+s),d={};if(r!==k.xKD.SECONDARY)d.lines=(0,Au.pf)([a,o,c,l,c,u,l,u]);else{const n=e.evaluate(t+.5*s),r=ge.S4.add(ge.S4.scale(h,i,C.create()),n),g=ge.S4.add(ge.S4.scale(h,-i,C.create()),n);d.lines=(0,Au.pf)([a,o,c,l,c,n,l,n,r,g,r,u,g,u])}const g=ge.S4.add(ge.S4.scale(h,-i,C.create()),a),p=ge.S4.add(ge.S4.scale(h,-i,C.create()),u),m=ge.S4.add(ge.S4.scale(h,i,C.create()),a);return d.pickArea=(0,Au.fQ)(g,p,m),d}function Mr(e,t){let i=ge.S4.subtract(t,e,C.create());i=ge.S4.normalize(i,C.create());const s=Math.atan2(-i[1],i[0]),n={x:hr.getNumber("MANIPULATOR_EDIT_VIEW_ORIGIN_X_OFFSET"),y:hr.getNumber("MANIPULATOR_EDIT_VIEW_ORIGIN_Y_OFFSET")};return Math.abs(s)>=Math.PI/2&&(n.x=-(n.x+75)),s>=0&&(n.y=-(30+n.y)),n}class Cr extends Ti.u1{constructor(e,t){super(e),this.parent=t}updateGraphics(e,t,i){const s=hr.getNumber("MANIPULATOR_LINEAR_START_LINE_LENGTH_PX"),n=e.getPixelSizeAtWorldPoint(this.parent.initialRay.point);let r=ge.S4.normalize(t,C.create());r=ge.S4.scale(r,n*s,C.create());const a=ge.S4.add(this.parent.initialRay.point,r,C.create());r=ge.S4.scale(r,-1);const o=ge.S4.add(this.parent.initialRay.point,r,C.create()),h=(0,Au.pf)([this.parent.initialRay.point,this.parent.initialRay.evaluate(i),a,o]);(0,Au.Ab)(hr.getColor("MANIPULATOR_DISPLACEMENT_COLOR"),h),(0,Au.VQ)(hr.getNumber("MANIPULATOR_DISPLACEMENT_LINE_WIDTH"),h),this.updateMeshIncrement(gr,Ti.ZJ,h,pr)}}class yr extends Sr{constructor(e,t){super(e,t),this.direction0=C.fromValues(1,0,0),this.direction1=C.fromValues(0,1,0),this.normal=C.fromValues(0,0,1),this.visualGapPx=0,this.sideLengthPx=0,this.dragOffset=Q.create(),this.origin=C.create(),this.offset=Q.create(),this.dragDelta=Q.create(),this.setFadeParameters(hr.getNumber("MANIPULATOR_PLANAR_FADE_ANGLE_START"),hr.getNumber("MANIPULATOR_PLANAR_FADE_ANGLE_END"))}updateGeometry(){this.meshIncrement=(0,Au.pf)([C.fromValues(0,0,0),C.fromValues(1,0,0),C.fromValues(1,0,0),C.fromValues(1,1,0),C.fromValues(1,1,0),C.fromValues(0,1,0),C.fromValues(0,1,0),C.fromValues(0,0,0)]),this.pickIncrement=(0,Au.fQ)(C.fromValues(0,0,0),C.fromValues(1,0,0),C.fromValues(0,1,0))}setVisualGap(e){this.visualGapPx=e}setSideLength(e){this.sideLengthPx=e}getOffsetFromEvent(e){const t=e.camera.getRay(e.mouseX,e.mouseY);return this.getOffsetFromRay(t)}getOffsetFromXrInputEvent(e){return this.getOffsetFromRay(e.modelSpaceRay)}getOffsetFromRay(e){const t=C.create(),i=y.fromValues(this.normal[0],this.normal[1],this.normal[2],-C.dot(this.normal,this.origin)),s=(0,yi.fE)(e,i);if(null===s)return null;const n=C.dot(ge.S4.subtract(s,this.origin,t),this.direction0),r=C.dot(ge.S4.subtract(s,this.origin,t),this.direction1);return Q.fromValues(n,r)}onDragStart(e,t,i){const s=this.getOffsetFromEvent(t);this.displayEditView&&((0,sr.m)().trigger(ir.C.CLOSE_MANIPULATOR_EDIT_VIEW),(0,Xo.a)().setActiveManipulator(null)),s&&(this.dragOffset=ge.gv.subtract(s,this.offset,Q.create()),super.onDragStart(e,t,i))}onXrDragStart(e,t,i){const s=this.getOffsetFromXrInputEvent(t);this.displayEditView&&((0,sr.m)().trigger(ir.C.CLOSE_MANIPULATOR_EDIT_VIEW),(0,Xo.a)().setActiveManipulator(null)),s&&(this.dragOffset=ge.gv.subtract(s,this.offset,Q.create()),super.onXrDragStart(e,t,i))}onDrag(e,t){if(this.isLocked)return;const i=this.getOffsetFromEvent(t),s=!t.shiftKey;this.handleDrag(i,s,t)}onXrDrag(e,t){if(this.isLocked)return;const i=this.getOffsetFromXrInputEvent(t);this.handleDrag(i,!1)}handleDrag(e,t,i){if(e){this.offset=ge.gv.subtract(e,this.dragOffset,Q.create());for(let e=0;e<this.offset.length;e++)t&&(this.offset[e]=this.getLinearSnapValue(i,this.offset[e],this.origin)),this.offset[e]=parseFloat(this.offset[e].toFixed(this.offsetRoundDecimals));this.trigger(or.Wb.VALUE_CHANGED,this.offset,i),this.viewer.requestDraw()}}updateDefinition(e,t,i,s){this.origin=e,this.direction0=t,this.direction1=i,(0,ar.areUnitVectorsParallel)(this.direction0,this.direction1)?ut.log.warn("Trying to create a planar manipulator with two parallel directions"):this.normal=ge.S4.normalize(ge.S4.cross(this.direction0,this.direction1,C.create())),this.offset=s,(0,Fs.vm)()}getOffset(){return this.offset}evaluatePosition(e,t){return ge.S4.add(ge.S4.scale(this.direction0,e,C.create()),ge.S4.add(ge.S4.scale(this.direction1,t,C.create()),this.origin))}getOffsetPosition(){return this.evaluatePosition(this.offset[0],this.offset[1])}updateGraphics(e){super.updateGraphics(e);const t=Math.acos(Math.min(Math.abs(C.dot(e.getForward(),this.normal)),1)),i=this.isBeingManipulated()?1:1-(0,yi.CW)(this.fadeAngleStart,this.fadeAngleEnd,t);if(this.updateColor(i),!this.isHidden){const t=e.getPixelSizeAtWorldPoint(this.getOffsetPosition()),i=this.visualGapPx*t,s=this.sideLengthPx*t,n=this.evaluatePosition(this.offset[0]+i,this.offset[1]+i),r=ge.S4.scale(this.direction0,s,C.create()),a=ge.S4.scale(this.direction1,s,C.create()),o=this.normal,h=de.fromValues(r[0],r[1],r[2],0,a[0],a[1],a[2],0,o[0],o[1],o[2],0,n[0],n[1],n[2],1);this.setTransform(h)}}}class Pr extends Sr{constructor(e,t){super(e,t),this.zeroAngleDirection=C.fromValues(1,0,0),this.upDirection=C.fromValues(0,1,0),this.angle=0,this.angleRelativeToInitialZeroDirection=0,this.angleRelativeToInitialZeroDirectionForEdit=0,this.isClockWiseRotation=!0,this.radius=0,this.radialOffsetPx=0,this.dragOffset=0,this.disableMinimumOffset=!1,this.axis=new yi.zH([0,0,0],[0,0,1]),this.initialZeroAngleDirection=this.zeroAngleDirection,this.initialUpDirection=this.upDirection,this.minAngle=-Math.PI,this.maxAngle=Math.PI,this.minDisplayAngle=-Math.PI,this.maxDisplayAngle=Math.PI,this.setFadeParameters(hr.getNumber("MANIPULATOR_ANGULAR_FADE_ANGLE_START"),hr.getNumber("MANIPULATOR_ANGULAR_FADE_ANGLE_END"))}updateGeometry(){this.meshIncrement=(0,Au.y)(C.fromValues(0,0,0),1,C.fromValues(0,0,1),hr.getNumber("MANIPULATOR_CIRCLE_SEGMENTS"));const e=hr.getNumber("MANIPULATOR_ANGULAR_HANDLE_RADIUS_SCALE"),t=Math.abs(Math.atan(1/e)),i=hr.getNumber("MANIPULATOR_ANGULAR_HANDLE_SUBTENSION_FACTOR"),s=hr.getNumber("MANIPULATOR_ANGULAR_HANDLE_ARC_SEGMENTS"),n=(0,Au.QV)(C.fromValues(-e,0,0),e,C.fromValues(0,0,1),C.fromValues(1,0,0),t,i*t,s);this.meshIncrement=this.meshIncrement.concatenate(n);const r=(0,Au.QV)(C.fromValues(-e,0,0),e,C.fromValues(0,0,1),C.fromValues(1,0,0),-t,-i*t,s);this.meshIncrement=this.meshIncrement.concatenate(r);const a=6*e*t;this.pickIncrement=(0,Au.fQ)(C.fromValues(-1,a/2,0),C.fromValues(-1,-a/2,0),C.fromValues(1,a/2,0))}setAngle(e){this.angle=e}setRadialOffset(e){this.radialOffsetPx=e}getPlaneDefinition(){return y.fromValues(this.axis.direction[0],this.axis.direction[1],this.axis.direction[2],-C.dot(this.axis.point,this.axis.direction))}getMousePlanePosition(e){const t=e.camera.getRay(e.mouseX,e.mouseY);return(0,yi.fE)(t,this.getPlaneDefinition())}getXrInputPlanePosition(e){return(0,yi.fE)(e.modelSpaceRay,this.getPlaneDefinition())}getAngleFromEvent(e,t,i,s,n,r,a){const o=this.getMousePlanePosition(e);return this.getAngleFromPlanePosition(o,t,i,s,n,r,a)}getAngleFromXrInputEvent(e,t,i,s,n,r,a){const o=this.getXrInputPlanePosition(e);return this.getAngleFromPlanePosition(o,t,i,s,n,r,a)}getAngleFromPlanePosition(e,t,i,s,n,r,a){if(!e)return null;const o=ge.S4.subtract(e,this.axis.point),h=C.dot(o,i),c=C.dot(o,s);if(h*h+c*c<Ci.W.ZERO_LENGTH*Ci.W.ZERO_LENGTH)return null;const l=Math.atan2(c,h)+t;return(0,yi.Kf)(l,n,r,a)}onDefaultUnitsChanged(){this.hasEditView&&this.createEditView()}createEditView(){const e=new k.wtM;e.parameterId="angle",e.units=(0,nr.vx)().getAngleUnits(),e.value=this.angle;const t=new k.ySX;t.minValue=Math.max(0,Or(this.minDisplayAngle)),t.maxValue=Math.max(0,Or(this.maxDisplayAngle)),t.units=e.units;const i={paramQuantity:e,quantityType:k.Uqp.ANGLE,range:t};(0,sr.m)().trigger(ir.C.CREATE_MANIPULATOR_EDIT_VIEW,this,i,this.viewer)}onDragStart(e,t,i){this.dragOffset=this.angle-this.getAngleFromEvent(t,0,this.zeroAngleDirection,this.upDirection,this.angle,this.minAngle,this.maxAngle),super.onDragStart(e,t,i),this.initializeEditView()}onXrDragStart(e,t,i){this.dragOffset=this.angle-this.getAngleFromXrInputEvent(t,0,this.zeroAngleDirection,this.upDirection,this.angle,this.minAngle,this.maxAngle),super.onXrDragStart(e,t,i),this.initializeEditView()}initializeEditView(){this.displayEditView&&!this.hasEditView&&(this.createEditView(),this.initialZeroAngleDirection=C.clone(this.zeroAngleDirection),this.initialUpDirection=C.clone(this.upDirection),this.trigger(or.Wb.CACHE_TRANSFORM),this.isClockWiseRotation=this.dragOffset>0,this.angleRelativeToInitialZeroDirectionForEdit=0,(0,Xo.a)().setActiveManipulator(this))}onEditChange(e){const t=Math.abs(Ar(e.value));this.isClockWiseRotation?this.angleRelativeToInitialZeroDirectionForEdit=t:this.angleRelativeToInitialZeroDirectionForEdit=-t,this.trigger(or.Wb.VALUE_EDITED)}getSnapAngle(e,t){const i=e.camera,s=hr.getNumberArray("MANIPULATOR_ANGULAR_SNAP_DIVISOR"),n=hr.getNumber("MANIPULATOR_ANGULAR_SNAP_RESOLUTION_PX"),r=this.getMousePlanePosition(e);let a=0;if(r){const e=i.getUnitSizeAtWorldPoint(r)/(0,Ji.x_)(),t=ge.S4.subtract(r,this.axis.point),o=ge.S4.length(t);for(;a<s.length;++a){if(o*(Math.PI/s[a])*e<=n)break}}const o=s[a]*t/Math.PI,h=Math.round(o),c=h-o;let l=hr.getNumber("MANIPULATOR_ANGULAR_SNAP_ANGLE_DEVIATION");return l*=1+a/s.length,Math.abs(c)<=l&&(t=h*Math.PI/s[a]),t}onDrag(e,t){if(this.isLocked)return;const i=this.getAngleFromEvent(t,this.dragOffset,this.zeroAngleDirection,this.upDirection,this.angle,this.minAngle,this.maxAngle),s=this.hasEditView?this.getAngleFromEvent(t,this.dragOffset,this.initialZeroAngleDirection,this.initialUpDirection,this.angleRelativeToInitialZeroDirectionForEdit,this.minDisplayAngle,this.maxDisplayAngle):null,n=!t.shiftKey;this.handleDrag(i,s,n,t)}onXrDrag(e,t){if(this.isLocked)return;const i=this.getAngleFromXrInputEvent(t,this.dragOffset,this.zeroAngleDirection,this.upDirection,this.angle,this.minAngle,this.maxAngle),s=this.hasEditView?this.getAngleFromXrInputEvent(t,this.dragOffset,this.initialZeroAngleDirection,this.initialUpDirection,this.angleRelativeToInitialZeroDirectionForEdit,this.minDisplayAngle,this.maxDisplayAngle):null;this.handleDrag(i,s,!1)}handleDrag(e,t,i,s){if(null!==e){if(this.angle=parseFloat(e.toFixed(this.offsetRoundDecimals)),i&&(this.angle=this.getSnapAngle(s,this.angle)),this.angle=(0,yi.uZ)(this.angle,this.minAngle,this.maxAngle),this.hasEditView&&null!==t){this.isClockWiseRotation=t>0;let e=(0,yi.FE)(this.initialZeroAngleDirection,this.zeroAngleDirection,this.getAxis().direction)+this.angle;e<this.minDisplayAngle?e=(0,yi.Tu)(e,this.minDisplayAngle):e>this.maxDisplayAngle&&(e=(0,yi.Kb)(e,this.maxDisplayAngle)),this.angleRelativeToInitialZeroDirection=t,this.angleRelativeToInitialZeroDirectionForEdit=e}this.trigger(or.Wb.VALUE_CHANGED,this.angle,s),this.viewer.requestDraw()}}updateDefinition(e,t,i,s,n){let r;if(this.isBeingManipulated()&&(r=ge.S4.add(ge.S4.scale(this.zeroAngleDirection,Math.cos(this.angle),C.create()),ge.S4.scale(this.upDirection,Math.sin(this.angle),C.create()))),this.axis=new yi.zH(e,t),this.zeroAngleDirection=ge.S4.normalize(i,C.create()),this.radius=s,this.upDirection=ge.S4.cross(this.axis.direction,this.zeroAngleDirection,C.create()),ge.S4.normalize(this.upDirection),n||(n=0),this.isBeingManipulated()&&r){const e=C.dot(r,this.zeroAngleDirection),t=C.dot(r,this.upDirection);if(e*e+t*t<Ci.W.ZERO_LENGTH*Ci.W.ZERO_LENGTH)this.angle=n;else{const i=Math.atan2(t,e);this.angle=(0,yi.Kf)(i,this.angle,this.minAngle,this.maxAngle)}}else this.angle=n;(0,Fs.vm)()}updateLimits(e,t){this.minAngle=e,this.maxAngle=t}updateEditLimits(e,t){this.minDisplayAngle=e,this.maxDisplayAngle=t}setDisableMinimumOffset(e){this.disableMinimumOffset=e}getAngle(){return this.angle}getEditAngle(){return this.angleRelativeToInitialZeroDirectionForEdit}getEditAngleDisplacement(){let e=(0,yi.FE)(this.initialZeroAngleDirection,this.zeroAngleDirection,this.getAxis().direction);if(this.maxDisplayAngle-this.minDisplayAngle>2*Math.PI&&(0,ar.sign)(e)!==(0,ar.sign)(this.angleRelativeToInitialZeroDirection)){const t=2*Math.PI-Math.abs(e);e=(0,ar.sign)(this.angleRelativeToInitialZeroDirection)*t}let t=Math.abs(e)-Math.abs(this.angleRelativeToInitialZeroDirectionForEdit);return this.angleRelativeToInitialZeroDirection<0&&(t=-t),t}getAxis(){return this.axis}getZeroAngleDirection(){return this.zeroAngleDirection}getPosition(e,t){const i=Math.cos(e)*t,s=Math.sin(e)*t,n=C.create(),r=C.create();return ge.S4.add(ge.S4.scale(this.zeroAngleDirection,i,n),ge.S4.add(ge.S4.scale(this.upDirection,s,r),this.axis.point))}updateEditBoxPosition(e){const t=e.getPixelSizeAtWorldPoint(this.axis.point),i=(0,Ji.x_)(),s=(hr.getNumber("MANIPULATOR_ANGULAR_ARROW_SHAFT_LENGTH_PX")+hr.getNumber("MANIPULATOR_ANGULAR_ARROW_RADIUS_PX")+hr.getNumber("MANIPULATOR_ANGULAR_ARROW_LENGTH_PX")+2*hr.getNumber("MANIPULATOR_ANGULAR_HANDLE_RADIUS")*i+2*hr.getNumber("MANIPULATOR_ANGULAR_HANDLE_RADIUS")*i)*t,n=this.getPosition(0,s),r=e.projectWorldPointToCanvas(this.axis.point),a=e.projectWorldPointToCanvas(n),o=Mr(r,a);a[0]=o.x+a[0]/(0,Ji.x_)(),a[1]=o.y+a[1]/(0,Ji.x_)(),this.triggerEditOriginChange(a[0],a[1])}updateGraphics(e){super.updateGraphics(e);const t=Math.acos(Math.abs(C.dot(e.getForward(),this.axis.direction))),i=this.isBeingManipulated()?1:1-(0,yi.CW)(this.fadeAngleStart,this.fadeAngleEnd,t);if(this.updateColor(i),!this.isHidden){const t=e.getPixelSizeAtWorldPoint(this.axis.point),i=this.axis.point,s=this.radius+t*this.radialOffsetPx,n=this.getPosition(this.angle,s),r=hr.getNumber("MANIPULATOR_ANGULAR_HANDLE_RADIUS")*t,a=n,o=ge.S4.scale(ge.S4.normalize(ge.S4.subtract(n,i,C.create())),r),h=ge.S4.normalize(this.axis.direction,C.create()),c=ge.S4.cross(h,o,C.create()),l=de.fromValues(o[0],o[1],o[2],0,c[0],c[1],c[2],0,h[0],h[1],h[2],0,a[0],a[1],a[2],1),u=(0,Ji.x_)();if(ge.w$.scale(l,C.fromValues(u,u,u)),this.hasEditView){this.updateEditBoxPosition(e);let t=0;if(this.isDragging)t=this.angleRelativeToInitialZeroDirectionForEdit;else{let e=(0,yi.FE)(this.initialZeroAngleDirection,this.zeroAngleDirection,this.getAxis().direction);this.maxDisplayAngle-this.minDisplayAngle>2*Math.PI&&(e=Math.abs(this.angleRelativeToInitialZeroDirectionForEdit)>Ci.W.ZERO_ANGLE?function(e,t,i,s){let n=(0,yi.FE)(e,t,i);s?n<0&&(n=2*Math.PI+n):n>0&&(n=-1*(2*Math.PI-n));return n}(this.initialZeroAngleDirection,this.zeroAngleDirection,this.getAxis().direction,this.isClockWiseRotation):this.angleRelativeToInitialZeroDirectionForEdit),t=e}const i=Math.abs(Or(t));this.triggerEditValueChange({value:i,isLength:!1});const s=1.5,n=hr.getNumber("MANIPULATOR_ANGULAR_HANDLE_RADIUS_SCALE")-s,r=hr.getNumber("MANIPULATOR_ANGULAR_HANDLE_SUBTENSION_FACTOR")*Math.abs(Math.atan(1/n)),a=2*hr.getNumber("MANIPULATOR_CIRCLE_SEGMENTS"),o=t<0?r:-r,h=C.fromValues(-n,0,0);let c=(0,Au.QV)(h,n,C.fromValues(0,0,1),C.fromValues(1,0,0),o,-t,a);const l=C.create(),u=C.fromValues(0,1,0),d=C.fromValues(1,0,0),g=n*Math.cos(-t),p=n*Math.sin(-t);ge.S4.add(h,ge.S4.add(ge.S4.scale(u,p,C.create()),ge.S4.scale(d,g,C.create()),l),l);const m=new yi.zH(h,ge.S4.subtract(h,l,C.create())),f=hr.getNumber("MANIPULATOR_ANGULAR_START_LINE_LENGTH_FACTOR"),I=(0,Au.pf)([m.evaluate(-n+f),m.evaluate(-n-f)]);c=c.concatenate(I),(0,Au.Ab)(hr.getColor("MANIPULATOR_DISPLACEMENT_COLOR"),c),(0,Au.VQ)(hr.getNumber("MANIPULATOR_DISPLACEMENT_LINE_WIDTH"),c),this.updateMeshIncrement(gr,Ti.ZJ,c,pr)}this.setTransform(l)}}dragByIncrementValue(e){const t=this.viewer.getCamera();if(!t)return;const i=t.getPixelSizeAtWorldPoint(this.axis.point),s=this.getClampedRadius(i,!0);let n=t.projectWorldPointToCanvas(this.getPosition(this.angle,s));const r={mouseX:n[0],mouseY:n[1],camera:t};this.onDragStart(null,r,{requestDrag:!1}),e=Ar(e),n=t.projectWorldPointToCanvas(this.getPosition(this.angle+e,s)),r.mouseX=n[0],r.mouseY=n[1],this.onDrag(null,r),this.onDragStop(null,r)}getClampedRadius(e,t){if(this.disableMinimumOffset)return this.radius;let i=this.radius;const s=hr.getNumber("MANIPULATOR_ANGULAR_MINIMUM_RADIUS_PX")*e;return i<s&&(i=s),t&&(i+=e*this.radialOffsetPx),i}}function Ar(e){return e="degree"===(0,nr.vx)().getAngleUnits()?e*Math.PI/180:e}function Or(e){return e="degree"===(0,nr.vx)().getAngleUnits()?180*e/Math.PI:e}class vr extends Pr{constructor(e){super(e)}updateGraphics(e){let t=Math.abs(C.dot(e.getForward(),this.axis.direction));t>1?t=1:t<-1&&(t=-1);const i=Math.acos(t),s=this.isBeingManipulated()?1:1-(0,yi.CW)(this.fadeAngleStart,this.fadeAngleEnd,i);if(s<=0)return void this.removeMeshIncrements();const n=e.getPixelSizeAtWorldPoint(this.axis.point),r=this.getClampedRadius(n,!0),a=this.getPosition(this.angle,r),o=Math.cos(this.angle),h=Math.sin(this.angle),c=ge.S4.add(ge.S4.scale(this.zeroAngleDirection,-h,C.create()),ge.S4.scale(this.upDirection,o,C.create()));this.angle<0&&ge.S4.negate(c);const l=Dr(new yi.zH(a,c),hr.getNumber("MANIPULATOR_ANGULAR_ARROW_SHAFT_LENGTH_PX")*n,hr.getNumber("MANIPULATOR_ANGULAR_ARROW_RADIUS_PX")*n,hr.getNumber("MANIPULATOR_ANGULAR_ARROW_LENGTH_PX")*n,e,this.style);this.updateLines("linear",l.lines,s),this.updatePickArea(l.pickArea);const u=this.getClampedRadius(n,!1),d=u+hr.getNumber("MANIPULATOR_ANGULAR_ARROW_LEADER_EXTENSION_PX")*n,g=this.getPosition(0,d),p=this.getPosition(this.angle,d),m=(0,Au.pf)([this.axis.point,g,this.axis.point,p]);this.updateLines("leaders",m,.5*s);const f=Math.abs(this.angle)*u/n,I=(0,Au.QV)(this.axis.point,u,this.axis.direction,this.zeroAngleDirection,0,this.angle,Math.floor(f/10));this.updateLines("arc",I,.5*s),!this.isHidden&&this.hasEditView&&this.updateEditBoxPosition(e)}}class Rr extends Sr{constructor(e,t){super(e,t),this.position=C.fromValues(0,0,0),this.dragPlane=y.fromValues(0,0,1,0),this.xrDragDistance=-1,this.lastMouseRay=new yi.zH([0,0,0],[1,0,0])}updateGeometry(){const e=hr.getNumber("MANIPULATOR_CIRCLE_SEGMENTS");this.meshIncrement=(0,Au.y)(C.fromValues(0,0,0),1,C.fromValues(0,0,1),e),this.pickIncrement=(0,Au.$)(C.fromValues(0,0,0),1,C.fromValues(0,0,1),e)}onDragStart(e,t,i){if(!this.isEnabled)return;this.displayEditView&&((0,sr.m)().trigger(ir.C.CLOSE_MANIPULATOR_EDIT_VIEW),(0,Xo.a)().setActiveManipulator(null));const s=t.camera.getForward();this.dragPlane=[s[0],s[1],s[2],C.dot(s,this.position)],super.onDragStart(e,t,i)}onXrDragStart(e,t,i){this.isEnabled&&(this.displayEditView&&((0,sr.m)().trigger(ir.C.CLOSE_MANIPULATOR_EDIT_VIEW),(0,Xo.a)().setActiveManipulator(null)),this.xrDragDistance=t.modelSpaceRay.findPositionOfPoint(this.position),super.onXrDragStart(e,t,i))}onDrag(e,t){if(this.isLocked)return;this.lastMouseRay=t.camera.getRay(t.mouseX,t.mouseY);const i=(0,yi.fE)(this.lastMouseRay,this.dragPlane);this.handleDrag(i,t)}onXrDrag(e,t){if(this.isLocked)return;const i=t.modelSpaceRay.evaluate(this.xrDragDistance);this.handleDrag(i)}handleDrag(e,t){e&&(this.position=e,this.trigger(or.Wb.VALUE_CHANGED,this.position,t?.mouseX,t?.mouseY,t),this.viewer.requestDraw())}getLastMouseRay(){return this.lastMouseRay}updateDefinition(e){this.position=e,(0,Fs.vm)()}updateGraphics(e){if(super.updateGraphics(e),this.updateColor(),!this.isHidden){const t=e.getPixelSizeAtWorldPoint(this.position),i=hr.getNumber("MANIPULATOR_FREE_DRAG_RADIUS_PX")*t,s=this.position,n=ge.S4.scale(e.getForward(),-1,C.create()),r=ge.S4.scale(e.getRight(),i,C.create()),a=ge.S4.scale(e.getUp(),i,C.create()),o=de.fromValues(r[0],r[1],r[2],0,a[0],a[1],a[2],0,n[0],n[1],n[2],0,s[0],s[1],s[2],1);this.setTransform(o)}}}const wr=new xi.hF({isVisible:!0,isPickable:!0,isShowThrough:!0,isDepthTested:!1,priority:xi.DO.DEFAULT,primitiveType:Di.MX.POINTS}),_r=new xi.hF(Object.assign({},wr,{priority:xi.DO.HIGHEST})),Nr=new xi.hF(Object.assign({},wr,{isPickable:!1}));class br extends Sr{constructor(e,t,i){super(e),this.points=[],this.pointBoundsCenter=C.create(),this.minimimumPointDistance=-1,this.lastPixelSize=-1,this.pointSize=-1,this.hoveredPointIndex=br.NO_SELECTED_INDEX,this.isMultiSelect=!1,this.isPointSelected=[],this.suppressedIndices=new Set,this.selectedIndicesServerState=new Set,this.boxSelectedIndices=new Set,this.isMultiSelect=t,this.isMultiSelect&&(this.listenTo(e.getEventDispatcher(),is.f4Y,this.onPicksBoxSelected),this.listenTo(e.getEventDispatcher(),is.KB0,this.onBoxSelectionFinished)),this.manipulatorChangesInFlightSubscription=i?.subscribe((e=>{this.manipulatorChangesInFlight=e}))}updateDefinition(e,t,i){this.selectedIndicesServerState=t,0===(this.manipulatorChangesInFlight??0)&&(this.isPointSelected=e.map(((e,t)=>this.selectedIndicesServerState.has(t)))),this.suppressedIndices=i??new Set,this.processPoints(e)}processPoints(e){this.points=e;const t=new yi.kB;t.addPointArray(e),t.isFinite()&&(this.pointBoundsCenter=t.center());let i=-1;this.minimimumPointDistance=-1;for(let t=0;t<e.length;++t)for(let s=t+1;s<e.length;++s){const n=C.squaredDistance(e[t],e[s]);n>Ci.W.ZERO_LENGTH_SQUARED&&(i<0||n<i)&&(i=n)}i>=0&&(this.minimimumPointDistance=Math.sqrt(i)),this.lastPixelSize=-1,this.pointSize=-1}updatePointGraphics(){if(this.isMultiSelect&&this.viewer.performingBoxSelection())return;if(this.removeMeshIncrements(),this.stopListening(this),this.stopListening(this.viewer.getEventDispatcher()),this.pointSize<=0)return;const e=hr.getPointFont("MANIPULATOR_POINT_FONT");for(let t=0;t<this.points.length;++t){const i="point"+t,s=this.getSelectionIdForIndex(t),n=this.isMultiSelect?this.getPointColorMultiSelect(t):this.getPointColor(t),r=this.isMultiSelect&&this.suppressedIndices.has(t)?this.pointSize/1.5:this.pointSize,a=(0,Au.Pu)(this.points[t],i,n,r,e);this.updateMeshIncrement(i,s,a,this.getPointNodeProperties(t)),this.listenTo(this,Ti.zw.MOUSE_ENTER+s,this.onMouseEnter),this.listenTo(this,Ti.zw.MOUSE_LEAVE+s,this.onMouseLeave),this.listenTo(this,Ti.zw.CLICK+s,this.onClick)}this.isMultiSelect&&(this.listenTo(this.viewer.getEventDispatcher(),is.f4Y,this.onPicksBoxSelected),this.listenTo(this.viewer.getEventDispatcher(),is.KB0,this.onBoxSelectionFinished))}onViewWillDraw(e,t){if(this.isHidden)return;const i=e.getPixelSizeAtWorldPoint(this.pointBoundsCenter);if(i!==this.lastPixelSize){let e;this.lastPixelSize=i;const t=this.minimimumPointDistance/i,s=hr.getNumber("MANIPULATOR_SMALL_POINT_DISTANCE_PX"),n=hr.getNumber("MANIPULATOR_LARGE_POINT_DISTANCE_PX");if(t<=s)e=br.SMALL_SIZE_CONSTANT;else if(t>=n)e=br.LARGE_SIZE_CONSTANT;else{const i=(t-s)/(n-s);e=(0,yi.CD)(br.SMALL_SIZE_CONSTANT,br.LARGE_SIZE_CONSTANT,i)}this.pointSize!==e&&(this.pointSize=e,this.updatePointGraphics())}}onMouseEnter(e){this.isEnabled&&this.setHoveredPoint(this.getIndexForSelection(e))}onMouseLeave(e){if(!this.isEnabled)return;this.getIndexForSelection(e)===this.hoveredPointIndex&&this.setHoveredPoint(br.NO_SELECTED_INDEX)}onClick(e){if(!this.isEnabled)return;const t=this.getIndexForSelection(e);!this.isMultiSelect&&this.isPointSelected[t]||this.setSelectedPoint(t)}onPicksBoxSelected(e){this.isEnabled&&this.queueManipulatorSelectionsFromPicks(e)}onBoxSelectionFinished(){this.setBoxSelectedPoints()}queueManipulatorSelectionsFromPicks(e){for(const t of e){const e=(0,j.as)(qm.D,t)?.uiSelection;e?.uiElement instanceof br&&this.boxSelectedIndices.add(this.getIndexForSelection(e))}}getSelectionIdForIndex(e){return""+e}getIndexForSelection(e){return+e.selectionId}getPointColor(e){return this.isPointSelected[e]?hr.getColor("MANIPULATOR_OUTLINE_DRAG_COLOR"):e===this.hoveredPointIndex?hr.getColor("MANIPULATOR_OUTLINE_HOVER_COLOR"):hr.getColor("MANIPULATOR_OUTLINE_COLOR")}getPointColorMultiSelect(e){return this.suppressedIndices.has(e)?hr.getColor("MANIPULATOR_OUTLINE_DISABLED_COLOR"):e===this.hoveredPointIndex?hr.getColor("MANIPULATOR_OUTLINE_HOVER_COLOR"):this.isPointSelected[e]?hr.getColor("MANIPULATOR_OUTLINE_DRAG_COLOR"):hr.getColor("MANIPULATOR_OUTLINE_COLOR")}getPointNodeProperties(e){return this.suppressedIndices.has(e)?Nr:this.isPointSelected[e]||e===this.hoveredPointIndex?_r:wr}setHoveredPoint(e){this.hoveredPointIndex!==e&&(this.hoveredPointIndex=e,this.updatePointGraphics())}setSelectedPoint(e){this.isMultiSelect?this.isPointSelected[e]=!this.isPointSelected[e]:(this.isPointSelected[this.isPointSelected.findIndex((e=>e))]=!1,this.isPointSelected[e]=!0),this.trigger(or.Wb.VALUE_CHANGED,this.isPointSelected),this.updatePointGraphics()}setBoxSelectedPoints(){for(const e of this.boxSelectedIndices)this.isPointSelected[e]=!this.isPointSelected[e];this.boxSelectedIndices.clear(),this.trigger(or.Wb.VALUE_CHANGED,this.isPointSelected),this.updatePointGraphics()}remove(){super.remove(),this.manipulatorChangesInFlightSubscription?.unsubscribe()}}br.NO_SELECTED_INDEX=-1,br.SMALL_SIZE_CONSTANT=hr.getNumber("MANIPULATOR_POINT_SMALL_SIZE"),br.LARGE_SIZE_CONSTANT=hr.getNumber("MANIPULATOR_POINT_LARGE_SIZE");class Lr extends Sr{constructor(e,t){super(e,t),this.scale=1,this.dragScale=1,this.minScale=1e-5,this.maxScale=1e3,this.ray=new yi.zH([0,0,0],[0,0,1]),this.gapLengthPx=hr.getNumber("MANIPULATOR_LINEAR_SHAFT_LENGTH_PX")*Math.sqrt(2),hr.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX"),this.headLengthPx=hr.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX"),this.isDraggable=!t||!t.hasOwnProperty("isDraggable")||!!t.isDraggable,this.setFadeParameters(hr.getNumber("MANIPULATOR_PLANAR_FADE_ANGLE_START"),hr.getNumber("MANIPULATOR_PLANAR_FADE_ANGLE_END"))}updateGeometry(){this.meshIncrement=(0,Au.AD)(C.fromValues(0,0,this.gapLengthPx),C.fromValues(0,0,1),C.fromValues(1,0,0),0,this.headLengthPx,this.headLengthPx/Math.sqrt(3)),this.pickIncrement=(0,Au.fQ)(C.fromValues(-this.headLengthPx/2,0,this.gapLengthPx),C.fromValues(this.headLengthPx/2,0,this.gapLengthPx),C.fromValues(-this.headLengthPx/2,0,this.gapLengthPx+this.headLengthPx))}setGapLength(e){this.gapLengthPx=e}setHeadLength(e){this.headLengthPx=e}setIsDraggable(e){this.isDraggable=e}getPlaneDefinition(){return y.fromValues(this.normal[0],this.normal[1],this.normal[2],-C.dot(this.ray.point,this.normal))}getMousePlanePosition(e){const t=e.camera.getRay(e.mouseX,e.mouseY);return(0,yi.fE)(t,this.getPlaneDefinition())}getXrInputPlanePosition(e){return(0,yi.fE)(e.modelSpaceRay,this.getPlaneDefinition())}createEditView(){const e=new k.wtM;e.parameterId="scale",e.units="",e.value=this.scale;const t=new k.ySX;t.minValue=this.minScale,t.maxValue=this.maxScale,t.units="";const i={paramQuantity:e,quantityType:k.Uqp.REAL,range:t};(0,sr.m)().trigger(ir.C.CREATE_MANIPULATOR_EDIT_VIEW,this,i,this.viewer)}onDragStart(e,t,i){const s=this.getMousePlanePosition(t);s&&(this.initializeDrag(s),super.onDragStart(e,t,i))}onXrDragStart(e,t,i){const s=this.getXrInputPlanePosition(t);s&&(this.initializeDrag(s),super.onXrDragStart(e,t,i))}initializeDrag(e){if(!e)return;const t=ge.S4.subtract(e,this.ray.point,C.create());this.originToInitialLength=ge.S4.length(t),this.dragScale=this.scale,this.displayEditView&&!this.hasEditView&&(this.createEditView(),(0,Xo.a)().setActiveManipulator(this))}onEditChange(e){this.scale=Math.max(0,e.value),this.trigger(or.Wb.VALUE_EDITED)}getScaleFromEvent(e){return this.getScaleFromPosition(this.getMousePlanePosition(e))}getScaleFromXrInputEvent(e){return this.getScaleFromPosition(this.getXrInputPlanePosition(e))}getScaleFromPosition(e){const t=ge.S4.subtract(e,this.ray.point,C.create());return ge.S4.length(t)/this.originToInitialLength}onDrag(e,t){!this.isLocked&&this.isDraggable&&this.handleDrag(this.getScaleFromEvent(t),t)}onXrDrag(e,t){!this.isLocked&&this.isDraggable&&this.handleDrag(this.getScaleFromXrInputEvent(t))}handleDrag(e,t){this.scale=this.dragScale*e,this.scale=parseFloat(this.scale.toFixed(this.offsetRoundDecimals)),this.trigger(or.Wb.VALUE_CHANGED,this.scale,t),this.viewer.requestDraw()}resetScale(){this.scale=1}updateDefinition(e,t,i){this.ray=new yi.zH(e,i),this.normal=t,(0,Fs.vm)()}getScale(){return this.scale}updateGraphics(e){super.updateGraphics(e);const t=Math.acos(Math.min(Math.abs(C.dot(e.getForward(),this.normal)),1)),i=this.isBeingManipulated()?1:1-(0,yi.CW)(this.fadeAngleStart,this.fadeAngleEnd,t);if(this.updateColor(i),!this.isHidden){const t=e.getPixelSizeAtWorldPoint(this.ray.point),i=this.isBeingDragged?this.scale/this.dragScale:1,s=this.ray.point,n=ge.S4.scale(ge.S4.normalize(this.ray.direction,C.create()),i*t),r=ge.S4.scale(ge.S4.normalize(ge.S4.cross(e.getForward(),n,C.create())),i*t),a=ge.S4.scale(ge.S4.normalize(ge.S4.cross(n,r,C.create())),i*t),o=de.fromValues(r[0],r[1],r[2],0,a[0],a[1],a[2],0,n[0],n[1],n[2],0,s[0],s[1],s[2],1);if(this.hasEditView){this.triggerEditValueChangeNoUnit({value:this.scale});const i=(0,Ji.x_)(),n=this.gapLengthPx*t*i,r=this.ray.evaluate(n),a=e.projectWorldPointToCanvas(r),o=Mr(e.projectWorldPointToCanvas(s),a);a[0]=o.x+a[0]/(0,Ji.x_)(),a[1]=a[1]/(0,Ji.x_)(),this.triggerEditOriginChange(a[0],a[1])}this.setTransform(o)}}}var Fr=i(64748);class xr{constructor(){this.operandA=null,this.operandB=null}resetWithOperands(e,t){return this.operandA=e,this.operandB=t,this.operandB.setOperand(this.operandA),this}getRangeIteratorForBufferSet(e){return this.operandA&&this.operandB?this.operandB.getRangeIteratorForBufferSet(e):null}setOperand(e){this.operandA.setOperand(e)}makeSceneDebugObject(){const e={text:"ChainedOperator",children:[]};return(0,Fs.n9)(e,this.operandA),e}}const Br=new xr;class Vr{constructor(e,t){this.occurrenceId=e,this.isUIElement=!1,this.shouldSetOccurrenceUniform=!0,this.isolated=!1,this.canIsolateChange=!0,this.cullingState=null,this.hiddenBaseMeshRanges=null,this.hiddenPreviewMeshRanges=null,this.hiddenFromPickBaseMeshRanges=null,this.hiddenFromPickPreviewMeshRanges=null,this.baseHighlights=null,this.previewHighlights=null,this.transform=de.create(),this.lod=nE.DEFAULT,this.visibility=Fs.EE.VISIBLE,this.boundables=new Set,this.isClippedBySectionPlane=t}destroy(){this.hiddenBaseMeshRanges&&(this.hiddenBaseMeshRanges.destroy(),this.hiddenBaseMeshRanges=null),this.hiddenPreviewMeshRanges&&(this.hiddenPreviewMeshRanges.destroy(),this.hiddenPreviewMeshRanges=null),this.hiddenFromPickBaseMeshRanges&&(this.hiddenFromPickBaseMeshRanges.destroy(),this.hiddenFromPickBaseMeshRanges=null),this.hiddenFromPickPreviewMeshRanges&&(this.hiddenFromPickPreviewMeshRanges.destroy(),this.hiddenFromPickPreviewMeshRanges=null),this.baseHighlights&&(this.baseHighlights.destroy(),this.baseHighlights=null),this.previewHighlights&&(this.previewHighlights.destroy(),this.previewHighlights=null),this.boundables.clear()}onPreviewDestroyed(){this.hiddenPreviewMeshRanges&&(this.hiddenPreviewMeshRanges.destroy(),this.hiddenPreviewMeshRanges=null),this.hiddenFromPickPreviewMeshRanges&&(this.hiddenFromPickPreviewMeshRanges.destroy(),this.hiddenFromPickPreviewMeshRanges=null),this.previewHighlights&&(this.previewHighlights.destroy(),this.previewHighlights=null)}getOccurrenceId(){return this.occurrenceId}setShouldSetOccurrenceUniform(e){this.shouldSetOccurrenceUniform=e}getShouldSetOccurrenceUniform(){return this.shouldSetOccurrenceUniform}setTransform(e){(0,yi.cl)(this.transform,e)||(this.transform=de.clone(e),this.damageBoundables())}getTransform(){return this.transform}setIsolated(e){this.canIsolateChange&&(this.isolated=e)}getIsolated(){return this.isolated}setCanIsolateChange(e){this.canIsolateChange=e}setLod(e){this.lod=e}getLod(){return this.lod}setVisibility(e){e!==this.visibility&&(this.visibility=e,this.damageBoundables())}getVisibility(){return this.visibility}getCullingState(){return this.cullingState}get culledMeshGroupIdSet(){const e=this.cullingState;return e&&e.size?e:null}setCullingState(e,t){if(!t)return void(this.cullingState=e);let i=this.culledMeshGroupIdSet;e===Fs.uc.CULLED?(i||(i=new Set,this.cullingState=i),i.add(t)):i&&(i.delete(t),0===i.size&&(this.cullingState=Fs.uc.VISIBLE))}getMeshGroupCullingState(e){if(this.cullingState===Fs.uc.VISIBLE||this.cullingState===Fs.uc.CULLED)return this.cullingState;const t=this.culledMeshGroupIdSet;return t&&t.has(e)?Fs.uc.CULLED:Fs.uc.VISIBLE}isStyledRangeCulled(e,t){const i=e.getMeshRangesGroupId();return this.isMeshGroupCulled(i,t)}isMeshGroupCulled(e,t){return this.cullingState!==Fs.uc.VISIBLE&&t.getUsage()===fs.L.BASE&&(this.cullingState===Fs.uc.CULLED||!!e&&this.getMeshGroupCullingState(e)===Fs.uc.CULLED)}isVisible(e){return!(this.cullingState===Fs.uc.CULLED&&e.getUsage()===fs.L.BASE)&&(e.isHighlighting()?this.hasHighlight():this.visibility===Fs.EE.VISIBLE)}isBoundable(){return this.visibility===Fs.EE.VISIBLE||this.hasHighlight()}isIncrementBoundable(e,t){const i=this.getHiddenRangesForUsage(t),s=this.getHighlightsForUsage(t),n=!!i&&i.containsIncrement(e),r=!!s&&s.entityHasHighlight(e);return!n||r}hasHighlight(){let e=!1;return this.baseHighlights&&(e=this.baseHighlights.hasHighlight()),this.previewHighlights&&(e=e||this.previewHighlights.hasHighlight()),e}getOrCreateHiddenRangesForUsage(e){return e===fs.L.BASE?(this.hiddenBaseMeshRanges||(this.hiddenBaseMeshRanges=new DS(this.occurrenceId+".hiddenBaseMeshRanges")),this.hiddenBaseMeshRanges):(this.hiddenPreviewMeshRanges||(this.hiddenPreviewMeshRanges=new DS(this.occurrenceId+".hiddenPreviewMeshRanges")),this.hiddenPreviewMeshRanges)}getHiddenRangesForUsage(e){return e===fs.L.BASE?this.hiddenBaseMeshRanges:this.hiddenPreviewMeshRanges}getOrCreateHiddenFromPickRangesForUsage(e){return e===fs.L.BASE?(this.hiddenFromPickBaseMeshRanges||(this.hiddenFromPickBaseMeshRanges=new DS(this.occurrenceId+".hiddenFromPickBaseMeshRanges")),this.hiddenFromPickBaseMeshRanges):(this.hiddenFromPickPreviewMeshRanges||(this.hiddenFromPickPreviewMeshRanges=new DS(this.occurrenceId+".hiddenFromPickPreviewMeshRanges")),this.hiddenFromPickPreviewMeshRanges)}getHiddenFromPickRangesForUsage(e){return e===fs.L.BASE?this.hiddenFromPickBaseMeshRanges:this.hiddenFromPickPreviewMeshRanges}hideIncrement(e,t){return!!this.getOrCreateHiddenRangesForUsage(t).onIncrementAdded(e)&&(this.damageBoundables(),!0)}showIncrement(e,t){const i=this.getHiddenRangesForUsage(t);return!(!i||!i.onIncrementRemoved(e))&&(this.damageBoundables(),!0)}isIncrementHidden(e,t){const i=this.getHiddenRangesForUsage(t);return!!i&&i.containsIncrement(e)}hideIncrementFromPick(e,t){this.getOrCreateHiddenFromPickRangesForUsage(t).onIncrementAdded(e)}isIncrementHiddenFromPick(e,t){const i=this.getHiddenFromPickRangesForUsage(t);return!!i&&i.containsIncrement(e)}resetHiddenFromPick(){this.hiddenFromPickBaseMeshRanges&&(this.hiddenFromPickBaseMeshRanges.destroy(),this.hiddenFromPickBaseMeshRanges=null),this.hiddenFromPickPreviewMeshRanges&&(this.hiddenFromPickPreviewMeshRanges.destroy(),this.hiddenFromPickPreviewMeshRanges=null)}getOrCreateHighlightsForUsage(e){return e===fs.L.BASE?(this.baseHighlights||(this.baseHighlights=new zE),this.baseHighlights):(this.previewHighlights||(this.previewHighlights=new zE),this.previewHighlights)}getBaseOccurrenceHighlight(){return this.baseHighlights?this.baseHighlights.getHighestPriorityOccurrenceHighlight():null}getHighlightsForUsage(e){return e===fs.L.BASE?this.baseHighlights:this.previewHighlights}updateEntityHighlight(e,t,i,s){const n=this.hasHighlight();this.getOrCreateHighlightsForUsage(s).updateEntityHighlight(e,t,i),n!==this.hasHighlight()&&this.damageBoundables()}updateOccurrenceHighlight(e,t,i){const s=this.hasHighlight();this.getOrCreateHighlightsForUsage(i).updateOccurrenceHighlight(e,t),s!==this.hasHighlight()&&this.damageBoundables()}clearHighlight(e,t){const i=this.hasHighlight(),s=this.getHighlightsForUsage(t);s&&s.clearHighlight(e),i!==this.hasHighlight()&&this.damageBoundables()}clearAllOccurrenceLevelHighlights(){this.hasHighlight()&&(this.baseHighlights&&this.baseHighlights.clearAllOccurrenceLevelHighlights(),this.previewHighlights&&this.previewHighlights.clearAllOccurrenceLevelHighlights(),this.damageBoundables())}getEntityHighlights(e,t){const i=this.getHighlightsForUsage(t);return i?i.getEntityHighlights(e):null}removeEntityHighlights(e,t){const i=this.getHighlightsForUsage(t);i&&i.removeEntityHighlights(e)}getMeshRangeOperator(e){if(e.isHighlighting()){const t=this.getHighlightsForUsage(e.getUsage());return t?t.getHighlightOperator(e):$I}if(e.isPicking()){const t=this.getHiddenRangesForUsage(e.getUsage()),i=this.getHiddenFromPickRangesForUsage(e.getUsage());return i&&t?(Br.resetWithOperands(t,i),Br):t||i}{e.applyStyle(WE);const t=this.getHighlightsForUsage(e.getUsage()),i=this.getHiddenRangesForUsage(e.getUsage());return t?t.getHighlightStyleOperator(e,i):i}}addBoundable(e){this.boundables.add(e)}removeBoundable(e){this.boundables.delete(e)}damageBoundables(){for(const e of this.boundables.values())e.damageBounds()}makeSceneDebugObject(){const e="Occurrence "+this.occurrenceId,t=[];return t.push((0,Fs.z4)("transform",this.transform)),t.push((0,Fs.z4)("isolated",this.isolated)),t.push((0,Fs.z4)("isUIElement",this.isUIElement)),t.push((0,Fs.z4)("clippedBySectionPlane",this.isClippedBySectionPlane)),t.push((0,Fs.z4)("lod",this.lod)),t.push((0,Fs.z4)("visibility",(0,Fs._I)(this.visibility))),t.push((0,Fs.z4)("cullingState",this.cullingState instanceof Set?Array.from(this.cullingState).toString():(0,j.getKeyForValue)(Fs.uc,this.cullingState))),t.push((0,Fs.z4)("shouldSetOccurrenceUniform",this.shouldSetOccurrenceUniform)),this.hiddenBaseMeshRanges&&t.push(this.hiddenBaseMeshRanges.makeSceneDebugObject()),this.hiddenPreviewMeshRanges&&t.push(this.hiddenPreviewMeshRanges.makeSceneDebugObject()),this.hiddenFromPickBaseMeshRanges&&t.push(this.hiddenFromPickBaseMeshRanges.makeSceneDebugObject()),this.hiddenFromPickPreviewMeshRanges&&t.push(this.hiddenFromPickPreviewMeshRanges.makeSceneDebugObject()),this.baseHighlights&&t.push(this.baseHighlights.makeSceneDebugObject("baseHighlights")),this.previewHighlights&&t.push(this.previewHighlights.makeSceneDebugObject("previewHighlights")),{text:e,children:t}}getIsClippedBySectionPlanes(){return this.isClippedBySectionPlane}setIsClippedBySectionPlanes(e){this.isClippedBySectionPlane=e}}var Ur=i(59974),Gr=i(94533),Hr=i(61857),kr=i(12613),Wr=i(84605);const zr=!1;function Xr(e){zr?ut.log.info&&ut.log.info(e):ut.log.trace&&ut.log.trace(e)}var Zr;function qr(e,t,i,s){return e+"."+t+"."+i+"."+s}!function(e){e.NORMAL="NORMAL",e.FLATTENED="FLATTENED"}(Zr||(Zr={}));let Yr=null;function Kr(){(0,dt.supportsIndexedDb)(window).then((e=>{e&&function(){try{let e=new Hr.ZP("GraphicsDetailSettings");e.version(1).stores({settings:"[viewerUsage+workspaceOrVersionId+elementId+modelUsage], enableSSAOFilter, enableEdgeSilhouettes, enableSSAO, enableBackfaceSilhouettes, enableLowestLodSwitching, enableSectionPlaneEdgeDetection"}),e.version(2).stores({settings:"[viewerUsage+workspaceOrVersionId+elementId+modelUsage], enableSSAOFilter, enableEdgeSilhouettes, enableSSAO, enableBackfaceSilhouettes, enableLowestLodSwitching, enableSectionPlaneEdgeDetection, lowLevelBodyProportion"}).upgrade((function(e){e.settings.toCollection().modify((function(e){e.lowLevelBodyProportion=0}))})),e.version(3).stores({settings:"[viewerUsage+workspaceOrVersionId+elementId+modelUsage], enableSSAOFilter, enableEdgeSilhouettes, enableSSAO, enableBackfaceSilhouettes, enableSectionPlaneEdgeDetection, lowLevelBodyProportion"}).upgrade((function(e){e.settings.toCollection().modify((function(e){delete e.enableLowestLodSwitching}))})),e.open().then((function(){Xr("Opened graphics detail database")})).catch((function(t){e=null,ut.log.warn("Failed to open graphics detail database: "+t)})),Yr=e}catch(e){Yr=null,ut.log.warn("Exception while creating settings database: "+e)}}()}))}Kr();const jr=X.default.getManager().getNumber("MAX_LOW_LEVEL_BODY_PROPORTION"),Qr=X.default.getManager().getNumber("LOW_LEVEL_BODY_PROPORTION_STEP");class $r{constructor(e,t,i,s){this.CLONING_PROPERTIES_TO_SKIP={viewerUsage:!0,workspaceOrVersionId:!0,elementId:!0,modelUsage:!0,enableSSAOFilter:!0},this.enableSSAOFilter=!1,this.enableEdgeSilhouettes=!0,this.enableSSAO=!0,this.enableBackfaceSilhouettes=!0,this.lowLevelBodyProportion=0,this.enableSectionPlaneEdgeDetection=!0,this.viewerUsage=e||Zr.NORMAL,this.workspaceOrVersionId=t||"",this.elementId=i||"",this.modelUsage=s||k.rvN.BASE}getKeyPath(){return[this.viewerUsage,this.workspaceOrVersionId,this.elementId,this.modelUsage]}getKeyString(){return qr(this.viewerUsage,this.workspaceOrVersionId,this.elementId,this.modelUsage)}persistSettings(){Yr?(Xr("Saving detail settings for "+this.getKeyString()),Yr.settings.put(this).catch((function(e){Xr("Save failed: "+e)}))):Xr("Database not available for persisting settings "+this.getKeyString())}updateFromDatabase(e){const t=Ur.defer();return Yr?Yr.settings.get(this.getKeyPath()).then((t=>{t?(Xr("Got saved details settings for "+this.getKeyString()+": "+JSON.stringify(t)),(0,j.overwriteMatchingProperties)(this,t)):(e?(Xr("No saved details settings for "+this.getKeyString()+" - initializing from "+e.getKeyString()),(0,j.overwriteMatchingProperties)(this,e,this.CLONING_PROPERTIES_TO_SKIP)):Xr("No saved details settings for "+this.getKeyString()+" - creating new settings"),this.persistSettings())})).catch((function(e){ut.log.info("Failed to retrieve graphics detail settings: "+e)})).finally((function(){t.resolve()})):(Xr("Settings database not available for updating settings"),t.resolve()),t.promise}decreaseDetail(){let e=!1;return this.enableEdgeSilhouettes||this.enableSectionPlaneEdgeDetection?(this.enableEdgeSilhouettes=!1,this.enableSectionPlaneEdgeDetection=!1,e=!0,Xr("Decreasing graphics detail: dropped edge-based silhouettes and section plane edges")):this.enableSSAO?(this.enableSSAO=!1,e=!0,Xr("Decreasing graphics detail: dropped ambient occlusion")):this.enableBackfaceSilhouettes?(this.enableBackfaceSilhouettes=!1,e=!0,Xr("Decreasing graphics detail: dropped image-based silhouettes")):this.lowLevelBodyProportion<jr&&(this.lowLevelBodyProportion=Math.min(this.lowLevelBodyProportion+Qr,jr),Xr("Decreasing graphics detail: Increased lowest LOD proportion to: "+this.lowLevelBodyProportion),e=!0),e&&this.persistSettings(),e}increaseDetail(e,t){let i=!1;this.lowLevelBodyProportion>0?(this.lowLevelBodyProportion=Math.max(0,this.lowLevelBodyProportion-Qr),Xr("Increasing graphics detail: decreased lowest LOD proportion to: "+this.lowLevelBodyProportion),i=!0):!this.enableBackfaceSilhouettes&&t?(this.enableBackfaceSilhouettes=!0,i=!0,Xr("Increasing graphics detail: adding image-based silhouettes")):!this.enableSSAO&&e?(this.enableSSAO=!0,i=!0,Xr("Increasing graphics detail: enabled ambient occlusion")):!this.enableEdgeSilhouettes&&t?(this.enableEdgeSilhouettes=!0,i=!0,Xr("Increasing graphics detail: enabled edge based silhouette edges")):this.enableSectionPlaneEdgeDetection||(this.enableSectionPlaneEdgeDetection=!0,i=!0,Xr("Increasing graphics detail: enabled section plane edges")),i&&this.persistSettings()}}class Jr{constructor(e,t,i){this.AnalyticsService=e,this.viewer=t,this.frameTimer=i,this.REDUCTION_THRESHOLD_MS=1e3/X.default.getManager().getNumber("DETAIL_REDUCTION_THRESHOLD_FPS"),this.ENHANCEMENT_THRESHOLD_MS=1e3/X.default.getManager().getNumber("DETAIL_ENHANCEMENT_THRESHOLD_FPS"),this.FULL_DETAIL_OCCURRENCE_REDUCTION_THRESHOLD=X.default.getManager().getNumber("FULL_DETAIL_OCCURRENCE_REDUCTION_THRESHOLD"),this.RENDER_PERFORMANCE_WARNING_TIMEOUT_SECONDS=X.default.getManager().getNumber("RENDER_PERFORMANCE_WARNING_TIMEOUT_SECONDS"),this.RENDER_PERFORMANCE_CLEAR_WARNING_TIMEOUT_SECONDS=X.default.getManager().getNumber("RENDER_PERFORMANCE_CLEAR_WARNING_TIMEOUT_SECONDS"),this.detailSettings={},this.activeInteractiveKey="",this.lastInteractiveTimingActedOn=-1,this.overrideSettings=null,this.disableInterativeUpdates=!1,this.renderingPerformanceMessageEnabled=!0,this.renderingPerformanceMessageTimeout=null,this.clearRenderingPerformanceMessageTimeout=null,this.clientVersion=null,this.viewerUsage=t.getIsForFlattenedDisplay()?Zr.FLATTENED:Zr.NORMAL,this.detailSettings[Wr.Q.FULL]=new $r(this.viewerUsage),this.detailSettings[Wr.Q.FULL].enableSSAOFilter=!0}onSettingStateChange(){const e=Ki.Jq.StateParameterService.workspaceId()||Ki.Jq.StateParameterService.versionId()||"",t=Ki.Jq.StateParameterService.elementId()||"",i=_s(),s=qr(this.viewerUsage,e,t,i);s!==this.activeInteractiveKey&&(Xr("Switching to detail settings for "+s),this.activeInteractiveKey=s,this.lastInteractiveTimingActedOn=-1)}ensureInteractiveSettingsExist(){if(this.detailSettings[this.activeInteractiveKey]){const e=Ur.defer();return e.resolve(),e.promise}{const e=Ki.Jq.StateParameterService.workspaceId()||Ki.Jq.StateParameterService.versionId()||"",t=Ki.Jq.StateParameterService.elementId()||"",i=_s();Xr("Initializing detail settings for "+this.activeInteractiveKey);const s=qr(this.viewerUsage,e,t,k.rvN.BASE),n=this.detailSettings[s]||this.detailSettings[Wr.Q.FULL],r=new $r(this.viewerUsage,e,t,i);return this.detailSettings[this.activeInteractiveKey]=r,r.updateFromDatabase(n).then((()=>{r.enableSSAO&&!this.isInteractiveSsaoEnabled()&&(Xr("Ambient occlusion disabled for interactive frames due to performance issues"),r.enableSSAO=!1),!r.enableBackfaceSilhouettes&&!r.enableEdgeSilhouettes||this.areInteractiveSilhouettesEnabled()||(Xr("Silhouette Edges disabled for interactive frames due to performance issues"),r.enableBackfaceSilhouettes=!1,r.enableEdgeSilhouettes=!1)}))}}forceLowestDetailSettings(e){this.ensureInteractiveSettingsExist();const t=this.detailSettings[this.activeInteractiveKey];t.enableSSAOFilter=!1,t.enableEdgeSilhouettes=!1,t.enableSSAO=!1,t.enableBackfaceSilhouettes=!1,t.enableSectionPlaneEdgeDetection=!1,t.lowLevelBodyProportion=jr,e&&t.persistSettings()}increaseDetail(){this.disableInterativeUpdates=!0,this.detailSettings[this.activeInteractiveKey].increaseDetail(this.isInteractiveSsaoEnabled(),this.areInteractiveSilhouettesEnabled())}decreaseDetail(){this.disableInterativeUpdates=!0,this.detailSettings[this.activeInteractiveKey].decreaseDetail()}getDetailSettings(){if(this.overrideSettings)return this.overrideSettings;let e=Wr.Q.FULL;return this.frameTimer.userIsInteracting()?(this.updateInteractiveSettings(),e=this.activeInteractiveKey):this.frameTimer.userIsManipulating()&&(e=this.activeInteractiveKey),this.detailSettings[e]?this.detailSettings[e]:(ut.log.warn("Could not find detail settings for key: "+e),this.detailSettings[Wr.Q.FULL])}getInteractiveSettings(){return this.ensureInteractiveSettingsExist(),this.detailSettings[this.activeInteractiveKey]}updateInteractiveSettings(){if(this.disableInterativeUpdates)return;this.ensureInteractiveSettingsExist();const e=this.frameTimer.getDrawLoopDetails(Wr.Q.INTERACTIVE),t=this.frameTimer.getTimingDetails(Wr.Q.INTERACTIVE);if(this.lastInteractiveTimingActedOn<0)return void(this.lastInteractiveTimingActedOn=t.timingCount);const i=t.timingCount-this.lastInteractiveTimingActedOn;if(e.averageTime>this.REDUCTION_THRESHOLD_MS)this.detailSettings[this.activeInteractiveKey].decreaseDetail(),e.reset();else if(i>=2)if(t.averageTime>this.REDUCTION_THRESHOLD_MS){const e=this.detailSettings[this.activeInteractiveKey].decreaseDetail();this.lastInteractiveTimingActedOn=t.timingCount,e&&!qt(this.viewer.getGlContext())||this.startRenderingPerformanceMessageTimeout()}else t.averageTime<this.ENHANCEMENT_THRESHOLD_MS?(this.detailSettings[this.activeInteractiveKey].increaseDetail(this.isInteractiveSsaoEnabled(),this.areInteractiveSilhouettesEnabled()),this.lastInteractiveTimingActedOn=t.timingCount,this.startClearRenderingPerformanceMessageTimeout()):this.startClearRenderingPerformanceMessageTimeout()}isInteractiveFramerateBelowThreshold(){const e=this.frameTimer.getDrawLoopDetails(Wr.Q.INTERACTIVE),t=this.frameTimer.getTimingDetails(Wr.Q.INTERACTIVE);return e.timingCount>0&&e.averageTime>this.REDUCTION_THRESHOLD_MS||t.timingCount>0&&t.averageTime>this.REDUCTION_THRESHOLD_MS}isInteractiveSsaoEnabled(){if((0,dt.isPlatformMetaQuest)())return!1;const e=this.viewer.getRendererInfo();if(!e)return!0;const t=/AMD/gi.test(e.glRenderer)||(0,dt.isBrowserFirefox)()&&/Radeon/gi.test(e.glRenderer)&&/ATI Technologies/gi.test(e.glVendor),i=/Apple GPU/gi.test(e.glRenderer);return!((0,dt.isPlatformMac)()&&(t||i&&(0,dt.isBrowserSafari)()))}areInteractiveSilhouettesEnabled(){return!(0,dt.isBrowserSafari)()||15!==(0,dt.getSafariVersion)()}setOverrideSettings(e){this.overrideSettings=e}updateFromLoadedScene(){const e=this.viewer.getModelViewManagers().getManager().getModelStatistics(!1),t=e.partOccurrences+e.surfaceOccurrences+e.curveOccurrences,i=this.detailSettings[Wr.Q.FULL],s=!i.enableEdgeSilhouettes;t>=this.FULL_DETAIL_OCCURRENCE_REDUCTION_THRESHOLD?(s||Xr("Reducing full detail rendering settings due to large occurrence count: "+t),i.enableEdgeSilhouettes=!1,i.enableSSAO=!1,i.enableBackfaceSilhouettes=!1,i.enableSectionPlaneEdgeDetection=!1,this.viewer.getSilhouetteTask().clearPendingRequests()):(s&&Xr("Increasing full detail rendering settings due to smaller occurrence count: "+t),i.enableEdgeSilhouettes=!0,i.enableSSAO=!0,i.enableBackfaceSilhouettes=!0,i.enableSectionPlaneEdgeDetection=!0)}areFullDetailEdgeSilhouettesEnabled(){return this.detailSettings[Wr.Q.FULL].enableEdgeSilhouettes}getClientVersion(){if(!this.clientVersion){const e=Ki.Jq.ClientVersionService.getRunningVersion(),t=e.match(new RegExp("(\\d+\\.\\d+)","i"));t&&t.length>0?this.clientVersion=t[0]:this.clientVersion=e}return this.clientVersion}setRenderingPerformanceMessageEnabled(e){this.renderingPerformanceMessageEnabled=e}startRenderingPerformanceMessageTimeout(){if((0,Gr.Z)(this.clearRenderingPerformanceMessageTimeout)&&(window.clearTimeout(this.clearRenderingPerformanceMessageTimeout),this.clearRenderingPerformanceMessageTimeout=null),!this.renderingPerformanceMessageEnabled||(0,Gr.Z)(this.renderingPerformanceMessageTimeout)||this.viewer.hasPendingBodiesToLoad()||this.viewer.getIsForFlattenedDisplay())return;const e=""+(0,dt.getBrowserMajorVersion)(),t=this.getClientVersion();window.localStorage.getItem("osRenderPerformanceMessageBrowserVersion")===e&&window.localStorage.getItem("osRenderPerformanceMessageClientVersion")===t||(Xr("Starting render performance message timeout"),this.renderingPerformanceMessageTimeout=window.setTimeout((()=>{window.localStorage.setItem("osRenderPerformanceMessageBrowserVersion",e),window.localStorage.setItem("osRenderPerformanceMessageClientVersion",t);const i=Ki.Jq.MessageBubbleService.createMessageBubble();i.showMessage(i18n("Reduced rendering performance detected."),void 0,i18n("Check system compatibility in a new tab")).then((()=>{this.AnalyticsService.trackEventForDocumentId("PERFORMANCE_MESSAGE","render_performance_action_click",(0,kr.n)());const e=location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+"/check";window.open(e),i.dismissMessage()})),this.AnalyticsService.trackEventForDocumentId("PERFORMANCE_MESSAGE","render_performance_warning",(0,kr.n)()),this.renderingPerformanceMessageTimeout=null}),1e3*this.RENDER_PERFORMANCE_WARNING_TIMEOUT_SECONDS))}startClearRenderingPerformanceMessageTimeout(e){!e&&qt(this.viewer.getGlContext())||(0,Gr.Z)(this.clearRenderingPerformanceMessageTimeout)||!(0,Gr.Z)(this.renderingPerformanceMessageTimeout)||(Xr("Starting clear render performance message timeout"),this.clearRenderingPerformanceMessageTimeout=window.setTimeout((()=>{(0,Gr.Z)(this.renderingPerformanceMessageTimeout)&&(window.clearTimeout(this.renderingPerformanceMessageTimeout),this.renderingPerformanceMessageTimeout=null,Xr("Cleared performance message timeout")),this.clearRenderingPerformanceMessageTimeout=null}),1e3*this.RENDER_PERFORMANCE_CLEAR_WARNING_TIMEOUT_SECONDS))}}var ea=i(36573),ta=i(97570);const ia=window.document.createElement("canvas"),sa=window.document.createElement("canvas"),na={},ra={};let aa={};function oa(e){ra[e]=!0}function ha(e){const t=(0,Fs.Wj)(),i=na[e];return i&&t-i[0]<X.default.getManager().getNumber("THUMBNAIL_LOCAL_EXPIRATION_INTERVAL")?i[1]:null}function ca(e,t){const i=(0,Fs.Wj)();na[e]=[i,t]}function la(e){delete na[e]}function ua(e){aa[e]=!0}const da=new $r;function ga(e,t,i,s){return e+"-"+t+"-"+i+"x"+s}function pa(e,t,i,s){return e+"-"+t+"-"+i+"x"+s}function ma(e,t,i,s){return e+"-"+t+"-"+i+"x"+s}function fa(e,t,i,s){ia.width=e,ia.height=t,sa.width=e/s,sa.height=t/s;const n=ia.getContext("2d"),r=n.createImageData(e,t);r.data.set(i),n.putImageData(r,0,0);const a=sa.getContext("2d");return a.translate(0,t/s),a.scale(1/s,-1/s),a.drawImage(ia,0,0),sa.toDataURL()}function Ia(e){const t=e.getPrimaryViewController().getZoomFitTargetCamera(e.getCamera().getFrame(),e.getFitBounds());e.pushCameraState(t),e.getBodyManager().updateForFrame(e.getRenderContext()),e.renderContext.prepareForNextFrame(),e.depthSamplingPass.retrieve(e.getRenderContext(),{includePlanes:!0,performIsolationTest:!0}),e.popCameraState();const i=[];for(let s=0;s<e.depthSamplingPass.points.length;++s)i.push(t.canvasToWorld(e.depthSamplingPass.points[s]));return i}function Ea(e,t,i){if(!e.getCamera())return;const s=e.getModelViewManagers().getManager(),n=s.partStudios[s.getDisplayedFullElementId()];if(!n)return;ta.t.getController().pauseListeningForRedraw();const r=n.bodyComponent,a=n.sketchComponent,o=s.getDisplayedElementId(),h=ea.W.getSingleton().getComputedData(o),c=(0,Fs.Wj)(),l=X.default.getManager().getNumber("THUMBNAIL_PART_RENDER_LIMIT"),u=X.default.getManager().getNumber("THUMBNAIL_PART_RENDER_TIME_LIMIT");n.removeInContextAssemblies();const d=e.getGlContext();if(!d)return;const g=e.getOrCreateFrameBuffer(d.UNSIGNED_BYTE,"",{storageType:d.DEPTH_STENCIL,attachmentType:d.DEPTH_STENCIL_ATTACHMENT});e.setUserIsManipulatingWithTimeout(),e.detailManager.setOverrideSettings(da),e.getEventDispatcher().trigger(yD.gV);const p=e.getRenderingMode();e.setRenderingMode(k.P1.SHADED_WITH_EDGES),e.getIsolatedOccurrenceManager()?.clearAllIsolateNoAnimation();const m=e.getFilteredEntitiesHighlightController();let f=!1;m&&(f=m.getIsEnabled(),e.disableCurrentLaminarHighlightController());const I=e.getPrimaryViewController();I.isPerspective()&&e.setPrimaryViewController(I.getMatchingOrthographicController()),e.viewManipulator&&e.viewManipulator.hide();const E=e.getCamera().clone();let S=null;const T=(0,Fs.Z)();(0,Fs.uP)(!1);const D=n.getHideableFeatureIds(),M=[];for(const e in r.bodyMetaData){const t=r.retrieveBodyMetaData(e);t&&t.shouldProduceLocalThumbnail()&&M.push(e)}const P=[];for(const e in n.sketchComponent.sketchToSketchEntityMapping)aa[e]&&P.push(e);const A=h?P.length:0,O=function(e,t,i,s){t&&t.forEach((t=>{const n=e.extractMeshIncrement(t);if(n){const e=C.create();for(let t=0;t<n.points.length;t+=3*i)e[0]=n.points[t],e[1]=n.points[t+1],e[2]=n.points[t+2],s(e)}return!1}))},v=ga(o,s.displayedElementMicroversionIdAndConfiguration.getKey(),t,i),R=!(v in na);let w=0;const _=!1;for(let e=0;e<M.length&&w<l;e++){pa(o,M[e],t,i)in ra&&w++}if(R||w>0||A>0){r.getDecalComponent().removeFromScene();for(const e in n.sketchComponent.sketchToSketchEntityMapping)n.imageComponent.onSketchHidden(e);n.planeComponent.getHideableFeatureIds().forEach((function(e){n.planeComponent.hideShowFeature(e,Fs.EE.HIDDEN)}));const t=n.pointBodyComponent.featureToIds.firstKey();t&&n.pointBodyComponent.hideShowFeature(t,Fs.EE.HIDDEN),n.mateConnectorComponent.getHideableFeatureIds().forEach((function(e){n.mateConnectorComponent.hideShowFeature(e,Fs.EE.HIDDEN)})),e.getEdgePointController()&&(e.getEdgePointController().removeAllEdgePointUiElements((0,Ce.vi)()),e.getEdgePointController().purgeEdgePointUiElements()),S=(0,LS.o_)(o),e.viewController.setStandardView("Trimetric")}const N=Ia(e),b=y.fromValues(0,0,2*t,2*i),L=[1,1,2*t-2,2*i-2];e.setBaseFrameBuffer(g),e.renderContext.pushViewport(b),e.getCamera().setViewport(b),g.update(e.renderContext,b[2],b[3]);const F=g.width*g.height*4,x=new Uint8Array(F);if(g.bindBuffer(),R&&(e.getCamera().zoomToFit(N,1.05,L),e.draw(),d.readPixels(0,0,g.width,g.height,d.RGBA,d.UNSIGNED_BYTE,x),ca(v,fa(g.width,g.height,x,2))),w>0||A>0){for(let e=0;e<D.length;e++)for(let t=0;t<n.components.length;++t)n.components[t].hasFeature(D[e])&&(D[e]in n.sketchComponent.sketchToSketchEntityMapping?n.hideSketch(D[e]):n.components[t].hideShowFeature(D[e],Fs.EE.HIDDEN));for(const e in r.partStudioBodyIdToOccurrenceId)r.setBodyCullingState(r.partStudioBodyIdToOccurrenceId[e],Fs.uc.CULLED,e,_);e.getBodyManager().setVisible(!1)}if(w>0){e.viewController.setStandardView("Trimetric");let s=0;for(let n=0;n<M.length&&s<l&&(0,Fs.Es)(c)<u;n++){const a=pa(o,M[n],t,i);if(a in ra){const t=r.retrieveBodyMetaData(M[n]);let i=[];t.isOpenCompositeBody?i=r.getInstantiableConstituentIds(t):i.push(M[n]);let o=null;if(t.isComposite){o=[];for(let e=0;e<t.constituentBodyIds.length;++e){r.bodyToEntity.get(t.constituentBodyIds[e])&&(o=o.concat(r.bodyToEntity.get(t.constituentBodyIds[e]).getKeys()))}}else o=r.bodyToEntity.get(M[n]).getKeys();for(let e=0;e<i.length;++e)r.setBodyCullingState(r.partStudioBodyIdToOccurrenceId[i[e]],Fs.uc.VISIBLE,i[e],_),r.hideShowBody(i[e],Fs.EE.VISIBLE,r.partStudioBodyIdToOccurrenceId[i[e]]);const h=2,c=1;e.getCamera().zoomToFit(O.bind(void 0,r,o,h),c,L),e.draw(0,{skipUpdateBodyCulling:!0}),d.readPixels(0,0,g.width,g.height,d.RGBA,d.UNSIGNED_BYTE,x),ca(a,fa(g.width,g.height,x,2));for(let e=0;e<i.length;++e)r.setBodyCullingState(r.partStudioBodyIdToOccurrenceId[i[e]],Fs.uc.CULLED,i[e],_);delete ra[a],s++}}}if(A>0)for(let s=0;s<P.length&&!((0,Fs.Es)(c)>=u);++s){const r=P[s],c=h.computedData[r];if(c&&c.planeMatrix){let s;const h=a.featureToIds.get(r);if(h&&(s=h.getKeys()),!s)continue;const l=ma(o,r,t,i);n.sketchComponent.hideShowFeature(r,Fs.EE.VISIBLE);const u=c.planeMatrix,p=[u.m00,u.m10,u.m20,0,u.m01,u.m11,u.m21,0,u.m02,u.m12,u.m22,0,0,0,0,1],m=e.getCamera().clone();m.setFrame(p),e.getCamera().copyFrom(m),e.getCamera().zoomToFit(O.bind(void 0,a,s,1),1.05,L),e.draw(0,{skipUpdateBodyCulling:!0}),d.readPixels(0,0,g.width,g.height,d.RGBA,d.UNSIGNED_BYTE,x),ca(l,fa(g.width,g.height,x,2)),n.sketchComponent.hideShowFeature(r,Fs.EE.HIDDEN)}}e.setBaseFrameBufferToDefault(),g.unbindBuffer(),g.destroy(),e.renderContext.popViewport(),e.getCamera().copyFrom(E),e.viewManipulator&&e.viewManipulator.show(),e.detailManager.setOverrideSettings(null),e.setRenderingMode(p),e.setPrimaryViewController(I),e.getBodyManager().setVisible(!0),S&&(0,LS.Wh)(S,o),f&&(e.setFilteredEntitiesHighlightController(m),m.enable()),(0,Fs.uP)(T),ta.t.resumeListeningForRedraw();const B=(0,Fs.Wj)();aa={},e.getEventDispatcher().trigger(yD.Xc),ut.log.trace("thumbnailgenerator.generateThumbnail time "+(B-c))}da.enableSSAO=!1,da.enableEdgeSilhouettes=!1,da.enableBackfaceSilhouettes=!1;var Sa=i(91296);class Ta extends Ti.u1{constructor(e,t){super((0,j.as)(eT,t),e.sceneGraphId),this.texture=null,this.text="",this.offsetAdjustmentFunction=null,this.drawBox=!1,this.boxOffsetPixels=0,this.backgroundColor=[1,1,1,1],this.backgroundOpacity=0,this.updateOnEachFrame=!0,this.origin=e.origin,this.right=e.right,this.up=e.up,this.heightPx=e.heightPx,this.orientToScreen=!!e.orientToScreen,this.offsetUp=void 0!==e.offsetUp?e.offsetUp:yi.iK.MID,this.offsetRight=void 0!==e.offsetRight?e.offsetRight:yi.iK.MID,this.orientToScreen&&(this.right=[1,0,0],this.up=[0,0,1]);const i=X.default.getManager();this.color=e.color||i.getColor("DEFAULT_TEXT_COLOR"),this.font=e.font||i.getString("DEFAULT_TEXT_FONT"),this.material=Fi(),this.nodeProperties=new xi.hF(Object.assign({},{isPickable:!1,isTwoSided:!0,primitiveType:Di.MX.TRIANGLES,isShowThrough:!0,isDepthTested:!1,material:this.material},e.textNodePropertyOptions||{})),this.boxNodeProperties=new xi.hF(Object.assign({},{isPickable:!1,primitiveType:Di.MX.LINES},e.boxNodePropertyOptions||{}))}remove(){this.destroyText(),this.material&&(this.material.destroy(),this.material=null),super.remove()}destroyText(){this.texture&&(this.texture.destroy(),this.texture=null)}setOffsetAdjustmentFunction(e){const t=this.offsetAdjustmentFunction;return this.offsetAdjustmentFunction=e,t}setDrawBox(e,t,i,s){this.drawBox=e,t&&(this.boxOffsetPixels=t),i&&(this.backgroundColor=i),s&&(this.backgroundOpacity=s),e||this.removeMeshIncrement("box")}setHeightPx(e){this.setHeightAndColor(e)}setText(e){this.text!==e&&(this.destroyText(),this.text=e,this.texture=_o(this.viewer,e,{color:this.color,font:this.font,size:this.heightPx}),this.material.ambientTexture=this.texture,(0,Fs.vm)())}setHeightAndColor(e,t){let i=!1;t&&this.color!==t&&(this.color=t,i=!0),e&&this.heightPx!==e&&(this.heightPx=e,i=!0),i&&this.text&&(this.destroyText(),this.drawBox?this.texture=_o(this.viewer,this.text,{color:this.color,font:this.font,size:this.heightPx,paddingWithinBorder:this.boxOffsetPixels,backgroundColor:this.backgroundColor,backgroundOpacity:this.backgroundOpacity}):this.texture=_o(this.viewer,this.text,{color:this.color,font:this.font,size:this.heightPx}),this.material.ambientTexture=this.texture,(0,Fs.vm)())}onViewWillDraw(e){if(!this.texture)return;if(!this.updateOnEachFrame&&this.hasMeshIncrements())return;const t=this.getTextCorners(e);if(this.updateMeshIncrement("text",Ti.ZJ,this.createScreenSpaceQuad(e,t.lowerLeft,t.lowerRight,t.upperLeft),this.nodeProperties),this.orientToScreen){const t=C.clone(e.getUp()),i=C.create();C.normalize(i,C.cross(i,e.getForward(),t));const s=C.create();C.normalize(s,C.cross(s,t,i));const n=de.fromValues(i[0],i[1],i[2],0,s[0],s[1],s[2],0,t[0],t[1],t[2],0,this.origin[0],this.origin[1],this.origin[2],1);this.setTransform(n)}if(this.drawBox){const e=ge.S4.scale(ge.S4.subtract(t.lowerRight,t.lowerLeft,C.create()),.5),i=ge.S4.scale(ge.S4.subtract(t.upperLeft,t.lowerLeft,C.create()),.5),s=ge.S4.scale(ge.S4.add(t.lowerRight,t.upperLeft,C.create()),.5);this.updateMeshIncrement("box",Ti.ZJ,(0,Au.PU)(s,e,i,this.color,1),this.boxNodeProperties)}}getTextCorners(e){const t=this.origin;this.transform&&ge.w$.multiplyVec3(this.transform,this.origin,C.create());const i=e.getPixelSizeAtWorldPoint(t);let s=this.origin;this.orientToScreen&&(s=this.getOffsetOrigin(i));let n=new is.vjd;return n.pixelSize=i,n.lowerLeft=C.clone(s),n.lowerRight=ge.S4.add(ge.S4.scale(this.right,i*this.texture.filledWidthPx,C.create()),s),n.upperLeft=ge.S4.add(ge.S4.scale(this.up,i*this.texture.filledHeightPx,C.create()),s),this.offsetAdjustmentFunction&&(n=this.offsetAdjustmentFunction(n)),n}getOffsetOrigin(e){return[-this.offsetRight*e*this.texture.filledWidthPx,0,-this.offsetUp*e*this.texture.filledHeightPx]}createScreenSpaceQuad(e,t,i,s){const n=this.orientToScreen?[!1,!1]:Po(e,this.right,this.up,this.transform);return(0,Au.fQ)(t,i,s,void 0,[n[0]?this.texture.rightCoordinate:this.texture.leftCoordinate,n[1]?this.texture.topCoordinate:this.texture.bottomCoordinate],[n[0]?this.texture.leftCoordinate:this.texture.rightCoordinate,n[1]?this.texture.bottomCoordinate:this.texture.topCoordinate])}}class Da extends Ti.u1{constructor(e,t,i){super(e,Zo.EG),this.text=t,this.options=i,this.texture=null,this.material=Fi(),this.nodeProperties=new xi.hF({isPickable:!0,primitiveType:Di.MX.TRIANGLES,material:this.material}),this.updateWithOptions(i)}hasEqualTextAndOptions(e,t){return this.text===e&&(0,Hs.Z)(this.options,t)}remove(){super.remove(),this.texture?.destroy(),this.material.destroy()}updateWithOptions(e){this.texture=_o(this.viewer,this.text,e),this.material.ambientTexture=this.texture;const t=this.texture.createTexturedQuad();this.bounds=t.getBounds(),this.options=e,this.updateMeshIncrement("text",Da.SELECTION_ID,t,this.nodeProperties),this.updatePosition()}getDiagonalVector(e){return this.bounds.diagonalVector(e)}positionRelativeTo(e,t,i){this.anchorPoint=C.clone(e),this.textAttachmentSpotX=t,this.textAttachmentSpotY=i,this.updatePosition()}updatePosition(){if(this.anchorPoint){const e=yi.iK.LOW,t=this.bounds.getLocationInBox(this.textAttachmentSpotX,this.textAttachmentSpotY,e);this.setTransform(ge.w$.translate(de.create(),ge.S4.subtract(this.anchorPoint,t,t)))}}getTextCenterInCanvas(){const e=this.bounds.createTransformedCopy(this.transform).center(),t=this.viewer.getCamera(),i=(0,Ji.x_)();return[e[0]/i,(t.getCanvasHeight()-e[1])/i]}getTransformedBounds(){return this.bounds.createTransformedCopy(this.transform)}}Da.SELECTION_ID="text";var Ma=i(63675),Ca=i(35692);let ya=!1;class Pa{constructor(){this.rayAperture=0,this.hitSelectionOnly=!1,this.mouseCreated=!1,this.mouseIsInMotion=!1,this.hitTestRay=new yi.zH([0,0,0],[0,0,0]),this.connexion=new _3Dconnexion(this),this.connexion.connect()||ut.log.trace("Failed to initialize connection to 3Dconnexion NL-Proxy")}logMatrix(e,t){const i=function(t){return e[t].toFixed(2)};console.group(t),console.log(i(0)+" "+i(1)+" "+i(2)+" "+i(3)),console.log(i(4)+" "+i(5)+" "+i(6)+" "+i(7)),console.log(i(8)+" "+i(9)+" "+i(10)+" "+i(11)),console.log(i(12)+" "+i(13)+" "+i(14)+" "+i(15)),console.groupEnd()}logVector(e,t){console.group(t),console.log(e[0].toFixed(2)+" "+e[1].toFixed(2)+" "+e[2].toFixed(2)),console.groupEnd()}logNumber(e,t){console.group(t),console.log(e),console.groupEnd()}onConnect(){this.connexion.create3dmouse(window,"Onshape"),ya=!0}onDisconnect(e){ut.log.trace("3Dconnexion NL-Proxy disconnected: "+e)}getViewer(){return(0,Jo.N9)()}getViewController(){const e=this.getViewer();return e?e.getPrimaryViewController():null}getCamera(){const e=this.getViewer();return e?e.getCamera():null}checkState(e){return!!(this.getViewer()&&this.getViewController()&&this.getCamera())||(ut.log.trace("Attempted to call spaceball."+e+" with no active document."),!1)}onViewerDraw(e,t){this.checkState("onViewerDraw")&&this.mouseCreated&&this.mouseIsInMotion&&e===this.getViewer()&&this.connexion.update3dcontroller({frame:{time:t}})}getViewMatrix(){return this.checkState("getViewMatrix")?this.getCamera().getFrame():null}getConstructionPlane(){if(!this.checkState("getConstructionPlane"))return null;const e=this.getViewer().getSketch();let t=null;return e&&(t=(0,yi.sc)(e.getPlaneMatrix()),t=Array.prototype.slice.call(t)),t}getViewExtents(){return this.checkState("getViewExtents")?this.getCamera().isOrthographic()?this.getCamera().getExtents():(ut.log.info("Tried to get view extents for a non-orthographic camera."),null):null}getFov(){return this.checkState("getFov")?this.getCamera().isOrthographic()?(ut.log.info("Tried to get fov for an orthographic camera"),0):(0,yi.Yr)(this.getCamera().getFieldOfView()):0}getViewFrustum(){return this.checkState("getViewFrustum")?this.getCamera().isOrthographic()?(ut.log.info("Tried to get frustum for an orthographic camera"),null):this.getCamera().getFrustum():null}getPerspective(){return!!this.checkState("getPerspective")&&this.getCamera().isPerspective()}getViewTarget(){if(!this.checkState("getViewTarget"))return null;const e=this.getCamera().getViewport();return this.getCamera().getRay(e[2]/2,e[3]/2).point}getModelExtents(){if(!this.checkState("getModelExtents"))return null;const e=this.getCamera().getSceneBounds();return e?[e.min[0],e.min[1],e.min[2],e.max[0],e.max[1],e.max[2]]:[-1,-1,-1,1,1,1]}getPivotPosition(){if(!this.checkState("getPivotPosition"))return null;const e=this.getViewController();return e.updateRotationPanCenterForSpaceball(),e.getRotateOrPanCenter()}getLookAt(){if(!this.checkState("getLookAt"))return null;const e=this.getViewer(),t=this.getCamera(),i=this.hitTestRay.evaluate(1),s=t.projectWorldPointToCanvas(i);s[2]=0;const n=t.canvasToWorld(s),r=this.rayAperture/2*t.getUnitSizeAtWorldPoint(n),a=t.getViewport(),o=a[2]*a[3]/X.default.getManager().getNumber("DEPTH_SAMPLES_PER_VIEWPORT"),h=Math.sqrt(o/2),c=(r+h)*(r+h);let l;l=this.hitSelectionOnly?e.retrieveHighlightsOnlyDepthSampling():e.retrieveDepthSampling();let u=null;const d=Q.create();for(let e=0;e<l.length;e++){Q.copy(d,[s[0]-l[e][0],s[1]-l[e][1]]);Q.squaredLength(d)<c&&(!u||l[e][2]<u[2])&&(u=l[e])}return u?t.canvasToWorld(u):null}getSelectionEmpty(){return!this.checkState("getSelectionEmpty")||0===(0,Ma.vi)().size()}getSelectionExtents(){if(!this.checkState("getSelectionExtents"))return null;const e=new yi.kB;(0,Ma.vi)().each((t=>{e.addBox(this.getViewer().getSelectionFitBounds(t))}));const t=e.getMin(),i=e.getMax();return[t[0],t[1],t[2],i[0],i[1],i[2]]}getPointerPosition(){if(!this.checkState)return null;const e=this.getViewController().getPointerPosition();return this.getCamera().getRay(e[0],e[1]).point}getCoordinateSystem(){return[1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1]}getFrontView(){return[1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1]}setViewMatrix(e){if(!this.checkState("setViewMatrix"))return;const t=this.getViewer();this.getCamera().setFrame(e),t.setUserIsAdjustingCamera(),t.getEventDispatcher().trigger(yD.h0)}setViewExtents(e){this.checkState("setViewExtents")&&(this.getCamera().isOrthographic()?this.getCamera().setExtents(e):ut.log.info("Tried to get view extents for a non-orthographic camera."))}setFov(e){this.checkState("setFov")&&this.getCamera().setFieldOfView((0,yi.Ux)(e))}setPivotPosition(e){this.checkState("setPivotPosition")&&this.getViewController().setRotationPivotPosition(e)}setPivotVisible(e){this.checkState("setPivotVisible")}setLookFrom(e){this.hitTestRay.setPoint(e)}setLookDirection(e){this.hitTestRay.setDirection(e)}setLookAperture(e){this.rayAperture=e}setSelectionOnly(e){this.hitSelectionOnly=e}setTransaction(e){this.checkState("setTransaction")&&0===e&&this.getViewer().requestDraw()}onStartMotion(){this.checkState("onStartMotion")&&(this.mouseIsInMotion=!0,this.getViewer().setSuppressMouseMovePick(!0),(0,Ma.IQ)(),this.getViewController().setIsSpaceballMoving(!0),this.getViewer().requestDraw())}onStopMotion(){this.checkState("onStopMotion")&&(this.mouseIsInMotion=!1,this.getViewController().setIsSpaceballMoving(!1),this.getViewer().setSuppressMouseMovePick(!1),this.getViewer().doPreHighlightPick())}setActiveCommand(e){e&&(0,yD.xA)().trigger(yD.RV,e)}on3dmouseCreated(){ya&&(Ki.Jq.SpaceballService.initializeSpacemouseCommands(),this.connexion.update3dcontroller({frame:{timingSource:1}}),this.mouseCreated=!0)}update3dcontroller(e){ya&&this.mouseCreated&&this.connexion.update3dcontroller(e)}}let Aa=null,Oa=null;function va(){Ca("iframe").attr("tabindex","-1"),!(0,Fs.CF)()||Aa||Oa||(Aa=new Pa,Oa=new Qi(Aa),Oa.startListeningToEvents())}function Ra(){Oa&&Oa.stopListeningToEvents()}function wa(){return ya}function _a(e,t){Aa&&Aa.onViewerDraw(e,t)}var Na=i(65754),ba=i(49947),La=i(31675);class Fa{constructor(e,t){this.entityId=e,this.isSubEntity=!1,this.start=null,this.end=null,this.type="unknown",this.subEntities=[],this.mid=null,this.radius=void 0,this.minorRadius=void 0,this.center=null,this.xAxis=null,this.point=null,this.useCenterPointForArcRadius=void 0,this.splineCPData=null,this.splineKnotData=null,this.lowParameter=void 0,this.highParameter=void 0,this.closedSpline=void 0,this.rationalSpline=void 0,this.splineDegree=0,this.offset=0,this.sourceId=void 0,this.bottomLeftCorner=null,this.bottomRightCorner=null,this.topLeftCorner=null,this.rho=0,this.controlPoint=null,this.hasSplineHandlesInSketch=!1,t&&this.update(t)}update(e){const t=this;if(e instanceof k.tCU)this.point=e.getPoint(0),this.type="point";else if(e instanceof k.r9S)this.start=e.getPoint(0),this.end=e.getPoint(1),this.type="line";else if(e instanceof k.Eg0)this.start=e.getPoint(0),this.mid=e.getPoint(1),this.end=e.getPoint(2),this.center=e.getPoint(3),this.type="arc";else if(e instanceof k.YEZ){const t=e;this.center=t.getPoint(0),this.radius=t.radius,this.type="circle"}else if(e instanceof k.piN){const t=e;this.type="spline",this.closedSpline=t.closed,this.rationalSpline=t.rational,this.splineDegree=t.degree,this.hasSplineHandlesInSketch=e.hasHandlesInSketch;const i=t.controlPointCount,s=i+t.degree+1,n=3*i;if(this.splineCPData=t.points.slice(0,n),this.splineKnotData=t.points.slice(n,n+s),this.offset=t.points[n+s],t.segment){const e=n+s+1;this.start=[t.points[e],t.points[e+1]],this.lowParameter=t.points[e+2],this.end=[t.points[e+3],t.points[e+4]],this.highParameter=t.points[e+5]}else this.lowParameter=this.splineKnotData[this.splineDegree],this.highParameter=this.splineKnotData[this.splineKnotData.length-this.splineDegree-1]}else if(e instanceof k.Mbd||e instanceof k.HmT){const i=e instanceof k.Mbd;if(i)this.type="text";else{this.type="image";const t=e;this.sourceId=t.sourceId,this.bottomLeftCorner=t.bottomLeftCorner.getVec3(),this.bottomRightCorner=t.bottomRightCorner.getVec3(),this.topLeftCorner=t.topLeftCorner.getVec3()}let s=0;if(t.subEntities.length===e.entities.length)for(s=0;s<t.subEntities.length;s++)t.subEntities[s].update(e.entities[s]);else{t.subEntities=[];const n=i?k.whn.ID_PREFIX:k.a_n.ID_PREFIX;e.entities.forEach((function(e){const i=new Fa(t.entityId+n+"."+s);i.isSubEntity=!0,i.update(e),t.subEntities.push(i),s++}))}}else if(e instanceof k.Nz9){const t=e;this.type="ellipse",this.center=t.getPoint(0),this.xAxis=t.getPoint(1),this.radius=t.radius,this.minorRadius=t.minorRadius,this.offset=t.offset}else if(e instanceof k.HlM){const t=e;this.type="ellipticalArc",this.center=t.getPoint(0),this.xAxis=t.getPoint(1),this.radius=t.radius,this.minorRadius=t.minorRadius,this.lowParameter=t.startParam,this.highParameter=t.endParam,this.offset=t.offset}else if(e instanceof k.Ddh){const t=e;this.type="conic",this.start=t.getPoint(0),this.controlPoint=t.getPoint(1),this.end=t.getPoint(2),this.lowParameter=t.points[6],this.highParameter=t.points[7],this.offset=t.offset,this.rho=t.rho}}}function xa(e){let t=null;const i=[e.center];if(e.radius>Ci.W.ZERO_LENGTH){t=new Array(Ci.W.NUMBER_OF_POINTS_IN_FULL_CIRCLE);const i=2*Math.PI/(Ci.W.NUMBER_OF_POINTS_IN_FULL_CIRCLE-1);let s=0;const n=e.radius;for(let r=0;r<Ci.W.NUMBER_OF_POINTS_IN_FULL_CIRCLE;++r){s=i*r;const a=Math.cos(s),o=Math.sin(s);t[r]=[e.center[0]+a*n,e.center[1]+o*n]}}return{linePoints:t,points:i}}function Ba(e,t,i){i<t&&(i+=2*Math.PI);let s=null;const n=[e.center],r=e.xAxis,a=[-e.xAxis[1],e.xAxis[0]],o=e.offset;if(e.radius>Ci.W.ZERO_LENGTH&&e.minorRadius>Ci.W.ZERO_LENGTH){s=[];let n=Math.max((i-t)/(2*Math.PI)*Ci.W.NUMBER_OF_POINTS_IN_FULL_CIRCLE,2);n=Math.floor(n);const h=(i-t)/(n-1);let c=0;const l=e.radius,u=e.minorRadius;for(let i=0;i<n;++i){c=h*i+t;const n=Math.cos(c),d=Math.sin(c);let g=r[0]*l*n+a[0]*u*d,p=r[1]*l*n+a[1]*u*d;if(0!==o){const e=r[0]*u*n+a[0]*l*d,t=r[1]*u*n+a[1]*l*d,i=Math.sqrt(e*e+t*t);g+=o*e/i,p+=o*t/i}s[i]=[e.center[0]+g,e.center[1]+p]}}return{linePoints:s,points:n}}const Va=function(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])},Ua=function(e,t,i){const s=Math.cos(i),n=Math.sin(i);return[e[0]+s*t,e[1]+n*t]};function Ga(e,t,i,s){const n=.01*Math.PI,r=2+Math.floor(Math.abs(s-i)/n),a=(s-i)/(r-1),o=new Array(r);for(let s=0;s<r;++s)o[s]=Ua(e,t,i),i+=a;return o}function Ha(e,t,i,s,n){if((0,Na.are2dPointsEqual)(e,i))return null;let r=s;if(n){const s=[0,0],n=[0,0],a=[0,0],o=[0,0];if(!(0,yi.eB)(e,t,s,n)||!(0,yi.eB)(t,i,a,o))return null;const h=[0,0];if(!(0,yi.TE)(s,n,a,o,h))return null;r=h}let a=Va(r,e),o=Va(r,i);const h=Va(r,t);let c=0;a>o&&(c=a,a=o,o=c),(h<a||h>o)&&(c=a,a=o,o=c+2*Math.PI);const l=e[0]-r[0],u=e[1]-r[1];return{linePoints:Ga(r,Math.sqrt(l*l+u*u),a,o),points:[e,i,r]}}function ka(e){const t=new Fa(e.entityId);let i=1;return Math.abs(1-e.rho)>Ci.W.ZERO_LENGTH?(i=e.rho/(1-e.rho),t.splineKnotData=[0,0,0,1,1,1],t.splineCPData=[e.start[0],e.start[1],1,e.controlPoint[0],e.controlPoint[1],i,e.end[0],e.end[1],1]):(t.splineKnotData=[0,0,0,.5,1,1,1],t.splineCPData=[e.start[0],e.start[1],1,e.controlPoint[0],e.controlPoint[1],i,e.controlPoint[0],e.controlPoint[1],i,e.end[0],e.end[1],1]),t.rationalSpline=!0,t.closedSpline=!1,t.offset=e.offset,t.splineDegree=2,t.lowParameter=e.lowParameter,t.highParameter=e.highParameter,Wa(t)}function Wa(e){let t=[];const i=[];if(e.splineCPData&&e.splineCPData.length>0&&e.splineDegree&&e.splineKnotData){const s=[];let n;for(n=0;n<e.splineCPData.length;n+=3)s.push([e.splineCPData[n]*e.splineCPData[n+2],e.splineCPData[n+1]*e.splineCPData[n+2],e.splineCPData[n+2]]);const r=new ba.Bspline(e.splineDegree,e.splineKnotData,s,C,!!e.closedSpline),a=e.splineCPData.length*Ci.W.NUMBER_OF_POINTS_PER_BSPLINE_CPOINT,o=Math.min(e.lowParameter,e.highParameter),h=Math.abs(e.highParameter-e.lowParameter)/a;let c,l;for(n=0;n<=a;n++)c=o+n*h,l=r.evaluate(c),t.push([l[0]/l[2],l[1]/l[2]]);if(e.offset&&Math.abs(e.offset)>Ci.W.ZERO_LENGTH){const i=[];let s=Q.create(),o=Q.create(),h=!1;if(e.closedSpline){const t=r.domain();h=Math.abs(Math.abs(e.highParameter-e.lowParameter)-t[1]+t[0])<Ci.W.ZERO_LENGTH}for(n=0;n<=a;++n)s=0===n?ge.gv.subtract(t[1],t[0],s):n===a?h?ge.gv.subtract(t[1],t[0],s):ge.gv.subtract(t[a],t[a-1],s):ge.gv.subtract(t[n+1],t[n-1],s),ge.gv.normalize(s),o=ge.gv.scale([s[1],-s[0]],e.offset,o),i.push(ge.gv.add(t[n],o,Q.create()));t=i}e.start&&i.push(e.start),e.end&&i.push(e.end)}return{linePoints:t,points:i}}function za(e){switch(e.type){case"line":const t=[e.start,e.end];return{linePoints:t,points:t};case"point":return{linePoints:null,points:[e.point]};case"circle":return xa(e);case"arc":return Ha(e.start,e.mid,e.end,e.center,!e.useCenterPointForArcRadius);case"spline":return Wa(e);case"ellipse":return Ba(e,0,2*Math.PI);case"ellipticalArc":if(void 0!==e.lowParameter&&void 0!==e.highParameter)return Ba(e,e.lowParameter,e.highParameter);break;case"conic":return ka(e)}return console.warn("Failed to create polyline for unsupported entity type: "+e.type),{linePoints:null,points:null}}function Xa(e,t,i,s){let n=!1,r=!1,a=!1,o=!1;t&&((i||"point"===e.type)&&(n=t.isConstruction),r=t.forPreview,t.isFromSplineHandle&&(a=t.isFromSplineHandle),t.isFromSplineControlPolygon&&(o=t.isFromSplineControlPolygon));const h=t?t.status:k.ea7.UNKNOWN;return(0,La.$V)(i,n,a,o,h,s,r)}function Za(e,t){const i=e.getSketch(),s=[],n=[];let r,a=0;if(t.linePoints){const e=t.linePoints.length;let o=0;t.linePoints.forEach((function(t){r=i.planeToWorld(t),s.push(r[0],r[1],r[2]),n.push(a),o>0&&o<e-1&&n.push(a),o++,a++}))}return s.length>0?new vE(Di.MX.LINES,s,n):null}function qa(e,t,i,s,n,r){const a=e.getSketch();if(!a)return;if(!t)return void i.removeEntity(n);let o=null;const h=[],c=[];let l=0;t.points&&t.points.forEach((function(e){o=a.planeToWorld(e),h.push(o[0],o[1],o[2]),c.push(l),l++}));const u=Za(e,t);u?i.updateTemporaryEntity(n,u,Xa(s,r,!0,n)):h.length>0&&i.updateTemporaryEntity(n,new vE(Di.MX.POINTS,h,c),Xa(s,r,!1,n))}const Ya=new gt.StringSet;function Ka(){return!Ya.isEmpty()}class ja{constructor(e){this.bytes=null,this.floats=null,this.width=-1,this.height=-1,this.useMipmaps=!1,this.maxAnisotropy=-1,this.canvas=null,this.imageSource="",this.defersRendering=!1,this.internalFormat=e.RGBA,this.format=this.internalFormat,this.minificationFilter=e.NEAREST,this.magnificationFilter=e.NEAREST,this.wrapS=e.CLAMP_TO_EDGE,this.wrapT=e.CLAMP_TO_EDGE}isImage(){return!!this.imageSource}}let Qa=0;class $a extends m.T{constructor(e,t,i){super(),this.viewer=e,this.GAUGE_MEMORY_TYPE="Texture",this.creationFunction=null,this.textureDefinition=null,this.waitingForTextureData=!1,this.texture=null,this.textureSize=0,this.textureNeedsUpdate=!1,this.hasTransparency=!0,this.performedImageLoadRetry=!1,(0,Jo.Yk)(e),"function"==typeof t?this.creationFunction=t:this.textureDefinition=t,this.updateFunction=i,this.id=Qa.toString(),++Qa,this.textureDefinition&&this.textureDefinition.isImage()&&this.createTexture(),this.listenTo(this.viewer.getEventDispatcher(),yD.so,this.onGlContextLostOrDestroyed),this.listenTo(this.viewer.getEventDispatcher(),yD.cW,this.onGlContextLostOrDestroyed)}destroy(){this.stopListening(),this.texture&&(this.viewer.getGlContext()?.deleteTexture(this.texture),this.viewer.getMemoryGauge().decrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.textureSize)),this.texture=null}setTextureNeedsUpdate(e){this.textureNeedsUpdate=e}createTexture(){if(this.texture)return;const e=this.textureDefinition?this.textureDefinition:this.creationFunction(this.viewer.getGlContext());if(!e)return;const t=this.viewer.getGlContext();if(this.texture=t.createTexture(),this.textureNeedsUpdate=!1,e.isImage())this.loadTextureFromImage(e);else{const i="createTexture temporary";Ja(this.viewer,this.texture,i)>=0&&(e.bytes?(t.texImage2D(t.TEXTURE_2D,0,e.internalFormat,e.width,e.height,0,e.format,t.UNSIGNED_BYTE,e.bytes),this.setTextureSize(e.width,e.height,e.internalFormat,t.UNSIGNED_BYTE)):e.floats?this.viewer.areFloatTexturesSupported()?(t.texImage2D(t.TEXTURE_2D,0,e.internalFormat,e.width,e.height,0,e.format,t.FLOAT,e.floats),this.setTextureSize(e.width,e.height,e.internalFormat,t.FLOAT)):ut.log.warn(vD+"An attempt was made to make a float texture without float texture support"):e.canvas?(t.texImage2D(t.TEXTURE_2D,0,e.internalFormat,e.format,t.UNSIGNED_BYTE,e.canvas),this.setTextureSize(e.canvas.width,e.canvas.height,e.internalFormat,t.UNSIGNED_BYTE)):ut.log.warn(vD+"An attempt was made to create a texture without valid input"),this.finishTextureSpecification(e),this.viewer.releaseTextureUnit(i))}}get imageSourceUri(){return this.textureDefinition?this.textureDefinition.imageSource:null}setTextureSize(e,t,i,s){this.textureSize=to(e,t,i,s),this.viewer.getMemoryGauge().incrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.textureSize)}loadTextureFromImage(e){const t=new Image;this.waitingForTextureData=!0,e.defersRendering&&Ya.add(this.id),t.onload=()=>{const i=this.viewer.getGlContext();if(!i||!this.texture)return;this.waitingForTextureData=!1;Ja(this.viewer,this.texture,"loadTextureFromImage")>=0&&(i.texImage2D(i.TEXTURE_2D,0,e.internalFormat,e.format,i.UNSIGNED_BYTE,t),this.setTextureSize(t.width,t.height,e.internalFormat,i.UNSIGNED_BYTE),this.finishTextureSpecification(e),this.viewer.releaseTextureUnit("loadTextureFromImage")),Ya.remove(this.id),(0,Fs.vm)()},t.onerror=()=>{if(Ya.remove(this.id),this.performedImageLoadRetry)ut.log.warn("Could not load texture image: "+e.imageSource);else{ut.log.info("Initial attempt to load texture image failed: "+e.imageSource),this.performedImageLoadRetry=!0;setTimeout((()=>{this.loadTextureFromImage(e)}),1e4)}(0,Fs.vm)()};setTimeout((()=>{Ya.contains(this.id)&&(Ya.remove(this.id),(0,Fs.vm)())}),2e3),t.src=e.imageSource}finishTextureSpecification(e){const t=this.viewer.getGlContext(),i=this.viewer.getAnisotropicExtension();i&&e.maxAnisotropy>0&&t.texParameterf(t.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,e.maxAnisotropy),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,e.magnificationFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e.minificationFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,e.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,e.wrapT),e.useMipmaps&&t.generateMipmap(t.TEXTURE_2D)}updateAndBindTexture(e){if((0,Jo.Yk)(this.viewer),this.texture||this.createTexture(),this.waitingForTextureData)return-1;const t=this.viewer.getGlContext(),i=Ja(this.viewer,this.texture,e);return i>=0&&this.textureNeedsUpdate&&this.updateFunction&&(t.activeTexture(t.TEXTURE0+i),this.updateFunction(),this.textureNeedsUpdate=!1),i}setHasTransparency(e){this.hasTransparency=e}getHasTransparency(){return this.hasTransparency}onGlContextLostOrDestroyed(){this.texture=null}}function Ja(e,t,i){(0,Jo.Yk)(e);const s=e.getOrAllocateTextureUnit(i);return s>=0&&e.bindTextureToUnit(t,s),s}function eo(e,t){(0,Jo.Yk)(e);const i=e.getTextureUnit(t);i>=0&&(e.bindTextureToUnit(null,i),e.releaseTextureUnit(t))}function to(e,t,i,s){return e*t*kt(i)*Bt(s)}function io(e,t,i,s){(0,Jo.Yk)(e);const n=e.getGlContext(),r=n.createTexture(),a="createRGBATexture temporary",o=e.getOrAllocateTextureUnit(a);if(o<0)return null;try{e.bindTextureToUnit(r,o),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,t,i,0,n.RGBA,s,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),e.bindTextureToUnit(null,o),e.releaseTextureUnit(a)}catch(e){throw ut.log.warn("BEL-56217 - exception while creating texture with width "+t+", height: "+i+", precision: "+s+", exception: "+e),e}return r}var so=i(35692);class no{constructor(e,t,i,s,n){this.canvas=e,this.filledWidthPx=t,this.filledHeightPx=i,this.leftPixel=s,this.topPixel=n}}class ro extends $a{constructor(e,t){super(e,(e=>this.textureCreationFunction(e))),this.canvasCreationFunction=t,this.width=-1,this.height=-1,this.filledWidthPx=-1,this.filledHeightPx=-1,this.leftCoordinate=-1,this.rightCoordinate=-1,this.bottomCoordinate=-1,this.topCoordinate=-1;this.createTexture()}createTexturedQuad(){return(0,Au.fQ)([0,0,0],[this.filledWidthPx,0,0],[0,this.filledHeightPx,0],"textQuad",[this.leftCoordinate,this.bottomCoordinate],[this.rightCoordinate,this.topCoordinate])}textureCreationFunction(e){const t=this.canvasCreationFunction(e);this.width=t.canvas.width,this.height=t.canvas.height,this.filledWidthPx=t.filledWidthPx,this.filledHeightPx=t.filledHeightPx,this.leftCoordinate=t.leftPixel/t.canvas.width,this.rightCoordinate=this.leftCoordinate+t.filledWidthPx/t.canvas.width,this.topCoordinate=t.topPixel/t.canvas.height,this.bottomCoordinate=this.topCoordinate+t.filledHeightPx/t.canvas.height;const i=new ja(e);return i.canvas=t.canvas,i.magnificationFilter=e.LINEAR,i.minificationFilter=e.LINEAR_MIPMAP_LINEAR,i.maxAnisotropy=4,i.wrapS=e.CLAMP_TO_EDGE,i.wrapT=e.CLAMP_TO_EDGE,i.useMipmaps=!0,i}}const ao={font:"Arial",heightPx:10,weight:"",color:"#000000"};function oo(e,t){const i=document.createElement("canvas");return i.width=(0,yi.cP)(e),i.height=(0,yi.cP)(t),i}let ho=null;function co(){if(!ho){const e=oo(128,128);ho=e.getContext("2d",{willReadFrequently:!0})}return ho}function lo({weight:e,heightPx:t,font:i}){return(e?e+" ":"")+t+"px "+i}async function uo(...e){const t=e.map((e=>lo(function({font:e,size:t,fontWeight:i}){return{font:e,heightPx:t,weight:i}}(e)))).map((async e=>{document.fonts.check(e)||await document.fonts.load(e)}));return Promise.all(t).then((()=>{}))}function go(e,t){t=Object.assign({},ao,t),e.font=lo(t),e.textAlign="left",e.fillStyle=t.color,e.globalAlpha=1,e.textBaseline="alphabetic"}const po=1;function mo(e,t){const i=e.getContext("2d",{willReadFrequently:!0}),s=i.getImageData(0,0,e.width,e.height),n=[t[0],t[1],t[2],po],r=s.data.length/4;for(let e=0;e<r;++e)for(let t=0;t<4;++t)s.data[4*e+t]=n[t];return i.putImageData(s,0,0),n}function fo(e,t){const i=co();go(i,t);let s=0;for(let t=0;t<e.length;++t)s=Math.max(s,i.measureText(e[t]).width);return s}const Io="A";function Eo(e){const t=co();go(t,e);const i=t.measureText(Io);return Math.ceil(i.actualBoundingBoxAscent)}function So(e,t){return oo(e,t)}function To(e,t,i,s,n,r,a,o){const h=e.getContext("2d",{willReadFrequently:!0});mo(e,n),o=(o||0)+1,h.fillStyle="rgba("+n[0]+","+n[1]+","+n[2]+","+r+")",Mo(h,t,i,s,a,o),h.fill()}function Do(e,t,i,s,n,r,a,o,h,c){const l=e.getContext("2d",{willReadFrequently:!0});c||mo(e,n),l.strokeStyle="rgba("+n[0]+","+n[1]+","+n[2]+", 1.0)",l.setLineDash([o,h]),l.lineWidth=a;Mo(l,t,i,s,r+a/2,a/2+1),l.stroke()}function Mo(e,t,i,s,n,r){const a=r,o=r;t-=2*r,i-=2*r,e.beginPath(),e.moveTo(a+n,o+s),e.arcTo(a+t,o+s,a+t,o+s+i,n),e.arcTo(a+t,o+s+i,a,o+s+i,n),e.arcTo(a,o+s+i,a,o+s,n),e.arcTo(a,o+s,a+t,o+s,n),e.closePath()}function Co(e){return e.split("\n")}function yo(e,t,i,s,n){const r=i.getContext("2d",{willReadFrequently:!0});go(r,t);const a=Co(e),o=Eo(t);for(let e=0;e<a.length;++e)r.fillText(a[e],s,n+t.heightPx*e+o);i.filledWithText=e}function Po(e,t,i,s){s&&(s=ge.w$.toMat3(s),t=ge.xB.multiply(s,t,C.create()),i=ge.xB.multiply(s,i,C.create()));const n=e.getRight(),r=e.getForward(),a=e.up,o=C.dot(t,n);let h=!1;o<=-Ci.W.ZERO_LENGTH?h=!0:o<=Ci.W.ZERO_LENGTH&&(h=C.dot(t,a)<=Ci.W.ZERO_LENGTH);const c=h?ge.S4.scale(t,-1,C.create()):t,l=ge.S4.cross(c,r,C.create());return[h,C.dot(i,l)<=-Ci.W.ZERO_LENGTH]}let Ao=null;function Oo(e){Ao||(Ao=so('<div style="z-index:999999;margin:5px;position:fixed;left:0;bottom:0"></div>').appendTo("body")),so(e).css({background:"yellow",margin:"0 5px"}),so(e).appendTo(Ao)}function vo(e,t,i,s,n,r){const a=mo(e,i);return yo(t,s,e,n,n+r),(0,dt.isBrowserFirefox)()?function(e,t){const i=new yi.tO,s=e.getContext("2d",{willReadFrequently:!0}),n=e.width,r=e.height,a=s.getImageData(0,0,n,r).data;for(let e=0;e<r;++e)for(let s=0;s<n;++s)if(wo(a,t,n,r,s,e)){const o=wo(a,t,n,r,s-1,e)||wo(a,t,n,r,s+1,e),h=wo(a,t,n,r,s,e-1)||wo(a,t,n,r,s,e+1);o&&h&&i.addPointXY(s,e)}return i}(e,a):function(e,t){const i=new yi.tO,s=e.getContext("2d",{willReadFrequently:!0}),n=e.width,r=e.height,a=s.getImageData(0,0,n,r).data;for(let e=0;e<r;++e)for(let s=0;s<n;++s)wo(a,t,n,r,s,e)&&i.addPointXY(s,e);return i}(e,a)}const Ro=256;function wo(e,t,i,s,n,r){if(n<0||n>=i||r<0||r>=s)return!1;const a=4*(r*i+n),o=e.subarray(a,a+4);if(o[3]>po){if(ge.jA.distanceSquared(t,o)>Ro)return!0}return!1}function _o(e,t,{color:i,font:s,size:n,fontWeight:r,paddingWithinBorder:a,backgroundColor:o,backgroundOpacity:h,backgroundRadius:c,borderColor:l,borderThickness:u,dashLength:d,dashGapLength:g,underlineWidth:p}){return new ro(e,(function(e){const m=[Math.floor(255*i[0]),Math.floor(255*i[1]),Math.floor(255*i[2])],f={color:"rgb("+m[0]+","+m[1]+","+m[2]+")",font:s,heightPx:n,weight:r},I=(a=a||0)+(u=u||0),E=Math.max(2,Math.ceil(.25*n)),S=Co(t);let T=Math.ceil(fo(S,f))+2*I;T=Math.min(T,e.getParameter(e.MAX_TEXTURE_SIZE));let D=n*S.length+2*I;p&&(D+=p+2);const M=So(T,D+2*E),C=M.getContext("2d",{willReadFrequently:!0}),y=vo(M,t,m,f,I,E);y.isInitialized()||(ut.log.warn("Did not find canvas bounds for text: "+t),y.addPointXY(0,E),y.addPointXY(T,E+D));const P=y.min[1];if(o){To(M,T,D,P-I,[Math.floor(255*o[0]),Math.floor(255*o[1]),Math.floor(255*o[2]),Math.floor(255*h)],h=h||1,c=c||0,u)}else mo(M,m);if(l){Do(M,T,D,P-I,[Math.floor(255*l[0]),Math.floor(255*l[1]),Math.floor(255*l[2])],c||0,u,d||1,g||0,!!o)}const A=y.getDimensions(),O=P+Math.floor((S.length*n-A[1])/(2*S.length));if(p){C.strokeStyle=f.color,C.lineWidth=p,C.beginPath();const e=O+n-.5*p;C.moveTo(I,e),C.lineTo(T-I,e),C.stroke()}return yo(t,f,M,I,O),new no(M,T,D,0,P-I)}))}function No(e){return e<0?"--":(1e3/e).toFixed(1)}class bo{constructor(){this.timings=[],this.averageTime=-1,this.framesSinceTiming=0,this.timingFrequency=10,this.timingCount=0,this.activeTimerQuery=null,this.pendingQueries=[],this.availableQueries=[],this.queryTimings=[],this.averageQueryTime=-1}reset(){this.timings=[],this.averageTime=-1,this.timingCount=0,this.framesSinceTiming=0,this.queryTimings=[],this.averageQueryTime=-1}onContextLost(){this.activeTimerQuery=null,this.pendingQueries=[],this.availableQueries=[]}hasTimings(){return this.timings.length>0}getAverageFramerate(){return 1e3/this.averageTime}onDrawStart(e,t){if(!e||!t)return;const i=t.getParameter(e.GPU_DISJOINT_EXT);let s;for(;s=this.pendingQueries.shift();)e.getQueryObjectEXT(s,e.QUERY_RESULT_AVAILABLE_EXT)&&(i||this.addQueryTiming(e.getQueryObjectEXT(s,e.QUERY_RESULT_EXT)/1e6),this.availableQueries.push(s));this.availableQueries.length>0?this.activeTimerQuery=this.availableQueries.shift():this.activeTimerQuery=e.createQueryEXT(),e.beginQueryEXT(e.TIME_ELAPSED_EXT,this.activeTimerQuery)}addQueryTiming(e){this.queryTimings.push(e),this.queryTimings.length>30&&this.queryTimings.shift();let t=0;for(let e=0;e<this.queryTimings.length;++e)t+=this.queryTimings[e];this.averageQueryTime=t/this.queryTimings.length}onDrawEnd(e){e&&this.activeTimerQuery&&(e.endQueryEXT(e.TIME_ELAPSED_EXT,this.activeTimerQuery),this.pendingQueries.push(this.activeTimerQuery),this.activeTimerQuery=null)}addTiming(e){this.timings.push(e),this.timings.length>5&&this.timings.shift();let t=0;for(let e=0;e<this.timings.length;++e)t+=this.timings[e];this.averageTime=t/this.timings.length,this.framesSinceTiming=0,++this.timingCount}}var Lo;!function(e){e[e.ADJUSTING_CAMERA=0]="ADJUSTING_CAMERA",e[e.MANIPULATING=1]="MANIPULATING",e[e.SYSTEM_ANIMATION=2]="SYSTEM_ANIMATION"}(Lo||(Lo={}));class Fo{constructor(e){this.viewer=e,this.timingFrameType=null,this.frameTimeStart=0,this.drawLoopStart=0,this.frameTimings=[],this.frameDetails={},this.drawLoopDetails={},this.interactionTimeouts={},(0,Jo.Yk)(e),this.frameDetails[Wr.Q.INTERACTIVE]=new bo,this.drawLoopDetails[Wr.Q.INTERACTIVE]=new bo}resetTimings(){this.frameDetails[Wr.Q.INTERACTIVE].reset(),this.drawLoopDetails[Wr.Q.INTERACTIVE].reset()}onContextCreated(){this.disjointTimer=this.viewer.getExtension("EXT_disjoint_timer_query")}onContextLost(){Object.values(this.frameDetails).forEach((e=>{e.onContextLost()})),this.disjointTimer=null}onContextRestored(){this.disjointTimer=this.viewer.getExtension("EXT_disjoint_timer_query")}getAverageFrameRate(e){return No(this.frameDetails[e].averageTime)}getAverageQueryFrameRate(e){return this.disjointTimer?No(this.frameDetails[e].averageQueryTime):null}getTimingDetails(e){return this.frameDetails[e]}getDrawLoopDetails(e){return this.drawLoopDetails[e]}onDrawStart(){const e=this.getCurrentFrameType(),t=this.frameDetails[e];if(!t)return;t.onDrawStart(this.disjointTimer,this.viewer.getGlContext());const i=(0,Fs.Wj)();this.drawLoopStart=i,this.timingFrameType===e?(this.frameTimings.push(i-this.frameTimeStart),this.frameTimings.length<2?(this.frameTimeStart=i,this.viewer.forceRequestDraw()):(t.addTiming(Math.max(this.frameTimings[0],this.frameTimings[1])),this.timingFrameType=null)):(t.framesSinceTiming++,t.framesSinceTiming>=t.timingFrequency&&(this.frameTimeStart=i,this.timingFrameType=e,this.frameTimings=[],this.viewer.forceRequestDraw()))}onDrawEnd(){const e=this.getCurrentFrameType(),t=this.frameDetails[e];t&&t.onDrawEnd(this.disjointTimer);const i=this.drawLoopDetails[e];if(!i)return;const s=(0,Fs.Wj)();i.addTiming(s-this.drawLoopStart)}setUserIsInteractingWithTimeout(e){this.interactionTimeouts[e]&&window.clearTimeout(this.interactionTimeouts[e]);this.interactionTimeouts[e]=window.setTimeout((()=>{delete this.interactionTimeouts[e],this.viewer.requestDraw()}),500)}resetInteractionStatus(){Object.values(this.interactionTimeouts).forEach((function(e){window.clearTimeout(e)}),this),this.interactionTimeouts={}}setUserIsAdjustingCamera(){this.setUserIsInteractingWithTimeout(Lo.ADJUSTING_CAMERA)}setUserIsManipulatingWithTimeout(){this.setUserIsInteractingWithTimeout(Lo.MANIPULATING)}setSystemIsAnimating(){this.setUserIsInteractingWithTimeout(Lo.SYSTEM_ANIMATION)}userIsInteracting(){for(const e in this.interactionTimeouts)if(this.interactionTimeouts[e])return!0;return!1}userIsManipulating(){return!!this.interactionTimeouts[Lo.MANIPULATING]}getCurrentFrameType(){return this.userIsManipulating()?Wr.Q.MANIPULATING:this.userIsInteracting()?Wr.Q.INTERACTIVE:Wr.Q.FULL}}class xo extends m.T{constructor(e,t,i,s){super(),this.viewer=e,this.textureType=t,this.GAUGE_MEMORY_TYPE="Frame buffer",this.colorTexture=null,this.renderBuffer=null,this.frameBuffer=null,this.width=0,this.height=0,this.isWebXrEnabled=!1,(0,Jo.Yk)(e),this.renderBufferArguments=s,this.id=i||"",this.listenTo(this.viewer.getEventDispatcher(),yD.cW,this.onGlContextLost),this.listenTo(this.viewer.getEventDispatcher(),yD.so,this.onSessionEnded),Ki.Jq.CapabilitiesService.isWebxrEnabled().then((e=>{this.isWebXrEnabled=e}))}destroy(){this.stopListening(),this.freeResources()}setExternalFrameBuffer(e,t,i){this.width=e,this.height=t,this.frameBuffer=i}onSessionEnded(){this.destroy()}onGlContextLost(){this.frameBuffer=null,this.colorTexture=null,this.renderBuffer=null}update(e,t,i){if(this.isWebXrEnabled){if(!t&&!i)if(e.isCustomViewportActive){const s=e.getViewport();t=s[2],i=s[3]}else t=this.viewer.getBaseFrameBufferWidth(),i=this.viewer.getBaseFrameBufferHeight()}else{const s=e.getViewport();t=s[2],i=s[3]}if(!this.colorTexture||t!==this.width||i!==this.height){const e=this.viewer.getGlContext();this.freeResources(),this.width=t,this.height=i;const s=e.getParameter(e.FRAMEBUFFER_BINDING);this.createBuffer(t,i),this.checkFrameBuffer()||this.textureType!==this.viewer.getHalfFloatType()||(this.textureType=e.FLOAT,ut.log.info("The creation of a frame buffer with HALF_FLOAT failed.  Attempting to create buffer with full FLOAT"),this.freeResources(),this.createBuffer(t,i),this.checkFrameBuffer()),e.bindFramebuffer(e.FRAMEBUFFER,s||null)}}getColorTextureMemoryUsage(){return to(this.width,this.height,Gt.RGBA,this.textureType)}getRenderBufferMemoryUsage(){return this.renderBufferArguments?this.width*this.height*Ht(this.renderBufferArguments.storageType):0}incrementMemoryGauge(){const e=this.viewer.getMemoryGauge();this.colorTexture&&e.incrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.getColorTextureMemoryUsage()),this.renderBuffer&&e.incrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.getRenderBufferMemoryUsage())}freeResources(){const e=this.viewer.getGlContext();if(!e)return;const t=this.viewer.getMemoryGauge();this.frameBuffer&&(e.deleteFramebuffer(this.frameBuffer),this.frameBuffer=null),this.colorTexture&&(t.decrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.getColorTextureMemoryUsage()),e.deleteTexture(this.colorTexture),this.colorTexture=null),this.renderBuffer&&(t.decrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.getRenderBufferMemoryUsage()),e.deleteRenderbuffer(this.renderBuffer),this.renderBuffer=null)}createBuffer(e,t){const i=this.viewer.getGlContext();this.colorTexture=io(this.viewer,e,t,this.textureType),this.renderBufferArguments&&(this.renderBuffer=this.viewer.getOrCreateRenderBuffer(e,t,this.renderBufferArguments)),this.frameBuffer=i.createFramebuffer(),i.bindFramebuffer(i.FRAMEBUFFER,this.frameBuffer),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.colorTexture,0),this.renderBufferArguments&&i.framebufferRenderbuffer(i.FRAMEBUFFER,this.renderBufferArguments.attachmentType,i.RENDERBUFFER,this.renderBuffer),this.incrementMemoryGauge()}checkFrameBuffer(){const e=this.viewer.getGlContext();switch(e.checkFramebufferStatus(e.FRAMEBUFFER)){case e.FRAMEBUFFER_UNSUPPORTED:return ut.log.warn(vD+"Framebuffer is unsupported"),!1;case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return this.textureType===this.viewer.getHalfFloatType()?ut.log.info("Framebuffer incomplete attachment for half float type"):ut.log.warn(vD+"Framebuffer incomplete attachment"),!1;case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return ut.log.warn(vD+"Framebuffer incomplete dimensions"),!1;case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return ut.log.warn(vD+"Framebuffer incomplete missing attachment"),!1}return!0}bindBuffer(){const e=this.viewer.getGlContext();e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer)}unbindBuffer(){const e=this.viewer.getGlContext();e.bindFramebuffer(e.FRAMEBUFFER,null)}getTexture(){return this.colorTexture}resetBuffer(){this.freeResources()}getWidth(){return this.width}getHeight(){return this.height}}var Bo=i(35692),Vo=i(35692);const Uo={duration:500,tolerance:10},Go={mousedown:"mousedown",mouseup:"mouseup",mousemove:"mousemove",longpress:"longpress"},Ho={LEFT:1,MIDDLE:2,RIGHT:3};function ko(e,t){e.on(Go.mousedown,zo),e.on(Go.longpress,t)}function Wo(e){e.off(Go.mousedown,void 0,zo),e.off(Go.longpress)}function zo(e){if(e.which!==Ho.LEFT)return;const t=Bo(e.target),i=(new Date).getTime(),s=Vo.Event(Go.longpress);for(const t in e)s[t]=e[t];s.type=Go.longpress,t.on(Go.mouseup,r),t.on(Go.mousemove,a);const n=setTimeout((function(){t.trigger(Go.longpress,s),o()}),Uo.duration);function r(e){(new Date).getTime()-i<Uo.duration?clearTimeout(n):t.trigger(Go.longpress,s),o()}function a(e){(Math.abs(e.pageX-s.pageX)>Uo.tolerance||Math.abs(e.pageY-s.pageY)>Uo.tolerance)&&(clearTimeout(n),o())}function o(){t.off(Go.mouseup,void 0,r),t.off(Go.mousemove,void 0,a)}}var Xo=i(19586),Zo=i(49192);class qo{constructor(e){this.id=e;const t=e===Zo.Vv?fs.L.PREVIEW:fs.L.BASE;this.rootNode=new xi.NB(e+" root",{},t)}getRootNode(){return this.rootNode}isForPreview(){return this.rootNode.getUsage()===fs.L.PREVIEW}getBounds(){return this.rootNode.getBoundingBox()}updateBounds(){this.rootNode.updateBounds()}removeEverything(){this.rootNode&&this.rootNode.removeAllChildren()}draw(e){this.rootNode.draw(e)}passesNodeFilter(e){return this.rootNode.passesNodeFilter(e)}getAllNodesWithId(e){const t=[],i=function(s){s.getId()===e&&t.push(s);for(let e=0;e<s.getChildCount();++e)i(s.getChildByIndex(e))};return i(this.rootNode),t}getNodeAtEndOfPath(e){const t=e.slice(0);let i=this.rootNode;for(t.shift();t.length>0;){const e=t.shift();if(i=i.getChildById(e),null===i)return null}return i}ownsNode(e){for(;e;){if(e===this.rootNode)return!0;e=e.getParent()}return!1}makeSceneDebugObject(){return{text:this.id,children:[this.rootNode.makeSceneDebugObject(0)]}}}class Yo{constructor(){this.theSceneGraphs={}}destroySceneGraphs(){Object.values(this.theSceneGraphs).forEach((function(e){e.getRootNode().onPermanentlyRemoved()})),this.theSceneGraphs={}}getSceneGraph(e){let t=this.theSceneGraphs[e];return t||(this.theSceneGraphs[e]=t=new qo(e)),t}getMainSceneGraph(){return this.getSceneGraph(Zo.lL)}getPreviewSceneGraph(){return this.getSceneGraph(Zo.Vv)}getHudSceneGraph(){return this.getSceneGraph(Zo.EG)}getHudModelSceneGraph(){return this.getSceneGraph(Zo.$K)}}function Ko(e){return e===fs.L.BASE?Zo.lL:Zo.Vv}var jo=i(29500),Qo=i(6057),$o=i(25889),Jo=i(21324);const eh=X.default.getManager();class th extends m.T{constructor(e,t,i){super(),this.usage=e,this.occurrenceDataManager=t,this.viewer=i,this.partStudios={},this.sharedBaseMeshManager=null,this.i18next=i18n,this.assemblies={},this.displayedElementMicroversionIdAndConfiguration=null,this.displayedElementType=null,this.displayedPartStudio=null,this.partStudioPreservedForPreview=null,this.pendingPartStudioComputedData=null,this.selectionsToClearOnReset={},this.secondaryOccurrenceHighlights={},this.secondaryEntityHighlights={},this.secondaryEntityHighlightSelectionRepeats={},this.addDerivedEntityHighlights=!0,this.selectionListNameToListAndHighlightType=new Map,this.bodyLoadTasks=null,this.meshPointController=null,this.queuedAssemblyDisplayData=[],this.queuedAssemblyTimeout=null,this.notCollapsedAssemblyMessageCount=0,this.selectedSheetmetalModelId=null,this.lastFitSheetMetalModelId=null,this.resyncFunction=null,this.resyncNeeded=!1,this.resyncReason=null,this.resyncPromise=null,this.lastPartStudioProcessed="",this.lastPartStudioMicroversionIdAndConfigurationIntervalProcessed={},this.temporarySketchComponents={},this.partStudioVisibilityUpdated=!1,this.subFeaturesShownByParameters={},(0,Jo.Yk)(i),this.meshManager=new AS(this.viewer,dI),this.displayedElementId="",this.partsAtTheBeginningOfEdit=new gt.StringSet,this.sheetModelIdsAtTheBeginningOfEdit=new gt.StringSet,this.handleAllSelectionListHighlights(),this.collapsibleDisplayDataTimer=new bo,this.bodyNode=new xi.NB(jg,new xi.hF,e),this.sketchNode=new xi.NB(Op,new xi.hF,e),this.elementPreviewBodyNode=new xi.NB(jg,new xi.hF,e),this.isBase()&&(this.listenTo(this.viewer.getEventDispatcher(),yD.LA,this.refreshHighlight),i.getIsPrimaryViewer()&&(this.simulationManager=new Pm(this),this.generativeDesignManager=new Wm(this),this.thicknessAnalysisManager=new Fm(this))),this.alternateEntityMapping=new $o.L,this.latestDisplayDataUsageSubscription=ys().latestDisplayDataUsageChangedObservable.subscribe((()=>this.clearAndRefreshHighlights())),this.meshPointController=new xn(this.viewer)}clearAndRefreshHighlights(){this.clearHighlights(),this.refreshHighlight()}getViewer(){return this.viewer}onViewerShown(){this.viewer.getIsForFlattenedDisplay()&&this.fitToSelectedSheetMetalModel()}setAlternateEntityMapping(e){this.alternateEntityMapping=e}setResyncFunction(e){this.resyncFunction=e}getResyncPromise(){return this.resyncPromise?this.resyncPromise:null}getSimulationManager(){return this.simulationManager}getGenerativeDesignManager(){return this.generativeDesignManager}getThicknessAnalysisManager(){return this.thicknessAnalysisManager}purgeUnusedPartStudios(e,t){const i=[];for(const t of Object.keys(this.partStudios))e.contains(t)||i.push(this.partStudios[t]);i.sort((function(e,t){return e.getEstimatedMemoryUsageOfBodies()>t.getEstimatedMemoryUsageOfBodies()?-1:e.getEstimatedMemoryUsageOfBodies()<t.getEstimatedMemoryUsageOfBodies()?1:0}));const s=[];for(;(t||this.isEstimatedBodyMemoryUsageAboveThreshold())&&i.length>0;){const e=i.shift();if(t||!e.getIsCachedPartStudioPendingUse()){const t=e.getFullElementId();e.onDeletion(),delete this.partStudios[t],s.push(t),this.displayedElementId&&this.setResyncNeeded(k.ggp.CLIENT_UNLOADED_DISPLAY_DATA)}}t&&Object.keys(this.partStudios).length>0&&ut.log.error("Failed to purge all part studios. Remaining part studios: "+Object.keys(this.partStudios)+", deleted part studios: "+s),s.length>0&&(this.meshManager.removeEmptyMeshes(),ut.log.info("Purged unused, in-memory part studios: "+s))}getInUsePartStudioIds(){const e=new gt.StringSet;if(this.displayingPartStudio()){this.getDisplayedPartStudio()&&e.add(this.getDisplayedPartStudio().getFullElementId());const t=this.getDisplayedInContextAssembly();t&&t.getUsedPartStudioIds(e)}else if(this.displayingAssembly()){const t=this.assemblies[this.displayedElementId];t&&t.getUsedPartStudioIds(e)}return e}getEstimatedMemoryUsageOfBodies(){const e=new Qo.B7("ModelViewManager.prototype.getEstimatedMemoryUsageOfBodies");let t=0;return Object.values(this.partStudios).forEach((function(e){t+=e.getEstimatedMemoryUsageOfBodies()}),this),e.report(),t}getBodyDisplayMemoryLimit(){return 1024*(Ki.Jq.CapabilitiesService.checkDecreasedBodyDisplayLimitCurrentlyEnabled()?eh.getNumber("DECREASED_BODY_DISPLAY_MEMORY_LIMIT_MB"):(0,dt.isBrowser64BitFirefox)()?eh.getNumber("BODY_DISPLAY_MEMORY_LIMIT_FIREFOX64_MB"):eh.getNumber("BODY_DISPLAY_MEMORY_LIMIT_MB"))*1024}clearAllGenerativeDesignPartInstances(){for(const e of Object.values(this.partStudios))e.getBodyComponent().clearAllGenerativeDesignOccurrences()}getBodyRefinementMemoryLimit(){return this.getBodyDisplayMemoryLimit()}isEstimatedBodyMemoryUsageAboveThreshold(){return this.getEstimatedMemoryUsageOfBodies()>this.getBodyDisplayMemoryLimit()}checkBodyMemoryUsage(e){if(!this.isBase()||this.viewer.getIsForFlattenedDisplay()||this.bodyLoadTasks.hasPendingUnloads()||e.fromDisplayCache)return;const t=this.getEstimatedMemoryUsageOfBodies(),i=this.getBodyDisplayMemoryLimit();if(t<=i)return;this.purgeUnusedPartStudios(this.getInUsePartStudioIds());const s=this.getEstimatedMemoryUsageOfBodies();if(s<=i)return;const n=new Qo.B7("ModelViewManager.prototype.checkBodyMemoryUsage",{logResult:_c()});_c()&&ut.log.info("bodyMemoryUse before unload: "+Nc(s));const r=this.viewer.getBodyManager().unloadBodies(s-i,this);if(r){const e=new Qo.B7("Unloading body display data",{logResult:_c()});r.then((t=>{if(this.setResyncNeeded(k.ggp.CLIENT_UNLOADED_DISPLAY_DATA),this.resyncAsNeeded(),e.report(),_c()){const e=this.getEstimatedMemoryUsageOfBodies();ut.log.info("Unloaded "+t.bodiesProcessedSinceStart+" bodies after "+t.iterationsSinceStart+" frames. bodyMemoryUse after unload: "+Nc(e))}}))}n.report()}setResyncNeeded(e){this.resyncNeeded=!0,this.resyncReason=void 0!==e?e:null}resyncAsNeeded(){if(this.resyncFunction&&this.resyncNeeded){const e=this.resyncFunction(this.resyncReason);return this.resyncNeeded=!1,this.resyncReason=null,e}return Ur()}integrityCheck(){if(this.displayedElementId in this.assemblies&&this.displayedElementType!==k.GNh.ASSEMBLY)ut.log.warn("Found an assembly with the displayed element id, but the element type is incorrect");else{const e=this.displayedElementId;let t=!1;if(e)for(const i in this.partStudios)if(0===i.indexOf(e)){t=!0;break}t&&this.displayedElementType!==k.GNh.PARTSTUDIO&&ut.log.warn("Found a part studio with the displayed element id, but the element type is incorrect")}}getSharedBodyNode(){return this.bodyNode}getSharedSketchNode(){return this.sketchNode}getElementPreviewBodyNode(){return this.elementPreviewBodyNode}clearSilhouetteRequests(){this.viewer.getSilhouetteTask().clearPendingRequestsForUsage(this.usage)}instantiateSharedNodes(e){e.addChild(this.bodyNode),e.addChild(this.sketchNode)}isBase(){return this.usage===fs.L.BASE}getDisplayedFullElementId(){return this.displayedElementMicroversionIdAndConfiguration?k.lK7.getFullElementIdString(this.displayedElementId,this.displayedElementMicroversionIdAndConfiguration.getKey()):this.displayedElementId}getLastDisplayedFullElementId(){const e=this.lastPartStudioMicroversionIdAndConfigurationIntervalProcessed[this.displayedElementId];return k.lK7.getFullElementIdString(this.displayedElementId,e?.to.microversion.theId)}setBodyLoadTasks(e){this.bodyLoadTasks=e}getHideableFeatureIdsForDisplayedPartStudio(e){if(e===this.getDisplayedElementId()){const e=this.partStudios[this.getDisplayedFullElementId()];if(e)return e.getHideableFeatureIds()}return[]}onDeletion(){Object.values(this.assemblies).forEach((function(e){e.onDeletion()})),Object.values(this.partStudios).forEach((function(e){e.onDeletion(!0)}),this),this.meshManager.destroy(),this.sharedBaseMeshManager&&(this.sharedBaseMeshManager.destroy(),this.sharedBaseMeshManager=null),this.stopListening(),this.latestDisplayDataUsageSubscription.unsubscribe(),this.meshPointController&&this.meshPointController.destroy(),this.clearSilhouetteRequests(),(0,Gr.Z)(this.queuedAssemblyTimeout)&&(window.clearTimeout(this.queuedAssemblyTimeout),this.queuedAssemblyTimeout=null)}getSceneGraph(){return this.usage===fs.L.PREVIEW?this.viewer.getSceneGraphs().getPreviewSceneGraph():this.viewer.getSceneGraphs().getMainSceneGraph()}getMeshManager(){return this.meshManager}getSharedBaseMeshManager(){return this.sharedBaseMeshManager}displayedMicroversionAndConfigMatchesDisplayData(e){return!!this.displayedElementMicroversionIdAndConfiguration&&e.microversionIdAndConfigurationInterval.to.equals(this.displayedElementMicroversionIdAndConfiguration)}processRootAssemblyDisplayData(e,t){if(!t&&(e.isCollapsible||this.viewer.getFrameTimer().userIsInteracting()&&this.displayedMicroversionAndConfigMatchesDisplayData(e))){const t=this.queuedAssemblyDisplayData.length>0?this.queuedAssemblyDisplayData[this.queuedAssemblyDisplayData.length-1]:null;t&&t.isCollapsible&&e.isCollapsible?(++t.collapseCount,t.mergeCollapsibleData(e)):this.queuedAssemblyDisplayData.push(e),this.startAssemblyDisplayDataQueueTimeout()}else this.emptyAssemblyDisplayDataQueue(),this.processRootAssemblyDisplayDataInternal(e,t),this.collapsibleDisplayDataTimer.reset()}startAssemblyDisplayDataQueueTimeout(){if((0,Gr.Z)(this.queuedAssemblyTimeout))return;const e=this.viewer.getFrameTimer().getTimingDetails(Wr.Q.INTERACTIVE).averageTime,t=this.collapsibleDisplayDataTimer.averageTime,i=Math.max((e+t)*eh.getNumber("ASSEMBLY_DRAG_COLLAPSE_WAIT_RATIO"),0);this.queuedAssemblyTimeout=window.setTimeout((()=>this.processAssemblyDisplayDataQueue()),i)}emptyAssemblyDisplayDataQueue(){(0,Gr.Z)(this.queuedAssemblyTimeout)&&(window.clearTimeout(this.queuedAssemblyTimeout),this.queuedAssemblyTimeout=null);for(let e=0;e<this.queuedAssemblyDisplayData.length;++e){const t=this.queuedAssemblyDisplayData[e];t.elementId!==this.displayedElementId||t.isCollapsible||this.processRootAssemblyDisplayDataInternal(t)}this.queuedAssemblyDisplayData=[]}processAssemblyDisplayDataQueue(){this.queuedAssemblyTimeout=null;let e=!1;for(let t=0;t<this.queuedAssemblyDisplayData.length&&!e;++t)e=e||this.queuedAssemblyDisplayData[t].elementId===this.displayedElementId&&this.queuedAssemblyDisplayData[t].isCollapsible;if(!e&&this.viewer.getFrameTimer().userIsInteracting())return void this.startAssemblyDisplayDataQueueTimeout();const t=this.queuedAssemblyDisplayData.shift();if(t&&t.elementId===this.displayedElementId){t.isCollapsible&&eh.getNumber("LOG_ASSEMBLY_DRAG_COLLAPSE_INFO")&&(t.collapseCount>1?(ut.log.debug("Did not collapse "+this.notCollapsedAssemblyMessageCount+" messages"),ut.log.debug("Collapsed "+t.collapseCount+" display data messages for "+t.elementId),this.notCollapsedAssemblyMessageCount=0):++this.notCollapsedAssemblyMessageCount);const e=(0,Fs.Wj)();this.processRootAssemblyDisplayDataInternal(t),t.isCollapsible&&this.collapsibleDisplayDataTimer.addTiming((0,Fs.Es)(e))}this.queuedAssemblyDisplayData.length>0&&this.startAssemblyDisplayDataQueueTimeout()}resetAllIncontextGraphicsForPartstudio(e){if(!this.assemblies)return;let t="";const i=Object.keys(this.assemblies);for(let s=0;s<i.length;s++){const n=i[s];if((0,Fs.dV)(n)===e){t=n;const e=this.assemblies[t];if(!e)continue;e.reset()}}}processPartStudioDisplayDataList(e,t,i){let s=i;for(const i of e){const e=i;if(!e)return;const n=!0,r=this.getAndUpdatePartStudioForMessage(e,t,n),a=e.microversionIdAndConfigurationInterval.to.equals(e.microversionIdAndConfigurationInterval.from);r&&r.processDisplayData(e,!1,t,a),s=s&&a}return s}processRootAssemblyDisplayDataInternal(e,t){const i=new Qo.B7("processRootAssemblyDisplayDataInternal",{setTraceId:!0}),s=e.elementId,n=!!t,r=this.displayedMicroversionAndConfigMatchesDisplayData(e);s!==this.displayedElementId||e.incremental||e.fromDisplayCache||this.clearSilhouetteRequests();let a=this.assemblies[s];a||(a=new pd(s,this,this.viewer),this.assemblies[s]=a,this.integrityCheck()),e.isForInContext&&this.showAssembly(s,e.isForInContext),this.clearHighlights(),a.processOccurrenceDeletions(e,t);const o=this.processPartStudioDisplayDataList(e.partStudioDisplayData,n,r);this.resyncNeeded&&this.resyncFunction?o?(this.resyncNeeded=!1,ut.log.warn("Skipped resync when processing tessellation update for assembly "+this.displayedElementId+" "+this.displayedElementMicroversionIdAndConfiguration)):this.resyncPromise=this.resyncAsNeeded().then((()=>{this.processRootAssemblyDisplayDataHelper(s,a,e,o,i),this.resyncPromise=null})):this.processRootAssemblyDisplayDataHelper(s,a,e,o,i)}processRootAssemblyDisplayDataHelper(e,t,i,s,n){if(i.isForInContext&&this.showAssembly(e,i.isForInContext),s&&(this.viewer.getBodyManager().cleanupPendingRefinementRequests(),_c())){const e=[];for(let t=0;t<i.partStudioDisplayData.length;++t){const s=i.partStudioDisplayData[t],n=k.lK7.getFullElementIdString(s.elementId,s.microversionIdAndConfigurationInterval.to.getKey());if(this.getPartStudio(n)){for(const t in s.deterministicPartIdToData)if(s.deterministicPartIdToData.hasOwnProperty(t)){const i=s.deterministicPartIdToData[t];e.push(t+"-"+i.tessellationSettings)}}else ut.log.warn(`Cannot find part studio: ${n} to apply display data refinement update.`)}ut.log.info("Processing update for bodies:\n"+e);const t=this.getEstimatedMemoryUsageOfBodies();ut.log.info("bodyMemoryUse prior to update: "+Nc(t))}if(t.processDisplayData(i),e===this.displayedElementId){const e=!this.displayedElementMicroversionIdAndConfiguration;this.displayedElementMicroversionIdAndConfiguration=i.microversionIdAndConfigurationInterval.to,this.displayAssembly(this.displayedElementId,e)}this.updateOrVerifySelections(null,e),this.refreshHighlight(),this.viewer.getEventDispatcher().trigger(yD.hj,i,s),this.viewer.requestDraw(),t.microversionIdAndConfiguration=i.microversionIdAndConfigurationInterval.to,!s&&this.simulationManager&&this.simulationManager.onAssemblyChanged();const r=this.viewer.getPendingBodiesToLoadPromise();r?r.then((()=>{this.viewer.getBodyManager().initiateAutomaticRetrieval(!s)})):this.viewer.getBodyManager().initiateAutomaticRetrieval(!s),this.checkBodyMemoryUsage(i),this.resyncAsNeeded(),n.report()}getOrCreatePartStudio(e,t){const i=t?k.lK7.getFullElementIdString(e,t.getKey()):e;let s=this.partStudios[i];if(!s){if(!this.bodyLoadTasks)throw"Loaders should be constructed prior to handling display data";s=new xd(e,t||null,this,this.bodyLoadTasks,this.usage,this.viewer),this.partStudios[i]=s,this.integrityCheck()}return s}getMicroversionIdsString(e){const t=[];for(const i in this.partStudios){const s=this.partStudios[i];s.getElementId()===e&&t.push(s.getMicroversionIdAndConfiguration())}return"["+t.join(", ")+"]"}getAndUpdatePartStudioForMessage(e,t,i,s){let n;if(!this.isBase())return n=this.partStudios[e.elementId]||this.getOrCreatePartStudio(e.elementId),n.microversionIdAndConfiguration=e.microversionIdAndConfigurationInterval.to,n;const r=!(t||i||e.elementId!==this.displayedElementId||e.fromDisplayCache||s);let a=!1;this.displayedElementMicroversionIdAndConfiguration&&!this.displayedElementIsPublicationItem||!r||(this.displayedElementMicroversionIdAndConfiguration=e.microversionIdAndConfigurationInterval.to,a=!0);const o=e.buildFullElementId(!0).toString(),h=e.buildFullElementId(!1).toString();if(this.isBase()&&this.viewer.getModelViewManagers().getPreviewManager()&&!e.incremental&&!e.keepFromMicroversion&&o in this.partStudios&&(ut.log.info("Received non-incremental base display data during preview/compare. Cloning base reference"),n=this.partStudios[o],this.partStudioPreservedForPreview=n,this.partStudios[o]=n.clone(e.incremental)),o!==h&&o in this.partStudios)h in this.partStudios&&(ut.log.info("Deleting existing local copy of : "+h),this.partStudios[h].onDeletion(),delete this.partStudios[h]),n=this.partStudios[o],e.keepFromMicroversion?n=n.clone(e.incremental):delete this.partStudios[o],this.partStudios[h]=n,n.microversionIdAndConfiguration=e.microversionIdAndConfigurationInterval.to,this.getDisplayedFullElementId()===o&&r&&(this.displayedElementMicroversionIdAndConfiguration=e.microversionIdAndConfigurationInterval.to);else{if(o!==h&&e.microversionIdAndConfigurationInterval.from&&e.microversionIdAndConfigurationInterval.from.microversion.theId)return this.partStudios[h]?(ut.log.trace("Skipped application of increment for part studio "+e.elementId+" because it was incrementing to a microversion that was already present "+e.microversionIdAndConfigurationInterval.to),r&&(this.displayedElementMicroversionIdAndConfiguration=e.microversionIdAndConfigurationInterval.to),this.partStudios[h].updateExternalState(t,i)):(ut.log.warn("Skipped application of increment for part studio "+e.elementId+" due to missing from data.  Interval with missing data: "+e.microversionIdAndConfigurationInterval+". Existing microversions for element: "+this.getMicroversionIdsString(e.elementId)),this.setResyncNeeded(),a&&(this.displayedElementMicroversionIdAndConfiguration=null)),null;if(e.incremental&&!(h in this.partStudios))return ut.log.warn("Skipped creation of part studio "+e.elementId+" because the destination microversion is missing.  MV interval: "+e.microversionIdAndConfigurationInterval+". From display cache: "+e.fromDisplayCache+". Existing microversions for element: "+this.getMicroversionIdsString(e.elementId)),this.setResyncNeeded(),a&&(this.displayedElementMicroversionIdAndConfiguration=null),null;n=this.getOrCreatePartStudio(e.elementId,e.microversionIdAndConfigurationInterval.to)}return n.updateExternalState(t,i),n}processManagedData(e){e?.computedData?.computedData&&(this.displayedPartStudio&&this.displayedPartStudio.microversionIdAndConfiguration?.equals(e.microversionIdAndConfigurationInterval.to)?(this.displayedPartStudio.addManagedIdMappings(e.computedData.computedData),this.pendingPartStudioComputedData=null):this.pendingPartStudioComputedData=e)}processReceivedInsertableDisplayData(e){const t=this.partStudios[this.getDisplayedFullElementId()];t&&t.processReceivedInsertableData(e)}processPartStudioDisplayData(e,t){const i=!!this.displayedElementMicroversionIdAndConfiguration;this.lastPartStudioProcessed=e.elementId,this.lastPartStudioMicroversionIdAndConfigurationIntervalProcessed[e.elementId]=e.microversionIdAndConfigurationInterval;const s=this.displayedMicroversionAndConfigMatchesDisplayData(e);s?this.viewer.getBodyManager().cleanupPendingRefinementRequests():this.viewer.getBodyManager().clearPreviewOccurrences(),this.isBase()&&this.hideInactiveContextAssemblies(e);const n=this.getAndUpdatePartStudioForMessage(e,e.isExternal);if(e.incremental)for(const t in e.deterministicPartIdToData)if(!e.deterministicPartIdToData[t].isACopyForTessellationSettings){const i=pa(e.elementId,t,70,40);la(i),oa(i)}const r=this.isBase()?e.buildFullElementId().toString()===this.getDisplayedFullElementId():this.displayedElementId===e.elementId&&!e.fromDisplayCache;if(r&&(this.displayPartStudio(this.getDisplayedFullElementId()),e.incremental||(this.partStudioVisibilityUpdated=!1)),n&&!e.isNoop){const i=!1,a=this.viewer.getModelViewManagers().getManager();let o;if(e.usage===k.rvN.PREVIEW_AFTER){o=new gt.StringSet;const t=a.partsAtTheBeginningOfEdit,i=a.sheetModelIdsAtTheBeginningOfEdit;e.partDisplayData.forEach((s=>{const n=e.deterministicPartIdToData[s.id];let r=null;if(n)r=n.sheetMetalModelId;else{const e=this.viewer.getModelViewManagers().getPreviewManager().retrieveBodyMetaData(null,s.id);r=e?e.sheetMetalModelId:null}t.contains(s.id)||i.contains(r)||o.add(s.id)}))}if(n.processDisplayData(e,r,i,s,o),this.viewer.getCurvatureAnalysisManager()?.onPartStudioDisplayDataChanged(e,e.buildFullElementId().toString()),this.thicknessAnalysisManager?.onPartStudioDisplayDataChanged(e),e.usage===k.rvN.PREVIEW_BEFORE){this.partsAtTheBeginningOfEdit=new gt.StringSet,this.sheetModelIdsAtTheBeginningOfEdit=new gt.StringSet,this.newParts=new gt.StringSet;const t=this.displayedPartStudio,i=this;e.partDisplayData.forEach((function(e){i.partsAtTheBeginningOfEdit.add(e.id);const s=t.retrieveBodyMetaData(e.id);s&&s.sheetMetalModelId&&i.sheetModelIdsAtTheBeginningOfEdit.add(s.sheetMetalModelId)}))}else e.usage===k.rvN.PREVIEW_AFTER&&(a.newParts=o);this.updateOrVerifySelections(t,e.elementId),this.viewer.getEventDispatcher().trigger(yD.cy,e.elementId),this.refreshHighlight()}else n&&n.processInContextData(e,r);return this.resyncNeeded&&(s?(this.resyncNeeded=!1,ut.log.warn("Skipped resync when processing tessellation update for part studio "+this.displayedElementId+" "+this.displayedElementMicroversionIdAndConfiguration)):this.resyncAsNeeded()),r&&(this.processInContextDisplayData(e,s),this.selectedSheetmetalModelId&&this.showPartsWithSheetmetalModelIdOnly(this.selectedSheetmetalModelId),this.pendingPartStudioComputedData&&this.processManagedData(this.pendingPartStudioComputedData),i||this.viewer.getIsForFlattenedDisplay()||this.viewer.getEventDispatcher().trigger(yD.ad,e.elementId,!i)),this.checkBodyMemoryUsage(e),s}populateClientCacheStateDisplayInformation(e){this.emptyAssemblyDisplayDataQueue();this.viewer.processQueuedDisplayData(!0);this.getPartStudioSortedForCache().forEach((function(t){t.populateClientCacheStateDisplayInformation(e)}),this),Object.values(this.assemblies).forEach((function(t){t.populateClientCacheStateDisplayInformation(e)}),this)}displayPartStudio(e){const t=this.partStudios[e];t!==this.displayedPartStudio&&this.removePartStudioDisplay(),t&&(t.instantiateForEditingInNode(this.getElementRootNode()),this.displayedPartStudio=t,this.viewer.getCurvatureAnalysisManager()?.onPartStudioDisplayed());lt.T.isElementAtVersionOrLater(k.vgi.V343_SUBFEATURES)&&!Ki.Jq.StateService.isOnDocumentCompare()?(this.viewer.getEdgePointController()||this.viewer.createEdgePointController(),this.viewer.getEdgePointController().enable()):this.viewer.getEdgePointController()&&this.viewer.getEdgePointController().disable()}removePartStudioDisplay(){this.displayedPartStudio&&(this.displayedPartStudio.removeInstantiationForEditing(this.getElementRootNode()),this.displayedPartStudio=null)}displayAssembly(e,t){const i=this.assemblies[e];i&&(this.getElementRootNode(),i.show(),this.simulationManager&&this.simulationManager.onAssemblyDisplayed(),this.viewer.getEventDispatcher().trigger(yD.t0,e,t))}getModelBounds(e){const t=new yi.kB,i=this.getSceneGraph().getRootNode(),s=i.getChildById(rI);if(s&&s.getBoundingBox().isInitialized()&&t.addBox(s.getBoundingBox()),!e||!e.doNotBoundTemporarySketchEntities){const e=i.getChildrenWithPrefix(oI);if(e)for(let i=0;i<e.length;++i)t.addBox(e[i].getBoundingBox())}const n=this.getDisplayedElement();return n&&t.addBox(n.getBoundsOutsideElementNode()),t.addBox(this.viewer.getBodyManager().getUnloadedBodyBounds()),t.isInitialized()?t:null}setModelTransform(e){const t=this.getSceneGraph().getRootNode(),i=t.getChildById(rI),s=t.getChildById(aI);i&&i.setPose(e),s&&s.setPose(e),this.applyToPreview(this.setModelTransform,arguments)}getModelTransform(){const e=this.getSceneGraph().getRootNode().getChildById(rI);return e?e.getPose():null}getEntityBounds(e,t){const i=this.getPartStudioDataFromOccurrence(t);if(!i)return null;const s=i.getEntityBounds(e,t);return s&&t?s.createTransformedCopy(this.getOccurrenceTransform(t)):s}getFeatureBounds(e){if(!this.displayingPartStudio())return null;const t=this.getDisplayedPartStudio();return t?t.getFeatureBounds(e):null}getBodyBounds(e,t){const i=this.getDisplayedElement();return i?i.getBodyBounds(e,t):null}getSelectionFitBounds(e){if(!e)return null;const t=e.getIdString(),i=e.getOccurrence();switch(e.getType()){case k.lQt.ENTITY:let e=this.getEntityBounds(t,i);return e||(e=this.getEntityBounds(this.alternateEntityMapping.get(t),i)),e;case k.lQt.FEATURE:if(ws()){const e=new yi.kB;return e.addBox((0,Jo.IO)().getManager().getFeatureBounds(t)),e.addBox((0,Jo.IO)().getPreviewManager().getFeatureBounds(t)),e}return this.getFeatureBounds(t);case k.lQt.BODY:let s=this.getBodyBounds(t,i);return s||(s=this.getBodyBounds(this.alternateEntityMapping.get(t),i)),s;case k.lQt.TABLE_ITEM:case k.lQt.OCCURRENCE:return i?this.getOccurrenceBounds(i):null;default:return null}}getElementRootNode(){const e=this.getSceneGraph().getRootNode();if(!e.getChildById(rI)){const t=new xi.NB(rI);e.addChild(t,0),this.instantiateSharedNodes(t)}return e.getChildById(rI)}getElementPreviewRootNode(){const e=this.getSceneGraph().getRootNode();if(!e.getChildById(aI)){const t=new xi.NB(aI);e.addChild(t),t.addChild(this.elementPreviewBodyNode)}return e.getChildById(aI)}cloneForPreview(e){const t=new Qo.B7("ModelViewManager.cloneForPreview"),i=new th(fs.L.PREVIEW,this.occurrenceDataManager,this.viewer),s=this.getDisplayedPartStudio();if(!s)throw"There is no base part studio to clone.";if(s.getElementId()!==e.elementId)throw"Displayed part studio does not match the part studio being previewed";i.sharedBaseMeshManager=this.meshManager.cloneForPreview(s.getMeshOwnerId());const n=s.cloneForPreview(i,!1);return i.partStudios[e.elementId]=n,i.displayedElementId=e.elementId,i.displayedElementType=k.GNh.PARTSTUDIO,i.setBodyLoadTasks(this.bodyLoadTasks),i.displayPartStudio(e.elementId),i.occurrenceDataManager=this.occurrenceDataManager,i.alternateEntityMapping=this.alternateEntityMapping,i.selectedSheetmetalModelId=this.selectedSheetmetalModelId,i.processManagedData(this.pendingPartStudioComputedData),t.report(),i}onPreviewDestroyed(){Object.values(this.partStudios).forEach((function(e){e.onPreviewDestroyed()}),this),this.partStudioPreservedForPreview&&(this.partStudioPreservedForPreview.onDeletion(),this.partStudioPreservedForPreview=null)}getPartStudioSortedForCache(){return Object.values(this.partStudios).sort((function(e,t){return e.getIsInternal()===t.getIsInternal()?e.microversionIdAndConfiguration.microversion.theId===t.microversionIdAndConfiguration.microversion.theId?e.microversionIdAndConfiguration.getKey()<t.microversionIdAndConfiguration.getKey()?-1:1:e.microversionIdAndConfiguration.microversion.theId<t.microversionIdAndConfiguration.microversion.theId?-1:1:e.getIsInternal()?-1:1}))}resetDisplayedElement(){this.displayedElementMicroversionIdAndConfiguration=null}onChangeActiveElement(e,t,i){if(this.clearSilhouetteRequests(),this.simulationManager&&this.simulationManager.clearSimulationAndConnectionGraphics(),this.viewer.getCurvatureAnalysisManager()?.onChangeActiveElement(),this.generativeDesignManager?.onChangeActiveElement(),this.displayingAssembly()){const e=this.assemblies[this.displayedElementId];e&&e.hide()}else this.displayingPartStudio()&&this.removePartStudioDisplay();this.displayedElementId="",this.displayedElementMicroversionIdAndConfiguration=null,this.displayedElementIsPublicationItem=void 0,this.partStudioVisibilityUpdated=!1,e?(this.displayedElementType=t,this.displayedElementType===k.GNh.PARTSTUDIO?(this.displayedElementId=e,this.displayedElementIsPublicationItem=i,this.displayedElementMicroversionIdAndConfiguration=null,this.viewer.requestDraw()):this.displayedElementType===k.GNh.ASSEMBLY?(this.displayedElementId=e,this.displayedElementIsPublicationItem=i,this.viewer.requestDraw()):this.displayedElementId=""):this.displayedElementId="",this.integrityCheck();!this.displayingPartStudio()&&this.viewer.getEdgePointController()&&this.viewer.getEdgePointController().disable()}displayingPartStudio(){return this.displayedElementType===k.GNh.PARTSTUDIO}displayingAssembly(){return this.displayedElementType===k.GNh.ASSEMBLY}getDisplayedElementId(){return this.displayedElementId}getDisplayedElement(){return this.displayingPartStudio()?this.partStudios[this.isBase()?this.getDisplayedFullElementId():this.displayedElementId]:this.displayingAssembly?this.assemblies[this.displayedElementId]:null}getDisplayedElementMicroversionId(e){if(e===fs.L.PREVIEW&&this.usage!==fs.L.PREVIEW)return this.applyToPreview(this.getDisplayedElementMicroversionId,arguments);const t=this.getDisplayedElement();return t&&t.microversionIdAndConfiguration&&t.microversionIdAndConfiguration.microversion?t.microversionIdAndConfiguration.microversion.theId:""}getDisplayedPartStudio(){return this.partStudios[this.getDisplayedFullElementId()]||null}getLastDisplayedPartStudio(){return this.partStudios[this.getLastDisplayedFullElementId()]||null}getDisplayedInContextAssembly(){const e=this.getDisplayedPartStudio();return e&&e.isDisplayingIncontextAssembly()?this.assemblies[e.getVisibleInContextAssemblyId()]:null}getDisplayedAssembly(){return this.assemblies[this.displayedElementId]||null}getPartStudioVisibilityUpdated(){return this.partStudioVisibilityUpdated}setPartStudioVisibilityUpdated(){this.getDisplayedPartStudio()&&(this.partStudioVisibilityUpdated=!0)}getInContextOccurrenceDisplayData(e){const t=this.getDisplayedPartStudio();if(t){const i=this.assemblies[t.getVisibleInContextAssemblyId()];if(i){const t=i.getDisplayDataForOccurrence(e);if(t)return t}}return null}getOccurrenceDisplayData(e){const t=this.assemblies[this.displayedElementId];return t?t.getOccurrenceDisplayData(e):this.getInContextOccurrenceDisplayData(e)}getMateConnectorGraphics(e,t){if(this.displayingAssembly()){const i=this.assemblies[this.displayedElementId];if(i)return i.getMateConnectorGraphics(e,t)}else if(this.displayingPartStudio()){if(e){const i=this.getDisplayedInContextAssembly();if(i)return i.getMateConnectorGraphics(e,t)}const i=this.partStudios[this.getDisplayedFullElementId()];if(i)return i.getMateConnectorGraphics(e,t)}return null}hasMateIndicatorForOccurrence(e){if(this.displayingAssembly()){const t=this.assemblies[this.displayedElementId];if(t)return t.hasMateIndicatorForOccurrence(e)}return!1}hasGraphicsOccurrenceData(e){return!!e.isAssemblyRoot()||!!this.getOccurrenceDisplayData(e)}getOccurrenceElementId(e){const t=this.getOccurrenceDisplayData(e);return t?t.fullElementId:null}getOccurrenceTransform(e){const t=this.getOccurrenceDisplayData(e);return t?t.occurrenceData.transform.getGlMatrix():de.create()}updateOccurrenceTransform(e,t){const i=this.assemblies[this.displayedElementId];i&&i.updateOccurrenceTransform(e,t)}batchUpdateOccurrenceTransforms(e){if(0===e.length)return!0;const t=this.assemblies[this.displayedElementId];return!!t&&t.batchUpdateOccurrenceTransforms(e)}getPartStudios(){return Object.values(this.partStudios)}getPartStudioDataFromOccurrence(e){if(this.displayingAssembly()){if(!e)return ut.log.warn("An attempt was made to retrieve an part studio data from an assembly without a specified occurrence"),null;const t=this.assemblies[this.displayedElementId];if(t){const i=t.getDisplayDataForOccurrence(e);if(i)return this.partStudios[i.fullElementId.toString()]||null}}else if(this.displayingPartStudio()){if(e){const t=this.getInContextOccurrenceDisplayData(e);if(t&&this.partStudios[t.fullElementId.toString()])return this.partStudios[t.fullElementId.toString()]}return this.partStudios[this.getDisplayedFullElementId()]||null}return null}getPartStudio(e){return(e=e.toString()).length>0&&e.length<=25&&"-"!==e&&this.isBase()&&ut.log.info("An attempt was made to get part studio with id that is not in elementId-microversionId format"),this.partStudios[e]||null}getDeterministicIdForFeature(e,t,i){let s;const n=this,r=n.getEntitiesForFeature(e,t);return r&&(s=r.find((function(t){const s=n.retrieveEntityMetaData(e,t);if(s){const n=(0,Ce.fl)(t,s,{},e);if(n&&(!i||i.filter(n)))return!0}return!1}))),s||""}getDeterministicIdForPickId(e,t){const i=e?this.getPartStudioDataFromOccurrence(e):this.getDisplayedPartStudio();return i?i.getEntityIdManager().getNameForId(t):null}retrieveEntityMetaData(e,t){if(!t)return null;if(t.startsWith(k.FBt.SECTION_IDENTIFIER)){const e=(0,LS.Ky)();return e?.getEntityMetaData(t)}let i=this.getDisplayedPartStudio();if(e&&(i=this.getPartStudioDataFromOccurrence(e)),!i)return null;let s=i.retrieveEntityMetaData(t);if(!s){const e=this.alternateEntityMapping.get(t);e&&(s=i.retrieveEntityMetaData(e))}return s}retrieveBodyMetaData(e,t){let i=this.getDisplayedPartStudio();if(e&&(i=this.getPartStudioDataFromOccurrence(e)),!i)return null;let s=i.retrieveBodyMetaData(t);return!s&&(s=this.applyToPreview(this.retrieveBodyMetaData,arguments)||null,s)?(s.foundInPreview=!0,s):s}retrieveAssociatedFeatureIds(e,t){let i=this.getDisplayedPartStudio();return e&&(i=this.getPartStudioDataFromOccurrence(e)),i?i.retrieveAssociatedFeatureIds(t):null}getFlattenedEntityOwnerBodyDetails(e,t){if(!this.viewer.getIsForFlattenedDisplay())return null;const i=this.retrieveEntityMetaData(t,e);if(!i)return null;const s=this.getPartStudioDataFromOccurrence(t);if(!s)return null;let n=null;if(n=i.isFromSketch()?s.getSketchComponent().getOwnerFlattenedBodyId(e):i.getBodyId(),!n)return null;const r=s.retrieveBodyMetaData(n);if(r){return{bodyMetaData:r,transform:s.getBodyComponent().getTransformFromSheetMetalBodyMetaData(r)}}return null}updatePSOI(e){const t=this.getDisplayedPartStudio();t&&t.updatePSOI(e)}getPartStudioBodyMetaDataAssociatedWithSelections(e){if(!this.displayingPartStudio())return[];const t=new Set;e&&t.add(e),(0,Ce.vi)().each((function(e){if(!e.getOccurrence()){const i=e.getBodyId();i&&t.add(i)}}),this);const i=[];return t.forEach((e=>{const t=this.retrieveBodyMetaData(null,e);t&&i.push(t)})),i.filter((e=>!e.getIsFromSketch()))}getAssemblyOccurrencesAssociatedWithSelections(){if(!this.displayingAssembly())return[];const e=[];return(0,Ce.vi)().forEach((t=>{e.push(t.getOccurrence().getPathAsString())})),e}hasEntity(e,t){return!!this.retrieveEntityMetaData(e,t)}hasFeature(e,t){const i=this.getCurrentPartStudioData(e);return!!i&&i.hasFeature(t)}getFirstMateConnectorId(e){const t=this.getCurrentPartStudioData(e);return t?t.mateConnectorComponent.featureToIds.firstKey():null}assemblyHasHiddenOccurrences(){const e=this.getDisplayedAssembly();if(e)for(const t in e.occurrences)if(e.occurrences[t].isHidden)return!0;return!1}getAllMateConnectorIds(e,t){let i=[];const s=this.getCurrentPartStudioData(e);if(s)i=s.mateConnectorComponent.getInstantiatedMateConnectorsForOccurrence(e);else if(this.displayingAssembly()&&e){const s=this.assemblies[this.displayedElementId];s&&(i=s.getMateConnectorIdsForOccurrence(e,t))}return i}hasBody(e,t){const i=this.getCurrentPartStudioData(e);return!!i&&i.hasBody(t)}getCurrentPartStudioData(e){return e?this.getPartStudioDataFromOccurrence(e):this.getDisplayedPartStudio()}hideSketch(e){const t=this.getDisplayedPartStudio();t&&t.hideSketch(e),this.applyToPreview(this.hideSketch,arguments)}retrieveSketchEntityDeterministicId(e,t){const i=this.getDisplayedPartStudio();return i?i.retrieveSketchEntityDeterministicId(e,t):null}showSketch(e){const t=this.getDisplayedPartStudio();t&&t.showSketch(e),this.applyToPreview(this.showSketch,arguments)}displaySketchAsActive(e){const t=this.getDisplayedPartStudio()||this.getLastDisplayedPartStudio();t&&t.displaySketchAsActive(e)}displaySketchAsInactive(e){const t=this.getDisplayedPartStudio();t&&t.displaySketchAsInactive(e)}hasActiveSketch(){const e=this.getDisplayedPartStudio();return!!e&&e.hasActiveSketch()}hideInactiveContextAssemblies(e){if(Ls())return;const t=e.assemblyReferenceDisplayData,i=new gt.StringSet;let s;for(s=0;s<t.assemblyReferences.length;s++){const e=t.assemblyReferences[s],n=e.assemblyDisplayData,r=(0,Fs.HL)(n.elementId,t.elementId,e.referenceNodeId);i.add(r),e.visibility!==k.HRI.VISIBLE&&this.hideAssembly(r)}const n=this.getDisplayedPartStudio();if(n){const e=n.getReferencedInContextAssemblyIds();for(s=0;s<e.length;s++)i.contains(e[s])||this.hideAssembly(e[s])}}processInContextDisplayData(e,t){e.isBase()&&(this.viewer.getIsForFlattenedDisplay()?this.processInContextDisplayDataForFlat(e,t):this.viewer.getIsPrimaryViewer()&&this.processInContextDisplayDataFor3d(e,t))}processInContextDisplayDataFor3d(e,t){let i=!1;const s=e.assemblyReferenceDisplayData;for(let t=0;t<s.assemblyReferences.length;t++){const n=s.assemblyReferences[t],r=n.assemblyDisplayData;if(n.visibility!==k.HRI.VISIBLE)continue;r.elementId=(0,Fs.HL)(r.elementId,s.elementId,n.referenceNodeId);const a=[];n.occurrencesToExclude.forEach((function(e){a.push(e.getPathAsString())}));const o=[];r.occurrences.push(k.yLM.createRootOccurrenceDisplayData(r.elementId)),r.occurrences.forEach((function(e){const t=e.occurrenceData.occurrence.getPathAsString(),i=e.occurrenceData.transform.getGlMatrix(),s=n.transform.getGlMatrix(),r=ge.w$.multiply(s,i,de.create());e.occurrenceData.transform.updateFromGlMatrix(r),o.push(e),a.indexOf(t)>=0&&(e.partIds=[],e.fullElementId=new k.lK7)})),r.occurrences=o,Ls()||this.viewer.onRootAssemblyDisplayData(r,e),i=!0}i?(0,yD.xA)().trigger(yD.bh,i):e.isNoop||(0,yD.xA)().trigger(yD.bh,i)}processInContextDisplayDataForFlat(e,t){if(Ls())return;const i=e.assemblyReferenceDisplayData;for(let e=0;e<i.assemblyReferences.length;e++){const s=i.assemblyReferences[e].assemblyDisplayData,n=!0;this.processPartStudioDisplayDataList(s.partStudioDisplayData,n,t)}}applyToPreview(e,t){if(this.isBase()){const i=this.viewer.getModelViewManagers().getPreviewManager();if(i)return e.apply(i,[...t])}return null}showConstructionPlane(e){const t=this.getDisplayedPartStudio();t&&t.showConstructionPlane(e),this.applyToPreview(this.showConstructionPlane,arguments),this.viewer.requestDraw()}hideMateConnector(e,t){const i=this.getDisplayedPartStudio();i&&i.hideMateConnector(e,t),this.applyToPreview(this.hideMateConnector,arguments),this.viewer.requestDraw()}showMateConnector(e,t){const i=this.getDisplayedPartStudio();i&&i.showMateConnector(e,t),this.applyToPreview(this.showMateConnector,arguments),this.viewer.requestDraw()}hideFeatureBodies(e,t){const i=this.getDisplayedPartStudio();i&&i.hideFeatureBodies(e,t),this.applyToPreview(this.hideFeatureBodies,arguments),this.viewer.requestDraw()}showFeatureBodies(e,t){const i=this.getDisplayedPartStudio();i&&i.showFeatureBodies(e,t),this.applyToPreview(this.showFeatureBodies,arguments),this.viewer.requestDraw()}hideConstructionPlane(e){const t=this.getDisplayedPartStudio();t&&t.hideConstructionPlane(e),this.applyToPreview(this.hideConstructionPlane,arguments),this.viewer.requestDraw()}hidePart(e){let t=!1;const i=this.getDisplayedPartStudio();return i&&(t=i.hidePart(e)),this.applyToPreview(this.hidePart,arguments),this.viewer.requestDraw(),t}showPart(e){let t=!1;const i=this.getDisplayedPartStudio();return i&&(t=i.showPart(e)),this.applyToPreview(this.showPart,arguments),this.viewer.requestDraw(),t}setPlaneAppearance(e,t){const i=this.getDisplayedPartStudio();i&&(i.setPlaneAppearance(e,t),this.viewer.requestDraw()),this.applyToPreview(this.setPlaneAppearance,arguments)}hidePointBodies(e){const t=this.getDisplayedPartStudio();t&&(t.hidePointBodies(e),this.applyToPreview(this.hidePointBodies,arguments),this.viewer.requestDraw())}showPointBodies(e){const t=this.getDisplayedPartStudio();t&&(t.showPointBodies(e),this.applyToPreview(this.showPointBodies,arguments),this.viewer.requestDraw())}changePartColor(e,t,i){const s=this.getDisplayedPartStudio();s&&(s.changePartColor(e,t,i),this.viewer.requestDraw())}changePartOpacity(e,t,i){const s=this.getDisplayedPartStudio();s&&(s.changePartOpacity(e,t,i),this.viewer.requestDraw())}getPartColor(e){const t=this.getDisplayedPartStudio();return t?t.getPartColor(e):null}getPartOpacity(e){const t=this.getDisplayedPartStudio();return t?t.getPartOpacity(e):-1}getOccurrenceColor(e){const t=this.getPartStudioDataFromOccurrence(e);return t?t.getBodyComponent(e).getOccurrenceColor(e):null}setOccurrenceAlphaModifier(e,t){const i=this.getPartStudioDataFromOccurrence(e);i&&i.getBodyComponent(e).setOccurrenceAlphaModifier(e,t)}clearOccurrenceAlphaModifier(e){const t=this.getPartStudioDataFromOccurrence(e);t&&t.getBodyComponent(e).clearOccurrenceAlphaModifier(e)}addTemporarySketchComponent(e){this.temporarySketchComponents[e.getUniqueId()]=e}removeTemporarySketchComponent(e){delete this.temporarySketchComponents[e.getUniqueId()]}processEntitiesHighlight(e,t,i,s){let n=Jf.KF;const r=this.getPartStudioDataFromOccurrence(t);if(t&&(n=this.viewer.getOccurrenceIdManager().getIdForName(t.getPathAsString())),n!==Jf.Qy)for(let t=0;t<i.length;++t){const a=i[t];r.updateEntityHighlight(e,s,a,n),this.updateTemprorarySketchHighlights(e,s,a,n);const o=this.alternateEntityMapping.get(a);if(o){const t=o.split(un.ID_SEPARATOR);for(let i=0;i<t.length;i++)r.updateEntityHighlight(e,s,t[i],n)}}}updateTemprorarySketchHighlights(e,t,i,s){for(const n in this.temporarySketchComponents)this.temporarySketchComponents[n].updateEntityHighlight(e,t,i,s)}getDimensionGraphic(e,t){let i=null;return this.displayedElementType===k.GNh.PARTSTUDIO&&(i=this.getDisplayedPartStudio()),i?i.getDimensionGraphic(e,t):null}processOccurrenceHighlight(e,t,i){const s=i.cloneForOccurrence(t);let n;if(t&&t.path[0]===Dp.PART_STUDIO_BODY_OCCURRENCE_PREFIX)n=[t];else{const i=this.assemblies[this.displayedElementId];if(!i)return;n=i.getLeafOccurrencesContainedWithinOccurrence(t);for(let t=0;t<n.length;++t){const r=i.getOccurrenceEntityIdsForHighlight(n[t]);r.length>0&&this.processEntitiesHighlight(e,n[t],r,s)}}this.viewer.getBodyManager().onOccurrencesHighlighted(e,n),this.occurrenceDataManager.processHighlightForOccurrences(e,n,s,this.usage)}getOccurrenceIdForSelection(e){if(e.getOccurrence())return this.viewer.getOccurrenceIdManager().getIdForName(e.getOccurrence().getPathAsString());{const t=this.getPartStudioDataFromOccurrence(e.getOccurrence());if(t)return t.getPartStudioOccurrenceIdForSelection(e)}return Jf.Qy}getEntityIdsForSelection(e){let t=null;const i=this.getPartStudioDataFromOccurrence(e.getOccurrence());return i&&(t=i.getEntityIdsForSelection(e)),t||[]}getEntitiesForFeature(e,t,i){let s=this.displayedPartStudio;return e&&(s=this.getPartStudioDataFromOccurrence(e)),s?s.getEntitiesForFeature(t,i):null}getFeatureIdsRelatedToBody(e,t){const i=e?this.getPartStudioDataFromOccurrence(e):this.getDisplayedPartStudio();if(!i)return[];const s=new Set,n=i.getEntitiesForBody(t);for(let t=0;t<n.length;++t){const r=i.retrieveEntityMetaData(n[t]);if(r){const e=r.getFeatureIds();for(let t=0;t<e.length;++t)s.add(e[t])}for(const i of this.retrieveAssociatedFeatureIds(e,n[t]))s.add(i)}for(const i of this.retrieveAssociatedFeatureIds(e,t))s.add(i);return[...s]}getBodyIdsRelatedToFeature(e,t){const i=e?this.getPartStudioDataFromOccurrence(e):this.getDisplayedPartStudio();if(!i)return[];const s=i.getEntitiesForFeature(t),n=new Set;for(let e=0;e<s.length;++e){const t=i.retrieveEntityMetaData(s[e]);t&&n.add(t.getBodyId())}return[...n]}getEntitiesForBody(e,t){const i=this.getPartStudioDataFromOccurrence(e);return i?i.getEntitiesForBody(t):null}getIncrementsForFeature(e,t){const i=this,s=[],n=i.getEntitiesForFeature(e,t);return n&&n.forEach((function(t){const n=i.extractMeshIncrement(t,e);n&&s.push(n)})),s}extractMeshIncrement(e,t){if(e?.startsWith(k.FBt.SECTION_IDENTIFIER)){const t=(0,LS.Ky)();return t?.extractMeshIncrement(e)??null}let i=this.getDisplayedPartStudio();return t&&(i=this.getPartStudioDataFromOccurrence(t)),i?i.extractMeshIncrement(e):null}isEntityOnOccurrence(e,t){const i=this.getOccurrenceDisplayData(t);if(!i)return!1;const s=this.retrieveEntityMetaData(t,e);return!!s&&(this.occurrenceContainsBody(i,s.getBodyId())||i.containsPart(e))}occurrenceContainsBody(e,t){if(e.containsPart(t))return!0;const i=this.partStudios[e.fullElementId.toString()];if(!i)return!1;if(i.getSketchComponent().hasBody(t)){if(e.sketchFeatureId)return i.getSketchComponent().doesSketchContainBody(e.sketchFeatureId,t);{const s=i.getEntitiesForBody(t);for(let t=0;t<s.length;++t)if(e.containsPart(s[t]))return!0}}const s=i.retrieveBodyMetaData(t);if(!s)return!1;if(s.isClosedCompositeConstituent&&e.containsPart(s.consumingClosedCompositeData.id))return!0;if(s.referencingOpenCompositeData)for(const[t,i]of s.referencingOpenCompositeData)if(e.containsPart(t))return!0;return!1}isNodeForModel(e){return e.getId()===rI||!!e.getParent()&&this.isNodeForModel(e.getParent())}isNodeForSketch(e){return e.getId()===Op}isNodeForBody(e,t){return 0===e.getId().indexOf(jg)||!!t&&(this.simulationManager?.isNodeForBodyVisualization(e)||this.thicknessAnalysisManager?.isNodeForBodyVisualization(e)||this.viewer.getCurvatureAnalysisManager()?.isNodeForBodyVisualization(e))}isNodeForFaces(e){return e.isFaces()}isNodeForEdges(e){return e.isEdges()}isNodeForPoints(e){return e.isPoints()}handleAllSelectionListHighlights(){const e=this.viewer.getFilteredEntitiesHighlightController()?.getSelectionList();!this.selectionListNameToListAndHighlightType.get(LM.SELECTION_LIST_NAME)&&e&&this.handleSelectionListHighlights(LM.SELECTION_LIST_NAME,e,dn.o2.FILTERED_ENTITIES),this.viewer.getIsForPreviousVersionDisplay()||(this.handleSelectionListHighlights("selectionList",(0,Ce.vi)()),this.handleSelectionListHighlights("preselectionList",(0,Ce.Wf)(),dn.o2.PRE),this.handleSelectionListHighlights("secondarySelectionList",(0,Ce.wT)(),dn.o2.SECONDARY),this.handleSelectionListHighlights("secondaryPreSelectionList",(0,Ce.Dk)(),dn.o2.SECONDARY_PRE),this.handleSelectionListHighlights("smartSelectionList",(0,Ce.PV)(),dn.o2.SMART_SELECTION),this.handleSelectionListHighlights("accumulatedSmartSelections",(0,Ce.Tb)(),dn.o2.ACCUMULATED_SMART_SELECTION),this.handleSelectionListHighlights("commentSelectionList",(0,Ce.d7)(),dn.o2.COMMENT),this.handleSelectionListHighlights("errorSelectionList",(0,Ce.yb)(),dn.o2.ERROR),this.handleSelectionListHighlights("profileInspectorSelectionList",(0,Ce.CY)(),dn.o2.PROFILE_INSPECTOR),this.handleSelectionListHighlights("profileInspectorFocusSelectionList",(0,Ce.QQ)(),dn.o2.PROFILE_INSPECTOR_FOCUS),this.handleSelectionListHighlights("retrievalSelectionList",(0,Ce.iH)(),dn.o2.RETRIEVAL))}resetSelectionListHandlers(){for(const e of this.selectionListNameToListAndHighlightType.values())this.stopListening(e.selectionList);this.selectionListNameToListAndHighlightType.clear(),this.handleAllSelectionListHighlights(),this.meshPointController&&this.meshPointController.resetSelectionListHandlers()}handleSelectionListHighlights(e,t,i){this.selectionListNameToListAndHighlightType.get(e)&&(ut.log.warn(`Attempt to add selectionList with duplicate name ${Ce.o$} to handle selections for. Removing the old one before adding the new one.`),this.removeSelectionListHandler(e)),this.selectionListNameToListAndHighlightType.set(e,{selectionList:t,highlightType:i});const s=this;this.selectionsToClearOnReset[e]={},this.listenTo(t,"add",(function(t){s.processSelectionHighlight(dn.aU.ADD,t,e,i)})),this.listenTo(t,"remove",(function(t){s.processSelectionHighlight(dn.aU.REMOVE,t,e,i)})),this.listenTo(t,"reset",(function(t){s.resetSelectionListHighlights(t,e,i)})),t.each((function(t){s.processSelectionHighlight(dn.aU.ADD,t,e,i)}))}removeSelectionListHandler(e){const t=this.selectionListNameToListAndHighlightType.get(e);t&&(this.clearSelectionHighlight(e,t.highlightType),this.stopListening(t.selectionList),this.selectionListNameToListAndHighlightType.delete(e)),delete this.selectionsToClearOnReset[e]}resetSelectionListHighlights(e,t,i){this.clearSelectionHighlight(t,i),e.each((e=>{this.processSelectionHighlight(dn.aU.ADD,e,t,i)}))}updateOrVerifySelections(e,t){if(!this.viewer.getIsPrimaryViewer())return;const i=this;(0,Ce._g)().forEach((function(s){i.updateOrVerifySelectionsInList(e,t,s)}))}updateOrVerifySelectionsInList(e,t,i){const s=[];let n=!1,r=!0;const a=this,o={},h=(0,Ce.VT)(),c=!h||!h.getReceivesComputedData();return i.each((function(i){let h=i;if(h.getUsage()!==a.usage)return;e&&(h=e.updateSelection(h,t),h=h||i);let l=!c&&!!h;if(h&&c)switch(h.getType()){case k.lQt.ENTITY:l=a.hasEntity(h.getOccurrence(),h.getIdString())||h.isSectionEntity();break;case k.lQt.FEATURE:case k.lQt.FOLDER:case k.lQt.ROLLBACKBAR:l=!0;break;case k.lQt.BODY:l=a.hasBody(h.getOccurrence(),h.getIdString());break;case k.lQt.MATE_CONNECTOR:case k.lQt.OCCURRENCE:case k.lQt.MATE:case k.lQt.NON_GEOMETRIC_ITEM:case k.lQt.SIMULATION_LOAD:case k.lQt.EDGE_POINT:case k.lQt.MESH_POINT:case k.lQt.TABLE_ITEM:l=!0}l?(n=n||h.getIdString()!==i.getIdString(),o.hasOwnProperty(h.id)?(s[o[h.id]]=h,n=!0):(o[h.id]=s.length,s.push(h))):(n=!0,r=r&&i.isInContextSubFeature())})),n&&i.reset(s,{suppressServerCalls:r,isForRemapping:!0}),n}clearHighlights(){for(const[e,t]of this.selectionListNameToListAndHighlightType.entries())this.clearSelectionHighlight(e,t.highlightType)}refreshHighlight(){const e=this,t=function(t,i,s){i.each((function(n){n.isMeshPoint()&&n.getMeshPointData()?e.meshPointController.addSelection(n,i):e.processSelectionHighlight(dn.aU.ADD,n,t,s)}))};for(const[e,i]of this.selectionListNameToListAndHighlightType.entries())t(e,i.selectionList,i.highlightType)}handlesHighlightForSelection(e,t){if(e.getUsage()!==this.usage)return!1;if(t===dn.o2.PRE&&e.source===Ce.Hw.PICK&&eh.getNumber("INHIBIT_PREHIGHLIGHT"))return!1;switch(e.getType()){case k.lQt.ENTITY:case k.lQt.FEATURE:case k.lQt.BODY:case k.lQt.OCCURRENCE:case k.lQt.MATE:case k.lQt.MATE_CONNECTOR:case k.lQt.EDGE_POINT:case k.lQt.TABLE_ITEM:case k.lQt.SKETCH_GROUP:case k.lQt.NON_GEOMETRIC_ITEM:case k.lQt.PROPERTY:case k.lQt.SIMULATION_LOAD:case k.lQt.FOLDER:case k.lQt.ANNOTATION:case k.lQt.DIMENSION:return!0}return!1}getHighlightTypeForSelection(e,t){if(t===dn.o2.PRE&&(e.isOccurrence()||e.isFolder()))return dn.o2.OCCURRENCE_PRE;if(t===dn.o2.SECONDARY_PRE&&e.isOccurrence())return dn.o2.OCCURRENCE_SECONDARY_PRE;if(t===dn.o2.COMMENT&&e.isOccurrence())return dn.o2.OCCURRENCE_COMMENT;if(t)return t;switch(e.getType()){case k.lQt.ENTITY:return dn.o2.ENTITY;case k.lQt.FEATURE:case k.lQt.SKETCH_GROUP:return dn.o2.FEATURE;case k.lQt.BODY:return dn.o2.PART;case k.lQt.FOLDER:case k.lQt.OCCURRENCE:case k.lQt.NON_GEOMETRIC_ITEM:return dn.o2.OCCURRENCE;case k.lQt.TABLE_ITEM:if(e.getOccurrence())return dn.o2.OCCURRENCE}return dn.o2.UI}processSelectionHighlight(e,t,i,s,n,r){if(!t||!this.handlesHighlightForSelection(t,s))return;const a=this.getDisplayedElement();if(!a)return;const o=!s||s===dn.o2.PRE;s=this.getHighlightTypeForSelection(t,s);let h=!1;if(t.isFromBody()&&(t.isBody()||t.isFace())){let e;e=t.isBody()?t.getBodyMetaData():t.getEntityMetaData().getBodyMetaData(),e&&(!e.isModifiableBody()||Ns()&&t.isBody())&&(h=!0)}const c=this.viewer.getHighlightManager(this.usage),l=c.createHighlightForSelection(s,t.getIdForCollection(),h),u=this.getEntityIdsForSelection(t),d=a.getInContextImportEntityIdsForSelection(t),g=s===dn.o2.PRE?dn.o2.INCONTEXT_REFERENCE_PRE:dn.o2.INCONTEXT_REFERENCE,p=n?[]:a.getOccurrencesForSelection(t);let m=!t.isEntity()||t.isFromConstructionGeometry()||this.addDerivedEntityHighlights;s!==dn.o2.COMMENT||t.isPlane()||(m=!1);let f=[];if(r||!m&&e===dn.aU.ADD||(f=this.viewer.getEdgePointController()&&t.isEdgePoint()?this.viewer.getEdgePointController().getUIElementsForSelection(t):t.getOccurrence()&&this.getDisplayedInContextAssembly()?this.getDisplayedInContextAssembly().getUIElementsForSelection(t):a.getUIElementsForSelection(t)),this.processUiHighlights(e,f,t,i,l),t.isMateConnector()||t.isMate()||t.isMateRelation()||t.isExplodeStep()||t.isNonGeometricItem()||t.isSimulationLoad())this.processSecondaryAssemblyFeatureHighlights(e,p,t,i,s);else if(u&&u.length>0&&this.processEntitiesHighlight(e,t.getOccurrence(),u,l),d&&d.length>0&&o&&this.processEntitiesHighlight(e,t.getOccurrence(),d,c.createHighlightForSelection(this.getHighlightTypeForSelection(t,g),t.getIdForCollection())),p&&p.length>0&&m){const n=t.isBody()&&!!t.getOccurrence();let r=l;(t.isEntity()||n||t.isFeature())&&(e===dn.aU.ADD&&(this.selectionsToClearOnReset[i][t.getIdForCollection()]=t),r=s===dn.o2.FEATURE?c.createSecondaryHighlight(dn.o2.OCCURRENCE,dn.o2.OCCURRENCE,t.getIdForCollection()):c.createSecondaryHighlight(s===dn.o2.PRE?dn.o2.ASSOCIATED_OCCURRENCE_PRE:dn.o2.ASSOCIATED_OCCURRENCE,s,t.getIdForCollection()));for(let t=0;t<p.length;++t)this.processOccurrenceHighlight(e,p[t],r);r.associatedPrimaryHighlightType&&e===dn.aU.REMOVE&&c.freeSecondaryHighlight(r.type,r.associatedPrimaryHighlightType,t.getIdForCollection())}e===dn.aU.REMOVE&&(c.freeHighlightForSelection(s,t.getIdForCollection()),o&&c.freeHighlightForSelection(g,t.getIdForCollection())),this.viewer.requestDraw()}processUiHighlights(e,t,i,s,n){if(!t||t.length<=0)return;let r=!0;for(let i=0;i<t.length;++i)e===dn.aU.ADD?t[i].addHighlight(n):r=r&&t[i].removeHighlight(n);e===dn.aU.ADD?this.selectionsToClearOnReset[s][i.getIdForCollection()]=i:r&&delete this.selectionsToClearOnReset[s][i.getIdForCollection()]}processSecondaryAssemblyFeatureHighlights(e,t,i,s,n){const r=this.getDisplayedElement();if(!r)return;const a=i.getIdForCollection()+un.ID_SEPARATOR+n,o=this.viewer.getHighlightManager(this.usage);let h,c;c=i.isMateConnector()||i.isMate()&&i.featureType!==ui.T.MATE_GROUP?o.createSecondaryHighlight(dn.o2.RELATED_OCCURRENCE_MATE,n,i.getIdForCollection()):o.createSecondaryHighlight(dn.o2.RELATED_OCCURRENCE,n,i.getIdForCollection());const l=n===dn.o2.UI?dn.o2.UI_RELATED_ENTITY:n;if(e===dn.aU.ADD){const e=this.secondaryOccurrenceHighlights[a];if(e&&e.length>0){for(h=0;h<e.length;++h)this.processOccurrenceHighlight(dn.aU.REMOVE,e[h],c);delete this.secondaryOccurrenceHighlights[a]}this.secondaryOccurrenceHighlights[a]=t}else t=this.secondaryOccurrenceHighlights[a],delete this.secondaryOccurrenceHighlights[a];for(h=0;t&&h<t.length;++h)this.processOccurrenceHighlight(e,t[h],c);if(this.displayingAssembly()){let t;if(this.secondaryEntityHighlights.hasOwnProperty(a))for(t=this.secondaryEntityHighlights[a],delete this.secondaryEntityHighlights[a],h=0;t&&h<t.length;++h)if(!this.updateSecondaryEntityHighlightRepeatCount(t[h],s,n,!1)){const e=!t[h].isAssemblyOrigin(),i=!t[h].isAssemblyOrigin();this.processSelectionHighlight(dn.aU.REMOVE,t[h],s,l,e,i)}if(e===dn.aU.ADD)for(t=r.getEntitiesForNonInstanceSelection(i),this.secondaryEntityHighlights[a]=t,h=0;t&&h<t.length;++h){this.updateSecondaryEntityHighlightRepeatCount(t[h],s,n,!0)||ut.log.warn("Adding highlight should always result in an existing entity highlight");const i=!t[h].isAssemblyOrigin(),r=!t[h].isAssemblyOrigin();this.processSelectionHighlight(e,t[h],s,l,i,r)}}e===dn.aU.ADD?this.selectionsToClearOnReset[s][i.getIdForCollection()]=i:o.freeSecondaryHighlight(dn.o2.RELATED_OCCURRENCE,n,i.getIdForCollection())}updateSecondaryEntityHighlightRepeatCount(e,t,i,s){const n=e.id+t+i.toString();let r=this.secondaryEntityHighlightSelectionRepeats[n];return r||(r=0),s?r++:r--,r>0?(this.secondaryEntityHighlightSelectionRepeats[n]=r,!0):(delete this.secondaryEntityHighlightSelectionRepeats[n],!1)}clearHighlight(e,t,i){const s=this.viewer.getReferenceHighlights().highlights[e];this.occurrenceDataManager.clearHighlight(s,this.usage),this.clearIndividualHighlights(s,t,i),this.viewer.getHighlightManager(this.usage).resetHighlightInstanceIds(e),e===dn.o2.PRE?(this.clearHighlight(dn.o2.OCCURRENCE_PRE,t,i),this.clearHighlight(dn.o2.ASSOCIATED_OCCURRENCE_PRE,t,i),this.clearHighlight(dn.o2.INCONTEXT_REFERENCE_PRE,t,!0)):e===dn.o2.SECONDARY_PRE?this.clearHighlight(dn.o2.OCCURRENCE_SECONDARY_PRE,t,i):e===dn.o2.COMMENT&&this.clearHighlight(dn.o2.OCCURRENCE_COMMENT,t,i),this.viewer.requestDraw()}clearSelectionHighlight(e,t){t?this.clearHighlight(t,e,!0):(this.clearHighlight(dn.o2.ENTITY,e,!1),this.clearHighlight(dn.o2.FEATURE,e,!1),this.clearHighlight(dn.o2.PART,e,!1),this.clearHighlight(dn.o2.OCCURRENCE,e,!1),this.clearHighlight(dn.o2.UI,e,!0),this.clearHighlight(dn.o2.INCONTEXT_REFERENCE,e,!0))}clearIndividualHighlights(e,t,i){const s=this.selectionsToClearOnReset[t];if(!s)return;const n=Object.keys(s);for(let i=0;i<n.length;++i)this.processSelectionHighlight(dn.aU.REMOVE,s[n[i]],t,e.type);i&&(this.selectionsToClearOnReset[t]={})}getOccurrencesStartingWithPath(e){const t=this.assemblies[this.displayedElementId];return t?t.getLeafOccurrencesContainedWithinOccurrence(e):[]}getOccurrenceBounds(e){const t=this.assemblies[this.displayedElementId];return t?(this.getSceneGraph().updateBounds(),t.getOccurrenceBounds(e)):null}setPlaneName(e,t,i){const s=this.getDisplayedPartStudio();s&&s.getElementId()===e&&(s.setPlaneName(t,i),ws()||this.applyToPreview(this.setPlaneName,arguments))}setAddDerivedEntityHighlights(e){this.addDerivedEntityHighlights!==e&&(this.clearHighlights(),this.addDerivedEntityHighlights=e,this.refreshHighlight())}getAddDerivedEntityHighlights(){return this.addDerivedEntityHighlights}isActiveElementEditingInContext(){const e=this.partStudios[this.getDisplayedFullElementId()];return!!e&&e.isDisplayingIncontextAssembly()}isDisplayingIncontextAssembly(){const e=this.getDisplayedPartStudio();return!!e&&e.isDisplayingIncontextAssembly()}isolateAllPartStudioBodies(){const e=this.getDisplayedPartStudio();if(!e)return;const t=e.getPartStudioOccurrenceIds(),i=this.viewer.getIsolatedOccurrenceManager();this.isBase()?i?.setIsolatedOccurrenceIds(t):i?.addIdsToIsolate(t);const s=e.getAllMateConnectorGraphics(null).map((e=>e.getOccurrenceData().getOccurrenceId()));i?.addIdsToIsolate(s),Ye(1),this.viewer.requestDraw()}clearIsolatedBodies(){this.viewer.getIsolatedOccurrenceManager()?.clearAllIsolateNoAnimation()}switchIsolateActiveElement(e){this.viewer.getIsolatedOccurrenceManager()?.switchActiveElement(e)}getModelStatistics(e,t=!1){const i={faces:0,triangles:0,edges:0,lines:0,vertices:0,silhouettes:0,settingCounts:{},uniqueParts:0,uniqueSurfaces:0,uniqueCurves:0,uniqueOpenComposites:0,uniqueClosedComposites:0,partOccurrences:0,surfaceOccurrences:0,curveOccurrences:0,openCompositeOccurrences:0,openCompositeConstituentOccurrences:0,closedCompositeOccurrences:0,closedCompositeConstituentOccurrences:0,bodiesPendingRetrieval:0,errors:[],veryFineParts:new Array,veryFineOccurrences:new Array};let s;for(s in this.partStudios){const n=this.partStudios[s].getStatistics(e,t);i.faces+=n.faces,i.triangles+=n.triangles,i.edges+=n.edges,i.lines+=n.lines,i.vertices+=n.vertices,i.silhouettes+=n.silhouettes,i.uniqueParts+=n.uniqueParts,i.uniqueSurfaces+=n.uniqueSurfaces,i.uniqueCurves+=n.uniqueCurves,i.uniqueOpenComposites+=n.uniqueOpenComposites,i.uniqueClosedComposites+=n.uniqueClosedComposites,i.partOccurrences+=n.partOccurrences,i.surfaceOccurrences+=n.surfaceOccurrences,i.curveOccurrences+=n.curveOccurrences,i.openCompositeOccurrences+=n.openCompositeOccurrences,i.openCompositeConstituentOccurrences+=n.openCompositeConstituentOccurrences,i.closedCompositeOccurrences+=n.closedCompositeOccurrences,i.closedCompositeConstituentOccurrences+=n.closedCompositeConstituentOccurrences,i.bodiesPendingRetrieval+=n.bodiesPendingRetrieval;for(const e in n.settingCounts){const t=i.settingCounts[e]||0;i.settingCounts[+e]=t+n.settingCounts[+e]}t&&(n.veryFineOccurrences.length&&(i.veryFineOccurrences=[...i.veryFineOccurrences,...n.veryFineOccurrences]),n.veryFineParts.size&&i.veryFineParts.push(n.veryFineParts)),n.errorMessage&&i.errors.push(n.errorMessage)}return i}removeSelectionHighlights(){const e=this;(0,Ce.vi)().each((function(t){e.processSelectionHighlight(dn.aU.REMOVE,t,"selectionList")}))}reAddSelectionHighlights(){const e=this;(0,Ce.vi)().each((function(t){e.processSelectionHighlight(dn.aU.ADD,t,"selectionList")}))}hideAssembly(e){const t=this.assemblies[e];t&&t.hide()}showAssembly(e,t){const i=this.assemblies[e];i&&i.show(t)}getInstantiatedTriangleCount(){let e=0;for(const t in this.partStudios)e+=this.partStudios[t].getInstantiatedTriangleCount();return e}showPartsWithSheetmetalModelIdOnly(e){const t=this.getDisplayedPartStudio();if(t&&(e||this.selectedSheetmetalModelId)&&(t.getBodyComponent(null).showPartsWithSheetmetalModelIdOnly(e),t.getSketchComponent().showPartsWithSheetmetalModelIdOnly(e),t.getImageComponent().showPartsWithSheetmetalModelIdOnly(e),t.getDimensionComponent().showDimensionsWithSheetmetalModelIdOnly(e,t)),this.selectedSheetmetalModelId!==e){this.selectedSheetmetalModelId=e;for(const[e,t]of this.selectionListNameToListAndHighlightType.entries())this.resetSelectionListHighlights(t.selectionList,e,t.highlightType);this.fitToSelectedSheetMetalModel(),this.viewer.getEventDispatcher().trigger(yD.Hq,e),this.viewer.requestDraw()}}fitToSelectedSheetMetalModel(){this.lastFitSheetMetalModelId===this.selectedSheetmetalModelId||this.viewer.isHidden()||!this.viewer.getPrimaryViewController()||(this.viewer.getPrimaryViewController().setStandardView(this.viewer.getDefaultStandardView()),this.viewer.setViewInitialized(!1),this.viewer.requestDraw(),this.lastFitSheetMetalModelId=this.selectedSheetmetalModelId)}hasSelectedSheetmetalModelId(){return!!this.selectedSheetmetalModelId}getSelectedSheetmetalModelId(){return this.selectedSheetmetalModelId}isBodyEntityMeasurable(e,t){const i=this.getDisplayedPartStudio();return!!i&&i.getBodyComponent(null).isEntityMeasurable(e,t)}needsDisplayData(e){let t=!1;for(const i in this.partStudios)e.elementId===this.partStudios[i].id&&(t=t||this.partStudios[i].getBodyComponent(null).needsDisplayData(e));return t}getOccurrenceSketchFeatureId(e){const t=this.getPartStudioDataFromOccurrence(e),i=this.viewer.getOccurrenceIdManager().getIdForName(e.getPathAsString());return t&&i!==Jf.Qy?t.getSketchComponent().getFeatureIdForOccurrence(i):null}getDescriptionOfLastProcessedPartStudio(){return this.lastPartStudioProcessed+" : "+this.lastPartStudioMicroversionIdAndConfigurationIntervalProcessed[this.lastPartStudioProcessed]}isOccurrenceIdForInContext(e){const t=this.getDisplayedPartStudio();if(t){const i=this.assemblies[t.getVisibleInContextAssemblyId()];if(i){const t=this.viewer.getOccurrenceIdManager().getNameForId(e);return!!i.getDisplayDataForOccurrencePath(t)}}return!1}hideEntityFromPick(e,t,i){const s=this.getPartStudioDataFromOccurrence(i);if(s){const i=this.viewer.getOccurrenceDataManager().getOccurrenceData(t);if(i){const t=s.getMeshManager().getIncrementDetails(e,s.getMeshOwnerId());t&&i.hideIncrementFromPick(t,this.usage)}}}hideBodyFromPick(e,t,i){const s=this.getPartStudioDataFromOccurrence(i);if(s){const i=this.viewer.getOccurrenceDataManager().getOccurrenceData(t);if(i){const t=s.getEntitiesForBody(e);for(let e=0;t&&e<t.length;++e){const n=s.getMeshManager().getIncrementDetails(t[e],s.getMeshOwnerId());n&&i.hideIncrementFromPick(n,this.usage)}}}}setDebugFaceTriangles(e){Object.values(this.partStudios).forEach((function(t){t.getBodyComponent().setDebugFaceTriangles(e)})),this.simulationManager&&this.simulationManager.setDebugMeshEdges(e)}clearSubFeaturesShownByParameters(){this.subFeaturesShownByParameters={}}getSubFeaturesShownByParameters(){return this.subFeaturesShownByParameters}collectComponentsForHeapDump(e){for(const t in this.partStudios)this.partStudios[t].collectComponentsForHeapDump(e);qf()}setExplodeViewActive(e){const t=this.getDisplayedAssembly();t&&t.setExplodeViewActive(e)}onStartEditingAssemblyFeature(e){const t=this.getDisplayedAssembly();t&&t.setEditState(e,!0)}onStopEditingAssemblyFeature(e){const t=this.getDisplayedAssembly();t&&t.setEditState(e,!1)}refreshSmoothEdgesForAllPartStudios(e){for(const t in this.partStudios){const i=this.partStudios[t],s=i.getBodyComponent();if(s){const t=this.viewer.getSmoothEdgesRenderStyle();if(!e){t===k.YUG.VISIBLE&&i.setIsMissingTangencyInformationMessageShown(!1);const e=this.getDisplayedPartStudio()===i;if(this.viewer.getSmoothEdgesRenderStyle()!==k.YUG.VISIBLE&&s.hasDisplayedEdgesWithOutdatedSmoothnessInfo()){if(!e)return this.viewer.showTangencyInformationMissingMessage(),i.setIsMissingTangencyInformationMessageShown(!0),!1;this.updateSmoothEdgesForDisplayedPartStudio()}}}}return!0}updateSmoothEdgesForDisplayedPartStudio(){this.viewer.getIsForFlattenedDisplay()||(this.isBase()?ut.log.debug("Triggered smooth edge update from base viewer"):ut.log.debug("Triggered smooth edge update from preview"),this.viewer.getEventDispatcher().trigger(yD.Uj))}processSmoothEdgeUpdate(e){for(let t=0;t<e.tangencyReponses.length;++t){const i=e.tangencyReponses[t],s=this.getPartStudio(i.source);s?s.getBodyComponent().updateEdgeSmoothness(i.edgeDeterministicIDToIsSmoothMap):ut.log.warn("Part Studio not found when applying smooth edge response")}this.refreshSmoothEdgesForAllPartStudios(!0),this.viewer.requestDraw()}onAppearanceConstantsUpdated(){for(const e of Object.values(this.partStudios))e.onAppearanceConstantsUpdated();for(const e of Object.values(this.temporarySketchComponents))e.onAppearanceConstantsUpdated()}onRenderingModeChanged(){for(const e of Object.values(this.partStudios))e.onRenderingModeChanged()}getDisplayedElementMicroversionIdAndConfiguration(){return this.displayedElementMicroversionIdAndConfiguration}}class ih{constructor(e,t){this.occurrenceDataManager=e,this.viewer=t,this.modelViewManagers={},this.lastPreviewedPartStudioId=null,(0,Jo.Yk)(t),this.viewer.getEventDispatcher().on(yD.so,(()=>{this.clearTheManagers()}))}getManager(){const e=fs.L.BASE;let t=this.modelViewManagers[e];return t||(t=new th(e,this.occurrenceDataManager,this.viewer),this.modelViewManagers[e]=t),t}clearTheManagers(){Object.values(this.modelViewManagers).forEach((function(e){e&&e.onDeletion()})),this.modelViewManagers={}}getManagerForUsage(e){return e===fs.L.BASE?this.getManager():e===fs.L.PREVIEW?this.getPreviewManager():null}getPreviewManager(e){const t=this.getManager().bodyLoadTasks,i=e?e.buildFullElementId(!0):null;if(!i||this.modelViewManagers[fs.L.PREVIEW]&&i.elementId===this.lastPreviewedPartStudioId){const e=this.modelViewManagers[fs.L.PREVIEW];return e&&t&&t.completeTasks(),e}{t&&t.completeTasks(),this.resetPreviewManager();const e=this.getManager().cloneForPreview(i);return this.modelViewManagers[fs.L.PREVIEW]=e,this.lastPreviewedPartStudioId=i.elementId,e}}previewManagerExists(){return null!==this.lastPreviewedPartStudioId&&!!this.modelViewManagers[fs.L.PREVIEW]}resetPreviewManager(){this.viewer.getUiResourceManager().destroyPreviewGraphics(),this.viewer.getSceneGraphs().getPreviewSceneGraph().removeEverything(),this.modelViewManagers[fs.L.PREVIEW]&&this.modelViewManagers[fs.L.PREVIEW].onDeletion(),this.modelViewManagers[fs.L.PREVIEW]=null,this.lastPreviewedPartStudioId=null,this.getManager().onPreviewDestroyed(),this.viewer.getOccurrenceDataManager().onPreviewDestroyed(),this.viewer.getCurvatureAnalysisManager()?.onPreviewDestroyed()}onAppearanceConstantsUpdated(){for(const e of Object.values(this.modelViewManagers))e?.onAppearanceConstantsUpdated()}onRenderingModeChanged(){for(const e of Object.values(this.modelViewManagers))e?.onRenderingModeChanged()}}var sh=i(60939);class nh{constructor(){this.viewport=y.fromValues(0,0,4,4),this.tileViewport=null,this.viewportDiagonal=0,this.canvasHeight=0,this.canvasWidth=0,this.sceneBounds=null,this.PROJECT_VEC_4=y.create(),this.TEMP_VEC4_0=y.create(),this.TEMP_VEC4_1=y.create(),this.TEMP_VEC4_2=y.create(),this.TEMP_VEC3_0=C.create(),this.TEMP_VEC3_1=C.create(),this.updateViewportDiagonal(),this.viewMatrix=de.create(),this.viewMatrixInverse=de.create(),this.projectionMatrix=de.create(),this.projectionMatrixInverse=de.create(),this.viewFrustum=new tr(this.viewMatrix,this.projectionMatrix)}integrityCheck(e){this.checkProperty("viewport",e),this.checkProperty("viewportDiagonal",e),this.checkProperty("canvasHeight",e),this.checkProperty("canvasWidth",e),this.checkProperty("viewMatrix",e),this.checkProperty("viewMatrixInverse",e),this.checkProperty("projectionMatrix",e),this.checkProperty("projectionMatrixInverse",e),this.checkProperty("eye",e),this.checkProperty("up",e),this.checkProperty("direction",e),this.checkProperty("near",e),this.checkProperty("far",e)}checkProperty(e,t){const i=this[e];(0,yi.xV)(i)||ut.log.warn(e+" was found to be non-finite in "+t+": "+i)}getViewFrustum(){return this.viewFrustum}toString(){return JSON.stringify(this,null,2)}isPerspective(){return!1}isOrthographic(){return!1}setViewportFromCanvasElement(e){const t=parseInt(e.attr("width")||""),i=parseInt(e.attr("height")||"");this.setViewport([0,0,t,i]),this.setCanvasDimensions(t,i)}setCanvasDimensions(e,t){this.canvasWidth=e,this.canvasHeight=t}updateViewportDiagonal(){this.viewportDiagonal=ge.gv.length([this.viewport[2],this.viewport[3]])}setViewport(e){this.viewport=e,this.updateViewportDiagonal(),this.updateMatrices()}getViewport(e){return this.tileViewport&&!e?y.fromValues(0,0,this.tileViewport[2],this.tileViewport[3]):this.viewport}getTileViewport(){return this.tileViewport}getViewportDiagonal(){return this.viewportDiagonal}getEye(){return this.eye}getFrame(){const e=de.create(),t=this.getRight();for(let i=0;i<3;i++)e[i]=t[i],e[i+4]=this.up[i],e[i+8]=-this.direction[i],e[i+12]=this.eye[i],e[4*i+3]=0;return e}setFrame(e){if(!e||16!==e.length)return void ut.log.error("An attempt was made to update the camera with an invalid frame");const t=C.fromValues(e[12],e[13],e[14]),i=C.fromValues(-e[8],-e[9],-e[10]),s=C.fromValues(e[4],e[5],e[6]);this.setViewPositionAndOrientation(t,i,s)}setViewPositionAndOrientation(e,t,i){this.eye=e,this.direction=t,this.up=i,this.updateMatrices(),this.integrityCheck("setViewPositionAndOrientation")}getDirection(){return this.direction}getFieldOfView(){return 0}setFieldOfView(e){}focalPoint(){return this.sceneBounds?this.sceneBounds.center():C.create()}distanceToCenter(){const e=this.focalPoint();return Math.abs(C.dot(this.direction,ge.S4.subtract(e,this.eye,C.create())))}setSceneBounds(e){e.isInitialized()&&!e.isInfinite()&&(this.sceneBounds=e,this.ensureCameraIsOutsideSceneBounds(),this.updateNearFar())}getSceneBounds(){return this.sceneBounds}getViewMatrix(){return de.clone(this.viewMatrix)}getViewMatrixInverse(){return de.clone(this.viewMatrixInverse)}setTileViewport(e){this.tileViewport=e}getProjectionMatrix(){return this.tileViewport?ge.w$.multiply((0,yi.vG)(this.tileViewport,this.viewport),this.projectionMatrix,de.create()):de.clone(this.projectionMatrix)}getMatrices(e,t){for(let i=0;i<16;++i)e[i]=this.viewMatrix[i],t[i]=this.projectionMatrix[i]}getProjectionMatrixInverse(){return de.clone(this.projectionMatrixInverse)}updateMatrixInverses(){let e=ge.w$.inverse(this.viewMatrix,this.viewMatrixInverse);e=ge.w$.inverse(this.projectionMatrix,this.projectionMatrixInverse)&&e,e||ut.log.warn("Error updating camera matrix inverses")}updateNearFar(e){if(!e&&this.sceneBounds&&(e=this.sceneBounds.getCorners()),!e||!e.length)return;let t,i=-1/0,s=1/0;const n=C.create();for(t=0;t<e.length;t++){const r=C.dot(ge.S4.subtract(e[t],this.eye,n),this.direction);i=Math.max(i,r),s=Math.min(s,r)}if(i>=s){let e=1;this.sceneBounds&&(e=this.sceneBounds.diameter());const t=.01,n=.1;this.near=Math.max(e*t,s-n*e),this.far=Math.max(e,i+n*e)}else ut.log.warn("Trying to initialize the camera with a bounds that has no extension in the view direction"),this.near=.001,this.far=2;this.updateMatrices()}setNearFar(e,t){e>=t&&ut.log.debug("Near set to a distance greater or equal to far"),this.near=e,this.far=t,this.updateMatrices()}zoom(e){}getNearDepth(){return this.near}getFarDepth(){return this.far}rotateAbout(e,t,i){i||(i=this.eye);const s=de.create();ge.w$.rotate(s,e,t),ge.w$.multiplyVec3(s,this.direction),ge.w$.multiplyVec3(s,this.up);const n=ge.S4.subtract(this.eye,i,C.create());ge.w$.multiplyVec3(s,n),ge.S4.add(i,n,this.eye),this.updateMatrices(),this.integrityCheck("rotateAbout")}pan(e){ge.S4.subtract(this.eye,e),this.updateMatrices(),this.integrityCheck("pan")}ensureCameraIsOutsideSceneBounds(){}getRight(){return ge.S4.normalize(ge.S4.cross(this.direction,this.up,C.create()))}getUp(){return this.up}getForward(){return this.direction}projectWorldPointToViewport(e){return e=y.fromValues(e[0],e[1],e[2],1),this.projectViewPoint(ge.w$.multiplyVec4(this.viewMatrix,e,y.create()))}projectWorldPointToCanvas(e){return this.viewportToCanvas(this.projectWorldPointToViewport(e))}viewportToCanvas(e){const t=C.create();t[0]=e[0]+this.getViewportLeft();const i=this.canvasHeight-(this.getViewportBottom()+this.getViewportHeight());return t[1]=i+(this.getViewportHeight()-e[1]),t[2]=e[2],t}viewNormalPlaneAtPoint(e){const t=this.getForward(),i=C.dot(t,e);return y.fromValues(t[0],t[1],t[2],-i)}projectViewPoint(e,t){t=t||C.create();const i=this.tileViewport?this.getProjectionMatrix():this.projectionMatrix,s=ge.w$.multiplyVec4(i,e,this.PROJECT_VEC_4);s[3]=1/s[3],s[0]*=s[3],s[1]*=s[3],s[2]*=s[3];const n=this.tileViewport?this.tileViewport:this.viewport,r=n[2],a=n[3];return t[0]=0+r*(s[0]+1)/2,t[1]=0+a*(s[1]+1)/2,t[2]=(s[2]+1)/2,t}viewPointToWorld(e){return e=y.fromValues(e[0],e[1],e[2],1),ge.w$.multiplyVec4(this.viewMatrixInverse,e,y.create())}getUnitSizeAtWorldPoint(e){const t=this.TEMP_VEC4_0;t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=1;const i=this.projectViewPoint(ge.w$.multiplyVec4(this.viewMatrix,t,this.TEMP_VEC4_1),this.TEMP_VEC3_0);t[0]+=this.up[0],t[1]+=this.up[1],t[2]+=this.up[2];const s=this.projectViewPoint(ge.w$.multiplyVec4(this.viewMatrix,t,this.TEMP_VEC4_2),this.TEMP_VEC3_1);return Math.abs(s[1]-i[1])}projectWorldDirectionToCanvas(e,t){const i=this.projectWorldPointToCanvas(e),s=ge.S4.add(e,t,this.TEMP_VEC3_0),n=this.projectWorldPointToCanvas(s);return ge.gv.subtract(n,i,Q.create())}getPixelSizeAtWorldPoint(e){return 1/this.getUnitSizeAtWorldPoint(e)}isCanvasPointInView(e){return e[0]>=0&&e[0]<this.getViewportWidth()&&e[1]>=0&&e[1]<this.getViewportHeight()}getRay(e,t){t=this.canvasHeight-t;const i=ge.S4.unproject([e+.5,t+.5,0],this.viewMatrix,this.projectionMatrix,this.viewport),s=ge.S4.unproject([e+.5,t+.5,1],this.viewMatrix,this.projectionMatrix,this.viewport);return new yi.zH(i,ge.S4.subtract(s,i,C.create()))}canvasToWorld(e){const t=C.fromValues(e[0],this.canvasHeight-e[1],e[2]);return ge.S4.unproject(t,this.viewMatrix,this.projectionMatrix,this.viewport,C.create())}getCanvasWidth(){return this.canvasWidth}getCanvasHeight(){return this.canvasHeight}getViewportWidth(){return this.viewport[2]}getViewportHeight(){return this.viewport[3]}getViewportLeft(){return this.viewport[0]}getViewportBottom(){return this.viewport[1]}getClosestNormalView(e,t){if(!e)return null;const i=C.fromValues(e[0],e[1],e[2]),s=C.fromValues(e[4],e[5],e[6]),n=this.getFrame(),r=C.fromValues(n[0],n[1],n[2]),a=C.fromValues(n[4],n[5],n[6]),o=C.fromValues(n[12],n[13],n[14]);let h,c;const l=C.dot(r,i),u=C.dot(r,s);if(Math.abs(l)>Math.abs(u)-Ci.W.ZERO_LENGTH){h=ge.S4.scale(i,l<0?-1:1,C.create());const e=C.dot(a,s);c=ge.S4.scale(s,e<0?-1:1,C.create())}else{h=ge.S4.scale(s,u<0?-1:1,C.create());const e=C.dot(a,i);c=ge.S4.scale(i,e<0?-1:1,C.create())}const d=ge.S4.cross(h,c,C.create()),g=o,p=de.create();for(let e=0;e<3;++e)p[0+e]=h[e],p[4+e]=c[e],p[8+e]=d[e],p[12+e]=g[e];if(t&&t.flipNormalIfIdentical&&(0,yi.cl)(n,p))for(let e=0;e<3;++e)p[0+e]=-h[e],p[8+e]=-d[e],p[12+e]=-g[e];return p}getCameraRotatedToView(e,t){const i=this.clone();i.setFrame(this.getClosestNormalView(e,{flipNormalIfIdentical:!0}));const s=this.projectWorldPointToCanvas(t),n=i.canvasToWorld(s);return i.pan(ge.S4.subtract(n,t)),i}getCameraRotatedToViewAndTranslated(e,t,i){const s=this.clone();s.setFrame(this.getClosestNormalView(e,{flipNormalIfIdentical:!0}));const n=this.projectWorldPointToCanvas(t),r=[i[0],i[1],n[2]],a=s.canvasToWorld(r);return s.pan(ge.S4.subtract(a,t)),s}canBoundsFitInViewport(e,t){if(!e||!e.isFinite())return!1;const i=new yi.tO,s=e.getCorners();for(let e=0;e<s.length;++e)i.addPoint(this.projectWorldPointToViewport(s[e]));const n=i.getDimensions();return n[0]<t[2]&&n[1]<t[3]}doBoundsFitInViewport(e,t,i){if(!e||!e.isFinite()||0===i)return!1;t=t||this.viewport;const s=i||1,n=new yi.tO,r=e.getCorners();for(let e=0;e<r.length;++e)n.addPoint(this.projectWorldPointToViewport(r[e]));const a=[t[2]*(s-1)/2,t[3]*(s-1)/2];return n.min[0]>-a[0]&&n.min[1]>-a[1]&&n.max[0]<t[2]+a[0]&&n.max[1]<t[3]+a[1]}canvasToModelPoint(e){const t=this.projectWorldPointToCanvas(C.fromValues(0,0,0));return this.canvasToWorld(C.fromValues(e[0],e[1],t[2]))}getUnitSizeAtWorldPointFast(e){return this.getUnitSizeAtWorldPoint(e)}}const rh=45;class ah extends nh{constructor(e){super(),this.MIN_SCALE=.05,this.MAX_SCALE=50,this.angle=rh,this.eye=C.fromValues(0,0,0),this.near=1,this.far=2,this.direction=C.fromValues(0,0,1),this.up=C.fromValues(0,1,0),Object.assign(this,ah.defaults(),e||{}),this.updateMatrices()}static defaults(){return{eye:[0,0,0],direction:[0,0,1],up:[0,1,0],angle:45,near:1,far:2}}integrityCheck(e){super.integrityCheck(e),this.checkProperty("angle",e)}equals(e){return e instanceof ah&&(this.angle===e.angle&&(0,yi.cl)(this.eye,e.eye)&&(0,yi.cl)(this.direction,e.direction)&&(0,yi.cl)(this.up,e.up))}isPerspective(){return!0}getFieldOfView(){return this.angle}setFieldOfView(e){this.angle=e,this.updateMatrices()}updateMatrices(){const e=ge.S4.add(this.direction,this.eye,C.create());ge.w$.lookAt(this.eye,e,this.up,this.viewMatrix),ge.w$.perspective(this.angle,this.viewport[2]/this.viewport[3],this.near,this.far,this.projectionMatrix),this.updateMatrixInverses(),this.viewFrustum.updateClippingPlanes(this.viewMatrix,this.projectionMatrix)}getDirectionToWorldPoint(e){return ge.S4.normalize(ge.S4.subtract(e,this.eye,C.create()))}getFrustum(){const e=Math.tan((0,yi.Yr)(.5*this.angle))*this.near,t=e*this.canvasWidth/this.canvasHeight;return[-t,t,-e,e,this.near,this.far]}copyTo(e){let t;for(t=0;t<3;++t)e.eye[t]=this.eye[t],e.direction[t]=this.direction[t],e.up[t]=this.up[t];for(e.angle=this.angle,e.near=this.near,e.far=this.far,e.sceneBounds=this.sceneBounds,e.setViewport(this.viewport),e.canvasWidth=this.canvasWidth,e.canvasHeight=this.canvasHeight,t=0;t<16;++t)e.viewMatrix[t]=this.viewMatrix[t],e.viewMatrixInverse[t]=this.viewMatrixInverse[t],e.projectionMatrix[t]=this.projectionMatrix[t]}copyFrom(e){e.isPerspective()?e.copyTo(this):e.getPerspectiveCamera().copyTo(this)}clone(){const e=new ah;return this.copyTo(e),e}getPerspectiveCamera(){return this.clone()}getOrthographicCamera(){const e=new oh;let t;for(t=0;t<3;++t)e.eye[t]=this.eye[t],e.direction[t]=this.direction[t],e.up[t]=this.up[t];e.setViewport(this.viewport),e.sceneBounds=this.sceneBounds,e.canvasWidth=this.canvasWidth,e.canvasHeight=this.canvasHeight,e.updateNearFar(),e.correctAspectRatio(),e.updateMatrices();const i=this.getSceneBounds()?.center(),s=this.getUnitSizeAtWorldPoint(i),n=e.getUnitSizeAtWorldPoint(i);return e.zoom(n/s),e}getFrame(){const e=de.create(),t=ge.S4.cross(this.direction,this.up,C.create()),i=this.up,s=this.direction;let n;for(n=0;n<3;n++)e[n]=t[n],e[n+4]=i[n],e[n+8]=-s[n],e[n+12]=this.eye[n],e[4*n+3]=0;return e}getMinDistance(){return this.sceneBounds?this.sceneBounds.diameter()*this.MIN_SCALE:this.MIN_SCALE}getMaxDistance(){return this.sceneBounds?this.sceneBounds.diameter()*this.MAX_SCALE:this.MAX_SCALE}dollyAlong(e,t){if(!this.sceneBounds)return;const i=this.getMinDistance(),s=this.getMaxDistance(),n=this.distanceToCenter(),r=C.dot(this.direction,t);let a=r*e;n<i?a=Math.min(a,0):n-a<i?a=Math.max(i-n,0):n-a>s&&(a=Math.min(n-s,0)),ge.S4.add(this.eye,ge.S4.scale(t,a/r,C.create())),this.updateMatrices(),this.integrityCheck("dollyAlong")}dolly(e){this.dollyAlong(e,this.direction)}zoom(e){const t=this.distanceToCenter();this.dolly(t-t*e)}getZoomToFitEyeAndPlanes(e,t,i){const s=ge.S4.cross(this.direction,this.up,C.create()),n=sh.fromValues(s[0],s[1],s[2],this.up[0],this.up[1],this.up[2],-this.direction[0],-this.direction[1],-this.direction[2]),r=ge.xB.transpose(n,sh.create()),a=[0,0,0];let o,h=0;if(e((function(e){ge.S4.add(a,e),h++})),h<=0)return null;ge.S4.scale(a,1/h);const c=[1/0,1/0,1/0],l=[-1/0,-1/0,-1/0],u=C.create(),d=C.create();e((function(e){for(ge.S4.subtract(e,a,u),ge.xB.multiplyVec3(r,u,d),o=0;o<3;o++)c[o]=Math.min(c[o],d[o]),l[o]=Math.max(l[o],d[o])}));const g=ge.S4.scale(ge.S4.add(l,c,C.create()),.5);ge.S4.subtract(l,g);const p=2*l[0]/(2*l[1]),m=t[2]/t[3];if(m<p&&(l[1]*=p/m),i)for(o=0;o<3;o++)l[o]*=i;const f=l[1]/Math.tan((0,yi.Yr)(.5*this.angle)),I=ge.xB.multiplyVec3(n,g,C.create()),E=ge.S4.add(a,I,C.create());return ge.S4.add(E,ge.S4.scale(this.direction,-(f+l[2]),C.create())),{eye:E,near:f,far:f+2*l[2]}}zoomToFit(e,t,i){let s;if(e instanceof Array)s=function(t){for(let i=0;i<e.length;i++)t(e[i])};else{if(!(e instanceof Function))return;s=e}const n=this.getZoomToFitEyeAndPlanes(s,this.viewport,t);if(n){if(this.eye=n.eye,this.near=n.near,this.far=n.far,i){const e=Math.tan((0,yi.Yr)(.5*this.angle))*this.near*2/i[3],t=(.5*this.viewport[2]-(i[0]+.5*i[2]))*e,s=(.5*this.viewport[3]-(i[1]+.5*i[3]))*e,n=ge.S4.cross(this.direction,this.up,C.create());ge.S4.add(this.eye,ge.S4.scale(n,t,C.create())),ge.S4.add(this.eye,ge.S4.scale(this.up,s,C.create()));const r=this.near*(this.viewport[2]/i[2]-1),a=this.near*(this.viewport[3]/i[3]-1),o=Math.max(r,a);ge.S4.subtract(this.eye,ge.S4.scale(this.direction,o,C.create())),this.near+=o,this.far+=o}this.updateMatrices(),this.integrityCheck("zoomToFit")}}}class oh extends nh{constructor(e){super(),this.DEFAULT_EXTENT_RATIO=.1,this.cachedWorldToPixelSize=-1,this.left=-1,this.right=1,this.top=1,this.bottom=-1,this.near=-1,this.far=1,this.eye=C.create(),this.direction=C.fromValues(0,0,-1),this.up=C.fromValues(0,1,0),Object.assign(this,oh.defaults(),e||{}),this.updateMatrices()}static defaults(){return{eye:[0,0,0],direction:[0,0,-1],up:[0,1,0],left:-1,right:1,top:1,bottom:-1,near:-1,far:1}}integrityCheck(e){super.integrityCheck(e),this.checkProperty("left",e),this.checkProperty("right",e),this.checkProperty("top",e),this.checkProperty("bottom",e)}equals(e){return e instanceof oh&&(Math.abs(this.left-e.left)<Ci.W.ZERO_LENGTH&&Math.abs(this.right-e.right)<Ci.W.ZERO_LENGTH&&Math.abs(this.top-e.top)<Ci.W.ZERO_LENGTH&&Math.abs(this.bottom-e.bottom)<Ci.W.ZERO_LENGTH&&(0,yi.cl)(this.eye,e.eye)&&(0,yi.cl)(this.direction,e.direction)&&(0,yi.cl)(this.up,e.up))}isOrthographic(){return!0}getUnitSizeAtWorldPointFast(e){return this.cachedWorldToPixelSize<0&&(this.cachedWorldToPixelSize=super.getUnitSizeAtWorldPoint(e)),this.cachedWorldToPixelSize}updateMatrices(){const e=ge.S4.add(this.direction,this.eye,C.create());ge.w$.lookAt(this.eye,e,this.up,this.viewMatrix),ge.w$.ortho(this.left,this.right,this.bottom,this.top,this.near,this.far,this.projectionMatrix),this.updateMatrixInverses(),this.viewFrustum.updateClippingPlanes(this.viewMatrix,this.projectionMatrix),this.cachedWorldToPixelSize=-1}copyTo(e){let t;for(t=0;t<3;++t)e.eye[t]=this.eye[t],e.direction[t]=this.direction[t],e.up[t]=this.up[t];for(e.left=this.left,e.right=this.right,e.top=this.top,e.bottom=this.bottom,e.near=this.near,e.far=this.far,e.sceneBounds=this.sceneBounds,e.setViewport(this.viewport),e.canvasWidth=this.canvasWidth,e.canvasHeight=this.canvasHeight,t=0;t<16;++t)e.viewMatrix[t]=this.viewMatrix[t],e.viewMatrixInverse[t]=this.viewMatrixInverse[t],e.projectionMatrix[t]=this.projectionMatrix[t]}copyFrom(e){e.isOrthographic()?e.copyTo(this):e.getOrthographicCamera().copyTo(this)}clone(){const e=new oh;return this.copyTo(e),e}getOrthographicCamera(){return this.clone()}getPerspectiveCamera(){const e=new ah;let t;for(t=0;t<3;++t)e.eye[t]=this.eye[t],e.direction[t]=this.direction[t],e.up[t]=this.up[t];e.setViewport(this.viewport),e.sceneBounds=this.sceneBounds,e.canvasWidth=this.canvasWidth,e.canvasHeight=this.canvasHeight,e.updateNearFar();const i=this.getSceneBounds()?.center();if(i){const t=this.getUnitSizeAtWorldPoint(i),s=e.getUnitSizeAtWorldPoint(i),n=e.distanceToCenter(),r=s/t*n;e.dolly(n-r),e.updateNearFar()}return e}getDirectionToWorldPoint(e){return this.direction}setViewport(e){this.viewport=e.slice(0),this.updateViewportDiagonal(),this.correctAspectRatio(),this.updateMatrices()}correctAspectRatio(){const e=this.right-this.left,t=this.top-this.bottom,i=this.getViewportWidth(),s=this.getViewportHeight();if(0===i||0===s)return;let n,r;i<s?(n=e<t?1:t/e,r=n*e*s/(t*i)):(r=e<t?e/t:1,n=r*t*i/(e*s)),this.left*=n,this.right*=n,this.top*=r,this.bottom*=r}zoom(e){const t=this.right-this.left,i=this.top-this.bottom;this.left=-t*e*.5,this.right=t*e*.5,this.top=i*e*.5,this.bottom=-i*e*.5,this.updateMatrices()}getExtents(){return[this.left,this.bottom,-this.far,this.right,this.top,-this.near]}setExtents(e){this.left=e[0],this.right=e[3],this.bottom=e[1],this.top=e[4],this.updateMatrices()}setExtentsByComponent(e,t,i,s){this.left=e,this.right=t,this.bottom=i,this.top=s,this.updateMatrices()}zoomPoint(e,t,i,s){const n=ge.S4.subtract(e,this.eye,C.create()),r=this.getRight(),a=C.dot(n,r),o=C.dot(n,this.up);ge.S4.add(this.eye,ge.S4.scale(r,-a*(i-1),C.create()),this.eye),ge.S4.add(this.eye,ge.S4.scale(this.up,-o*(i-1),C.create()),this.eye);const h=this.right-this.left,c=this.top-this.bottom;this.left=-h*i*.5,this.right=h*i*.5,this.top=c*i*.5,this.bottom=-c*i*.5,this.updateMatrices(),this.integrityCheck("zoomPoint")}ensureCameraIsOutsideSceneBounds(){if(!this.sceneBounds)return;const e=C.dot(this.direction,this.sceneBounds.center())-C.dot(this.direction,this.eye);ge.S4.add(this.eye,ge.S4.scale(this.direction,-(.6*this.sceneBounds.diameter()-e),C.create()),this.eye),this.integrityCheck("ensureCameraIsOutsideSceneBounds")}zoomToFit(e,t,i){let s;if(e instanceof Array)s=function(t){for(let i=0;i<e.length;i++)t(e[i])};else{if(!(e instanceof Function))return;s=e}t=t||1;const n=this.getRight(),r=this.getUp(),a=[1/0,1/0],o=[-1/0,-1/0],h=[0,0];if(s((function(e){h[0]=C.dot(n,e),h[1]=C.dot(r,e);for(let e=0;e<2;++e)h[e]<a[e]&&(a[e]=h[e]),h[e]>o[e]&&(o[e]=h[e])})),o[0]<a[0]||o[1]<a[1])return;let c=o[0]-a[0],l=o[1]-a[1];if(0===c&&0===l)return;0===c?c=l*this.DEFAULT_EXTENT_RATIO:0===l&&(l=c*this.DEFAULT_EXTENT_RATIO),this.eye=ge.S4.add(ge.S4.scale(n,.5*(a[0]+o[0]),C.create()),ge.S4.scale(r,.5*(a[1]+o[1]),C.create())),this.ensureCameraIsOutsideSceneBounds(),this.right=.5*c*t,this.top=.5*l*t;let u=this.viewport[2]/this.viewport[3];i&&(u=i[2]/i[3]);const d=this.right/this.top/u;if(d>1?this.top*=d:this.right/=d,i){const e=2*this.right/i[2],t=(.5*this.viewport[2]-(i[0]+.5*i[2]))*e,s=(.5*this.viewport[3]-(i[1]+.5*i[3]))*e;ge.S4.add(this.eye,ge.S4.scale(n,t,C.create())),ge.S4.add(this.eye,ge.S4.scale(r,s,C.create())),this.right*=this.viewport[2]/i[2],this.top*=this.viewport[3]/i[3]}this.left=-this.right,this.bottom=-this.top,this.updateMatrices(),this.integrityCheck("zoomToFit")}}function hh(e){const t=Math.min(e[2],e[3]);return[-.5*t,.5*t]}class ch extends ah{constructor(){super(),this.viewMatrix=de.create()}setTransforms(e,t,i){de.multiply(this.viewMatrix,t,e),this.projectionMatrix=i,this.updateMatrixInverses(),C.set(this.TEMP_VEC3_0,0,0,0),ge.w$.multiplyVec3(this.viewMatrixInverse,this.TEMP_VEC3_0,this.eye),y.set(this.TEMP_VEC4_0,0,0,-1,0),ge.w$.multiplyVec4(this.viewMatrixInverse,this.TEMP_VEC4_0,this.TEMP_VEC4_1),C.copy(this.direction,this.TEMP_VEC4_1),y.set(this.TEMP_VEC4_0,0,1,0,0),ge.w$.multiplyVec4(this.viewMatrixInverse,this.TEMP_VEC4_0,this.TEMP_VEC4_1),C.copy(this.up,this.TEMP_VEC4_1)}updateMatrices(){}}class lh{constructor(e){this.viewer=e,this.occurrenceData={},(0,Jo.Yk)(e),this.getOrCreateOccurrenceData(Jf.KF)}getOccurrencesData(){return Object.values(this.occurrenceData)}destroy(){Object.values(this.occurrenceData).forEach((function(e){e.destroy()})),this.occurrenceData={},XE()}onPreviewDestroyed(){Object.values(this.occurrenceData).forEach((function(e){e.onPreviewDestroyed()}))}forEach(e){for(const t in this.occurrenceData)e(t,this.occurrenceData[t])}getOrCreateOccurrenceData(e){let t=this.occurrenceData[+e];return t||(this.occurrenceData[+e]=t=new Vr(+e,this.viewer.getIsExcludingItemsForSection())),t}getOccurrenceData(e){const t=this.occurrenceData[e];return t||null}destroyOccurrenceData(e){const t=this.occurrenceData[e];t&&(t.destroy(),delete this.occurrenceData[e])}setOccurrenceTransform(e,t){const i=this.getOrCreateOccurrenceData(e);return i.setTransform(t),this.viewer.requestDraw(),i}getOccurrenceTransform(e){const t=this.getOrCreateOccurrenceData(e);if(t)return t.getTransform();return de.create()}processHighlightForOccurrences(e,t,i,s){const n=this.viewer.getOccurrenceIdManager();for(let r=0;r<t.length;++r){const a=n.getIdForName(t[r].getPathAsString());a!==Jf.Qy&&this.getOrCreateOccurrenceData(a).updateOccurrenceHighlight(e,i,s)}this.viewer.requestDraw()}clearHighlight(e,t){for(const i in this.occurrenceData){this.occurrenceData[i].clearHighlight(e,t)}this.viewer.requestDraw()}clearIsolation(e){this.setAllIsolated(!1,e)}isolateAll(){this.setAllIsolated(!0)}setAllIsolated(e,t){for(const i in this.occurrenceData){if(t?.has(+i))continue;this.occurrenceData[i].setIsolated(e)}this.viewer.requestDraw()}setOccurrenceIsolated(e,t){this.getOrCreateOccurrenceData(+e).setIsolated(t),this.viewer.requestDraw()}resetHiddenFromPick(){for(const e in this.occurrenceData)this.occurrenceData[e].resetHiddenFromPick()}makeSceneDebugObject(){const e=[];return Object.values(this.occurrenceData).forEach((function(t){e.push(t.makeSceneDebugObject())})),{text:"Occurrence data",children:e}}doesHighlightOfTypeExists(e){for(const t of Object.values(this.occurrenceData)){const i=t.getHighlightsForUsage(fs.L.BASE),s=i?.hasHighlightOfType(e);if(s)return!0}return!1}}var uh,dh=i(63971),gh=i(29307);!function(e){e[e.BACK=0]="BACK",e[e.FRONT=1]="FRONT",e[e.NONE=-1]="NONE",e[e.UNSPECIFIED=-2]="UNSPECIFIED"}(uh||(uh={}));var ph=i(44634);const mh="SIMULATION_BONDED";let fh=!1;const Ih=255;class Eh{constructor(e,t,i){this.AnalyticsService=e,this.modelViewManager=t,this.simulationManager=i,this.meshOwnerId=PS(),this.elementIdToResponseData=new Map,this.contactTractionThreshold=.1,this.visualizedOccurrencePaths=[],this.connectionTypes=[],this.useIsolateEffect=!0,this.occurrencesMarkedAsSimulated=[],this.contactBehavior=k.Ixp.FUSE_IN_CONTACT_AND_USE_MATES,this.prepareScenegraph()}setVisible(e){this.isVisible!==e&&(this.isVisible=e,!this.isVisible&&this.useIsolateEffect?(this.useIsolateEffect&&this.viewer.getIsolatedOccurrenceManager()?.clearAllIsolateNoAnimation(),this.clearGraphics()):this.updateGraphics())}setContactBehavior(e){this.contactBehavior!==e&&(this.contactBehavior=e,this.updateGraphics())}getContactBehavior(){return this.contactBehavior}getVisible(){return this.isVisible}getUseIsolateEffect(){return this.useIsolateEffect}updateContactAnalysis(e){const t=new Qo.B7("ConnectionVisualizationManager.updateContactAnalysis",{setTraceId:!0});let i=!1;if(e.runStatus===k.zgQ.JUST_STARTED||e.runStatus===k.zgQ.INVALID_ASSEMBLY)return this.clearGraphics(),void(e.runStatus===k.zgQ.JUST_STARTED&&this.elementIdToResponseData.delete(e.sourceElementId));if(e.hasResponse)this.elementIdToResponseData.set(e.sourceElementId,e.response),i=!0;else{const t=this.modelViewManager.getDisplayedAssembly();t&&e.runStatus===k.zgQ.TRANSMITTED&&this.elementIdToResponseData.has(t.elementId)&&(i=!0)}i&&this.updateGraphics(),t.report()}onAssemblyChanged(){this.updateIfVisible()}onSectionSetChanged(){this.updateIfVisible()}updateIfVisible(){this.isVisible&&this.updateGraphics()}updateGraphics(){const e=new Qo.B7("ConnectionVisualizationManager.updateGraphics",{setTraceId:!0});if(this.clearGraphics(),!this.isVisible)return;const t=this.modelViewManager.getDisplayedAssembly();if(!t||t.isHidden)return;if(this.viewer.getRenderingMode()!==k.P1.SIMULATION_RESULTS)return;const i=this.elementIdToResponseData.get(t.elementId);if(!i||!i.resultData)return void ut.log.debug("No data set to display");this.useIsolateEffect=!!X.default.getManager().getNumber("USE_ISOLATE_EFFECT_FOR_CONNECTION_VISUALIZATION");const s=this.viewer.getOccurrenceIdManager(),n=this.viewer.getOccurrenceDataManager(),r=i.resultData,a=new Set;this.updateConnectionTexture(i,t,a);let o=!1;const h=[];for(const e in r.occurrenceIdToOccurrenceResult){const c=r.occurrenceIdToOccurrenceResult[e],l=k._oC.getOccurrenceFromPathString(e),u=s.getIdForName(e);if(u===Jf.Qy){ut.log.warn("No occurrence id for "+e);continue}const d=n.getOccurrenceData(u);d||ut.log.warn("No occurrence data for "+e);const g=t.getOccurrenceDisplayData(l);if(!g){ut.log.warn("No occurrence display data for "+e);continue}const p=this.modelViewManager.getPartStudioDataFromOccurrence(l);if(!p){ut.log.debug("No part studio for occurrence "+e);continue}if(!this.simulationManager.getTessellationForOccurrenceResult(c)){ut.log.debug("No simulation tessellation for "+e),o=!0;break}const m=this.getMeshIncrementForOccurrence(i,c,g,a);if(!m)continue;const f=e+".CP";let I,E;this.useIsolateEffect||(p.getBodyComponent().setScalarVisualizationOccurrence(u),this.occurrencesMarkedAsSimulated.push(e)),this.useIsolateEffect?(I=s.getOrCreateIdForName(f),E=n.getOrCreateOccurrenceData(I),E.setTransform(d.getTransform()),E.setIsolated(!0),E.setVisibility(d.getVisibility()),E.setIsClippedBySectionPlanes(d.getIsClippedBySectionPlanes())):(I=u,E=d),h.push(I),m.id=e;const S=this.meshManager.addMeshIncrement(m,this.meshOwnerId),T=new SS("Contact "+f);T.onIncrementAdded(S);const D=p.retrieveBodyMetaData(g.partIds[0]),M=new XI.bg;D&&M.setAttribute(sE.COLOR,D.getColor()),this.rootNode.addOccurrenceGeometryToNode(this.meshNodeProperties,E,M,T),this.rootNode.addOccurrenceGeometryToNode(this.fadeMeshNodeProperties,E,M,T),this.visualizedOccurrencePaths.push(f)}o?this.clearGraphics():(this.viewer.getEventDispatcher().trigger(yD.GO,a),this.viewer.requestDraw(),this.useIsolateEffect&&(this.viewer.getIsolatedOccurrenceManager()?.clearAllIsolateNoAnimation(),Ye(1),this.viewer.getIsolatedOccurrenceManager()?.addIdsToIsolate(h,!0)),e.report())}setContactTractionThreshold(e){this.contactTractionThreshold=e,this.updateMaterialUniforms(),this.viewer.requestDraw()}isNodeForBodyVisualization(e){return this.rootNode===e}updateMaterialUniforms(){this.material.setCustomFloatUniform("uMultipleConnectionsCoordinate",this.multipleConnectionCoordinate),this.fadeMaterial.setCustomFloatUniform("uMultipleConnectionsCoordinate",this.multipleConnectionCoordinate),this.material.setCustomFloatUniform("uTractionContactThreshold",Math.floor(this.contactTractionThreshold*Ih-1)),this.fadeMaterial.setCustomFloatUniform("uTractionContactThreshold",Math.floor(this.contactTractionThreshold*Ih-1))}get viewer(){return this.modelViewManager.getViewer()}prepareScenegraph(){const e="ContactAnalysis",t=this.modelViewManager.getSharedBodyNode();this.rootNode=t.getChildById(e),this.rootNode||(this.rootNode=new xi.NB(e),t.addChild(this.rootNode)),this.material=Fi(),this.material.shaderId="contact",this.fadeMaterial=Fi(),this.fadeMaterial.shaderId="contact",this.material.setCustomFloatUniform("uOcclusionFactor",0),this.material.setCustomFloatUniform("uBlendTransparent",0),this.fadeMaterial.setCustomFloatUniform("uOcclusionFactor",0),this.fadeMaterial.setCustomFloatUniform("uBlendTransparent",1),this.meshNodeProperties=new xi.hF({material:this.material,zOffset:X.default.getManager().getNumber("PART_FACES_Z_OFFSET"),primitiveType:Di.MX.TRIANGLES,includedInBlend:!0,addsToSectionMask:!1,clippedBySectionPlanes:!0,isPickable:!1,isTwoSided:!0}),this.fadeMeshNodeProperties=new xi.hF({material:this.fadeMaterial,zOffset:X.default.getManager().getNumber("PART_FACES_Z_OFFSET"),primitiveType:Di.MX.TRIANGLES,includedInBlend:!0,addsToSectionMask:!1,clippedBySectionPlanes:!0,isPickable:!1,isTwoSided:!0,primitivesHaveTransparency:!0})}clearGraphics(){const e=this.viewer.getOccurrenceIdManager(),t=this.viewer.getOccurrenceDataManager();for(let i=0;i<this.visualizedOccurrencePaths.length;++i){const s=this.visualizedOccurrencePaths[i],n=e.getIdForName(s);if(n===Jf.Qy)continue;t.getOccurrenceData(n)&&(this.rootNode.removeOccurrence(n),t.destroyOccurrenceData(n),e.removeName(s))}this.meshManager&&this.meshManager.destroy(),this.meshManager=new AS(this.viewer,{bufferAllocationPolicy:$f.MAXIMUM}),this.simulationManager.clearScalarVisualizationStatusForOccurrences(this.occurrencesMarkedAsSimulated),this.occurrencesMarkedAsSimulated=[]}updateConnectionTexture(e,t,i){const s=e.contactPairList.length+2,n=new Uint8Array(4*s*1),r={},a=k.hto.slice(0,k.hto.length-1);for(let e=0;e<a.length;++e)r[a[e]]=(0,Fs.Db)(X.default.getManager().getColor("CONTACT_COLOR_"+a[e]));const o=this.getNonMatedContactType(),h=k.v79[o],c=this.contactBehavior===k.Ixp.FUSE_IN_CONTACT,l={};let u=0;function d(e){const t=e.firstOccurrence.getPathAsString(),i=e.secondOccurrence.getPathAsString();let s;if(s=t<i?t+"-"+i:i+"-"+t,l.hasOwnProperty(s))return l[s];{const e=u++;return l[s]=e,e}}const g=[];this.connectionTypes=[];for(let i=0;i<e.contactPairList.length;++i){const s=e.contactPairList[i];let a;s.occurrencePairId=d(s);let l=h;if(s.mateId&&!c){const e=t.getMateIndicatorData(s.mateId);let i=o;e?i=e.getSimulationConnectionType():ut.log.debug("Failed to find mate for connection visualization: "+s.mateId),l=k.v79[i],a=r[i]?r[i]:r[o]}else a=r[o];this.connectionTypes.push(l),g.push({contactPairIndex:i,contactPair:s,connectionType:l});const u=4*i*1;n.set(a,u)}this.sortContactFields(g);let p=-1;for(let e=0;e<g.length;++e){const t=g[e];let s=!0;(c&&t.contactPair.hasSimulationConnections||p===t.contactPair.occurrencePairId&&t.connectionType===h)&&(s=!1),t.connectionType!==h&&(p=t.contactPair.occurrencePairId),s&&i.add(t.connectionType)}const m=4*(s-1)*1;n.set(r.MULTIPLE,m);const f=4*(s-2)*1;n.set(r[mh],f);const I=new ja(this.viewer.getGlContext());I.bytes=n,I.width=1,I.height=s,this.material.ambientTexture&&this.material.ambientTexture.destroy(),this.material.ambientTexture=new $a(this.viewer,I),this.material.ambientTexture.setHasTransparency(!1),this.fadeMaterial.ambientTexture=this.material.ambientTexture,this.textureInfo={textureEntryCount:s,texelHeight:1/s,texelWidth:1},this.updateMaterialUniforms()}getNonMatedContactType(){return this.contactBehavior===k.Ixp.MATES_ONLY?"UNCONSTRAINED":mh}getMeshIncrementForOccurrence(e,t,i,s){const n=this.simulationManager.getTessellationForOccurrenceResult(t);if(!n)return null;const r=this.simulationManager.getSampleMesh(n,t),a=new vE(Di.MX.TRIANGLES,r.points,r.getAnyIndices()),o=this.getContactAttributesForResult(e,t,s);if(!o)return null;a.contactTraction=o.contactTraction,a.contactPairCoordinate=o.contactPairCoordinate;const h=this.modelViewManager.getPartStudio(t.sourcePartReference);if(h){const e=h.getBodyBounds(n.deterministicId,i.occurrenceData.occurrence);e&&(a.boundingBox=e)}return a}sortContactFields(e){const t=k.v79[this.getNonMatedContactType()];e.sort(((e,i)=>e.contactPair.occurrencePairId===i.contactPair.occurrencePairId?e.connectionType===i.connectionType?e.contactPairIndex-i.contactPairIndex:e.connectionType===t?1:i.connectionType===t?-1:e.connectionType-i.connectionType:e.contactPair.occurrencePairId<i.contactPair.occurrencePairId?-1:1))}getContactAttributesForResult(e,t,i){if(0===t.fields.length)return ut.log.debug("Found occurrence result with no fields"),null;const s=[];let n=0;for(let i=0;i<t.fields.length;++i){const n=t.fields[i];for(let t=0;t<n.contactPairIndices.length;++t){const i=n.contactPairIndices[t],r=this.connectionTypes[i],a=e.contactPairList[i];s.push({contactPairIndex:i,connectionType:r,contactPair:a,field:n,visible:!1})}}const r=k.v79[this.getNonMatedContactType()];this.sortContactFields(s);const a=this.contactBehavior===k.Ixp.FUSE_IN_CONTACT,o=[];let h=-1;for(let t=0;t<s.length;++t){const i=s[t];let c=!this.simulationManager.getVisualizationState().connectionTypeToHidden[i.connectionType];const l=e.contactPairList[i.contactPairIndex];(a&&l.hasSimulationConnections||h===i.contactPair.occurrencePairId&&i.connectionType===r)&&(c=!1),i.connectionType!==r&&(h=i.contactPair.occurrencePairId),i.visible=c,c&&(++n,o.push(i))}if(0===n)return null;const c=s[0].field.values.length,l=new Uint8Array(16*c),u=new Float32Array(16*c);let d=!1,g=0,p=0;const m=[];for(let e=0;e<o.length;++e)m.push(this.getTextureCoordinate(o[e].contactPairIndex));if(n>16){fh||(this.AnalyticsService.trackEvent("SIMULATION","high-connection-count"),fh=!0);const e=this.multipleConnectionCoordinate;a||(d=!0);for(let t=0;t<c;++t){let i=o[0].field.values[t];for(let e=1;e<o.length;++e){const s=o[e].field.values[t];s>i&&(i=s)}l[g++]=Math.min(255,Ih*i),u[p++]=e;for(let e=1;e<16;++e)g++,p++}}else for(let e=0;e<c;++e){let t=0;for(let i=0;i<16;++i)if(i<o.length){const s=o[i].field.values[e];s>=this.contactTractionThreshold&&++t,l[g++]=Math.min(255,Ih*s),u[p++]=m[i]}else g++,p++;d=t>1&&!a||d}return d&&i.add(k.v79.MULTIPLE),{contactTraction:l,contactPairCoordinate:u}}getTextureCoordinate(e){return.5*this.textureInfo.texelHeight+e*this.textureInfo.texelHeight}get multipleConnectionCoordinate(){return this.contactBehavior===k.Ixp.FUSE_IN_CONTACT?this.getTextureCoordinate(this.textureInfo.textureEntryCount-2):this.getTextureCoordinate(this.textureInfo.textureEntryCount-1)}}Eh.$inject=["AnalyticsService"];var Sh=i(23562),Th=i(98488),Dh=i(13539),Mh=i(71455);const Ch=new xi.hF({primitiveType:Di.MX.LINES,isPickable:!1}),yh=new xi.hF({primitiveType:Di.MX.LINES,isVisible:!1}),Ph=new xi.hF({primitiveType:Di.MX.TRIANGLES,isPickable:!1,material:bi,primitivesHaveTransparency:!1}),Ah=new xi.hF({primitiveType:Di.MX.TRIANGLES,isVisible:!1}),Oh="legend",vh="legendMinTick",Rh="legendMaxTick",wh="legendColorMap",_h="legendAboveMax",Nh="legendBelowMin",bh="legendBackground",Lh="legendDragRegion",Fh="minHighlight",xh="maxHighlight",Bh="dimHighlight",Vh=.1,Uh=.3,Gh=.4,Hh=.5,kh=Nn.C.GRAB,Wh=Nn.C.CROSSHAIR,zh=Nn.C.GRABBING,Xh=Nn.C.POINTER,Zh=Nn.C.EW_RESIZE,qh=Nn.C.NS_RESIZE;class Yh extends Ti.u1{get SNAPPING_MARGIN_TOP(){return 0}constructor(e){super(e.getViewer(),Zo.EG),this.manager=e,this.valueTextElements=[],this.textCache=[],this.isVertical=!0,this.isDamaged=!1,this.colorMapDimensions={width:0,height:0},this.colorMapPadding={left:0,right:0,top:0,bottom:0},this.userHasMovedLegend=!1,this.legendMovedSubject=new Is.x,this.legendDragPoint=new k.YFv,this.isBeingDragged=!1,this.tickBeingDragged=null,this.removeSubject=new Is.x,this.isPendingShow=!1,this.colorMapMaterial=Fi(),this.colorMapNodeProperties=new xi.hF({primitiveType:Di.MX.TRIANGLES,material:this.colorMapMaterial}),this.setActiveColorMapping(Th.T),this.listenTo(this,Ti.zw.MOUSE_ENTER+Oh,this.onMouseEnterLegend),this.listenTo(this,Ti.zw.MOUSE_ENTER+wh,this.onMouseEnterColorMap),this.listenTo(this,Ti.zw.DRAG_START+Oh,this.onDragStartLegend),this.listenTo(this,Ti.zw.DRAG+Oh,this.onDragLegend),this.listenTo(this,Ti.zw.DRAG_STOP+Oh,this.onDragStopLegend),this.listenTo(this,Ti.zw.DRAG_START+wh,this.onDragStartLegend),this.listenTo(this,Ti.zw.DRAG+wh,this.onDragLegend),this.listenTo(this,Ti.zw.DRAG_STOP+wh,this.onDragStopLegend),this.listenTo(this,Ti.zw.MOUSE_LEAVE+wh,(()=>this.onMouseLeavePopCursor(Wh))),this.listenTo(this,Ti.zw.MOUSE_LEAVE+Oh,(()=>this.onMouseLeavePopCursor(kh))),this.listenTo(this,Ti.zw.MOUSE_ENTER+Rh,this.onMouseEnterTick),this.listenTo(this,Ti.zw.DRAG_START+Rh,this.onDragStartTickMax),this.listenTo(this,Ti.zw.DRAG+Rh,this.onDragTickMax),this.listenTo(this,Ti.zw.DRAG_STOP+Rh,this.onDragStopTick),this.listenTo(this,Ti.zw.MOUSE_LEAVE+Rh,this.onMouseLeaveTick),this.listenTo(this,Ti.zw.MOUSE_ENTER+vh,this.onMouseEnterTick),this.listenTo(this,Ti.zw.DRAG_START+vh,this.onDragStartTickMin),this.listenTo(this,Ti.zw.DRAG+vh,this.onDragTickMin),this.listenTo(this,Ti.zw.DRAG_STOP+vh,this.onDragStopTick),this.listenTo(this,Ti.zw.MOUSE_LEAVE+vh,this.onMouseLeaveTick),e.getSupportsInContextMode()&&(0,$i.Xt)().getPanelOpenCloseObservable().pipe((0,Mh.R)(this.getRemoveObservable())).subscribe((e=>this.panelWasAdded(e))),this.changeLegendOrientation(),this.updateConstants()}updateConstants(){const e=X.default.getManager(),t=e.getNumber("LEGEND_TICK_TEXT_UNDERLINE_WIDTH_PX");this.backgroundColor=e.getColor("LEGEND_BACKGROUND_COLOR"),this.defaultFontOptions={color:e.getColor("LEGEND_TICK_TEXT_COLOR"),size:e.getNumber("LEGEND_TICK_TEXT_HEIGHT_PX"),font:e.getString("LEGEND_TICK_TEXT_FONT")},this.clickableFontOptions={color:e.getColor("LEGEND_TICK_CLICKABLE_TEXT_COLOR"),size:e.getNumber("LEGEND_TICK_TEXT_HEIGHT_PX"),font:e.getString("LEGEND_TICK_TEXT_FONT"),underlineWidth:t},this.hoverFontOptions={color:e.getColor("LEGEND_TICK_TEXT_COLOR"),size:e.getNumber("LEGEND_TICK_TEXT_HEIGHT_PX"),font:e.getString("LEGEND_TICK_TEXT_FONT"),fontWeight:e.getString("LEGEND_TICK_TEXT_HOVER_WEIGHT"),underlineWidth:t}}repositionPanel(){const e=this.colorMapCorners,t=this.calculateInitialLegendPosition();t&&(this.colorMapCorners=t,e?.bottomLeft.equals(this.colorMapCorners?.bottomLeft)&&e?.topRight.equals(this.colorMapCorners?.topRight)||this.updateGraphics())}getRelevantPanelIdsForRepositioning(){return[this.CANVAS_CONTROLS_PANEL_ID]}panelWasAdded(e){const t=this.getRelevantPanelIdsForRepositioning();!this.userHasMovedLegend&&t.includes(e?.panelId)&&this.repositionPanel()}setIsVertical(e){this.isVertical!==e&&this.changeLegendOrientation()}getIsVertical(){return this.isVertical}areCoordinatesOverLegend(e){return!!this.colorMapCorners&&(this.colorMapCorners.bottomLeft.x<e.x&&e.x<this.colorMapCorners.topRight.x&&this.colorMapCorners.bottomLeft.y<e.y&&e.y<this.colorMapCorners.topRight.y)}onMouseLeavePopCursor(e){this.viewer.removeTopOccurrenceOfCursor(e)}onMouseLeaveTick(){const e=this.isVertical?qh:Zh;this.onMouseLeavePopCursor(e)}onMouseEnterLegend(){this.viewer.pushCursor(kh)}onMouseEnterColorMap(){this.viewer.pushCursor(Wh)}onDragStartLegend(e,t,i){this.viewer.pushCursor(zh),i.requestDrag=!0,this.legendDragPoint.updateFromArray([t.mouseX,t.mouseY]),this.userHasMovedLegend=!0}onMouseEnterTick(){this.isVertical?this.viewer.pushCursor(qh):this.viewer.pushCursor(Zh)}get isTickBeingDragged(){return null!==this.tickBeingDragged}onDragStartTick(e,t,i){this.isBeingDragged=!0,i.requestDrag=!0,this.currentScaleRange=this.visualizedScalarRange?.clone()}onDragStartTickMax(e,t,i){return this.tickBeingDragged=Dh.s.MAX,this.onDragStartTick(e,t,i)}onDragStartTickMin(e,t,i){return this.tickBeingDragged=Dh.s.MIN,this.onDragStartTick(e,t,i)}onDragStopTick(){this.isBeingDragged=!1,this.tickBeingDragged=null,this.currentScaleRange=this.visualizedScalarRange?.clone(),this.isDamaged=!0}onDragLegend(e,t){const i=k.YFv.fromArray([this.legendDragPoint.x-t.mouseX,t.mouseY-this.legendDragPoint.y]);this.moveLegend(i)}onDragStopLegend(){this.viewer.removeTopOccurrenceOfCursor(zh),this.isBeingDragged=!1,this.legendDragPoint=new k.YFv}onDragTickMin(e,t){if(!this.visualizedScalarRange?.hasRange)return;const{topRight:i}=this.getViewportCoordinates();let s=this.getClampedValueFromCoordinatesInRange(k.YFv.fromArray([t.mouseX,i.y-t.mouseY]));this.isInverted?s<this.visualizedScalarRange.max+Ci.W.MIN_LEGEND_MIN_MAX_DIFFERENCE&&(s=Math.min(this.visualizedScalarRange.max+Ci.W.MIN_LEGEND_MIN_MAX_DIFFERENCE,this.visualizedScalarRange.min)):s>this.visualizedScalarRange.max-Ci.W.MIN_LEGEND_MIN_MAX_DIFFERENCE&&(s=Math.max(this.visualizedScalarRange.max-Ci.W.MIN_LEGEND_MIN_MAX_DIFFERENCE,this.visualizedScalarRange.min)),s!==this.visualizedScalarRange.min&&this.viewer.getEventDispatcher().trigger(this.LEGEND_RANGE_CHANGED,s,Dh.s.MIN)}onDragTickMax(e,t){if(!this.visualizedScalarRange?.hasRange)return;const{topRight:i}=this.getViewportCoordinates();let s=this.getClampedValueFromCoordinatesInRange(k.YFv.fromArray([t.mouseX,i.y-t.mouseY]));this.isInverted?s>this.visualizedScalarRange.min-Ci.W.MIN_LEGEND_MIN_MAX_DIFFERENCE&&(s=Math.max(this.visualizedScalarRange.min-Ci.W.MIN_LEGEND_MIN_MAX_DIFFERENCE,this.visualizedScalarRange.max)):s<this.visualizedScalarRange.min+Ci.W.MIN_LEGEND_MIN_MAX_DIFFERENCE&&(s=Math.min(this.visualizedScalarRange.min+Ci.W.MIN_LEGEND_MIN_MAX_DIFFERENCE,this.visualizedScalarRange.max)),s!==this.visualizedScalarRange.max&&this.viewer.getEventDispatcher().trigger(this.LEGEND_RANGE_CHANGED,s,Dh.s.MAX)}getValueFromCoordinates(e){if(!this.currentScaleRange?.hasRange)return ut.log.warn("Tried to getValueFromCoordinates but currentScaleRange was not valid"),0;const t=this.isVertical?e.y:e.x,i=this.calculateLongSideCoordinate(this.currentScaleRange.max),s=this.calculateLongSideCoordinate(this.currentScaleRange.min),n=(t-s)/(i-s)*this.currentScaleRange.magnitude+this.currentScaleRange.min;return isNaN(n)&&ut.log.warn(`Tried to getValueFromCoordinates but value was ${n}`),n}getValueFromCoordinatesInVisualizedRange(e){if(!this.visualizedScalarRange?.hasRange)return ut.log.warn("Tried to getValueFromCoordinatesInVisualizedRange but visualizedScalarRange was not valid"),0;const t=this.isVertical?e.y:e.x,i=this.calculateLongSideCoordinate(this.visualizedScalarRange.max),s=this.calculateLongSideCoordinate(this.visualizedScalarRange.min),n=(t-s)/(i-s)*this.visualizedScalarRange.magnitude+this.visualizedScalarRange.min;return isNaN(n)&&ut.log.warn(`Tried to getValueFromCoordinatesInVisualizedRange but value was ${n}`),n}getClampedValueFromCoordinatesInRange(e){if(!this.currentScaleRange?.hasRange)return ut.log.warn("Tried to getClampedValueFromCoordinatesInRange but currentScaleRange was not valid"),0;const t=this.getValueFromCoordinates(e);return t>this.currentScaleRange.highValue?this.currentScaleRange.highValue:t<this.currentScaleRange.lowValue?this.currentScaleRange.lowValue:t}getViewportCoordinates(){const e=this.viewer.getCamera()?.getViewport(!0)?.slice();return e?(this.lastRenderedViewport||(this.lastRenderedViewport=e.slice()),this.getCornerCoordinatesFromViewportVector(e)):(ut.log.debug("Tried to get viewport coordinates but the viewport was falsey"),null)}getCornerCoordinatesFromViewportVector(e){return{bottomLeft:k.YFv.fromXY(e[0],e[1]),topRight:k.YFv.fromXY(e[0]+e[2],e[1]+e[3])}}changeLegendOrientation(e){this.isVertical=!this.isVertical;const t=X.default.getManager();this.isVertical?(this.colorMapDimensions.width=t.getNumber("LEGEND_COLOR_MAP_VERTICAL_WIDTH_PX"),this.colorMapDimensions.height=t.getNumber("LEGEND_COLOR_MAP_VERTICAL_HEIGHT_PX"),this.colorMapPadding.left=t.getNumber("LEGEND_VERTICAL_LEFT_MARGIN_PX"),this.colorMapPadding.bottom=t.getNumber("LEGEND_VERTICAL_BOTTOM_MARGIN_PX"),this.colorMapPadding.right=t.getNumber("LEGEND_VERTICAL_RIGHT_MARGIN_PX"),this.colorMapPadding.top=t.getNumber("LEGEND_VERTICAL_TOP_MARGIN_PX")):(this.colorMapDimensions.width=t.getNumber("LEGEND_COLOR_MAP_HORIZONTAL_WIDTH_PX"),this.colorMapDimensions.height=t.getNumber("LEGEND_COLOR_MAP_HORIZONTAL_HEIGHT_PX"),this.colorMapPadding.left=t.getNumber("LEGEND_HORIZONTAL_LEFT_MARGIN_PX"),this.colorMapPadding.bottom=t.getNumber("LEGEND_HORIZONTAL_BOTTOM_MARGIN_PX"),this.colorMapPadding.right=t.getNumber("LEGEND_HORIZONTAL_RIGHT_MARGIN_PX"),this.colorMapPadding.top=t.getNumber("LEGEND_HORIZONTAL_TOP_MARGIN_PX")),this.colorMapCorners&&(this.colorMapCorners.bottomLeft.x=this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.height/2-this.colorMapDimensions.width/2,this.colorMapCorners.bottomLeft.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.width/2-this.colorMapDimensions.height/2,this.colorMapCorners.topRight.x=this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width,this.colorMapCorners.topRight.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height),e&&(this.colorMapCorners.bottomLeft.x-this.colorMapPadding.left<e.left?(this.colorMapCorners.bottomLeft.x=e.left+this.colorMapPadding.left,this.colorMapCorners.topRight.x=this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width):this.colorMapCorners.topRight.x+this.colorMapPadding.right>e.right&&(this.colorMapCorners.topRight.x=e.right-this.colorMapPadding.right,this.colorMapCorners.bottomLeft.x=this.colorMapCorners.topRight.x-this.colorMapDimensions.width),this.colorMapCorners.bottomLeft.y-this.colorMapPadding.bottom<e.bottom?(this.colorMapCorners.bottomLeft.y=e.bottom+this.colorMapPadding.bottom,this.colorMapCorners.topRight.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height):this.colorMapCorners.topRight.y+this.colorMapPadding.top>e.top&&(this.colorMapCorners.topRight.y=e.top-this.colorMapPadding.top,this.colorMapCorners.bottomLeft.y=this.colorMapCorners.topRight.y-this.colorMapDimensions.height))}onDevicePixelRatioChanged(e){if(this.isHidden)return void this.changeLegendOrientation();const t=(0,Ji.x_)();if(!this.lastUsedDevicePixelRatio||t===this.lastUsedDevicePixelRatio)return;const i=this.lastRenderedViewport,s=e.getViewport(!0).slice(),n=t/this.lastUsedDevicePixelRatio;if(this.colorMapPadding.left*=n,this.colorMapPadding.top*=n,this.colorMapPadding.right*=n,this.colorMapPadding.bottom*=n,this.colorMapDimensions.width*=n,this.colorMapDimensions.height*=n,this.isVertical){const e=(.5*i[3]-this.colorMapCorners.bottomLeft.y)*n;this.colorMapCorners.bottomLeft.y=.5*s[3]-e;if(this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width/2>=i[2]/2){const e=(i[2]-this.colorMapCorners.bottomLeft.x)*n;this.colorMapCorners.bottomLeft.x=s[2]-e}else this.colorMapCorners.bottomLeft.x*=n}else{const e=(.5*i[2]-this.colorMapCorners.bottomLeft.x)*n;this.colorMapCorners.bottomLeft.x=.5*s[2]-e;if(this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height/2>=i[3]/2){const e=(i[3]-this.colorMapCorners.bottomLeft.y)*n;this.colorMapCorners.bottomLeft.y=s[3]-e}else this.colorMapCorners.bottomLeft.y*=n}this.colorMapCorners.topRight.x=this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width,this.colorMapCorners.topRight.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height,this.lastRenderedViewport=s,this.lastUsedDevicePixelRatio=t,this.updateGraphics()}onAppearanceConstantsUpdated(){this.updateConstants(),this.updateGraphics()}onResize(e,t){const i=t[2]-e[2],s=t[3]-e[3];if(0===i&&0===s)return;const n=this.getCornerCoordinatesFromViewportVector(e),{shouldSnapTo:r}=this.getShouldSnapTo(n),a=this.getCornerCoordinatesFromViewportVector(t);let o=0,h=0;if(this.isVertical)if(h=s/2,r.left())this.snapToLeft(a);else{this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width/2>=e[2]/2&&(o=i)}else if(o=i/2,r.top())this.snapToTop(a);else{this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height/2>=e[3]/2&&(h=s)}this.moveLegend(k.YFv.fromXY(-o,-h),a,!0)}moveLegend(e,t=this.getViewportCoordinates(),i=!1){const{shouldSnapTo:s,snappableBounds:n}=this.getShouldSnapTo(t,e);let r=!1;s.top()?(!this.isVertical||i||r||this.changeLegendOrientation(n),this.snapToTop(t),r=!0):s.bottom()?(!this.isVertical||i||r||this.changeLegendOrientation(n),this.snapToBottom(t),r=!0):(this.colorMapCorners.bottomLeft.y-=e.y,this.colorMapCorners.topRight.y-=e.y,this.isBeingDragged&&(this.legendDragPoint.y=this.legendDragPoint.y+e.y)),s.left()?(this.isVertical||i||r||this.changeLegendOrientation(n),this.snapToLeft(t),r=!0):s.right()?(this.isVertical||i||r||this.changeLegendOrientation(n),this.snapToRight(t),r=!0):(this.colorMapCorners.topRight.x-=e.x,this.colorMapCorners.bottomLeft.x-=e.x,this.isBeingDragged&&(this.legendDragPoint.x=this.legendDragPoint.x-e.x)),(0,Fs.sW)()&&(this.userHasMovedLegend=!0),this.legendMovedSubject.next(),this.isDamaged=!0}getLegendMovedObservable(){return this.legendMovedSubject.asObservable()}getShouldSnapTo(e,t=new k.YFv){const i=X.default.getManager(),s=i.getNumber("LEGEND_SIDE_SNAP_DEADZONE_PX"),n=i.getNumber("LEGEND_SIDE_SNAP_THRESHOLD_PX"),r=i.getNumber("LEGEND_VERTICAL_SNAP_THRESHOLD_PX"),a={right:e.topRight.x-s-n,left:e.bottomLeft.x+s+n,top:e.topRight.y-this.SNAPPING_MARGIN_TOP-r,bottom:e.bottomLeft.y+r};return{shouldSnapTo:{right:()=>this.colorMapCorners.topRight.x-t.x+this.colorMapPadding.right>a.right,left:()=>this.colorMapCorners.bottomLeft.x-t.x-this.colorMapPadding.left<a.left,top:()=>this.colorMapCorners.topRight.y-t.y+this.colorMapPadding.top>a.top,bottom:()=>this.colorMapCorners.bottomLeft.y-t.y-this.colorMapPadding.bottom<a.bottom},snappableBounds:a}}snapToTop(e){this.colorMapCorners.topRight.y=e.topRight.y-this.colorMapPadding.top-this.SNAPPING_MARGIN_TOP,this.colorMapCorners.bottomLeft.y=this.colorMapCorners.topRight.y-this.colorMapDimensions.height}snapToBottom(e){this.colorMapCorners.bottomLeft.y=e.bottomLeft.y+this.colorMapPadding.bottom,this.colorMapCorners.topRight.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height}snapToRight(e){const t=X.default.getManager().getNumber("LEGEND_SIDE_SNAP_DEADZONE_PX");this.colorMapCorners.topRight.x=e.topRight.x-this.colorMapPadding.right-t,this.colorMapCorners.bottomLeft.x=this.colorMapCorners.topRight.x-this.colorMapDimensions.width}snapToLeft(e){const t=X.default.getManager().getNumber("LEGEND_SIDE_SNAP_DEADZONE_PX");this.colorMapCorners.bottomLeft.x=e.bottomLeft.x+this.colorMapPadding.left+t,this.colorMapCorners.topRight.x=this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width}remove(){super.remove(),this.colorMapMaterial.destroy(),this.clearText(),this.removeSubject.next()}getRemoveObservable(){return this.removeSubject.asObservable()}setActiveColorMapping(e){this.colorMapMaterial.ambientTexture=this.viewer.getResources().scalarVisualizationTextures.get(e)}setInputRange(e){this.rangeInData=e.rangeInData,e.defaultDisplayRange?this.defaultDisplayRange=e.defaultDisplayRange:this.defaultDisplayRange=e.rangeInData,this.visualizedScalarRange||this.setVisualizedScalarRange(this.defaultDisplayRange)}setVisualizedScalarRange(e){this.visualizedScalarRange=e,!this.isTickBeingDragged&&e&&(this.currentScaleRange=e.clone()),this.isDamaged=!0}clearRanges(){this.rangeInData=null,this.visualizedScalarRange=null,this.isDamaged=!0}hide(){this.clearText(),this.isDamaged=!0,this.isPendingShow=!1,super.hide()}onViewWillDraw(e){if(this.isHidden)return;const t=e.getViewport(!0);this.lastRenderedViewport?(0,li.arraysEqual)(this.lastRenderedViewport,t)||(this.onResize(this.lastRenderedViewport,t),this.lastRenderedViewport=t.slice()):(this.lastRenderedViewport=t.slice(),this.isDamaged=!0),this.isDamaged&&this.updateGraphics()}getInputRangeInDisplayUnits(){if(this.rangeInData){const e=(0,Sh.r)(this.rangeInData,this.visualizedFieldType);return this.isInverted&&!e.isInverted?e.cloneInverted():e}return null}getDefaultDisplayRangeInDisplayUnits(){return this.defaultDisplayRange?(0,Sh.r)(this.defaultDisplayRange,this.visualizedFieldType):null}setupCorners(){this.colorMapCorners=this.getViewportCoordinates()}calculateInitialLegendPosition(){if(this.lastUsedDevicePixelRatio!==(0,Ji.x_)())return null;const e=this.getViewportCoordinates();if(!e)return null;const t=k.YFv.fromArray([(e.topRight.x-this.colorMapPadding.right-this.colorMapDimensions.width+this.colorMapPadding.left)/2,e.topRight.y-this.SNAPPING_MARGIN_TOP-this.colorMapDimensions.height-this.colorMapPadding.top]);return{bottomLeft:t,topRight:k.YFv.fromArray([t.x+this.colorMapDimensions.width,t.y+this.colorMapDimensions.height])}}createRectangleUsingLegendBounds(e,t){const i=X.default.getManager().getNumber("LEGEND_BACKGROUND_CORNER_RADIUS_PX");return(0,Au.Dw)([this.colorMapCorners.bottomLeft.x-this.colorMapPadding.left,this.colorMapCorners.bottomLeft.y-this.colorMapPadding.bottom,t],[this.colorMapCorners.topRight.x+this.colorMapPadding.right,this.colorMapCorners.bottomLeft.y-this.colorMapPadding.bottom,t],[this.colorMapCorners.bottomLeft.x-this.colorMapPadding.left,this.colorMapCorners.topRight.y+this.colorMapPadding.top,t],i,5,e)}createHighlightRegion(e,t,i,s,n){const r=Math.max(this.colorMapDimensions.width,this.colorMapDimensions.height),a=Math.min(this.colorMapDimensions.width,this.colorMapDimensions.height),o=this.colorMapCorners.bottomLeft.x,h=this.colorMapCorners.bottomLeft.y;let c=i*r,l=c+(s-i)*r;const u=a/2,d=X.default.getManager().getNumber("LEGEND_OVERFLOW_DISPLAY_OFFSET_PX");let g,p;n===Dh.s.MIN&&this.isInputMinimumChanged()?c-=d:n===Dh.s.MAX&&this.isInputMaximumChanged()&&(l+=d),this.isVertical?(g=[u+o,c+h,Gh],p=[u+o,l+h,Gh]):(g=[c+o,u+h,Gh],p=[l+o,u+h,Gh]);return(0,Au.W5)(g,p,e,t,a/this.lastUsedDevicePixelRatio)}requiresHighlightGraphics(){return!1}createHighlightGraphics(){if(!this.requiresHighlightGraphics())return;if(!this.visualizedScalarRange?.hasRange)return void ut.log.warn("Tried to createHighlightGraphics but visualizedScalarRange was not valid");if(!this.currentScaleRange?.hasRange)return void ut.log.warn("Tried to createHighlightGraphics but currentScaleRange was not valid");const e=this.currentScaleRange.getNormalizedValue(this.visualizedScalarRange.min),t=this.currentScaleRange.getNormalizedValue(this.visualizedScalarRange.max);if(this.manager.getUseMinValueHighlight()){const t=this.manager.getMinHighlightColor(),i=this.createHighlightRegion(Fh,t,0,e,Dh.s.MIN);this.updateMeshIncrement(Fh,Ti.ZJ,i,Ch)}if(this.manager.getUseMaxValueHighlight()){const e=this.manager.getMaxHighlightColor(),i=this.createHighlightRegion(xh,e,t,1,Dh.s.MAX);this.updateMeshIncrement(xh,Ti.ZJ,i,Ch)}if(this.manager.getUseDimColorScale()){const i=this.manager.getDimHighlightColor(),s=this.createHighlightRegion(Bh,i,e,t);this.updateMeshIncrement(Bh,Ti.ZJ,s,Ch)}}updateGraphics(){if(this.isHidden)return;this.removeMeshIncrements();if(this.clearText(!0),this.lastUsedDevicePixelRatio||(this.lastUsedDevicePixelRatio=(0,Ji.x_)()),!this.colorMapCorners){const e=this.calculateInitialLegendPosition();if(!e)return;this.colorMapCorners=e}const e=this.createRectangleUsingLegendBounds(bh,0);(0,Au.Ab)(this.backgroundColor,e),(0,Au.Ae)(e,this.backgroundColor[3]),this.updateMeshIncrement(bh,Ti.ZJ,e,Ph);const t=this.createRectangleUsingLegendBounds(Lh,.2);this.updateMeshIncrement(Lh,Oh,t,Ah);if(this.createColorMapQuads().forEach((e=>this.updateMeshIncrement(e.id,wh,e,this.colorMapNodeProperties))),this.isDamaged=!1,this.createHighlightGraphics(),!this.visualizedScalarRange?.hasRange)return void this.clearTextCache();if(!this.currentScaleRange?.hasRange)return void ut.log.warn("Tried to updateGraphics but currentScaleRange was not valid");const i=X.default.getManager(),s=this.isVertical?this.colorMapCorners.bottomLeft.x:this.colorMapCorners.bottomLeft.y,n=i.getNumber("LEGEND_TICK_LENGTH_PX"),r=s-n,a=i.getColor("LEGEND_TICK_SCALE_COLOR"),o=i.getNumber("LEGEND_TICK_TEXT_GAP_PX"),h=i.getNumber("LEGEND_TICK_WIDTH");for(let e=0;e<6;e++){const t=this.currentScaleRange.magnitude/5*e+this.currentScaleRange.min,i=this.calculateLongSideCoordinate(t),n="legendScaleTick"+e,c=this.createTick(i,s,r,Vh,n,a,h);this.updateMeshIncrement(n,Ti.ZJ,c,Ch);let l=null,u=this.manager.getValueString(t),d=Vh;if(0===e?(d=.5,l=this.LEGEND_MINIMUM_CLICKED,this.isDisplayMinimumChanged()&&(u+="*")):5===e&&(d=.5,l=this.LEGEND_MAXIMUM_CLICKED,this.isDisplayMaximumChanged()&&(u+="*")),this.isVertical){const e=k.d0F.fromArray([r-o,i,d]);this.placeText(u,e,yi.iK.HIGH,yi.iK.MID,n,l)}else{const e=k.d0F.fromArray([i,r-o,d]);this.placeText(u,e,yi.iK.MID,yi.iK.HIGH,n,l)}}this.createMinMaxTick(Dh.s.MIN),this.createMinMaxTick(Dh.s.MAX),this.createMinMaxInputRangeText(n),this.clearTextCache()}createMinMaxInputRangeText(e){if(this.isInputMaximumChanged()){const t=this.getInputRangeValueString(Dh.s.MAX),i=new k.d0F;i.z=Vh,this.isVertical?(i.x=this.colorMapCorners.topRight.x-this.colorMapDimensions.width/2,i.y=this.colorMapCorners.topRight.y+e):(i.x=this.colorMapCorners.topRight.x+e,i.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height/2);const s=this.isVertical?yi.iK.MID:yi.iK.LOW,n=this.isVertical?yi.iK.LOW:yi.iK.MID;this.placeText(t,i,s,n)}if(this.isInputMinimumChanged()){const t=this.getInputRangeValueString(Dh.s.MIN),i=new k.d0F;i.z=Vh,this.isVertical?(i.x=this.colorMapCorners.topRight.x-this.colorMapDimensions.width/2,i.y=this.colorMapCorners.bottomLeft.y-e):(i.x=this.colorMapCorners.bottomLeft.x-e,i.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height/2);const s=this.isVertical?yi.iK.MID:yi.iK.HIGH,n=this.isVertical?yi.iK.HIGH:yi.iK.MID;this.placeText(t,i,s,n)}}getInputRangeValueString(e){const t=this.getInputRangeInDisplayUnits(),i=e===Dh.s.MAX?t?.max:t?.min;return this.manager.getValueString(i)}createColorMapQuad(e,t,i,s){const n=s?s[0]:void 0,r=s?s[1]:void 0,a=this.isVertical?[t.x,t.y,Uh]:[t.x,i.y,Uh],o=this.isVertical?[i.x,t.y,Uh]:[t.x,t.y,Uh],h=this.isVertical?[t.x,i.y,Uh]:[i.x,i.y,Uh];return(0,Au.fQ)(a,o,h,e,n,r)}createColorMapQuads(){const e=[],t=[[1,1],[1,1]],i=[[0,1],[1,0]],s=X.default.getManager().getNumber("LEGEND_OVERFLOW_DISPLAY_OFFSET_PX");if(this.isVertical){let n=this.colorMapCorners.topRight.y,r=this.colorMapCorners.bottomLeft.y;if(this.visualizedScalarRange?.hasRange&&this.isInputMaximumChanged()){n=this.calculateLongSideCoordinate(this.visualizedScalarRange.max);const t=k.YFv.fromArray([this.colorMapCorners.bottomLeft.x,n]),i=k.YFv.fromArray([this.colorMapCorners.topRight.x,this.colorMapCorners.topRight.y+s]),r=this.createColorMapQuad(_h,t,i);e.push(r)}if(this.visualizedScalarRange?.hasRange&&this.isInputMinimumChanged()){r=this.calculateLongSideCoordinate(this.visualizedScalarRange.min);const i=k.YFv.fromArray([this.colorMapCorners.topRight.x,r]),n=k.YFv.fromArray([this.colorMapCorners.bottomLeft.x,this.colorMapCorners.bottomLeft.y-s]),a=this.createColorMapQuad(Nh,n,i,t);e.push(a)}const a=k.YFv.fromArray([this.colorMapCorners.bottomLeft.x,r]),o=k.YFv.fromArray([this.colorMapCorners.topRight.x,n]),h=this.createColorMapQuad(wh,a,o,i);e.push(h)}else{let n=this.colorMapCorners.topRight.x,r=this.colorMapCorners.bottomLeft.x;if(this.visualizedScalarRange?.hasRange&&this.isInputMaximumChanged()){n=this.calculateLongSideCoordinate(this.visualizedScalarRange.max);const t=k.YFv.fromArray([n,this.colorMapCorners.bottomLeft.y]),i=k.YFv.fromArray([this.colorMapCorners.topRight.x+s,this.colorMapCorners.topRight.y]),r=this.createColorMapQuad(_h,t,i);e.push(r)}if(this.visualizedScalarRange?.hasRange&&this.isInputMinimumChanged()){r=this.calculateLongSideCoordinate(this.visualizedScalarRange.min);const i=k.YFv.fromArray([this.colorMapCorners.bottomLeft.x-s,this.colorMapCorners.bottomLeft.y]),n=k.YFv.fromArray([r,this.colorMapCorners.topRight.y]),a=this.createColorMapQuad(Nh,i,n,t);e.push(a)}const a=k.YFv.fromArray([r,this.colorMapCorners.bottomLeft.y]),o=k.YFv.fromArray([n,this.colorMapCorners.topRight.y]),h=this.createColorMapQuad(wh,a,o,i);e.push(h)}return e}clearText(e=!1){this.clearTextCache();for(let t=0;t<this.valueTextElements.length;++t){const i=this.valueTextElements[t].text;e?(i.viewer.uiSelectionManager.removeSelectionForUiElement(i),this.textCache.push(i)):i.remove(),this.stopListening(i)}this.valueTextElements=[]}getOrCreateText(e,t){for(let i=0;i<this.textCache.length;++i){const s=this.textCache[i];if(s.hasEqualTextAndOptions(e,t))return this.textCache.splice(i,1),s.show(),s}return new Da(this.viewer,e,t)}clearTextCache(){for(let e=0;e<this.textCache.length;++e)this.textCache[e].remove();this.textCache=[]}get isInverted(){return this.visualizedScalarRange?.isInverted}isInputMinimumChanged(){return k.dGY.isMinChanged(this.getInputRangeInDisplayUnits(),this.visualizedScalarRange,Ci.W.ZERO_LENGTH)}isInputMaximumChanged(){return k.dGY.isMaxChanged(this.getInputRangeInDisplayUnits(),this.visualizedScalarRange,Ci.W.ZERO_LENGTH)}isDisplayMinimumChanged(){return k.dGY.isMinChanged(this.getDefaultDisplayRangeInDisplayUnits(),this.currentScaleRange,Ci.W.ZERO_LENGTH)}isDisplayMaximumChanged(){return k.dGY.isMaxChanged(this.getDefaultDisplayRangeInDisplayUnits(),this.currentScaleRange,Ci.W.ZERO_LENGTH)}calculateLongSideCoordinate(e){if(!this.currentScaleRange?.hasRange)return ut.log.warn("Tried to calculateLongSideCoordinate but currentScaleRange was not valid"),0;let t;if(t=this.isVertical?this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height*(e-this.currentScaleRange.min)/this.currentScaleRange.magnitude:this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width*(e-this.currentScaleRange.min)/this.currentScaleRange.magnitude,isNaN(t))return ut.log.warn(`Tried to calculateLongSideCoordinate but coordinate was ${t}`),0;const i=(0,Ji.x_)()/2;return Math.round(t+i)-i}createMinMaxTick(e){if(!this.visualizedScalarRange?.hasRange)return void ut.log.warn("Tried to createMinMaxTick but visualizedScalarRange was not valid");const t=e===Dh.s.MAX,i=t?Rh:vh,s=t?this.visualizedScalarRange.max:this.visualizedScalarRange.min,n=this.calculateLongSideCoordinate(s),r=X.default.getManager(),a=r.getNumber("LEGEND_TICK_LENGTH_PX"),o=r.getColor("LEGEND_TICK_MIN_MAX_COLOR"),h=r.getNumber("LEGEND_TICK_WIDTH"),c=h+2*r.getNumber("LEGEND_TICK_MIN_MAX_OUTLINE_WIDTH"),l=r.getColor("LEGEND_TICK_MIN_MAX_OUTLINE_COLOR"),u=r.getNumber("LEGEND_TICK_CLICK_TARGET_WIDTH_PX"),d=r.getNumber("LEGEND_TICK_TEXT_GAP_PX"),g=this.isVertical?this.colorMapCorners.topRight.x:this.colorMapCorners.topRight.y,p=this.isVertical?this.colorMapCorners.bottomLeft.x-a:this.colorMapCorners.bottomLeft.y-a,m=this.createTick(n,g,p,.45,i,l,c);this.updateMeshIncrement(i+"outline",i,m,Ch);const f=this.createTick(n,g,p,Hh,i,o,h);this.updateMeshIncrement(i,i,f,Ch);const I=this.createTick(n,g,p,Hh,i,o,u);if(this.updateMeshIncrement(i+"target",i,I,yh),t&&this.tickBeingDragged===Dh.s.MAX||!t&&this.tickBeingDragged===Dh.s.MIN){const e=this.manager.getValueString(s),t="",r=!0;if(this.isVertical){const s=k.d0F.fromArray([p-d,n,Hh]);this.placeText(e,s,yi.iK.HIGH,yi.iK.MID,t,i,r)}else{const s=k.d0F.fromArray([n,p-d,Hh]);this.placeText(e,s,yi.iK.MID,yi.iK.HIGH,t,i,r)}}}createTick(e,t,i,s,n,r,a){let o;return o=this.isVertical?(0,Au.W5)([i,e,s],[t,e,s],n,r):(0,Au.W5)([e,i,s],[e,t,s],n,r),(0,Au.VQ)(a,o),o}placeText(e,t,i,s,n,r,a){const o={...r?this.clickableFontOptions:this.defaultFontOptions};o.size=Math.floor(X.default.getManager().getNumber("LEGEND_TICK_TEXT_HEIGHT_PX"));const h=this.getOrCreateText(e,o);if(h.positionRelativeTo([t.x,t.y,t.z],i,s),r){this.listenTo(h,Ti.zw.MOUSE_ENTER+Da.SELECTION_ID,(()=>{this.viewer.pushCursor(Xh),h.updateWithOptions(this.hoverFontOptions)})),this.listenTo(h,Ti.zw.MOUSE_LEAVE+Da.SELECTION_ID,(()=>{this.onMouseLeavePopCursor(Xh),h.updateWithOptions(this.clickableFontOptions)}));const e=this.getInputRangeInDisplayUnits();this.listenTo(h,Ti.zw.CLICK+Da.SELECTION_ID,((t,i)=>{this.viewer.getEventDispatcher().trigger(r,i.sourceEvent,e,h.getTextCenterInCanvas())}))}if(a){const e=h.getTransformedBounds().getXyBounds();for(let t=0;t<this.valueTextElements.length;++t){const i=this.valueTextElements[t];e.overlapsWith(i.text.getTransformedBounds().getXyBounds())&&(i.text.hide(),i.associatedTickId&&this.hideIncrement(i.associatedTickId))}}this.valueTextElements.push({text:h,associatedTickId:n})}getColorMapCorners(){return this.colorMapCorners}show(){this.isPendingShow=!0,uo(this.defaultFontOptions,this.clickableFontOptions,this.hoverFontOptions).catch((e=>{ut.log.warn(`failed to load font for scalar visualization legend: ${e}`)})).finally((()=>{this.isPendingShow&&(this.isPendingShow=!1,super.show())}))}}var Kh=i(21592);class jh{constructor(e){this.modelViewManager=e,this.supportsInContextMode=!1,this.nodes=[],this.visualizationStateSubject=new Is.x,this.DEFAULT_COLOR_MAPPING=k.ZIP.VIRIDIS,this.scalarVisualizationMaterials=[],this.keepLegendHiddenAndAllowControls=!1,this.webAssemblyUtils=Zm.module}cloneVisualizationState(e){return e.clone()}static getMapIndex(e){return jh.imageMaps.findIndex((t=>t.type===e))}viewerIsInScalarVisualizationRenderMode(){return this.getViewer().getRenderingMode()===this.graphicsRenderMode}usesGraphicsRenderMode(e){return e===this.graphicsRenderMode}getRangeInData(){return this.displayedScalarRangeSpecification?this.displayedScalarRangeSpecification.rangeInData:null}setRangeInData(e){this.displayedScalarRangeSpecification?(this.displayedScalarRangeSpecification.rangeInData=e,this.getDefaultDisplayRange()||this.setVisualizedRange(e)):ut.log.debug("Tried to set rangeInData but displayedScalarRangeSpecification was null")}getDefaultDisplayRange(){return this.displayedScalarRangeSpecification?this.displayedScalarRangeSpecification.defaultDisplayRange:null}updateDefaultDisplayRange(e){this.displayedScalarRangeSpecification?this.displayedScalarRangeSpecification.defaultDisplayRange=e:ut.log.debug("Tried to set defaultDisplayRange but displayedScalarRangeSpecification was null")}setDefaultDisplayRange(e){this.updateDefaultDisplayRange(e),this.setVisualizedRange(e)}getSupportsInContextMode(){return this.supportsInContextMode}getColorMappingName(){const{colorMapping:e}=this.visualizationState;return k.hDy[e]}getMinHighlightColor(){const e=X.default.getManager(),t=this.getColorMappingName();return e.getColor(jh.MIN_COLOR_CONSTANT+t)}getMaxHighlightColor(){const e=X.default.getManager(),t=this.getColorMappingName();return e.getColor(jh.MAX_COLOR_CONSTANT+t)}getDimHighlightColor(){const e=X.default.getManager(),t=this.getColorMappingName();return e.getColor(jh.DIM_COLOR_CONSTANT+t)}updateScalarRangeUniforms(){const e=this.getRangeInData();if(!e||!this.visualizedScalarRange)return;const t=e.max,i=e.magnitude;let s=1/i;i<=Ci.W.ZERO_LENGTH?(s=0,i<0&&ut.log.debug("Invalid scalar input range")):i>16777216&&ut.log.info(`Scalar range had a magnitude greater than 1.67e+7: ${i} for ${this.VISUALIZATION_MANAGER_NODE_ID}`);const n=this.getRangeInBaseUnits(this.visualizedScalarRange),r=n.max,a=n.magnitude,o=1/a,h=X.default.getManager(),c=this.getMinHighlightColor(),l=this.getMaxHighlightColor(),u=this.getDimHighlightColor(),d=h.getNumber(jh.BLEND_WIDTH_CONSTANT),g=1/d,p=this.getUseMinValueHighlight()?1:0,m=this.getUseMaxValueHighlight()?1:0,f=this.getUseDimColorScale()?1:0;for(const e of this.scalarVisualizationMaterials)e.setCustomFloatUniform(jh.SCALAR_INPUT_MAXIMUM_UNIFORM,t),e.setCustomFloatUniform(jh.SCALAR_INPUT_MAGNITUDE_INVERSE_UNIFORM,s),e.setCustomFloatUniform(jh.SCALAR_OUTPUT_MAXIMUM_UNIFORM,r),e.setCustomFloatUniform(jh.SCALAR_OUTPUT_MAGNITUDE_UNIFORM,a),e.setCustomFloatUniform(jh.SCALAR_OUTPUT_MAGNITUDE_INVERSE_UNIFORM,o),e.setCustomIntUniform(jh.USE_MIN_VALUE_UNIFORM,p),e.setCustomIntUniform(jh.USE_MAX_VALUE_UNIFORM,m),e.setCustomIntUniform(jh.USE_DIM_COLOR_UNIFORM,f),e.setCustomVectorUniform(jh.MIN_COLOR_UNIFORM,c),e.setCustomVectorUniform(jh.MAX_COLOR_UNIFORM,l),e.setCustomVectorUniform(jh.DIM_COLOR_UNIFORM,u),e.setCustomFloatUniform(jh.HIGHLIGHT_REGION_BLEND_DISTANCE,d),e.setCustomFloatUniform(jh.HIGHLIGHT_REGION_BLEND_INVERSE_DISTANCE,g)}getUseMinValueHighlight(){return!1}getUseMaxValueHighlight(){return!1}getUseDimColorScale(){return!1}getVisualizationState(){return this.visualizationState}getVisualizationStateObservable(){return this.visualizationStateSubject.asObservable()}getRangeInDisplayUnits(e){return e}getValueInDisplayUnits(e){return e}getRangeInBaseUnits(e){return e}convertValueBetweenDisplayAndBaseUnits(e,t){return e}setVisualizationState(e){const t=this.visualizationState?this.displayedColorMap:null,i=null===t||t!==e.colorMapping,s=!this.visualizationState||!this.visualizationState.visualizedRange||!this.visualizationState.visualizedRange.equals(e.visualizedRange);this.visualizationState=e,this.visualizationStateSubject.next(e),this.updateGraphics(),i&&this.updateColorMapping(t,this.visualizationState.colorMapping),s&&this.updateVisualizedScalarRange(),this.readyToShowLegend()||this.hideLegend()}setVisualizedRange(e){const t=this.cloneVisualizationState(this.getVisualizationState());t.visualizedRange=e,this.setVisualizationState(t)}setVisualizedScaleComponent(e,t,i){const s=this.convertValueBetweenDisplayAndBaseUnits(e,!0),n=this.visualizedScalarRange?.clone();switch(t){case Dh.s.MAX:n.max=s,this.visualizationState.userSetRangeMax=i;break;case Dh.s.MIN:n.min=s,this.visualizationState.userSetRangeMin=i}this.setVisualizedRange(n)}resetVisualizedScaleRangeComponent(e){const t=this.getVisualizedScaleResetValue(e),i=this.convertValueBetweenDisplayAndBaseUnits(t,!1);this.setVisualizedScaleComponent(i,e,!1)}getVisualizedScaleResetValue(e){return this.getDefaultDisplayRange().getValueFromRangeComponent(e)}setColorMapping(e){if(e===this.displayedColorMap)return;localStorage.setItem(this.COLOR_MAP_STORAGE_KEY,""+e);const t=this.getVisualizationState().clone();t.colorMapping=e,this.setVisualizationState(t)}onRenderingModeChanged(){this.prepareResources(),this.viewerIsInScalarVisualizationRenderMode()?this.showLegend():(this.clearGraphics(),this.hideLegend())}clearGraphics(){this.resetScenegraphNodes(),this.cursorAppendage&&(this.cursorAppendage.destroy(),this.cursorAppendage=null),this.hideLegend(),this.getViewer().requestDraw()}updateVisualizedScalarRange(){if(this.updateScalarRangeUniforms(),this.legend&&this.visualizedScalarRange){const e=this.getRangeInDisplayUnits(this.visualizedScalarRange);this.legend.setVisualizedScalarRange(e)}this.getViewer().requestDraw()}updateColorMapping(e,t){this.hideMapping(e),this.showMapping(t),this.updateVisualizedScalarRange()}get displayedColorMap(){return this.visualizationState?this.visualizationState.colorMapping:(ut.log.warn("No visualization state set"),k.ZIP.UNKNOWN)}hideMapping(e){const t=jh.getMapIndex(e),i=this.nodes[t];i&&i.setVisible(!1)}showMapping(e){const t=jh.getMapIndex(e),i=this.nodes[t];i&&i.setVisible(!0),this.legend&&this.legend.setActiveColorMapping(e),this.showLegend()}showLegend(){this.legend&&this.readyToShowLegend()&&this.legend.isHidden&&(this.keepLegendHiddenAndAllowControls||this.legend.show(),this.getViewer().getEventDispatcher().trigger(this.LEGEND_OPENED,this.displayedColorMap))}hideLegend(){this.legend&&(this.legend.hide(),this.getViewer().getEventDispatcher().trigger(this.LEGEND_CLOSED))}setKeepLegendHiddenAndAllowControls(e){this.keepLegendHiddenAndAllowControls=e,this.keepLegendHiddenAndAllowControls&&this.legend&&this.legend.hide()}get visualizedScalarRange(){return this.visualizationState?this.visualizationState.visualizedRange:(ut.log.debug("Visualization state undefined when trying to get visualized range"),null)}resetScenegraphNodes(){if(this.rootNode){for(let e=0;e<this.nodes.length;++e)this.nodes[e].remove();this.nodes=[];for(let e=0;e<jh.imageMaps.length;++e){const t=new xi.NB(this.VISUALIZATION_MANAGER_NODE_ID+"."+e,{isPickable:!1,clippedBySectionPlanes:!0});t.setVisible(!1),this.nodes.push(t),this.rootNode.addChild(t)}}}getViewer(){return this.modelViewManager.getViewer()}readyToShowLegend(){return!1}createMaterialForTexture(e){const t=new Ni({ambientTexture:e});return t.shaderId="scalarVisualization",t}prepareResources(){if(0===this.scalarVisualizationMaterials.length&&this.getViewer().getGlContext())for(let e=0;e<jh.imageMaps.length;++e){const t=new ja(this.getViewer().getGlContext());t.imageSource=jh.imageMaps[e].source;const i=new $a(this.getViewer(),t);i.setHasTransparency(!1),this.getViewer().getResources().scalarVisualizationTextures.set(jh.imageMaps[e].type,i);const s=this.createMaterialForTexture(i);s.setCustomFloatUniform("uOffsetFactor",0),s.setCustomIntUniform("uMakeUnsigned",0),this.scalarVisualizationMaterials.push(s)}if(!this.rootNode){const e=this.modelViewManager.getSharedBodyNode();this.rootNode=e.getChildById(this.VISUALIZATION_MANAGER_NODE_ID),this.rootNode||(this.rootNode=new xi.NB(this.VISUALIZATION_MANAGER_NODE_ID),e.addChild(this.rootNode))}}getCursorValue(e,t){const i=k.YFv.fromArray([e,this.getViewer()?.getCamera()?.getViewportHeight()-t]);return this.legend?.isBeingDragged||!this.getRangeInData()?null:this.legend&&this.legend.areCoordinatesOverLegend(i)&&this.visualizedScalarRange?this.legend.getValueFromCoordinatesInVisualizedRange(i):this.findScalarVisualizationScalar(e,t)}getCursorText(e,t){if(this.legend?.isBeingDragged||!this.getRangeInData())return null;{const i=this.getCursorValue(e,t);if(null===i)return;return this.getValueString(i)}}findScalarVisualizationScalar(e,t){const i=this.getViewer().findScalarVisualizationScalar(this.VISUALIZATION_MANAGER_NODE_ID,this.getRangeInDisplayUnits(this.getRangeInData()),e,t);return 0===i.length?null:i[0].scalar}getValueString(e){const t=(0,nr.vx)().getLengthUnitsDisplayPrecision(),i=Kh.l.ScalarVisualization,s=1/Math.pow(10,Ci.W.SCALAR_VISUALIZATION_MAX_DECIMAL_PRECISION);return Kh.c.getNumberString(e,t,i,s)}isNodeForBodyVisualization(e){return 0===e.getId().indexOf(this.VISUALIZATION_MANAGER_NODE_ID)}getStoredColorMapping(){const e=localStorage.getItem(this.COLOR_MAP_STORAGE_KEY);return e&&Object.values(k.ZIP).includes(+e)?+e:this.DEFAULT_COLOR_MAPPING}getSampleMesh(e,t){return t.refinementHistory.history.length>0?this.webAssemblyUtils&&this.webAssemblyUtils.isReady?this.webAssemblyUtils.replaySampleMeshRefinementRoutine(e.sampleMesh,t.refinementHistory):(ut.log.debug("Received refinement history for simulation data, but sampling utils module was not available"),e.sampleMesh):e.sampleMesh}}jh.SCALAR_INPUT_MAXIMUM_UNIFORM="uScalarInputMax",jh.SCALAR_INPUT_MAGNITUDE_INVERSE_UNIFORM="uScalarInputMagnitudeInverse",jh.SCALAR_OUTPUT_MAXIMUM_UNIFORM="uScalarOutputMax",jh.SCALAR_OUTPUT_MAGNITUDE_UNIFORM="uScalarOutputMagnitude",jh.SCALAR_OUTPUT_MAGNITUDE_INVERSE_UNIFORM="uScalarOutputMagnitudeInverse",jh.USE_MIN_VALUE_UNIFORM="uUseMinColor",jh.USE_MAX_VALUE_UNIFORM="uUseMaxColor",jh.USE_DIM_COLOR_UNIFORM="uUseDimColor",jh.MIN_COLOR_UNIFORM="uMinColor",jh.MAX_COLOR_UNIFORM="uMaxColor",jh.DIM_COLOR_UNIFORM="uDimColor",jh.HIGHLIGHT_REGION_BLEND_DISTANCE="uHighlightRegionBlendDistance",jh.HIGHLIGHT_REGION_BLEND_INVERSE_DISTANCE="uHighlightRegionBlendDistanceInverse",jh.MIN_COLOR_CONSTANT="SCALAR_MIN_COLOR_",jh.MAX_COLOR_CONSTANT="SCALAR_MAX_COLOR_",jh.DIM_COLOR_CONSTANT="SCALAR_DIM_COLOR_",jh.BLEND_WIDTH_CONSTANT="SCALAR_HIGHLIGHT_BLEND_WIDTH",jh.imageMaps=[{type:k.ZIP.VIRIDIS,source:"/images/scalar-visualization-gradient-viridis.png"},{type:k.ZIP.RAINBOW,source:"/images/scalar-visualization-gradient-rainbow.png"},{type:k.ZIP.BLUE_RED,source:"/images/scalar-visualization-gradient.png"},{type:k.ZIP.PLASMA,source:"/images/scalar-visualization-gradient-plasma.png"}];var Qh=i(90923);class $h extends Yh{constructor(e){super(e)}getRelevantPanelIdsForRepositioning(){return[...super.getRelevantPanelIdsForRepositioning(),Qh.i]}get SNAPPING_MARGIN_TOP(){return X.default.getManager().getNumber(this.TOP_TOOPBAR_HEIGHT_CONSTANT)+(0,$i.NO)(this.CANVAS_CONTROLS_PANEL_ID)*(0,Ji.x_)()}}class Jh extends jh{constructor(){super(...arguments),this.supportsInContextMode=!0}}class ec extends $h{constructor(e){super(e),this.manager=e,this.LEGEND_MAXIMUM_CLICKED=is.fdd,this.LEGEND_MINIMUM_CLICKED=is.ibh,this.LEGEND_RANGE_CHANGED=is.JHq,this.CANVAS_CONTROLS_PANEL_ID=is.Wzm,this.TOP_TOOPBAR_HEIGHT_CONSTANT="CURVATURE_ANALYSIS_TOP_TOOLBAR_HEIGHT_PX"}getInputRangeValueString(e){return this.manager.getInputRangeBoundaryString(e)}isInputMaximumChanged(){const e=this.manager.getRangeInData();return!!(e&&e.max>ac)||super.isInputMaximumChanged()}getInputRangeInDisplayUnits(){return this.manager.getRangeInDisplayUnits(this.manager.getRangeInData())}getDefaultDisplayRangeInDisplayUnits(){return this.manager.getRangeInDisplayUnits(this.manager.getDefaultDisplayRange())}}var tc=i(49258),ic=i(2524),sc=i(67079),nc=i(37018);const rc="meter",ac=1e4,oc="CurvatureAnalysisManager",hc=k.ls1.getTessellationSettingIndexFromEnum(k.XiJ.CURVATURE_VISUALIZATION);class cc extends Jh{constructor(e){super(e.getModelViewManagers().getManager()),this.viewer=e,this.COLOR_MAP_STORAGE_KEY=tc.xV,this.LEGEND_OPENED=is.A1q,this.LEGEND_CLOSED=is.Nwl,this.VISUALIZATION_MANAGER_NODE_ID=oc,this.graphicsRenderMode=k.P1.SHADED_CURVATURE_VISUALIZATION,this.DEFAULT_COLOR_MAPPING=sc.z,this.messageBubble=Ki.Jq.MessageBubbleService.createMessageBubbleWithAutoDismiss("warning"),this.visualizedRangeCache=new Map,this.curvatureTypeCache=new Map,this.displayedScalarRangeSpecification={rangeInData:null,defaultDisplayRange:null},this.visualizationState=new k.AON,this.mainScenegraphManager=new uc(this.modelViewManager,"CurvatureAnalysis",this.scalarVisualizationMaterials),this.resetMeshes(),this.setColorMapping(this.getStoredColorMapping()),(0,yD.eR)(yD.Cr).subscribe((()=>{this.updateVisualizedScalarRange()}))}getViewer(){return this.viewer}isVisualizing(){return this.mainScenegraphManager.isVisualizing()||!!this.previewScenegraphManager?.isVisualizing()}resetScenegraphNodes(){this.mainScenegraphManager.resetScenegraphNodes(),this.previewScenegraphManager?.resetScenegraphNodes()}hideMapping(e){this.mainScenegraphManager.hideMapping(e),this.previewScenegraphManager?.hideMapping(e),super.hideMapping(e)}showMapping(e){this.mainScenegraphManager.showMapping(e),this.previewScenegraphManager?.showMapping(e),super.showMapping(e)}updateGraphics(){if(this.viewerIsInScalarVisualizationRenderMode()){if(this.cursorAppendage||(this.cursorAppendage=new ts(this.getViewer(),((e,t)=>this.getCursorText(e,t)))),this.followModeCursorAppendage||(this.followModeCursorAppendage=new ss(this.getViewer(),((e,t)=>this.getCursorText(e,t)))),this.readyToShowLegend()){const e=this.getRangeInData(),t=this.getDefaultDisplayRange();this.legend.setInputRange({rangeInData:e,defaultDisplayRange:t})}this.showMapping(this.displayedColorMap),this.updateVisualizedScalarRange()}}convertValueBetweenDisplayAndBaseUnits(e,t){const i=(0,nr.vx)().getLengthUnits();if(!i)return null;const s=this.getCurvatureTypeUnitPower(),n={[i]:s},r={[rc]:s};return t?(0,rr.NI)(e,n,r):(0,rr.NI)(e,r,n)}getRangeInDisplayUnits(e){const t=(0,nr.vx)().getLengthUnits();return e&&t?(0,rr.u0)(e,t,this.getCurvatureTypeUnitPower()):null}getRangeInBaseUnits(e){return(0,rr.u0)(e,rc,this.getCurvatureTypeUnitPower())}getRangeInData(){let e;return e=Ns()?this.previewScenegraphManager?.getRangeInData()??this.mainScenegraphManager.getRangeInData():this.mainScenegraphManager.getRangeInData()??this.previewScenegraphManager?.getRangeInData(),e?.addUnits(rc,this.getCurvatureTypeUnitPower())}getClampedRangeInData(){let e;return e=Ns()?this.previewScenegraphManager?.getClampedRangeInData()??this.mainScenegraphManager.getClampedRangeInData():this.mainScenegraphManager.getClampedRangeInData()??this.previewScenegraphManager?.getClampedRangeInData(),e?.addUnits(rc,this.getCurvatureTypeUnitPower())}setRangeInData(e){this.mainScenegraphManager.setRangeInData(e),this.previewScenegraphManager?.setRangeInData(e)}setClampedRangeInData(e){this.mainScenegraphManager.setClampedRangeInData(e),this.previewScenegraphManager?.setClampedRangeInData(e)}readyToShowLegend(){return this.viewerIsInScalarVisualizationRenderMode()&&!!this.legend}prepareResources(){super.prepareResources(),this.legend||(this.legend=new ec(this)),this.mainScenegraphManager.prepareResources(),this.previewScenegraphManager?.prepareResources()}clearAndUpdateCurvatures(){this.clearGraphics(),this.requestMissingCurvatureTessellations(),this.mainScenegraphManager.updateNodesWithCurvatureData(),this.getOrCreatePreviewScenegraphManager()?.updateNodesWithCurvatureData(),this.updateScalarRangeFromCurvatureData(),null===this.getRangeInData()&&this.legend?.clearRanges(),this.showLegend(),this.updateGraphics()}onRenderingModeChanged(){super.onRenderingModeChanged(),this.viewerIsInScalarVisualizationRenderMode()&&this.modelViewManager.displayingPartStudio()?(this.getViewer().getUserEnabledAggressiveRefinement()&&this.getViewer().setUserEnabledAggressiveRefinement(!1),this.clearAndUpdateCurvatures()):((this.isVisualizing()||this.mainScenegraphManager.getDisplayedPartStudioHasPendingTessellationRequests()||this.previewScenegraphManager?.getDisplayedPartStudioHasPendingTessellationRequests())&&this.getViewer().getEventDispatcher().trigger(yD.Jp),this.clearScalarVisualizationForVisualizedBodies())}onDocumentDestroyed(){this.mainScenegraphManager.clearPendingTessellationRequests(),this.destroyPreviewScenegraphManager(),this.curvatureTypeCache=new Map}onDocumentReconnect(){this.mainScenegraphManager.clearPendingTessellationRequests(),this.previewScenegraphManager?.clearPendingTessellationRequests()}onPreviewDestroyed(){this.destroyPreviewScenegraphManager(),this.readyToShowLegend()||this.hideLegend()}onEstimatedMemoryLimitExceeded(e=!1){e&&this.viewer.resetToDefaultRenderingMode(),this.messageBubble.showMessage(i18n("Color map may exceed browser memory limits. Try hiding unnecessary parts or surfaces.")),Ki.Jq.AngularEventService.ensureDigest()}destroyPreviewScenegraphManager(){this.previewScenegraphManager?.resetMeshes(),this.previewScenegraphManager=null}preventChangeToRenderMode(e){if(this.graphicsRenderMode!==e)return!1;if(ws())return this.messageBubble.showMessage(i18n("Curvature color map is not currently supported while comparing.")),Ki.Jq.AngularEventService.ensureDigest(),!0;if(ci._3.getOpenDocumentController().isInterferenceDetectionActive())return this.messageBubble.showMessage(i18n("Curvature color map is not currently supported during interference detection.")),Ki.Jq.AngularEventService.ensureDigest(),!0;const t=this.mainScenegraphManager.getBodiesToVisualize()??new Set,i=this.previewScenegraphManager?.getBodiesToVisualize()??new Set;return!this.getViewer().getBodyManager().checkBodiesUnderMemoryLimit(hc,new Set([...t,...i]))&&(this.onEstimatedMemoryLimitExceeded(),!0)}onCheckInterferences(){this.graphicsRenderMode===this.getViewer().getRenderingMode()&&(Ki.Jq.MessageBubbleService.showMessageWithAutoDismiss(i18n("Curvature color map is not currently supported during interference detection."),"warning"),Ki.Jq.AngularEventService.ensureDigest(),this.getViewer().resetToDefaultRenderingMode())}userCanEnableColorMap(){const e=ci._3.getOpenDocumentController().isInterferenceDetectionActive(),t=ws();return!e&&!t}onPartStudioDisplayed(){this.viewerIsInScalarVisualizationRenderMode()&&this.setCurvatureType(this.getCachedCurvatureTypeForElement())}onPartStudioDisplayDataChanged(e,t){if(!e.isNoop&&this.viewerIsInScalarVisualizationRenderMode()){if(e.hasCurvatureTessellation())this.clearAndUpdateCurvatures();else{this.requestMissingCurvatureTessellations()||this.clearAndUpdateCurvatures()}this.updateFollowModeCache()}}getCachedCurvatureTypeForElement(){const e=this.getViewer().getActiveElementId(),t=this.curvatureTypeCache.get(e);return t&&t!==k.Lck.UNKNOWN?t:k.Lck.GAUSSIAN}onChangeActiveElement(){this.clearGraphics()}clearGraphics(){this.clearScalarVisualizationForVisualizedBodies(),this.messageBubble.dismissMessage(),this.legend?.clearRanges(),this.setRangeInData(null),this.setClampedRangeInData(null),this.setDefaultDisplayRange(null),this.resetMeshes(),this.followModeCursorAppendage?.destroy(),this.followModeCursorAppendage=null,super.clearGraphics()}resetMeshes(){this.mainScenegraphManager?.resetMeshes(),this.previewScenegraphManager?.resetMeshes()}requestMissingCurvatureTessellations(){const e=this.mainScenegraphManager.getBodiesThatNeedCurvatureTessellations()??[],t=this.getOrCreatePreviewScenegraphManager()?.getBodiesThatNeedCurvatureTessellations()??[],i=new Set(e.concat(t));if(0===i.size)return!1;return this.requestCurvatureData(i)?(this.onEstimatedMemoryLimitExceeded(!0),!1):(this.mainScenegraphManager.didRequestCurvatureDataForBodies(e),this.getOrCreatePreviewScenegraphManager()?.didRequestCurvatureDataForBodies(t),!0)}getOrCreatePreviewScenegraphManager(){if(!this.previewScenegraphManager){const e=this.getViewer().getModelViewManagers().getPreviewManager(),t=e?.getDisplayedPartStudio();if(!t)return null;this.previewScenegraphManager=new uc(e,"CurvatureAnalysisPreview",this.scalarVisualizationMaterials),this.previewScenegraphManager.prepareResources(),this.previewScenegraphManager.setCurvatureType(this.getCurvatureType())}return this.previewScenegraphManager}clearScalarVisualizationForVisualizedBodies(){this.mainScenegraphManager.isVisualizing()&&this.mainScenegraphManager.getBodyComponent()?.clearAllScalarVisualizationOccurrences(),this.previewScenegraphManager?.isVisualizing()&&this.previewScenegraphManager?.getBodyComponent()?.clearAllScalarVisualizationOccurrences()}requestCurvatureData(e){if(!e||0===e.size)return!1;const t=[];if(!this.viewer.getBodyManager().checkBodiesUnderMemoryLimit(hc,e))return!0;for(const i of e){const e=new k.A$B;e.bodyDeterministicId=i,e.tessellationSetting=hc,e.occurrence=null,e.elementId=this.modelViewManager.getDisplayedElementId(),e.microversionIdAndConfiguration=this.modelViewManager.getDisplayedElementMicroversionIdAndConfiguration(),t.push(e)}return this.getViewer().getEventDispatcher().trigger(yD.am,t),!1}setVisualizedScaleComponent(e,t,i){super.setVisualizedScaleComponent(e,t,i),this.updateVisualizedRangeCache()}getCurvatureTypeUnitPower(){switch(this.getCurvatureType()){case k.Lck.GAUSSIAN:return-2;case k.Lck.MEAN:return-1;case k.Lck.MAX_RADIUS:case k.Lck.MIN_RADIUS:default:return 1}}getBaseUnitsRange(e,t){return k.dGY.fromMinMax(e,t,rc,this.getCurvatureTypeUnitPower())}updateScalarRangeFromCurvatureData(){const e=this.getCachedRange(),t=this.getClampedRangeInData();this.updateDefaultDisplayRange(t);const i=this.getRangeInData(),s=this.convertValueBetweenDisplayAndBaseUnits(1,!0);if(i&&0===i.magnitude){let e;e=this.isInCurvatureRadiusMode()&&i.mean>ac?this.getBaseUnitsRange(0,s):this.isInCurvatureRadiusMode()&&i.mean<s?this.getBaseUnitsRange(0,2*i.mean):this.getBaseUnitsRange(i.mean-s,i.mean+s),this.updateDefaultDisplayRange(e)}e?this.setVisualizedRange(e):this.setVisualizedRange(this.getDefaultDisplayRange())}resetVisualizedScaleRangeComponent(e){super.resetVisualizedScaleRangeComponent(e),this.updateVisualizedRangeCache()}getVisualizedScaleResetValue(e){const t=this.getDefaultDisplayRange();switch(e){case Dh.s.MIN:return t.min;case Dh.s.MAX:return this.isInCurvatureRadiusMode()?Math.min(t.max,ac):t.max}}setCurvatureType(e){if(this.getCurvatureType()===e)return;const t=this.getVisualizationState().clone();t.curvatureType=e,this.setVisualizationState(t)}updateCurvatureType(e){this.mainScenegraphManager.setCurvatureType(e),this.previewScenegraphManager?.setCurvatureType(e),this.clearAndUpdateCurvatures();const t=this.getViewer().getActiveElementId();this.curvatureTypeCache.set(t,e)}getCurvatureType(){return this.visualizationState.curvatureType}moveLegendTo(e,t){if(!e||e.some((e=>!isFinite(e)))||!this.legend)return;this.legend.colorMapCorners?.bottomLeft||this.legend.setupCorners();const i=(0,Ji.x_)(),s=e.map((e=>e*i));this.legend.setIsVertical(t);const n=this.legend.colorMapCorners.topRight.y-this.getViewer().getCamera().getCanvasHeight()+s[1],r=this.legend.colorMapCorners.bottomLeft.x-s[0],a=k.YFv.fromXY(r,n);a.isZeroVector()||this.legend.moveLegend(a,void 0,!0)}getLegend(){return this.legend}getLegendMovedObservable(){return this.prepareResources(),this.legend.getLegendMovedObservable()}isInCurvatureRadiusMode(){return this.getCurvatureType()===k.Lck.MAX_RADIUS||this.getCurvatureType()===k.Lck.MIN_RADIUS}onReceiveFollowModeMessage(e){if(!e||!e.visualizationState||!this.followViewDataMessageCache)return;this.setCurvatureType(e.visualizationState.curvatureType);const t=e.legendTopLeftCoordinates.slice(),i=nc.D.convertCanvasCoordinateLeaderToFollower(t,this.followViewDataMessageCache);this.moveLegendTo(i,e.legendIsVertical),this.shouldUpdateVisualizationStateFromMessage(e)?this.updateVisualizationStateFromMessage(e):this.followModeMessageCache=e}onReceiveFollowViewDataMessage(e){this.followViewDataMessageCache=e}shouldUpdateVisualizationStateFromMessage(e){return e&&this.getRangeInData()?.equals(e.rangeInData,Ci.W.ZERO_LENGTH)}updateVisualizationStateFromMessage(e){const t=e.visualizationState;t.visualizedRange?.noRange||(this.setVisualizationState(t),this.updateVisualizedRangeCache())}updateFollowModeCache(){this.followModeMessageCache&&((0,Fs.sW)()?this.shouldUpdateVisualizationStateFromMessage(this.followModeMessageCache)&&(this.updateVisualizationStateFromMessage(this.followModeMessageCache),this.followModeMessageCache=null):this.followModeMessageCache=null)}setVisualizationState(e){const t=this.getCurvatureType()!==e.curvatureType;super.setVisualizationState(e),t&&this.updateCurvatureType(e.curvatureType)}getCursorText(e,t){if(this.legend?.isBeingDragged||!this.getRangeInData())return null;{const i=this.getCursorValue(e,t);if(!(0,ic.isNumber)(i))return;const s=!0;if(this.isInCurvatureRadiusMode()&&this.convertValueBetweenDisplayAndBaseUnits(i,s)>ac)return"♾️";const n=(0,nr.vx)().getLengthUnitsDisplayPrecision(),r=Kh.l.UserWorkspace,a=1/Math.pow(10,n);return Kh.c.getNumberString(i,n,r,a)}}getInputRangeBoundaryString(e){const t=this.getRangeInData(),i=t.getValueFromRangeComponent(e);if(this.isInCurvatureRadiusMode()&&i>ac)return"♾️";const s=this.getRangeInDisplayUnits(t).getValueFromRangeComponent(e);return this.getValueString(s)}updateVisualizedRangeCache(){const e=this.getViewer().getActiveElementId();if(!this.visualizedScalarRange||0===e.length)return;let t,i=this.visualizedRangeCache.get(e);i||(i=new Map),t=this.visualizedScalarRange.equals(this.getDefaultDisplayRange())?null:this.visualizedScalarRange,i.set(this.getCurvatureType(),t),this.visualizedRangeCache.set(e,i)}getCachedRange(){const e=this.getViewer().getActiveElementId(),t=this.visualizedRangeCache.get(e);return t?t.get(this.getCurvatureType())??null:null}}const lc=new Float32Array(2);class uc{constructor(e,t,i){this.modelViewManager=e,this.parentNodeId=t,this.scalarVisualizationMaterials=i,this.nodes=[],this.VISUALIZATION_MANAGER_NODE_ID=oc,this.meshOwnerId=PS(),this.bodyIdsWithPendingTessellationRequest=new Map,this.resetMeshes()}isVisualizing(){return!!this.getBodyComponent()?.isVisualizingOccurrences()}getViewer(){return this.modelViewManager.getViewer()}getBodyComponent(){return this.getDisplayedPartStudio()?.getBodyComponent()}getDisplayedPartStudio(){return this.modelViewManager.getDisplayedPartStudio()}setCurvatureType(e){this.curvatureType=e}getCurvatureType(){return this.curvatureType}setBodyHasPendingTessellationRequest(e,t){if(!t)return;const i=this.bodyIdsWithPendingTessellationRequest.get(t)??new Set;i.add(e),this.bodyIdsWithPendingTessellationRequest.set(t,i)}unsetBodyHasPendingTessellationRequest(e,t){const i=this.bodyIdsWithPendingTessellationRequest.get(t);i&&(i.delete(e),this.bodyIdsWithPendingTessellationRequest.set(t,i))}getBodyHasPendingTessellationRequest(e,t){const i=this.bodyIdsWithPendingTessellationRequest.get(t);return i&&i.has(e)}getDisplayedPartStudioHasPendingTessellationRequests(){const e=this.getDisplayedPartStudio()?.getElementId();if(!e)return!1;const t=this.bodyIdsWithPendingTessellationRequest.get(e);return t&&t.size>0}clearPendingTessellationRequests(){this.bodyIdsWithPendingTessellationRequest=new Map}prepareResources(){if(!this.rootNode){const e=this.modelViewManager.getSharedBodyNode();this.rootNode=e.getChildById(this.VISUALIZATION_MANAGER_NODE_ID),this.rootNode||(this.rootNode=new xi.NB(this.VISUALIZATION_MANAGER_NODE_ID),e.addChild(this.rootNode))}if(this.resetScenegraphNodes(),!this.nodePropertiesSolids||0===this.nodePropertiesSolids.length||!this.nodePropertiesSurfaces||0===this.nodePropertiesSurfaces.length){this.nodePropertiesSolids=[],this.nodePropertiesSurfaces=[];for(let e=0;e<cc.imageMaps.length;++e){const t=this.scalarVisualizationMaterials[e];t.ambientTextureFactor=0;const i=new xi.hF({material:t,zOffset:X.default.getManager().getNumber("PART_FACES_Z_OFFSET"),primitiveType:Di.MX.TRIANGLES,includedInBlend:!0,clippedBySectionPlanes:!0,isPickable:!1,isTwoSided:!1});this.nodePropertiesSolids.push(i);const s={zOffset:X.default.getManager().getNumber("SURFACE_Z_OFFSET"),isTwoSided:!0},n=i.cloneAndModify(s);this.nodePropertiesSurfaces.push(n)}}}resetScenegraphNodes(){if(this.rootNode){for(let e=0;e<this.nodes.length;++e)this.nodes[e].remove();this.nodes=[];for(let e=0;e<jh.imageMaps.length;++e){const t=new xi.NB(this.VISUALIZATION_MANAGER_NODE_ID+"."+e,{isPickable:!1,clippedBySectionPlanes:!0});t.setVisible(!1),this.nodes.push(t),this.rootNode.addChild(t)}}}hideMapping(e){const t=jh.getMapIndex(e),i=this.nodes[t];i&&i.setVisible(!1)}showMapping(e){const t=jh.getMapIndex(e),i=this.nodes[t];i&&i.setVisible(!0)}resetMeshes(){this.meshManager&&this.meshManager.destroy(),this.meshManager=new AS(this.getViewer(),{bufferAllocationPolicy:$f.MAXIMUM})}updateNodesWithCurvatureData(){const e=this.getBodyComponent();if(!e)return;const t=new Qo.B7(`CurvatureAnalysisManager.updateNodesWithCurvatureData - Usage: ${this.modelViewManager.usage}`);this.resetMeshes();const i=this.getDisplayedPartStudio().getElementId();for(const t of this.getBodiesWithCurvatureTessellations()){const s=e.bodyMetaData[t],n=e.getBodyOccurrenceData(t);if(!this.shouldVisualizeBody(s,n))continue;const r=s.isClosedCompositeConstituent?s.closedCompositeParentId:t;this.unsetBodyHasPendingTessellationRequest(r,i);const a=new SS(this.parentNodeId+" "+n.getOccurrenceId()),o=this.getPartStudioFaceEntityIdsForBody(s);for(const e of o){const t=this.getMeshIncrementWithScalars(e),i=this.meshManager.addMeshIncrement(t,this.meshOwnerId);a.onIncrementAdded(i)}const h=new XI.bg;h.setAttribute(sE.COLOR,s.getColor());const c=s.containsOnlySheetBodies()?this.nodePropertiesSurfaces:this.nodePropertiesSolids;for(let e=0;e<c.length&&e<this.nodes.length;++e)this.nodes[e].addOccurrenceGeometryToNode(c[e],n,h,a);e.setScalarVisualizationOccurrence(n.getOccurrenceId(),s.getId())}t.report()}getBodiesThatNeedCurvatureTessellations(){const e=this.getBodyComponent();if(!e)return;const t=new Set;for(const i of this.getBodiesToVisualize()){const s=e.retrieveBodyMetaData(i),n=e=>e===hc;if(!s||s.tessellationSettings.findIndex(n)>-1)continue;const r=s.isClosedCompositeConstituent?s.closedCompositeParentId:i,a=this.getDisplayedPartStudio().getElementId();this.getBodyHasPendingTessellationRequest(r,a)||t.add(r)}return[...t]}shouldVisualizeBody(e,t){return(e?.isSolidBody()||e?.isSheetBody()||e?.isClosedComposite&&!e?.containsOnlyWireBodies())&&t?.getVisibility()===Fs.EE.VISIBLE}getBodiesToVisualize(){const e=this.getBodyComponent();if(!e)return;const t=new Set;for(const i of e.getBodyIds()){const s=e.retrieveBodyMetaData(i),n=e.getBodyOccurrenceData(i);this.shouldVisualizeBody(s,n)&&t.add(i)}return t}getBodiesWithCurvatureTessellations(){const e=e=>e===hc;return this.getBodyComponent()?.getBodyIds((t=>t.tessellationSettings.findIndex(e)>-1))??[]}getPartStudioFaceEntityIdsForBody(e){const t=this.getDisplayedPartStudio();if(!t)return[];const i=e.isClosedComposite?e.constituentBodyIds:[e.getId()],s=[];for(const e of i){const i=t.getEntitiesForBody(e,(e=>e.isFace()));s.push(...i)}return s}getFaceEntityMetadata(e){const t=this.getDisplayedPartStudio()?.retrieveEntityMetaData(e);return t&&t.isFace()?t:null}getMeshIncrementWithScalars(e){const t=this.getFaceEntityMetadata(e),i=t.getGeometry();if(!i)return ut.log.debug(`Tried to get mesh increment with curvature data for entityId="${e}" but entity was not a BTEntityFace`),null;const s=t.getMeshIncrement().clone();if(i.hasValidCurvatureData()&&!i.isPlanarFace()){const e=this.getIncrementCurvatures(i.maxPrincipleCurvatureMagnitudes,i.minPrincipleCurvatureMagnitudes);s.packScalarsIntoTextureCoordinates(e),this.updateRanges(e)}else i.isPlanarFace()&&s.replicateTextureCoordinate(lc);return s}updateRanges(e){const t=k.dGY.fromMinMax(1/0,-1/0),i=k.dGY.fromMinMax(1/0,-1/0);for(const s of e){s<t.min&&(t.min=s),s>t.max&&(t.max=s);const e=Math.min(s,ac);e<i.min&&(i.min=e),e>i.max&&(i.max=e)}const s=k.dGY.combine(this.getRangeInData(),t);this.setRangeInData(s);const n=k.dGY.combine(this.getClampedRangeInData(),i);this.setClampedRangeInData(n)}setRangeInData(e){this.rangeInData=e}setClampedRangeInData(e){this.clampedRangeInData=e}getRangeInData(){return this.rangeInData}getClampedRangeInData(){return this.clampedRangeInData}getIncrementCurvatures(e,t){if(!e||!t)return void ut.log.warn("The passed arrays of principle curvatures were not defined");const i=e=>(0,ic.clamp)(1/e,-1/0,ac+1);switch(this.getCurvatureType()){case k.Lck.MIN_RADIUS:{const s=(e,t)=>Math.max(Math.abs(e),Math.abs(t)),n=(e,t)=>i(s(e,t));return(0,ic.zipWith)(e,t,n)}case k.Lck.MAX_RADIUS:{const s=(e,t)=>Math.min(Math.abs(e),Math.abs(t)),n=(e,t)=>i(s(e,t));return(0,ic.zipWith)(e,t,n)}case k.Lck.MEAN:{const i=(e,t)=>(e+t)/2;return(0,ic.zipWith)(e,t,i)}case k.Lck.GAUSSIAN:default:const s=(e,t)=>e*t;return(0,ic.zipWith)(e,t,s)}}didRequestCurvatureDataForBodies(e){for(const t of e)this.setBodyHasPendingTessellationRequest(t,this.getDisplayedPartStudio()?.getElementId())}}const dc=new xi.hF({isShowThrough:!0,isDepthTested:!1,isStencilTested:!0,isPickable:!1,priority:xi.DO.LOWER,primitiveType:Di.MX.LINES}),gc=new xi.hF({isPickable:!1,primitiveType:Di.MX.LINES}),pc=X.default.getManager();class mc extends Ti.u1{constructor(e,t,i){if(super((0,j.as)(eT,e)),this.handleRoot=null,this.handleHead=null,t){const e=t.geometry,s=e.interpolationPoints.length;i?(this.handleRoot=[e.interpolationPoints[0],e.interpolationPoints[1]],this.handleHead=[e.startHandleX,e.startHandleY]):(this.handleRoot=[e.interpolationPoints[s-2],e.interpolationPoints[s-1]],this.handleHead=[e.endHandleX,e.endHandleY])}this.updateLines()}updateEndpoints(e,t){this.handleRoot=t,this.handleHead=e,this.updateLines()}updateLines(){if(!this.handleRoot||!this.handleHead)return;const e=this.viewer.getSketch();if(!e)return;const t=[e.planeToWorld(this.handleRoot),e.planeToWorld(this.handleHead)],i=(0,Au.pf)(t);(0,Au.VQ)(pc.getNumber("SPLINE_HANDLE_LINE_WIDTH"),i),(0,Au.Ab)(pc.getColor("SPLINE_HANDLE_COLOR"),i),this.updateMeshIncrement("lines",Ti.ZJ,i,dc),this.updateMeshIncrement("dp.lines",Ti.ZJ,i.clone(),gc)}}const fc=X.default.getManager(),Ic=new xi.hF({zOffset:fc.getNumber("ORIGIN_Z_OFFSET"),primitiveType:Di.MX.POINTS,isShowThrough:!0,isDepthTested:!1});var Ec;!function(e){e.POINT="point"}(Ec||(Ec={}));class Sc extends Ti.u1{constructor(e,t){super(t),this.definition=e,this.lastScale=-1,this.worldSpacePosition=[0,0,0],this.id="AssemblyOriginElement",this.occurrenceTransform=de.create(),this.updateHideState()}onAppearanceConstantsUpdated(){this.updateGraphics()}setOccurrenceTransform(e){this.occurrenceTransform=e,this.damageTransform()}updateDefinition(e){this.definition=e,this.updateHideState(),this.damageTransform()}damageTransform(){if(this.lastScale=-1,this.definition){const e=[0,0,0];ge.w$.multiplyVec3(this.occurrenceTransform,e,this.worldSpacePosition)}(0,Fs.vm)()}getUserVisibilitySetting(){return this.definition.hidden?Fs.EE.HIDDEN:Fs.EE.VISIBLE}updateHideState(){this.isHighlighted()||this.getUserVisibilitySetting()!==Fs.EE.HIDDEN?(this.hasMeshIncrements()||this.updateGraphics(!0),this.show()):this.hide()}getBounds(){if(this.isVisibleToUser()){const e=new yi.kB;return e.addPoint(this.worldSpacePosition),e}return null}onViewWillDraw(e){this.adjustTransform(e)}adjustTransform(e){if(!this.definition||this.isHidden)return;const t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition);if(Math.abs(this.lastScale-t)<Ci.W.ZERO_LENGTH)return;this.lastScale=t;const i=de.create();i[0]=t,i[5]=t,i[10]=t,this.setTransform(ge.w$.multiply(this.occurrenceTransform,i,de.create())),this.hasMeshIncrements()||this.updateGraphics()}updateGraphics(e){if(!this.definition||this.isHidden&&!e)return void this.removeMeshIncrements();const t=(0,Au.Pu)([0,0,0],"point",fc.getColor("ORIGIN_COLOR"),fc.getNumber("ORIGIN_SIZE"));(0,Au.KZ)(fc.getPointFont("ORIGIN_FONT"),t),this.updateMeshIncrement(Ec.POINT,Ti.ZJ,t,Ic)}getOccurrence(){return null}getModelSelection(e){if(!this.definition)return null;const t=new k._oC,i=new Ce.Y1(k.lQt.FEATURE,k.AuL.ORIGIN_ID,t,{sourcePick:e.sourcePick});return i.setFeatureType(ui.T.ASSEMBLY_ORIGIN),i}addHighlight(e){super.addHighlight(e),this.updateHideState(),this.addHighlightToIncrement(Ec.POINT,e)}removeHighlight(e){return this.removeHighlightFromIncrement(Ec.POINT,e),!!super.removeHighlight(e)&&(this.updateHideState(),!0)}}var Tc=i(61455);const Dc="pbm",Mc="tbm",Cc="nbm";class yc{constructor(e,t,i,s,n,r,a,o,h){this.bodyOccurrence=e,this.requestSource=t,this.occurrence=i,this.tessellationSettingDesired=s,this.tessellationSettingRequested=n,this.finestTessellationSettingInMemory=r,this.viewportError=a,this.isOutsideFrustum=o,this.benefitToProcess=h}}var Pc;!function(e){e[e.DISABLED=0]="DISABLED",e[e.CONDITIONAL=1]="CONDITIONAL",e[e.ALWAYS=2]="ALWAYS"}(Pc||(Pc={}));let Ac=Pc.CONDITIONAL;function Oc(e){Ac=e}const vc=-1;var Rc;!function(e){e[e.SELECTION=0]="SELECTION",e[e.HOVER=1]="HOVER",e[e.VIEWING=2]="VIEWING"}(Rc||(Rc={}));const wc=X.default.getManager().getNumber("UNLOADED_BODY_OPACITY_FACTOR");function _c(){return!!localStorage.getItem("osBodyRetrievalDebuggingEnabled")}function Nc(e){return(e/1024/1024).toFixed(0)+" MB"}const bc=[0];class Lc{constructor(e,t){this.partStudio=e,this.bodyMetaData=t,this.radius=this.getBodyMetaDataForRetrieval().getBounds().diameter()/2}getBodyMetaDataForRetrieval(){return this.bodyMetaData.isClosedCompositeConstituent?this.bodyMetaData.consumingClosedCompositeData:this.bodyMetaData}getBenefitToUnload(){return this.getBodyMetaDataForRetrieval().getEstimatedMemoryUsage()/(this.radius*this.radius)}isBodyDataPresent(){return this.getBodyMetaDataForRetrieval().hasTessellationSettings()}isInstantiated(){return!1}getLastViewTime(){return 0}getLastViewportOccupancy(){return 0}getUnloadedChordalTolerance(){return this.getBodyMetaDataForRetrieval().getBounds().diameter()}getCenter(){return null}}const Fc=C.create(),xc=y.create(),Bc=de.create();class Vc{constructor(e,t,i){this.occurrenceData=e,this.bodyMetaData=t,this.pickId=i,this.center=[0,0,0],this.radius=0,this.lod=null,this.displayDamaged=!0,this.incrementDetails=null,this.highlightApplied=null,this.retrievalRequestState=vc,this.update(e,t)}update(e,t){this.occurrenceData=e,this.bodyMetaData=t;const i=xc;t.getBounds().center(i),i[3]=1,ge.w$.multiplyVec4(e.getTransform(),i),this.center[0]=i[0],this.center[1]=i[1],this.center[2]=i[2],this.radius=t.getBounds().diameter()/2,this.displayDamaged=!0}getBodyMetaData(){return this.bodyMetaData}getBodyMetaDataForRetrieval(){return this.bodyMetaData.isClosedCompositeConstituent?this.bodyMetaData.consumingClosedCompositeData:this.bodyMetaData}getOccurrenceData(){return this.occurrenceData}getOccurrenceId(){return this.occurrenceData.getOccurrenceId()}getCenter(){return this.center}getRadius(){return this.radius}getUnloadedChordalTolerance(){return 2*this.radius}getBenefitToCull(){return this.bodyMetaData.coarseTriangleCount/(this.radius*this.radius)}getBenefitToUnload(){return this.getBodyMetaDataForRetrieval().getEstimatedMemoryUsage()/(this.radius*this.radius)}getBenefitToLoad(){return this.isBodyDataPresent()?0:this.radius*this.radius/this.getBodyMetaDataForRetrieval().getEstimatedMemoryUsage(bc)}getBenefitToRefine(e,t){return t/this.getBodyMetaDataForRetrieval().getEstimatedMemoryUsage([e])}isInstantiated(){return!0}setCullingState(e){if(this.numberOfBodiesInOccurrence>1){const t=Dp.getPotentialMeshGroupIdsForBody(this.bodyMetaData.meshGroupId);for(let i=0;i<t.length;++i)this.occurrenceData.setCullingState(e,t[i])}else this.occurrenceData.setCullingState(e)}isEntityTessellationLoaded(){return this.getBodyMetaDataForRetrieval().getIsTessellationLoaded()}canBeRefinedFurther(e){const t=this.getBodyMetaDataForRetrieval().getFinestTessellationSettingInMemory();return null===t||t<this.getBodyMetaDataForRetrieval().getBestAvailableTessellationSettingIndex(e)}setLod(e){this.isEntityTessellationLoaded()||(e=nE.LOWEST),this.occurrenceData.setLod(e)}outsideFrustum(e){return e.viewFrustum.getSphereFrustumIntersection(this.center,this.radius)===Jn.I.OUTSIDE}intersectsFrustum(e){return!!e&&e.getSphereFrustumIntersection(this.center,this.radius)!==Jn.I.OUTSIDE}isVisible(){return this.occurrenceData.getVisibility()===Fs.EE.VISIBLE}mustShowLowestLod(e){return!this.isEntityTessellationLoaded()&&(this.isVisible()||this.occurrenceData.hasHighlight()||!!e&&e.getIsPickingHiddenOccurrences())}lodIsUpToDate(){return this.mustShowLowestLod()?!this.displayDamaged&&this.lod===nE.LOWEST:this.lod!==nE.LOWEST}isBodyDataPresent(){return this.getBodyMetaDataForRetrieval().hasTessellationSettings()}resetRetrievalRequestState(){this.retrievalRequestState=vc}setBodyRetrievalStarted(e){this.retrievalRequestState=e}isRetrievalRequestDataPresent(){if(!this.getBodyRetrievalStarted())return!1;const e=this.getBodyMetaDataForRetrieval();return e.hasTessellationSettings()&&e.getFinestTessellationSettingInMemory()===this.retrievalRequestState}getBodyRetrievalStarted(){return this.retrievalRequestState>=0}canCullBody(e){return this.occurrenceData.getVisibility()===Fs.EE.VISIBLE&&!this.occurrenceData.getIsolated()&&!this.intersectsFrustum(e)}getDisplayId(){return this.occurrenceData.getOccurrenceId()+"."+this.bodyMetaData.id}addBounds(e){e.addBox(this.bodyMetaData.getBounds(),this.occurrenceData.getTransform())}updateViewHistory(e,t){const i=this.getBodyMetaDataForRetrieval();i.getLastViewTime()!==e?(i.setLastViewTime(e),i.setLastViewportOccupancy(t)):i.setLastViewportOccupancy(t+i.getLastViewportOccupancy())}getLastViewTime(){return this.getBodyMetaDataForRetrieval().getLastViewTime()}getLastViewportOccupancy(){return this.getBodyMetaDataForRetrieval().getLastViewportOccupancy()}getDisplayIncrement(){const e=this.bodyMetaData.getBounds(),t=e.diagonalVector(Fc),i=ge.w$.scale(de.identity(Bc),t),s=e.center(Fc);i[12]+=s[0],i[13]+=s[1],i[14]+=s[2],ge.w$.multiply(this.occurrenceData.getTransform(),i,i);const n=Gc().createTransformed(i);n.id=this.getDisplayId(),n.pickId=this.pickId,n.lod=nE.LOWEST;let r=this.bodyMetaData.getColor();return!this.occurrenceData.getIsolated()&&(0,Jo.uQ)().getIsolatedOccurrenceManager().isInIsolateOrMakeTransparentMode()?(r=[r[0],r[1],r[2],1],n.groupId=Cc):(this.isBodyDataPresent()||(r=[r[0],r[1],r[2],r[3]*wc]),n.groupId=r[3]<1?Mc:Dc),(0,Au.Ab)(r,n),n}}let Uc=null;function Gc(){return Uc||(Uc=(0,Au.dO)([-.5,-.5,-.5],[.5,.5,.5])),Uc}class Hc extends m.T{constructor(e,t){super(),this.viewer=e,this.bodyUnloadTask=t,this.DISPLAY_OCCURRENCE_NAME="BodyManager",this.DISPLAY_NON_ISOLATED_OCCURRENCE_NAME="BodyManagerNonIsolated",this.DISPLAY_BOXES_WHEN_CULLING=X.default.getManager().getNumber("DISPLAY_BOXES_WHEN_CULLING"),this.previewOccurrences=new Map,this.sortedOccurrences=null,this.occurrencesNeedSort=!0,this.unloadedBodyBounds=null,this.MAXIMUM_BODY_CULL_DIAMETER_PROPORTION=X.default.getManager().getNumber("MAXIMUM_BODY_CULL_DIAMETER_PROPORTION"),this.occurrenceRetrievalTimeout=null,this.occurrencesRequestedSet=new Set,this.logLimiter=10,this.encounteredUnloadedOccurrenceInLastFrame=!1,this.bodyRetrievalCheckTimeout=null,this.shouldUpdateBodyOccurrenceLodForIsolate=!1,this.paused=!1,this.userEnabledAggressiveRefinement=!1,this.idManager=new eI.E,this.graphicsRefinementModeSubject=new Tc.t(1),this.occurrences=new Map,this.node=new xi.NB("bodyManager"),this.displayOccurrenceId=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(this.DISPLAY_OCCURRENCE_NAME),this.displayOccurrenceData=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(this.displayOccurrenceId),this.displayOccurrenceData.setLod(nE.LOWEST),this.displayOccurrenceData.setIsolated(!0),this.displayOccurrenceData.setCanIsolateChange(!1),this.displayOccurrenceIdNonIsolated=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(this.DISPLAY_NON_ISOLATED_OCCURRENCE_NAME),this.displayOccurrenceDataNonIsolated=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(this.displayOccurrenceIdNonIsolated),this.displayOccurrenceDataNonIsolated.setLod(nE.LOWEST),this.displayOccurrenceDataNonIsolated.setIsolated(!1),this.displayOccurrenceDataNonIsolated.setCanIsolateChange(!1),this.meshManager=new AS(this.viewer,{bufferAllocationPolicy:$f.MAXIMUM}),this.meshOwnerId=PS(),this.bodyOccurrenceToRetrievalRequest=new Map,this.occurrenceRetrievalRequests=[],this.pendingRetrievalInformation=new Map;this.viewer.getModelViewManagers().getManager().getSharedBodyNode().addChild(this.node);const i=new XI.bg,s=this.meshManager.getOrCreateGroupRangesForGroupTypeAndLod(Dc,this.meshOwnerId,Di.MX.TRIANGLE_STRIP,nE.LOWEST);this.node.addOccurrenceGeometryToNode(ep,this.displayOccurrenceData,i,s);const n=this.meshManager.getOrCreateGroupRangesForGroupTypeAndLod(Mc,this.meshOwnerId,Di.MX.TRIANGLE_STRIP,nE.LOWEST);this.node.addOccurrenceGeometryToNode(hp,this.displayOccurrenceData,i,n);const r=this.meshManager.getOrCreateGroupRangesForGroupTypeAndLod(Cc,this.meshOwnerId,Di.MX.TRIANGLE_STRIP,nE.LOWEST);this.node.addOccurrenceGeometryToNode(ep,this.displayOccurrenceDataNonIsolated,i,r),Ki.Jq.CapabilitiesService&&Ki.Jq.CapabilitiesService.isMoreAggressiveCullingEnabled&&Ki.Jq.CapabilitiesService.isMoreAggressiveCullingEnabled().then((e=>{this.MAXIMUM_BODY_CULL_DIAMETER_PROPORTION=!0===e?X.default.getManager().getNumber("MORE_AGGRESSIVE_MAXIMUM_BODY_CULL_DIAMETER_PROPORTION"):X.default.getManager().getNumber("MAXIMUM_BODY_CULL_DIAMETER_PROPORTION")})),this.refinementNodeFilter=e=>{const t=this.viewer.getModelViewManagers().getManager();if(t.isNodeForModel(e)){const i=e.getParent();return!e.isMeshNode()||e.isFaces()&&(t.isNodeForBody(i)||i===this.node)}return!1},this.subscribeToSelectionList()}destroy(){this.node.remove(),this.viewer.getOccurrenceDataManager().destroyOccurrenceData(this.displayOccurrenceId),this.viewer.getOccurrenceIdManager().removeName(this.DISPLAY_OCCURRENCE_NAME),this.viewer.getOccurrenceDataManager().destroyOccurrenceData(this.displayOccurrenceIdNonIsolated),this.viewer.getOccurrenceIdManager().removeName(this.DISPLAY_NON_ISOLATED_OCCURRENCE_NAME),this.meshManager.destroy(),this.resetOccurrenceRetrieval(),this.clearBodyRetrievalCheckTimeout(),this.stopListening()}resetSelectionListHandlers(){this.stopListening(),this.subscribeToSelectionList()}subscribeToSelectionList(){const e=(0,Ce.vi)();this.listenTo(e,"add",this.onSelectionChanged),this.listenTo(e,"reset",this.onSelectionChanged),this.listenTo(e,"remove",this.onSelectionChanged)}setVisible(e){this.node.setVisible(e)}resetOccurrenceRetrieval(){_c()&&ut.log.info("Reset occurence retriaval"),this.clearBodyRetrievalCheckTimeout(),this.clearRetrievalTimeout(),this.bodyOccurrenceToRetrievalRequest.clear(),this.occurrenceRetrievalRequests=[],this.pendingRetrievalInformation=new Map}clearPreviewOccurrences(){this.previewOccurrences.clear()}getGraphicsRefinementModeObservable(){return this.graphicsRefinementModeSubject.asObservable()}updateGraphicsRefinementMode(){this.userEnabledAggressiveRefinement?this.graphicsRefinementModeSubject.next(is.Rng.AGGRESSIVE_USER_CAUSED):this.graphicsRefinementModeSubject.next(is.Rng.NORMAL)}get aggressiveRefinementEnabled(){return this.userEnabledAggressiveRefinement}getUserEnabledAggressiveRefinement(){return this.userEnabledAggressiveRefinement}setUserEnabledAggressiveRefinement(e){this.userEnabledAggressiveRefinement!==e&&(this.userEnabledAggressiveRefinement=e,this.onAggressiveRefinementChanged())}onAggressiveRefinementChanged(){this.aggressiveRefinementEnabled?this.performUnloadedBodyAndRefinementCheck():this.viewer.getEventDispatcher().trigger(yD.Jp),this.updateGraphicsRefinementMode()}isBodyManagerOccurrence(e){return!!e&&e.path[0]===this.DISPLAY_OCCURRENCE_NAME}pickedOccurrenceId(e){this.viewer.isHidden()||this.initiateAutomaticRetrieval(!1)}onSelectionChanged(){this.viewer.isHidden()||this.initiateAutomaticRetrieval(!1)}getBtOccurrence(e){const t=this.viewer.getOccurrenceIdManager().getNameForId(e.getOccurrenceId());return!t||t.startsWith(Dp.PART_STUDIO_BODY_OCCURRENCE_PREFIX)?null:k._oC.getOccurrenceFromPathString(t)}getFinestTessellationSettingInMemory(e){let t=e.getBodyMetaDataForRetrieval().getFinestTessellationSettingInMemory();return null===t&&(t=-1),t}checkBodiesUnderMemoryLimit(e,t){const i=this.viewer.getModelViewManagers().getManager().getBodyRefinementMemoryLimit();let s=0;for(const n of this.occurrences.values()){const r=n.getBodyMetaData();if(!t||t.has(r.id)?s+=r.getEstimatedMemoryUsage([e]):s+=r.getEstimatedMemoryUsage(),s>=i)return!1}return!0}clearRetrievalTimeout(){(0,Gr.Z)(this.occurrenceRetrievalTimeout)&&(window.clearTimeout(this.occurrenceRetrievalTimeout),this.occurrenceRetrievalTimeout=null)}startRetrievalTimeout(){this.clearRetrievalTimeout();const e=this.aggressiveRefinementEnabled?X.default.getManager().getNumber("AGGRESSIVE_OCCURRENCE_RETRIEVAL_INTERVAL_MS"):X.default.getManager().getNumber("OCCURRENCE_RETRIEVAL_INTERVAL_MS");this.occurrenceRetrievalTimeout=window.setTimeout((()=>this.onRetrievalTimeout()),e)}onRetrievalTimeout(){if(this.clearRetrievalTimeout(),this.paused)return void ut.log.info("Skipped body retrieval timeout due to pause");const e=this.viewer.getModelViewManagers().getManager();if(!this.aggressiveRefinementEnabled&&this.viewer.getFrameTimer().userIsInteracting())return void this.startRetrievalTimeout();const t=[];let i=!1;const s=X.default.getManager(),n=1024*s.getNumber("BODY_REFINEMENT_BATCH_SIZE_MB")*1024,r=1024*s.getNumber("PENDING_BODY_REFINEMENT_SIZE_LIMIT_MB")*1024;let a=0;const o=_c(),h=[],c=this.getEstimatedMemoryUsageOfPendingRetrievals();if(o){const t=e.getEstimatedMemoryUsageOfBodies();ut.log.info("Estimated memory use of all bodies: "+Nc(t)+" pending:"+Nc(c))}for(const s of this.occurrenceRetrievalRequests){const l=s.bodyOccurrence.getBodyMetaDataForRetrieval();if(this.pendingRetrievalInformation.has(l)){i=!0;continue}let u=l.getFinestTessellationSettingInMemory();if(null===u&&(u=-1),u===s.tessellationSettingRequested||s.tessellationSettingRequested===k.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING)continue;i=!0;let d=0,g=-1;const p=this.viewer.getRenderingMode()===k.P1.SHADED_CURVATURE_VISUALIZATION;if(this.aggressiveRefinementEnabled||p||u>s.tessellationSettingRequested?(g=s.tessellationSettingRequested,d=l.getEstimatedMemoryUsage([g])):(i=!0,g=u+1,d=l.getEstimatedMemoryUsage([g])),(0===a||a+d<n)&&(0===this.pendingRetrievalInformation.size||c+a+d<r)){a+=d,this.pendingRetrievalInformation.set(l,{estimatedAdditionalMemoryUsage:d,tessellationSetting:g});const i=new k.A$B;if(i.bodyDeterministicId=l.getId(),s.occurrence){i.occurrence=s.occurrence;const t=e.getOccurrenceDisplayData(s.occurrence);t&&(i.elementId=t.elementId,i.microversionIdAndConfiguration=t.fullElementId.microversionIdAndConfiguration)}else i.occurrence=null,i.elementId=e.getDisplayedElementId(),i.microversionIdAndConfiguration=e.getDisplayedElementMicroversionIdAndConfiguration();i.tessellationSetting=g,s.bodyOccurrence.setBodyRetrievalStarted(i.tessellationSetting),_c()&&(s.occurrence?(0,Ce.iH)().add(new Ce.Y1(k.lQt.OCCURRENCE,s.occurrence,s.occurrence)):(0,Ce.iH)().add(new Ce.Y1(k.lQt.BODY,s.bodyOccurrence.getBodyMetaData().getId()))),t.push(i),o&&h.push(l.getId()+"-"+i.tessellationSetting)}}if(o&&h.length>0){h.sort(),ut.log.info("Retrieving bodies from cache or service: "+h);const e=this.viewer.getModelViewManagers().getManager().getEstimatedMemoryUsageOfBodies(),t=this.getEstimatedMemoryUsageOfPendingRetrievals();ut.log.info("Estimated use of body memory at time of retrieval "+Nc(e+t)+", pending use: "+Nc(t))}t.length>0&&(this.logLimiter>0&&(t.forEach((e=>{this.occurrencesRequestedSet.has(e.toString())&&(this.logLimiter-=1,ut.log.warn(`Duplicate refinement request issued: ${e.occurrence}, tessellationSetting: ${e.tessellationSetting},  elementId: ${e.elementId}, bodyDeterministicId: ${e.bodyDeterministicId}, microversionIdAndConfiguration: ${e.microversionIdAndConfiguration}, isAvailableAtClient ${e.isAvailableAtClient}`))})),this.occurrencesRequestedSet=new Set,t.forEach((e=>{this.occurrencesRequestedSet.add(e.toString())}))),this.aggressiveRefinementEnabled?this.viewer.getEventDispatcher().trigger(yD.am,t):this.viewer.getEventDispatcher().trigger(yD.Qe,t)),i&&this.startRetrievalTimeout()}resetRetrievalStateForOccurrence(e){e.resetRetrievalRequestState();const t=e.getBodyMetaDataForRetrieval();if(this.pendingRetrievalInformation.delete(t),_c()){const i=this.getBtOccurrence(e);i?(0,Ce.iH)().remove(new Ce.Y1(k.lQt.OCCURRENCE,i,i)):(0,Ce.iH)().remove(new Ce.Y1(k.lQt.BODY,t.getId()))}}updateForFrame(e,t){let i;this.sortedOccurrences||(this.sortedOccurrences=new Array(this.occurrences.size),i=0,this.occurrences.forEach((e=>{this.sortedOccurrences[i++]=e})),this.occurrencesNeedSort=!0),this.occurrencesNeedSort&&(this.sortedOccurrences.sort(kc),this.occurrencesNeedSort=!1),this.performAggressiveCulling(e,!!t)}performAggressiveCulling(e,t){if(this.viewer.getXrController().getIsXrRunning())return;const i=e.getActiveCamera(),s=e.getDetailSettings();let n=Rs()?Math.floor(s.lowLevelBodyProportion*this.sortedOccurrences.length):0;const r=!t||this.DISPLAY_BOXES_WHEN_CULLING;let a=this.shouldUpdateBodyOccurrenceLodForIsolate||0!==n&&r||e.getIsPickingHiddenOccurrences();const o=e.getViewer().getFrustumToPreventCulling();t&&(this.encounteredUnloadedOccurrenceInLastFrame=!1);const h=this.MAXIMUM_BODY_CULL_DIAMETER_PROPORTION*i.getViewportDiagonal();let c=!1;for(let s=0;s<this.sortedOccurrences.length;++s){const r=this.sortedOccurrences[s];if(r.outsideFrustum(i))r.setCullingState(Fs.uc.CULLED),--n;else{r.lodIsUpToDate()||a||(a=!0,s=0);const l=i.getUnitSizeAtWorldPointFast(r.center)*r.radius*2;t&&!r.isBodyDataPresent()&&(this.encounteredUnloadedOccurrenceInLastFrame=!0),r.mustShowLowestLod(e)||s<n&&r.canCullBody(o)&&l<h?(c=!0,r.setCullingState(Fs.uc.CULLED),a&&this.setBodyOccurrenceLod(r,nE.LOWEST,e)):(r.setCullingState(Fs.uc.VISIBLE),a&&this.setBodyOccurrenceLod(r,nE.DEFAULT,e))}this.shouldUpdateBodyOccurrenceLodForIsolate=!1,r.isRetrievalRequestDataPresent()&&this.resetRetrievalStateForOccurrence(r)}c?(this.displayOccurrenceData.setCullingState(Fs.uc.VISIBLE),this.displayOccurrenceDataNonIsolated.setCullingState(Fs.uc.VISIBLE)):(this.displayOccurrenceData.setCullingState(Fs.uc.CULLED),this.displayOccurrenceDataNonIsolated.setCullingState(Fs.uc.CULLED))}setBodyOccurrenceLod(e,t,i){if(e.lod===t&&!e.displayDamaged)return void this.updateBodyHighlight(e);const s=e.occurrenceData.getIsolated()||!this.viewer.getIsolatedOccurrenceManager()?.isInIsolateOrMakeTransparentMode();if(t===nE.DEFAULT)e.incrementDetails&&(this.displayOccurrenceData.hideIncrement(e.incrementDetails,fs.L.BASE),this.displayOccurrenceDataNonIsolated.hideIncrement(e.incrementDetails,fs.L.BASE));else{const t=!e.isVisible()&&!i.getIsPickingHiddenOccurrences();if(e.displayDamaged||!e.incrementDetails){e.incrementDetails&&(this.meshManager.removeMeshIncrement(e.getDisplayId(),this.meshOwnerId),e.incrementDetails=null,e.highlightApplied=null);const t=e.getDisplayIncrement();e.incrementDetails=this.meshManager.addMeshIncrement(t,this.meshOwnerId),e.displayDamaged=!1}s&&!t?this.displayOccurrenceData.showIncrement(e.incrementDetails,fs.L.BASE):this.displayOccurrenceData.hideIncrement(e.incrementDetails,fs.L.BASE),s||t?this.displayOccurrenceDataNonIsolated.hideIncrement(e.incrementDetails,fs.L.BASE):this.displayOccurrenceDataNonIsolated.showIncrement(e.incrementDetails,fs.L.BASE)}e.lod=t,this.updateBodyHighlight(e)}updateBodyHighlight(e){if(e.incrementDetails)if(e.lod===nE.DEFAULT)this.clearBodyHighlight(e);else{const t=e.occurrenceData.getBaseOccurrenceHighlight();t!==e.highlightApplied&&(this.clearBodyHighlight(e),t&&(this.displayOccurrenceData.updateEntityHighlight(dn.aU.ADD,t,e.incrementDetails,fs.L.BASE),this.displayOccurrenceDataNonIsolated.updateEntityHighlight(dn.aU.ADD,t,e.incrementDetails,fs.L.BASE),e.highlightApplied=t))}}clearBodyHighlight(e){e.highlightApplied&&e.incrementDetails&&(this.displayOccurrenceData.updateEntityHighlight(dn.aU.REMOVE,e.highlightApplied,e.incrementDetails,fs.L.BASE),this.displayOccurrenceDataNonIsolated.updateEntityHighlight(dn.aU.REMOVE,e.highlightApplied,e.incrementDetails,fs.L.BASE),e.highlightApplied=null)}getBodyOccurrenceId(e,t){return e+"."+t}addOrUpdateOccurrence(e,t,i,s){const n=this.getBodyOccurrenceId(e,i.id);let r=this.occurrences.get(n);r?r.update(t,i):(r=new Vc(t,i,this.idManager.getOrCreateIdForName(n)),this.occurrences.set(n,r),this.sortedOccurrences&&this.sortedOccurrences.push(r)),r.numberOfBodiesInOccurrence=s,this.occurrencesNeedSort=!0,this.damageUnloadedBodyBounds()}damageUnloadedBodyBounds(){this.unloadedBodyBounds=null}getUnloadedBodyBounds(){return this.unloadedBodyBounds||(this.unloadedBodyBounds=new yi.kB,this.occurrences.forEach((e=>{!e.isVisible()||e.isBodyDataPresent()&&e.isEntityTessellationLoaded()||e.addBounds(this.unloadedBodyBounds)}))),this.unloadedBodyBounds}getBodyOccurrence(e,t){return this.occurrences.get(this.getBodyOccurrenceId(e,t))}removeOccurrence(e,t){const i=this.getBodyOccurrenceId(e,t),s=this.occurrences.get(i);s&&(s.incrementDetails&&this.meshManager.removeMeshIncrement(s.getDisplayId(),this.meshOwnerId),this.occurrences.delete(i),this.sortedOccurrences=null,this.occurrencesNeedSort=!0,this.damageUnloadedBodyBounds(),this.idManager.removeName(i))}getOccurrenceBounds(e,t){const i=new yi.kB,s=this.occurrences.get(this.getBodyOccurrenceId(e,t));return s&&s.addBounds(i),i}onUserIsAdjustingCamera(){(this.viewer.getModelViewManagers().getManager().displayingAssembly()||this.viewer.getModelViewManagers().getManager().displayingPartStudio())&&this.initiateAutomaticRetrieval(!0)}getEstimatedMemoryUsageOfPendingRetrievals(){let e=0;return this.pendingRetrievalInformation.forEach((function(t){e+=t.estimatedAdditionalMemoryUsage})),e}hasRefinementCeased(){return 0===this.pendingRetrievalInformation.size&&this.hasRetrievalCompleted()}getDisplayDataRefinementState(){const e=[];return this.occurrences.forEach((t=>{const i=t.getBodyMetaDataForRetrieval(),s=i.getFinestTessellationSettingInMemory(),n=t.isVisible(),r=i.getBestAvailableTessellationSettingIndex(this.aggressiveRefinementEnabled);e.push(`${i.name}, ${i.getId()}, on client = ${s}, maximum = ${r}, isVisible = ${n}`)})),e.join("\n")}hasRetrievalCompleted(){let e=!0;for(const t of this.occurrenceRetrievalRequests){const i=t.bodyOccurrence.getBodyMetaDataForRetrieval().getFinestTessellationSettingInMemory();if(null===i){e=!1;break}if(t.tessellationSettingRequested!==k.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING&&t.tessellationSettingRequested!==i){e=!1;break}}return e}getPendingRetrievalSummary(){let e="Body manager retrieval summary:\n";return this.pendingRetrievalInformation.size>0&&(e+="pendingRetrievalInformation size: "+this.pendingRetrievalInformation.size+"\n",this.pendingRetrievalInformation.forEach(((t,i)=>{e+="  Body: "+i.getId()+", retrievalInfo: "+JSON.stringify(t)+"\n"}))),this.bodyOccurrenceToRetrievalRequest.size>0&&(e+="occurrenceRetrievalRequests size: "+this.bodyOccurrenceToRetrievalRequest.size+"\n",this.bodyOccurrenceToRetrievalRequest.forEach(((t,i)=>{e+="retrievalRequest: "+JSON.stringify(t,null,"  ")+"\n"}))),e}clearBodyRetrievalCheckTimeout(){(0,Gr.Z)(this.bodyRetrievalCheckTimeout)&&(window.clearTimeout(this.bodyRetrievalCheckTimeout),this.bodyRetrievalCheckTimeout=null)}initiateAutomaticRetrieval(e){this.clearBodyRetrievalCheckTimeout(),e&&(this.occurrenceRetrievalRequests=[],this.bodyOccurrenceToRetrievalRequest=new Map);const t=this.aggressiveRefinementEnabled?X.default.getManager().getNumber("AGGRESSIVE_AUTOMATIC_BODY_RETRIEVAL_TIMEOUT_MS"):X.default.getManager().getNumber("AUTOMATIC_BODY_RETRIEVAL_TIMEOUT_MS");this.bodyRetrievalCheckTimeout=window.setTimeout((()=>this.performUnloadedBodyAndRefinementCheck()),t)}allowRefinementCheck(){if(Ac===Pc.ALWAYS||this.aggressiveRefinementEnabled)return!0;const e=this.viewer.getInteractiveFrameDetails(),t=_c();let i=!1;return e&&e.hasTimings()&&(i=e.getAverageFramerate()<X.default.getManager().getNumber("BODY_REFINEMENT_FRAMERATE_THRESHOLD"),t&&i&&ut.log.info("Skipped body refinement check because framerate is slow right now: "+e.getAverageFramerate()+" fps")),!i}getSelectionsForRetrieval(){const e=[];return(0,Ce.vi)().forEach((t=>{e.push({selection:t,requestSource:Rc.SELECTION})})),(0,Ce.Wf)().forEach((t=>{e.push({selection:t,requestSource:Rc.HOVER})})),e}getSelectionOccurrencesForRetieval(){const e=[],t=this.viewer.getModelViewManagers().getManager(),i=this.viewer.getOccurrenceIdManager(),s=this.viewer.getCamera(),n=this.aggressiveRefinementEnabled?X.default.getManager().getNumber("SELECTED_AGGRESSIVE_ERROR_REFINEMENT_THRESHOLD"):X.default.getManager().getNumber("FINER_BODY_SCREENSPACE_ERROR_REFINEMENT_THRESHOLD");for(const{selection:r,requestSource:a}of this.getSelectionsForRetrieval()){const o=r.getOccurrence();if(!o)continue;const h=i.getIdForName(o.getPathAsString());if(h===Jf.Qy)continue;const c=t.getOccurrenceDisplayData(o);if(c&&c.displayedPartIds)for(const t of c.displayedPartIds){const i=this.getBodyOccurrenceId(h,t),r=this.occurrences.get(i);if(!r)continue;const o=s?.getUnitSizeAtWorldPoint(r.getCenter()),c=this.getTessellationIndexToGoUnderThreshold(r,n,o,this.aggressiveRefinementEnabled),l=this.getFinestTessellationSettingInMemory(r),u=this.getBtOccurrence(r);e.push(new yc(r,a,u,c,k.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING,l,Number.MAX_VALUE,!0,0))}}return e}getVisibleOccurrencesForRetrieval(){const e=[],t=this.viewer.getCamera(),i=this.viewer.getModelViewManagers().getManager();let s;s=this.aggressiveRefinementEnabled?i.displayingAssembly()?X.default.getManager().getNumber("VIEWING_ASSEMBLY_AGGRESSIVE_ERROR_REFINEMENT_THRESHOLD"):X.default.getManager().getNumber("VIEWING_PART_STUDIO_AGGRESSIVE_ERROR_REFINEMENT_THRESHOLD"):X.default.getManager().getNumber("BODY_SCREENSPACE_ERROR_REFINEMENT_THRESHOLD");const n=(0,Fs.Wj)();return this.collectBodyOccurrencesInViewport().forEach(((i,r)=>{r.updateViewHistory(n,i.viewportOccupancyRatio);const a=r.getBodyMetaData(),o=r.getUnloadedChordalTolerance(),h=t?.getUnitSizeAtWorldPoint(r.getCenter()),c=h*o;if(c>=s){let t=null;if(t=this.shouldRetrieveHighestQualityTessellationForOccurrence(r)?a.getBestAvailableTessellationSettingIndex(this.aggressiveRefinementEnabled):this.getTessellationIndexToGoUnderThreshold(r,s,h,this.aggressiveRefinementEnabled),null===t)return;const n=this.getFinestTessellationSettingInMemory(r),o=this.getBtOccurrence(r);e.push(new yc(r,Rc.VIEWING,o,t,k.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING,n,i.viewportOccupancyRatio*c,!0,0))}})),e}findMaximumRefinementForOccurrences(){for(const e of[...this.getSelectionOccurrencesForRetieval(),...this.getVisibleOccurrencesForRetrieval()]){const t=this.viewer.getCamera();e.isOutsideFrustum=e.bodyOccurrence.outsideFrustum(t),e.benefitToProcess=e.bodyOccurrence.getBenefitToRefine(e.tessellationSettingDesired,e.viewportError);const i=this.bodyOccurrenceToRetrievalRequest.get(e.bodyOccurrence);i?(i.viewportError=Math.max(e.viewportError,i.viewportError),i.requestSource=Math.min(e.requestSource,i.requestSource),i.isOutsideFrustum=e.isOutsideFrustum&&i.isOutsideFrustum,i.benefitToProcess=Math.max(e.benefitToProcess,i.benefitToProcess),i.tessellationSettingDesired=Math.max(e.tessellationSettingDesired,i.tessellationSettingDesired),i.finestTessellationSettingInMemory=e.finestTessellationSettingInMemory):(this.occurrenceRetrievalRequests.push(e),this.bodyOccurrenceToRetrievalRequest.set(e.bodyOccurrence,e))}this.occurrenceRetrievalRequests.sort(((e,t)=>{if(e.isOutsideFrustum!==t.isOutsideFrustum)return e.isOutsideFrustum?1:-1;if(e.requestSource<t.requestSource)return-1;if(e.requestSource>t.requestSource)return 1;const i=!!this.getBtOccurrence(e.bodyOccurrence);return i!==!!this.getBtOccurrence(t.bodyOccurrence)?i?-1:1:e.benefitToProcess>t.benefitToProcess?-1:e.benefitToProcess<t.benefitToProcess?1:0})),this.upgradeTessellations(this.occurrenceRetrievalRequests,this.bodyOccurrenceToRetrievalRequest);this.occurrenceRetrievalRequests.sort(((e,t)=>{const i=e.finestTessellationSettingInMemory>e.tessellationSettingRequested&&e.tessellationSettingRequested!==k.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING,s=t.finestTessellationSettingInMemory>t.tessellationSettingRequested&&t.tessellationSettingRequested!==k.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING;return i!==s?s?1:-1:0}))}upgradeTessellations(e,t){let i=0;const s=this.viewer.getModelViewManagers().getManager().getBodyRefinementMemoryLimit();for(const t of e)t.tessellationSettingRequested=k.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING;if(i=this.upgradeTessellationSettingsConditionally(e,(e=>e.tessellationSettingRequested<e.tessellationSettingDesired),i,s),i=this.upgradeTessellationSettingsConditionally(e,(e=>e.tessellationSettingRequested<e.finestTessellationSettingInMemory),i,s),_c()){const n=this.getLoadedDisplayDataVolume(),r=this.getDesiredDisplayDataVolume(e),a=[];a.push(`Total display data in memory: ${Nc(n)}`),a.push(`Total desired memory usage: ${Nc(r)}`),a.push(`Maximum allowed memory usage: ${Nc(s)}`),a.push(`Total requested display memory after optimization: ${Nc(i)}`),e.forEach((({bodyOccurrence:e})=>{const i=e.getBodyMetaDataForRetrieval(),s=i.getFinestTessellationSettingInMemory(),n=t.get(e),r=i.getBestAvailableTessellationSettingIndex(this.aggressiveRefinementEnabled);a.push(`${i.name}, ${i.getId()}, in memory = ${s}, maximum = ${r}, desired = ${n?.tessellationSettingDesired}, requested = ${n?.tessellationSettingRequested}`)})),a.push(`Number of visible occurrences in frustum=${e.length}`),ut.log.info(a.join("\n"))}}upgradeTessellationSettingsConditionally(e,t,i,s){let n=!0;for(;n;){n=!1;const r=new Map;for(const a of e){const e=a.bodyOccurrence.getBodyMetaDataForRetrieval(),o=r.get(e);if(o)a.tessellationSettingRequested=o.tessellationSettingRequested;else{if(t(a)){const t=e.getEstimatedMemoryUsage([a.tessellationSettingRequested+1])-e.getEstimatedMemoryUsage([a.tessellationSettingRequested]);i+t<=s&&(a.tessellationSettingRequested+=1,i+=t,n=!0)}r.set(e,a)}}}return i}getDesiredDisplayDataVolume(e){let t=0;const i=new Set;for(const s of e){const e=s.bodyOccurrence.getBodyMetaDataForRetrieval();i.has(e)||(i.add(e),s.tessellationSettingDesired>=0&&(t+=e.getEstimatedMemoryUsage([s.tessellationSettingDesired])))}return t}getLoadedDisplayDataVolume(){let e=0;const t=new Set;return this.occurrences.forEach((function(i){const s=i.getBodyMetaDataForRetrieval();t.has(s)||(t.add(s),e+=s.getEstimatedMemoryUsage())}),this),e}performUnloadedBodyAndRefinementCheck(){if(this.paused)return void ut.log.info("Skipped body refinement check due to pause");if(Ac===Pc.DISABLED)return;if(!this.encounteredUnloadedOccurrenceInLastFrame&&!this.allowRefinementCheck())return;const e=_c(),t=new Qo.B7("BodyManager.performUnloadedBodyAndRefinementCheck",{logResult:e});this.findMaximumRefinementForOccurrences(),this.startRetrievalTimeout(),t.report()}collectBodyOccurrencesInViewport(){const e=new Qo.B7("BodyManager.collectBodyOccurrencesInViewport"),t=[];let i=[];const s=this.viewer.getCamera();if(s){const e=s.viewportToCanvas([0,s.getViewportHeight(),0]),n=this.aggressiveRefinementEnabled&&Ns();i=this.viewer.pickInRect(e[0],e[1],s.getViewportWidth(),s.getViewportHeight(),{bodyPicks:t,nodeFilterOverride:this.refinementNodeFilter,sampleLimit:X.default.getManager().getNumber("OFFSCREEN_BODY_ERROR_SAMPLE_SIZE"),doNotAffectFrustumCulling:!0,forcePreviewPick:n})}const n=new Map;for(let e=0;e<t.length;++e){const i=t[e],s=i.primitiveId;if(s.length<1)continue;s.length>1&&ut.log.warn("Picked body manager occurrence id with multiple entries");const r=this.idManager.getNameForId(s),a=this.occurrences.get(r);a&&this.collectBodyOccurrenceForOccurrencePick(n,a,i)}for(let e=0;e<i.length;++e)this.collectBodyOccurrenceForEntityPick(n,i[e]);return e.report(),n}updatePickData(e){let t=!1;const i=e.primitiveId;if(i.length<1)return t;i.length>1&&ut.log.warn("Picked body manager occurrence id with multiple entries");const s=this.idManager.getNameForId(i),n=this.occurrences.get(s);if(n)if(e.bodyMetaData=n.getBodyMetaDataForRetrieval(),e.occurrence=this.getBtOccurrence(n),e.occurrence)e.occurrenceId=this.viewer.getOccurrenceIdManager().getIdForName(e.occurrence.toString()),t=!0;else{const i=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();i&&(e.occurrenceId=i.getBodyComponent().getCorrectedBodyOccurrenceId(e.bodyMetaData.id),t=!0)}return t}hideBodyFromPick(e){const t=this.occurrences.get(this.getBodyOccurrenceId(e.occurrenceId,e.bodyMetaData.id));t?.incrementDetails&&(this.displayOccurrenceData.hideIncrementFromPick(t.incrementDetails,fs.L.BASE),this.displayOccurrenceDataNonIsolated.hideIncrement(t.incrementDetails,fs.L.BASE))}shouldRetrieveHighestQualityTessellationForOccurrence(e){if(e.getBodyMetaData().getTessellationSettingOverride()!==k.XiJ.AUTO)return!0;let t=this.getBtOccurrence(e);for(;t;){const e=this.viewer.getModelViewManagers().getManager().getOccurrenceDisplayData(t);if(e&&e.occurrenceData.forceHighestQualityTessellation)return!0;t.path.length>0?t.path.splice(t.path.length-1,1):t=null}return!1}collectBodyOccurrenceForEntityPick(e,t){if(t.isUIPick())return;const i=t.getOccurrence();let s,n,r=t.getBodyId();if(!r)return;const a=this.viewer.getModelViewManagers().getManagerForUsage(t.usage);if(i)s=this.viewer.getOccurrenceIdManager().getIdForName(i.toString()),n=a.retrieveBodyMetaData(i,r),n&&n.canBeGroupedWithOtherConstituents&&(r=n.consumingClosedCompositeData.getId());else{const e=a.getDisplayedPartStudio();if(!e)return;n=e.retrieveBodyMetaData(r),n&&n.canBeGroupedWithOtherConstituents&&(r=n.consumingClosedCompositeData.getId()),s=e.getBodyComponent().getCorrectedBodyOccurrenceId(r)}let o=this.occurrences.get(this.getBodyOccurrenceId(s,r));if(!o&&t.usage===fs.L.PREVIEW&&(o=this.previewOccurrences.get(r),!o)){const e=this.viewer.getOccurrenceDataManager().getOccurrenceData(s);e&&n&&(o=new Vc(e,n),this.previewOccurrences.set(r,o))}o&&this.collectBodyOccurrenceForOccurrencePick(e,o,t)}collectBodyOccurrenceForOccurrencePick(e,t,i){const s=e.get(t);s?s.viewportOccupancyRatio+=i.coverage:e.set(t,{viewportOccupancyRatio:i.coverage})}getBodiesInFrustum(){const e=new Set,t=this.viewer.getCamera();return this.occurrences.forEach((function(i){i.outsideFrustum(t)||e.add(i.getBodyMetaData())}),this),e}getBodiesInvolvedInSelection(){const e=new Set,t=(0,Ce._g)();for(let i=0;i<t.length;++i){t[i].forEach((t=>{let i=t.getBodyMetaData();!i&&t.getEntityMetaData()&&(i=t.getEntityMetaData().getBodyMetaData()),i&&e.add(i)}))}return e}refreshReducedDetailBoxes(){this.sortedOccurrences&&(this.sortedOccurrences.forEach((e=>{e.displayDamaged=!0})),this.shouldUpdateBodyOccurrenceLodForIsolate=!0)}onOccurrencesHighlighted(e,t){if(e===dn.aU.ADD){const e=this.viewer.getModelViewManagers().getManager(),i=this.viewer.getOccurrenceIdManager();for(let s=0;s<t.length;++s){const n=e.getOccurrenceDisplayData(t[s]);if(!n?.displayedPartIds)continue;const r=i.getIdForName(t[s].toString());for(const e of n.displayedPartIds){const t=this.occurrences.get(this.getBodyOccurrenceId(r,e));t?.mustShowLowestLod()&&(t.displayDamaged=!0)}}}}getPartStudio(e){const t=this.viewer.getModelViewManagers().getManager(),i=this.getBtOccurrence(e);return i?t.getPartStudioDataFromOccurrence(i):t.getDisplayedPartStudio()}getTessellationIndexToGoUnderThreshold(e,t,i,s){let n=0;const r=e.getBodyMetaData();if(r.isWireBody()&&!r.hasTessellationSettings())return null;if(r.isClosedComposite&&r.containsOnlyWireBodies()){const t=this.getPartStudio(e);if(t)for(let e=0;e<r.constituentBodyIds.length;++e){const i=t.retrieveBodyMetaData(r.constituentBodyIds[e]);if(i&&!i.hasTessellationSettings())return null}}if(this.viewer.getRenderingMode()===k.P1.SHADED_CURVATURE_VISUALIZATION)return k.ls1.getTessellationSettingIndexFromEnum(k.XiJ.CURVATURE_VISUALIZATION);const a=r.getBestAvailableTessellationSettingIndex(!!s);if(null===a)return null;for(;n<a;){if(!(i*r.getChordalToleranceForSetting(n)>=t))break;n++}return n}cleanupPendingRefinementRequests(){if(0===this.pendingRetrievalInformation.size)return;const e=new Set;for(const[t,i]of this.pendingRetrievalInformation){t.getFinestTessellationSettingInMemory()===i.tessellationSetting&&(e.add(t),this.pendingRetrievalInformation.delete(t))}const t=new Set;this.occurrences.forEach((i=>{const s=i.getBodyMetaDataForRetrieval();t.add(s),e.has(s)&&this.resetRetrievalStateForOccurrence(i)}));for(const[e,i]of this.pendingRetrievalInformation)t.has(e)||this.pendingRetrievalInformation.delete(e);_c()&&ut.log.info(`Number of refined pending requests: ${e.size} remaining: ${this.pendingRetrievalInformation.size}`)}unloadBodies(e,t){if(_c()&&ut.log.info(`Unload bodies ${Nc(e)}`),this.paused)return ut.log.info("Skipped body unloading due to pause"),null;const i=Array.from(this.occurrences.values()),s=this.getBodiesInFrustum(),n=this.getBodiesInvolvedInSelection(),r=new Map;for(const e of this.occurrenceRetrievalRequests){const t=e.bodyOccurrence.getBodyMetaDataForRetrieval();r.has(t)||r.set(t,e)}const a=t.getDisplayedPartStudio(),o=t.getPartStudios();for(let e=0;e<o.length;++e){const t=o[e];if(t===a)continue;const s=t.getBodyComponent().getNonInstantiatedBodies();for(let e=0;e<s.length;++e){const n=s[e];n.hasTessellationSettings()&&i.push(new Lc(t,n))}}i.sort((function(e,t){if(e.isInstantiated()!==t.isInstantiated())return e.isInstantiated()?1:-1;const i=e.isBodyDataPresent(),r=t.isBodyDataPresent();if(!i&&!r)return 0;if(!i)return 1;if(!r)return-1;const a=e.getBodyMetaDataForRetrieval(),o=t.getBodyMetaDataForRetrieval(),h=n.has(a);if(h!==n.has(o))return h?1:-1;const c=s.has(a);if(c!==s.has(o))return c?1:-1;const l=e.getLastViewTime(),u=t.getLastViewTime();if(l!==u)return l>u?1:-1;const d=e.getLastViewportOccupancy(),g=t.getLastViewportOccupancy();if(d!==g)return d>g?1:-1;const p=e.getBenefitToUnload(),m=t.getBenefitToUnload();return p>m?-1:m>p?1:0}));const h=new Set;let c=0;for(let t=0;t<i.length&&c<e;++t){const e=i[t],s=e.getBodyMetaDataForRetrieval();if(s.isWireBody())continue;if(!e.isBodyDataPresent()||h.has(s)||n.has(s))continue;if(r.has(s)){const e=r.get(s);if(e?.tessellationSettingRequested!==k.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING)continue}let a;a=e instanceof Vc?this.getPartStudio(e):e.partStudio,a&&(c+=s.getEstimatedMemoryUsage(),this.bodyUnloadTask.addBodyToProcess(a.getBodyComponent(),s.getId()),h.add(s))}if(_c()){const t=[];h.forEach((function(e){t.push(e.getId()+"-"+e.getFinestTessellationSettingInMemory())})),t.sort(),ut.log.info("Unloading "+Nc(c)+" of bodies to satisfy request of "+Nc(e)+". Body ids:\n"+t)}return this.occurrences.forEach((e=>{h.has(e.getBodyMetaDataForRetrieval())&&this.resetRetrievalStateForOccurrence(e)})),this.bodyUnloadTask.getTaskFinishedPromise()}unloadSelectionBody(e){const t=e.getBodyMetaData()||e.getEntityMetaData()?.getBodyMetaData();if(!t)return;const i=this.viewer.getModelViewManagers().getManager().getPartStudioDataFromOccurrence(e.getOccurrence());i&&this.bodyUnloadTask.addBodyToProcess(i.getBodyComponent(),t.id),this.viewer.requestDraw()}}function kc(e,t){const i=e.getBenefitToCull(),s=t.getBenefitToCull();return i===s?e.getOccurrenceId()===t.getOccurrenceId()?0:e.getOccurrenceId()<t.getOccurrenceId()?-1:1:i>s?-1:1}const Wc=X.default.getManager();var zc;function Xc(e,t){return e+un.ID_SEPARATOR+t.getCollectionId()}!function(e){e[e.UNLOAD=0]="UNLOAD",e[e.LOAD=1]="LOAD"}(zc||(zc={}));class Zc{constructor(e,t){this.bodyComponent=e,this.bodyId=t}getCollectionId(){return Xc(this.bodyId,this.bodyComponent)}}class qc{constructor(e,t){this.viewer=e,this.action=t,this.bodiesToProcess=[],this.bodiesNeedSort=!1,this.taskFinishedDeferred=null,this.iterationsSinceStart=0,this.bodiesProcessedSinceStart=0,(0,Jo.Yk)(e),this.bodiesToProcessMap=new Map,this.initialLoadBudget=new KT(Wc.getNumber("GRAPHICS_TASK_INITIAL_TIME_BUDGET"),Wc.getNumber("GRAPHICS_TASK_INITIAL_VERTEX_BUDGET"))}addBodyToProcess(e,t){const i=new Zc(e,t),s=i.getCollectionId();this.bodiesToProcessMap.get(s)||(this.bodiesToProcess.push(i),this.bodiesToProcessMap.set(s,i),this.setBodiesNeedSort())}performInitialLoad(){const e=new Qo.B7("BodyLoader.prototype.performInitialLoad");this.initialLoadBudget.reset(),this.process(this.initialLoadBudget),e.report()}indexOfBody(e,t){for(let i=0;i<this.bodiesToProcess.length;++i){const s=this.bodiesToProcess[i];if(s.bodyComponent===e&&s.bodyId===t)return i}return-1}stopBodyFromProcessing(e,t){if(this.bodiesToProcessMap.has(Xc(t,e))){const i=this.indexOfBody(e,t);i>=0&&(this.bodiesToProcessMap.delete(this.bodiesToProcess[i].getCollectionId()),this.bodiesToProcess.splice(i,1))}}clearBodiesForComponent(e,t){const i=[];for(let s=0;s<this.bodiesToProcess.length;++s){const n=this.bodiesToProcess[s];n.bodyComponent===e&&t.contains(n.bodyId)&&(yI([s,s+1],i),this.bodiesToProcessMap.delete(n.getCollectionId()))}vI(this.bodiesToProcess,i)}clearAllBodiesForComponent(e){const t=[];for(let i=0;i<this.bodiesToProcess.length;++i)this.bodiesToProcess[i].bodyComponent===e&&(yI([i,i+1],t),this.bodiesToProcessMap.delete(this.bodiesToProcess[i].getCollectionId()));vI(this.bodiesToProcess,t)}setBodiesNeedSort(){this.bodiesNeedSort=!0}clearAllBodies(){this.bodiesToProcess=[],this.bodiesToProcessMap.clear(),this.bodiesNeedSort=!1}hasPendingWork(){return this.bodiesToProcess.length>0}sortBodies(){this.bodiesNeedSort&&(this.bodiesToProcess.sort((function(e,t){const i=e.bodyComponent.isBodyInstantiated(e.bodyId);if(i!==t.bodyComponent.isBodyInstantiated(t.bodyId))return i?-1:1;const s=e.bodyComponent.getBodyDiameter(e.bodyId),n=t.bodyComponent.getBodyDiameter(t.bodyId);return s>n?-1:s<n?1:0})),this.bodiesNeedSort=!1)}process(e){this.sortBodies();const t=[];let i=0;for(let s=0;s<this.bodiesToProcess.length;++s){const n=this.bodiesToProcess[s];let r=!1;if(this.action===zc.UNLOAD?(n.bodyComponent.unloadBody(n.bodyId),++i,r=!0):n.bodyComponent.processBodyAddition(n.bodyId,e)&&(++i,r=!0),r&&(yI([s,s+1],t),this.bodiesToProcessMap.delete(n.getCollectionId())),e&&e.budgetExceeded())break}vI(this.bodiesToProcess,t),i>0&&this.action===zc.LOAD&&this.viewer.getEventDispatcher().trigger(yD.LA),i>0&&(this.bodiesProcessedSinceStart+=i,++this.iterationsSinceStart),this.hasPendingWork()||(this.taskFinishedDeferred&&(this.taskFinishedDeferred.resolve({bodiesProcessedSinceStart:this.bodiesProcessedSinceStart,iterationsSinceStart:this.iterationsSinceStart}),this.taskFinishedDeferred=null),this.iterationsSinceStart=0,this.bodiesProcessedSinceStart=0)}getTaskFinishedPromise(){return this.taskFinishedDeferred?this.taskFinishedDeferred.promise:this.hasPendingWork()?(this.taskFinishedDeferred=Ur.defer(),this.taskFinishedDeferred.promise):null}}class Yc{constructor(e){this.loadTask=new qc(e,zc.LOAD),this.unloadTask=new qc(e,zc.UNLOAD)}getLoadTask(){return this.loadTask}getUnloadTask(){return this.unloadTask}postBodyToLoad(e,t){this.loadTask.addBodyToProcess(e,t),this.unloadTask.stopBodyFromProcessing(e,t)}postBodyToUnload(e,t){this.unloadTask.addBodyToProcess(e,t),this.loadTask.stopBodyFromProcessing(e,t)}completeTasks(){this.loadTask.process(null),this.unloadTask.process(null)}stopBodyFromProcessing(e,t){this.loadTask.stopBodyFromProcessing(e,t),this.unloadTask.stopBodyFromProcessing(e,t)}clearBodiesForComponent(e,t){this.loadTask.clearBodiesForComponent(e,t),this.unloadTask.clearBodiesForComponent(e,t)}clearAllBodiesForComponent(e){this.loadTask.clearAllBodiesForComponent(e),this.unloadTask.clearAllBodiesForComponent(e)}clearAllBodies(){this.loadTask.clearAllBodies(),this.unloadTask.clearAllBodies()}hasPendingUnloads(){return this.unloadTask.hasPendingWork()}}const Kc=X.default.getManager(),jc=new xi.hF({primitiveType:Di.MX.LINES,isShowThrough:!0,isDepthTested:!1,isPickable:!1}),Qc=jc.cloneAndModify({includedInBlend:!0}),$c=jc.cloneAndModify({priority:xi.DO.HIGHER}),Jc=jc.cloneAndModify({priority:xi.DO.HIGHEST}),el=new xi.hF({primitiveType:Di.MX.TRIANGLE_STRIP,isTwoSided:!0,isShowThrough:!0,isDepthTested:!1,isPickable:!1,zOffset:Kc.getNumber("MATE_CONNECTOR_TRIANGLE_Z_OFFSET"),primitivesHaveTransparency:!0,material:bi}),tl=el.cloneAndModify({priority:xi.DO.HIGHER}),il=el.cloneAndModify({includedInBlend:!0}),sl=el.cloneAndModify({priority:xi.DO.HIGHEST}),nl=new xi.hF({primitiveType:Di.MX.TRIANGLES,isTwoSided:!0,isShowThrough:!0,isDepthTested:!1,isVisible:!1});var rl;!function(e){e.LINES="lines",e.LINES_FADED="lines_faded",e.TRIANGLES="triangles",e.COMPARE_BASE_TRIANGLES="compare_base_triangles",e.COMPARE_TARGET_TRIANGLES="compare_target_triangles",e.TRIANGLES_PRESELECTED="triangles_preselected",e.TRIANGLES_SELECTED="triangles_selected",e.TRIANGLES_SECONDARY="triangles_secondary",e.TRIANGLES_FADED="triangles_faded",e.PICK_DISC="pick_disc",e.INFERENCE_POINT_TRIANGLES="inference_point_triangles",e.INFERENCE_POINT_LINES="inference_point_lines",e.INFERENCE_CENTER_TRIANGLES="inference_center_triangles",e.INFERENCE_CENTER_LINES="inference_center_lines",e.INFERENCE_CENTROID_TRIANGLES="inference_centroid_triangles",e.INFERENCE_CENTROID_LINES="inference_centroid_lines",e.INFERENCE_MID_POINT_TRIANGLES="inference_mid_point_triangles",e.INFERENCE_MID_POINT_LINES="inference_mid_point_lines",e.INFERENCE_ORIGIN_AXIS_LINES="inference_origin_axis_lines",e.INFERENCE_ORIGIN_AXIS_LINES_PRESELECTED="inference_origin_axis_lines_preselected"}(rl||(rl={}));let al=null,ol=!0;class hl extends Ti.u1{constructor(e,t,i,s){super(i,t),this.definition=e,this.isBeingEdited=!1,this.lastScale=-1,this.worldSpacePosition=[0,0,0],this.activeMateConnectorScaled=!1,this.isForInContextAssembly=!1,this.isFromChildFeature=!1,this.isParentOccurrenceDataMissing=!1,this.partStudioFeatureId=s||"",this.isPartStudioMateConnector=!!this.partStudioFeatureId,this.occurrenceTransform=de.create(),this.parentOccurrenceVisibility=Fs.EE.VISIBLE,this.usage=t===Zo.Vv?fs.L.PREVIEW:fs.L.BASE,this.damageTransform(),this.updateHideState(),this.occurrenceData.setCanIsolateChange(!0),this.occurrenceData.setIsolated(!1),this.isForInContextAssembly=e&&e.occurrence&&this.viewer.getModelViewManagers().getManager().isDisplayingIncontextAssembly(),this.definition.implicit&&(this.id="ImplicitMateConnector")}cloneForPreview(){return new hl(this.definition,Zo.Vv,this.viewer,this.partStudioFeatureId)}getUsage(){return this.usage}getWorldSpacePosition(){return this.worldSpacePosition}onDevicePixelRatioChanged(e){al=null,this.updateGraphics()}getIsPartStudioMateConnector(){return this.isPartStudioMateConnector}getId(){return(0,ln.vm)(this.definition.ownerOccurrence,this.definition.nodeId)}setOccurrenceTransform(e){this.occurrenceTransform=e,this.damageTransform()}setEditState(e){this.isBeingEdited=e,this.updateHideState(),this.updateGraphics()}getDefinition(){return this.definition?this.definition:null}getLineProperties(){return this.isForInContextAssembly?jc:Qc}getTriangleProperties(){return this.isForInContextAssembly?jc:il}updateDefinition(e){this.definition=e,this.updateHideState(),this.damageTransform()}damageTransform(){this.lastScale=-1,this.definition&&ge.w$.multiplyVec3(this.occurrenceTransform,this.definition.location.origin.getVec3(),this.worldSpacePosition),this.viewer.requestDraw()}getWorldSpaceDefinition(){if(!this.definition)return null;const e=new k.em5,t=this.definition.location.xAxis.getVec3(),i=this.definition.location.yAxis.getVec3(),s=this.definition.location.zAxis.getVec3(),n=this.definition.location.origin.getVec3(),r=ge.w$.toRotationMat(this.occurrenceTransform,de.create());return ge.w$.multiplyVec3(this.occurrenceTransform,n),ge.w$.multiplyVec3(r,t),ge.w$.multiplyVec3(r,i),ge.w$.multiplyVec3(r,s),e.xAxis.updateFromArray(t),e.yAxis.updateFromArray(i),e.zAxis.updateFromArray(s),e.origin.updateFromArray(n),e}canPickThrough(){return!0}getPickPriority(){return qm.z.MATE_CONNECTOR}getModelSelection(e){return this.definition?new Ce.Y1(k.lQt.MATE_CONNECTOR,this.definition.nodeId,this.definition.ownerOccurrence,{sourcePick:e.sourcePick,isPartStudioMateConnector:this.isPartStudioMateConnector,isDerivedFeature:this.definition.isDerivedFeature,isChildFeature:this.isFromChildFeature,featureId:this.partStudioFeatureId}):null}addHighlight(e){super.addHighlight(e),this.updateHideState(),this.updateGraphics()}removeHighlight(e){return!!super.removeHighlight(e)&&(this.updateHideState(),this.updateGraphics(),!0)}getUserVisibilitySetting(){return this.definition.hidden?Fs.EE.HIDDEN:Fs.EE.VISIBLE}updateOccurrenceVisibility(e){e!==this.parentOccurrenceVisibility&&(this.parentOccurrenceVisibility=e,this.updateHideState(),this.updateGraphics())}updateHideState(){!this.isParentOccurrenceDataMissing&&(this.isBeingEdited||this.isHighlighted()||this.getUserVisibilitySetting()!==Fs.EE.HIDDEN&&this.parentOccurrenceVisibility!==Fs.EE.HIDDEN)?(this.hasMeshIncrements()||this.updateGraphics(!0),this.show()):this.hide()}setOpacity(e){const t=cl(),i=Kc.getColor("MATE_CONNECTOR_COLOR");i[3]=e,(0,Au.Ab)(i,t[rl.TRIANGLES_FADED]),this.updateMeshIncrement(rl.TRIANGLES,Ti.ZJ,t[rl.TRIANGLES_FADED].clone(),this.getTriangleProperties()),this.setLineOpacity(e)}onIsolateChanged(){this.updateGraphics()}updateIsolation(){if(this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()&&!this.occurrenceData.getIsolated()){let e=0;e=this.isForInContextAssembly?Kc.getNumber("ISOLATE_CONTEXT_UI_MATE_CONNECTOR_TRANSPARENCY"):Kc.getNumber("ISOLATE_CONTEXT_UI_TRANSPARENCY")*Ke()+(1-Ke()),this.setOpacity(e)}else{const e=cl();this.updateBaseIncrements(e)}}updateBaseIncrements(e){let t=rl.TRIANGLES;const i=ws(),s=!!i&&(Ki.Jq.PartStudioCompareService.isPartStudioComparisonReady()&&Ki.Jq.PartStudioCompareService.doesFeatureHaveADifference(this.partStudioFeatureId));i&&s&&(t=this.sceneGraphId===Zo.lL?rl.COMPARE_BASE_TRIANGLES:rl.COMPARE_TARGET_TRIANGLES),this.updateMeshIncrement(rl.TRIANGLES,Ti.ZJ,e[t].clone(),this.getTriangleProperties()),this.setLineOpacity(1),this.updateMeshIncrement(rl.LINES,Ti.ZJ,e[rl.LINES].clone(),this.getLineProperties())}setLineOpacity(e){const t=cl(),i=(0,Au.Ae)(t[rl.LINES_FADED],e);this.updateMeshIncrement(rl.LINES,Ti.ZJ,i.clone(),this.getLineProperties())}adjustTransform(e){if(!this.definition||this.isHidden)return;let t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition);const i=this.getIsActiveMateConnector();if(this.activeMateConnectorScaled&&!i&&(this.activeMateConnectorScaled=!1,this.lastScale=-1),Math.abs(this.lastScale-t)<Ci.W.ZERO_LENGTH)return;this.lastScale=t,i&&(t*=Kc.getNumber("ACTIVE_MATE_CONNECTOR_SIZE_SCALE_PERCENT"),this.activeMateConnectorScaled=!0);const s=de.create();s[0]=t,s[5]=t,s[10]=t,this.setTransform(ge.w$.multiply(ge.w$.multiply(this.occurrenceTransform,this.definition.location.getGlMatrix(),de.create()),s)),this.hasMeshIncrements()||this.updateGraphics()}getIsActiveMateConnector(){const e=this.viewer.getMateConnectorManager();return!!e&&e.isMateConnectorActive(this.getId(),this)}onViewWillDraw(e){this.isHidden||this.hasBeenRemoved||(this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()&&this.updateGraphics(),this.adjustTransform(e))}onHighlightColorUpdated(){this.isHighlighted()&&this.updateGraphics()}updateGraphics(e){if(!this.definition||this.isHidden&&!e)return void this.removeMeshIncrements();const t=cl();this.updateMeshIncrement(rl.PICK_DISC,"mateconnector",t[rl.PICK_DISC].clone(),nl);const i=this.getHighlight();i&&i.type===dn.o2.PRE?(this.updateMeshIncrement(rl.TRIANGLES,Ti.ZJ,t[rl.TRIANGLES_PRESELECTED].clone(),sl),this.updateMeshIncrement(rl.LINES,Ti.ZJ,t[rl.LINES].clone(),Jc)):i&&[dn.o2.SECONDARY,dn.o2.REPAIR_HOVER].includes(i.type)?(this.updateMeshIncrement(rl.TRIANGLES,Ti.ZJ,t[rl.TRIANGLES_SECONDARY].clone(),sl),this.updateMeshIncrement(rl.LINES,Ti.ZJ,t[rl.LINES].clone(),Jc)):i?(this.updateMeshIncrement(rl.TRIANGLES,Ti.ZJ,t[rl.TRIANGLES_SELECTED].clone(),sl),this.updateMeshIncrement(rl.LINES,Ti.ZJ,t[rl.LINES].clone(),Jc),this.muteIfActive()):(this.updateBaseIncrements(t),this.updateIsolation(),this.muteIfActive())}muteIfActive(){if(this.hasBeenRemoved)return;const e=this.getIsActiveMateConnector();if(e&&this.setOpacity(Kc.getNumber("ACTIVE_MATE_CONNECTOR_OPACITY")),this.activeMateConnectorScaled!==e){if(!e){const e=1;this.setOpacity(e)}this.damageTransform()}}static setInteractionEnabled(e){ol=e}isInteractionEnabled(){return ol&&!(this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()&&!this.occurrenceData.getIsolated())}getOccurrence(){return this.definition?this.definition.occurrence:null}setIsParentOccurrenceDataMissing(e){this.isParentOccurrenceDataMissing=e,this.updateHideState()}}function cl(){if(al)return al;al={};const e=C.create(),t=C.fromValues(0,0,1),i=C.fromValues(1,0,0),s=Math.PI/2,n=.75*Kc.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS"),r=.25*Kc.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS");let a=Kc.getNumber("MATE_CONNECTOR_DIAMETER_PX")/2;const o=a-Kc.getNumber("MATE_CONNECTOR_RING_WIDTH_PX"),h=Kc.getColor("MATE_CONNECTOR_STROKE_COLOR");let c=Kc.getNumber("MATE_CONNECTOR_STROKE_WIDTH"),l=(0,Au.y)(e,a,t,Kc.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS"));(0,Au.Ab)(h,l),(0,Au.VQ)(c,l);const u=(0,Au.QV)(e,o,t,i,s,2*Math.PI,n);(0,Au.Ab)(h,u),(0,Au.VQ)(c,u);let d=(0,Au.W5)(e,[o,0,0],void 0,h,c),g=(0,Au.W5)(e,[0,o,0],void 0,h,c);const p=Kc.getNumber("MATE_CONNECTOR_AXIS_LINE_GAP_PX"),m=Kc.getNumber("MATE_CONNECTOR_AXIS_LINE_LENGTH_PX"),f=Kc.getNumber("MATE_CONNECTOR_AXIS_LINE_WIDTH"),I=Kc.getNumber("MATE_CONNECTOR_Z_AXIS_LINE_LENGTH_PX"),E=Kc.getNumber("MATE_CONNECTOR_Z_AXIS_LINE_WIDTH"),S=(0,Au.W5)([a+p,0,0],[a+p+m,0,0],void 0,Kc.getColor("X_AXIS_COLOR"),f),T=(0,Au.W5)([0,a+p,0],[0,a+p+m,0],void 0,Kc.getColor("Y_AXIS_COLOR"),f),D=(0,Au.W5)([0,0,p],[0,0,p+I],void 0,Kc.getColor("Z_AXIS_COLOR"),E);let M=l.concatenate(u).concatenate(d).concatenate(g).concatenate(S).concatenate(T).concatenate(D);M&&(al[rl.LINES]=M,al[rl.LINES_FADED]=M.clone());const y=(0,Au.I$)(e,o,a,t,i,s,2*Math.PI,n),P=(0,Au.I$)(e,0,a,t,i,0,s,r),A=y.concatenate(P);A&&(al[rl.TRIANGLES]=A,(0,Au.Ab)(Kc.getColor("MATE_CONNECTOR_COLOR"),al[rl.TRIANGLES]),al[rl.COMPARE_BASE_TRIANGLES]=A.clone(),(0,Au.Ab)(Kc.getColor("MATE_CONNECTOR_COMPARE_BASE_COLOR"),al[rl.COMPARE_BASE_TRIANGLES]),al[rl.COMPARE_TARGET_TRIANGLES]=A.clone(),(0,Au.Ab)(Kc.getColor("MATE_CONNECTOR_COMPARE_TARGET_COLOR"),al[rl.COMPARE_TARGET_TRIANGLES]),al[rl.TRIANGLES_PRESELECTED]=A.clone(),(0,Au.Ab)(Kc.getColor("MATE_CONNECTOR_PRE_SELECTED_COLOR"),al[rl.TRIANGLES_PRESELECTED]),al[rl.TRIANGLES_SELECTED]=A.clone(),(0,Au.Ab)(Kc.getColor("MATE_CONNECTOR_SELECTED_COLOR"),al[rl.TRIANGLES_SELECTED]),al[rl.TRIANGLES_FADED]=A.clone(),al[rl.TRIANGLES_SECONDARY]=A.clone(),(0,Au.Ab)(Kc.getColor("MATE_CONNECTOR_SECONDARY_COLOR"),al[rl.TRIANGLES_SECONDARY])),al[rl.PICK_DISC]=(0,Au.$)(e,a,t,Kc.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS")),a=Kc.getNumber("MATE_CONNECTOR_MINI_DIAMETER_PX")/2,c=Kc.getNumber("MATE_CONNECTOR_MINI_STROKE_WIDTH"),l=(0,Au.y)(e,a,t,Kc.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS")),(0,Au.Ab)(Kc.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),l),al[rl.INFERENCE_POINT_LINES]=l,al[rl.INFERENCE_POINT_TRIANGLES]=(0,Au.I$)(e,0,a,t,i,0,2*Math.PI,4*r),(0,Au.Ab)(Kc.getColor("MATE_CONNECTOR_INFERENCE_FILL_COLOR"),al[rl.INFERENCE_POINT_TRIANGLES]),l=(0,Au.y)(e,a,t,Kc.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS")),(0,Au.Ab)(Kc.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),l),(0,Au.VQ)(c,l),d=(0,Au.W5)([-a,0,0],[a,0,0],void 0,Kc.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),g=(0,Au.W5)([0,-a,0],[0,a,0],void 0,Kc.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),M=l.concatenate(d),M=M.concatenate(g),M&&(al[rl.INFERENCE_CENTER_LINES]=M),al[rl.INFERENCE_CENTER_TRIANGLES]=(0,Au.I$)(e,0,a,t,i,0,2*Math.PI,4*r),(0,Au.Ab)(Kc.getColor("MATE_CONNECTOR_INFERENCE_FILL_COLOR"),al[rl.INFERENCE_CENTER_TRIANGLES]),l=(0,Au.y)(e,a,t,Kc.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS")),(0,Au.Ab)(Kc.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),l),(0,Au.VQ)(c,l),d=(0,Au.W5)([-a,0,0],[a,0,0],void 0,Kc.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),g=(0,Au.W5)([0,-a,0],[0,a,0],void 0,Kc.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),M=l.concatenate(d).concatenate(g),M&&(al[rl.INFERENCE_CENTROID_LINES]=M);const O=(0,Au.I$)(e,0,a,t,i,0,.5*Math.PI,r);(0,Au.Ab)(Kc.getColor("MATE_CONNECTOR_INFERENCE_FILL_COLOR"),O);const v=(0,Au.I$)(e,0,a,t,i,.5*Math.PI,Math.PI,r);(0,Au.Ab)(Kc.getColor("MATE_CONNECTOR_INFERENCE_DARK_FILL_COLOR"),v);const R=(0,Au.I$)(e,0,a,t,i,Math.PI,1.5*Math.PI,r);(0,Au.Ab)(Kc.getColor("MATE_CONNECTOR_INFERENCE_FILL_COLOR"),R);const w=(0,Au.I$)(e,0,a,t,i,1.5*Math.PI,2*Math.PI,r);(0,Au.Ab)(Kc.getColor("MATE_CONNECTOR_INFERENCE_DARK_FILL_COLOR"),w);const _=O.concatenate(v).concatenate(R).concatenate(w);al[rl.INFERENCE_CENTROID_TRIANGLES]=_;const N=.7071*a,b=(0,Au.W5)([-N,-N,0],[N,-N,0],void 0,Kc.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),L=(0,Au.W5)([-N,N,0],[N,N,0],void 0,Kc.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),F=(0,Au.W5)([-N,-N,0],[-N,N,0],void 0,Kc.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),x=(0,Au.W5)([N,-N,0],[N,N,0],void 0,Kc.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c);M=b.concatenate(L).concatenate(F).concatenate(x),M&&(al[rl.INFERENCE_MID_POINT_LINES]=M),al[rl.INFERENCE_MID_POINT_TRIANGLES]=(0,Au.VO)([-N,-N,0,N,-N,0,N,N,0,-N,N,0],[1,2,0,3],void 0,Kc.getColor("MATE_CONNECTOR_INFERENCE_FILL_COLOR"));const B=5*Kc.getNumber("MATE_CONNECTOR_AXIS_LINE_LENGTH_PX"),V=2*Kc.getNumber("MATE_CONNECTOR_Z_AXIS_LINE_WIDTH"),U=(0,Au.W5)([0,0,0],[0,0,B],void 0,Kc.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),V),G=(0,Au.W5)([0,0,p],[0,0,B],void 0,Kc.getColor("MATE_CONNECTOR_SELECTED_COLOR"),V);return al[rl.INFERENCE_ORIGIN_AXIS_LINES]=U,al[rl.INFERENCE_ORIGIN_AXIS_LINES_PRESELECTED]=G,Object.values(al).forEach((function(e){(0,Ti._J)(e)})),al}function ll(e){const t=Kc.getColor("MATE_CONNECTOR_SELECTED_COLOR");if(e)for(let i=0;i<3;i++)t[i]=e[i];const i=cl();i&&(0,Au.Ab)(t,i[rl.TRIANGLES_SELECTED])}const ul="elementPreviewManager";class dl{constructor(e){this.viewer=e,this.DISPLAY_OCCURRENCE_NAME="ElementPreviewManager",this.GROUP_RANGE_GROUP_ID="elementPreviewGroup",this.nodeOccurrenceNames=[],this.nodeOccurenceIds=[],this.node=new xi.NB(ul),this.meshManager=new AS(this.viewer,{bufferAllocationPolicy:$f.MAXIMUM}),this.displayOccurrenceId=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(this.DISPLAY_OCCURRENCE_NAME),this.displayOccurrenceData=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(this.displayOccurrenceId),this.displayOccurrenceData.setLod(nE.DEFAULT),this.meshOwnerId=PS(),this.finalSceneBounds=new yi.kB,this.viewer.getModelViewManagers().getManager().getElementPreviewRootNode();this.viewer.getModelViewManagers().getManager().getElementPreviewBodyNode().addChild(this.node)}destroy(){this.node.remove();const e=this.viewer.getOccurrenceDataManager();e.destroyOccurrenceData(this.displayOccurrenceId);for(let t=0;t<this.nodeOccurenceIds.length;++t)e.destroyOccurrenceData(this.nodeOccurenceIds[t]);const t=this.viewer.getOccurrenceIdManager();t.removeName(this.DISPLAY_OCCURRENCE_NAME);for(let e=0;e<this.nodeOccurrenceNames.length;++e)t.removeName(this.nodeOccurrenceNames[e]);this.meshManager.destroy(),this.finalSceneBounds.reset()}readFloat32Array(e){return e?new Float32Array(e.buffer):new Float32Array(0)}readUint32Array(e){return e?new Uint32Array(e.buffer):new Uint32Array(0)}readUint16Array(e){return e?new Uint16Array(e.buffer):new Uint16Array(0)}processGLDisplayData(e){if(!e)return;let t=1,i=1;const s=e.buffers,n=e.nodes;for(let r=0;r<n.length;++r){const a=new XI.bg,o=ep.cloneAndModify({isPickable:!1,isHighlightable:!1}),h=n[r],c=h.drawables;if(!c||0===c.length)continue;const l=c[0],u=l.attributes,d=u.point>-1?s[e.bufferAccessors[u.point].bufferIndex].data:null;let g=new Array(0);u.point>-1&&(g=e.bufferAccessors[u.point].glDataType===k.hs8.UNSIGNED_SHORT?Array.from(this.readUint16Array(d)):this.readFloat32Array(d));const p=u.normal>-1?s[e.bufferAccessors[u.normal].bufferIndex].data:null,m=new Int8Array(p),f=new Float32Array(m.length);for(let e=0;e<f.length;++e)f[e]=m[e]/127;const I=l.indices>-1?s[e.bufferAccessors[l.indices].bufferIndex].data:null,E=this.readUint32Array(I),S=l.appearance.color,T=[S[0]/255,S[1]/255,S[2]/255,l.appearance.opacity/255],D=(0,Au.VO)(g,E,f,T),M=this.GROUP_RANGE_GROUP_ID+t,C=this.meshManager.getOrCreateGroupRangesForGroupTypeAndLod(M,this.meshOwnerId,Di.MX.TRIANGLE_STRIP,nE.DEFAULT);D.id="elementPreviewGraphics_"+t,D.groupId=M,D.lod=nE.DEFAULT,this.meshManager.addMeshIncrement(D,this.meshOwnerId),t+=1;for(let e=0;e<h.transform.length;++e){const t=this.DISPLAY_OCCURRENCE_NAME+i;this.nodeOccurrenceNames.push(t);const s=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(this.DISPLAY_OCCURRENCE_NAME+i);this.nodeOccurenceIds.push(s);const n=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(s);n.setLod(nE.DEFAULT),n.setTransform(h.transform[e].getGlMatrix()),this.node.addOccurrenceGeometryToNode(o,n,a,C),i+=1}}this.viewer.getModelViewManagers().getManager().getElementPreviewBodyNode().damageBounds()}processGLDisplayDataResponse(e){if(e&&e.hasGLDisplayData){const t=new k.gFF(e.glDisplayDataBytes).readMessage();t.finalSceneBounds&&(this.finalSceneBounds.addPoint(t.finalSceneBounds.minCorner.getVec3()),this.finalSceneBounds.addPoint(t.finalSceneBounds.maxCorner.getVec3())),this.processGLDisplayData(t)}}getModelBounds(){if(this.finalSceneBounds&&this.finalSceneBounds.isInitialized()&&this.finalSceneBounds.isExtensive())return this.finalSceneBounds;{const e=new yi.kB,t=this.viewer.getModelViewManagers().getManager().getElementPreviewBodyNode();return t&&e.addBox(t.getBoundingBox()),e}}}var gl=i(27974);class pl{constructor(e,t){this.viewer=t,(0,Jo.Yk)(t),this.imageData=new gl.TemplatedNestedMap,this.imageDisplays=new gl.TemplatedNestedMap,this.imageDisplaysByOccurrence=new gl.TemplatedCountedMap,this.activeSketchIds=new gt.StringSet,this.hiddenSketchIds=new gt.StringSet,this.usage=e||fs.L.BASE}processDisplayData(e){this.imageDisplays.eachNested(((t,i,s)=>{const n=this.imageDisplays.getNested(i,s);if(n){if(e.sketchImages.hasOwnProperty(i)&&e.sketchImages[i].hasOwnProperty(s)){const t=e.sketchImages[i][s];if((0,Bn.e)(t.sourceId)===n.url&&t.isOnFlat===n.isOnFlat)return}return n.remove(),this.imageDisplays.removeNested(i,s),!1}})),this.imageData.clear(),Object.entries(e.sketchImages).forEach((([e,t])=>{Object.entries(t).forEach((([t,i])=>{this.viewer.getIsForFlattenedDisplay()===i.isOnFlat&&this.imageData.insertNested(e,t,i)}))}))}reset(){this.remove(),this.imageData.clear()}remove(){this.imageDisplays.eachNested((function(e){return e.remove(),!1}),this),this.imageDisplays.clear(),this.imageDisplaysByOccurrence.each((e=>{e.eachNested((e=>{e.remove()}))})),this.imageDisplaysByOccurrence.clear()}removeOccurrence(e){const t=this.imageDisplaysByOccurrence.get(e);t&&(t.eachNested((e=>(e.remove(),!1))),t.clear()),this.imageDisplaysByOccurrence.remove(e)}showPartsWithSheetmetalModelIdOnly(e){const t=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();this.imageData.eachNested(((i,s,n)=>{const r=this.imageDisplays.getNested(s,n);if(r){if(t&&i.isOnFlat){const s=t.getSketchComponent().getSMModelIdForSketch(i.featureId);e!==s||this.hiddenSketchIds.contains(i.featureId)?r.hide():(r.updateImage(i.sourceId,i.bottomLeftCorner.getVec3(),i.bottomRightCorner.getVec3(),i.topLeftCorner.getVec3()),r.show())}return!1}}))}getDisplaysForOccurrence(e){const t=[],i=this.imageDisplaysByOccurrence.get(e);return i?(i.eachNested((e=>{t.push(e)})),t):t}updateDisplaysByOccurrence(e,t,i){if(0===i.size)return;let s=this.imageDisplaysByOccurrence.get(e);s||(s=new gl.TemplatedNestedMap,this.imageDisplaysByOccurrence.insert(e,s));const n=new gl.TemplatedNestedMap;i.forEach((e=>{const t=this.imageData.get(e);t&&n.insert(e,t)}));const r=this.viewer?.getOccurrenceDataManager()?.getOccurrenceData(e)?.getTransform();n.eachNested(((e,i,n)=>{const a=s.getNested(i,n);let o="";if(e.isOnFlat&&(o=this.viewer?.getModelViewManagers()?.getManager()?.getDisplayedPartStudio()?.getSketchComponent()?.getOwnerFlattenedBodyIdForSketch(e.featureId)),a)t.isHidden?a.hide():(a.show(),a.isOnFlat=e.isOnFlat,a.flattenedBodyId=o,a.transform=r,a.updateImage(e.sourceId,e.bottomLeftCorner.getVec3(),e.bottomRightCorner.getVec3(),e.topLeftCorner.getVec3()));else{const a=new Gn(n,e.sourceId,e.bottomLeftCorner.getVec3(),e.bottomRightCorner.getVec3(),e.topLeftCorner.getVec3(),null,this.usage,this.viewer,e.isOnFlat,o,r);a.setIsolated(!1),t.isHidden?a.hide():a.show(),s.insertNested(i,n,a)}return!1}))}updateDisplays(){const e=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();this.imageData.eachNested(((t,i,s)=>{const n=this.imageDisplays.getNested(i,s);let r=de.create(),a="";if(e&&t.isOnFlat&&(a=e.getSketchComponent().getOwnerFlattenedBodyIdForSketch(t.featureId),a)){const t=e.retrieveBodyMetaData(a);t&&(r=e.getBodyComponent().getTransformFromSheetMetalBodyMetaData(t))}if(n)n.isHidden||(n.isOnFlat=t.isOnFlat,n.flattenedBodyId=a,n.transform=r,n.updateImage(t.sourceId,t.bottomLeftCorner.getVec3(),t.bottomRightCorner.getVec3(),t.topLeftCorner.getVec3()));else{const e=new Gn(s,t.sourceId,t.bottomLeftCorner.getVec3(),t.bottomRightCorner.getVec3(),t.topLeftCorner.getVec3(),null,this.usage,this.viewer,t.isOnFlat,a,r);this.activeSketchIds.contains(i)?e.activate():this.hiddenSketchIds.contains(i)&&e.hide(),this.imageDisplays.insertNested(i,s,e)}return!1}),this)}onSketchHidden(e){this.hiddenSketchIds.add(e),this.imageDisplays.eachNested(((t,i)=>{const s=i?.split(".");return e===s[0]&&t.hide(),!1}))}onSketchShown(e){this.hiddenSketchIds.remove(e),this.imageDisplays.eachNested(((t,i,s)=>{const n=i.split(".");if(e===n[0]){let e=!0;if(t.isOnFlat){e=!1;const i=this.viewer.getModelViewManagers().getManager(),s=i.getSelectedSheetmetalModelId();if(s){const n=i.getDisplayedPartStudio();if(n){const i=n.retrieveBodyMetaData(t.flattenedBodyId);i&&(e=s===i.sheetMetalModelId)}}}if(e){const e=this.imageData.getNested(i,s);e&&(t.updateImage(e.sourceId,e.bottomLeftCorner.getVec3(),e.bottomRightCorner.getVec3(),e.topLeftCorner.getVec3()),t.show())}}return!1}))}onSketchActivated(e){this.activeSketchIds.contains(e)||(this.imageDisplays.has(e)&&this.imageDisplays.get(e).each(((e,t)=>(e.activate(),!1))),this.activeSketchIds.add(e))}onSketchDeactivated(e){this.activeSketchIds.contains(e)&&(this.imageDisplays.has(e)&&this.imageDisplays.get(e).each(((e,t)=>(e.deactivate(),!1))),this.activeSketchIds.remove(e))}cloneForUsage(e){const t=new pl(e,this.viewer);return this.imageData.eachNested(((e,i,s)=>(t.imageData.insertNested(i,s,e),!1))),e===fs.L.PREVIEW&&this.imageDisplays.eachNested(((e,i,s)=>(t.imageDisplays.insertNested(i,s,e.cloneForPreview()),!1))),t}hideImage(e,t){if(this.imageDisplays.hasNested(e,t)){this.imageDisplays.getNested(e,t).hide()}}cloneImageDisplay(e,t){if(this.imageDisplays.hasNested(e,t)){const i=this.imageDisplays.getNested(e,t),s=new Gn(t,i.url,i.bottomLeftCorner,i.bottomRightCorner,i.topLeftCorner,i.texture,i.usage,this.viewer,i.isOnFlat,i.flattenedBodyId,i.transform);return i.isHidden&&s.hide(),i.isActive&&s.activate(),s}return null}}var ml=i(98883),fl=i(57667);class Il{constructor(){this.id="",this.imageName="",this.svgToStyle="",this.backgroundColor="rgba(0,0,0,0)",this.index=-1}}class El{constructor(e,t){this.viewer=e,this.options=t,this.sources=null,this.imageSize=0,this.gridSize=0,this.textureSize=0,this.texture=null,this.canvas=null,(0,Jo.Yk)(e)}destroy(){this.texture&&(this.texture.destroy(),this.texture=null)}getCanvasPosition(e){const t=e%this.gridSize,i=(e-t)/this.gridSize;return[t*this.imageSize,i*this.imageSize]}onReceivedImages(e){this.canvas=document.createElement("canvas"),this.canvas.width=this.textureSize,this.canvas.height=this.textureSize,this.options.debugCanvas&&(this.canvas.style.position="absolute",this.canvas.style.left="0",this.canvas.style.bottom="0",this.canvas.style.zIndex="1000",document.body.append(this.canvas));const t=this.canvas.getContext("2d");t.fillStyle="rgba(0, 0, 0, 0)",t.fillRect(0,0,this.textureSize,this.textureSize),e.forEach(((e,i)=>{const s=this.sources[i],n=this.getCanvasPosition(i);t.fillStyle=s.backgroundColor,t.fillRect(n[0],n[1],this.imageSize,this.imageSize),e&&t.drawImage(e,n[0],n[1],this.imageSize,this.imageSize)})),this.texture=new $a(this.viewer,(e=>{const i=new ja(e);if(i.width=this.canvas.width,i.height=this.canvas.height,this.options.clearColorOverride){const e=t.getImageData(0,0,this.canvas.width,this.canvas.height).data;for(let t=0;t<e.length;t+=4)0===e[t+3]&&(e[t]=this.options.clearColorOverride[0],e[t+1]=this.options.clearColorOverride[1],e[t+2]=this.options.clearColorOverride[2],e[t+3]=this.options.clearColorOverride[3]);i.bytes=e}else i.canvas=this.canvas;return i.magnificationFilter=e.LINEAR,i.minificationFilter=e.LINEAR_MIPMAP_LINEAR,i.maxAnisotropy=4,i.useMipmaps=!0,i})),this.texture.setHasTransparency(this.options.sourcesHaveTransparency)}onImageGetFailed(e){}getTextureCoords(e){const t=this.sources.find((t=>t.id===e));if(!t)return null;const i=this.getCanvasPosition(t.index);return{lowS:i[0]/this.textureSize,highS:(i[0]+this.imageSize)/this.textureSize,lowT:i[1]/this.textureSize,highT:(i[1]+this.imageSize)/this.textureSize}}getTextureCoordsOffset(e,t){const i=this.sources.find((t=>t.id===e));if(!i)return null;const s=this.getCanvasPosition(i.index);return{lowS:(s[0]+t)/this.textureSize,highS:(s[0]+this.imageSize-t)/this.textureSize,lowT:(s[1]+t)/this.textureSize,highT:(s[1]+this.imageSize-t)/this.textureSize}}}const Sl="--static",Tl=["--os-icon-accent-cancel","--os-icon-accent-error","--os-icon-fill-tertiary","--os-icon-outline-primary","--os-icon-outline-primary--static"];function Dl(e){return fetch(e).then((e=>e.text())).then((e=>function(e){for(let t of Tl){const i=new RegExp(`var\\(${t},[^)]*\\)`);t.endsWith(Sl)&&(t=t.substring(0,t.length-Sl.length));const s=fl.G.getTokenValue(t);e=e.replace(i,s)}return"data:image/svg+xml,"+encodeURIComponent(e)}(e)))}function Ml(e,t,i,s){const n=Math.ceil(Math.sqrt(i.length)),r=(0,yi.cP)(n*t);if(r>e.getMaximumTextureSize()||0===n)return ut.log.warn("Attempting to create atlas with bad size. textureSize: "+r+"  gridSize: "+n+" Maximum size: "+e.getMaximumTextureSize()),Ur.fcall((()=>null));const a=new El(e,s);a.sources=[...i],a.gridSize=n,a.imageSize=t,a.textureSize=r;const o=[];return a.sources.forEach(((e,t)=>{e.index=t;const i=Ur.defer(),s=new Image;s.onload=function(){i.resolve(s)},s.onerror=function(t){ut.log.warn("Error loading texture atlas image data: "+(e.imageName||e.svgToStyle)),i.reject(t)},e.svgToStyle?Dl("/images/"+e.svgToStyle).then((e=>{s.src=e})).catch((t=>{ut.log.warn("Error loading texture atlas svg: "+e.svgToStyle+"\nError: "+t),i.reject(t)})):s.src="/images/"+e.imageName,o.push(i.promise)})),Ur.all(o).then((e=>(a.onReceivedImages(e),a)),(e=>(a.onImageGetFailed(e),null)))}var Cl;!function(e){e.NORMAL="NORMAL",e.ERROR="ERROR",e.SUPPRESSED="SUPPRESSED"}(Cl||(Cl={}));const yl={NORMAL:"",ERROR:"_Error",SUPPRESSED:"_Suppressed"};var Pl;!function(e){e.NO_HIGHLIGHT="NO_HIGHLIGHT",e.PRE_HIGHLIGHT="PRE_HIGHLIGHT",e.HIGHLIGHT="HIGHLIGHT"}(Pl||(Pl={}));const Al={NO_HIGHLIGHT_NORMAL:8,NO_HIGHLIGHT_SUPPRESSED:7,NO_HIGHLIGHT_ERROR:6,HIGHLIGHT_NORMAL:5,HIGHLIGHT_SUPPRESSED:4,HIGHLIGHT_ERROR:3,PRE_HIGHLIGHT_NORMAL:2,PRE_HIGHLIGHT_SUPPRESSED:1,PRE_HIGHLIGHT_ERROR:0};class Ol{constructor(e,t,i,s,n,r,a){this.atlasId=e,this.viewer=t,this.textures=i,this.pixelSize_=s,this.textureResolutionScales=n,this.textureAtlasOptions=r,this.isDarkModeThemed=a,this.material=Fi(),this.nodeProperties={},this.initializeTextureAtlas(),this.initializeNodeProperties()}onDevicePixelRatioChanged(){this.textureResolutionScales&&this.getTextureResolutionScale(this.lastUsedDevicePixelRatio)!==this.getTextureResolutionScale((0,Ji.x_)())&&this.reinitialize()}reinitialize(){this.viewer.getTextureAtlasFactory().clearAtlas(this.atlasId),this.textureAtlas&&(this.textureAtlas.destroy(),this.textureAtlas=null),this.material.ambientTexture=null,this.initializeTextureAtlas(),this.initializeNodeProperties()}destroy(){this.material&&(this.material.destroy(),this.material=null)}get pixelSize(){return this.pixelSize_}get atlasReady(){return!!this.textureAtlas}getNodeProperties(e,t,i){return this.nodeProperties[this.getNodePropertyKey(e,t,i)]}getTextureCoordsOffset(e,t,i,s){return this.textureAtlas.getTextureCoordsOffset(this.getAtlasKey(e,t,i),s)}initializeNodeProperties(){for(const e in Pl)for(const t in Cl)for(let i=xi.DO.LOWER;i<=xi.DO.DEFAULT;++i){const s=this.getNodePropertyKey(e,t,i),n=this.getZOffsetKey(e,t);this.nodeProperties[s]=new xi.hF({primitiveType:Di.MX.TRIANGLES,isShowThrough:!0,isDepthTested:!0,isTwoSided:!0,priority:i,primitivesHaveTransparency:!0,material:this.material,zOffset:Al[n]})}}initializeTextureAtlas(){this.viewer.getTextureAtlasFactory().getAtlas(this.atlasId,(()=>{const e=[];for(const t in this.textures)for(const i in Cl)for(const s in Pl)e.push(this.createAtlasItem(t,i,s));const t=this.textureAtlasOptions?this.textureAtlasOptions:{};t.sourcesHaveTransparency=!0;let i=this.pixelSize;const s=this.getTextureResolutionScale((0,Ji.x_)());return s&&(i*=s),Ml(this.viewer,i,e,t)})).then((e=>{e?(this.textureAtlas=e,this.material.ambientTexture=e.texture,this.viewer.requestDraw()):ut.log.warn("Could not load texture atlas")})).catch((e=>{ut.log.error(e)}))}getNodePropertyKey(e,t,i){return e+"_"+t+"_"+i}getZOffsetKey(e,t){return e+"_"+t}getAtlasKey(e,t,i){return e+un.ID_SEPARATOR+t+un.ID_SEPARATOR+i}getAtlasBackgroundColor(e,t){return X.default.getManager().getColorString("GLYPH_"+e+"_"+t+"_BACKGROUND")}getAtlasTextureName(e,t,i){return this.textures[e]+yl[t]+this.getSystemStateSuffix()+".png"}getTextureResolutionScale(e){let t=null;if(!this.textureResolutionScales)return t;for(let i=0;i<this.textureResolutionScales.length&&(t=this.textureResolutionScales[i],!(t>=e));++i);return t}getSystemStateSuffix(){let e="";if(this.isDarkModeThemed&&(e+="_"+fl.G.getCurrentTheme()),this.textureResolutionScales){const t=(0,Ji.x_)(),i=this.getTextureResolutionScale(t);this.lastUsedDevicePixelRatio=t,e+="_"+i+"x"}return e}createAtlasItem(e,t,i){const s=new Il;return s.id=this.getAtlasKey(e,t,i),s.imageName=this.getAtlasTextureName(e,t,i),s.backgroundColor=this.getAtlasBackgroundColor(t,i),s}}const vl="GLYPH";class Rl extends Ti.u1{constructor(e,t,i,s,n,r,a,o){super(e),this.glyphResources=t,this.textureId=i,this.glyphStateId=s,this.pixelSize=n,this.renderPriority=r,this.worldOrigin=a,this.parent=o}getModelSelection(e){return this.parent?this.parent.getModelSelection(e):null}addHighlight(e){super.addHighlight(e),this.resetGraphics()}removeHighlight(e){return!!super.removeHighlight(e)&&(this.resetGraphics(),!0)}onViewWillDraw(e){this.isHidden||this.hasBeenRemoved||(this.updateGraphics(),this.adjustTransform(e))}setWorldOrigin(e){ge.S4.distanceSquared(this.worldOrigin,e)>Ci.W.ZERO_LENGTH_SQUARED&&(this.worldOrigin=e,this.resetGraphics())}onDevicePixelRatioChanged(e){this.isHidden||this.resetGraphics()}get highlightStateId(){const e=this.getHighlight();return e&&e.type===dn.o2.PRE?Pl.PRE_HIGHLIGHT:e?Pl.HIGHLIGHT:Pl.NO_HIGHLIGHT}resetGraphics(){this.removeMeshIncrements(),this.updateGraphics()}updateGraphics(){!this.hasMeshIncrements()&&this.glyphResources.atlasReady&&this.instantiateMeshIncrements()}}class wl extends Rl{constructor(e,t,i,s,n,r,a,o,h,c){super(e,t,i,s,n,r,a,c),this.worldXAxis=o,this.worldYAxis=h}instantiateMeshIncrements(){const e=this.glyphResources.getTextureCoordsOffset(this.textureId,this.glyphStateId,this.highlightStateId,0);if(!e)return;const t="glyphQuad",i=[e.lowS,e.highT],s=[e?.highS,e?.lowT],n=(0,Au.fQ)([-.5,0,-.5],[.5,0,-.5],[-.5,0,.5],t,i,s),r=this.glyphResources.getNodeProperties(this.highlightStateId,this.glyphStateId,this.renderPriority);this.updateMeshIncrement(t,vl,n,r)}adjustTransform(e){const t=e.getPixelSizeAtWorldPoint(this.worldOrigin)*this.pixelSize*(0,Ji.x_)(),i=ge.S4.scale(this.worldYAxis,t,C.create()),s=ge.S4.scale(this.worldXAxis,t,C.create()),n=ge.S4.scale(ge.S4.normalize(ge.S4.cross(i,s,C.create())),t),r=de.fromValues(s[0],s[1],s[2],0,n[0],n[1],n[2],0,i[0],i[1],i[2],0,this.worldOrigin[0],this.worldOrigin[1],this.worldOrigin[2],1);this.setTransform(r)}}class _l extends Rl{constructor(e,t,i,s,n,r,a,o,h){super(e,t,i,s,n,r,a,h),this.originInGlyph=o}instantiateMeshIncrements(){const e=this.glyphResources.getTextureCoordsOffset(this.textureId,this.glyphStateId,this.highlightStateId,0);if(!e)return;const t=[-this.originInGlyph[0],0,-this.originInGlyph[1]],i=[1-this.originInGlyph[0],0,-this.originInGlyph[1]],s=[-this.originInGlyph[0],0,1-this.originInGlyph[1]],n="quad",r=[e.lowS,e.highT],a=[e.highS,e.lowT],o=(0,Au.fQ)(t,i,s,n,r,a);this.updateMeshIncrement(n,vl,o,this.glyphResources.getNodeProperties(this.highlightStateId,this.glyphStateId,this.renderPriority))}adjustTransformToAlignUp(e,t){const i=e.getPixelSizeAtWorldPoint(this.worldOrigin)*this.pixelSize*(0,Ji.x_)(),s=ge.S4.scale(t,i,C.create()),n=ge.S4.scale(ge.S4.normalize(ge.S4.cross(e.getForward(),s,C.create())),i),r=ge.S4.scale(ge.S4.normalize(ge.S4.cross(s,n,C.create())),i),a=de.fromValues(n[0],n[1],n[2],0,r[0],r[1],r[2],0,s[0],s[1],s[2],0,this.worldOrigin[0],this.worldOrigin[1],this.worldOrigin[2],1);this.setTransform(a)}adjustTransform(e){this.adjustTransformToAlignUp(e,e.getUp())}}class Nl extends _l{constructor(e,t,i,s,n,r,a,o,h,c){super(e,t,i,s,n,r,a,h,c),this.worldDirection=o}adjustTransform(e){this.adjustTransformToAlignUp(e,this.worldDirection)}}const bl={FASTENED:"mateindicators/MateIndicatorAssets_Fastened",REVOLUTE:"mateindicators/MateIndicatorAssets_Revolute",SLIDER_BASE:"mateindicators/MateIndicatorAssets_Ball",PLANAR_BASE:"mateindicators/MateIndicatorAssets_PlanarCenter",CYLINDRICAL_BASE:"mateindicators/MateIndicatorAssets_Revolute",PIN_SLOT_BASE:"mateindicators/MateIndicatorAssets_PinSlot",PARALLEL_BASE:"mateindicators/MateIndicatorAssets_Parallel",BALL:"mateindicators/MateIndicatorAssets_Ball",ARROW:"mateindicators/MateIndicatorAssets_DirectionArrow",GROUP:"mateindicators/MateIndicatorAssets_Group",TANGENT:"mateindicators/MateIndicatorAssets_Tangent",FIXED:"mateindicators/MateIndicatorAssets_Fixed",WIDTH:"mateindicators/MateIndicatorAssets_Width_Mate"},Ll=X.default.getManager(),Fl=Ll.getNumber("UNSCALED_MATE_SCREEN_SIZE"),xl="MateIndicatorComponent";function Bl(e){e.getResources().mateIndicatorGlyphResources||(e.getResources().mateIndicatorGlyphResources=new Ol(pM.Bm,e,bl,Fl*(0,Ji.x_)()))}class Vl extends Ti.u1{constructor(e,t,i,s,n){super(s),this.mateConnectorDisplayData=e,this.type=t,this.definition=i,this.occurrenceTransforms=[],this.connectorCoordinateSystems=[],this.worldSpacePositions=[],this.worldSpacePosition=[0,0,0],this.lastScale=-1,this.positionComputed=!1,this.inHiddenMode=!1,Bl(this.viewer),this.id=t,this.featureType=ui.T.MATE,this.mateType=n,this.listenTo(this,Ti.zw.LONG_PRESS_START+xl,this.onLongPressStart),this.listenTo(this,Ti.zw.LONG_PRESS_END+xl,this.onLongPressEnd),this.damageTransform(),this.occurrenceData.setCanIsolateChange(!0),this.occurrenceData.setIsolated(!1)}updateHiddenMode(e){return this.inHiddenMode!==e&&(this.inHiddenMode=e,!0)}updateHideState(){this.isHighlighted()||!this.definition.hidden&&!this.inHiddenMode?(this.hasMeshIncrements()||this.updateGraphics(!0),this.positionComputed||this.computePosition(),this.show()):this.hide()}onLongPressStart(){this.trigger(Ti.zw.LONG_PRESS_START)}onLongPressEnd(){this.trigger(Ti.zw.LONG_PRESS_END)}addHighlight(e){super.addHighlight(e),this.updateHideState(),this.updateGraphics()}removeHighlight(e){return!!super.removeHighlight(e)&&(this.updateHideState(),this.updateGraphics(),!0)}onViewWillDraw(e){this.isHidden||this.hasBeenRemoved||(this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()&&this.updateGraphics(),this.adjustTransform(e))}updateIsolation(){let e=1;this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()&&!this.occurrenceData.getIsolated()&&(e=Ll.getNumber("ISOLATE_CONTEXT_UI_TRANSPARENCY")*Ke()+(1-Ke()));let t=this.getIncrement();t&&(t=(0,Au.Ae)(t,e),this.updateMeshIncrement(this.type,xl,t,this.getNodeProperties()))}updateGraphics(e){if(!this.isValid())return;if(!this.definition||this.isHidden&&!e)return void this.removeMeshIncrements();if(!this.glyphResources.atlasReady)return;const t=this.getIncrement();t&&(this.updateMeshIncrement(this.type,xl,t,this.getNodeProperties()),this.updateIsolation())}getIncrement(){return null}get glyphResources(){return this.viewer.getResources().mateIndicatorGlyphResources}getNodeProperties(){return this.glyphResources.getNodeProperties(this.getHighlightStateId(),this.getMateStateId(),this.getRenderOrderPriority())}getRenderOrderPriority(){return xi.DO.LOWER}getMateStateId(){return this.definition.status===k.EFx.ERROR?"ERROR":this.definition.status===k.EFx.SUPPRESSED?"SUPPRESSED":"NORMAL"}getHighlightStateId(){const e=this.getHighlight();return e&&e.type===dn.o2.PRE?"PRE_HIGHLIGHT":e?"HIGHLIGHT":"NO_HIGHLIGHT"}getTextureId(){return this.type}isValid(){return!!this.worldSpacePosition}computePosition(){for(let e=0;e<this.mateConnectorDisplayData.length;e++)this.occurrenceTransforms[e]=this.viewer.getModelViewManagers().getManager().getOccurrenceTransform(this.mateConnectorDisplayData[e].occurrence),this.connectorCoordinateSystems[e]=this.mateConnectorDisplayData[e].location,this.worldSpacePositions[e]=ge.w$.multiplyVec3(this.occurrenceTransforms[e],this.connectorCoordinateSystems[e].origin.getVec3(),C.create());this.worldSpacePositions.length>0?this.worldSpacePosition=this.worldSpacePositions[0]:(this.worldSpacePosition=null,this.removeMeshIncrements()),this.positionComputed=!0}causePositionRecompute(){this.lastScale=-1,this.positionComputed=!1,this.isHidden||this.computePosition()}updateMateConnectorDisplayData(e){this.mateConnectorDisplayData=e,this.causePositionRecompute()}getDefinitionOccurrenceIds(){const e=[];for(let t=0;t<this.mateConnectorDisplayData.length;t++)e.push(this.mateConnectorDisplayData[t].occurrence.getPathAsString());return e}getRelatedOccurrences(){const e=[];for(let t=0;t<this.mateConnectorDisplayData.length;t++)e.push(this.mateConnectorDisplayData[t].occurrence);return e}getModelSelection(){if(this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()&&!this.occurrenceData.getIsolated())return null;const e=this.getRelatedOccurrences(),t=[];for(let i=0;i<e.length;i++){const s=e[i],n=new Ce.Y1(k.lQt.OCCURRENCE,s,s);t.push(n)}for(let e=0;e<this.mateConnectorDisplayData.length;e++){const i=this.mateConnectorDisplayData[e],s=new Ce.Y1(k.lQt.MATE_CONNECTOR,i.nodeId,i.ownerOccurrence,{isDerivedFeature:i.isDerivedFeature});t.push(s)}return new Ce.Y1(k.lQt.MATE,this.definition.nodeId,this.definition.ownerOccurrence,{featureType:this.featureType,mateType:this.mateType,childSelections:t,isDerivedFeature:this.definition.isDerivedFeature})}adjustTransform(e){if(this.positionComputed||this.computePosition(),!this.isValid())return;const t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition)*(0,Ji.x_)();if(Math.abs(this.lastScale-t)<Ci.W.ZERO_LENGTH&&this.hasMeshIncrements())return;this.lastScale=t;const i=de.create();i[0]=t,i[5]=t,i[10]=t,this.setTransform(ge.w$.rotateX(ge.w$.multiply(ge.w$.multiply(this.occurrenceTransforms[0],this.connectorCoordinateSystems[0].getGlMatrix(),de.create()),i),-Math.PI/2)),this.hasMeshIncrements()||this.updateGraphics()}damageTransform(){this.lastScale=-1,this.connectorCoordinateSystems[0]&&ge.w$.multiplyVec3(this.occurrenceTransforms[0],this.connectorCoordinateSystems[0].origin.getVec3(),this.worldSpacePosition),(0,Fs.vm)()}}class Ul extends Vl{constructor(e,t,i,s,n){super(e,t,i,s,n)}getIncrement(){const e=this.glyphResources.getTextureCoordsOffset(this.getTextureId(),this.getMateStateId(),this.getHighlightStateId(),.5);return(0,Au.fQ)([-Fl/2,0,-Fl/2],[Fl/2,0,-Fl/2],[-Fl/2,0,Fl/2],void 0,[e.lowS,e.highT],[e.highS,e.lowT])}}class Gl extends Vl{constructor(e,t,i,s,n,r){super(e,"ARROW",t,n,r),this.rotationAngle=i,this.rotationAxis=s}getIncrement(){const e=this.glyphResources.getTextureCoordsOffset(this.getTextureId(),this.getMateStateId(),this.getHighlightStateId(),1);return(0,Au.fQ)([0,0,-Fl/4],[Fl,0,-Fl/4],[0,0,Fl/4],void 0,[e.lowS,e.highT],[e.highS,e.lowT])}adjustTransform(e){if(this.positionComputed||this.computePosition(),!this.isValid())return;const t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition)*(0,Ji.x_)();if(Math.abs(this.lastScale-t)<Ci.W.ZERO_LENGTH&&this.hasMeshIncrements())return;this.lastScale=t;const i=de.create();i[0]=t,i[5]=t,i[10]=t;const s=ge.w$.multiply(ge.w$.multiply(this.occurrenceTransforms[0],this.connectorCoordinateSystems[0].getGlMatrix(),de.create()),i),n=ge.w$.rotate(s,this.rotationAngle,this.rotationAxis);this.setTransform(n),this.hasMeshIncrements()||this.updateGraphics()}getHighlightStateId(){return"NO_HIGHLIGHT"}getRenderOrderPriority(){return xi.DO.DEFAULT}}class Hl extends Ul{constructor(e,t,i){super([],"GROUP",t,i),this.occurrenceDisplayData=e,this.featureType=ui.T.MATE_GROUP}getDefinitionOccurrenceIds(){return this.definition.getOccurrenceIds()}getRelatedOccurrences(){const e=[];for(let t=0;t<this.occurrenceDisplayData.length;t++)e.push(this.occurrenceDisplayData[t].occurrenceData.occurrence);return e}computePosition(){if(!this.occurrenceDisplayData)return;let e=null;const t=this.viewer.getModelViewManagers().getManager();for(let i=0;i<this.occurrenceDisplayData.length;i++){const s=this.occurrenceDisplayData[i].occurrenceData.occurrence;this.occurrenceTransforms[i]=t.getOccurrenceTransform(s),this.connectorCoordinateSystems[i]=k.em5.createValidDefault(),this.worldSpacePositions[i]=ge.w$.multiplyVec3(this.occurrenceTransforms[i],this.connectorCoordinateSystems[i].origin.getVec3(),C.create());const n=t.getOccurrenceBounds(s);n&&n.isFinite()&&(e||(e=new yi.kB),e.addBox(n))}if(this.worldSpacePositions.length>0&&e){const t=e.center();this.connectorCoordinateSystems[0].origin.updateFromArray(ge.S4.subtract(t,this.worldSpacePositions[0])),this.worldSpacePosition=t}else this.worldSpacePosition=null,this.removeMeshIncrements();this.positionComputed=!0}updateOccurenceDisplayData(e){this.occurrenceDisplayData=e,this.causePositionRecompute()}}class kl extends Ul{constructor(e,t,i){super([],t,e,i),this.featureType=ui.T.GEOMETRY_MATE}computePosition(){const e=this.definition;e&&e.location?this.worldSpacePosition=e.location.origin.getVec3():(this.worldSpacePosition=null,this.removeMeshIncrements()),this.positionComputed=!0}updateDefinition(e){this.definition=e,this.causePositionRecompute()}getDefinitionOccurrenceIds(){const e=this.getRelatedOccurrences(),t=[];return e.forEach((function(e){t.push(e.getPathAsString())})),t}getRelatedOccurrences(){const e=[],t=this.definition;return t&&(t.firstOccurrence&&e.push(t.firstOccurrence),t.secondOccurrence&&e.push(t.secondOccurrence)),e}adjustTransform(e){if(this.positionComputed||this.computePosition(),!this.isValid())return;const t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition)*(0,Ji.x_)();if(Math.abs(this.lastScale-t)<Ci.W.ZERO_LENGTH&&this.hasMeshIncrements())return;this.lastScale=t;const i=de.create();i[0]=t,i[5]=t,i[10]=t;const s=this.definition;this.setTransform(ge.w$.rotateX(ge.w$.multiply(s.location.getGlMatrix(),i),-Math.PI/2)),this.hasMeshIncrements()||this.updateGraphics()}}class Wl extends Ul{constructor(e,t,i){super([],"FIXED",new k.iYR(!0),i),this.occurrenceDisplayData=[],this.connectorCoordinateSystems[0]=k.em5.createValidDefault();const s=this.viewer.retrieveCanvasLocationWorldPosition(t);if(s)this.worldSpacePosition=s,this.connectorCoordinateSystems[0].origin.updateFromArray(s);else{const t=this.viewer.getModelViewManagers().getManager().getOccurrenceBounds(e);if(t&&t.isFinite()){const e=new yi.kB;e.addBox(t);const i=e.center();this.worldSpacePosition=i,this.connectorCoordinateSystems[0].origin.updateFromArray(i)}}this.occurrenceTransforms[0]=de.create()}computePosition(){this.positionComputed=!0}}class zl extends Ul{constructor(e,t,i,s){super(e,i,t,s),this.featureType=ui.T.WIDTH_MATE}computePosition(){const e=this.definition;e&&e.location?this.worldSpacePosition=e.location.origin.getVec3():(this.worldSpacePosition=null,this.removeMeshIncrements()),this.positionComputed=!0}updateDefinition(e){this.definition=e,this.causePositionRecompute()}adjustTransform(e){if(this.positionComputed||this.computePosition(),!this.isValid())return;const t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition)*(0,Ji.x_)();if(Math.abs(this.lastScale-t)<Ci.W.ZERO_LENGTH&&this.hasMeshIncrements())return;this.lastScale=t;const i=de.create();i[0]=t,i[5]=t,i[10]=t;const s=this.definition;this.setTransform(ge.w$.rotateX(ge.w$.multiply(s.location.getGlMatrix(),i),-Math.PI/2)),this.hasMeshIncrements()||this.updateGraphics()}}const Xl=new xi.hF({primitiveType:Di.MX.POINTS,isPickable:!1,isShowThrough:!0,isDepthTested:!1});class Zl extends Ti.u1{constructor(e,t,i,s,n,r){super(n,t),this.position=e,this.increment=(0,Au.Pu)([0,0,0],"point",i,s),this.updatePosition(e),this.nodeProperties=Xl,r&&(this.nodeProperties=r),this.updateGraphics()}updatePosition(e){if(e){this.position=e;const t=de.create();t[12]=this.position[0],t[13]=this.position[1],t[14]=this.position[2],this.setTransform(t)}}setStyle(e){(0,Au.KZ)(e,this.increment),this.updateGraphics()}updateGraphics(){this.updateMeshIncrement(Zl.INCREMENT_ID,"pointElementSelection",this.increment,this.nodeProperties)}addHighlight(e){super.addHighlight(e),this.addHighlightToIncrement("pointElement",e),this.highlight=e}removeHighlight(e){return!!e&&(this.removeHighlightFromIncrement("pointElement",e),!!super.removeHighlight(e))}}Zl.INCREMENT_ID="pointElement";const ql=X.default.getManager(),Yl=[];let Kl=0;class jl{constructor(e,t,i,s){this.usage=e,this.elementId=t,this.viewer=i,this.cloneSource=s,this.annotationIdToUIElementMap={},this.activeAnnotationId="",this.isAnnotationPaneOpen=!1,this.persistentAnnotationIds=[],s&&(this.activeAnnotationId=s?.getActiveAnnotationId()),this.updateTextureAtlas(this.viewer,this.onTextureAtlasChanged.bind(this))}reset(){for(const e in this.annotationIdToUIElementMap)if(e&&e.length>0){this.annotationIdToUIElementMap[e].remove()}this.annotationIdToUIElementMap={}}processDisplayData(e){if(this.usage===fs.L.PREVIEW)return;e.incremental||this.reset();const t=e.annotationsForElement;if(!t)return;const i=t.annotationIdToDisplayObject;if(i){for(const e in i)if(e&&e.length>0){let t;const s=i[e],n=this.annotationIdToUIElementMap[e];if(n&&(n.remove(),delete this.annotationIdToUIElementMap[e]),s.getIsDeletion())continue;switch(s.getAnnotationType()){case k.pLb.DATUM:t=new iu(e,s,this.viewer,this),this.annotationIdToUIElementMap[e]=t;break;case k.pLb.GTOL:t=new su(e,s,this.viewer,this),this.annotationIdToUIElementMap[e]=t;break;case k.pLb.WELD:t=new nu(e,s,this.viewer,this),this.annotationIdToUIElementMap[e]=t}t&&t.processDisplayData()}this.updateAnnotationsVisibility(),this.viewer.requestDraw()}}hide(){this.annotationIdToUIElementMap&&Object.entries(this.annotationIdToUIElementMap).forEach((([e,t])=>{t.hide()}))}getIsAnnotationPaneOpen(){return this.isAnnotationPaneOpen}onAnnotationPaneOpenClosed(e){this.isAnnotationPaneOpen=e,this.updateAnnotationsVisibility()}getActiveAnnotationId(){return this.activeAnnotationId}onActiveAnnotationChanged(e){this.activeAnnotationId=e,this.updateAnnotationsVisibility()}setPersistentAnnotations(e){this.persistentAnnotationIds=e,this.updateAnnotationsVisibility()}getUiElementForSelection(e){if(this.annotationIdToUIElementMap){const t=e.selectionId;return this.annotationIdToUIElementMap[t]}return null}updateAnnotationsVisibility(){this.annotationIdToUIElementMap&&Object.entries(this.annotationIdToUIElementMap).forEach((([e,t])=>{this.isAnnotationPaneOpen&&this.persistentAnnotationIds.includes(e)||e===this.activeAnnotationId?t.show():t.hide()}))}isPersistent(e){return this.isAnnotationPaneOpen&&this.persistentAnnotationIds.includes(e)}isAnnotationActive(e){return this.activeAnnotationId===e}onTextureAtlasChanged(){this.viewer.requestDraw()}updateTextureAtlas(e,t){if(null==e.getResources().mbdAtlas&&Yl.push(t),e.getResources().mbdAtlasCreationInitiated)return;e.getResources().mbdAtlasCreationInitiated=!0;const i=Kl++;e.getResources().mbdAtlasCreationId=i;e.getTextureAtlasFactory().getAtlas(pM.di,this.createTextureAtlas.bind(this,e)).then((t=>{i===e.getResources().mbdAtlasCreationId&&(t?(e.getResources().mbdAtlas=t,e.getResources().mbdAtlasMaterial.ambientTexture=t.texture,Yl.forEach((e=>e())),Yl.length=0):ut.log.warn("Could not load the MBD annotation texture atlas"))}),(e=>ut.log.error(e)))}appendImagesPerIcon(e,t,i){const s=i.length;i.push(this.createImageData(!1,e,t,s)),i.push(this.createImageData(!0,e,t,s+1))}createImageData(e,t,i,s){const n=new Il;return n.id=e?tu.getIconHighlightName(t):t,n.svgToStyle=i,n.index=s,n.backgroundColor=e?ql.getColorString("ANNOTATION_SELECTED_COLOR"):ql.getColorString("ANNOTATION_DEFAULT_BACKGROUND_COLOR"),n}createTextureAtlas(e){const t=[];return this.appendImagesPerIcon("TRUE_POSITION","mbd/position.svg",t),this.appendImagesPerIcon("PARALLELISM","mbd/parallelism.svg",t),this.appendImagesPerIcon("PERPENDICULARITY","mbd/perpendicularity.svg",t),this.appendImagesPerIcon("PROFILE_SURFACE","mbd/profileSurface.svg",t),this.appendImagesPerIcon("TOTAL_RUNOUT","mbd/totalRunout.svg",t),this.appendImagesPerIcon("FILLET_JOINT","mbd/fillet.svg",t),this.appendImagesPerIcon("SQUARE_GROOVE","mbd/squareGroove.svg",t),this.appendImagesPerIcon("BEVEL_FLARE_GROOVE","mbd/bevelFlareGroove.svg",t),this.appendImagesPerIcon("V_GROOVE","mbd/vGroove.svg",t),this.appendImagesPerIcon("BEVEL_GROOVE","mbd/bevelGroove.svg",t),Ml(e,ql.getNumber("ANNOTATION_ICON_SIZE_PIXELS"),t,{sourcesHaveTransparency:!0})}}var Ql=i(80285),$l=i(54995),Jl=i(46035);const eu=X.default.getManager();class tu extends Ti.u1{constructor(e,t,i,s){super(i),this.annotationId=e,this.annotationDisplayData=t,this.viewer=i,this.parent=s,this.baseDisplay=null,this.leaderDisplay=null,this.detailDisplay=null,this.nodeProperties=null,this.planeCoordinateSystem=null,this.baseCoordinateSystem=null,this.isDragging=!1,this.defaultColor=[],this.hoverColor=[],this.isPaneOpen=!1,this.isFilteredOut=null,this.lineWidth=0,this.lineStyle=[],this.font="",this.fontSize=1,this.backgroundPadding=1,this.iconSize=1,this.sideEdgeLength=0,this.dragDistance=.025,this.nextStartPoint=null,this.startDirection=null,this.newEndPoint=null,this.oldEndPoint=null,this.draggingLeaderPoints=[],this.originalDelta=null,this.lastPlaneIntersection=null,this.dragMeshIncrement=null,this.deterministicId="",this.startDetailFromFarSide=!1,this.extendedLeaderStartPoint=null,this.planeCoordinateSystem=t.annotationPlane,this.baseCoordinateSystem=t.basePlane,this.nextStartPoint=this.planeCoordinateSystem.origin.getVec3(),this.startDirection=this.planeCoordinateSystem.yAxis.getVec3(),this.lineWidth=eu.getNumber("ANNOTATION_LINE_WIDTH"),this.lineStyle=eu.getStipple("DEFAULT_LINE_STIPPLE"),this.font=eu.getString("DIMENSION_VALUE_FONT"),this.fontSize=eu.getNumber("DIMENSION_VALUE_HEIGHT_PIXELS"),this.backgroundPadding=eu.getNumber("DIMENSION_VALUE_BACKGROUND_PADDING"),this.iconSize=eu.getNumber("ANNOTATION_ICON_SIZE_PIXELS"),this.lastPlaneIntersection=C.create(),this.listenTo(this,Ti.zw.MOUSE_ENTER+au,this.onMouseEnter),this.listenTo(this,Ti.zw.MOUSE_LEAVE+au,this.onMouseLeave),this.listenTo(this,Ti.zw.DRAG_START+au,this.onDragStartBase),this.listenTo(this,Ti.zw.DRAG+au,this.onDragBase),this.listenTo(this,Ti.zw.DRAG_STOP+au,this.onDragStopBase),this.listenTo(this,Ti.zw.MOUSE_ENTER+hu,this.onMouseEnter),this.listenTo(this,Ti.zw.MOUSE_LEAVE+hu,this.onMouseLeave)}get camera(){return this.viewer.getCamera()}onViewWillDraw(e,t){if(this.isPaneOpen=this.isAnnotationPaneOpenForParent(),this.isPaneOpen){const t=this.isFilteredOutByOrientation(e),i=this.isFilteredOutAsOnSide(e),s=this.isFilteredOutByType(),n=this.isFilteredOutByPersistence(),r=t||i||s||n,a=this.isAnnotationActiveOrHighlighted();this.setFilteredOut(r&&!a),this.isVisibleToUser()&&!this.isFilteredOut?this.processDisplayData():this.hide()}}isAnnotationPaneOpenForParent(){const e=this.viewer.getModelViewManagers().getManager();if(e){const t=e.getDisplayedPartStudio()?.getAnnotationComponent();if(t&&t===this.parent)return t.getIsAnnotationPaneOpen()}return!1}isFilteredOutByOrientation(e){if(!(1===eu.getNumber("ANNOTATION_FILTER_OUT_BY_ORIENTATION")))return!1;const t=this.getCurrentAxisUp(e);return!(this.getAnnotationAxisUp()===t)}isFilteredOutAsOnSide(e){const t=this.getPlaneCoordinateSystem().zAxis.getVec3(),i=e.getDirection();return Math.abs(C.dot(t,i))<eu.getNumber("DIMENSION_SIDE_FADE_UPPER_DOT")}isFilteredOutByType(){return this.annotationDisplayData.getAnnotationType()===k.pLb.DATUM?1===eu.getNumber("ANNOTATION_FILTER_OUT_DATUMS"):this.annotationDisplayData.getAnnotationType()===k.pLb.GTOL&&1===eu.getNumber("ANNOTATION_FILTER_OUT_GTOLS")}isFilteredOutByPersistence(){const e=this.viewer.getModelViewManagers().getManager();if(e){const t=e.getDisplayedPartStudio()?.getAnnotationComponent();if(t)return!t.isPersistent(this.annotationId)}return!1}isAnnotationActiveOrHighlighted(){const e=this.viewer.getModelViewManagers().getManager();if(e){const t=e.getDisplayedPartStudio()?.getAnnotationComponent();if(t)return t.isAnnotationActive(this.annotationId)||this.isHighlighted()}return!1}isAnnotation(){return!0}getAnnotationDisplayData(){return this.annotationDisplayData}getPlaneCoordinateSystem(){return this.planeCoordinateSystem}getBaseCoordinateSystem(){return this.baseCoordinateSystem}setNextStartPoint(e){this.nextStartPoint=e}getNextStartPoint(){return this.nextStartPoint}setExtendedLeaderStartPoint(e){this.extendedLeaderStartPoint=e}getExtendedLeaderStartPoint(){return this.extendedLeaderStartPoint}setLeaderStartDirection(e){this.startDirection=e}getLeaderStartDirection(){return this.startDirection}getSideEdgeLength(e){return this.sideEdgeLength=eu.getNumber("ANNOTATION_BASE_SIDE_LENGTH_PX")*this.camera.getPixelSizeAtWorldPoint(e),this.sideEdgeLength}getPixelSizeAtWorldPoint(e){return this.camera.getPixelSizeAtWorldPoint(e)}convertToleranceToString(e){let t="";if(e){const i="meter",s=(0,$l.$w)(i),n=(0,rr.WR)(e,i,s),r={};r[s]=1,t=(0,Jl.cn)(r,n,!1)}return t}setFilteredOut(e){this.isFilteredOut!==e&&(this.isFilteredOut=e,this.isFilteredOut?this.hide():this.isPaneOpen&&this.show())}getFilteredOut(){return this.isFilteredOut}getColor(){const e=this.getHighlight();return e?.type===dn.o2.UI||e?.type===dn.o2.SECONDARY?eu.getColor("ANNOTATION_SELECTED_COLOR"):e?.type===dn.o2.PRE?eu.getColor("ANNOTATION_HOVER_COLOR"):eu.getColor("ANNOTATION_DEFAULT_COLOR")}getLineWidth(){return this.lineWidth}getLineStyle(){return this.lineStyle}getFont(){return this.font}getFontSize(){return this.fontSize}getBackgroundPadding(){return this.backgroundPadding}getBackgroundColor(){return eu.getNumberArray("ANNOTATION_BACKGROUND_COLOR")}static getIconHighlightName(e){return e+"_highlight"}getIconSize(){return this.iconSize}remove(){super.remove(),this.detailDisplay?.destroy()}getVisualVector(e){const t=this.planeCoordinateSystem.origin.getVec3(),i=C.transformMat4(C.create(),e,this.planeCoordinateSystem.getGlMatrix());return C.subtract(i,i,t),C.normalize(i,i)}getVisualUpVector(){return this.getVisualVector([0,1,0])}getVisualRightVector(){return this.getVisualVector([1,0,0])}getFlips(){return Po(this.camera,this.getVisualRightVector(),this.getVisualUpVector(),this.transform)}getCurrentAxisUp(e){const t=this.annotationDisplayData.annotationPlane.origin.getVec3(),i=C.fromValues(1,0,0),s=C.fromValues(0,1,0),n=C.fromValues(0,0,1),r=C.add(C.create(),t,i),a=C.add(C.create(),t,s),o=C.add(C.create(),t,n),h=e.projectWorldPointToCanvas(t),c=e.projectWorldPointToCanvas(r),l=e.projectWorldPointToCanvas(a),u=e.projectWorldPointToCanvas(o),d=Math.abs(c[1]-h[1]),g=Math.abs(l[1]-h[1]),p=Math.abs(u[1]-h[1]);this.camera.getUp();let m=!1,f=!1,I=!1;return d>g&&d>p?m=!0:g>d&&g>p?f=!0:p>d&&p>g&&(I=!0),m?Ql.H.Right:f?Ql.H.Front:Ql.H.Top}getAnnotationAxisUp(){const e=this.annotationDisplayData.annotationPlane.yAxis.getVec3(),t=C.fromValues(0,0,1),i=C.fromValues(0,1,0),s=C.fromValues(1,0,0),n=Math.abs(C.dot(e,t)),r=Math.abs(C.dot(e,i)),a=Math.abs(C.dot(e,s)),o=Math.abs(n-1),h=Math.abs(r-1),c=Math.abs(a-1);return o<h&&o<c?Ql.H.Top:h<o&&h<c?Ql.H.Front:Ql.H.Right}getAnnotationPlaneMatrix(){return this.planeCoordinateSystem.getGlMatrix()}getSubjectPlaneMatrix(){return this.baseCoordinateSystem.getGlMatrix()}getDragIntersectionPointWithAnnotationPlane(e){const t=e.camera.getRay(e.mouseX,e.mouseY);return(0,yi.bZ)(t,this.getAnnotationPlaneMatrix())}getDragIntersectionPointWithSubjectPlane(e){const t=e.camera.getRay(e.mouseX,e.mouseY);return(0,yi.bZ)(t,this.getSubjectPlaneMatrix())}intersectRayWithSubjectAxis(e){const t=C.copy(C.create(),this.planeCoordinateSystem.origin.getVec3()),i=C.copy(C.create(),this.baseCoordinateSystem.zAxis.getVec3()),s=new yi.zH(t,i),n=s.findPositionOfPoint(e);return s.evaluate(n)}onMouseEnterBase(e,t){this.viewer.requestDraw()}onMouseLeaveBase(e,t){this.viewer.requestDraw()}onDragStartBase(e,t,i){const s=this.getDragIntersectionPointWithSubjectPlane(t);if(!s)return;const n=this.deterministicId;this.dragMeshIncrement=this.viewer.getModelViewManagers().getManager().extractMeshIncrement(n),this.dragMeshIncrement||ut.log.debug("Could not find mesh increment for face "+n),this.originalDelta=C.subtract(C.create(),s,this.annotationDisplayData.annotationPlane.origin.getVec3()),i.requestDrag=!0}onDragBase(e,t){const i=this.getDragIntersectionPointWithSubjectPlane(t);if(!i)return;if(0===(0,yi.E7)(t.camera.getRay(t.mouseX,t.mouseY),this.dragMeshIncrement).length)return;this.lastPlaneIntersection=C.copy(C.create(),i);const s=C.subtract(C.create(),i,this.originalDelta);this.annotationDisplayData.annotationPlane.origin=k.d0F.fromArray(s),this.planeCoordinateSystem.origin.updateFromArray(this.annotationDisplayData.annotationPlane.origin.getVec3()),this.viewer.requestDraw()}onDragStopBase(e,t){this.lastPlaneIntersection=C.subtract(C.create(),this.lastPlaneIntersection,this.originalDelta),this.planeCoordinateSystem.origin.updateFromArray(this.lastPlaneIntersection),this.viewer.getEventDispatcher().trigger(yD.og,this.annotationId,this.deterministicId,this.lastPlaneIntersection)}addHighlight(e){super.addHighlight(e),this.updateHideState(),this.viewer.requestDraw()}removeHighlight(e){return!!e&&(!!super.removeHighlight(e)&&(this.viewer.requestDraw(),this.updateHideState(),!0))}hide(){this.isHighlighted()||(super.hide(),this.isDragging=!1)}getModelSelection(e){return(0,Ce.zZ)(this.annotationId)}updateHideState(){!this.isVisibleToUser()&&this.isHighlighted()?this.show():this.isFilteredOut&&this.hide()}onMouseEnter(e,t){this.viewer.requestDraw()}onMouseLeave(e,t){this.viewer.requestDraw()}getCurrentSidePoint(){const e=this.detailDisplay.getSidePoints();if(!e||0===e.length)return this.nextStartPoint;return e[this.findSideForLeader(e)]}onDragStartAnnotationDetail(e,t,i){this.isDragging=!0;const s=this.getDragIntersectionPointWithAnnotationPlane(t);if(!s)return;const n=this.getCurrentSidePoint();this.originalDelta=C.subtract(C.create(),s,n),this.newEndPoint=s,i.requestDrag=!0}onDragAnnotationDetail(e,t){const i=this.getDragIntersectionPointWithAnnotationPlane(t);if(!i)return;const s=this.getCurrentSidePoint();this.oldEndPoint=C.copy(C.create(),s),this.newEndPoint=C.subtract(C.create(),i,this.originalDelta);const n=C.subtract(C.create(),this.newEndPoint,this.oldEndPoint),r=this.detailDisplay.getSidePoints();r[0]=C.add(C.create(),r[0],n),r[1]=C.add(C.create(),r[1],n);const a=this.findSideForLeader(r);this.adjustLeaderToSide(a,r,!0)}onDragStopAnnotationDetail(e,t){const i=this.detailDisplay.getSidePoints(),s=this.findSideForLeader(i);this.adjustLeaderToSide(s,i,!1),this.isDragging=!1}findSideForLeader(e){if(2!==e.length)return 0;const t=this.planeCoordinateSystem.origin.getVec3();return C.squaredDistance(e[0],t)>C.squaredDistance(e[1],t)?1:0}adjustLeaderToSide(e,t,i){const s=t[e],n=this.planeCoordinateSystem.origin.getVec3(),r=this.planeCoordinateSystem.xAxis.getVec3(),a=this.planeCoordinateSystem.yAxis.getVec3();C.normalize(r,r),C.normalize(a,a);const o=t[1-e],h=C.subtract(C.create(),s,o);C.normalize(h,h);const c=this.getSideEdgeLength(n),l=C.add(C.create(),s,C.scale(C.create(),h,c)),u=[];if(u.push(n),u.push(l),u.push(s),i){this.draggingLeaderPoints=[],this.draggingLeaderPoints.push(C.copy(C.create(),l)),this.draggingLeaderPoints.push(C.copy(C.create(),s));const e=C.subtract(C.create(),s,l);return void(this.startDetailFromFarSide=C.dot(r,e)<0)}const d=[],g=this.annotationId;this.annotationDisplayData.dxdySegments=[];for(let e=0;e<2;e++){const t=u[e],i=u[e+1],s=C.subtract(C.create(),i,t);1===e&&(this.startDetailFromFarSide=C.dot(r,s)<0);const n=C.dot(s,r),o=C.dot(s,a),h=Q.fromValues(n,o);d.push(h);const c=new k.YFv;c.x=n,c.y=o,this.annotationDisplayData.dxdySegments.push(c)}this.viewer.getEventDispatcher().trigger(yD.nu,g,d),this.viewer.requestDraw()}}class iu extends tu{constructor(e,t,i,s){super(e,t,i,s),this.listenTo(this,Ti.zw.DOUBLE_CLICK+au,this.onEditAnnotation),this.listenTo(this,Ti.zw.DOUBLE_CLICK+hu,this.onEditAnnotation),this.listenTo(this,Ti.zw.DOUBLE_CLICK+lu,this.onEditAnnotation),this.listenTo(this,Ti.zw.MOUSE_ENTER+lu,this.onMouseEnter),this.listenTo(this,Ti.zw.MOUSE_LEAVE+lu,this.onMouseLeave),this.listenTo(this,Ti.zw.DRAG_START+lu,this.onDragStartAnnotationDetail),this.listenTo(this,Ti.zw.DRAG+lu,this.onDragAnnotationDetail),this.listenTo(this,Ti.zw.DRAG_STOP+lu,this.onDragStopAnnotationDetail)}processDisplayData(){0===this.deterministicId.length&&(this.deterministicId=this.annotationDisplayData.deterministicId),this.baseDisplay||(this.baseDisplay=new vu(this)),this.leaderDisplay||(this.leaderDisplay=new sd(this)),this.detailDisplay||(this.detailDisplay=new Nu(this)),this.baseDisplay.processDisplayData(),this.leaderDisplay.processDisplayData(),this.detailDisplay.processDisplayData()}onEditAnnotation(e,t){(0,sr.m)().trigger(ir.C.EDIT_ANNOTATION_DATUM,this.annotationId,t.mouseX,t.mouseY)}onDragStartAnnotationDetail(e,t,i){const s=this.getDragIntersectionWithBaseAxis(t);if(!s)return;this.isDragging=!0,this.newEndPoint=s;const n=C.subtract(C.create(),s,this.nextStartPoint);this.dragDistance=C.distance(C.create(),n),i.requestDrag=!0}getDragIntersectionWithBaseAxis(e){const t=this.getDragIntersectionPointWithAnnotationPlane(e);return this.intersectRayWithSubjectAxis(t)}onDragAnnotationDetail(e,t){const i=this.getDragIntersectionWithBaseAxis(t);if(!i)return;this.newEndPoint=i;const s=C.subtract(C.create(),i,this.nextStartPoint);this.dragDistance=C.distance(C.create(),s),this.viewer.requestDraw()}onDragStopAnnotationDetail(e,t){this.isDragging=!1;const i=Q.create();i[0]=0,i[1]=this.dragDistance;const s=[];s.push(i),this.viewer.getEventDispatcher().trigger(yD.nu,this.annotationId,s),this.viewer.requestDraw()}}class su extends tu{constructor(e,t,i,s){super(e,t,i,s),this.listenTo(this,Ti.zw.DOUBLE_CLICK+au,this.onEditAnnotation),this.listenTo(this,Ti.zw.DOUBLE_CLICK+hu,this.onEditAnnotation),this.listenTo(this,Ti.zw.DOUBLE_CLICK+du,this.onEditAnnotation),this.listenTo(this,Ti.zw.MOUSE_ENTER+du,this.onMouseEnter),this.listenTo(this,Ti.zw.MOUSE_LEAVE+du,this.onMouseLeave),this.listenTo(this,Ti.zw.DRAG_START+du,this.onDragStartAnnotationDetail),this.listenTo(this,Ti.zw.DRAG+du,this.onDragAnnotationDetail),this.listenTo(this,Ti.zw.DRAG_STOP+du,this.onDragStopAnnotationDetail)}processDisplayData(){0===this.deterministicId.length&&(this.deterministicId=this.annotationDisplayData.deterministicId),this.baseDisplay||(this.baseDisplay=new Ru(this)),this.leaderDisplay||(this.leaderDisplay=new nd(this)),this.detailDisplay||(this.detailDisplay=new Lu(this)),this.detailDisplay.isUpdateNeeded()&&this.removeMeshIncrements(),this.leaderDisplay.processDisplayData(),this.baseDisplay.processDisplayData(),this.detailDisplay.processDisplayData()}onEditAnnotation(e,t){(0,sr.m)().trigger(ir.C.EDIT_ANNOTATION_GTOL,this.annotationId,t.mouseX,t.mouseY)}}class nu extends tu{constructor(e,t,i,s){super(e,t,i,s),this.listenTo(this,Ti.zw.DOUBLE_CLICK+au,this.onEditWeld),this.listenTo(this,Ti.zw.DOUBLE_CLICK+hu,this.onEditWeld),this.listenTo(this,Ti.zw.DOUBLE_CLICK+fu,this.onEditWeld),this.listenTo(this,Ti.zw.DOUBLE_CLICK+pu,this.onEditWeld),this.listenTo(this,Ti.zw.DOUBLE_CLICK+Eu,this.onEditWeld),this.listenTo(this,Ti.zw.MOUSE_ENTER+fu,this.onMouseEnter),this.listenTo(this,Ti.zw.MOUSE_LEAVE+fu,this.onMouseLeave),this.listenTo(this,Ti.zw.DRAG_START+fu,this.onDragStartAnnotationDetail),this.listenTo(this,Ti.zw.DRAG+fu,this.onDragAnnotationDetail),this.listenTo(this,Ti.zw.DRAG_STOP+fu,this.onDragStopAnnotationDetail),this.listenTo(this,Ti.zw.MOUSE_ENTER+pu,this.onMouseEnter),this.listenTo(this,Ti.zw.MOUSE_LEAVE+pu,this.onMouseLeave),this.listenTo(this,Ti.zw.DRAG_START+pu,this.onDragStartAnnotationDetail),this.listenTo(this,Ti.zw.DRAG+pu,this.onDragAnnotationDetail),this.listenTo(this,Ti.zw.DRAG_STOP+pu,this.onDragStopAnnotationDetail)}processDisplayData(){this.deterministicId||(this.deterministicId=this.annotationDisplayData.deterministicId),this.baseDisplay||(this.baseDisplay=new wu(this)),this.leaderDisplay||(this.leaderDisplay=new rd(this)),this.detailDisplay||(this.detailDisplay=new td(this)),this.detailDisplay.isUpdateNeeded()&&this.removeMeshIncrements(),this.leaderDisplay.processDisplayData(),this.baseDisplay.processDisplayData(),this.detailDisplay.processDisplayData()}onEditWeld(e,t){(0,sr.m)().trigger(ir.C.EDIT_ANNOTATION_WELD,this.annotationId,t.mouseX,t.mouseY)}}const ru="_annotation_base_element_id",au="_annotation_base_selection_id",ou="_annotation_leader_element_id",hu="_annotation_leader_selection_id",cu="_annotation_detail_element_id",lu="_annotation_detail_selection_id",uu="_annotation_gtol_detail_element_id",du="_annotation_gtol_detail_selection_id",gu="_annotation_weld_extended_leader_element_id",pu="_annotation_weld_extended_leader_selection_id",mu="_annotation_weld_detail_element_id",fu="_annotation_weld_detail_selection_id",Iu="_annotation_iso_leader_element_id",Eu="_annotation_iso_leader_selection_id",Su="_annotation_detail_cell_element_id",Tu="_annotation_detail_cell_selection_id",Du=new xi.hF({isPickable:!0,primitiveType:Di.MX.LINES}),Mu=new xi.hF({isPickable:!0,isTwoSided:!0,primitiveType:Di.MX.TRIANGLES}),Cu=new xi.hF({isPickable:!0,primitiveType:Di.MX.LINES}),yu=new xi.hF({isPickable:!0,primitiveType:Di.MX.LINES});class Pu{constructor(e){this.annotationDisplay=e}getAnnotationDisplayData(){return this.annotationDisplay.getAnnotationDisplayData()}getPlaneCoordinateSystem(){return this.annotationDisplay.getPlaneCoordinateSystem()}getBaseCoordinateSystem(){return this.annotationDisplay.getBaseCoordinateSystem()}setNextStartPoint(e){this.annotationDisplay.setNextStartPoint(e)}getNextStartPoint(){return this.annotationDisplay.getNextStartPoint()}setLeaderStartDirection(e){this.annotationDisplay.setLeaderStartDirection(e)}getLeaderStartDirection(){return this.annotationDisplay.getLeaderStartDirection()}getSideEdgeLength(e){return this.annotationDisplay.getSideEdgeLength(e)}setExtendedLeaderStartPoint(e){this.annotationDisplay.setExtendedLeaderStartPoint(e)}getExtendedLeaderStartPoint(){return this.annotationDisplay.getExtendedLeaderStartPoint()}getPixelSizeAtWorldPoint(e){return this.annotationDisplay.getPixelSizeAtWorldPoint(e)}isHighlighted(){return this.annotationDisplay.isHighlighted()}getHighlight(){return this.annotationDisplay.getHighlight()}getColor(){return this.annotationDisplay.getColor()}getLineWidth(){return this.annotationDisplay.getLineWidth()}getLineStyle(){return this.annotationDisplay.getLineStyle()}getFont(){return this.annotationDisplay.getFont()}getFontSize(){return this.annotationDisplay.getFontSize()}getBackgroundPadding(){return this.annotationDisplay.getBackgroundPadding()}getBackgroundColor(){return this.annotationDisplay.getBackgroundColor()}destroy(){}}var Au=i(20042);class Ou extends Pu{constructor(e){super(e)}createArrow(e,t,i,s){const n=[],r=e.zAxis.getVec3(),a=C.create(),o=C.create(),h=C.create();C.normalize(s,s);const c=C.cross(C.create(),s,r);return C.normalize(c,c),C.scale(c,c,i/4),C.scale(s,s,i),C.copy(a,t),C.subtract(o,s,c),C.add(h,s,c),C.add(o,o,t),C.add(h,h,t),n.push(a),n.push(o),n.push(h),n}processDisplayData(){let e=[],t=null;e=this.createDisplayPoints();t=(0,Au.aT)(e[0],e[1],e[2],ru),(0,Au.Ab)(this.getColor(),t),this.annotationDisplay.updateMeshIncrement(ru,au,t,Mu)}getArrowHeightForAnnotation(e){return X.default.getManager().getNumber("ANNOTATION_ARROW_HEIGHT_PX")*this.getPixelSizeAtWorldPoint(e)}}class vu extends Ou{constructor(e){super(e)}createDisplayPoints(){const e=[],t=this.getPlaneCoordinateSystem(),i=t.xAxis.getVec3(),s=t.yAxis.getVec3(),n=t.origin.getVec3(),r=this.getArrowHeightForDatum(n),a=C.scale(C.create(),i,-r/2),o=C.scale(C.create(),s,r),h=C.scale(C.create(),i,r/2);return C.add(a,a,n),C.add(o,o,n),C.add(h,h,n),e.push(a),e.push(o),e.push(h),this.setNextStartPoint(o),e}getArrowHeightForDatum(e){return X.default.getManager().getNumber("ANNOTATION_DATUM_ARROW_HEIGHT_PX")*this.getPixelSizeAtWorldPoint(e)}}class Ru extends Ou{constructor(e){super(e)}createDisplayPoints(){const e=this.getPlaneCoordinateSystem(),t=e.origin.getVec3(),i=this.getArrowHeightForAnnotation(t),s=C.copy(C.create(),this.getLeaderStartDirection());return this.createArrow(e,t,i,s)}}class wu extends Ou{constructor(e){super(e)}createDisplayPoints(){const e=this.getPlaneCoordinateSystem(),t=e.origin.getVec3(),i=this.getArrowHeightForAnnotation(t),s=C.copy(C.create(),this.getLeaderStartDirection());return this.createArrow(e,t,i,s)}}class _u extends Pu{constructor(e){super(e)}isUpdateNeeded(){return!1}}class Nu extends _u{constructor(e){super(e),this.textTexture=null,this.textMaterial=null,this.datumDisplayData=null,this.currentHighlightType=null,this.annotationDisplay.getAnnotationDisplayData()instanceof k.UqF&&(this.datumDisplayData=this.annotationDisplay.getAnnotationDisplayData())}destroy(){this.destroyTextureAndMaterial()}getSidePoints(){return[]}destroyTextureAndMaterial(){this.textMaterial&&(this.textMaterial?.ambientTexture.destroy(),this.textMaterial.destroy(),this.textMaterial=null),this.textTexture&&(this.textTexture.destroy(),this.textTexture=null)}processDisplayData(){this.currentHighlightType!==this.getHighlight()?.type&&this.destroyTextureAndMaterial();const e=this.getPlaneCoordinateSystem();let t="",i=this.getNextStartPoint();this.annotationDisplay.isDragging&&(i=this.annotationDisplay.newEndPoint),this.datumDisplayData&&(t=this.datumDisplayData.name),this.textMaterial||(this.currentHighlightType=this.getHighlight()?.type,this.textTexture=_o(this.annotationDisplay.viewer,t,{color:this.getColor(),font:this.getFont(),size:this.getFontSize(),paddingWithinBorder:this.getBackgroundPadding(),backgroundColor:this.getBackgroundColor(),backgroundOpacity:1,backgroundRadius:0,borderColor:this.getColor(),borderThickness:this.getLineWidth(),dashLength:2,dashGapLength:0}),this.textTexture.hasTransparency=!1,this.textMaterial=Fi(),this.textMaterial.setTexture(this.textTexture),this.annotationDisplay.nodeProperties=new xi.hF({isVisible:!0,isTwoSided:!0,primitiveType:Di.MX.TRIANGLES,isPickable:!0,material:this.textMaterial}));const s=e.xAxis.getVec3(),n=e.yAxis.getVec3();let r=[!1,!1];r=this.annotationDisplay.getFlips();const a=this.textTexture,o=this.annotationDisplay.camera.getPixelSizeAtWorldPoint(i),h=C.add(C.create(),i,C.scale(C.create(),s,-a.filledWidthPx/2*o)),c=C.add(C.create(),h,C.scale(C.create(),s,a.filledWidthPx*o)),l=C.add(C.create(),h,C.scale(C.create(),n,a.filledHeightPx*o)),u=(0,Au.fQ)(h,c,l,void 0,[r[0]?a.rightCoordinate:a.leftCoordinate,r[1]?a.topCoordinate:a.bottomCoordinate],[r[0]?a.leftCoordinate:a.rightCoordinate,r[1]?a.bottomCoordinate:a.topCoordinate]);this.annotationDisplay.updateMeshIncrement(cu,lu,u,this.annotationDisplay.nodeProperties)}}class bu{constructor(){this.displayCells=[]}}class Lu extends _u{constructor(e){super(e),this.gtolRowTextureData=[],this.gtolDisplayData=null,this.topNearBoxPositions=[],this.wholeBoxesWithLines=[],this.boxWidthValues=[],this.boxEdgeLength=0,this.flips=[],this.xAxis=null,this.yAxis=null,this.adjustedStartPoint=null,this.totalDisplayWidth=0,this.lastRenderedUnitSizePx=-1,this.constraintUpperCellDisplay=null,this.constraintLowerCellDisplay=null;const t=this.getAnnotationDisplayData();t.getAnnotationType()===k.pLb.GTOL&&(this.gtolDisplayData=t instanceof k.UmN?t:null)}destroy(){this.destroyChildren()}destroyChildren(){this.constraintUpperCellDisplay?.destroy(),this.constraintLowerCellDisplay?.destroy(),this.gtolRowTextureData.length>0&&this.gtolRowTextureData.forEach((e=>{e.displayCells.forEach((e=>{e?.destroy()}))}))}isUpdateNeeded(){let e=!1,t=this.constraintUpperCellDisplay?.updateTexture();t=t||this.constraintLowerCellDisplay?.updateTexture(),t||this.gtolRowTextureData.forEach((e=>{e.displayCells.forEach((e=>{e.updateTexture()&&(t=!0)}))}));const i=this.annotationDisplay.camera.getUnitSizeAtWorldPoint(this.getNextStartPoint());return Math.abs(this.lastRenderedUnitSizePx-i)>Ci.W.ZERO_LENGTH&&(t=!0),this.lastRenderedUnitSizePx=i,t&&(e=!0,this.destroyChildren(),this.gtolRowTextureData.forEach((e=>{e.displayCells=[]})),this.gtolRowTextureData=[],this.wholeBoxesWithLines=[],this.topNearBoxPositions=[],this.boxWidthValues=[]),e}processDisplayData(){let e=this.isUpdateNeeded();0===this.gtolRowTextureData.length&&(e=!0);const t=this.annotationDisplay.getPlaneCoordinateSystem();this.xAxis=t.xAxis.getVec3(),this.yAxis=t.yAxis.getVec3();let i=this.getNextStartPoint();this.flips=this.annotationDisplay.getFlips(),this.boxEdgeLength=this.getSideEdgeLength(i),this.annotationDisplay.startDetailFromFarSide&&(i=C.add(C.create(),i,C.scale(C.create(),this.xAxis,-this.totalDisplayWidth))),this.adjustedStartPoint=this.adjustStartPoint(i);for(let t=0;t<this.gtolDisplayData.rows.length;t++){if(e){const e=new bu;this.gtolRowTextureData.push(e),this.wholeBoxesWithLines=[],this.topNearBoxPositions=[],this.boxWidthValues=[];i=this.adjustStartPoint(i),this.createRowDisplayCells(t),this.createRowTextures(i,t),this.updateTotalDisplayWidth(),this.createBoxes()}this.instantiateRowTextures(i,t)}i=this.adjustedStartPoint,this.displayUpperText(i),i=this.adjustedStartPoint,this.displayLowerText(i)}createRowDisplayCells(e){const t=this.gtolDisplayData.rows[e],i=this.gtolRowTextureData[e],s=t.constraintType;let n=k.ad8[s];this.isHighlighted()&&(n=tu.getIconHighlightName(n));const r=this.annotationDisplay.convertToleranceToString(t.tolerance);let a="",o="",h="";t.references&&(a=t.references.length>0?t.references[0]:"",o=t.references.length>1?t.references[1]:"",h=t.references.length>2?t.references[2]:""),i.displayCells.push(new Bu(this.annotationDisplay,"cell_id_prefix",t.prefix)),i.displayCells.push(new xu(this.annotationDisplay,"cell_id_constraint_type",n)),i.displayCells.push(new Bu(this.annotationDisplay,"cell_id_constraint_Value",r)),i.displayCells.push(new Bu(this.annotationDisplay,"cell_id_datum_0",a)),i.displayCells.push(new Bu(this.annotationDisplay,"cell_id_datum_1",o)),i.displayCells.push(new Bu(this.annotationDisplay,"cell_id_datum_2",h)),i.displayCells.push(new Bu(this.annotationDisplay,"cell_id_suffix",t.suffix)),this.flips[0]&&i.displayCells.reverse()}adjustStartPoint(e){const t=C.add(C.create(),e,C.scale(C.create(),this.yAxis,this.boxEdgeLength/2));return this.topNearBoxPositions.push(t),t}updateTotalDisplayWidth(){this.totalDisplayWidth=0,this.boxWidthValues.forEach((e=>{this.totalDisplayWidth+=e}))}getSidePoints(){const e=[];e.push(this.adjustedStartPoint);const t=C.add(C.create(),this.adjustedStartPoint,C.scale(C.create(),this.xAxis,this.totalDisplayWidth));return e.push(t),e}createRowTextures(e,t){this.gtolRowTextureData[t].displayCells.forEach((t=>{const i=t.createTexture(e);e=C.add(C.create(),e,C.scale(C.create(),this.xAxis,i)),this.topNearBoxPositions.push(e),this.boxWidthValues.push(i)}))}instantiateRowTextures(e,t){this.annotationDisplay.camera.getPixelSizeAtWorldPoint(e);const i=this.gtolRowTextureData[t].displayCells;for(let e=0;e<i.length;e++){const t=i[e],s=this.boxWidthValues[e],n=this.boxEdgeLength,r=this.topNearBoxPositions[e];t.setWidth(s),t.setHeight(n),t.instantiateTexture(r)}}createBoxes(){this.wholeBoxesWithLines=[];let e=0;this.topNearBoxPositions.forEach((t=>{let i=C.create();i=t;const s=1*this.boxWidthValues[e++],n=C.create();n[0]=i[0]+this.xAxis[0]*s,n[1]=i[1]+this.xAxis[1]*s,n[2]=i[2]+this.xAxis[2]*s;const r=C.create();r[0]=n[0]-this.yAxis[0]*this.boxEdgeLength,r[1]=n[1]-this.yAxis[1]*this.boxEdgeLength,r[2]=n[2]-this.yAxis[2]*this.boxEdgeLength;const a=C.create();a[0]=r[0]-this.xAxis[0]*s,a[1]=r[1]-this.xAxis[1]*s,a[2]=r[2]-this.xAxis[2]*s,1!==e&&e!==this.topNearBoxPositions.length-1&&(this.wholeBoxesWithLines.push(i),this.wholeBoxesWithLines.push(n),this.wholeBoxesWithLines.push(n),this.wholeBoxesWithLines.push(r),this.wholeBoxesWithLines.push(r),this.wholeBoxesWithLines.push(a),this.wholeBoxesWithLines.push(a),this.wholeBoxesWithLines.push(i))}));const t=(0,Au.pf)(this.wholeBoxesWithLines,uu,this.getColor(),this.getLineWidth(),this.getLineStyle());this.annotationDisplay.updateMeshIncrement(uu,du,t,yu)}displayUpperText(e){if(0===this.gtolDisplayData.upper.length)return;const t=this.annotationDisplay.getFlips()[1]?-this.boxEdgeLength:this.boxEdgeLength,i=C.add(C.create(),e,C.scale(C.create(),this.yAxis,t));this.constraintUpperCellDisplay=new Bu(this.annotationDisplay,"cell_id_upper",this.gtolDisplayData.upper);const s=this.constraintUpperCellDisplay.createTexture(i),n=this.boxEdgeLength;this.constraintUpperCellDisplay.setWidth(s),this.constraintUpperCellDisplay.setHeight(n);const r=C.add(C.create(),i,C.scale(C.create(),this.xAxis,(this.totalDisplayWidth-s)/2));this.constraintUpperCellDisplay.instantiateTexture(r)}displayLowerText(e){if(0===this.gtolDisplayData.lower.length)return;const t=this.annotationDisplay.getFlips()[1]?this.boxEdgeLength:-this.boxEdgeLength,i=C.add(C.create(),e,C.scale(C.create(),this.yAxis,t));this.constraintLowerCellDisplay=new Bu(this.annotationDisplay,"cell_id_lower",this.gtolDisplayData.lower);const s=this.constraintLowerCellDisplay.createTexture(i),n=this.boxEdgeLength;this.constraintLowerCellDisplay.setWidth(s),this.constraintLowerCellDisplay.setHeight(n);const r=C.add(C.create(),i,C.scale(C.create(),this.xAxis,(this.totalDisplayWidth-s)/2));this.constraintLowerCellDisplay.instantiateTexture(r)}}class Fu extends _u{constructor(e,t,i){super(e),this.cellId=t,this.displayValue=i,this.height=0,this.width=0,this.xAxis=null,this.yAxis=null,this.lastFlips=[],this.nodeProperties=null,this.xAxis=e.getPlaneCoordinateSystem().xAxis.getVec3(),this.yAxis=e.getPlaneCoordinateSystem().yAxis.getVec3(),this.lastFlips=e.getFlips()}getSidePoints(){return[]}processDisplayData(){}setCellId(e){this.cellId=e}setDisplayValue(e){this.displayValue=e}setHeight(e){this.height=e}setWidth(e){this.width=e}didFlipsChange(){const e=this.annotationDisplay.getFlips();return e[0]!==this.lastFlips[0]||e[1]!==this.lastFlips[1]}}class xu extends Fu{constructor(e,t,i){super(e,t,i)}destroyTextureAndMaterial(){}updateTexture(){return!1}createTexture(e){const t=this.getSideEdgeLength(e),i=(this.annotationDisplay.camera.getPixelSizeAtWorldPoint(e),this.annotationDisplay.viewer.getResources().mbdAtlasNodeProperties);return this.nodeProperties=i[1],t}instantiateTexture(e){let t=[!1,!1];t=this.annotationDisplay.getFlips();const i=this.annotationDisplay.getIconSize(),s=this.width/2,n=this.height,r=C.add(C.create(),e,C.scale(C.create(),this.xAxis,s));C.subtract(r,r,C.scale(C.create(),this.yAxis,.9*n));const a=this.annotationDisplay.camera.getPixelSizeAtWorldPoint(e),o=C.add(C.create(),r,C.scale(C.create(),this.xAxis,-i/2*a)),h=C.add(C.create(),o,C.scale(C.create(),this.xAxis,i*a)),c=C.add(C.create(),o,C.scale(C.create(),this.yAxis,i*a)),l=this.annotationDisplay.viewer.getResources().mbdAtlas;if(l){const e=l.getTextureCoords(this.displayValue);if(e){const i=(0,Au.fQ)(o,h,c,void 0,[t[0]?e.highS:e.lowS,t[1]?e.lowT:e.highT],[t[0]?e.lowS:e.highS,t[1]?e.highT:e.lowT]);this.annotationDisplay.updateMeshIncrement(this.cellId,du,i,this.nodeProperties)}}}}class Bu extends Fu{constructor(e,t,i){super(e,t,i),this.textTexture=null,this.textMaterial=null,this.lastRenderedHighlightType=null,this.lastRenderedHighlightType=this.currentHighlightType}destroy(){this.destroyTextureAndMaterial()}destroyTextureAndMaterial(){this.textMaterial&&(this.textMaterial.ambientTexture?.destroy(),this.textMaterial.destroy(),this.textMaterial=null),this.textTexture&&(this.textTexture.destroy(),this.textTexture=null)}get currentHighlightType(){return this.getHighlight()?.type||null}updateTexture(){return!(this.lastRenderedHighlightType===this.currentHighlightType&&!this.annotationDisplay.isDragging&&!this.didFlipsChange())&&(this.destroyTextureAndMaterial(),!0)}createTexture(e){this.destroyTextureAndMaterial();let t=0;if(0===this.displayValue.length)return t;if(!this.textMaterial){this.lastFlips=this.annotationDisplay.getFlips(),this.lastRenderedHighlightType=this.currentHighlightType,this.textTexture=_o(this.annotationDisplay.viewer,this.displayValue,{color:this.getColor(),font:this.getFont(),size:this.getFontSize(),paddingWithinBorder:this.getBackgroundPadding(),backgroundColor:this.getBackgroundColor(),backgroundOpacity:1,backgroundRadius:0,borderThickness:0,dashLength:2,dashGapLength:0}),this.textTexture.hasTransparency=!1,this.textMaterial=Fi(),this.textMaterial.setTexture(this.textTexture),this.nodeProperties=new xi.hF({isVisible:!0,isTwoSided:!0,primitiveType:Di.MX.TRIANGLES,isPickable:!0,material:this.textMaterial,zOffset:25});const i=this.annotationDisplay.camera.getPixelSizeAtWorldPoint(e);t=this.textTexture.filledWidthPx*i}return t}instantiateTexture(e){if(!this.textMaterial)return;const t=this.annotationDisplay.getFlips(),i=this.textTexture,s=this.width/2,n=this.height,r=C.add(C.create(),e,C.scale(C.create(),this.xAxis,s));C.subtract(r,r,C.scale(C.create(),this.yAxis,n));const a=this.annotationDisplay.camera.getPixelSizeAtWorldPoint(e),o=C.add(C.create(),r,C.scale(C.create(),this.xAxis,-i.filledWidthPx/2*a)),h=C.add(C.create(),o,C.scale(C.create(),this.xAxis,i.filledWidthPx*a)),c=C.add(C.create(),o,C.scale(C.create(),this.yAxis,i.filledHeightPx*a)),l=(0,Au.fQ)(o,h,c,void 0,[t[0]?i.rightCoordinate:i.leftCoordinate,t[1]?i.topCoordinate:i.bottomCoordinate],[t[0]?i.leftCoordinate:i.rightCoordinate,t[1]?i.bottomCoordinate:i.topCoordinate]);this.annotationDisplay.updateMeshIncrement(this.cellId,du,l,this.nodeProperties)}}class Vu extends _u{constructor(e){super(e),this.textTexture=null,this.textMaterial=null,this.currentHighlightType=null,this.displayValue="",this.cellId="",this.lowerLeft=null,this.upperLeft=null,this.lowerRight=null,this.upperRight=null,this.boxEdgeLength=0}processDisplayData(){}getSidePoints(){return[]}setDisplayValue(e){this.displayValue=e}setCellId(e){this.cellId=e}destroy(){this.destroyTextureAndMaterial()}destroyTextureAndMaterial(){this.textMaterial&&(this.textMaterial.ambientTexture?.destroy(),this.textMaterial.destroy(),this.textMaterial=null),this.textTexture&&(this.textTexture.destroy(),this.textTexture=null)}updateTexture(e,t,i,s){this.currentHighlightType!==this.getHighlight()?.type||this.annotationDisplay.isDragging,this.destroyTextureAndMaterial(),this.currentHighlightType=this.getHighlight()?.type,this.textTexture=_o(this.annotationDisplay.viewer,this.displayValue,{color:this.getColor(),font:this.getFont(),size:this.getFontSize(),paddingWithinBorder:this.getBackgroundPadding(),backgroundRadius:0,borderThickness:0,dashLength:2,dashGapLength:0}),this.textTexture.hasTransparency=!1,this.textMaterial=Fi(),this.textMaterial.setTexture(this.textTexture);const n=new xi.hF({isVisible:!0,isTwoSided:!0,primitiveType:Di.MX.TRIANGLES,isPickable:!0,material:this.textMaterial}),r=this.textTexture;this.boxEdgeLength=this.getSideEdgeLength(e);const a=r.filledWidthPx*this.getPixelSizeAtWorldPoint(e),o=this.boxEdgeLength;s?(this.lowerLeft=e,this.upperLeft=C.add(C.create(),this.lowerLeft,C.scale(C.create(),i,o)),this.upperRight=C.add(C.create(),this.upperLeft,C.scale(C.create(),t,a)),this.lowerRight=C.add(C.create(),this.lowerLeft,C.scale(C.create(),t,a))):(this.upperLeft=e,this.upperRight=C.add(C.create(),this.upperLeft,C.scale(C.create(),t,a)),this.lowerLeft=C.add(C.create(),this.upperLeft,C.scale(C.create(),i,-o)),this.lowerRight=C.add(C.create(),this.lowerLeft,C.scale(C.create(),t,a)));const h=Po(this.annotationDisplay.camera,t,i),c=(0,Au.fQ)(this.lowerLeft,this.lowerRight,this.upperLeft,void 0,[h[0]?r.rightCoordinate:r.leftCoordinate,h[1]?r.topCoordinate:r.bottomCoordinate],[h[0]?r.leftCoordinate:r.rightCoordinate,h[1]?r.bottomCoordinate:r.topCoordinate]);this.annotationDisplay.updateMeshIncrement(this.cellId,fu,c,n)}}const Uu="mbd_weld_upper_root_opening",Gu="mbd_weld_upper_groove_cell_id",Hu="mbd_weld_upper_value_one",ku="mbd_weld_upper_value_two",Wu="mbd_weld_upper_value_three",zu="mbd_weld_upper_value_four",Xu="mbd_weld_lower_root_opening",Zu="mbd_weld_lower_groove_cell_id",qu="mbd_weld_lower_value_one",Yu="mbd_weld_lower_value_two",Ku="mbd_weld_lower_value_three",ju="mbd_weld_lower_value_four",Qu=new Set([Uu,Gu,Hu,ku,Wu,zu]),$u=new Set([Xu,Zu,qu,Yu,Ku,ju]),Ju=new Set([Uu,Gu,Xu,Zu]),ed=X.default.getManager();class td extends _u{constructor(e){super(e),this.boxEdgeLength=0,this.upperHorizontalBoxesStartPoint=null,this.upperVerticalBoxesStartPoint=null,this.lowerHorizontalBoxesStartPoint=null,this.lowerVerticalBoxesStartPoint=null,this.linePoints=[];const t=this.getAnnotationDisplayData();t.getAnnotationType()===k.pLb.WELD&&(this.weldDisplayData=t instanceof k.tGf?t:null),this.cellIdToDisplayValue=new Map([[Uu,this.weldDisplayData.upperRootOpening],[Gu,this.weldDisplayData.upperGroove],[Hu,this.weldDisplayData.upperValueOne],[ku,this.weldDisplayData.upperValueTwo],[Wu,this.weldDisplayData.upperValueThree],[zu,this.weldDisplayData.upperValueFour],[Xu,this.weldDisplayData.lowerRootOpening],[Zu,this.weldDisplayData.lowerGroove],[qu,this.weldDisplayData.lowerValueOne],[Yu,this.weldDisplayData.lowerValueTwo],[Ku,this.weldDisplayData.lowerValueThree],[ju,this.weldDisplayData.lowerValueFour]]),this.cellIdToDisplayElement=new Map;for(const t of this.cellIdToDisplayValue.keys())this.cellIdToDisplayElement.set(t,new Vu(e));this.referenceDisplayElement=new Vu(e)}processDisplayData(){this.linePoints=[],this.system=this.annotationDisplay.planeCoordinateSystem,this.startPoint=this.getNextStartPoint(),this.boxEdgeLength=this.getSideEdgeLength(this.startPoint),this.initializeBoxPointParameters(this.startPoint),this.annotationDisplay.startDetailFromFarSide?(this.insertQuantityToBox(zu,this.upperHorizontalBoxesStartPoint),this.insertQuantityToBox(Wu,this.upperHorizontalBoxesStartPoint),this.insertQuantityToBox(ju,this.lowerHorizontalBoxesStartPoint),this.insertQuantityToBox(Ku,this.lowerHorizontalBoxesStartPoint)):(this.insertQuantityToBox(Hu,this.upperHorizontalBoxesStartPoint),this.insertQuantityToBox(ku,this.upperHorizontalBoxesStartPoint),this.insertQuantityToBox(qu,this.lowerHorizontalBoxesStartPoint),this.insertQuantityToBox(Yu,this.lowerHorizontalBoxesStartPoint)),C.dot(this.upperHorizontalBoxesStartPoint,this.extendedLeaderDirection)>C.dot(this.lowerHorizontalBoxesStartPoint,this.extendedLeaderDirection)?this.lowerHorizontalBoxesStartPoint=C.subtract(C.create(),this.upperHorizontalBoxesStartPoint,this.getDeltaVectorForBoxStartPoints(this.upperHorizontalBoxesStartPoint)):this.upperHorizontalBoxesStartPoint=C.add(C.create(),this.lowerHorizontalBoxesStartPoint,this.getDeltaVectorForBoxStartPoints(this.lowerHorizontalBoxesStartPoint)),this.insertUpperWeldTypeIcon(this.upperHorizontalBoxesStartPoint),this.insertQuantityToBox(Uu,this.upperVerticalBoxesStartPoint),this.insertQuantityToBox(Gu,this.upperVerticalBoxesStartPoint),this.insertLowerWeldTypeIcon(this.lowerHorizontalBoxesStartPoint),this.insertQuantityToBox(Xu,this.lowerVerticalBoxesStartPoint),this.insertQuantityToBox(Zu,this.lowerVerticalBoxesStartPoint),this.annotationDisplay.startDetailFromFarSide?(this.insertQuantityToBox(ku,this.upperHorizontalBoxesStartPoint),this.insertQuantityToBox(Hu,this.upperHorizontalBoxesStartPoint),this.insertQuantityToBox(Yu,this.lowerHorizontalBoxesStartPoint),this.insertQuantityToBox(qu,this.lowerHorizontalBoxesStartPoint)):(this.insertQuantityToBox(Wu,this.upperHorizontalBoxesStartPoint),this.insertQuantityToBox(zu,this.upperHorizontalBoxesStartPoint),this.insertQuantityToBox(Ku,this.lowerHorizontalBoxesStartPoint),this.insertQuantityToBox(ju,this.lowerHorizontalBoxesStartPoint));const e=this.newEndPoint;this.weldDisplayData.upperWeldType===k.RvD.NONE&&this.weldDisplayData.lowerWeldType===k.RvD.NONE||(C.dot(this.upperHorizontalBoxesStartPoint,this.extendedLeaderDirection)>C.dot(this.lowerHorizontalBoxesStartPoint,this.extendedLeaderDirection)?this.newEndPoint=this.weldDisplayData.isoFlip?C.subtract(C.create(),this.upperHorizontalBoxesStartPoint,this.getDeltaVectorForBoxStartPoints(this.upperHorizontalBoxesStartPoint)):this.upperHorizontalBoxesStartPoint:this.newEndPoint=this.weldDisplayData.isoFlip?this.lowerHorizontalBoxesStartPoint:C.add(C.create(),this.lowerHorizontalBoxesStartPoint,this.getDeltaVectorForBoxStartPoints(this.lowerHorizontalBoxesStartPoint))),this.linePoints.push(e),this.linePoints.push(this.newEndPoint);const t=this.newEndPoint;this.totalDisplayWidth=C.distance(this.startPoint,this.newEndPoint),this.createSegmentsForReferenceParameter(),this.insertReferenceStringParameter();const i=(0,Au.pf)(this.linePoints,mu,this.getColor(),this.getLineWidth(),this.getLineStyle());this.annotationDisplay.updateMeshIncrement(gu,pu,i,Cu),this.createISOLine(this.getExtendedLeaderStartPoint(),t)}getDeltaVectorForBoxStartPoints(e){return C.scale(C.create(),this.verticalDirection,this.getDistanceBetweenLeaderAndISO(e))}isUpdateNeeded(){return!!this.annotationDisplay.isDragging&&(this.destroy(),this.linePoints=[],!0)}destroy(){for(const e of this.cellIdToDisplayElement.values())e.destroy()}getSidePoints(){const e=[];e.push(this.startPoint);const t=C.add(C.create(),this.startPoint,C.scale(C.create(),this.extendedLeaderDirection,this.totalDisplayWidth));return e.push(t),e}initializeBoxPointParameters(e){this.newEndPoint=this.startPoint,this.extendedLeaderDirection=this.system.xAxis.getVec3(),this.annotationDisplay.startDetailFromFarSide&&(this.extendedLeaderDirection=C.fromValues(-this.extendedLeaderDirection[0],-this.extendedLeaderDirection[1],-this.extendedLeaderDirection[2]));const t=this.system.zAxis.getVec3(),i=this.system.yAxis.getVec3();(0,ar.areUnitVectorsParallel)(this.extendedLeaderDirection,t)?this.verticalDirection=C.cross(C.create(),this.extendedLeaderDirection,i):this.verticalDirection=C.cross(C.create(),this.extendedLeaderDirection,t),C.normalize(this.verticalDirection,this.verticalDirection),this.annotationDisplay.startDetailFromFarSide||(this.verticalDirection=C.fromValues(-this.verticalDirection[0],-this.verticalDirection[1],-this.verticalDirection[2])),this.linePoints.push(this.startPoint),this.linePoints.push(this.newEndPoint),this.weldDisplayData.isoFlip?(this.upperHorizontalBoxesStartPoint=C.add(C.create(),this.newEndPoint,this.getDeltaVectorForBoxStartPoints(this.newEndPoint)),this.lowerHorizontalBoxesStartPoint=this.newEndPoint):(this.upperHorizontalBoxesStartPoint=this.newEndPoint,this.lowerHorizontalBoxesStartPoint=C.subtract(C.create(),this.newEndPoint,this.getDeltaVectorForBoxStartPoints(this.newEndPoint))),this.flips=Po(this.annotationDisplay.camera,this.extendedLeaderDirection,this.verticalDirection)}insertUpperWeldTypeIcon(e){if(this.weldDisplayData.upperWeldType===k.RvD.NONE)return;let t=k.jv6[this.weldDisplayData.upperWeldType];const i=this.annotationDisplay.viewer.getResources().mbdAtlasNodeProperties[1];this.isHighlighted()&&(t=tu.getIconHighlightName(t));const s=this.annotationDisplay.viewer.getResources().mbdAtlas;if(s){const n=s.getTextureCoords(t);if(n){const t=this.boxEdgeLength,s=e,r=C.add(C.create(),s,C.scale(C.create(),this.verticalDirection,t)),a=C.add(C.create(),s,C.scale(C.create(),this.extendedLeaderDirection,t)),o=(0,Au.fQ)(s,a,r,void 0,[this.flips[0]?n.lowS:n.highS,n.highT],[this.flips[0]?n.highS:n.lowS,n.lowT]);this.annotationDisplay.updateMeshIncrement("mbd_upper_weld_type_icon",fu,o,i),this.upperVerticalBoxesStartPoint=r,this.upperHorizontalBoxesStartPoint=a}}}insertLowerWeldTypeIcon(e){if(this.weldDisplayData.lowerWeldType===k.RvD.NONE)return;let t=k.jv6[this.weldDisplayData.lowerWeldType];const i=this.annotationDisplay.viewer.getResources().mbdAtlasNodeProperties[1];this.isHighlighted()&&(t=tu.getIconHighlightName(t));const s=this.annotationDisplay.viewer.getResources().mbdAtlas;if(s){const n=s.getTextureCoords(t);if(n){const t=this.boxEdgeLength,s=e,r=C.add(C.create(),s,C.scale(C.create(),this.extendedLeaderDirection,t)),a=C.add(C.create(),s,C.scale(C.create(),this.verticalDirection,-t)),o=C.add(C.create(),a,C.scale(C.create(),this.extendedLeaderDirection,t)),h=(0,Au.fQ)(a,o,s,void 0,[this.flips[0]?n.lowS:n.highS,n.lowT],[this.flips[0]?n.highS:n.lowS,n.highT]);this.annotationDisplay.updateMeshIncrement("mbd_lower_weld_type_icon",fu,h,i),this.lowerVerticalBoxesStartPoint=a,this.lowerHorizontalBoxesStartPoint=r}}}insertQuantityToBox(e,t){if(!t)return;const i=Qu.has(e),s=Ju.has(e);if(0===this.cellIdToDisplayValue.get(e))return;if(this.weldDisplayData.upperWeldType===k.RvD.NONE&&Qu.has(e))return;if(this.weldDisplayData.lowerWeldType===k.RvD.NONE&&$u.has(e))return;let n="";n=e===Gu||e===Zu?"radian":"meter";const r=(0,$l.$w)(n),a=(0,rr.WR)(this.cellIdToDisplayValue.get(e),n,r),o={};o[r]=1;let h=(0,Jl.cn)(o,a,!1)+(0,BI.$D)(r);e!==zu&&e!==ju||(h="("+h+")"),this.cellIdToDisplayElement.get(e).setCellId(e),this.cellIdToDisplayElement.get(e).setDisplayValue(h),this.cellIdToDisplayElement.get(e).updateTexture(t,this.extendedLeaderDirection,this.verticalDirection,i),s?i?this.upperVerticalBoxesStartPoint=this.cellIdToDisplayElement.get(e).upperLeft:this.lowerVerticalBoxesStartPoint=this.cellIdToDisplayElement.get(e).lowerLeft:i?this.upperHorizontalBoxesStartPoint=this.cellIdToDisplayElement.get(e).lowerRight:this.lowerHorizontalBoxesStartPoint=this.cellIdToDisplayElement.get(e).upperRight}createISOLine(e,t){const i=C.distance(e,t);let s=null;s=this.weldDisplayData.isoFlip?C.add(C.create(),e,this.getDeltaVectorForBoxStartPoints(e)):C.subtract(C.create(),e,this.getDeltaVectorForBoxStartPoints(e));const n=C.add(C.create(),s,C.scale(C.create(),this.extendedLeaderDirection,i)),r=[];r.push(s),r.push(n);const a=(0,Au.pf)(r,Iu,this.getColor(),this.getLineWidth(),this.getLineStyle());(0,Au.KZ)(this.getAnnotationISOLineStipple(),a),this.annotationDisplay.updateMeshIncrement(Iu,Eu,a,Cu)}createSegmentsForReferenceParameter(){if(!this.weldDisplayData.reference)return;const e=C.add(C.create(),this.extendedLeaderDirection,this.verticalDirection);C.normalize(e,e);const t=C.add(C.create(),this.extendedLeaderDirection,C.negate(C.create(),this.verticalDirection));C.normalize(t,t);const i=this.getWeldReferenceSegmentLength(this.newEndPoint),s=C.add(C.create(),this.newEndPoint,C.scale(C.create(),e,i)),n=C.add(C.create(),this.newEndPoint,C.scale(C.create(),t,i));this.linePoints.push(this.newEndPoint),this.linePoints.push(s),this.linePoints.push(this.newEndPoint),this.linePoints.push(n),this.newEndPoint=C.add(C.create(),this.newEndPoint,C.scale(C.create(),this.extendedLeaderDirection,i))}insertReferenceStringParameter(){if(!this.weldDisplayData.reference)return;const e=C.add(C.create(),this.newEndPoint,C.scale(C.create(),this.verticalDirection,-this.boxEdgeLength/2));this.referenceDisplayElement.setCellId("mbd_weld_reference"),this.referenceDisplayElement.setDisplayValue(this.weldDisplayData.reference),this.referenceDisplayElement.updateTexture(e,this.extendedLeaderDirection,this.verticalDirection,!0)}getDistanceBetweenLeaderAndISO(e){return ed.getNumber("ANNOTATION_DISTANCE_BETWEEN_LEADER_AND_ISO_PX")*this.getPixelSizeAtWorldPoint(e)}getWeldReferenceSegmentLength(e){return ed.getNumber("ANNOTATION_WELD_REFERENCE_SEGMENT_LENGTH_PX")*this.getPixelSizeAtWorldPoint(e)}getAnnotationISOLineStipple(){return ed.getStipple("ANNOTATION_ISO_LINE_STIPPLE")}}class id extends Pu{constructor(e){super(e)}createDisplayPoints(){return null}adjustLeaderPoint(e,t){return C.create()}createDisplayPointsForDrag(){const e=[],t=this.getPlaneCoordinateSystem().xAxis.getVec3(),i=this.getPlaneCoordinateSystem().yAxis.getVec3();let s=C.copy(C.create(),this.getPlaneCoordinateSystem().origin.getVec3());for(let n=0;n<this.annotationDisplay.draggingLeaderPoints.length;n++){let r=C.copy(C.create(),this.annotationDisplay.draggingLeaderPoints[n]);r=this.adjustLeaderPoint(r,i),e.push(s),e.push(r);const a=C.subtract(C.create(),r,s);0===n?this.setLeaderStartDirection(a):1===n&&(this.annotationDisplay.startDetailFromFarSide=C.dot(t,a)<0,this.setNextStartPoint(r),this.setExtendedLeaderStartPoint(e[1])),s=C.copy(C.create(),r)}return e}createDisplayPointsForReal(){const e=[],t=this.getPlaneCoordinateSystem().xAxis.getVec3(),i=this.getPlaneCoordinateSystem().yAxis.getVec3();let s=this.getPlaneCoordinateSystem().origin.getVec3();for(let n=0;n<this.getAnnotationDisplayData().dxdySegments.length;n++){const r=this.getAnnotationDisplayData().dxdySegments[n].getVec2(),a=C.scale(C.create(),t,r[0]),o=C.scale(C.create(),i,r[1]),h=C.add(C.create(),a,o),c=C.add(C.create(),s,h);e.push(s),e.push(c),s=c,0===n?this.setLeaderStartDirection(h):n===this.getAnnotationDisplayData().dxdySegments.length-1&&(this.annotationDisplay.startDetailFromFarSide=C.dot(t,h)<0,this.setNextStartPoint(c),this.setExtendedLeaderStartPoint(e[1]))}return e}processDisplayData(){const e=this.createDisplayPoints(),t=(0,Au.pf)(e,ou,this.getColor(),this.getLineWidth(),this.getLineStyle());this.annotationDisplay.updateMeshIncrement(ou,hu,t,Cu)}}class sd extends id{constructor(e){if(super(e),this.getAnnotationDisplayData()&&this.getAnnotationDisplayData().dxdySegments.length>0){const e=this.getAnnotationDisplayData().dxdySegments[0].getVec2();this.annotationDisplay.dragDistance=e[1]}}createDisplayPoints(){const e=this.getPlaneCoordinateSystem().yAxis.getVec3(),t=this.getNextStartPoint();let i=C.create();i=this.annotationDisplay.isDragging?this.annotationDisplay.newEndPoint:C.add(C.create(),t,C.scale(C.create(),e,this.annotationDisplay.dragDistance));const s=[];return s.push(t),s.push(i),this.annotationDisplay.isDragging||this.setNextStartPoint(i),s}}class nd extends id{constructor(e){super(e)}createDisplayPoints(){return this.annotationDisplay.isDragging?this.createDisplayPointsForDrag():this.createDisplayPointsForReal()}adjustLeaderPoint(e,t){const i=this.annotationDisplay.getSideEdgeLength(e);return C.add(C.create(),e,C.scale(C.create(),t,-i/2))}}class rd extends id{constructor(e){super(e)}adjustLeaderPoint(e,t){return e}createDisplayPoints(){return this.annotationDisplay.isDragging?this.createDisplayPointsForDrag():this.createDisplayPointsForReal()}}const ad=X.default.getManager(),od=new xi.hF({primitiveType:Di.MX.POINTS,isPickable:!0,isShowThrough:!0,isDepthTested:!1});class hd extends Zl{constructor(e,t,i,s){super(hd.getEdgePointLocation(s,t,i),e,ad.getColor("POINT_BODY_COLOR"),ad.getNumber("POINT_BODY_SIZE"),s,od),this.parameter=i,this.selectionId=t.selectionId;let n=hd.getEdgePointLocation(s,t,i);const r=t.getEntityMetaData();if(this.entityMetaData=r.clone(),this.entityMetaData.setBodyMetaData(r.getBodyMetaData()),n){const e=new k.DT1;e.point=new Float32Array(3);for(let t=0;t<3;++t)e.point[t]=n[t];this.entityMetaData.geometries=[e]}else if(1===r.geometries.length&&r.geometries[0]instanceof k.DT1){const e=r.geometries[0];n=C.clone(e.point),this.entityMetaData.geometries=r.geometries}this.setStyle(ad.getPointFont("POINT_BODY_FONT")),n&&this.show()}static getEdgePointLocation(e,t,i){let s=null;const n=t.getEntityMetaData();let r=null;if(e.getIsForPreviousVersionDisplay()?r=e.getModelViewManagers().getManager().extractMeshIncrement(t.getDeterministicId()):n&&(r=n.getMeshIncrement()),!r&&n.isFromSketch()&&(r=e.getModelViewManagers().getManager().extractMeshIncrement(t.getDeterministicId())),r){s=C.create();const a=r.getLinesLength(),o=r.getPositionAtDistanceAlongLines(a*i),h=e.getModelViewManagers().getManager().getDisplayedPartStudio();if(h){let i;i=n.isFromSketch()?h.getSketchComponent().getTransformForSketchEntity(t.getDeterministicId()):h.getBodyTransform(t.getBodyId(),e),ge.w$.multiplyVec3(i,o,s)}}return s}getModelSelection(e){return new Ce.Y1(k.lQt.EDGE_POINT,this.selectionId,null,{sourcePick:e.sourcePick,entityMetaData:this.entityMetaData})}getClearModelSelectionsOnPrehilite(){return!1}addHighlight(e){this.addHighlightToIncrement(Zl.INCREMENT_ID,e),(0,Fs.vm)()}removeHighlight(e){return this.removeHighlightFromIncrement(Zl.INCREMENT_ID,e),(0,Fs.vm)(),!0}}class cd extends m.T{constructor(e){super(),this.viewer=e,this.cullableBodies=[],this.microversionIdAndConfiguration=null,(0,Jo.Yk)(e)}getViewer(){return this.viewer}getMicroversionIdAndConfiguration(){return this.microversionIdAndConfiguration}getUIElementsForSelection(e){return[]}getEntityIdsForSelection(e){return[]}getOccurrenceEntityIdsForHighlight(e){return[]}getInContextImportEntityIdsForSelection(e){return[]}getOccurrencesForSelection(e){return[]}callOnChildSelections(e,t){let i=[];if(t.childSelections)for(let s=0;s<t.childSelections.length;s++)i=i.concat(e.call(this,t.childSelections[s]));return i}getBoundsOutsideElementNode(){return null}getBodyBounds(e,t){return null}getBodyComponent(e){return null}populateClientCacheStateDisplayInformation(e){}checkDuplicatedMicroversionIdAndConfiguration(e,t){return!e.find((function(e){return e.equals(t)}))}getElementType(){return k.GNh.UNKNOWN}}var ld=i(9228),ud=i(14115);const dd=X.default.getManager();class gd{constructor(){this.boundingSphere=null,this.lod=null,this.cullingState=null}}class pd extends cd{constructor(e,t,i){super(i),this.elementId=e,this.elementAccessor=t,this.occurrences={},this.occurrencePrefixToLeaves={},this.mateConnectorData={},this.mateConnectorGraphics={},this.mateIndicatorData=new Map,this.mateIndicatorGraphics={},this.occurrenceMateIndicators={},this.originDisplayData=null,this.originGraphics=null,this.isHidden_=!0,this.isForInContext=!1,this.cachedOccurrenceState={},this.fullElementIdToOccurrence=new gl.TemplatedNestedMap,this.ownerToInstanceMateIndicatorIds=new Map,this.mateIndicatorOwnerInstanceIds=new Map,this.mateConnectorMateIndicatorIds=new Map,this.mateIndicatorMateConnectorIds=new Map,this.occurrenceMateConnectors=new gl.TemplatedNestedMap,this.ensureRootOccurrenceDisplayData(),Bl(i),this.loadDisplayManager=new yg(i)}onDeletion(){this.reset(),this.loadDisplayManager.remove()}getUsedPartStudioIds(e){e.addAll(this.fullElementIdToOccurrence.getKeys())}populateClientCacheStateDisplayInformation(e){if(this.microversionIdAndConfiguration){const t=e.getOrCreateElementDataList(this.elementId,k.D3B.DISPLAY_DATA);this.checkDuplicatedMicroversionIdAndConfiguration(t,this.microversionIdAndConfiguration)?t.push(this.microversionIdAndConfiguration):ut.log.warn("Found duplicated assembly microversion id and configuration "+this.microversionIdAndConfiguration)}}getIdOccurrenceNodeId(e,t){return(0,ln.vm)(e,t)}getMateConnectorGraphicsForSelection(e){let t=[];if(e.isMateConnector()){const i=this.getMateConnectorGraphics(e.getOccurrence(),e.getIdString());i&&t.push(i)}else if(e.childSelections)for(let i=0;i<e.childSelections.length;i++){const s=e.childSelections[i];s.isMateConnector()&&(t=t.concat(this.getMateConnectorGraphicsForSelection(s)))}return t}getMateIndicatorGraphics(e,t){let i=this.mateIndicatorGraphics[e];if(!i){const s=this.mateIndicatorData.get(e);s&&(i=this.updateMateIndicatorGraphicsAndOccurrences(s,t))}return i}getMateIndicatorForSelection(e){const t=[];if(e.isMate()){const i=!0,s=this.getIdOccurrenceNodeId(e.getOccurrence(),e.getIdString()),n=this.getMateIndicatorGraphics(s,i);n&&t.push(n)}return t}getEntitiesForNonInstanceSelection(e){let t=[];const i=function(e,i){for(let s=0;s<i.length;++s)if(i[s]===k.AuL.ORIGIN_ID&&e.isRoot()){const i=(0,ud.Az)(e);t.push(i)}else t.push(new Ce.Y1(k.lQt.ENTITY,i[s],e))};if(e.isMateConnector()){const t=this.getIdOccurrenceNodeId(e.getOccurrence(),e.getIdString()),s=this.mateConnectorData[t];s&&i(s.occurrence,s.entityIds)}else if(e.isSimulationLoad()){const t=this.loadDisplayManager.getDisplayDataForSelection(e);t&&i(t.occurrence,t.faceLoadDeterministicIds)}else if(e.isGeometryMate()){const t=this.getIdOccurrenceNodeId(e.getOccurrence(),e.getFeatureId()),s=(0,j.as)(k.z1E,this.mateIndicatorData.get(t));s&&(s.firstDeterministicId&&i(s.firstOccurrence,[s.firstDeterministicId]),s.secondDeterministicId&&i(s.secondOccurrence,[s.secondDeterministicId]))}else e.isMate()?t=this.callOnChildSelections(this.getEntitiesForNonInstanceSelection,e):e.isEntity()&&t.push(e);return t}getMateConnectorGraphics(e,t,i){const s=this.getIdOccurrenceNodeId(e,t),n=this.mateConnectorData[s];let r=null;if(n){if(r=this.mateConnectorGraphics[s],!r){const e=this.occurrences[n.occurrence.getPathAsString()];e&&(r=this.updateMateConnectorOccurrence(n,e,!i))}}else this.fullElementIdToOccurrence.each(((i,s)=>{const n=this.elementAccessor.getPartStudio(s);if(n&&(r=n.getMateConnectorGraphics(e,t),r))return!0}),this);return r}getMateConnectorData(e,t){const i=this.getIdOccurrenceNodeId(e,t);let s=this.mateConnectorData[i];return s||this.fullElementIdToOccurrence.each(((i,n)=>{const r=this.elementAccessor.getPartStudio(n);if(r&&(s=r.getMateConnectorData(e,t),s))return!0}),this),s}getUIElementsForSelection(e){let t=[];if(e.isMateConnector())t=this.getMateConnectorGraphicsForSelection(e);else if(e.isSimulationLoad())t=this.loadDisplayManager.getUiElementsForSelection(e);else if(e.isMate())t=this.getMateIndicatorForSelection(e),0===t.length&&(t=this.callOnChildSelections(this.getUIElementsForSelection,e));else if(e.isMateRelation())t=this.callOnChildSelections(this.getUIElementsForSelection,e);else if(e.isFeature()&&e.getIdString()===k.AuL.ORIGIN_ID&&this.originGraphics&&t.push(this.originGraphics),e.getOccurrence()&&(e.isFromSketch()||e.isFromBody()||e.isOccurrence()||e.isAssemblyOrigin())){const i=ld.m.getCommandToolbarModel(),s=!!i&&i.inShowMatesOnSelectionMode;Ki.Jq.ExplodedViewsService.inExplodedViewMode()||!s&&1!==dd.getNumber("OCCURRENCE_MATE_HIGHLIGHT")&&!Ki.Jq.NamedPositionPaneService.getIsInNamedPositionEditMode()||t.push.apply(t,this.getMateIndicatorsForOccurrence(e.getOccurrence()))}return t}getEntityIdsForSelection(e){let t=[];const i=e.getOccurrence();if(i){const s=this.occurrences[i.getPathAsString()];if(s){const i=this.elementAccessor.getPartStudio(s.fullElementId);i&&(t=i.getEntityIdsForSelection(e))}}return t}getOccurrenceEntityIdsForHighlight(e){let t=[];if(e){const i=this.occurrences[e.getPathAsString()];if(i){const s=this.elementAccessor.getPartStudio(i.fullElementId);s&&(t=t.concat(s.getOccurrenceEntityIdsForHighlight(e)))}}return t}getOccurrencesForSelection(e){let t=[];if(e.isMateConnector()){const i=this.getMateConnectorGraphicsForSelection(e);for(let e=0;e<i.length;++e)t.push(i[e].getOccurrence())}else if(e.isSimulationLoad()){const i=this.loadDisplayManager.getDisplayDataForSelection(e);i&&0===i.faceLoadDeterministicIds.length&&t.push(i.occurrence)}else e.isMate()||e.isMateRelation()||e.isNonGeometricItem()||e.isExplodeStep()||e.isFolder()?t=this.callOnChildSelections(this.getOccurrencesForSelection,e):e.getOccurrence()&&!e.isFeature()&&t.push(e.getOccurrence());return t}getDisplayDataForOccurrencePath(e){return this.occurrences[e]||null}hide(){if(this.isHidden_)return;const e=new Qo.B7("bt.graphics.assembly.Assembly.prototype.hide");for(const e in this.mateConnectorGraphics)this.mateConnectorGraphics[e].remove();this.mateConnectorGraphics={},this.removeAllMateIndicators();for(const e in this.occurrences)this.removeOccurrenceFromPartStudio(this.occurrences[e],!1);this.removeOriginGraphics(),this.loadDisplayManager.hide(),this.isHidden_=!0,e.report()}show(e){if(!this.isHidden_)return;const t=new Qo.B7("bt.graphics.assembly.Assembly.prototype.show",iT());this.isHidden_=!1;let i=new Qo.B7("Updating occurrences");for(const e in this.occurrences)this.addOrUpdateOccurrence(this.occurrences[e]);i.report(),i=new Qo.B7("Updating mate indicators");for(const e of this.mateIndicatorData.values())this.updateMateIndicatorGraphicsAndOccurrences(e);i.report(),this.createOriginGraphics(),this.loadDisplayManager.show(),e||this.viewer.setSuppressNonIsolatedPicks(!0),t.report()}get isHidden(){return this.isHidden_}getMateIndicatorData(e){return this.mateIndicatorData.get(e)}createOriginGraphics(){this.removeOriginGraphics(),this.isHidden_||!this.originDisplayData||this.isForInContext||(this.originGraphics=new Sc(this.originDisplayData,this.viewer))}removeOriginGraphics(){this.originGraphics&&(this.originGraphics.remove(),this.originGraphics=null)}reset(){let e;for(e in this.occurrences)this.removeOccurrenceFromPartStudio(this.occurrences[e],!1);this.occurrences={},this.fullElementIdToOccurrence.clear();for(const e in this.mateConnectorGraphics)this.mateConnectorGraphics[e].remove();for(const e in this.mateIndicatorGraphics)this.mateIndicatorGraphics[e].remove();this.mateConnectorGraphics={},this.mateConnectorData={},this.mateIndicatorData=new Map,this.mateIndicatorGraphics={},this.occurrenceMateIndicators={},this.occurrenceMateConnectors.clear(),this.cullableBodies=[],this.occurrencePrefixToLeaves={},this.removeOriginGraphics(),this.originDisplayData=null,this.ownerToInstanceMateIndicatorIds.clear(),this.mateIndicatorOwnerInstanceIds.clear(),this.mateConnectorMateIndicatorIds.clear(),this.mateIndicatorMateConnectorIds.clear(),this.ensureRootOccurrenceDisplayData(),this.loadDisplayManager.reset()}processSingleOccurrenceDeletion(e,t,i){if(e){let s=e;i&&e.fullElementId.equals(i.buildFullElementId(!0))&&(s=(0,j.shallowClone)(e),s.fullElementId=i.buildFullElementId(!1)),this.removeOccurrenceFromPartStudio(s,!0),this.removeOccurrenceElementAssociation(e),delete this.occurrences[t]}}processOccurrenceDeletions(e,t){let i;for(i=0;i<e.deletedOccurrences.length;++i)this.removeOccurrence(e.deletedOccurrences[i],t);if(!e.incremental){const e=Object.keys(this.occurrences);for(i=0;i<e.length;i++){const s=e[i],n=this.occurrences[s];this.processSingleOccurrenceDeletion(n,s,t)}}for(i=0;i<e.occurrences.length;++i){const s=e.occurrences[i];if(!s||!s.occurrenceData)continue;const n=s.occurrenceData.occurrence.toString(),r=this.occurrences[n];if(r){const i=e.getPartStudioDisplayDataForMicroversion(s.fullElementId),a=!t||e.partStudioDisplayData.length>0,o=i?i.buildFromFullElementId():s.fullElementId,h=!!i&&i.keepFromMicroversion,c=!r.fullElementId.equals(o)||h,l=r.sketchFeatureId!==s.sketchFeatureId||r.partIds.some((function(e){return s.partIds.indexOf(e)<0}));(c||l)&&a?this.processSingleOccurrenceDeletion(r,n,t):this.removeOccurrenceElementAssociation(r)}}}processDisplayData(e){const t=new Qo.B7("Assembly.prototype.processDisplayData",iT());if(this.elementId!==e.elementId)return void ut.log.warn("Tried to update a graphics assembly with data corresponding to the wrong element id");let i,s;for(e.incremental||this.reset(),this.isForInContext=e.isForInContext,i=0;i<e.occurrences.length;++i)if(e.occurrences[i]){const t=e.occurrences[i],s=!0;this.addOrUpdateOccurrence(t,s)}for(i=0;i<e.mateConnectors.length;++i)if(e.mateConnectors[i]){const t=e.mateConnectors[i];this.updateMateConnector(t)}for(i=0;i<e.occurrences.length;++i)if(e.occurrences[i]){const t=e.occurrences[i];this.updateMateIndicators(t)}for(e.originDisplayData?this.originDisplayData=e.originDisplayData:e.incremental||ut.log.warn("Null originDisplayData in non-incremental BTRootAssemblyDisplayData"),this.createOriginGraphics(),i=0;i<e.mates.length;++i){const t=e.mates[i];t&&this.updateMateIndicator(t)}for(i=0;i<e.assemblyFeatures.length;++i){const t=e.assemblyFeatures[i];t&&this.updateMateIndicator(t)}for(i=0;i<e.deletedMateIds.length;++i)s=e.deletedMateIds[i],this.removeMateWithId(s);for(i=0;i<e.deletedMateConnectorIds.length;++i)s=e.deletedMateConnectorIds[i],this.removeMateConnectorWithId(s);for(i=0;i<e.mateGroups.length;++i){const t=e.mateGroups[i];t&&this.updateMateIndicator(t)}for(i=0;i<e.deletedMateGroupIds.length;++i)s=e.deletedMateGroupIds[i],this.removeMateWithId(s);for(i=0;i<e.geometryMates.length;++i){const t=e.geometryMates[i];t&&this.updateMateIndicator(t)}for(i=0;i<e.deletedGeometryMateIds.length;++i)s=e.deletedGeometryMateIds[i],this.removeMateWithId(s);for(i=0;i<e.deletedAssemblyFeatures.length;++i)s=e.deletedAssemblyFeatures[i],this.removeMateWithId(s);this.loadDisplayManager.processUpdates(e,!this.isHidden_),t.report()}ensureRootOccurrenceDisplayData(){const e=k.yLM.createRootOccurrenceDisplayData(this.elementId);this.addOrUpdateOccurrence(e)}addOrUpdateOccurrence(e,t){const i=e.getOccurrenceId(),s=this.occurrences[i];if(this.addOccurrenceElementAssociation(e),!this.isHidden){const t=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(i);this.viewer.getOccurrenceDataManager().setOccurrenceTransform(t,e.occurrenceData.transform.getGlMatrix());const n=this.elementAccessor.getPartStudio(e.fullElementId);n&&n.addOrUpdateOccurrence(t,e,!0),this.updateMateConnectorsForOccurrence(e),s&&s.isHidden===e.isHidden||this.trigger("OCCURRENCE_VISIBILITY_CHANGE."+i,e.isHidden?Fs.EE.HIDDEN:Fs.EE.VISIBLE)}this.addOccurrenceToPrefixMap(e.occurrenceData.occurrence),this.occurrences[i]=e,t||this.updateMateIndicators(e),this.trigger("OCCURRENCE_DATA_CHANGE."+i)}updateMateIndicators(e){const t=e.occurrenceData.occurrence.getPathAsString();this.updateOccurrenceMateIndicator(t)}updateUniqueMateIndicators(e){if(0===e.length)return;const t=[];e.forEach((e=>{const i=e.occurrenceData.occurrence.getPathAsString(),s=this.occurrenceMateIndicators[i];if(s)for(const e in s){if(t.includes(e))continue;t.push(e);const i=s[e].getDefinition();i&&this.updateMateIndicator(i)}}),this)}updateOccurrenceTransform(e,t){const i=[];i.push({pathId:e,transform:t}),this.batchUpdateOccurrenceTransforms(i)}batchUpdateOccurrenceTransforms(e){if(0===e.length)return!0;const t=[];if(!e.every((e=>{if(!this.occurrences)return ut.log.warn("No occurrences property for this path transform pair."),!1;const i=this.occurrences[e.pathId],s=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(e.pathId);if(!i||s===Jf.Qy)return ut.log.warn('bad occurrence display data for pathId "'+e.pathId+'", graphics ID "'+s+'".'),!1;if(!this.isHidden_){const n=i.occurrenceData.transform.getGlMatrix();t.push({displayData:i,transform:n}),i.occurrenceData&&i.occurrenceData.transform&&i.occurrenceData.transform.updateFromGlMatrix(e.transform),e.transform&&this.viewer.getOccurrenceDataManager().setOccurrenceTransform(s,e.transform);const r=this.elementAccessor.getPartStudio(i.fullElementId);if(r){const e=!0;r.addOrUpdateOccurrence(s,i,e)}}return!0}),this))return!1;const i=t.map((function(e){return e.displayData}));return this.updateUniqueMateIndicators(i),i.forEach(pd.prototype.updateMateConnectorsForOccurrence,this),t.forEach((function(e){e.displayData.occurrenceData.transform.updateFromGlMatrix(e.transform)})),!0}getOccurrenceDisplayData(e){return e&&this.occurrences[e.getPathAsString()]||null}addOccurrenceElementAssociation(e){this.fullElementIdToOccurrence.insertNested(e.fullElementId.toString(),e.getOccurrenceId(),!0)}removeOccurrenceElementAssociation(e){this.fullElementIdToOccurrence.removeNested(e.fullElementId.toString(),e.getOccurrenceId())}removeOccurrence(e,t){const i=e.getPathAsString(),s=this.occurrences[i];s&&(this.processSingleOccurrenceDeletion(s,i,t),this.removeMateConnectorsForOccurrence(s),this.removeOccurrenceFromPrefixMap(s.occurrenceData.occurrence),this.updateOccurrenceMateIndicator(i)),this.trigger("OCCURRENCE_DELETED."+i)}removeOccurrenceFromPartStudio(e,t){if(!e||this.isHidden_)return;const i=this.elementAccessor.getPartStudio(e.fullElementId),s=e.getOccurrenceId(),n=this.viewer.getOccurrenceIdManager().getIdForName(s);i&&n!==Jf.Qy&&i.removeOccurrence(n,t),this.viewer.getOccurrenceDataManager().destroyOccurrenceData(n),this.viewer.getOccurrenceIdManager().removeName(s)}getOccurrenceData(e){const t=this.occurrences[e];return t||null}getMateConnectorsForOccurrence(e){const t=[],i=this.occurrenceMateConnectors.get(e.getPathAsString());return i&&i.each((function(e,i){return t.push(e),!1}),this),t}getMateConnectorGraphicsForOccurrence(e,t){let i=[];const s=this.getMateConnectorsForOccurrence(e),n=this;for(let e=0;e<s.length;++e){const n=this.getMateConnectorGraphics(s[e].ownerOccurrence,s[e].nodeId,t);n&&(i=i.concat(n))}return this.fullElementIdToOccurrence.each((function(t,s){const r=n.elementAccessor.getPartStudio(s);return r&&function(t){i=i.concat(t.getAllMateConnectorGraphics(e))}(r),!1})),i}getMateConnectorIdsForOccurrence(e,t){const i=[];return Object.entries(this.mateConnectorData).forEach((function([s,n]){!(0,ln.wB)(e,n.ownerOccurrence)||t&&n.implicit||i.push({Id:n.nodeId,isPartStudio:!1})})),i}getHideableSketchOccurrences(){const e=[];for(const t in this.occurrences){const i=this.occurrences[t];!i.isHidden&&i.displayedSketchEntityIds&&e.push(i.occurrenceData.occurrence)}return e}getSketchImagesForOccurrence(e){const t=this.getDisplayDataForOccurrence(e);if(!t)return[];const i=this.elementAccessor.getPartStudio(t.fullElementId);if(!i)return[];const s=this.viewer.getOccurrenceIdManager().getIdForName(e.getPathAsString());return i.getImageComponent().getDisplaysForOccurrence(s)}getInstanceMateIndicatorIdsFromOwner(e,t){const i=this.ownerToInstanceMateIndicatorIds.get(e);return i?i.get(t):void 0}getMateIndicatorsForOccurrence(e,t){const i=[],s=e.getTailNodeId();let n=e.getOccurrenceWithoutTail();!n.isRoot()&&k.s5W.isOutputInstanceNodeId(s)&&(n=n.getOccurrenceWithoutTail());const r=this.getInstanceMateIndicatorIdsFromOwner(n.getPathAsString(),s);for(const e of new Set(r)){const s=this.getMateIndicatorGraphics(e,!t);s&&i.push(s)}return i}hasMateIndicatorForOccurrence(e){let t=e.getOccurrenceWithoutTail();const i=e.getTailNodeId();!t.isRoot()&&k.s5W.isOutputInstanceNodeId(i)&&(t=t.getOccurrenceWithoutTail());const s=this.ownerToInstanceMateIndicatorIds.get(t.getPathAsString());if(s){const e=s.get(i);return!!e&&e.size>0}return!1}updateMateConnector(e){const t=this.getIdOccurrenceNodeId(e.ownerOccurrence,e.nodeId),i=this.mateConnectorData[t];i&&((0,ln.wB)(i.occurrence,e.occurrence)||this.removeMateConnectorWithId(t)),this.mateConnectorData[t]=e;const s=e.occurrence.getPathAsString();this.occurrenceMateConnectors.insertNested(s,e.nodeId,e);const n=this.occurrences[s];this.updateMateConnectorOccurrence(e,n),this.updateMateConnectorMateIndicator(t)}updateMateConnectorMateIndicator(e){const t=this.mateConnectorMateIndicatorIds.get(e);if(t)for(const e of new Set(t).values()){const t=this.mateIndicatorData.get(e);t&&this.updateMateIndicator(t)}}updateOccurrenceMateIndicator(e){const t=this.occurrenceMateIndicators[e];if(t)for(const e in t)if(t[e]){const i=t[e].getDefinition();this.updateMateIndicator(i)}}shouldMateIndicatorBeRecreated(e){const t=this.getIdOccurrenceNodeId(e.ownerOccurrence,e.nodeId),i=this.mateIndicatorData.get(t);if(i&&e&&i.status===e.status&&i.getClassId()===e.getClassId()&&i.hidden===e.hidden&&(0,Hs.Z)(i.getMateConnectorIds(),e.getMateConnectorIds())&&(0,Hs.Z)(i.getOccurrenceIds(),e.getOccurrenceIds())){if(e instanceof k.Zdq&&i instanceof k.Zdq&&i.mateType!==e.mateType)return!0;const s=this.mateIndicatorGraphics[t];return!(!s||0!==s.mateIndicatorComponents.length)}return!0}updateMateIndicator(e){const t=this.getIdOccurrenceNodeId(e.ownerOccurrence,e.nodeId);this.shouldMateIndicatorBeRecreated(e)&&this.removeMateWithId(t),this.mateIndicatorData.set(t,e),this.updateMateIndicatorGraphicsAndOccurrences(e)}separateOccurrenceAndFeatureId(e){const t=new k._oC;let i=!1,s="";const n=e.split(k._oC.OCCURRENCE_PATH_SEPARATOR);if(n.length>0)do{s=s?n.pop()+k._oC.OCCURRENCE_PATH_SEPARATOR+s:n.pop(),t.path=n,i=this.occurrences.hasOwnProperty(t.getPathAsString())}while(!i&&n.length>0);return i?{occurrence:t,featureId:s}:null}updateMateIndicatorGraphicsAndOccurrences(e,t){if(this.isHidden_)return null;const i=this.getIdOccurrenceNodeId(e.ownerOccurrence,e.nodeId),s=!!!this.mateIndicatorGraphics[i]&&!t&&e.hidden;let n=null,r=null;const a=[];let o=null;if(e instanceof k.Zdq){const t=[],h=e.mateConnectorIds.length;o=e.mateConnectorIds;for(let i=0;i<h;++i){const s=this.separateOccurrenceAndFeatureId(e.mateConnectorIds[i]);if(!s)continue;const n=this.getMateConnectorData(s.occurrence,s.featureId);n&&(t.push(n),a.push(n.occurrence.getPathAsString()))}if(r=this.mateIndicatorGraphics[i],r){const e=r.getDefinitionOccurrenceIds(),s=(0,Hs.Z)(e,a);if(r.updateMateConnectorDisplayData(t),s)return r;this.removeOccurrenceMateIndicatorMapping(i,e),n=r}else s||(n=Gg(t,e,this.viewer))}else if(e instanceof k.IuU){const t=[],o=e.occurrenceIds.length,h=[];for(let i=0;i<o;++i){a.push(e.occurrenceIds[i]);const s=this.occurrences[e.occurrenceIds[i]];s&&(t.push(s),h.push(e.occurrenceIds[i]))}if(r=this.mateIndicatorGraphics[i],r){const e=r.getDefinitionOccurrenceIds(),s=(0,Hs.Z)(e,a);if(r.updateOccurenceDisplayData(t),s)return r;this.removeOccurrenceMateIndicatorMapping(i,e),n=r}else s||(n=new xg(t,e,this.viewer))}else if(e instanceof k.z1E)if(r=this.mateIndicatorGraphics[i],a.push(e.firstOccurrence.getPathAsString()),a.push(e.secondOccurrence.getPathAsString()),r){const t=r.getDefinitionOccurrenceIds(),s=(0,Hs.Z)(t,a);if(r.updateMateIndicatorDefinition(e),s)return r;this.removeOccurrenceMateIndicatorMapping(i,t),n=r}else s||(n=new Bg(e,this.viewer));else if(e instanceof k.ZQK){const t=[];o=e.mateConnectorIds;for(let i=0;i<e.mateConnectorIds.length;++i){const s=this.separateOccurrenceAndFeatureId(e.mateConnectorIds[i]);if(!s)continue;const n=this.getMateConnectorData(s.occurrence,s.featureId);n&&(t.push(n),a.push(n.occurrence.getPathAsString()))}if(r=this.mateIndicatorGraphics[i],r){const t=r.getDefinitionOccurrenceIds(),s=(0,Hs.Z)(t,a);if(r.updateMateIndicatorDefinition(e),s)return r;this.removeOccurrenceMateIndicatorMapping(i,t),n=r}else s||(n=new Ug(t,e,this.viewer))}if(0===a.length)this.removeMateGraphicsWithId(i);else if(n){this.mateIndicatorGraphics[i]=n;const e=n.getDefinitionOccurrenceIds();for(let t=0;t<e.length;++t)this.addOccurrenceMateIndicator(e[t],i,n)}this.removeMappingsForMateIndicator(i);for(let t=0;t<a.length;++t){let s=e.ownerOccurrence;e.isDerivedFeature&&(s=s.getOccurrenceWithoutTail()),this.addOwnerOccurrenceMateIndicatorMapping(a[t],i,s)}if(o)for(let e=0;e<o.length;++e)this.addMateConnectorMateIndicatorMapping(o[e],i);return n}addOwnerOccurrenceMateIndicatorMapping(e,t,i){const s=e.split(k._oC.OCCURRENCE_PATH_SEPARATOR).slice(i.path.length);let n="";s.length>0&&(n=s.length>1&&k.s5W.isOutputInstanceNodeId(s[1])?s[1]:s[0]);const r=i.getPathAsString();let a=this.ownerToInstanceMateIndicatorIds.get(r);a||(a=new Map,this.ownerToInstanceMateIndicatorIds.set(r,a));let o=a.get(n);o||(o=new Set,a.set(n,o)),o.add(t);let h=this.mateIndicatorOwnerInstanceIds.get(t);h||(h=[],this.mateIndicatorOwnerInstanceIds.set(t,h)),h.push({owner:r,instance:n})}addMateConnectorMateIndicatorMapping(e,t){let i=this.mateConnectorMateIndicatorIds.get(e);i||(i=new Set,this.mateConnectorMateIndicatorIds.set(e,i)),i.add(t);let s=this.mateIndicatorMateConnectorIds.get(t);s||(s=new Set,this.mateIndicatorMateConnectorIds.set(t,s)),s.add(e)}removeMappingsForMateIndicator(e){const t=this.mateIndicatorOwnerInstanceIds.get(e);t&&t.forEach((t=>{const i=this.ownerToInstanceMateIndicatorIds.get(t.owner);if(i){const s=i.get(t.instance);s&&(s.delete(e),0===s.size&&i.delete(t.instance)),0===i.size&&this.ownerToInstanceMateIndicatorIds.delete(t.owner)}})),this.mateIndicatorOwnerInstanceIds.delete(e);const i=this.mateIndicatorMateConnectorIds.get(e);i&&i.forEach((t=>{const i=this.mateConnectorMateIndicatorIds.get(t);i&&(i.delete(e),0===i.size&&this.mateConnectorMateIndicatorIds.delete(t))})),this.mateIndicatorMateConnectorIds.delete(e)}updateMateConnectorsForOccurrence(e){const t=this.getMateConnectorsForOccurrence(e.occurrenceData.occurrence);for(let i=0;i<t.length;++i)this.updateMateConnectorOccurrence(t[i],e)}removeMateConnectorWithId(e){const t=this.mateConnectorData[e];t&&(delete this.mateConnectorData[e],this.occurrenceMateConnectors.removeNested(t.occurrence.getPathAsString(),t.nodeId),this.removeMateConnectorOccurrenceFromIds(t.nodeId,t.ownerOccurrence),this.updateMateConnectorMateIndicator(e),this.loadDisplayManager.processDeletedMateConnector(e))}removeOccurrenceMateIndicatorMapping(e,t){const i=this.mateIndicatorGraphics[e];if(i){t=t||i.getDefinitionOccurrenceIds();for(let i=0;i<t.length;++i)this.removeOccurrenceMateIndicator(t[i],e)}}removeMateGraphicsWithId(e){const t=this.mateIndicatorGraphics[e];t&&(this.removeOccurrenceMateIndicatorMapping(e),t.remove(),delete this.mateIndicatorGraphics[e])}removeMateWithId(e){this.removeMateGraphicsWithId(e),this.removeMappingsForMateIndicator(e),this.mateIndicatorData.delete(e)}removeMateConnectorsForOccurrence(e){const t=this.getMateConnectorsForOccurrence(e.occurrenceData.occurrence);for(let e=0;e<t.length;++e)this.removeMateConnectorOccurrenceFromIds(t[e].nodeId,t[e].ownerOccurrence)}updateMateConnectorOccurrence(e,t,i){if(this.isHidden_)return null;const s=this.getIdOccurrenceNodeId(e.ownerOccurrence,e.nodeId);let n=this.mateConnectorGraphics[s];return n||i||!(t&&t.isHidden||e.hidden)?(n?n.updateDefinition(e):this.mateConnectorGraphics[s]=n=new hl(e,Zo.lL,this.viewer),t?(n.setOccurrenceTransform(t.occurrenceData.transform.getGlMatrix()),n.updateOccurrenceVisibility(t.isHidden?Fs.EE.HIDDEN:Fs.EE.VISIBLE),n.setIsParentOccurrenceDataMissing(!1)):n.setIsParentOccurrenceDataMissing(!0),n):null}removeMateConnectorOccurrenceFromIds(e,t){const i=this.getIdOccurrenceNodeId(t,e),s=this.mateConnectorGraphics[i];s&&(s.remove(),delete this.mateConnectorGraphics[i])}removeAllMateIndicators(){for(const e in this.mateIndicatorGraphics)this.mateIndicatorGraphics[e].remove();this.occurrenceMateIndicators={},this.mateIndicatorGraphics={}}addOccurrenceMateIndicator(e,t,i){e in this.occurrenceMateIndicators||(this.occurrenceMateIndicators[e]={}),this.occurrenceMateIndicators[e][t]=i;const s=this.viewer.getIsolatedOccurrenceManager().getIsolatedOccurrences();if(s&&s.length>0)for(let t=0;t<s.length;t++)s[t].getPathAsString()===e&&i.getOccurrenceData().setIsolated(!0)}removeOccurrenceMateIndicator(e,t){e in this.occurrenceMateIndicators&&this.occurrenceMateIndicators[e][t]&&delete this.occurrenceMateIndicators[e][t]}getDisplayDataForOccurrence(e){return e&&this.occurrences[e.getPathAsString()]||null}getOccurrenceVisibility(e){const t=this.getDisplayDataForOccurrence(e);return!t||t.isHidden?Fs.EE.HIDDEN:Fs.EE.VISIBLE}addOrRemoveOccurrenceInPrefixMap(e,t){const i=e.getPathAsString();for(let s=0;s<e.path.length;s++){const n=e.path.slice(0,s+1).join(".");this.occurrencePrefixToLeaves[n]||(this.occurrencePrefixToLeaves[n]=new gt.StringSet),t?this.occurrencePrefixToLeaves[n].add(i):this.occurrencePrefixToLeaves[n].remove(i)}}addOccurrenceToPrefixMap(e){this.addOrRemoveOccurrenceInPrefixMap(e,!0)}removeOccurrenceFromPrefixMap(e){this.addOrRemoveOccurrenceInPrefixMap(e,!1)}getLeafOccurrencesContainedWithinOccurrence(e){const t=[];if(e)if(e.isAssemblyRoot())(0,ot.Z)(this.occurrences,(e=>t.push(e.occurrenceData.occurrence)));else{const i=this.occurrencePrefixToLeaves[e.getPathAsString()];i&&i.each((e=>{const i=this.occurrences[e];i&&i.occurrenceData&&t.push(i.occurrenceData.occurrence)}))}return t}getOccurrenceBounds(e){const t=this.getLeafOccurrencesContainedWithinOccurrence(e);let i=null;return t.forEach((e=>{const t=this.viewer.getOccurrenceIdManager().getIdForName(e.getPathAsString()),s=this.getOccurrenceDisplayData(e);if(s&&t!==Jf.Qy){const e=this.elementAccessor.getPartStudio(s.fullElementId);if(e){const s=e.getOccurrenceBounds(t);s&&s.isFinite()&&(i||(i=new yi.kB),i.addBox(s))}}})),i}getBodyComponent(e){const t=this.getOccurrenceDisplayData(e);if(t){const e=this.elementAccessor.getPartStudio(t.fullElementId);if(e)return e.bodyComponent}return null}getBodyBounds(e,t){const i=this.getOccurrenceDisplayData(t);if(i){const s=this.elementAccessor.getPartStudio(i.fullElementId);if(s){const n=s.getBodyBounds(e,t);if(n)return n.createTransformedCopy(i.occurrenceData.transform.getGlMatrix())}}return null}getCachedOccurrenceState(e){let t=this.cachedOccurrenceState[e];return t||(this.cachedOccurrenceState[e]=t=new gd),t}clearCachedOccurrenceState(){this.cachedOccurrenceState={}}getBoundsOutsideElementNode(){const e=new yi.kB;if(this.originGraphics&&e.addBox(this.originGraphics.getBounds()),this.mateConnectorGraphics)for(const t in this.mateConnectorGraphics)this.mateConnectorGraphics[t].isHidden||e.addPoint(this.mateConnectorGraphics[t].worldSpacePosition);return this.fullElementIdToOccurrence.each(((t,i)=>{const s=this.elementAccessor.getPartStudio(i);return null!==s&&e.addBox(s.mateConnectorComponent.getVisibleMateConnectorBounds()),!1}),this),e.isInitialized()&&e.isFinite()?e:null}getMateIndicatorConnectivityMap(e){const t=new gl.TemplatedNestedMap;for(const i of this.mateIndicatorData.values()){if(i.status===k.EFx.SUPPRESSED)continue;const s=i.getOccurrences(this);for(const i of s){const n=i.trimToTopLevel().getPathAsString(),r=i.getPathAsString();if(e.has(r))for(const e of s){const i=e.getPathAsString();n!==i&&t.insertNested(r,i,e)}}}return t}getElementType(){return k.GNh.ASSEMBLY}setExplodeViewActive(e){this.loadDisplayManager.setExplodeViewActive(e)}setEditState(e,t){this.loadDisplayManager.setEditState(e,t)}getOccurrences(){return this.occurrences}setAreOccurrencesClippedBySectionPlaneExcept(e,t){for(const t in this.occurrences){const i=this.viewer.getOccurrenceIdManager().getIdForName(t),s=this.viewer.getOccurrenceDataManager().getOccurrenceData(i);s&&s.setIsClippedBySectionPlanes(e)}for(const i of t)this.setAllLeafOccurrencesClippedForOccurrence(k._oC.getOccurrenceFromPathString(i),!e)}setAllLeafOccurrencesClippedForOccurrence(e,t){const i=this.getLeafOccurrencesContainedWithinOccurrence(e);if(i){for(const e of i){if(!this.occurrences[e.getPathAsString()]){ut.log.debug("Did not find occurrence data for leaf occurrence "+e.getPathAsString()+" in assembly "+this.elementId);continue}const i=this.viewer.getIdForOccurrence(e),s=this.viewer.getOccurrenceDataManager().getOccurrenceData(i);s&&s.setIsClippedBySectionPlanes(t)}const e=this.viewer.getModelViewManagers().getManager().getSimulationManager();e&&e.onSectionSetChanged()}}enterMateHideMode(e){const t=new Set;e.forEach((e=>{const i=new k._oC;i.path=e.path;const s=this.getIdOccurrenceNodeId(i,e.featureId);t.add(s)}));for(const e in this.mateIndicatorGraphics){this.mateIndicatorGraphics[e].updateHiddenMode(!t.has(e))}}exitMateHideMode(){for(const e in this.mateIndicatorGraphics){this.mateIndicatorGraphics[e].updateHiddenMode(!1)}}}const md="commentindicator",fd=X.default.getManager(),Id=20,Ed=20,Sd="n",Td="h";function Dd(e){const t=new Il;t.id=Sd,t.backgroundColor=fd.getString("COMMENT_INDICATOR_BACKGROUND_COLOR"),t.imageName="comment-indicator.png";const i=new Il;return i.id=Td,i.backgroundColor=fd.getString("COMMENT_INDICATOR_HOVER_BACKGROUND_COLOR"),i.imageName="comment-indicator.png",Ml(e,Math.max(Id,Ed),[t,i],{sourcesHaveTransparency:!0})}function Md(e){if(e.getResources().commentIndicatorAtlasCreationInitiated)return;e.getResources().commentIndicatorAtlasCreationInitiated=!0;e.getTextureAtlasFactory().getAtlas("COMMENT_INDICATOR_ATLAS",Dd.bind(void 0,e)).then((t=>{t?(e.getResources().commentIndicatorAtlas=t,e.getResources().commentIndicatorMaterial.ambientTexture=t.texture,(0,Fs.vm)()):ut.log.warn("Could not load texture atlas")}),(e=>ut.log.error(e)))}class Cd extends Ti.u1{constructor(e,t,i){super(i,Zo.EG),this.occurrence=null,this.associatedComments=[],this.worldSpacePosition=null,this.hovered=!1,this.elementBeingListenedTo=null,this.parentHidden=!1,this.allCommentsHidden=!1,this.parentSheetMetalModelId=null,t&&(this.occurrence=k._oC.getOccurrenceFromPathString(t)),(0,ic.isString)(e)?this.entityDeterministicId=e:this.commentCoordinates=e,this.updateWorldPosition(),this.listenTo(this.viewer.getEventDispatcher(),yD.CD,this.updateWorldPosition),this.listenTo(this.viewer.getEventDispatcher(),yD.LA,this.updateWorldPosition),this.listenTo(this.viewer.getEventDispatcher(),yD.hj,this.updateMissingWorldPosition),this.listenTo(i.getEventDispatcher(),yD.Hq,this.onActiveSheetMetalModelChanged),this.listenTo(this,Ti.zw.CLICK+md,this.onClick),this.listenTo(this,Ti.zw.MOUSE_ENTER+md,this.onMouseEnter),this.listenTo(this,Ti.zw.MOUSE_LEAVE+md,this.onMouseLeave)}setCommentCoordinates(e){if(this.entityDeterministicId)throw new Error("A comment should have coordinates or entity id, but not both");this.commentCoordinates=e,this.updateWorldPosition()}addComment(e){this.associatedComments.indexOf(e)<0&&this.associatedComments.push(e);!this.entityDeterministicId&&this.updateElementListener()}removeComment(e){const t=this.associatedComments.indexOf(e);t>=0&&this.associatedComments.splice(t,1),this.entityDeterministicId||this.updateElementListener()}hasComments(){return this.associatedComments.length>0}onDevicePixelRatioChanged(e){this.updateGraphics()}updateGraphics(){if(!this.viewer.getResources().commentIndicatorAtlas)return;const e=this.viewer.getResources().commentIndicatorAtlas.getTextureCoords(this.hovered?Td:Sd);if(!e)return;const t=(0,Ji.x_)(),i=(0,Au.fQ)([0,0,0],[Id*t,0,0],[0,Ed*t,0],void 0,[e.lowS,e.highT],[e.highS,e.lowT]);this.updateMeshIncrement("QUAD",md,i,this.viewer.getResources().commentIndicatorNodeProperties)}updateWorldPosition(){this.worldSpacePosition=null;const e=this.viewer.getModelViewManagers().getManager();if(this.entityDeterministicId){let t=null;if(this.occurrence&&!e.isEntityOnOccurrence(this.entityDeterministicId,this.occurrence)||(t=e.extractMeshIncrement(this.entityDeterministicId,this.occurrence)),!t)return void this.removeMeshIncrements();if(this.worldSpacePosition=this.getStickingPosition(t),this.viewer.getIsForFlattenedDisplay()){const t=e.getFlattenedEntityOwnerBodyDetails(this.entityDeterministicId,this.occurrence);if(!t||!t.transform)return this.worldSpacePosition=null,void this.removeMeshIncrements();ge.w$.multiplyVec3(t.transform,this.worldSpacePosition),this.parentSheetMetalModelId=t.bodyMetaData.sheetMetalModelId,this.updateHideState()}}else this.worldSpacePosition=[this.commentCoordinates.x,this.commentCoordinates.y,this.commentCoordinates.z];if(this.occurrence){const t=e.getOccurrenceTransform(this.occurrence);if(!t)return this.worldSpacePosition=null,void this.removeMeshIncrements();ge.w$.multiplyVec3(t,this.worldSpacePosition)}this.updateElementListener()}updateMissingWorldPosition(){this.worldSpacePosition||this.updateWorldPosition()}stopListeningToElement(){this.elementBeingListenedTo&&(this.stopListening(this.elementBeingListenedTo),this.elementBeingListenedTo=null)}updateElementListener(){if(this.stopListeningToElement(),this.hasBeenRemoved)return;const e=this.viewer.getModelViewManagers().getManager();if(this.occurrence){const t=e.getDisplayedAssembly();if(t){const e=this.occurrence.getPathAsString();this.onParentVisibilityChange(t.getOccurrenceVisibility(this.occurrence)),this.listenTo(t,"OCCURRENCE_VISIBILITY_CHANGE."+e,this.onParentVisibilityChange),this.listenTo(t,"OCCURRENCE_DATA_CHANGE."+e,this.updateWorldPosition),this.listenTo(t,"OCCURRENCE_DELETED."+e,this.updateWorldPosition),this.elementBeingListenedTo=t}}else this.entityDeterministicId?this.addEntityListeners(this.entityDeterministicId):this.addCommentListenersForAssociatedComments()}addCommentListenersForAssociatedComments(){const e=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();if(e)for(const t of this.associatedComments)if(t.deterministicIds)for(const i of t.deterministicIds){if(e.retrieveBodyMetaData(i))this.listenToBodyVisibility(i,e);else{e.retrieveEntityMetaData(i)&&this.addEntityListeners(i)}}}addEntityListeners(e){const t=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio(),i=t?.retrieveEntityMetaData(e);t&&i&&(i.isFromBody()?this.listenToBodyVisibility(i.getBodyId(),t):this.listenToFeatureVisibility(i.getLastFeatureId(),t))}listenToBodyVisibility(e,t){this.onParentVisibilityChange(t.getBodyVisibility(e)),this.listenTo(t,"BODY_VISIBILITY_CHANGE."+e,this.onParentVisibilityChange),this.elementBeingListenedTo=t}listenToFeatureVisibility(e,t){this.onParentVisibilityChange(t.getFeatureVisibility(e)),this.listenTo(t,"FEATURE_VISIBILITY_CHANGE."+e,this.onParentVisibilityChange),this.elementBeingListenedTo=t}onParentVisibilityChange(e){this.parentHidden=e===Fs.EE.HIDDEN,this.updateHideState()}setAllCommentsHidden(e){this.allCommentsHidden=e,this.updateHideState()}updateHideState(){let e=!1;this.parentSheetMetalModelId&&this.parentSheetMetalModelId!==this.viewer.getModelViewManagers().getManager().getSelectedSheetmetalModelId()&&(e=!0),this.allCommentsHidden||this.parentHidden||e?this.hide():this.show()}getStickingPosition(e){return e.getPositionNearCenter()}onViewWillDraw(e){if(Md(this.viewer),this.isHidden||!this.worldSpacePosition||!this.viewer.getResources().commentIndicatorAtlas)return;this.viewer.getResources().commentIndicatorMaterial.ambientTexture=this.viewer.getResources().commentIndicatorAtlas.texture;const t=e.projectWorldPointToViewport(this.worldSpacePosition),i=de.create();i[12]=Math.floor(t[0]-Id/2),i[13]=Math.floor(t[1]-Ed/2),this.setTransform(i),this.hasMeshIncrements()||this.updateGraphics()}onClick(e,t){t.skipCommentClearHighlight=!0,Ki.Jq.CommentService.highlightComments(this.associatedComments)}onMouseEnter(){this.hovered=!0,this.removeMeshIncrements(),(0,Fs.vm)()}onMouseLeave(){this.hovered=!1,this.removeMeshIncrements(),(0,Fs.vm)()}onActiveSheetMetalModelChanged(e){this.parentSheetMetalModelId&&this.updateHideState()}}class yd extends Ti.u1{constructor(e,t){super(t,Zo.EG),this.elementModel=e,this.centerOfMass=null}updateCenterOfMass(e){this.centerOfMass=e}updateGraphics(){this.ensureMaterialIsCreated();const e=20*(0,Ji.x_)(),t=(0,Au.fQ)([0,0,0],[e,0,0],[0,e,0],void 0,[0,0],[1,1]);this.updateMeshIncrement("QUAD","",t,this.viewer.getResources().centerOfMassIndicatorNodeProperties)}ensureMaterialIsCreated(){if(null===this.viewer.getResources().centerOfMassIndicatorNodeProperties){const e=(0,yi.cP)(20);if(e>this.viewer.getMaximumTextureSize())throw new Error("Center of mass texture size exceeds limit");const t=new $a(this.viewer,(function(t){const i=new ja(t);return i.width=e,i.height=e,i.magnificationFilter=t.LINEAR,i.minificationFilter=t.LINEAR,i.useMipmaps=!1,i.imageSource="/images/center-of-mass.png",i}));t.setHasTransparency(!0),this.viewer.getResources().centerOfMassIndicatorNodeProperties=new xi.hF({primitiveType:Di.MX.TRIANGLES,material:Fi(t),isPickable:!1})}}onViewWillDraw(e){if(null===this.centerOfMass||this.isHidden)return;const t=e.projectWorldPointToViewport(this.centerOfMass),i=de.create(),s=20*(0,Ji.x_)()/2;i[12]=Math.floor(t[0]-s),i[13]=Math.floor(t[1]-s),this.setTransform(i),this.hasMeshIncrements()||this.updateGraphics()}onDevicePixelRatioChanged(e){this.updateGraphics()}}class Pd{constructor(e){this.bodyComponent=e,this.geometryHandler=new Ad(e)}featureEntityHasThreadData(e){return e&&e.getDomainSpecificMetadata(k.rhF)}addMaterialOverrideForEntity(e,t,i){if(!(t instanceof k.kdl))return;const s=t;this.featureEntityHasThreadData(s)&&this.geometryHandler.setFaceData(e,s,i)}removeOccurrence(e){this.geometryHandler.removeOccurrence(e)}destroy(){this.geometryHandler.destroy()}bodyHasCosmeticThreads(e){return this.geometryHandler.getBodyIdToFaces().get(e)?.size>0}getBodiesWithCosmeticThreads(e){const t=new Set;if(e.isNonGroupingCompositeBody)for(const i of e.constituentBodyIds)this.bodyHasCosmeticThreads(i)&&t.add(i);else this.bodyHasCosmeticThreads(e.id)&&t.add(e.id);return t}addCosmeticThreadGeometry(e,t,i,s,n,r,a){if(!this.bodyComponent.isBodyLoaded(t))return null;const o=this.geometryHandler.getBodyIdToFaces().get(t);if(!o)return null;let h=null;return o.forEach((o=>{const c=e.getIncrementDetails(o,this.bodyComponent.parent.getMeshOwnerId());if(!c)return;if(e===this.bodyComponent.getSharedBaseMeshManager()&&n.isIncrementHidden(c,fs.L.PREVIEW))return;const l=new SS("CosmeticThread-"+o+"-OccurrenceId-"+n.getOccurrenceId(),t);if(l.onIncrementAdded(c),this.geometryHandler.addGeometry(s,n,r,l,o,a,i),h){const e=new qE;e.setOperand(h);const t=l;e.setOperandA(t),h=e}else h=l})),h}updateEntity(e,t,i){const s=t,n=new Set;this.geometryHandler.removeFace(e,i)&&n.add(i),this.featureEntityHasThreadData(s)&&(this.addMaterialOverrideForEntity(e,t,i),n.add(i));const r=this.bodyComponent.retrieveBodyMetaData(i);return r&&this.getBodiesWithCosmeticThreads(r).forEach((e=>{n.add(e)})),n}removeFace(e,t){return this.geometryHandler.removeFace(e,t)}cloneForPreview(e){const t=new Pd(e);return this.copyToClone(t),t}copyToClone(e){e.geometryHandler=this.geometryHandler.clone(e.bodyComponent)}}class Ad{constructor(e){this.faceIdToCosmeticThread=new Map,this.faceIdToMaterial=new Map,this.faceAndOccurrenceIdToGeometryData=new gl.TemplatedSetMap,this.bodyIdToFaceIds=new gl.TemplatedSetMap,this.occurrenceIdToFaceIds=new gl.TemplatedSetMap,this.faceIdToOccurrences=new gl.TemplatedSetMap,this.bodyComponent=e}getDataKey(e,t){return e.toString()+t}getCosmeticThreadMaterial(e){const t=new Ni;return t.shaderId="cosmeticThreads",t.setCustomFloatUniform("uThreadPitch",e.pitch),t.setCustomVectorUniform("uCylinderOrigin",e.cylinderSystem.origin.getVec3()),t.setCustomVectorUniform("uCylinderAxisX",e.cylinderSystem.xAxis.getVec3()),t.setCustomVectorUniform("uCylinderAxisY",e.cylinderSystem.yAxis.getVec3()),t.setCustomVectorUniform("uCylinderAxisZ",e.cylinderSystem.zAxis.getVec3()),t.setCustomFloatUniform("uCylinderRadius",e.cylinderRadius),t.setCustomFloatUniform("uThreadLength",e.threadLength),t}setFaceData(e,t,i){this.bodyIdToFaceIds.add(i,e);const s=t.getDomainSpecificMetadata(k.rhF);this.faceIdToCosmeticThread.set(e,s)}getBodyIdToFaces(){return this.bodyIdToFaceIds}addGeometry(e,t,i,s,n,r,a){const o=t.getOccurrenceId(),h=this.getDataKey(o,n),c=this.faceIdToCosmeticThread.get(n);if(!c)return;const l=this.getCosmeticThreadMaterial(c);this.faceIdToMaterial.set(n,l);const u=e.cloneAndModify({material:l});this.faceAndOccurrenceIdToGeometryData.add(h,{nodeProperties:u,occurrenceData:t,style:i,meshRanges:s,faceId:n,nodeId:u.id,styleOverrideRanges:r,rangesToSkip:a}),this.bodyComponent.getNode().addOccurrenceGeometryToNode(u,t,i,s,r,a),this.occurrenceIdToFaceIds.add(o,n),this.faceIdToOccurrences.add(n,o)}clone(e){const t=new Ad(e);return t.faceIdToCosmeticThread=new Map(this.faceIdToCosmeticThread),t}removeOccurrence(e){this.occurrenceIdToFaceIds.has(e)&&(this.occurrenceIdToFaceIds.get(e).forEach((t=>{const i=this.getDataKey(e,t),s=this.faceAndOccurrenceIdToGeometryData.get(i);s&&(s.forEach((e=>{this.bodyComponent.getNode().removeChildById(e.nodeId.toString())})),this.faceAndOccurrenceIdToGeometryData.delete(i))})),this.occurrenceIdToFaceIds.delete(e))}removeFace(e,t){let i=!1;return this.faceIdToMaterial.has(e)&&(this.faceIdToMaterial.get(e).destroy(),this.faceIdToMaterial.delete(e),i=!0),this.bodyIdToFaceIds.deleteValue(t,e),this.faceIdToCosmeticThread.has(e)&&(this.faceIdToCosmeticThread.delete(e),i=!0),this.faceIdToOccurrences.has(e)&&0!==this.faceIdToOccurrences.get(e).size?(this.faceIdToOccurrences.get(e).forEach((t=>{const s=this.getDataKey(t,e),n=this.faceAndOccurrenceIdToGeometryData.get(s);n&&(n.forEach((e=>{this.bodyComponent.getNode().removeChildById(e.nodeId.toString()),i=!0})),this.faceAndOccurrenceIdToGeometryData.delete(s),this.occurrenceIdToFaceIds.deleteValue(t,e))})),this.faceIdToOccurrences.delete(e),i):i}destroy(){this.faceIdToMaterial.forEach(((e,t)=>{e.destroy()})),this.faceAndOccurrenceIdToGeometryData.forEach((e=>{e.forEach((e=>{e.nodeProperties.material.destroy(),this.bodyComponent.getNode().removeChildById(e.nodeId.toString())}))}))}}const Od="uDecalProjection",vd="uCylinderRadius",Rd="decals";function wd(e){return e.getMaterial()?.getExtendedShaderId()===Rd}class _d{constructor(e,t,i){this.decalId=e,this.bodyComponent=t,this.partStudio=i,this.bodyToInstantiationDetails=new Map,this.bodyToOccurrenceId=new Map,this.occurrenceIdToInstantiatedNodeProperties=new Map,this.relatedClosedCompositeDeterminsticIds=new Set,this.mappingResources=[]}destroy(){this.removeGraphics();for(let e=0;e<this.mappingResources.length;++e)this.mappingResources[e].material.destroy()}clone(e,t){const i=new _d(this.decalId,e,t);return i.btDecal=this.btDecal,i}removeOccurrences(){for(const[e,t]of this.bodyToOccurrenceId)for(const i of t)this.removeOccurrence(i,e)}removeGraphics(){this.removeOccurrences(),this.bodyToInstantiationDetails.clear()}addOrUpdateOccurrence(e,t){t=+t;const i=this.bodyComponent.retrieveBodyMetaData(e);if(!i)return;let s;s=i.isClosedComposite?i.constituentBodyIds:[e];let n=!1;for(let i=0;i<s.length;++i){const r=s[i],a=this.bodyToInstantiationDetails.get(r);if(a)for(const[i,s]of a){const i=new XI.bg,r=this.viewer.getOccurrenceDataManager().getOccurrenceData(t);for(let e=0;e<s.nodeProperties.length;++e){this.node.addOccurrenceGeometryToNode(s.nodeProperties[e],r,i,s.incrementRanges);let a=this.occurrenceIdToInstantiatedNodeProperties.get(t);a||(a=new Set,this.occurrenceIdToInstantiatedNodeProperties.set(t,a),n=!0),a.add(s.nodeProperties[e])}let a=this.bodyToOccurrenceId.get(e);a||(a=new Set,this.bodyToOccurrenceId.set(e,a)),a.add(t)}}n&&(i.isClosedComposite?this.relatedClosedCompositeDeterminsticIds.add(e):i.isClosedCompositeConstituent&&this.relatedClosedCompositeDeterminsticIds.add(i.closedCompositeParentId))}removeOccurrence(e,t){e=+e;const i=this.bodyToOccurrenceId.get(t);if(i&&i.has(e)){const s=this.occurrenceIdToInstantiatedNodeProperties.get(e);if(s){for(const t of s)this.node.removeOccurrenceFromNode(t,e);this.occurrenceIdToInstantiatedNodeProperties.delete(e)}i.delete(e),0===i.size&&this.bodyToOccurrenceId.delete(t)}}update(e){return(!this.btDecal||!this.btDecal.deepEquals(e))&&(this.btDecal=e,this.updateGraphics(),!0)}debugCoordinateSystem(){for(let e=0;e<this.btDecal.mappings.length;++e){const t=this.btDecal.mappings[e];let i=null;t instanceof k.TIP?i=t.planeSystem:t instanceof k.Q7q&&(i=t.cylinderSystem),i&&UD(this.viewer,this.decalId+"."+e,i)}}onPartStudioChange(e){(this.didReferencedFaceChange(e)||this.didBodyStatusChange(e))&&this.updateGraphics()}updateGraphics(){this.btDecal&&(this.removeGraphics(),this.updateMappingResources(),this.updateIncrementRanges(),this.refreshOccurrences())}refreshOccurrences(){this.bodyComponent.getBodyToOccurrenceId().eachNested(((e,t,i)=>{this.addOrUpdateOccurrence(t,i)}))}doesReferenceEntity(e){for(const t of this.btDecal.mappings)if(t.deterministicIds.indexOf(e)>=0)return!0;return!1}didReferencedFaceChange(e){if(!this.btDecal)return!1;for(const t of this.btDecal.mappings)for(const i of t.deterministicIds)if(e.deterministicIdToEntity.hasOwnProperty(i))return!0;return!1}didBodyStatusChange(e){for(const[e,t]of this.bodyToOccurrenceId){const t=this.bodyComponent.retrieveBodyMetaData(e);if(!t||t.canBeGroupedWithOtherConstituents)return!0}let t=!1;for(const i of this.relatedClosedCompositeDeterminsticIds)e.deterministicPartIdToData[i]&&(this.relatedClosedCompositeDeterminsticIds.delete(i),t=!0);return t}updateMappingResources(){for(let e=0;e<this.btDecal.mappings.length;++e){const t=this.btDecal.mappings[e];let i=this.mappingResources[e];if(!i){const e=new Ni({diffuseFactor:0,ambientFactor:1,specularColor:[0,0,0]});e.shaderId=Rd,i={material:e,nodeProperties:null,transparentNodeProperties:null},this.mappingResources.push(i)}if(t instanceof k.TIP)i.material.setCustomMatrixUniform(Od,t.planeSystem.fromWorld()),i.material.setCustomFloatUniform(vd,0);else{if(!(t instanceof k.Q7q))return void ut.log.debug("Unsupported decal mapping: "+t.getMessageName());i.material.setCustomMatrixUniform(Od,t.cylinderSystem.getGlMatrix()),i.material.setCustomFloatUniform(vd,t.radius)}i.material.setCustomMatrixUniform("uUvTransform",t.uvTransform.getGlMatrix());const s=(0,Bn.e)(this.btDecal.imageSourceId);i.material.setTexture(this.viewer.getResources().getImageTexture(s)),i.nodeProperties=cp.cloneAndModify({material:i.material,isPickable:!1,zOffset:X.default.getManager().getNumber("DECALS_Z_OFFSET")}),i.transparentNodeProperties=lp.cloneAndModify({material:i.material,isPickable:!1,zOffset:X.default.getManager().getNumber("DECALS_Z_OFFSET")})}}updateIncrementRanges(){for(let e=0;e<this.btDecal.mappings.length;++e){const t=this.btDecal.mappings[e];if(0===t.deterministicIds.length)continue;const i=this.mappingResources[e];if(i)for(const s of t.deterministicIds){const t=this.bodyComponent.getEntityMetaData(s);if(!t)continue;const n=t.getBodyId();if(!this.bodyComponent.isBodyLoaded(n))continue;const r=this.partStudio.getIncrementMeshDetails(s);if(!r){ut.log.debug("Did not find increment details for "+s);continue}let a=this.bodyToInstantiationDetails.get(n);a||(a=new Map,this.bodyToInstantiationDetails.set(n,a));let o=a.get(e);o||(o={incrementRanges:new SS("Decal-"+this.decalId+"-Mapping-"+e+"-Body-"+n),nodeProperties:[i.nodeProperties,i.transparentNodeProperties]},a.set(e,o)),o?.incrementRanges.onIncrementAdded(r)}else ut.log.warn("Did not have image mapping resources for decal mapping "+e)}}get node(){return this.partStudio.getModelViewManager().getSharedBodyNode()}get viewer(){return this.partStudio.viewer}}class Nd{constructor(e,t){this.bodyComponent=e,this.partStudio=t,this.decals=new Map}destroy(){for(const[e,t]of this.decals)t.destroy()}cloneForPreview(e,t){const i=new Nd(e,t);return this.copyToClone(i),i}copyToClone(e){for(const[t,i]of this.decals){const s=i.clone(e.bodyComponent,e.partStudio);e.decals.set(t,s),s.updateGraphics()}}removeFromScene(){for(const[e,t]of this.decals)t.removeOccurrences()}update(e){if(this.partStudio.viewer.getIsForFlattenedDisplay())return;const t=new Set;for(const i in e.decalIdToDecal){const s=e.decalIdToDecal[i];let n=this.decals.get(i);s.isDeletion?n&&(n.destroy(),this.decals.delete(i)):(n||(n=new _d(i,this.bodyComponent,this.partStudio),this.decals.set(i,n)),n.update(s)&&t.add(i))}for(const[i,s]of this.decals)t.has(i)||s.onPartStudioChange(e)}onBodyLoaded(){for(const[e,t]of this.decals)t.updateGraphics()}addOrUpdateOccurrence(e,t){for(const[i,s]of this.decals)s.addOrUpdateOccurrence(e,t)}removeOccurrence(e,t){for(const[i,s]of this.decals)s.removeOccurrence(e,t)}getDecalIdsAffectingEntity(e){const t=[];for(const[i,s]of this.decals)s.doesReferenceEntity(e)&&t.push(i);return t}}var bd=i(17355);const Ld=function(e){return e.isFace()||e.isFromSketch()&&e.isEdge()||e.isFromOrigin()||e.isSketchUserPoint()||e.isFromPointBody()||e.isFromWireBody()},Fd=function(e){return e.isFace()||e.isFromWireBody()&&e.isEdge()||e.isFromPointBody()};class xd extends cd{constructor(e,t,i,s,n,r,a){super(r),this.id=e,this.microversionIdAndConfiguration=t,this.modelViewManager=i,this.usage=n,this.isExternal=!1,this.isForIncontextDisplay=!1,this.bodyIdsThatAreInsertableBuffers=null,this.hideableFeatureIds=[],this.referencedInContextAssemblyIds=[],this.visibleInContextAssembly="",this.displayedContextTransform={},this.editedInContextOccurrences=[],this.partColorCycle=null,this.isCachedPartStudioPendingUse=!1,this.isMissingTangencyInformationMessageShown=!1,this.bodyIdToEntityAppearanceSettings={},this.meshOwnerId=a?a.meshOwnerId:PS(),this.sharedBaseMeshManager=i.getSharedBaseMeshManager(),this.entityIdManager=new eI.E(Si._6.ENTITY),this.bodyComponent=new Dp(this,s,this.usage,this.viewer),this.sketchComponent=new vp(this,this.usage,this.viewer),this.planeComponent=new Xd(this,this.usage,this.viewer),this.pointBodyComponent=new Xg(this,this.viewer),this.mateConnectorComponent=new Ag(this,this.usage,this.viewer),this.errorComponent=new Mp(this,this.viewer),this.dimensionComponent=new Bd(this.usage,this.id,this.viewer,a?.getDimensionComponent()),this.imageComponent=new pl(this.usage,this.viewer),this.annotationComponent=new jl(this.usage,this.id,this.viewer,a?.getAnnotationComponent()),this.components=[this.bodyComponent,this.sketchComponent,this.planeComponent,this.pointBodyComponent,this.mateConnectorComponent,this.errorComponent]}clone(e){const t=new xd(this.id,this.microversionIdAndConfiguration,this.modelViewManager,this.bodyComponent.getBodyLoadTasks(),this.usage,this.viewer);if(e){for(let e=0;e<t.components.length;++e)t.bodyComponent===t.components[e]?(t.bodyComponent=this.bodyComponent.clone(t),t.components[e]=t.bodyComponent):t.planeComponent===t.components[e]?(t.planeComponent=this.planeComponent.clone(t),t.components[e]=t.planeComponent):t.sketchComponent===t.components[e]?(t.sketchComponent=this.sketchComponent.clone(t),t.components[e]=t.sketchComponent):t.pointBodyComponent===t.components[e]?(t.pointBodyComponent=this.pointBodyComponent.clone(t),t.components[e]=t.pointBodyComponent):t.mateConnectorComponent===t.components[e]&&(t.mateConnectorComponent=this.mateConnectorComponent.clone(t),t.components[e]=t.mateConnectorComponent);t.imageComponent=this.imageComponent.cloneForUsage(this.usage),t.partColorCycle=this.partColorCycle,t.isCachedPartStudioPendingUse=this.isCachedPartStudioPendingUse,t.bodyIdToEntityAppearanceSettings=this.bodyIdToEntityAppearanceSettings}return t}cloneForPreview(e,t){const i=new xd(this.id,null,e,this.bodyComponent.getBodyLoadTasks(),fs.L.PREVIEW,this.viewer,this);i.entityIdManager=this.entityIdManager.clone();for(let e=0;e<i.components.length;++e)i.bodyComponent===i.components[e]?(i.bodyComponent=this.bodyComponent.cloneForPreview(i),i.components[e]=i.bodyComponent):i.planeComponent===i.components[e]?t||(i.planeComponent=this.planeComponent.cloneForPreview(i),i.components[e]=i.planeComponent):i.sketchComponent===i.components[e]?(i.sketchComponent=this.sketchComponent.cloneForPreview(i),i.components[e]=i.sketchComponent):i.pointBodyComponent===i.components[e]?t||(i.pointBodyComponent=this.pointBodyComponent.cloneForPreview(i),i.components[e]=i.pointBodyComponent):i.mateConnectorComponent===i.components[e]&&(t||(i.mateConnectorComponent=this.mateConnectorComponent.cloneForPreview(i),i.components[e]=i.mateConnectorComponent));return i.imageComponent=this.imageComponent.cloneForUsage(fs.L.PREVIEW),i.partColorCycle=this.partColorCycle,i.bodyIdToEntityAppearanceSettings=this.bodyIdToEntityAppearanceSettings,i}isBodyContainedInInsertableDisplayBuffers(e){return this.bodyIdsThatAreInsertableBuffers&&this.bodyIdsThatAreInsertableBuffers.has(e)}onPreviewDestroyed(){this.bodyComponent.onPreviewDestroyed()}copyBodyVisibility(e){this.bodyComponent.copyVisibility(e.bodyComponent)}isBase(){return this.usage===fs.L.BASE}getElementId(){return this.id}getIsMissingTangencyInformationMessageShown(){return this.isMissingTangencyInformationMessageShown}setIsMissingTangencyInformationMessageShown(e){this.isMissingTangencyInformationMessageShown=e}getIsCachedPartStudioPendingUse(){return this.isCachedPartStudioPendingUse}getFullElementId(){return this.microversionIdAndConfiguration?k.lK7.getFullElementIdString(this.id,this.microversionIdAndConfiguration.getKey()):this.id}getBtFullElementId(){const e=new k.lK7;return e.elementId=this.id,this.microversionIdAndConfiguration&&(e.microversionId=this.microversionIdAndConfiguration.microversion,e.microversionIdAndConfiguration=this.microversionIdAndConfiguration),e}getModelViewManager(){return this.modelViewManager}getMeshManager(){return this.modelViewManager.getMeshManager()}getSharedBaseMeshManager(){return this.sharedBaseMeshManager||null}populateClientCacheStateDisplayInformation(e){if(this.microversionIdAndConfiguration){const t=e.getOrCreateElementDataList(this.id,k.D3B.DISPLAY_DATA);this.checkDuplicatedMicroversionIdAndConfiguration(t,this.microversionIdAndConfiguration)?t.push(this.microversionIdAndConfiguration):ut.log.warn("Found duplicated part studio microversion id and configuration "+this.microversionIdAndConfiguration),this.populateTessellationSetting(e),this.populateSketchFeatures(e)}}populateSketchFeatures(e){const t=this.getBtFullElementId(),i=this.sketchComponent.featureToIds.getKeys(),s=e.listFullElementIdToReferencedSketchFeatureIds,n=new k.luK;return n.fullElementId=t,n.referencedSketchFeatureIds=i,s.push(n),n}populateTessellationSetting(e){let t,i=e.tessellationWithConfigurationSettings[this.id];i||(e.tessellationWithConfigurationSettings[this.id]=i=[]);for(let e=0;e<i.length;e++)if(t=i[e],t.microversionIdAndConfiguration.equals(this.microversionIdAndConfiguration))return t.tessellationSettings=this.bodyComponent.getTessellationSettings(),t.partTriangleCounts=this.bodyComponent.getPartTriangleCounts(),t;return t=new k.iRj,t.microversionIdAndConfiguration=this.microversionIdAndConfiguration,t.tessellationSettings=this.bodyComponent.getTessellationSettings(),i.push(t),t}getSceneGraph(){return this.usage===fs.L.PREVIEW?this.viewer.getSceneGraphs().getPreviewSceneGraph():this.viewer.getSceneGraphs().getMainSceneGraph()}getPartColorCycle(){return this.partColorCycle}reset(e){for(let t=0;t<this.components.length;++t)this.components[t].reset(e);this.dimensionComponent.reset(),this.imageComponent.reset(),this.entityIdManager.reset(),this.referencedInContextAssemblyIds=[],this.visibleInContextAssembly="",this.editedInContextOccurrences=[],this.annotationComponent.reset(),this.sharedBaseMeshManager=null}retrieveEntityMetaData(e){for(let t=0;t<this.components.length;++t){const i=this.components[t].getEntityMetaData(e);if(i)return i}return null}retrieveBodyMetaData(e){for(let t=0;t<this.components.length;++t){const i=this.components[t].retrieveBodyMetaData(e);if(i)return i}return null}retrieveAssociatedFeatureIds(e){const t=[];for(const i of this.components){const s=i.retrieveAssociatedFeatureIds(e);s&&s.length&&t.push(...s)}return t}retrieveBodyEntityData(e){const t=[],i=this.getBodyComponent().getEntityIds(e);for(const e of i){const i=this.retrieveEntityMetaData(e);i&&t.push(i)}return t}getEntityIdManager(){return this.entityIdManager}extractMeshIncrement(e){for(let t=0;t<this.components.length;++t){const i=this.components[t].extractMeshIncrement(e);if(i)return i}return null}getHideableMateConnectorFeatureIds(){return this.mateConnectorComponent.getHideableFeatureIds()}getHideableSketchFeatureIds(){return this.sketchComponent.getHideableFeatureIds()}getHideablePlaneFeatureIds(){return this.planeComponent.getHideableFeatureIds()}getHideableFeatureIds(){return this.hideableFeatureIds}addManagedIdMappings(e){for(const t of Object.values(e)){const e=t.managedData;if(e)for(const t of e)for(const e of t.bodyIds){const i=t.creationId;switch(t.type){case k.dry.SKETCH:this.sketchComponent.addManagedIdMappings(i,e);break;case k.dry.CONSTRUCTION_PLANE:this.planeComponent.addManagedIdMappings(i,e);break;case k.dry.MATE_CONNECTOR:this.mateConnectorComponent.addManagedIdMappings(i,e);break;default:this.sketchComponent.addManagedIdMappings(i,e),this.planeComponent.addManagedIdMappings(i,e),this.mateConnectorComponent.addManagedIdMappings(i,e)}}}}fixPartAndDisplayDataForMessage(e){this.bodyIdsThatAreInsertableBuffers||(this.bodyIdsThatAreInsertableBuffers=new Set);for(const t of Object.values(e.partIdAndTessellationSettingToBuffers)){const i=Object.values(t);if(i.length>0&&i[0]instanceof k.l48){const t=i[0],s=t.getId();e.deterministicPartIdToData[s]=t.partData,e.partDisplayData.push(t.partDisplayData),this.bodyIdsThatAreInsertableBuffers.add(s)}}for(const t of Object.values(e.sketchFeatureIdAndTessellationSettingToBuffers)){const i=Object.values(t);if(i.length>0&&i[0]instanceof k.VtB){const t=i[0],s=t.getId();this.bodyIdsThatAreInsertableBuffers.add(s);for(const[i,s]of Object.entries(t.bodyIdToPartData))e.deterministicPartIdToData[i]=s,this.bodyIdsThatAreInsertableBuffers.add(i)}}}processDisplayData(e,t,i,s,n){if((this.isBase()?e.buildFullElementId().toString():e.elementId)!==(this.isBase()?this.getFullElementId():this.id))return void ut.log.warn("An attempt was made to update part studio graphics with display data that do not belong to it.");if(this.updateExternalState(e.isExternal,i),e.isNoop)return;e.fromDisplayCache&&(this.isCachedPartStudioPendingUse=!0),this.viewer.areOptimizedBuffersEnabled&&this.fixPartAndDisplayDataForMessage(e),this.partColorCycle||(this.partColorCycle=e.partColorCycle),this.hideableFeatureIds=[];let r,a,o,h=0;const c=new Qo.B7("processDisplayData");if(e.incremental){const t=new Qo.B7("Deleting entities");for(r=0;r<this.components.length;++r)this.components[r].processDeletions(e);t.report()}else this.reset();let l=!this.viewer.getIsForFlattenedDisplay()||!(0,j.isEmptyObjectOrArray)(e.appearanceIdToAppearanceOverride);if(!l)for(const t in e.deterministicPartIdToData)if(e.deterministicPartIdToData[t].isForFlattenedView()){l=!0;break}l||this.bodyComponent.updateBodyDisplayData(e,s);const u=new Qo.B7("Updating entities");for(r=0;r<this.components.length;++r){this.viewer.getIsForFlattenedDisplay()&&!l||this.components[r].processAdditionsAndChanges(e,t,s);const i=this.components[r].getHideableFeatureIds();for(a=0;a<i.length;++a)this.hideableFeatureIds.push(i[a])}if(this.bodyComponent.updateCompositeConstituentCounts(e),this.bodyComponent.updateBodiesWithChangedSmoothEdgesCount(),this.viewer.getIsPrimaryViewer()&&this.annotationComponent.processDisplayData(e),u.report(),e.bodyIdToEntityAppearanceSettingsChanged&&(this.bodyIdToEntityAppearanceSettings=e.bodyIdToEntityAppearanceSettings),e.partDisplayData){const t=e.partDisplayData.length;for(o=0;o<t;o++){const t=e.partDisplayData[o].id;if(e.partDisplayData[o].baseAppearanceSettings=this.bodyIdToEntityAppearanceSettings[t],!e.partDisplayData[o].baseAppearanceSettings){const i=this.retrieveBodyMetaData(t);if(i&&i.isClosedComposite){const s=e.partDisplayData[o];let n=!1;const r=i.constituentBodyIds.length;for(h=0;h<r;h++){const e=i.constituentBodyIds[h];if(!this.bodyIdToEntityAppearanceSettings[e])continue;const r=this.bodyIdToEntityAppearanceSettings[e];if(n){if(s.baseAppearanceSettings&&r.colorIdToBaseEntityAppearanceEntry){const e=r.colorIdToBaseEntityAppearanceEntry;for(const t in e)if(t){const i=e[t];i&&(s.baseAppearanceSettings.colorIdToBaseEntityAppearanceEntry[t]?s.baseAppearanceSettings.colorIdToBaseEntityAppearanceEntry[t].affectedDeterministicIds=s.baseAppearanceSettings.colorIdToBaseEntityAppearanceEntry[t].affectedDeterministicIds.concat(i.affectedDeterministicIds):s.baseAppearanceSettings.colorIdToBaseEntityAppearanceEntry[t]=i)}}}else n=!0,s.baseAppearanceSettings=r,this.bodyIdToEntityAppearanceSettings[t]=s.baseAppearanceSettings}}}}}this.isForIncontextDisplay||this.viewer.getIsForFlattenedDisplay()||this.viewer.getEventDispatcher().trigger(yD.W2,e.partDisplayData,e.buildFullElementId(),e.usage,this.bodyComponent.bodyMetaData,n),this.dimensionComponent.processDisplayData(e),this.imageComponent.processDisplayData(e),e.incremental||t||this.bodyComponent.reloadOccurrences(),t&&(this.dimensionComponent.updateDisplays(),this.imageComponent.updateDisplays()),this.processInContextData(e,t),this.viewer.getEventDispatcher().trigger(yD.CD,e,s),c.report()}processReceivedInsertableData(e){const t={},i={};i[e.getTessellationSetting()]=e,t[e.getId()]=i;const s=e.isSketchFeature()?this.getSketchComponent():this.getBodyComponent(),n=e.getId();s.processPrecompiledGraphicsBuffers(t),e.isSketchFeature()||s.refreshBodyOccurrenceForBodyId(n),this.viewer.requestDraw()}processInContextData(e,t){if(this.isBase()){let i,s=!1;if(e.assemblyReferenceDisplayData){const t=e.assemblyReferenceDisplayData.assemblyReferences;for(i=0;i<t.length;i++)t[i].visibility===k.HRI.VISIBLE&&(s=!0)}if(s){if(t)for(this.referencedInContextAssemblyIds=[],this.visibleInContextAssembly="",this.editedInContextOccurrences=[],this.displayedContextTransform={},i=0;i<e.assemblyReferenceDisplayData.assemblyReferences.length;i++){const t=e.assemblyReferenceDisplayData.assemblyReferences[i],s=t.isTransient?"":t.referenceNodeId,n=t.assemblyDisplayData;t.occurrencesToExclude.forEach((e=>{this.editedInContextOccurrences.push({assemblyElementId:n.elementId,occurrence:e,contextId:s})}));const r=(0,Fs.dV)(n.elementId);let a=n.elementId;r!==e.assemblyReferenceDisplayData.elementId&&(a=(0,Fs.HL)(n.elementId,e.assemblyReferenceDisplayData.elementId,t.referenceNodeId)),this.referencedInContextAssemblyIds.push(a),t.visibility===k.HRI.VISIBLE&&(this.visibleInContextAssembly=a),this.displayedContextTransform[s]=t.transform}}else t&&this.removeInContextAssemblies()}else if(this.viewer.getModelViewManagers().getManager().isDisplayingIncontextAssembly()){const e=!0;(0,yD.xA)().trigger(yD.bh,e)}}updateExternalState(e,t){this.isExternal=e,this.isForIncontextDisplay=!!t}getReferencedInContextAssemblyIds(){return this.referencedInContextAssemblyIds}isDisplayingIncontextAssembly(){return!!this.visibleInContextAssembly}getVisibleInContextAssemblyId(){return this.visibleInContextAssembly}removeInContextAssemblies(){this.viewer.getModelViewManagers().getManager().resetAllIncontextGraphicsForPartstudio(this.getElementId()),this.referencedInContextAssemblyIds=[],this.visibleInContextAssembly="",this.editedInContextOccurrences=[]}getEditedOccurrenceForAssembly(e,t){const i=(0,bd.Z)(this.editedInContextOccurrences,{assemblyElementId:e,contextId:t});return i?i.occurrence:null}removeInstantiationForEditing(e){this.removeInContextAssemblies();for(let t=0;t<this.components.length;++t)this.components[t].removePartStudioInstantiation(e);this.dimensionComponent.remove(),this.annotationComponent?.hide(),this.imageComponent.remove()}instantiateForEditingInNode(e){this.isCachedPartStudioPendingUse=!1,this.bodyComponent.instantiateForPartStudio(e),this.sketchComponent.instantiateForPartStudio(e),this.mateConnectorComponent.instantiateForPartStudio(e),this.planeComponent.instantiateForPartStudio(e),this.pointBodyComponent.instantiateForPartStudio(e),this.dimensionComponent.updateDisplays()}getDimensionGraphic(e,t){return this.dimensionComponent.getDimensionGraphic(e,t)}addOrUpdateOccurrence(e,t,i){this.isCachedPartStudioPendingUse=!1,this.sketchComponent.addOrUpdateOccurrence(e,t),this.bodyComponent.addOrUpdateOccurrence(e,t),i&&this.mateConnectorComponent.addOrUpdateOccurrence(e,t)}removeOccurrence(e,t){this.sketchComponent.removeOccurrence(e,t),this.bodyComponent.removeOccurrence(e,t),this.mateConnectorComponent.removeOccurrence(e,t),this.imageComponent.removeOccurrence(e)}getChildNodesWithId(e,t){const i=[],s=t?[t]:this.getSceneGraph().getAllNodesWithId(rI),n=function(t){return t.getId()===e&&i.push(t),!1};for(let e=0;e<s.length;++e)s[e].walk(n);return i}hideSketch(e){this.sketchComponent.hideShowFeature(e,Fs.EE.HIDDEN),this.dimensionComponent.sketchHidden(e),this.imageComponent.onSketchHidden(e),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Fs.EE.HIDDEN)}hideDimensions(e){this.dimensionComponent.sketchHidden(e)}showSketch(e){this.sketchComponent.hideShowFeature(e,Fs.EE.VISIBLE),this.dimensionComponent.sketchShown(e),this.imageComponent.onSketchShown(e),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Fs.EE.VISIBLE)}displaySketchAsActive(e,t){void 0===t&&(t=!0),this.sketchComponent.displaySketchAsActive(e,t),this.dimensionComponent.displaySketchAsActive(e,t),t?this.imageComponent.onSketchActivated(e):this.imageComponent.onSketchDeactivated(e)}displaySketchAsInactive(e){this.displaySketchAsActive(e,!1)}hasActiveSketch(){return this.sketchComponent.hasActiveSketch()}getPartNodes(e){return this.getChildNodesWithId(jg,e)}setPlaneAppearance(e,t){this.planeComponent.updateFeatureAppearance(e,t)}getBoundsOutsideElementNode(){const e=new yi.kB;return e.addBox(this.planeComponent.getVisiblePlaneBounds()),e.addBox(this.dimensionComponent.getVisibleDimensionBounds()),e.addBox(this.mateConnectorComponent.getVisibleMateConnectorBounds()),e}showPointBodies(e){this.pointBodyComponent.hideShowFeature(e,Fs.EE.VISIBLE),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Fs.EE.VISIBLE)}hidePointBodies(e){this.pointBodyComponent.hideShowFeature(e,Fs.EE.HIDDEN),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Fs.EE.HIDDEN)}hidePart(e){const t=this.bodyComponent.hideShowBody(e,Fs.EE.HIDDEN,Jf.KF);return t&&this.trigger("BODY_VISIBILITY_CHANGE."+e,Fs.EE.HIDDEN),t}showPart(e){const t=this.bodyComponent.hideShowBody(e,Fs.EE.VISIBLE,Jf.KF);return t&&this.trigger("BODY_VISIBILITY_CHANGE."+e,Fs.EE.VISIBLE),t}changePartColor(e,t,i){this.bodyComponent.setBodyColor(e,t,i)}changePartOpacity(e,t,i){this.bodyComponent.setBodyOpacity(e,t,i)}getPartColor(e){return this.bodyComponent.getBodyColorByBodyId(e).slice(0)}getPartOpacity(e){return this.bodyComponent.getBodyColorByBodyId(e)[3]}getEntityColor(e){return this.bodyComponent.getEntityColor(e)}hideConstructionPlane(e){this.planeComponent.hideShowFeature(e,Fs.EE.HIDDEN),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Fs.EE.HIDDEN)}showConstructionPlane(e){this.planeComponent.hideShowFeature(e,Fs.EE.VISIBLE),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Fs.EE.VISIBLE)}hideFeatureBodies(e,t){this.bodyComponent.hideShowFeature(e,Fs.EE.HIDDEN,t),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Fs.EE.HIDDEN)}showFeatureBodies(e,t){this.bodyComponent.hideShowFeature(e,Fs.EE.VISIBLE,t),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Fs.EE.VISIBLE)}hideMateConnector(e,t){this.mateConnectorComponent.hideShowFeature(e,Fs.EE.HIDDEN,null,t),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Fs.EE.HIDDEN)}showMateConnector(e,t){this.mateConnectorComponent.hideShowFeature(e,Fs.EE.VISIBLE,null,t),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Fs.EE.VISIBLE)}getEntitiesForFeature(e,t){let i=[];for(let s=0;s<this.components.length;++s){const n=this.components[s].getEntitiesForFeature(e,t);n&&(i=i.concat(n))}return i}getFilteredEntityIds(e){let t=[];for(let i=0;i<this.components.length;++i){const s=this.components[i].getEntitiesForFilterFunction(e);s&&(t=t.concat(s))}return t}getEntitiesForSketchGroup(e,t,i){return this.sketchComponent.getEntitiesForFeature(t,(function(t){let s=0===t.getSketchGroupId().indexOf(e);return t.isSketchTextEntity()&&(s=s&&["left","right","ascent","baseline"].some((function(e){return t.getSketchEntityId().indexOf(e)>0}))),i&&(s=s&&i(t)),s}))||[]}getEntitiesForBody(e,t){let i=[];for(let s=0;s<this.components.length;++s){const n=this.components[s].getEntitiesForBody(e,t);n&&(i=i.concat(n))}return i}retrieveSketchEntityDeterministicId(e,t){return this.sketchComponent.retrieveSketchEntityDeterministicId(e,t)}onDeletion(e){this.reset(e)}hasFeature(e){for(let t=0;t<this.components.length;++t)if(this.components[t].hasFeature(e))return!0;return!1}getFeatureVisibility(e){for(let t=0;t<this.components.length;++t)if(this.components[t].hasFeature(e))return this.components[t].getFeatureVisibility(e);return Fs.EE.HIDDEN}hasBody(e){for(let t=0;t<this.components.length;++t)if(this.components[t].hasBody(e))return!0;return!1}getBodyVisibility(e){return this.bodyComponent.isBodyVisible(Jf.KF,e)?Fs.EE.VISIBLE:Fs.EE.HIDDEN}getUIElementsForSelection(e){let t=[];if((e.isMateConnector()||e.isFeature())&&(t=this.mateConnectorComponent.getUIElementsForSelection(e)),(e.isEntity()||e.isFromConstructionGeometry()||e.isDerivedFeature())&&(t=t.concat(this.planeComponent.getUIElementsForSelection(e))),e.isAnnotation()){const i=this.annotationComponent.getUiElementForSelection(e);i&&t.push(i)}if(e.isDimension()){const i=this.dimensionComponent.getUiElementForSelection(e);i&&t.push(i)}return t}getInContextImportEntityIdsForSelection(e){let t=[];const i=e.getInContextImports();if(i&&i.length>0)for(let e=0;e<i.length;++e){const s=this.getEntitiesForFeature(i[e],Ld);t=t.concat(s)}return t||[]}getEntityIdsForSelection(e){let t=[];if(e.isMateConnector())t=this.mateConnectorComponent.getEntityIdsForSelection(e);else if(e.isProperty()){if(e.getChildSelections())for(let i=0;i<e.getChildSelections().length;++i)t=t.concat(this.getEntityIdsForSelection(e.getChildSelections()[i]))}else if(e.isEntity())t.push(e.getIdString());else if(e.isFeature())t=this.getEntitiesForFeature(e.getIdString(),Ld);else if(e.isSketchGroup()){const i=e.getSketchGroupFeatureId();i?t=this.getEntitiesForSketchGroup(e.getIdString(),i,Ld):ut.log.info("Sketch group selection did not have a valid sketch id")}else if(e.isBody()){const i=this.getEntityIdsForBodySelection(e.getIdString(),e.getOccurrence(),e.getBodyMetaData());i&&i.length&&(t=t.concat(i))}else if(e.isTableItem()){const i=e.getOccurrence();for(let s=0;s<e.getDeterministicIdList().length;++s){const n=e.getDeterministicIdList()[s],r=this.getEntityIdsForBodySelection(n,i,this.retrieveBodyMetaData(n));r&&r.length?t=t.concat(r):t.push(n)}}return t||[]}getEntityIdsForBodySelection(e,t,i){let s=[];s=i&&i.isComposite?i.constituentBodyIds:[e];let n=[];for(let e=0;e<s.length;++e){const i=s[e],r=this.retrieveBodyMetaData(i);if(r&&this.bodyComponent.hasBodyOccurrence(r.meshGroupId,t))if(this.bodyComponent.isBodyLoaded(i)){const e=this.getEntitiesForBody(i,Fd);e&&e.length&&(n=n.concat(e))}else n.push(i);else{const e=this.retrieveBodyMetaData(i),t=e?.isPointBody()?null:Ld,s=this.sketchComponent.getEntitiesForBody(i,t);s&&(n=s)}}return n}getOccurrenceEntityIdsForHighlight(e){if(e){const t=this.viewer.getIdForOccurrence(e);return this.sketchComponent.getEntitiesForOccurrenceSelection(t)||[]}return[]}getOccurrencesForSelection(e){let t=[];if(e.isMateConnector())t=this.mateConnectorComponent.getOccurrencesForSelection(e);else if(e.isBody()){const i=this.bodyComponent.retrieveBodyMetaData(e.getBodyId());if(i&&!i.hasTessellationSettings()){const i=this.bodyComponent.getPartStudioBodyOccurrenceName(e.getBodyId());t.push(k._oC.getOccurrenceFromPathString(i))}}return t}getOccurrenceBounds(e){const t=new yi.kB;for(let i=0;i<this.components.length;i++){const s=this.components[i];t.addBox(s.getOccurrenceBounds(e))}return t}setPlaneName(e,t){this.planeComponent.setPlaneName(e,t)}getMateConnectorGraphics(e,t){return this.mateConnectorComponent.getMateConnectorGraphics(e,t)}getMateConnectorData(e,t){return this.mateConnectorComponent.getMateConnectorData(e,t)}getAllMateConnectorGraphics(e){const t=this;let i=[];return this.mateConnectorComponent.featureToIds.each((function(s,n){if(t.hasMateConnectorDefinition(e,n)){const s=t.getMateConnectorGraphics(e,n);s&&(i=i.concat(s))}return!1})),i}hasMateConnectorDefinition(e,t){return!!this.getMateConnectorGraphics(e,t)}getStatistics(e,t=!1){const i=this.bodyComponent.getStatistics(e,t),s=this.errorComponent.getEntityCount();return s>0&&(i.errorMessage=this.getFullElementId()+" has "+s+" entities with failed tessellation."),i}getBoundsForEntities(e){if(!e||0===e.length)return null;const t=new yi.kB;for(let i=0;i<e.length;++i){const s=this.extractMeshIncrement(e[i]);s&&t.addBox(s.getBounds())}return t}getFeatureBounds(e){const t=this.getBoundsForEntities(this.getEntitiesForFeature(e,(function(e){return!e.isFromSketch()||e.isUserSketchEntity()})));return t&&t.addBox(this.dimensionComponent.getDimensionBoundsForFeature(e)),t}getEntityBounds(e,t){const i=this.retrieveEntityMetaData(e);if(!i)return null;if(i.isFromBody()&&!this.bodyComponent.isBodyActiveInView(this.bodyComponent.getEntityBodyGroupId(i),t))return null;const s=this.extractMeshIncrement(e);return s?.getBounds()||null}getBodyBounds(e,t){if(this.bodyComponent.isBodyActiveInView(e,t)){const t=this.retrieveBodyMetaData(e);if(t)return t.getBounds()}return null}getBodyComponent(e){return this.bodyComponent}getDimensionComponent(){return this.dimensionComponent}getPartStudioBodyOccurrenceIds(){return this.bodyComponent.getPartStudioBodyOccurrenceIds()}getPartStudioOccurrenceIds(){const e=this.bodyComponent.getPartStudioBodyOccurrenceIds(),t=[this.sketchComponent.sketchComponentElementId],i=this.planeComponent.getPartStudioPlaneOccurrenceIds();return e.concat(t,i)}getContextCameraData(e){return this.displayedContextTransform[e]?this.viewer.getCameraData(this.displayedContextTransform[e].getGlMatrix()):{camera:null,cameraExtents:null}}getInstantiatedTriangleCount(){return this.bodyComponent.getInstantiatedTriangleCount()}getSketchComponent(){return this.sketchComponent}getImageComponent(){return this.imageComponent}getMateConnectorComponent(){return this.mateConnectorComponent}getPlaneComponent(){return this.planeComponent}getAnnotationComponent(){return this.annotationComponent}getIsInternal(){return!this.isExternal&&!this.isForIncontextDisplay}getEstimatedMemoryUsageOfBodies(){return this.bodyComponent.getEstimatedMemoryUsage()}unloadBody(e){this.bodyComponent.unloadBody(e)}getPartStudioOccurrenceIdForSelection(e){return e.getOccurrence()?Jf.Qy:e.isFromBody()?this.bodyComponent.getCorrectedBodyOccurrenceId(e.getBodyId(),Jf.KF):e.isFromSketch()?this.sketchComponent.sketchComponentElementId:e.isConstructionPlane()?this.planeComponent.getSelectionOccurrenceId(e):Jf.KF}getBodyTransform(e,t){const i=this.bodyComponent;let s=i.partStudioBodyIdToOccurrenceId[e];if(!s){const n=t.getModelViewManagers().getManager().alternateEntityMapping.get(e);n&&(s=i.partStudioBodyIdToOccurrenceId[n])}return s?(0,j.as)(eT,t).getOccurrenceDataManager().getOccurrenceTransform(s):de.create()}getMeshOwnerId(){return this.meshOwnerId}updateEntityHighlight(e,t,i,s){for(let n=0;n<this.components.length&&!this.components[n].updateEntityHighlight(e,t,i,s);++n);}getElementType(){return k.GNh.PARTSTUDIO}collectComponentsForHeapDump(e){this.bodyComponent.collectComponentsForHeapDump(e)}updatePSOI(e){this.bodyComponent.updatePSOI(e)}getDecalIdsAffectingEntity(e){return this.bodyComponent.getDecalComponent().getDecalIdsAffectingEntity(e)}onAppearanceConstantsUpdated(){for(const e of this.components)e.onAppearanceConstantsUpdated()}onRenderingModeChanged(){for(const e of this.components)e.onRenderingModeChanged()}getIncrementMeshDetails(e){const t=this.getMeshManager().getIncrementDetails(e,this.getMeshOwnerId());if(t)return t;const i=this.getSharedBaseMeshManager();return i?i.getIncrementDetails(e,this.getMeshOwnerId()):null}}class Bd{constructor(e,t,i,s){this.usage=e,this.elementId=t,this.viewer=i,this.dimensionData={},this.dimensionDisplays={},this.visibleDimensionBounds=null,this.activeFeatureId=null,this.annotationPaneIsOpen=!1,(0,Jo.Yk)(i),this.activeSketchIds=new gt.StringSet,this.persistentDimensionKeys=new Set,s&&(this.activeFeatureId=s.activeFeatureId,this.activeSketchIds=s.activeSketchIds.clone())}processDisplayData(e){const t=this.usage===fs.L.PREVIEW;if(!t||this.activeFeatureId&&!this.activeSketchIds.contains(this.activeFeatureId)){this.dimensionData={};for(let i=0;i<e.dimensions.length;++i){const s=e.dimensions[i];s&&s.isAssociatedWithFlat===this.viewer.getIsForFlattenedDisplay()&&(!t||s.isAnnotationDimension&&s.featureId===this.activeFeatureId)&&(this.dimensionData[s.getFullyQualifiedId()]=s)}}}reset(){this.remove(),this.dimensionData={},this.activeSketchIds.clear()}onActiveFeatureChanged(e){this.activeFeatureId=e}getActiveFeatureId(){return this.activeFeatureId}remove(){Object.values(this.dimensionDisplays).forEach((function(e){e.remove()})),this.dimensionDisplays={}}isDimensionForDisplayedSheetMetalModel(e,t){if(!this.viewer.getIsForFlattenedDisplay())return!0;const i=this.viewer.getModelViewManagers().getManager(),s=t||i.getSelectedSheetmetalModelId(),n=this.dimensionData[e];if(n){return s===i.getDisplayedPartStudio().getSketchComponent().getSMModelIdForSketch(n.featureId)}return!0}showDimensionsWithSheetmetalModelIdOnly(e,t){for(const t in this.dimensionDisplays){const i=this.isDimensionForDisplayedSheetMetalModel(t,e),s=this.dimensionDisplays[t],n=this.dimensionData[t];i&&n&&this.shouldDisplayForFeature(n.featureId)?s&&(this.showDimension(s,!0),this.resetVisibleDimensionBounds()):s.hide()}}shouldShowDimension(e,t){return!!this.shouldDisplayForFeature(t)||!(!this.annotationPaneIsOpen||!this.persistentDimensionKeys.has(e))}shouldDisplayForFeature(e){return this.activeSketchIds.contains(e)||this.activeFeatureId===e}showDimension(e,t){e.setFeatureActive(t),e.show()}onAnnotationPaneOpenClosed(e){this.dimensionDisplays&&(this.annotationPaneIsOpen=e,Object.entries(this.dimensionDisplays).forEach((([t,i])=>{if(i.getIsAnnotationDimension()&&this.isDimensionForDisplayedSheetMetalModel(t)){const s=this.shouldDisplayForFeature(i.getFeatureId());e&&this.persistentDimensionKeys.has(t)?this.showDimension(i,s):s||i.hide()}}),this),this.resetVisibleDimensionBounds(),this.updateDimensionsToLatestFromModel())}updateDimensionsVisibility(){Object.entries(this.dimensionDisplays).forEach((([e,t])=>{if(this.isDimensionForDisplayedSheetMetalModel(e)){const i=this.shouldDisplayForFeature(t.getFeatureId());this.annotationPaneIsOpen&&this.persistentDimensionKeys.has(e)?this.showDimension(t,i):i||t.hide()}})),this.resetVisibleDimensionBounds(),this.updateDimensionsToLatestFromModel()}setPersistentDimensions(e){this.persistentDimensionKeys.clear();for(const t of e)this.persistentDimensionKeys.add(k._w.createFullyQualifiedId(t.featureId,t.constraintId,t.parameterId,t.partId));this.updateDimensionsVisibility()}updateDisplays(){let e,t;const i=[];for(e in this.dimensionDisplays)this.dimensionData.hasOwnProperty(e)||i.push(e);for(let s=0;s<i.length;++s)e=i[s],t=this.dimensionDisplays[e],t.remove(),delete this.dimensionDisplays[e];Object.entries(this.dimensionData).forEach((([e,i])=>{if(t=this.dimensionDisplays[e],!t){if(t=(0,BI.j$)(i,this.elementId,this.viewer),!t)return;this.dimensionDisplays[e]=t,this.shouldShowDimension(e,i.featureId)&&this.isDimensionForDisplayedSheetMetalModel(e)?(this.showDimension(t,this.shouldDisplayForFeature(i.featureId)),this.resetVisibleDimensionBounds()):t.hide()}if(this.viewer.getIsForFlattenedDisplay()){const e=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio(),s=e.getSketchComponent().getOwnerFlattenedBodyIdForSketch(i.featureId);if(s){const i=e.retrieveBodyMetaData(s);if(i){const s=e.getBodyComponent().getTransformFromSheetMetalBodyMetaData(i);t.setAppliedTransform(s)}}}t.updateFromDisplayData(i)}),this),this.updateDimensionsToLatestFromModel()}displaySketchAsActive(e,t){this.activeSketchIds.contains(e)!==t&&(t?this.activeSketchIds.add(e):this.activeSketchIds.remove(e),Object.entries(this.dimensionDisplays).forEach((([i,s])=>{s.getFeatureId()!==e||s.getIsAnnotationDimension()||(t&&this.isDimensionForDisplayedSheetMetalModel(i)?this.showDimension(s,t):s.hide())}),this),this.resetVisibleDimensionBounds(),this.updateDimensionsToLatestFromModel())}updateDimensionsToLatestFromModel(){const e=ea.W.getSingleton().getModelTreeState(this.elementId);e&&this.updateDimensionsFromModel(e.getModelTree())}getDimensionId(e,t,i){let s="";return i&&Bd.parameterIdsIncludedInDisplayData.includes(i)&&(s=i),k._w.createFullyQualifiedId(e,t,s)}updateDimensionsFromModel(e){const t=new Map,i=e.children;for(const e of i)if(e instanceof k.OEu&&this.activeSketchIds.contains(e.featureId))for(const i of e.constraints)for(const s of i.parameters){if(s instanceof k.nmJ){const n=this.getDimensionId(e.featureId,i.entityId,s.parameterId),r=s.getParameterForCurrentConfiguration(Ki.Jq.ConfigurationsService);t.set(n,{configured:!0,expression:Ud(r)?r?.expression:void 0});break}if(Ud(s)){const n=this.getDimensionId(e.featureId,i.entityId,s.parameterId);t.set(n,{expression:s.expression})}}Object.entries(this.dimensionDisplays).forEach((([e,i])=>{const s=t.get(e);i.setIsConfigured(s?.configured??!1),i.setExpression(s?.expression??"")}))}sketchHidden(e){this.activeSketchIds.contains(e)&&Object.values(this.dimensionDisplays).forEach((t=>{t.getFeatureId()!==e||t.getIsAnnotationDimension()||(t.hide(),this.resetVisibleDimensionBounds())}),this)}sketchShown(e){this.activeSketchIds.contains(e)&&Object.entries(this.dimensionDisplays).forEach((([t,i])=>{i.getFeatureId()===e&&!i.getIsAnnotationDimension()&&this.isDimensionForDisplayedSheetMetalModel(t)&&(this.showDimension(i,this.shouldDisplayForFeature(e)),this.resetVisibleDimensionBounds())}),this)}getDimensionGraphic(e,t,i){const s=this.getDimensionId(e,t,i);return this.dimensionDisplays[s]}getFeatureDimensionGraphic(e,t,i,s){const n=k._w.createFullyQualifiedId(e,t,i,s);return this.dimensionDisplays[n]}getUiElementForSelection(e){if(this.dimensionDisplays)return this.dimensionDisplays[e.selectionId]}getDimensionGraphicFromSketch(e){return Object.values(this.dimensionDisplays).filter((t=>t?.getDisplayData()?.featureId===e))}getDimensionBoundsForFeature(e){if(!this.shouldDisplayForFeature(e))return null;const t=new yi.kB;return Object.values(this.dimensionDisplays).forEach((function(i){i.getFeatureId()===e&&t.addBox(i.getFitBounds())}),this),t}resetVisibleDimensionBounds(){this.visibleDimensionBounds=null}getVisibleDimensionBounds(){return this.activeSketchIds.isEmpty()?null:(this.visibleDimensionBounds||(this.visibleDimensionBounds=new yi.kB,Object.values(this.dimensionDisplays).forEach((e=>{e.isVisibleToUser()&&this.visibleDimensionBounds?.addBox(e.getFitBounds())}),this)),this.visibleDimensionBounds)}}Bd.parameterIdsIncludedInDisplayData=[k.s7b.RHO_PARAMETER_NAME,k.s7b.BEZIER_DEGREE_PARAMETER_NAME,k.s7b.PATTERN_INSTANCE_COUNT1_PARAMETER_NAME,k.s7b.PATTERN_INSTANCE_COUNT2_PARAMETER_NAME];const Vd=new Set([k.s7b.LENGTH_PARAMETER_NAME,k.s7b.ANGLE_PARAMETER_NAME,k.s7b.RHO_PARAMETER_NAME,k.s7b.BEZIER_DEGREE_PARAMETER_NAME,k.s7b.PATTERN_INSTANCE_COUNT1_PARAMETER_NAME,k.s7b.PATTERN_INSTANCE_COUNT2_PARAMETER_NAME]);function Ud(e){return e instanceof k.wtM&&Vd.has(e.parameterId)}var Gd;!function(e){e[e.FACE=0]="FACE",e[e.EDGE=1]="EDGE"}(Gd||(Gd={}));class Hd{constructor(e,t,i){this.parent=e,this.viewer=t,this.idToMetaData={},this.childFeatureIds=new Set,this.removedBaseIncrements=null,this.featureVisibility={},this.insertableIdToTypeToIncrement=null,(0,Jo.Yk)(t),this.usage=void 0===i?fs.L.BASE:i,this.featureToIds=new gl.TemplatedNestedMap,this.bodyToEntity=new gl.TemplatedNestedMap}copyToClone(e){e.featureToIds=this.featureToIds.cloneNested(),e.bodyToEntity=this.bodyToEntity.cloneNested();for(const t in this.idToMetaData){const i=this.idToMetaData[t],s=(0,j.shallowClone)(i);e.idToMetaData[t]=s,s.setBodyId(i.getBodyId());const n=e.retrieveBodyMetaData(s.getBodyId());n&&s.setBodyMetaData(n);const r=i.getMeshIncrement();r&&(s.setMeshIncrement(r.clone(e.getMeshOwnerId())),e.isInstantiated()&&e.updateEntityGraphics(t,s.getMeshIncrement(),s))}}copyToPreview(e){for(const t in this.idToMetaData)e.idToMetaData[t]=this.idToMetaData[t];e.featureToIds=this.featureToIds.cloneNested(),e.bodyToEntity=this.bodyToEntity.cloneNested();for(const t in this.featureVisibility)e.featureVisibility[t]=this.featureVisibility[t]}reset(e){if(this.removedBaseIncrements=null,this.featureToIds.clear(),this.bodyToEntity.clear(),!e)for(const e in this.idToMetaData)this.removeMeshIncrement(e);this.idToMetaData={}}isInstantiated(){return!0}isForBase(){return this.usage===fs.L.BASE}getEntityIdManager(){return this.parent.getEntityIdManager()}getMeshManager(){return this.parent.getMeshManager()}getSharedBaseMeshManager(){return this.parent.getSharedBaseMeshManager()}getMeshOwnerId(){return this.parent.getMeshOwnerId()}getBodyManager(){return this.viewer.getBodyManager()}processDeletions(e){for(const t in e.deterministicIdToEntity){const i=e.deterministicIdToEntity[t];i&&(!i.isDeletion()&&this.handlesEntity(i)||this.removeEntity(t))}}processAdditionsAndChanges(e,t,i){for(const t in e.deterministicPartIdToData){const i=e.deterministicPartIdToData[t],s=this.parent.isBodyContainedInInsertableDisplayBuffers(t);for(let n=0;n<i.entityDIds.length;++n){const r=i.entityDIds[n],a=e.deterministicIdToEntity[r];if(!a||a.isDeletion()||!this.handlesEntity(a,i))continue;let o=null;(s||(o=gI(a,r,this.getEntityIdManager().getOrCreateIdForName(r)),o||!this.expectsTessellation()))&&(this.removeOldEntityGraphics(r,a),this.addIdMappings(r,a,t,e),s||(a.setMeshIncrement(o),this.isInstantiated()&&this.updateEntityGraphics(r,o,a)),this.viewer.getIsForFlattenedDisplay()===i.isForFlattenedView()&&a.removeGeometry())}}}processPrecompiledGraphicsBuffers(e){if(this.viewer.areOptimizedBuffersEnabled){this.insertableIdToTypeToIncrement||(this.insertableIdToTypeToIncrement=new Map);for(const[t,i]of Object.entries(e)){const e=Object.values(i);if(0===e.length)continue;const s=e[e.length-1];if(!s?.graphicsBuffers)continue;const n=this.retrieveBodyMetaData(t);if(n&&n.isForFlattenedView()!==this.viewer.getIsForFlattenedDisplay())continue;const r=s.graphicsBuffers,a=r[k.bdZ.POINTS],o=r[k.bdZ.LINES],h=r[k.bdZ.TRIANGLE_STRIP];if(a){const e=a[k.xB1.ARRAY_BUFFER];if(e){e.setPrimitiveType(Di.MX.POINTS);e.mapGraphicsAttributeToComponentCount[k.hOe.POINT],e.bufferData}}if(o){const e=o[k.xB1.ARRAY_BUFFER];if(e){const i=o[k.xB1.ELEMENT_ARRAY_BUFFER];if(i){i.setPrimitiveType(Di.MX.LINES);const s=new Float32Array(e.bufferData.buffer),n=new Uint32Array(i.bufferData.buffer),r=new vE(Di.MX.LINES,s,n,t+".edges",void 0,!0);r.groupId=t,this.getMeshManager().addMeshIncrement(r,this.getMeshOwnerId());let a=this.insertableIdToTypeToIncrement.get(t);a||(a=new Map,this.insertableIdToTypeToIncrement.set(t,a)),a.set(Gd.EDGE,r)}}}if(h){const e=h[k.xB1.ARRAY_BUFFER];if(e){const i=e.mapGraphicsAttributeToComponentCount[k.hOe.NORMAL],s=i&&i>0,n=h[k.xB1.ELEMENT_ARRAY_BUFFER];if(n){n.setPrimitiveType(Di.MX.TRIANGLE_STRIP);const i=new Float32Array(e.bufferData.buffer),r=new Uint32Array(n.bufferData.buffer),a=new vE(Di.MX.TRIANGLE_STRIP,i,r,t+".faces",void 0,!0);a.groupId=t,s&&a.addVertexAttribute(sE.NORMAL),this.getMeshManager().addMeshIncrement(a,this.getMeshOwnerId());let o=this.insertableIdToTypeToIncrement.get(t);o||(o=new Map,this.insertableIdToTypeToIncrement.set(t,o)),o.set(Gd.FACE,a)}}}}}}hasBody(e){return this.bodyToEntity.has(e)}retrieveBodyMetaData(e){const t=this.bodyToEntity.get(e);let i=null;return t&&t.each(((e,t)=>{const s=this.idToMetaData[t];return s&&(i=s.getBodyMetaData()),!!i})),i}retrieveAssociatedFeatureIds(e){return this.deterministicIdToAssociatedFeatureIds&&this.deterministicIdToAssociatedFeatureIds[e]||null}getEntitiesForBody(e,t){const i=this.bodyToEntity.get(e);return i?EI(i,this.idToMetaData,t):null}onAppearanceConstantsUpdated(){}onRenderingModeChanged(){}getHideableFeatureIds(){throw"This method should be overridden by a subclass"}updateEntityGraphics(e,t,i){throw"This method should be overridden by a subclass"}expectsTessellation(){return!0}getEntityCount(){return Object.keys(this.idToMetaData).length}containsEntity(e){return this.idToMetaData.hasOwnProperty(e)}getEntityMetaData(e){const t=this.idToMetaData[e];return t||null}removeEntity(e){this.removeBaseIncrement(e);this.idToMetaData[e]&&(this.removeMeshIncrement(e),this.removeIdMappings(e),this.getEntityIdManager().removeName(e))}extractMeshIncrement(e){const t=this.idToMetaData[e];return t?t.getMeshIncrement():null}addMeshIncrement(e,t){return e.pickId=this.getEntityIdManager().getOrCreateIdForName(e.id),this.getMeshManager().addMeshIncrement(e,this.getMeshOwnerId(),t)}getOccurrenceData(e){return this.viewer.getOccurrenceDataManager().getOccurrenceData(e)}getMeshIncrementDetails(e){return this.getMeshManager().getIncrementDetails(e,this.getMeshOwnerId())}getBaseMeshIncrementDetails(e){const t=this.getSharedBaseMeshManager();return t?t.getIncrementDetails(e,this.getMeshOwnerId()):null}hideMeshIncrement(e,t){const i=this.getOccurrenceData(t),s=this.getMeshIncrementDetails(e);let n=!1;return i&&s&&(n=i.hideIncrement(s,this.usage)),this.hideBaseIncrement(e,t),n}showMeshIncrement(e,t){const i=this.getOccurrenceData(t),s=this.getMeshIncrementDetails(e);let n=!1;return i&&s&&(n=i.showIncrement(s,this.usage)),this.showBaseIncrement(e,t),n}removeMeshIncrement(e){return this.getMeshManager().removeMeshIncrement(e,this.getMeshOwnerId())}setMeshIncrementRemovedFromBase(e,t){this.removedBaseIncrements||(this.removedBaseIncrements=new gl.TemplatedNestedMap),this.removedBaseIncrements.insertNested(t,e,!0)}wasIncrementRemovedFromBase(e,t){return!!this.removedBaseIncrements&&this.removedBaseIncrements.hasNested(t,e)}removeBaseIncrement(e){this.removeBaseIncrementFromOccurrence(e,Jf.KF)}removeBaseIncrementFromOccurrence(e,t){this.hideBaseIncrement(e,t)&&this.setMeshIncrementRemovedFromBase(e,t)}hideBaseIncrement(e,t){const i=this.getSharedBaseMeshManager();if(i){const s=this.getOccurrenceData(t);if(s){const t=i.getIncrementDetails(e,this.getMeshOwnerId());if(t)return s.hideIncrement(t,this.usage),!0}}return!1}showBaseIncrement(e,t){const i=this.getSharedBaseMeshManager();if(i&&!this.wasIncrementRemovedFromBase(e,t)){const s=this.getOccurrenceData(t),n=i.getIncrementDetails(e,this.getMeshOwnerId());if(s&&n)return s.showIncrement(n,this.usage),!0}return!1}removeOldEntityGraphics(e,t){this.removeEntity(e)}updateSMMapping(e,t){}addManagedIdMappings(e,t){const i=this.bodyToEntity.get(t);if(i)for(const t of i.getKeys()){const i=this.idToMetaData[t];i?!i.isDeletion()&&this.handlesEntity(i)&&(this.updateSMMapping(t,i),this.featureToIds.insertNested(e,t,!0),i.featureIds.find((t=>e===t))||(this.childFeatureIds.add(e),i.featureIds.push(e))):ut.log.warn(`entityData was not present for entityId in part studio for usage - ${this.usage} in ${this.getComponentId()}`)}}addIdMappings(e,t,i,s){this.getEntityIdManager().getOrCreateIdForName(e),this.idToMetaData[e]=t;const n=t.getFeatureIds();for(let t=0;n&&t<n.length;++t)this.featureToIds.insertNested(n[t],e,!0);t.setBodyId(i),i&&this.bodyToEntity.insertNested(i,e,!0)}removeIdMappings(e){const t=this.idToMetaData[e];if(delete this.idToMetaData[e],!t)return;const i=t.getFeatureIds();for(let t=0;t<i.length;++t)this.featureToIds.removeNested(i[t],e),this.childFeatureIds.delete(i[t]);this.bodyToEntity.removeNested(t.getBodyId(),e)}hasFeature(e){return this.featureToIds.has(e)}getEntitiesForFeature(e,t){if(this.featureIdToAssociatedDeterministicIds&&this.featureIdToAssociatedDeterministicIds.hasOwnProperty(e)){const i=new Set;for(const s of this.featureIdToAssociatedDeterministicIds[e])this.bodyToEntity.has(s)?this.bodyToEntity.get(s).each(((e,s)=>{let n=!0;if(t){const e=this.idToMetaData[s];e&&t(e)||(n=!1)}n&&i.add(s)})):i.add(s);return[...i]}{const i=this.featureToIds.get(e);return i?EI(i,this.idToMetaData,t):null}}getEntitiesForFilterFunction(e){const t=[];for(const i in this.idToMetaData)e(this.idToMetaData[i])&&t.push(i);return t}isEntityHidden(e,t){const i=e.getFeatureIds();for(let e=0;e<i.length;++e)if(this.featureVisibility[i[e]]===Fs.EE.HIDDEN)return!0;return!1}getVisibleFeatureIds(){const e=[];for(const t in this.featureVisibility)this.featureVisibility[t]!==Fs.EE.HIDDEN&&this.featureToIds.has(t)&&e.push(t);return e}hideShowFeatureEntities(e,t,i){const s=this.getEntitiesForFeature(e);if(s){for(let e=0;e<s.length;++e){const i=this.getOccurrenceIdForEntity(s[e]);this.hideShowEntity(s[e],t,i)}(0,Fs.vm)()}}hideShowFeature(e,t,i,s){this.featureVisibility[e]=t,this.hideShowFeatureEntities(e,t,s)}getFeatureVisibility(e){return this.featureVisibility.hasOwnProperty(e)?this.featureVisibility[e]:Fs.EE.VISIBLE}hideShowEntity(e,t,i){return(i=i||Jf.KF)!==Jf.Qy&&(t===Fs.EE.HIDDEN?this.hideMeshIncrement(e,i):this.showMeshIncrement(e,i))}instantiateForPartStudio(e){}instantiateEntities(){for(const e in this.idToMetaData){const t=this.idToMetaData[e],i=t.getMeshIncrement();!i&&this.expectsTessellation()||this.updateEntityGraphics(e,i,t)}}removePartStudioInstantiation(e){}getNode(){return null}getOccurrenceIdForEntity(e){return null}getOccurrenceBounds(e){const t=new yi.kB,i=this.getNode();return i&&i.getOccurrenceBounds(e,t),t}updateEntityHighlight(e,t,i,s){if(!this.idToMetaData.hasOwnProperty(i))return!1;const n=this.getOccurrenceData(s),r=this.getMeshIncrementDetails(i)||this.getBaseMeshIncrementDetails(i);return!(!n||!r)&&(n.updateEntityHighlight(e,t,r,this.usage),!0)}}class kd extends Hd{constructor(e,t,i){super(e,t,i),this.occurrences={}}addOrUpdateOccurrence(e,t){this.occurrences[e]=t}removeOccurrence(e,t){delete this.occurrences[e]}isOccurrenceIdForAssembly(e){return!!this.occurrences[e]}getComponentId(){return kd.ComponentId}}kd.ComponentId="ASSEMBLY_ENABLED_PARTSTUDIO_COMPONENT";X.default.getManager();const Wd="plane_component.";class zd{constructor(e,t,i,s){this.entityId=e,this.label="",this.center=null,this.xAxis=null,this.yAxis=null,this.update(t,i,s)}update(e,t,i){this.center=e,this.xAxis=t,this.yAxis=i}}class Xd extends Hd{constructor(e,t,i){super(e,i),this.constructionPlanes={},this.planeNames={},this.planeUi=new Map,this.usage=void 0!==t?t:fs.L.BASE}clone(e){const t=new Xd(e,this.usage,this.viewer);return this.copyToClone(t),t}cloneForPreview(e){const t=new Xd(e,fs.L.PREVIEW,this.viewer);this.copyToPreview(t);for(const e in this.constructionPlanes)t.constructionPlanes[e]=(0,z.Z)(this.constructionPlanes[e]);return this.planeUi.forEach(((e,i)=>(t.planeUi.set(i,e.cloneForPreview()),!1))),t}extractMeshIncrement(e){const t=super.extractMeshIncrement(e);if(t)return t;const i=this.planeUi.get(e);return i?i.getIncrement():null}getVisiblePlaneBounds(){const e=new yi.kB;return this.planeUi.forEach((t=>(t.isHidden||e.addBox(t.getBounds()),!1))),e}reset(){this.removeDefaultPlanesInstantiation(),this.constructionPlanes={},super.reset()}getComponentId(){return Wd}handlesEntity(e,t){return!e.hasTessellationError()&&e.isFromConstructionPlane()&&e.isFace()&&!this.viewer.getIsForFlattenedDisplay()}processAdditionsAndChanges(e,t){super.processAdditionsAndChanges(e,t),t&&this.instantiateDefaultPlanes()}updateEntityGraphics(e,t,i){t.pickId=this.getEntityIdManager().getOrCreateIdForName(e),this.updatePlaneDefinition(t,i)}getHideableFeatureIds(){return this.featureToIds.getKeys()}removeOldEntityGraphics(e,t){const i=this.idToMetaData[e];i&&i.getFirstFeatureId()!==t.getFirstFeatureId()&&this.removeEntity(e)}removeEntity(e){this.idToMetaData[e]&&(this.removePlaneUiForEntity(e),delete this.constructionPlanes[e]),super.removeEntity(e)}removePlaneUiForEntity(e){const t=this.planeUi.get(e);t&&t.remove(),this.planeUi.delete(e)}getUIElementsForSelection(e){const t=[];let i;return e.isEntity()?(i=this.planeUi.get(e.getDeterministicId()),i&&t.push(i)):e.isFeature()&&this.iterateOverEntitiesForFeature(e.getFeatureId(),(e=>{i=this.planeUi.get(e),i&&t.push(i)})),t}updatePlaneDefinition(e,t){if(!t.isFace())return;const i=e.getBounds().center(),s=C.fromValues(e.points[0],e.points[1],e.points[2]),n=C.fromValues(e.points[3],e.points[4],e.points[5]),r=C.fromValues(e.points[6],e.points[7],e.points[8]),a=ge.S4.add(s,r,C.create());ge.S4.scale(a,.5),ge.S4.subtract(a,i);const o=ge.S4.add(s,n,C.create());ge.S4.scale(o,.5),ge.S4.subtract(o,i);const h=this.constructionPlanes[e.id];h?h.update(i,a,o):this.constructionPlanes[e.id]=new zd(e.id,i,a,o)}iterateOverEntitiesForFeature(e,t){const i=this.getEntitiesForFeature(e);if(i)for(let e=0;e<i.length;++e)t.call(this,i[e])}getFeatureIdForEntity(e){const t=this.idToMetaData[e];return t?t.getFirstFeatureId():""}hideShowFeature(e,t,i){super.hideShowFeature(e,t,i),this.iterateOverEntitiesForFeature(e,(e=>{const i=this.planeUi.get(e);i&&(t===Fs.EE.HIDDEN?i.hide():i.show())}))}updateFeatureAppearance(e,t){this.iterateOverEntitiesForFeature(e,(e=>{const i=this.planeUi.get(e);i&&i.updateAppearance(t)}))}overrideinstantiateForPartStudio(e){super.instantiateForPartStudio(e),this.instantiateDefaultPlanes()}removePartStudioInstantiation(e){super.removePartStudioInstantiation(e),this.removeDefaultPlanesInstantiation()}instantiateDefaultPlanes(){const e=[];this.planeUi.forEach(((t,i)=>(this.constructionPlanes.hasOwnProperty(i)||e.push(i),!1)));for(let t=0;t<e.length;++t)this.removePlaneUiForEntity(e[t]);const t=ws()?"CONSTRUCTION_PLANE_COMPARE_TEXT_COLOR":"CONSTRUCTION_PLANE_TEXT_COLOR";for(const e in this.constructionPlanes){let i=this.planeUi.get(e);const s=this.constructionPlanes[e];i||(i=void 0!==this.usage&&this.usage===fs.L.PREVIEW?new AM(t,s.entityId,Zo.Vv,this.getFeatureIdForEntity(e),this.viewer):new AM(t,s.entityId,Zo.lL,this.getFeatureIdForEntity(e),this.viewer),this.planeUi.set(e,i)),i.updateDefinition(s.label,s.center,s.xAxis,s.yAxis,!1);const n=this.idToMetaData[e];if(n instanceof k.kdl){const e=n.getLastFeatureId();this.featureVisibility[e]===Fs.EE.HIDDEN?i.hide():i.show()}}}getPartStudioPlaneOccurrenceIds(){const e=[];return this.planeUi.forEach((t=>(e.push(t.graphicsOccurrenceId),!1))),e}getSelectionOccurrenceId(e){const t=this.planeUi.get(e.getDeterministicId());return t?t.graphicsOccurrenceId:Jf.Qy}removeDefaultPlanesInstantiation(){this.planeUi.forEach((e=>{e.remove()})),this.planeUi.clear()}setPlaneName(e,t){this.planeNames[e]=t,this.iterateOverEntitiesForFeature(e,(e=>{const i=this.constructionPlanes[e];i&&(i.label=t);const s=this.planeUi.get(e);s&&s.setName(t)}))}}var Zd=i(74300);const qd=X.default.getManager();class Yd extends Ti.u1{constructor(e,t,i){super(t),this.inferenceData=e,this.hovered=!1,this.selected=!1,this.lastScale=-1,this.lastPickScale=-1;const s=this.inferenceData.isInContextEntity?de.create():this.getOccurrenceTransform(this.inferenceData.occurrence,i);this.worldSpaceTransform=ge.w$.multiply(s,this.inferenceData.coordinateSystem.getGlMatrix()),this.worldSpacePosition=[this.worldSpaceTransform[12],this.worldSpaceTransform[13],this.worldSpaceTransform[14]],this.inferenceId=Si.JE,(0,Fs.vm)()}setInferenceId(e){this.inferenceId=e}getInferenceId(){return this.inferenceId}onDevicePixelRatioChanged(e){this.updateGraphics()}setHovered(e){e!==this.hovered&&(this.hovered=e,this.updateGraphics())}getOccurrenceTransform(e,t){return t?t(e.getPathAsString()):this.viewer.getModelViewManagers().getManager().getOccurrenceTransform(e)}onViewWillDraw(e,t){this.updateTransform(e)}updateTransform(e){const t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition);if(Math.abs(this.lastScale-t)<Ci.W.ZERO_LENGTH)return;this.lastScale=t;const i=de.create();i[0]=t,i[5]=t,i[10]=t,this.setTransform(ge.w$.multiply(this.worldSpaceTransform,i,de.create())),this.hasMeshIncrements()||this.updateGraphics()}isAxialInference(e){return e===Zd.i.TOP_AXIS_POINT||e===Zd.i.MID_AXIS_POINT||e===Zd.i.BOTTOM_AXIS_POINT||e===Zd.i.LOOP_CENTER||e===Zd.i.CENTER}updateGraphicsNoHover(e){this.isAxialInference(this.inferenceData.inferenceType)?(this.updateMeshIncrement(rl.TRIANGLES,Ti.ZJ,e[rl.INFERENCE_CENTER_TRIANGLES].clone(),tl),this.updateMeshIncrement(rl.LINES,Ti.ZJ,e[rl.INFERENCE_CENTER_LINES].clone(),$c)):this.inferenceData.inferenceType===Zd.i.MID_POINT?(this.updateMeshIncrement(rl.TRIANGLES,Ti.ZJ,e[rl.INFERENCE_MID_POINT_TRIANGLES].clone(),tl),this.updateMeshIncrement(rl.LINES,Ti.ZJ,e[rl.INFERENCE_MID_POINT_LINES].clone(),$c)):this.inferenceData.inferenceType===Zd.i.CENTROID?(this.updateMeshIncrement(rl.TRIANGLES,Ti.ZJ,e[rl.INFERENCE_CENTROID_TRIANGLES].clone(),tl),this.updateMeshIncrement(rl.LINES,Ti.ZJ,e[rl.INFERENCE_CENTROID_LINES].clone(),$c)):this.isOriginAxisInference()?(this.updateMeshIncrement(rl.TRIANGLES,rl.INFERENCE_ORIGIN_AXIS_LINES,e[rl.INFERENCE_POINT_TRIANGLES].clone(),tl),this.updateMeshIncrement(rl.LINES,rl.INFERENCE_ORIGIN_AXIS_LINES,e[rl.INFERENCE_ORIGIN_AXIS_LINES].clone(),$c),this.removeMeshIncrement(rl.INFERENCE_ORIGIN_AXIS_LINES_PRESELECTED)):(this.updateMeshIncrement(rl.TRIANGLES,Ti.ZJ,e[rl.INFERENCE_POINT_TRIANGLES].clone(),tl),this.updateMeshIncrement(rl.LINES,Ti.ZJ,e[rl.INFERENCE_POINT_LINES].clone(),$c))}isOriginAxisInference(){return this.inferenceData&&(this.inferenceData.inferenceType===Zd.i.ORIGIN_X||this.inferenceData.inferenceType===Zd.i.ORIGIN_Y||this.inferenceData.inferenceType===Zd.i.ORIGIN_Z)}updateGraphics(){const e=cl();this.hovered?(this.updateMeshIncrement(rl.TRIANGLES,Ti.ZJ,e[rl.TRIANGLES_PRESELECTED].clone(),tl),this.updateMeshIncrement(rl.LINES,Ti.ZJ,e[rl.LINES].clone(),$c),this.isOriginAxisInference()&&this.updateMeshIncrement(rl.INFERENCE_ORIGIN_AXIS_LINES_PRESELECTED,rl.INFERENCE_ORIGIN_AXIS_LINES_PRESELECTED,e[rl.INFERENCE_ORIGIN_AXIS_LINES_PRESELECTED].clone(),$c)):this.updateGraphicsNoHover(e)}updateOccurrenceTransform(e){if(this.inferenceData){this.worldSpaceTransform=ge.w$.multiply(e,this.inferenceData.coordinateSystem.getGlMatrix()),this.worldSpacePosition=[this.worldSpaceTransform[12],this.worldSpaceTransform[13],this.worldSpaceTransform[14]];const t=de.create();t[0]=this.lastScale,t[5]=this.lastScale,t[10]=this.lastScale,this.setTransform(ge.w$.multiply(this.worldSpaceTransform,t,de.create())),this.hasMeshIncrements()||this.updateGraphics(),(0,Fs.vm)()}}getUpdatedPickIncrement(e,t){let i=null;if(this.isOriginAxisInference()){const s=t.getPixelSizeAtWorldPoint(this.worldSpacePosition);if(Math.abs(s-this.lastPickScale)>Ci.W.ZERO_LENGTH){const t=de.create();t[0]=s,t[5]=s,t[10]=s;const n=5*qd.getNumber("MATE_CONNECTOR_AXIS_LINE_LENGTH_PX"),r=3*qd.getNumber("MATE_CONNECTOR_Z_AXIS_LINE_WIDTH"),a=[0,0,n*s],o=ge.w$.multiplyVec3(this.worldSpaceTransform,a,C.create());i=(0,Au.W5)([0,0,0],o,e?.toString(),void 0,r),i.id=e?.toString(),this.lastPickScale=s}}else 1!==this.lastPickScale&&(i=(0,Au.Pu)(this.worldSpacePosition,e?.toString()),this.lastPickScale=1);return i&&(i.pickId=e),i}}class Kd extends Yd{constructor(e,t){super(e,t)}updateGraphics(){const e=cl();this.updateGraphicsNoHover(e)}}const jd=new xi.hF({isShowThrough:!0,isDepthTested:!1,isPickable:!1,primitiveType:Di.MX.LINES}),Qd=X.default.getManager();class $d extends Ti.u1{constructor(e){super(e)}updateLines(e){(0,Au.VQ)(Qd.getNumber("INFERENCE_SNAP_LINE_WIDTH"),e),(0,Au.Ab)(Qd.getColor("INFERENCE_SNAP_LINE_COLOR"),e),this.updateMeshIncrement("lines",Ti.ZJ,e,jd)}}const Jd=C.fromValues(1,0,0),eg=C.fromValues(0,1,0),tg=C.fromValues(0,0,1),ig=C.fromValues(0,1,0);var sg;!function(e){e.ACCELERATION_ARROW="ACCELERATION_ARROW",e.ACCELERATION_BEHIND="ACCELERATION_BEHIND",e.BEARING_ARROWS="BEARING_ARROWS",e.FORCE_ARROW="FORCE_ARROW",e.MOMENT_BASE="MOMENT_BASE",e.PRESSURE="PRESSURE",e.PRESSURE_FLIPPED="PRESSURE_FLIPPED",e.ROUND_BASE="ROUND_BASE"}(sg||(sg={}));const ng={};ng[sg.ACCELERATION_ARROW]="simulation/acceleration-arrow",ng[sg.ACCELERATION_BEHIND]="simulation/acceleration-behind",ng[sg.BEARING_ARROWS]="simulation/bearing-arrows",ng[sg.FORCE_ARROW]="simulation/force-arrow",ng[sg.MOMENT_BASE]="simulation/moment-base",ng[sg.PRESSURE]="simulation/pressure",ng[sg.PRESSURE_FLIPPED]="simulation/pressure-flipped",ng[sg.ROUND_BASE]="simulation/base";const rg=X.default.getManager().getNumber("SIMULATION_LOAD_LEADER_OFFSET_RATIO"),ag=new xi.hF({primitiveType:Di.MX.LINES,isShowThrough:!1,isDepthTested:!0,isPickable:!1}),og=ag.cloneAndModify({isShowThrough:!0,isDepthTested:!1,isStencilTested:!0}),hg="obliqueBaseLine",cg=Math.cos((0,yi.Yr)(90-X.default.getManager().getNumber("SIMULATION_LOAD_OBLIQUE_BASE_LINE_ANGLE_THRESHOLD_DEGREES"))),lg=X.default.getManager().getColor("SIMULATION_LOAD_BASE_COLOR"),ug=X.default.getManager().getColor("SIMULATION_PRE_HIGHLIGHT_COLOR"),dg=X.default.getManager().getColor("SIMULATION_HIGHLIGHT_COLOR"),gg=ag.cloneAndModify({primitiveType:Di.MX.LINES,isShowThrough:!0,isDepthTested:!1,isPickable:!0}),pg="loadComponent",mg="lineAxis",fg=X.default.getManager().getStipple("SIMULATION_LINE_AXIS_STIPPLE"),Ig=C.create(),Eg=C.create(),Sg=(C.create(),C.create(),X.default.getManager().getNumber("SIMULATION_LOAD_GLYPH_SIZE"));class Tg{constructor(e,t,i){this.leftPoint=e,this.rightPoint=t,this.color=i}equals(e){return!!e&&(C.equals(this.leftPoint,e.leftPoint)&&C.equals(this.rightPoint,e.rightPoint)&&(0,li.arraysEqual)(this.color,e.color))}}class Dg extends Ti.u1{constructor(e,t,i,s){super(t),this.loadDisplayManager=e,this.loadDisplayData=i,this.hideLoad=s,this.worldAnchorPoint=null,this.worldOrigin_=null,this.worldXAxis=null,this.worldYAxis=null,this.worldZAxis=null,this.adjustedWorldOrigin=C.create(),this.leaderRay=null,this.occupiedScreenBounds=new yi.tO,this.glyphComponents=[],this.targetId_="",this.offsetInLeaderDirection_=0,this.hideLeader=!1,this.isBeingEdited=!1}setHideLoads(e){this.hideLoad!==e&&(this.hideLoad=e,this.updateHideState(),this.updateGraphics(this.loadDisplayData))}setEditState(e){this.isBeingEdited=e,this.updateHideState(),this.updateGraphics(this.loadDisplayData)}updateHideState(){!this.hideLoad||this.isHighlighted()||this.isBeingEdited?(this.show(),this.updateGraphics(this.loadDisplayData)):this.hide()}hide(){super.hide(),this.glyphComponents.forEach((e=>{e.hide()}))}show(){super.show(),this.glyphComponents.forEach((e=>{e.show()}))}remove(){this.clearComponents(),super.remove()}update(e){const t=e||this.loadDisplayData;t&&(this.hideLoad=this.shouldBeHidden(t),this.updateHideState(),this.updateGraphics(t))}shouldBeHidden(e){return!Ki.Jq.SimulationService.getCanAccessSimulations()||(!!e.hidden||(!(!this.loadDisplayManager||!this.loadDisplayManager.getExplodeViewActive())||!!this.occurrenceIsHidden(e.occurrence)))}removeMeshIncrements(){super.removeMeshIncrements(),this.lastObliqueBaseLineDisplayed=null,this.lastLineAxisDisplayed=null}updateGraphics(e){if(this.viewer.requestDraw(),this.loadDisplayData=e,this.isHidden)return void this.removeMeshIncrements();switch(this.clearComponents(),this.clearPositionalData(),e.loadType){case k.DzI.ACCELERATION:case k.DzI.BEARING_LOAD:case k.DzI.FORCE:case k.DzI.MOMENT:if(C.squaredLength(this.loadDisplayData.componentValues.getVec3())<Ci.W.ZERO_LENGTH_SQUARED)return}if(this.computePositionalData(),!this.isValid)return;const t=e.status===k.EFx.SUPPRESSED?Cl.SUPPRESSED:Cl.NORMAL;switch(e.loadType){case k.DzI.ACCELERATION:this.addBaseGlyph(sg.ROUND_BASE,t),this.addDirectionGlyph(sg.ACCELERATION_ARROW,t),this.addDirectionGlyph(sg.ACCELERATION_BEHIND,t,!0);break;case k.DzI.BEARING_LOAD:this.addBaseGlyph(sg.ROUND_BASE,t),this.addDirectionGlyph(sg.BEARING_ARROWS,t);break;case k.DzI.FORCE:this.addBaseGlyph(sg.ROUND_BASE,t),this.addDirectionGlyph(sg.FORCE_ARROW,t);break;case k.DzI.MOMENT:this.addBaseGlyph(sg.MOMENT_BASE,t);break;case k.DzI.PRESSURE:this.addPressureGlyph(t,e.isDirectionFlipped)}const i=this.getHighlight();i&&this.addHighlightToComponents(i),this.updateTargetId()}get scaledGlyphSize(){return Sg*(0,Ji.x_)()}updateViewDependentGraphics(e){if(!this.isValid||this.isHidden)return void this.removeMeshIncrements();if(!this.viewer.getResources().loadGlyphResources.atlasReady)return;const t=X.default.getManager(),i=e.getPixelSizeAtWorldPoint(this.worldOrigin_),s=this.scaledGlyphSize;for(let e=0;e<this.glyphComponents.length;++e)this.glyphComponents[e].setWorldOrigin(this.adjustedWorldOrigin);const n=this.getDistanceFromOriginToGlyphEdge(!0)+t.getNumber("SIMULATION_LOAD_LEADER_GAP_PX"),r=this.leaderWorldDistance+this.offsetInLeaderDirection_-i*n;if(this.hideLeader||r<0)this.removeMeshIncrement("leader"),this.removeMeshIncrement("leader-st");else{const e=(0,Au.W5)(this.worldAnchorPoint,this.leaderRay?.evaluate(r));(0,Au.Ab)(t.getColor("SIMULATION_LOAD_LEADER_LINE_COLOR"),e),this.updateMeshIncrement("leader",Ti.ZJ,e,ag);const i=e.clone();(0,Au.Ab)(t.getColor("SIMULATION_LOAD_LEADER_HIDDEN_LINE_COLOR"),i),this.updateMeshIncrement("leader-st",Ti.ZJ,i,og)}const a=Math.abs(C.dot(e.getDirectionToWorldPoint(this.adjustedWorldOrigin),this.worldZAxis));if(a<cg&&this.usesBaseGlyph){const t=ge.S4.normalize(ge.S4.cross(e.getForward(),this.worldZAxis,Ig)),n=i*s*.5,r=this.getColorWithHighlight(lg).slice();r[3]=1-a/cg;const o=new Tg(C.subtract(C.create(),this.adjustedWorldOrigin,C.scale(Eg,t,-n)),C.subtract(C.create(),this.adjustedWorldOrigin,C.scale(Eg,t,n)),r);if(!o.equals(this.lastObliqueBaseLineDisplayed)){const e=(0,Au.W5)(o.leftPoint,o.rightPoint);(0,Au.Ab)(r,e),this.updateMeshIncrement(hg,pg,e,gg),this.lastObliqueBaseLineDisplayed=o}}else this.removeMeshIncrement(hg),this.lastObliqueBaseLineDisplayed=null;if(this.showLineAxis){const e=i*s*.25,t=new Tg(C.subtract(C.create(),this.adjustedWorldOrigin,C.scale(Eg,this.worldZAxis,-e)),C.subtract(C.create(),this.adjustedWorldOrigin,C.scale(Eg,this.worldZAxis,e)),this.getColorWithHighlight(X.default.getManager().getColor("SIMULATION_LINE_AXIS_COLOR")));if(!t.equals(this.lastLineAxisDisplayed)){const e=(0,Au.W5)(t.leftPoint,t.rightPoint);(0,Au.Ab)(t.color,e),(0,Au.KZ)(fg,e),this.updateMeshIncrement(mg,pg,e,gg),this.lastLineAxisDisplayed=t}}else this.removeMeshIncrement(mg),this.lastLineAxisDisplayed=null}getModelSelection(e){const t=new Ce.Y1(k.lQt.OCCURRENCE,this.loadDisplayData.occurrence);return new Ce.Y1(k.lQt.SIMULATION_LOAD,this.loadDisplayData.nodeId,this.loadDisplayData.ownerOccurrence,{childSelections:[t]})}addHighlight(e){super.addHighlight(e),this.updateHideState(),this.addHighlightToComponents(e)}addHighlightToComponents(e){for(let t=0;t<this.glyphComponents.length;t++)this.glyphComponents[t].addHighlight(e)}removeHighlight(e){const t=super.removeHighlight(e);for(let t=0;t<this.glyphComponents.length;t++)this.glyphComponents[t].removeHighlight(e);return this.updateHideState(),t}get leaderDirection(){return this.leaderRay?.direction}set offsetInLeaderDirection(e){this.offsetInLeaderDirection_=e;const t=this.leaderWorldDistance+this.offsetInLeaderDirection_;this.leaderRay?.evaluate(t,this.adjustedWorldOrigin)}get offsetInLeaderDirection(){return this.offsetInLeaderDirection_}get worldOrigin(){return this.worldOrigin_}get targetId(){return this.targetId_}updateTargetId(){const e=this.loadDisplayData.faceLoadDeterministicIds.slice();e.sort(),this.targetId_=this.loadDisplayData.occurrence.toString()+"-"+e}getDistanceFromOriginToGlyphEdge(e){const t=this.scaledGlyphSize,i=e?-1:1,s=Math.max(0,this.getDirectionGlyphLength()*i*C.dot(this.worldZAxis,this.leaderRay?.direction)),n=C.dot(this.worldZAxis,this.leaderRay?.direction);return(this.usesBaseGlyph?Math.sqrt(1-n*n)*t*.5:.5*t)+s}getOccupiedScreenBounds(e,t){if(this.isHidden)return this.occupiedScreenBounds.reset(),this.occupiedScreenBounds;const i=this.scaledGlyphSize;if(this.usesBaseGlyph){this.occupiedScreenBounds.reset();for(let s=-.5;s<=.5;s+=1){for(let n=-.5;n<=.5;n+=1){let n=ge.S4.add(this.adjustedWorldOrigin,ge.S4.scale(this.worldXAxis,s*t*i,Eg),Ig);n=ge.S4.add(n,ge.S4.scale(this.worldYAxis,s*t*i,Eg),Ig),this.occupiedScreenBounds.addPoint(e.projectWorldPointToCanvas(n))}const n=ge.S4.add(this.adjustedWorldOrigin,ge.S4.scale(this.worldZAxis,t*this.getDirectionGlyphLength(),Eg),Ig);this.occupiedScreenBounds.addPoint(e.projectWorldPointToCanvas(n))}}else this.occupiedScreenBounds.makeCenteredBoxOnPoint(e.projectWorldPointToCanvas(this.adjustedWorldOrigin),i*t);return this.occupiedScreenBounds}clearComponents(){for(let e=0;e<this.glyphComponents.length;++e)this.glyphComponents[e].remove();this.glyphComponents=[],this.removeMeshIncrements()}get assembly(){return this.viewer.getModelViewManagers().getManager().getDisplayedAssembly()}clearPositionalData(){this.worldAnchorPoint=null,this.worldOrigin_=null,this.worldXAxis=null,this.worldYAxis=null,this.worldZAxis=null,this.leaderRay=null}get isValid(){return!!(this.worldAnchorPoint&&this.worldOrigin_&&this.worldXAxis&&this.worldYAxis&&this.worldZAxis)}updateWorldZAxisWithPartStudioMateConnector(){const e=k._oC.getOccurrenceFromPathString(this.loadDisplayData.directionMateConnectorId),t=e.getOccurrenceWithoutTail().getPathAsString(),i=this.assembly.getOccurrences()[t];if(i){const t=i.fullElementId.toString(),s=this.assembly.elementAccessor.getPartStudio(t);if(s){const t=i.occurrenceData,n=t.transform.getGlMatrix(),r=s.getMateConnectorData(t.occurrence,e.getTailNodeId());if(r){const e=r.location.getGlMatrix();this.updateWorldZAxisInternal(n,e)}else ut.log.warn("Unable to find mate connector display data")}else ut.log.warn("Unable to find part studio element")}else ut.log.warn("Unable to find part studio display data")}updateWorldZAxisInternal(e,t){if(e&&t){const i=ge.w$.multiply(e,t,de.create());this.worldZAxis=ge.S4.normalize(ge.w$.multiplyVec4(i,(0,yi.Ot)(this.loadDisplayData.componentValues.getVec3(),0)))}else ut.log.warn("Unable to identify load direction.")}updateWorldZAxis(){if(this.worldZAxis=C.clone(eg),this.loadDisplayData){if(this.loadDisplayData.directionMateConnectorId){const e=this.assembly.mateConnectorData[this.loadDisplayData.directionMateConnectorId];if(e){const t=e.location.getGlMatrix(),i=this.assembly.getOccurrences()[e.occurrence.getPathAsString()];if(!i)return void ut.log.warn("Mate connector occurrence was falsey. World Z Axis was not updated.");const s=i.occurrenceData.transform.getGlMatrix();this.updateWorldZAxisInternal(s,t)}else this.updateWorldZAxisWithPartStudioMateConnector()}this.loadDisplayData.isDirectionFlipped&&(this.worldZAxis=ge.S4.negate(this.worldZAxis))}}computePositionalData(){const e=C.clone(Jd),t=this.getBounds();if(!t||!t.isFinite())return;const i=t.center(),s=this.viewer.getModelBounds();if(C.dot(e,ge.S4.subtract(i,s.center(),C.create()))<-Ci.W.ZERO_LENGTH&&ge.S4.negate(e),this.updateAnchorPoint(ge.S4.add(i,ge.S4.scale(e,t.diameter()/2,C.create()),C.create())),!this.worldAnchorPoint)return;let n=0;const r=s.getCorners();if(!r)return;const a=C.dot(this.worldAnchorPoint,e);for(let t=0;t<r.length;++t){const i=C.dot(r[t],e)-a;i>n&&(n=i)}this.worldOrigin_=ge.S4.add(this.worldAnchorPoint,ge.S4.scale(e,n+rg*s.diameter(),C.create()),C.create()),this.updateWorldZAxis(),(0,ar.areUnitVectorsParallel)(tg,this.worldZAxis)?this.worldXAxis=ge.S4.normalize(ge.S4.cross(ig,this.worldZAxis,C.create())):this.worldXAxis=ge.S4.normalize(ge.S4.cross(tg,this.worldZAxis,C.create())),this.worldYAxis=ge.S4.normalize(ge.S4.cross(this.worldZAxis,this.worldXAxis,C.create()));const o=ge.S4.subtract(this.worldOrigin_,this.worldAnchorPoint,C.create());this.leaderWorldDistance=ge.S4.length(o),this.leaderRay=new yi.zH(this.worldAnchorPoint,o)}updateAnchorPoint(e){this.worldAnchorPoint=null;const t=this.viewer.getModelViewManagers().getManager();let i;const s=this.loadDisplayData.occurrence;if(this.loadDisplayData.faceLoadDeterministicIds.length>0)i=this.loadDisplayData.faceLoadDeterministicIds;else{const e=t.getOccurrenceDisplayData(s);if(!e)return void ut.log.debug("Failed to find occurrence display data for load");const n=t.getPartStudioDataFromOccurrence(s);if(!n)return void ut.log.debug("Failed to find part studio display data for load");i=[];for(const t of e.displayedPartIds)i=i.concat(n.getEntitiesForBody(t))}if(!i||0===i.length)return void ut.log.debug("No deterministic ids to use for load anchor point");const n=t.getOccurrenceTransform(s);if(!n)return void ut.log.debug("Failed to find occurrence transform for load");const r=ge.w$.multiplyVec3(ge.w$.inverse(n,de.create()),e,C.create());let a=null;for(let e=0;e<i.length;++e){const n=t.extractMeshIncrement(i[e],s);if(n){const e=n.getPositionNearPoint(r);e.position&&(!a||e.distance<a.distance)&&(a=e)}}a?this.worldAnchorPoint=ge.w$.multiplyVec3(n,a.position):ut.log.debug("Failed to find anchor point for load display")}getBounds(){if(this.loadDisplayData.faceLoadDeterministicIds.length>0){const e=new yi.kB;for(let t=0;t<this.loadDisplayData.faceLoadDeterministicIds.length;++t)e.addBox(this.viewer.getModelViewManagers().getManager().getEntityBounds(this.loadDisplayData.faceLoadDeterministicIds[t],this.loadDisplayData.occurrence));return e}return this.assembly.getOccurrenceBounds(this.loadDisplayData.occurrence)}addBaseGlyph(e,t){const i=new wl(this.viewer,this.viewer.getResources().loadGlyphResources,e,t,Sg,xi.DO.DEFAULT,this.worldOrigin_,this.worldXAxis,this.worldYAxis,this);this.glyphComponents.push(i)}addDirectionGlyph(e,t,i){const s=i?ge.S4.scale(this.worldZAxis,-1,C.create()):this.worldZAxis,n=new Nl(this.viewer,this.viewer.getResources().loadGlyphResources,e,t,Sg,xi.DO.DEFAULT,this.worldOrigin_,s,[.5,0],this);this.glyphComponents.push(n)}addPressureGlyph(e,t){const i=t?sg.PRESSURE_FLIPPED:sg.PRESSURE,s=new _l(this.viewer,this.viewer.getResources().loadGlyphResources,i,e,Sg,xi.DO.DEFAULT,this.worldOrigin_,[.5,.5],this);this.glyphComponents.push(s)}get usesBaseGlyph(){return this.loadDisplayData.loadType!==k.DzI.PRESSURE}get showLineAxis(){return this.loadDisplayData.loadType===k.DzI.MOMENT}getColorWithHighlight(e){const t=this.getHighlight();return t?t.type===dn.o2.PRE?ug:dg:e}getDirectionGlyphLength(){switch(this.loadDisplayData.loadType){case k.DzI.ACCELERATION:case k.DzI.BEARING_LOAD:case k.DzI.FORCE:return this.scaledGlyphSize;case k.DzI.MOMENT:return.25*this.scaledGlyphSize}return 0}occurrenceIsHidden(e){const t=this.assembly.getDisplayDataForOccurrence(e);return!!t&&t.isHidden}}const Mg=C.create();class Cg{constructor(){this.loadDisplays=[],this.occupiedScreenBounds=new yi.tO}addDisplay(e){this.loadDisplays.push(e)}arrangeAndUpdateForView(e,t){if(0===this.loadDisplays.length||!this.loadDisplays[0].isValid)return;const i=this.loadDisplays[0].worldOrigin,s=this.loadDisplays[0].leaderDirection,n=this.loadDisplays[0].scaledGlyphSize,r=e.getPixelSizeAtWorldPoint(i),a=X.default.getManager().getNumber("SIMULATION_INTER_LOAD_GAP_PX");let o=0,h=!1;for(let e=0;e<this.loadDisplays.length;++e){const t=this.loadDisplays[e];t.isHidden||(0!==e&&(o+=r*t.getDistanceFromOriginToGlyphEdge(!0)),t.hideLeader=h,h=!0,t.offsetInLeaderDirection=o,o+=r*Math.max(t.getDistanceFromOriginToGlyphEdge(!1),a))}this.occupiedScreenBounds.reset();for(let t=0;t<this.loadDisplays.length;++t)this.occupiedScreenBounds.addBox(this.loadDisplays[t].getOccupiedScreenBounds(e,r));const c=e.projectWorldDirectionToCanvas(i,ge.S4.scale(s,r*n,Mg));ge.gv.normalize(c);let l=t.getUnoccupiedOffsetAlongDirection(this.occupiedScreenBounds,c);if(l>0){l+=a;const e=l*r;for(let t=0;t<this.loadDisplays.length;++t){const i=this.loadDisplays[t];i.offsetInLeaderDirection=i.offsetInLeaderDirection+e}this.occupiedScreenBounds.translate(ge.gv.scale(c,l))}t.addOccupiedRegion(this.occupiedScreenBounds);for(let t=0;t<this.loadDisplays.length;++t)this.loadDisplays[t].updateViewDependentGraphics(e)}}class yg extends Ti.u1{constructor(e){super(e),this.loadDisplayData=new Map,this.loadDisplays=new Map,this.groupedLoadDisplays=new Map,this.loadDisplayOccupancyMap=new Ri,this.explodeViewActive=!1,this.mateConnectorIdToLoads=new Map,this.loadResources(),Ki.Jq.SimulationService.getCanAccessSimulationsObservable().subscribe((e=>{for(const t of this.loadDisplays.values())t.setHideLoads(!e),this.show()}))}setEditState(e,t){const i=this.loadDisplays.get(e);i&&i.setEditState(t)}reset(){this.clearLoadDisplays(),this.loadDisplayData.clear(),this.mateConnectorIdToLoads.clear()}hide(){this.isHidden=!0,this.clearLoadDisplays()}show(){this.isHidden=!1,this.updateLoadDisplays(this.loadDisplayData.values(),!0)}onAppearanceConstantsUpdated(){this.isHidden||(this.clearLoadDisplays(),this.updateLoadDisplays(this.loadDisplayData.values(),!0))}setExplodeViewActive(e){if(this.explodeViewActive!==e)if(this.explodeViewActive=e,e)this.clearLoadDisplays();else{const e=!0;this.updateLoadDisplays(this.loadDisplayData.values(),e)}}getExplodeViewActive(){return this.explodeViewActive}static getMateConnectorPath(e){return e.ownerOccurrence.createOccurrenceWithTailAppended(e.nodeId).getPathAsString()}processUpdates(e,t){if(!this.assembly)return;if(e.isCollapsible)return void this.hide();t&&this.isHidden&&!this.explodeViewActive&&this.show();for(const t of e.deletedLoads){const e=this.loadDisplays.get(t);e&&(e.remove(),this.loadDisplays.delete(t));const i=this.loadDisplayData.get(t);if(i){const e=i.directionMateConnectorId;if(e){const i=this.mateConnectorIdToLoads.get(e);i&&(i.delete(t),0===i.size&&this.mateConnectorIdToLoads.delete(e))}}this.loadDisplayData.delete(t)}const i=new Set(e.mateConnectors.map((e=>yg.getMateConnectorPath(e))));for(const t of e.occurrences){const e=this.assembly.getMateConnectorsForOccurrence(t.occurrenceData.occurrence);for(let t=0;t<e.length;t++)i.add(yg.getMateConnectorPath(e[t]))}this.updateLoadDisplays(e.loads.values(),t,Array.from(i))}processDeletedMateConnector(e){this.mateConnectorIdToLoads.delete(e)}getUiElementsForSelection(e){if(!e.isSimulationLoad())return[];const t=this.loadDisplays.get(e.getIdString());return t?[t]:[]}getDisplayDataForSelection(e){return e.isSimulationLoad()?this.loadDisplayData.get(e.getIdString()):null}onViewWillDraw(e){this.loadDisplayOccupancyMap.clearOccupiedRegions();for(const[t,i]of this.groupedLoadDisplays)i.arrangeAndUpdateForView(e,this.loadDisplayOccupancyMap)}updateDirectionMateConnectorToLoad(e){const t=e.nodeId,i=e.directionMateConnectorId,s=this.loadDisplayData.get(t);if(s){const e=s.directionMateConnectorId;if(e&&e!==i){const i=this.mateConnectorIdToLoads.get(e);i&&i.delete(t)}}if(i){const e=this.mateConnectorIdToLoads.get(i);e?e.add(t):this.mateConnectorIdToLoads.set(i,new Set([t]))}}updateLoadDisplays(e,t,i){for(const i of e){const e=i.nodeId;if(this.updateDirectionMateConnectorToLoad(i),this.loadDisplayData.set(e,i),t){let t=this.loadDisplays.get(e);if(!t){const s=i.hidden||!Ki.Jq.SimulationService.getCanAccessSimulations();t=new Dg(this,this.viewer,i,s),this.loadDisplays.set(e,t)}t.update(i)}}if(i)for(let e=0;e<i.length;e++)this.processMateConnectorChange(i[e]);this.setupAssemblyListeners(),this.groupedLoadDisplays.clear();for(const[e,t]of this.loadDisplays){if(!t.isValid)continue;let e=this.groupedLoadDisplays.get(t.targetId);e||(e=new Cg,this.groupedLoadDisplays.set(t.targetId,e)),e.addDisplay(t)}}processMateConnectorChange(e){const t=this.mateConnectorIdToLoads.get(e);t&&t.forEach((e=>{const t=this.loadDisplays.get(e);t&&t.update()}))}setupAssemblyListeners(){this.stopListening(this.assembly);const e=new Set;for(const t of this.loadDisplays.keys()){const i=this.loadDisplayData.get(t).occurrence.getPathAsString();e.add(i)}for(const t of e)this.listenTo(this.assembly,"OCCURRENCE_DATA_CHANGE."+t,this.show)}clearLoadDisplays(){for(const[e,t]of this.loadDisplays)t.remove();this.loadDisplays.clear(),this.groupedLoadDisplays.clear(),this.stopListening()}loadResources(){if(!this.viewer.getResources().loadGlyphResources){const e="LOAD_GLYPHS",t=48,i=[1,2],s=!0;this.viewer.getResources().loadGlyphResources=new Pg(e,this.viewer,ng,t,i,{clearColorOverride:[255,255,255,0],useMipMappingAndAnisotropicFiltering:!0},s)}}get assembly(){return this.viewer.getModelViewManagers().getManager().getDisplayedAssembly()}}class Pg extends Ol{getAtlasBackgroundColor(e,t){return"rgba(0, 0, 0, 0.0)"}getAtlasTextureName(e,t,i){let s="";return i!==Pl.NO_HIGHLIGHT?s="_"+i:t===Cl.SUPPRESSED&&(s+=yl[t]),this.textures[e]+s+this.getSystemStateSuffix()+".png"}initializeNodeProperties(){for(const e in Pl)for(const t in Cl){const i=this.getNodePropertyKey(e,t,xi.DO.DEFAULT);this.nodeProperties[i]=new xi.hF({primitiveType:Di.MX.TRIANGLES,isShowThrough:!1,isDepthTested:!1,isTwoSided:!0,priority:xi.DO.DEFAULT,primitivesHaveTransparency:!0,material:this.material})}}}class Ag extends kd{constructor(e,t,i){super(e,i),this.usage=t,this.mateConnectorGraphics={}}clone(e){const t=new Ag(e,this.usage,this.viewer);return this.copyToClone(t),t}cloneForPreview(e){const t=new Ag(e,fs.L.PREVIEW,this.viewer);this.copyToPreview(t);for(const e in this.mateConnectorGraphics){const i=this.mateConnectorGraphics[e],s=t.mateConnectorGraphics[e]={};for(const e in i)s[e]=i[e].cloneForPreview()}return t}getVisibleMateConnectorBounds(){const e=new yi.kB;for(const t in this.mateConnectorGraphics){const i=this.mateConnectorGraphics[t];for(const t in i)i[t].isHidden||e.addPoint(i[t].worldSpacePosition)}return e}getInstantiatedMateConnectorsForOccurrence(e){const t=[];for(const i in this.mateConnectorGraphics){const s=this.mateConnectorGraphics[i];for(const i in s){const n=s[i],r=n.getDefinition();r&&(0,ln.wB)(e,n.getOccurrence())&&t.push({Id:r.nodeId,isPartStudio:n.getIsPartStudioMateConnector()})}}return t}getComponentId(){return"mateconnector_component."}handlesEntity(e,t){return!e.hasTessellationError()&&e.isMateConnector()&&!this.viewer.getIsForFlattenedDisplay()}expectsTessellation(){return!1}reset(e){for(const e in this.mateConnectorGraphics){const t=this.mateConnectorGraphics[e];for(const e in t)t[e].remove()}this.mateConnectorGraphics={},super.reset(e)}isInstantiated(){return!0}instantiateForPartStudio(e){this.addOrUpdateOccurrence(Jf.KF,null),Hd.prototype.instantiateForPartStudio.apply(this,[e])}removePartStudioInstantiation(e){Hd.prototype.removePartStudioInstantiation.apply(this,[e]),this.removeOccurrence(Jf.KF,!1)}addOrUpdateOccurrence(e,t){let i=!1;for(const s in this.idToMetaData)i=this.updateEntityMateConnector(s,this.idToMetaData[s],e,t)||i;const s=e===Jf.KF;(i||s||this.occurrences.hasOwnProperty(e))&&super.addOrUpdateOccurrence(e,t)}addManagedIdMappings(e,t){super.addManagedIdMappings(e,t);const i=this.bodyToEntity.get(t)?.getKeys();if(i)for(const t of i){const i=Object.values(this.mateConnectorGraphics[t]);for(const t of i)t.partStudioFeatureId=e,t.isFromChildFeature=!0}}getConnectorHiddenState(e,t){const i=e.getFirstFeatureId();let s=!1;if(t){const e=t.occurrenceData.featureData[i];e?s=e.visibility===k.HRI.HIDDEN:t.isPatternDescendant&&(s=!0)}else s=e.getFeatureIds().reduce(((e,t)=>e||this.featureVisibility[t]===Fs.EE.HIDDEN),s);return s}occurrenceContainsBody(e,t){return this.viewer.getModelViewManagers().getManagerForUsage(this.usage).occurrenceContainsBody(e,t)}createMateConnectorDisplayData(e,t){if(t&&!this.occurrenceContainsBody(t,e.getMateConnectorPartId()))return null;const i=new k.Zcz;return i.location=e.getMateConnectorCoordinateSystem(),i.partId=e.getMateConnectorPartId(),i.nodeId=e.getFirstFeatureId(),i.occurrence=t?t.occurrenceData.occurrence:null,i.ownerOccurrence=i.occurrence,i.implicit=!1,i.hidden=this.getConnectorHiddenState(e,t),i}updateEntityMateConnector(e,t,i,s,n){if(s&&!this.occurrenceContainsBody(s,t.getMateConnectorPartId()))return!1;const r=t.getLastFeatureId(),a=this.getConnectorHiddenState(t,s);let o=this.mateConnectorGraphics[e],h=o?o[i]:null;if(!n&&s&&a&&!h){return!0}o||(o={},this.mateConnectorGraphics[e]=o);const c=this.createMateConnectorDisplayData(t,s);return!!c&&(h?h.updateDefinition(c):(h=new hl(c,Ko(this.usage),this.viewer,r),o[i]=h),s&&(h.setOccurrenceTransform(s.occurrenceData.transform.getGlMatrix()),h.updateOccurrenceVisibility(s.isHidden?Fs.EE.HIDDEN:Fs.EE.VISIBLE)),!0)}removeOccurrence(e,t){super.removeOccurrence(e,t);for(const t in this.mateConnectorGraphics){const i=this.mateConnectorGraphics[t];if(!i)continue;const s=i[e];s&&(s.remove(),delete i[e])}}updateEntityGraphics(e,t,i){let s;for(s in this.occurrences){const t=this.occurrences[s];s=+s,this.updateEntityMateConnector(e,i,s,t)}}static getFirstNonCompoundFeatureId(e){const t=e.getFeatureIds();if(null===t)return ut.log.warn("Unable to retrieve feature ids for entity: "+e.getMessageName()),null;for(let e=0;e<t.length;++e)if(!SI(t[e]))return t[e]}getHideableFeatureIds(){const e=[];return this.featureToIds.each(((t,i)=>{if(this.childFeatureIds.has(i))return void e.push(i);if(SI(i))return;const s=t.getKeys();for(let t=0;t<s.length;++t){const n=s[t],r=this.idToMetaData[n];if(r){const t=Ag.getFirstNonCompoundFeatureId(r);if(t&&t===i)return void e.push(i)}}})),e}removeEntity(e){const t=this.mateConnectorGraphics[e];for(const e in t)t[e].remove();delete this.mateConnectorGraphics[e],Hd.prototype.removeEntity.apply(this,[e])}hideShowEntity(e,t,i){if((i=i||Jf.KF)===Jf.Qy)return!1;let s=!1;const n=this.mateConnectorGraphics[e];for(const e in n)if(+e===i){const e=n[i];e&&(t===Fs.EE.HIDDEN?e.definition.hidden=!0:e.definition.hidden=!1,e.updateHideState(),s=!0)}return s}hideShowFeatureEntities(e,t,i){const s=this.getEntitiesForFeature(e);if(!s)return;let n=i;for(let i=0;i<s.length;++i){const r=this.idToMetaData[s[i]];if(!n){const t=Ag.getFirstNonCompoundFeatureId(r);n=!!t&&t===e}if(r&&n){const e=this.getOccurrenceIdForEntity(s[i]);this.hideShowEntity(s[i],t,e)}}this.viewer.requestDraw()}getAllMateConnectorGraphics(e,t){const i=this.featureToIds.get(t),s=[];return i&&i.each(((t,i)=>{const n=this.getMateConnectorGraphicsFromEntityId(e,i);return n&&s.push(n),!1})),s}getMateConnectorGraphics(e,t){const i=this.featureToIds.get(t);let s;return i&&(s=i.firstKey()),s?this.getMateConnectorGraphicsFromEntityId(e,s):null}getMateConnectorData(e,t){const i=this.featureToIds.get(t);let s;if(i&&(s=i.firstKey()),s){const t=this.idToMetaData[s],i=this.viewer.getOccurrenceIdManager().getIdForName(e.getPathAsString()),n=this.occurrences[i];if(t&&n)return this.createMateConnectorDisplayData(t,n)}return null}getMateConnectorGraphicsFromEntityId(e,t){if(t){let i=this.mateConnectorGraphics[t];if(e){const s=this.viewer.getOccurrenceIdManager().getIdForName(e.getPathAsString()),n=i?i[s]:null;if(n)return n;const r=this.idToMetaData[t],a=this.occurrences[s];if(r&&a){const e=!0;return this.updateEntityMateConnector(t,r,s,a,e),i=this.mateConnectorGraphics[t],i?i[s]:null}}else for(const e in i){const t=i[e];if(!t.getOccurrence())return t}}return null}getUIElementsForSelection(e){const t=[];if(e.isMateConnector()||e.isFeature()){this.getAllMateConnectorGraphics(e.getOccurrence(),e.getIdString()).forEach((function(e){t.push(e)}))}return t}getEntityIdsForSelection(e){return[]}getOccurrencesForSelection(e){const t=[];if(e.isMateConnector()||e.isFeature()){const i=this.getMateConnectorGraphics(e.getOccurrence(),e.getIdString());i&&t.push(i.getOccurrence())}return t}}class Og extends Ti.u1{constructor(e,t,i){super(i),this.definition=e,this.mateConnectorDisplayData=t,this.mateIndicatorComponents=[],this.occurrenceData.setCanIsolateChange(!0),this.occurrenceData.setIsolated(!1)}onDevicePixelRatioChanged(e){this.updateGraphics()}getDefinition(){return this.definition?this.definition:null}remove(){for(let e=0;e<this.mateIndicatorComponents.length;e++)this.mateIndicatorComponents[e].remove();super.remove()}addHighlight(e){super.addHighlight(e);for(let t=0;t<this.mateIndicatorComponents.length;t++)this.mateIndicatorComponents[t].addHighlight(e)}removeHighlight(e){const t=super.removeHighlight(e);for(let t=0;t<this.mateIndicatorComponents.length;t++)this.mateIndicatorComponents[t].removeHighlight(e);return t}onIsolateChanged(){this.updateGraphics()}isInteractionEnabled(){return!(this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()&&!this.occurrenceData.getIsolated())}updateGraphics(){for(let e=0;e<this.mateIndicatorComponents.length;e++)this.mateIndicatorComponents[e].updateGraphics()}setIsolated(e){this.occurrenceData.setIsolated(e);for(let t=0;t<this.mateIndicatorComponents.length;t++)this.mateIndicatorComponents[t].getOccurrenceData().setIsolated(e)}getDefinitionMateConnectorIds(){return this.definition.getMateConnectorIds()}getDefinitionOccurrenceIds(){return this.mateIndicatorComponents.length>0?this.mateIndicatorComponents[0].getDefinitionOccurrenceIds():this.definition.getOccurrenceIds()}getModelSelection(e){return null}addMateIndicatorComponent(e){e.isValid()&&(e.updateHideState(),this.mateIndicatorComponents.push(e),this.listenTo(e,Ti.zw.LONG_PRESS_START,this.onLongPressStart),this.listenTo(e,Ti.zw.LONG_PRESS_END,this.onLongPressEnd))}onLongPressStart(){const e=[];this.getDefinitionOccurrenceIds().forEach((function(t){e.push(k._oC.getOccurrenceFromPathString(t))})),this.viewer.getIsolatedOccurrenceManager().isolateOccurrences(e,DD.INITIAL),(0,Ce.IQ)()}onLongPressEnd(){(0,sr.m)().trigger(ir.C.EXIT_ISOLATE,this.viewer)}updateMateConnectorDisplayData(e){this.mateConnectorDisplayData=e;for(let e=0;e<this.mateIndicatorComponents.length;++e)this.mateIndicatorComponents[e].updateMateConnectorDisplayData(this.mateConnectorDisplayData)}updateHiddenMode(e){for(let t=0;t<this.mateIndicatorComponents.length;t++)this.mateIndicatorComponents[t].updateHiddenMode(e)&&this.mateIndicatorComponents[t].updateHideState()}}class vg extends Og{constructor(e,t,i){super(t,e,i);const s=new Ul(this.mateConnectorDisplayData,"FASTENED",t,this.viewer,k.qep.FASTENED);this.addMateIndicatorComponent(s)}}class Rg extends Og{constructor(e,t,i){super(t,e,i);const s=new Ul(this.mateConnectorDisplayData,"REVOLUTE",t,this.viewer,k.qep.REVOLUTE);this.addMateIndicatorComponent(s)}}class wg extends Og{constructor(e,t,i){super(t,e,i);const s=new Ul(this.mateConnectorDisplayData,"PLANAR_BASE",t,this.viewer,k.qep.PLANAR);this.addMateIndicatorComponent(s)}}class _g extends Og{constructor(e,t,i){super(t,e,i);const s=new Ul(this.mateConnectorDisplayData,"PARALLEL_BASE",t,this.viewer,k.qep.PARALLEL);this.addMateIndicatorComponent(s)}}class Ng extends Og{constructor(e,t,i){super(t,e,i);const s=new Ul(this.mateConnectorDisplayData,"SLIDER_BASE",t,this.viewer,k.qep.SLIDER),n=new Gl(this.mateConnectorDisplayData,t,-Math.PI/2,[0,1,0],this.viewer,k.qep.SLIDER);this.addMateIndicatorComponent(s),this.addMateIndicatorComponent(n)}}class bg extends Og{constructor(e,t,i){super(t,e,i);const s=new Ul(this.mateConnectorDisplayData,"CYLINDRICAL_BASE",t,this.viewer,k.qep.CYLINDRICAL),n=new Gl(this.mateConnectorDisplayData,t,-Math.PI/2,[0,1,0],this.viewer,k.qep.CYLINDRICAL);this.addMateIndicatorComponent(s),this.addMateIndicatorComponent(n)}}class Lg extends Og{constructor(e,t,i){super(t,e,i);const s=new Ul(this.mateConnectorDisplayData,"PIN_SLOT_BASE",t,this.viewer,k.qep.PIN_SLOT);this.addMateIndicatorComponent(s)}}class Fg extends Og{constructor(e,t,i){super(t,e,i);const s=new Ul(this.mateConnectorDisplayData,"BALL",t,this.viewer,k.qep.BALL);this.addMateIndicatorComponent(s)}}class xg extends Og{constructor(e,t,i){super(t,[],i);const s=new Hl(e,t,this.viewer);this.addMateIndicatorComponent(s)}updateOccurenceDisplayData(e){for(let t=0;t<this.mateIndicatorComponents.length;++t)this.mateIndicatorComponents[t].updateOccurenceDisplayData(e)}}class Bg extends Og{constructor(e,t){super(e,null,t);const i=new kl(e,"TANGENT",this.viewer);this.addMateIndicatorComponent(i)}updateMateIndicatorDefinition(e){this.definition=e;for(let e=0;e<this.mateIndicatorComponents.length;++e)this.mateIndicatorComponents[e].updateDefinition(this.definition)}}class Vg extends Og{constructor(e,t,i){super(null,null,i);const s=new Wl(e,t,this.viewer);this.addMateIndicatorComponent(s)}}class Ug extends Og{constructor(e,t,i){super(t,e,i);const s=new zl(this.mateConnectorDisplayData,t,"WIDTH",this.viewer);this.addMateIndicatorComponent(s)}updateMateIndicatorDefinition(e){this.definition=e;for(let e=0;e<this.mateIndicatorComponents.length;++e)this.mateIndicatorComponents[e].updateDefinition(this.definition)}}function Gg(e,t,i){let s=null;switch(t.mateType){case k.qep.FASTENED:s=new vg(e,t,i);break;case k.qep.REVOLUTE:s=new Rg(e,t,i);break;case k.qep.SLIDER:s=new Ng(e,t,i);break;case k.qep.PLANAR:s=new wg(e,t,i);break;case k.qep.PARALLEL:s=new _g(e,t,i);break;case k.qep.CYLINDRICAL:s=new bg(e,t,i);break;case k.qep.PIN_SLOT:s=new Lg(e,t,i);break;case k.qep.BALL:s=new Fg(e,t,i);break;default:s=null}return s}const Hg=X.default.getManager(),kg=new xi.hF({zOffset:Hg.getNumber("ORIGIN_Z_OFFSET"),primitiveType:Di.MX.POINTS,isPickable:!1}),Wg=new xi.hF({primitiveType:Di.MX.POINTS,isShowThrough:!0,isDepthTested:!1,priority:xi.DO.LOWER}),zg=new Mi;class Xg extends Hd{constructor(e,t,i){super(e,t,i),this.hasBeenInstantiated=!1,this.incrementRanges={},this.styledRanges={},this.node=new xi.NB(this.getComponentId(),new xi.hF,i),this.instantiateRanges()}reset(){super.reset(),this.node.removeOccurrence(Jf.KF),Object.values(this.styledRanges).forEach((e=>{e.getMeshRanges().destroy()})),this.incrementRanges={},this.styledRanges={},this.instantiateRanges()}getStyleId(e,t){return zg.reset(),zg.addBoolean(e),zg.addBoolean(t),zg.getId()}instantiateRanges(){for(let e=0;e<=1;++e)for(let t=0;t<=1;++t){const i=this.getStyleId(!!e,!!t),s="PointBodyComponent."+i;let n=this.incrementRanges[s];n||(n=new SS("PointBodyComponent."+i),this.usage===fs.L.PREVIEW&&n.setListenForDeletions(!0),this.incrementRanges[s]=n);const r=t?"ORIGIN":"POINT_BODY",a=new XI.bg;a.setAttribute(sE.PRIMITIVE_SIZE,Hg.getNumber(r+"_SIZE")),a.setAttribute(sE.PRIMITIVE_STYLE,Hg.getPointFont(r+"_FONT")),a.setAttribute(sE.COLOR,Hg.getColor(r+"_COLOR"));const o=e?Wg:kg,h=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(Jf.KF),c=this.node.addOccurrenceGeometryToNode(o,h,a,n);this.styledRanges[i]=c}}getComponentId(){return"point_body_component."}clone(e){const t=new Xg(e,this.viewer,this.usage);return this.copyToClone(t),t}cloneForPreview(e){const t=new Xg(e,this.viewer,fs.L.PREVIEW);return this.copyToPreview(t),t.instantiateBaseEntities(),t}instantiateBaseEntities(){const e=this.getSharedBaseMeshManager();for(const t in this.idToMetaData){const i=this.idToMetaData[t],s=e.getIncrementDetails(t,this.getMeshOwnerId());i&&s&&this.updateEntityGraphicsFromIncrementDetails(s,t,i)}this.hasBeenInstantiated=!0}isInstantiated(){return this.hasBeenInstantiated}instantiateForPartStudio(e){this.node.getParent()!==e&&e.addChild(this.node),this.hasBeenInstantiated||(this.instantiateEntities(),this.hasBeenInstantiated=!0)}removePartStudioInstantiation(e){e.removeChild(this.node,!0)}onAppearanceConstantsUpdated(){const e=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(Jf.KF);this.node.removeOccurrenceFromNode(kg,e.getOccurrenceId()),this.instantiateRanges()}handlesEntity(e,t){return!e.hasTessellationError()&&e.isPointEntity()&&!this.viewer.getIsForFlattenedDisplay()}getRanges(e,t){const i=this.getStyleId(t,e.isFromOrigin()),s=this.styledRanges[i];return s?s.getMeshRanges():null}updateEntityGraphics(e,t,i){if(!t)return;const s=this.addMeshIncrement(t);this.updateEntityGraphicsFromIncrementDetails(s,e,i)}updateEntityGraphicsFromIncrementDetails(e,t,i){if(!e)return;const s=this.getRanges(i,!1);s&&s.onIncrementAdded(e);const n=this.getRanges(i,!0);n&&n.onIncrementAdded(e),this.isEntityHidden(i,Jf.KF)&&this.hideMeshIncrement(t,Jf.KF)}removeMeshIncrement(e){const t=this.getMeshManager().removeMeshIncrement(e,this.getMeshOwnerId());if(!t)return null;const i=this.idToMetaData[e];if(!i)return null;const s=this.getRanges(i,!1);s&&s.onIncrementRemoved(t);const n=this.getRanges(i,!0);return n&&n.onIncrementRemoved(t),t}getHideableFeatureIds(){return this.featureToIds.getKeys()}}var Zg,qg,Yg=i(88497);!function(e){e[e.ALL_OPAQUE=0]="ALL_OPAQUE",e[e.OPAQUE_BODY_TRANSPARENT_FACE=1]="OPAQUE_BODY_TRANSPARENT_FACE",e[e.TRANSPARENT_BODY_OPAQUE_FACE=2]="TRANSPARENT_BODY_OPAQUE_FACE",e[e.ALL_TRANSPARENT=3]="ALL_TRANSPARENT"}(Zg||(Zg={})),function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT"}(qg||(qg={}));const Kg=X.default.getManager(),jg="body_component.",Qg=new Ni({}),$g=new Ni({color:Kg.getColor("MESH_FACET_EDGE_COLOR"),lineWidth:Kg.getNumber("MESH_FACET_EDGE_LINE_WIDTH")}),Jg=new Ni({shininess:Kg.getNumber("MESH_SHININESS"),specularColor:Kg.getColor("MESH_SPECULAR"),ambientFactor:Kg.getNumber("MESH_AMBIENT_FACTOR"),diffuseFactor:Kg.getNumber("MESH_DIFFUSE_FACTOR")}),ep=new xi.hF({material:Qg,zOffset:Kg.getNumber("PART_FACES_Z_OFFSET"),primitiveType:Di.MX.TRIANGLE_STRIP,includedInBlend:!0,clippedBySectionPlanes:!0}),tp=new xi.hF({material:Qg,zOffset:Kg.getNumber("PART_FACES_Z_OFFSET"),primitiveType:Di.MX.TRIANGLE_STRIP,includedInBlend:!0,clippedBySectionPlanes:!0,isVisible:!1}),ip=tp.cloneAndModify({zOffset:X.default.getManager().getNumber("SURFACE_Z_OFFSET"),isTwoSided:!0}),sp=ep.cloneAndModify({isTwoSided:!0}),np=new xi.hF({material:Qg,zOffset:Kg.getNumber("NON_MODIFIABLE_Z_OFFSET"),primitiveType:Di.MX.TRIANGLE_STRIP,includedInBlend:!0,clippedBySectionPlanes:!0,addsToSectionMask:!1,primitivesHaveTransparency:!0,isTwoSided:!0}),rp=new xi.hF({material:Qg,zOffset:Kg.getNumber("NON_MODIFIABLE_Z_OFFSET"),primitiveType:Di.MX.TRIANGLE_STRIP,isTwoSided:!0,includedInBlend:!0,clippedBySectionPlanes:!0,primitivesHaveTransparency:!0}),ap=new xi.hF({material:Jg,zOffset:Kg.getNumber("PART_FACES_Z_OFFSET"),primitiveType:Di.MX.TRIANGLE_STRIP,includedInBlend:!0,clippedBySectionPlanes:!0}),op=(ap.cloneAndModify({primitivesHaveTransparency:!0}),ap.cloneAndModify({isTwoSided:!0}).cloneAndModify({primitivesHaveTransparency:!0}),new xi.hF({material:$g,zOffset:Kg.getNumber("PART_EDGES_Z_OFFSET"),primitiveType:Di.MX.LINES,addsToBounds:!1,includedInBlend:!0,clippedBySectionPlanes:!0,isPickable:!1})),hp=new xi.hF({material:Qg,zOffset:Kg.getNumber("PART_FACES_Z_OFFSET"),primitiveType:Di.MX.TRIANGLE_STRIP,primitivesHaveTransparency:!0,includedInBlend:!0,clippedBySectionPlanes:!0,isTwoSided:!0}),cp=new xi.hF({material:Qg,zOffset:Kg.getNumber("SURFACE_Z_OFFSET"),primitiveType:Di.MX.TRIANGLE_STRIP,isTwoSided:!0,includedInBlend:!0,clippedBySectionPlanes:!0}),lp=new xi.hF({material:Qg,zOffset:Kg.getNumber("SURFACE_Z_OFFSET"),primitiveType:Di.MX.TRIANGLE_STRIP,isTwoSided:!0,includedInBlend:!0,clippedBySectionPlanes:!0,primitivesHaveTransparency:!0}),up=new xi.hF({zOffset:Kg.getNumber("PART_POINTS_Z_OFFSET"),primitiveType:Di.MX.POINTS,isVisible:!1,addsToBounds:!1,includedInBlend:!0,clippedBySectionPlanes:!0}),dp=up.cloneAndModify({zOffset:Kg.getNumber("SURFACE_POINTS_Z_OFFSET")}),gp=up.cloneAndModify({zOffset:Kg.getNumber("WIRE_POINTS_Z_OFFSET")});function pp(e){return e.getZOffset()===cp.zOffset||e.getZOffset()===rp.zOffset}const mp={};function fp(e,t){let i=mp[e];if(!i){i=new XI.bg;const s=[t.color[0]/255,t.color[1]/255,t.color[2]/255,t.opacity/255];i.setAttribute(sE.COLOR,s),mp[e]=i}return i}function Ip(e){if(e){const t=e.getAttribute(sE.COLOR);if(t)return t[3]<1}return!1}const Ep=new Si.si;let Sp=!1,Tp=!1;class Dp extends kd{constructor(e,t,i,s){super(e,s,i),this.bodyLoadTasks=t,this.bodyMetaData={},this.lastSetBodyColor={},this.subBodyStyleOverrides=new gl.TemplatedNestedMap,this.entityStyles={},this.cachedBodyTransparencyState={},this.partStudioBodyIdToOccurrenceId={},this.cullableBodies=null,this.instantiatedTriangleCount=-1,this.sheetMetalOrderIdToTransform={},this.previewClone=null,this.baseComponent=null,this.bodiesHiddenInBase=new Set,this.tessellationSettings={},this.partTriangleCounts={},this.bodiesWithUpdatedMeshReferences=new Set,this.scalarVisualizationOccurrences=new Set,this.generativePartInstanceOccurrences=new Set,this.bodyIdToSmoothEdges=new gl.TemplatedSetMap,this.previousBodyIdToSmoothEdgesCount=new Map,this.node=e.getModelViewManager().getSharedBodyNode(),this.collectionId=Ep.getId(),this.knownBodyIds=new Set,this.occurrenceAlphaModifiers=new Map,this.bodyVisibility=new gl.TemplatedNestedMap,this.bodyToOccurrenceId=new gl.TemplatedNestedMap,this.unavailableBodyOccurrences=new gl.TemplatedNestedMap,this.silhouetteCallback=(e,t)=>{this.onSilhouetteCreated(e,t)},this.decalComponent=new Nd(this,e),this.cosmeticThreadsEnabled=Ki.Jq.CapabilitiesService.checkRenderCosmeticThreadsCppServerCurrentlyEnabled(),this.cosmeticThreadsEnabled&&(this.cosmeticThreadComponent=new Pd(this))}getCollectionId(){return this.collectionId}getNode(){return this.node}getDecalComponent(){return this.decalComponent}getBodyIds(e=(()=>!0)){const t=[];for(const i of Object.keys(this.bodyMetaData))e(this.bodyMetaData[i])&&t.push(i);return t}getEntityIds(e){const t=[];for(const i in this.idToMetaData)e(this.idToMetaData[i])&&t.push(i);return t}getCorrectedBodyOccurrenceId(e,t){return t&&t!==Jf.KF||(t=this.partStudioBodyIdToOccurrenceId[e]),t}getBodyToOccurrenceId(){return this.bodyToOccurrenceId}copyBodyDataToClone(e){let t;for(t in e.bodyLoadTasks=this.bodyLoadTasks,this.bodyMetaData)e.bodyMetaData[t]=this.bodyMetaData[t].clone();for(t in e.knownBodyIds=new Set(this.knownBodyIds),e.bodyIdToSmoothEdges=this.bodyIdToSmoothEdges.structuredClone(),e.previousBodyIdToSmoothEdgesCount=new Map(this.previousBodyIdToSmoothEdgesCount),this.lastSetBodyColor)e.lastSetBodyColor[t]=this.lastSetBodyColor[t].slice(0);this.subBodyStyleOverrides.eachNested(((t,i,s)=>{e.subBodyStyleOverrides.insertNested(i,s,t.clone())})),e.tessellationSettings=(0,z.Z)(this.tessellationSettings),e.partTriangleCounts=(0,z.Z)(this.partTriangleCounts),e.entityStyles=(0,z.Z)(this.entityStyles)}clone(e){this.bodyLoadTasks.completeTasks();const t=new Dp(e,this.bodyLoadTasks,this.usage,this.viewer);return this.copyBodyDataToClone(t),this.copyToClone(t),this.decalComponent.copyToClone(t.decalComponent),this.cosmeticThreadsEnabled&&this.cosmeticThreadComponent.copyToClone(t.cosmeticThreadComponent),t}cloneForPreview(e){const t=new Dp(e,this.bodyLoadTasks,fs.L.PREVIEW,this.viewer);this.copyToPreview(t),this.copyBodyDataToClone(t),Object.entries(this.occurrences).forEach((([e,i])=>{!i&&(t.occurrences[e]=i)})),this.bodyToOccurrenceId.eachNested(((e,i,s)=>{t.occurrences.hasOwnProperty(s)&&t.bodyToOccurrenceId.insertNested(i,s,e)})),this.unavailableBodyOccurrences.eachNested(((e,i,s)=>{t.occurrences.hasOwnProperty(s)&&t.unavailableBodyOccurrences.insertNested(i,s,e)}));for(const e in this.bodyMetaData)t.refreshBodyOccurrences(e);return this.previewClone=t,t.baseComponent=this,t.decalComponent=this.decalComponent.cloneForPreview(t,e),this.cosmeticThreadsEnabled&&(t.cosmeticThreadComponent=this.cosmeticThreadComponent.cloneForPreview(t)),t}onPreviewDestroyed(){this.previewClone=null}copyVisibility(e){e.bodyVisibility.eachNested(((e,t,i)=>(this.hideShowBody(i,e,+t),!1)))}getBodyLoadTasks(){return this.bodyLoadTasks}getTessellationSettings(){return this.tessellationSettings}getPartTriangleCounts(){return this.partTriangleCounts}damageInstantiatedTriangleCount(){this.instantiatedTriangleCount=-1}getInstantiatedTriangleCount(){if(this.instantiatedTriangleCount<0){this.instantiatedTriangleCount=0;const e=this.getMeshManager(),t=this.getMeshOwnerId();this.bodyToOccurrenceId.each(((i,s)=>{if(i&&!i.isEmpty()){const n=e.getGroupRangesForGroupTypeAndLod(s,t,Di.MX.TRIANGLE_STRIP,nE.DEFAULT);n&&(this.instantiatedTriangleCount+=i.size()*n.getPrimitiveCount())}return!1}),this)}return this.instantiatedTriangleCount}hasDisplayedEdgesWithOutdatedSmoothnessInfo(){let e=!1;return this.bodyToOccurrenceId.each(((t,i)=>{const s=this.bodyToEntity.get(i);return s&&s.each(((t,i)=>{const s=this.idToMetaData[i];return s&&s.isEdge()&&(s.getEdgeSmoothnessStatus()===k.dA1.UNKNOWN||s.getEdgeSmoothnessStatus()===k.dA1.SMOOTH)&&(e=!0),e})),e})),e}getEstimatedMemoryUsage(){let e=0;for(const t in this.bodyMetaData){this.bodyMetaData[t].isClosedCompositeConstituent||(e+=this.bodyMetaData[t].getEstimatedMemoryUsage())}return e}retrieveBodyMetaData(e){return this.bodyMetaData[e]||null}getBodyDiameter(e){const t=this.bodyMetaData[e];return t?t.getBounds().diameter():0}isBodyIsolated(e,t){const i=this.getOccurrenceDataForBody(e,t);return!!i&&i.getIsolated()}isBodyVisible(e,t){const i=this.getOccurrenceDataForBody(e,t);return!!i&&i.getVisibility()!==Fs.EE.HIDDEN}getOccurrenceDataForBody(e,t){let i=this.bodyMetaData[t];if(i&&i.isClosedComposite&&!i.isGroupableCompositeBody){let e=null;for(let t=0;t<i.constituentBodyIds.length&&!e;++t)e=this.bodyMetaData[i.constituentBodyIds[t]];i=e}return this.getBodyOccurrenceData(i.meshGroupId,e)}isBodyInstantiated(e){const t=this.bodyMetaData[e];if(!t)return!1;if(!t.isNonGroupingCompositeBody)return this.bodyToOccurrenceId.has(t.meshGroupId);for(let e=0;e<t.constituentBodyIds.length;++e)if(this.bodyToOccurrenceId.has(t.constituentBodyIds[e]))return!0}getNonInstantiatedBodies(){const e=[];for(const t in this.bodyMetaData){this.bodyMetaData[t].isClosedCompositeConstituent||(this.isBodyInstantiated(t)||e.push(this.bodyMetaData[t]))}return e}getComponentId(){return jg}reset(){this.bodyToOccurrenceId.eachNested(((e,t,i)=>(this.removeBodyOccurrence(i,t),!1)),this),this.unavailableBodyOccurrences.clear(),this.bodyLoadTasks.clearAllBodiesForComponent(this),this.bodyMetaData={},this.tessellationSettings={},this.knownBodyIds.clear(),this.lastSetBodyColor={},this.partStudioBodyIdToOccurrenceId={},this.sheetMetalOrderIdToTransform={},this.entityStyles={},this.subBodyStyleOverrides.clear(),this.decalComponent.destroy(),this.decalComponent=new Nd(this,this.parent),this.cosmeticThreadsEnabled&&(this.cosmeticThreadComponent.destroy(),this.cosmeticThreadComponent=new Pd(this)),this.bodyIdToSmoothEdges.clear(),this.previousBodyIdToSmoothEdgesCount.clear(),this.damageInstantiatedTriangleCount(),super.reset()}updateBodyDisplayData(e,t){const i=new gt.StringSet;for(const t in e.deterministicPartIdToData){const i=e.deterministicPartIdToData[t];if(i.isDeletion){this.parent.bodyIdsThatAreInsertableBuffers?.delete(t),delete this.tessellationSettings[t],delete this.partTriangleCounts[t];const e=this.bodyMetaData[t];if(e?.isClosedComposite)for(const t of e.constituentBodyIds)this.bodyIdToSmoothEdges.delete(t),this.previousBodyIdToSmoothEdgesCount.delete(t);else this.bodyIdToSmoothEdges.delete(t),this.previousBodyIdToSmoothEdgesCount.delete(t)}else{this.tessellationSettings[t]=i.tessellationSettings;const e=new k.xTE;e.coarsePlanarFaceTriangleCount=i.coarsePlanarFaceTriangleCount,e.coarseTriangleCount=i.coarseTriangleCount,e.totalEntityCount=i.totalEntityCount,this.partTriangleCounts[t]=e}}this.knownBodyIds=new Set;for(let s=0;s<e.partDisplayData.length;++s){const n=e.partDisplayData[s].id;this.knownBodyIds.add(n);const r=e.deterministicPartIdToData[n];if(r){if(this.viewer.getIsForFlattenedDisplay()!==r.isForFlattenedView()){if(this.viewer.getIsForFlattenedDisplay())continue;n in this.partStudioBodyIdToOccurrenceId&&this.removeBodyOccurrence(Jf.KF,n)}}else if(!this.bodyMetaData.hasOwnProperty(n))continue;if(i.add(n),!t||e.deterministicPartIdToData.hasOwnProperty(n)){let i=-1;t&&_c()&&this.bodyMetaData[n]&&null!==this.bodyMetaData[n].getFinestTessellationSettingInMemory()&&(i=this.bodyMetaData[n].getFinestTessellationSettingInMemory());const r=e.deterministicPartIdToData[n],a=e.partDisplayData[s];if(a||ut.log.warn("Missing expected BTPartDisplayData"),this.updateBodyMetaData(e,n,a,r),t&&_c()){const e=this.bodyMetaData[n],t=(e.getEstimatedMemoryUsage()-e.getEstimatedMemoryUsage([i]))/1024/1024;t>Kg.getNumber("SINGLE_BODY_MEMORY_CHANGE_INFO_THRESHOLD_MB")&&ut.log.info("Memory change for "+n+" to go to "+e.getFinestTessellationSettingInMemory()+": "+t+"MB")}}const a=this.bodyMetaData[n];if(a.isClosedComposite)for(let e=0;e<a.constituentBodyIds.length;++e)this.knownBodyIds.add(a.constituentBodyIds[e]),i.add(a.constituentBodyIds[e])}let s=null;for(const e in this.bodyMetaData)i.contains(e)||(this.removeBodyOccurrence(Jf.KF,e),this.bodyMetaData[e].removeOpenCompositeBodyReferences(this.bodyMetaData),delete this.bodyMetaData[e],delete this.lastSetBodyColor[e],this.bodyIdToSmoothEdges.delete(e),this.previousBodyIdToSmoothEdgesCount.delete(e),this.subBodyStyleOverrides.remove(e),s||(s=new gt.StringSet),s.add(e));s&&this.bodyLoadTasks.clearBodiesForComponent(this,s)}processDeletions(e){let t,i;for(const s in e.deterministicPartIdToData){const n=e.deterministicPartIdToData[s];for(let s=0;s<n.entityDIds.length;++s)i=n.entityDIds[s],t=e.deterministicIdToEntity[i],t&&!this.handlesEntity(t,n)&&this.removeEntity(i)}for(i in e.deterministicIdToEntity)t=e.deterministicIdToEntity[i],t.isDeletion()&&(delete this.entityStyles[i],this.removeEntity(i))}removeEntity(e){const t=this.idToMetaData[e];if(!t)return;const i=t.getBodyId();this.cosmeticThreadsEnabled&&this.cosmeticThreadComponent.removeFace(e,i)&&this.bodiesWithUpdatedMeshReferences.add(i),t.isSmoothEdge()&&this.bodyIdToSmoothEdges.deleteValue(i,e,!0),super.removeEntity(e)}updatePSOI(e){for(const t in e.detIdToPSOIIncrement)this.bodyMetaData[t]&&(this.bodyMetaData[t].partIdentity=e.detIdToPSOIIncrement[t])}unloadBody(e){const t=this.bodyMetaData[e];if(!t)return;t.setIsTessellationLoaded(!1),t.tessellationSettings=[];const i=this.bodyToEntity.get(e);if(i&&i.each(((e,t)=>(this.removeEntity(t),!1)),this),this.tessellationSettings[e]=[k.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING],this.damageInstantiatedTriangleCount(),t.isClosedComposite)for(let e=0;e<t.constituentBodyIds.length;++e)this.unloadBody(t.constituentBodyIds[e])}removeBaseIncrement(e){if(this.baseComponent){const t=this.baseComponent.idToMetaData[e];if(t){const i=this.baseComponent.getEntityBodyGroupId(t),s=this.baseComponent.bodyToOccurrenceId.get(i);s&&s.each(((t,i)=>(this.removeBaseIncrementFromOccurrence(e,i),!1)),this)}}}onBaseSilhouetteAdded(e,t,i){const s=this.bodyToOccurrenceId.get(i);s&&s.each(((i,s)=>(this.wasIncrementRemovedFromBase(e,s)&&this.hideBaseIncrement(t,s),!1)),this)}processAdditionsAndChanges(e,t,i){let s;for(s in this.updateBodyDisplayData(e,i),this.updateEntityAppearanceOverrides(e),this.processPrecompiledGraphicsBuffers(e.partIdAndTessellationSettingToBuffers),e.deterministicPartIdToData){const t=e.deterministicPartIdToData[s],i=this.bodyMetaData[s];if(!i)continue;const n=i.getIsTessellationLoaded(),r=i.canEntitiesBeLoaded();if(this.viewer.areOptimizedBuffersEnabled){if(!e.partIdAndTessellationSettingToBuffers[s])continue;this.refreshBodyOccurrences(s)}else{Dp.sortEntityIdsToOptimizeBuffers(t.entityDIds,e.deterministicIdToEntity);for(let a=0;a<t.entityDIds.length;++a){const o=t.entityDIds[a],h=e.deterministicIdToEntity[o];if(!h||this.handlesEntity(h,t))if(h){const e=gI(h,o,this.getEntityIdManager().getOrCreateIdForName(o));if(!e)continue;h.setBodyMetaData(i),h.setMeshIncrement(e),this.removeOldEntityGraphics(o,h),this.addIdMappings(o,h,s),n?this.updateEntityGraphics(o,e,h):this.updateGroupId(h,e),this.viewer.getIsForFlattenedDisplay()===t.isForFlattenedView()&&h.removeGeometry()}else r&&this.changeEntityOwner(o,s)}}n||i.isClosedCompositeConstituent||!i.canEntitiesBeLoaded()||this.bodyLoadTasks.postBodyToLoad(this,s)}this.updateBodiesWithChangedMeshReferences(),this.decalComponent.update(e),this.deterministicIdToAssociatedFeatureIds=e.deterministicIdToAssociatedFeatureIds,this.featureIdToAssociatedDeterministicIds={};for(const[e,t]of Object.entries(this.deterministicIdToAssociatedFeatureIds))for(const i of t){let t=this.featureIdToAssociatedDeterministicIds[i];t||(t=[],this.featureIdToAssociatedDeterministicIds[i]=t),t.push(e)}t&&this.addPartStudioOccurrences()}getBodyType(e){const t=this.bodyMetaData[e];if(t)return t.type;const i=this.parent.getEntitiesForBody(e);for(let e=0;i&&e<i.length;e++){const t=this.parent.retrieveEntityMetaData(i[e]);if(t&&t instanceof k.sWe)return k.wG2.POINT}return null}accumulateSketchIdsFromBodyId(e,t){this.parent.sketchComponent.accumulateSketchIdsFromBodyId(e,t)}updateCompositeConstituentCounts(e){for(let t=0;t<e.partDisplayData.length;t++){const i=e.partDisplayData[t].id,s=this.bodyMetaData[i];s&&s.isComposite&&s.updateConstituentTypeCounts(this)}}handlesEntity(e,t){const i=t&&this.viewer.getIsForFlattenedDisplay()&&!t.isForFlattenedView();return!e.hasTessellationError()&&e.isFromBody()&&!i}updateEntityAppearanceOverrides(e){for(const t in e.appearanceIdToAppearanceOverride){const i=e.appearanceIdToAppearanceOverride[t],s=t===k.QHW.RESET_APPEARANCE_ID?null:fp(t,i.appearance);for(let e=0;e<i.entityDeterministicIds.length;++e){const t=i.entityDeterministicIds[e];if(s?this.entityStyles[t]=s:delete this.entityStyles[t],this.containsEntity(t)){const e=this.getMeshIncrementDetails(t)||this.getBaseMeshIncrementDetails(t);e&&(this.removeEntityAppearanceOverride(e),s&&this.incorporateEntityAppearanceOverride(e))}}}}static sortEntityIdsToOptimizeBuffers(e,t){e.sort(((e,i)=>{const s=t[e],n=t[i];return s||n?s&&!n?-1:!s&&n?1:s.getEntityType()!==n.getEntityType()?s.getEntityType()<n.getEntityType()?-1:1:s.isEdge()&&s.isSmoothEdge()!==n.isSmoothEdge()?s.isSmoothEdge()?-1:1:0:0}))}getNodePropertiesForFace(e,t,i){const s=i===qg.TRANSPARENT;return e.containsOnlySheetBodies()?e.isModifiableBody()?s?lp:cp:rp:e.isModifiableBody()?s?hp:t!==Zg.ALL_OPAQUE?sp:ep:np}getNodePropertiesForEdge(e,t=null){if(e.getIsBendCenterLineBody())return this.viewer.getResources().CENTER_LINE_NODE_PRPOPERTIES;{const i=()=>this.viewer.getIsolatedOccurrenceManager()?.isOccurrenceTranslucent(t);return e.containsOnlyWireBodies()?e.isModifiableBody()?this.viewer.getResources().WIRE_EDGE_NODE_PROPERTIES:this.viewer.getResources().WIRE_EDGE_NODE_PROPERTIES_NON_MODIFIABLE:e.containsOnlySheetBodies()?e.isModifiableBody()?i()?this.viewer.getResources().TRANSLUCENT_SURFACE_EDGE_NODE_PROPERTIES:this.viewer.getResources().SURFACE_EDGE_NODE_PROPERTIES:this.viewer.getResources().SURFACE_EDGE_NODE_PROPERTIES_NON_MODIFIABLE:e.isModifiableBody()?i()?this.viewer.getResources().TRANSLUCENT_PART_EDGE_NODE_PROPERTIES:this.viewer.getResources().PART_EDGE_NODE_PROPERTIES:this.viewer.getResources().PART_EDGE_NODE_PROPERTIES_NON_MODIFIABLE}}getNodePropertiesForSmoothEdges(e,t){const i=this.viewer.getResources(),s=this.viewer.getIsolatedOccurrenceManager()?.isOccurrenceTranslucent(t);if(!this.bodyIdToSmoothEdges.get(e.getId())?.size){if(0===this.getSmoothEdgeCountForCompositeBody(e))return null}return e.containsOnlySheetBodies()?s?i.TRANSLUCENT_SURFACE_SMOOTH_EDGE_NODE_PROPERTIES:e.isModifiableBody()?i.SURFACE_SMOOTH_EDGE_NODE_PROPERTIES:i.SURFACE_SMOOTH_EDGE_NODE_PROPERTIES_NON_MODIFIABLE:e.containsOnlySolidBodies()?s?i.TRANSLUCENT_PART_SMOOTH_EDGE_NODE_PROPERTIES:e.isModifiableBody()?i.PART_SMOOTH_EDGE_NODE_PROPERTIES:i.PART_SMOOTH_EDGE_NODE_PROPERTIES_NON_MODIFIABLE:null}getNodePropertiesForSilhouettes(e){return null!==e&&this.viewer.getIsolatedOccurrenceManager()?.isOccurrenceTranslucent(e)?this.viewer.getResources().TRANSLUCENT_SILHOUETTE_NODE_PROPERTIES:this.viewer.getResources().SILHOUETTE_NODE_PROPERTIES}getNodePropertiesForPoint(e){return e.containsOnlyWireBodies()?gp:e.containsOnlySheetBodies()?dp:up}getGroupBoundsForEntity(e){const t=this.getEntityBodyGroupId(e),i=this.bodyMetaData[t];if(!i){const i=e.getEntityType();return ut.log.info(`Could not find bodyMetaData for entityType ${i} and entityBodyGroupId ${t} while fetching group bounds for entity`),null}return i.getBounds()}addMeshIncrementAndSilhouettes(e,t){const i=this.getGroupBoundsForEntity(t),s=super.addMeshIncrement(e,i);t.isSmoothEdge()&&this.bodyIdToSmoothEdges.add(t.getBodyId(),e.id),this.incorporateEntityAppearanceOverride(s),this.addMeshTriangleEdges(e,t);e.primitiveType===Di.MX.TRIANGLE_STRIP&&!t.isPlanar()&&this.viewer.getSilhouetteTask().postSilhouetteRequest(e,this.usage,this.silhouetteCallback),this.damageInstantiatedTriangleCount()}addMeshTriangleEdges(e,t){if(t.isFace()&&(Sp||t.getSurfaceType()===k.C1H.MESH)){const i=Dp.getMeshEdgeId(e.id),s=(0,Au.sp)(e,i);if(s){s.groupId=Dp.getMeshEdgeId(this.getEntityBodyGroupId(t));const e=this.getGroupBoundsForEntity(t);this.getMeshManager().addMeshIncrement(s,this.getMeshOwnerId(),e)}}}onSilhouetteCreated(e,t){const i=e.id,s=this.idToMetaData[i];s&&s.getIncrementGloballyUniqueId()===e.getGloballyUniqueId()&&t&&(t.groupId=e.groupId,this.getMeshManager().addMeshIncrement(t,this.getMeshOwnerId()),this.previewClone&&this.previewClone.onBaseSilhouetteAdded(i,t.id,e.groupId),this.viewer.requestDraw())}static getMeshEdgeId(e){return-1!==e.indexOf(Dp.MESH_EDGE_GROUP_SUFFIX,e.length-Dp.MESH_EDGE_GROUP_SUFFIX.length)?e:e+Dp.MESH_EDGE_GROUP_SUFFIX}static getPotentialMeshGroupIdsForBody(e){return[e,e+Dp.MESH_EDGE_GROUP_SUFFIX,e+Dp.SMOOTH_EDGE_GROUP_SUFFIX]}callBaseVisibilityMethodForIncrementAndDerivations(e,t,i){const s=e.call(this,t,i);e.call(this,zf(t),i);const n=Dp.getMeshEdgeId(t);return n!==t&&e.call(this,n,i),s}showMeshIncrement(e,t){return this.callBaseVisibilityMethodForIncrementAndDerivations(Hd.prototype.showMeshIncrement,e,t)}hideMeshIncrement(e,t){return this.callBaseVisibilityMethodForIncrementAndDerivations(Hd.prototype.hideMeshIncrement,e,t)}hideBaseIncrement(e,t){return this.callBaseVisibilityMethodForIncrementAndDerivations(Hd.prototype.hideBaseIncrement,e,t)}showBaseIncrement(e,t){return this.callBaseVisibilityMethodForIncrementAndDerivations(Hd.prototype.showBaseIncrement,e,t)}refreshEntityGraphics(e,t){let i=this.idToMetaData[e];i&&(this.removeMeshIncrement(e),this.removeBaseIncrement(e),i=i.cloneForNewBody(t),this.idToMetaData[e]=i,this.updateEntityGraphics(e,i.getMeshIncrement(),i))}removeMeshIncrement(e){const t=Hd.prototype.removeMeshIncrement.apply(this,[e]);super.removeMeshIncrement(zf(e)),t&&(this.viewer.getSilhouetteTask().removePendingRequest(t.increment,this.usage),this.removeEntityAppearanceOverride(t));const i=Dp.getMeshEdgeId(e);return i!==e&&Hd.prototype.removeMeshIncrement.call(this,i),this.damageInstantiatedTriangleCount(),t}incorporateEntityAppearanceOverride(e){let t=!1;const i=e?.increment?.groupId,s=this.entityStyles[e.increment?.id];if(s){const n=Ip(s)?qg.TRANSPARENT:qg.OPAQUE;let r=this.subBodyStyleOverrides.getNested(i,n);r||(r=new SS(i+" "+(n===qg.OPAQUE?"opaque":"transparent")+" entity style overrides",i),this.subBodyStyleOverrides.insertNested(i,n,r),t=!0),r.onIncrementAdded(e,s)}t&&this.bodiesWithUpdatedMeshReferences.add(i)}removeEntityAppearanceOverride(e){let t=!1;const i=e.increment?.groupId,s=this.subBodyStyleOverrides.get(i);s&&s.each(((s,n)=>{s.onIncrementRemoved(e)&&s.isEmpty()&&(s.destroy(),this.subBodyStyleOverrides.removeNested(i,n),t=!0)})),t&&this.bodiesWithUpdatedMeshReferences.add(i)}damageComputedBodyTransparency(e){delete this.cachedBodyTransparencyState[e]}getComputeBodyTransparency(e){if(this.cachedBodyTransparencyState.hasOwnProperty(e))return this.cachedBodyTransparencyState[e];const t=this.getBodyColorByBodyId(e)[3]<1,i=this.bodyMetaData[e];let s=[e];i&&i.isClosedComposite&&(s=i.constituentBodyIds);let n=0,r=0;for(let e=0;e<s.length;++e){const t=this.bodyToEntity.get(s[e]);t&&t.each(((e,t)=>{const i=this.entityStyles[t];return i&&(Ip(i)?++n:++r),n>0&&r>0}))}let a=Zg.ALL_OPAQUE;return t&&r>0?a=Zg.TRANSPARENT_BODY_OPAQUE_FACE:!t&&n>0?a=Zg.OPAQUE_BODY_TRANSPARENT_FACE:t&&(a=Zg.ALL_TRANSPARENT),this.cachedBodyTransparencyState[e]=a,a}getHideableFeatureIds(){return[]}hideShowFeature(e,t,i){this.featureVisibility[e]=t;const s=this.getEntitiesForFeature(e);if(!s)return;const n=new gt.StringSet;for(let e=0;e<s.length;++e){const t=this.idToMetaData[s[e]];let r=t?t.getBodyMetaData():void 0;r?.isClosedCompositeConstituent&&(r=r.consumingClosedCompositeData),r&&!r.isModifiableBody()&&i&&n.add(r.id)}n.each((e=>{this.hideShowBody(e,t,Jf.KF)}),this)}updateEdgeSmoothness(e){let t=0;for(const i in this.idToMetaData){const s=this.idToMetaData[i];if(s.isEdge()&&(s.isFromSolidBody()||s.isFromSheetBody())){e.hasOwnProperty(i)||++t;const n=s.getGeometry();e[i]&&!s.isFromWireBody()?n.edgeSmoothnessStatus=k.dA1.SMOOTH_V2:n.edgeSmoothnessStatus=k.dA1.NOT_SMOOTH}}t>0&&ut.log.warn("Did not find edge smoothness data for "+t+" edges")}updateGroupId(e,t){const i=this.getEntityBodyGroupId(e);e.isSmoothEdge()?t.groupId=i+Dp.SMOOTH_EDGE_GROUP_SUFFIX:t.groupId=i}updateEntityGraphics(e,t,i){t.pickId=this.getEntityIdManager().getOrCreateIdForName(e),!this.parent.getIsMissingTangencyInformationMessageShown()&&this.viewer.getSmoothEdgesRenderStyle()!==k.YUG.VISIBLE&&i.isEdge()&&i.getEdgeSmoothnessStatus()===k.dA1.UNKNOWN&&(this.parent===this.parent.getModelViewManager().getDisplayedPartStudio()?this.parent.getModelViewManager().updateSmoothEdgesForDisplayedPartStudio():(this.viewer.showTangencyInformationMissingMessage(),this.parent.setIsMissingTangencyInformationMessageShown(!0),setTimeout((()=>{this.viewer.setSmoothEdgesRenderStyle(k.YUG.VISIBLE)}),0))),this.updateGroupId(i,t),this.cosmeticThreadsEnabled&&this.cosmeticThreadComponent.updateEntity(e,i,t.groupId).forEach((e=>{this.bodiesWithUpdatedMeshReferences.add(e)})),this.addMeshIncrementAndSilhouettes(t,i)}instantiateForPartStudio(e){Hd.prototype.instantiateForPartStudio.apply(this,[e]),this.addPartStudioOccurrences()}removePartStudioInstantiation(e){this.usage===fs.L.PREVIEW&&Hd.prototype.removePartStudioInstantiation.apply(this,[e]),this.removeOccurrence(Jf.KF,!1)}isBodyLoaded(e){const t=this.bodyMetaData[e];return!!t&&t.getIsTessellationLoaded()}processBodyAddition(e,t,i=!0){const s=this.bodyMetaData[e];if(s&&s.isClosedComposite){for(let e=0;e<s.constituentBodyIds.length;++e){const i=s.constituentBodyIds[e];if(!this.isBodyLoaded(i)){const n=!this.bodyMetaData[i].canBeGroupedWithOtherConstituents;this.processBodyAddition(s.constituentBodyIds[e],t,n)}}return s.setIsTessellationLoaded(!0),this.cosmeticThreadsEnabled&&this.cosmeticThreadComponent.getBodiesWithCosmeticThreads(s).forEach((e=>{this.bodiesWithUpdatedMeshReferences.add(e)})),this.updateBodiesWithChangedMeshReferences(),this.decalComponent.onBodyLoaded(),s.isGroupableCompositeBody&&this.updateBodyIfSmoothEdgeCountChanged(s),!0}if(this.isBodyLoaded(e)&&ut.log.warn("The same body occurrence was loaded twice"),!this.viewer.areOptimizedBuffersEnabled){const n=this.bodyToEntity.get(e);if(!n)return!0;const r=n.getKeys();Dp.sortEntityIdsToOptimizeBuffers(r,this.idToMetaData),r.forEach((e=>{const i=this.idToMetaData[e];if(!i||!i.getMeshIncrement())return!1;t&&t.addVertexCost(i.getMeshIncrement().vertexCount()),this.updateEntityGraphics(e,i.getMeshIncrement(),i)}),this),i&&this.updateBodyIfSmoothEdgeCountChanged(s)}if(s&&s.setIsTessellationLoaded(!0),this.damageInstantiatedTriangleCount(),this.getBodyManager().damageUnloadedBodyBounds(),this.partStudioBodyIdToOccurrenceId.hasOwnProperty(e)){const t=this.viewer.getOccurrenceDataManager().getOccurrenceData(this.partStudioBodyIdToOccurrenceId[e]);t&&t.clearAllOccurrenceLevelHighlights()}return this.updateBodiesWithChangedMeshReferences(),this.decalComponent.onBodyLoaded(),!0}addBodyOccurrence(e,t,i,s){if(this.bodyToOccurrenceId.hasNested(t,e)&&!i)return;const n=this.bodyMetaData[t];if(!n)return void(s||this.unavailableBodyOccurrences.insertNested(t,e,!0));this.bodyToOccurrenceId.insertNested(t,e,!0);const r=this.getBodyOccurrenceData(t,e);if(!r)return void ut.log.warn("Tried to add occurrence without occurrence data");const a=this.getBodyColorByBodyOccurrence(n,r),o=this.getEdgeStyleByBodyOccurrence(n,r,a);if(this.cosmeticThreadsEnabled&&!this.scalarVisualizationOccurrences.has(r.getOccurrenceId())){const e=this.getEntitiesForBody(t);e&&e.forEach((e=>{const i=this.getEntityMetaData(e);this.cosmeticThreadComponent.addMaterialOverrideForEntity(e,i,t)}))}this.syncPartSmoothEdgeCount(n),this.addBodyOccurrenceFromMeshManager(this.getMeshManager(),e,r,t,n,a,o),this.getSharedBaseMeshManager()&&!this.bodiesHiddenInBase.has(t)&&this.addBodyOccurrenceFromMeshManager(this.getSharedBaseMeshManager(),e,r,t,n,a,o),this.scalarVisualizationOccurrences.has(r.getOccurrenceId())||this.decalComponent.addOrUpdateOccurrence(t,e),i||this.damageInstantiatedTriangleCount()}getEdgeStyleByBodyOccurrence(e,t,i){i=i||this.getBodyColorByBodyOccurrence(e,t);const s=new XI.bg;if(this.viewer.getIsolatedOccurrenceManager()?.isOccurrenceTranslucent(t)){const e=this.getTranslucentEdgeColor(i);s.setAttribute(sE.COLOR,e)}else e.containsOnlyWireBodies()&&s.setAttribute(sE.COLOR,i);return s}addBodyOccurrenceFromMeshManager(e,t,i,s,n,r,a){if(n.hasFaces()){const o=new XI.bg;o.setAttribute(sE.COLOR,r);const h=n.getChordalTolerance();null!==h?o.setFloatUniform("uChordalTolerance",h):o.setFloatUniform("uChordalTolerance",Ci.W.MAX_MODEL_SIZE);const c=this.hasOccurrenceAlphaModifier(t)||this.viewer.getIsolatedOccurrenceManager()?.isOccurrenceTranslucent(i)?Zg.ALL_TRANSPARENT:this.getComputeBodyTransparency(s);switch(c){case Zg.ALL_OPAQUE:this.addFaceRangesToOccurrenceNode(e,n,i,o,c,qg.OPAQUE);break;case Zg.ALL_TRANSPARENT:this.addFaceRangesToOccurrenceNode(e,n,i,o,c,qg.TRANSPARENT);break;default:this.addFaceRangesToOccurrenceNode(e,n,i,o,c,qg.OPAQUE),this.addFaceRangesToOccurrenceNode(e,n,i,o,c,qg.TRANSPARENT)}const l=e.getOrCreateGroupRangesForGroupTypeAndLod(s,this.getMeshOwnerId(),Di.MX.SILHOUETTES,nE.DEFAULT);this.node.addOccurrenceGeometryToNode(this.getNodePropertiesForSilhouettes(i),i,a,l)}if((Sp||n.containsMesh())&&!this.scalarVisualizationOccurrences.has(i.getOccurrenceId())){const t=Dp.getMeshEdgeId(n.id),s=e.getOrCreateGroupRangesForGroupTypeAndLod(t,this.getMeshOwnerId(),Di.MX.LINES,nE.DEFAULT);this.node.addOccurrenceGeometryToNode(op,i,a,s)}if(n.hasEdges()){const t=e.getOrCreateGroupRangesForGroupTypeAndLod(s,this.getMeshOwnerId(),Di.MX.LINES,nE.DEFAULT);this.addSmoothEdgesBodyOccurrenceFromMeshManager(e,i,s,n,a),this.node.addOccurrenceGeometryToNode(this.getNodePropertiesForEdge(n,i),i,a,t)}if(n.hasPoints()){const t=e.getOrCreateGroupRangesForGroupTypeAndLod(s,this.getMeshOwnerId(),Di.MX.POINTS,nE.DEFAULT);this.node.addOccurrenceGeometryToNode(this.getNodePropertiesForPoint(n),i,a,t)}}addSmoothEdgesBodyOccurrenceFromMeshManager(e,t,i,s,n){const r=this.getNodePropertiesForSmoothEdges(s,t);if(r){const s=e.getOrCreateGroupRangesForGroupTypeAndLod(i+Dp.SMOOTH_EDGE_GROUP_SUFFIX,this.getMeshOwnerId(),Di.MX.LINES,nE.DEFAULT);this.node.addOccurrenceGeometryToNode(r,t,n,s)}}addFaceRangesToOccurrenceNode(e,t,i,s,n,r){const a=t.id;let o;o=this.scalarVisualizationOccurrences.has(i.getOccurrenceId())?t.containsOnlySheetBodies()?ip:tp:this.getNodePropertiesForFace(t,n,r);const h=e.getOrCreateGroupRangesForGroupTypeAndLod(a,this.getMeshOwnerId(),Di.MX.TRIANGLE_STRIP,nE.DEFAULT);let c=null,l=null,u=this.getSubBodyStyleOverrides(a,i.getOccurrenceId(),r),d=!1;if(n===Zg.ALL_OPAQUE||n===Zg.ALL_TRANSPARENT?c=h:n===Zg.OPAQUE_BODY_TRANSPARENT_FACE?r===qg.OPAQUE?(c=h,l=this.subBodyStyleOverrides.getNested(a,qg.TRANSPARENT)):(c=this.subBodyStyleOverrides.getNested(a,qg.TRANSPARENT),d=!0,u=null):n===Zg.TRANSPARENT_BODY_OPAQUE_FACE&&(r===qg.TRANSPARENT?(c=h,l=this.subBodyStyleOverrides.getNested(a,qg.OPAQUE),d=!0):(c=this.subBodyStyleOverrides.getNested(a,qg.OPAQUE),u=null)),c){let t=l;if(this.cosmeticThreadsEnabled){const n=this.cosmeticThreadComponent.addCosmeticThreadGeometry(e,a,l,o,i,s,d?c:u);if(n)if(t){const e=new qE;e.setOperand(t);const i=n;e.setOperandA(i),t=e}else t=n}this.node.addOccurrenceGeometryToNode(o,i,s,c,u,t)}}getSubBodyStyleOverrides(e,t,i){if(this.hasOccurrenceAlphaModifier(t)){const i=this.subBodyStyleOverrides.getNested(e,qg.OPAQUE),s=this.subBodyStyleOverrides.getNested(e,qg.TRANSPARENT);let n=null;if(i&&s){const e=new qE;e.setOperandA(i),e.setOperand(s),n=e}else i?n=i:s&&(n=s);if(n){const e=this.getOccurrenceAlphaModifier(t),i=new xE(LE(e));return i.setOperand(n),i}return null}return this.subBodyStyleOverrides.getNested(e,i)}getOccurrenceAlphaModifier(e){return this.occurrenceAlphaModifiers.has(e)?this.occurrenceAlphaModifiers.get(e):this.generativePartInstanceOccurrences.has(e)?is.M81:void 0}hasOccurrenceAlphaModifier(e){return this.occurrenceAlphaModifiers.has(e)||this.generativePartInstanceOccurrences.has(e)}getPartStudioBodyOccurrenceName(e){return Dp.PART_STUDIO_BODY_OCCURRENCE_PREFIX+"."+this.getMeshOwnerId()+"."+e}removeBodyOccurrence(e,t,i){e=this.getCorrectedBodyOccurrenceId(t,e);const s=Dp.getPotentialMeshGroupIdsForBody(t);for(let t=0;t<s.length;++t)this.node.removeMeshGroupFromOccurrence(s[t],e);if(this.decalComponent.removeOccurrence(e,t),this.cosmeticThreadsEnabled&&this.cosmeticThreadComponent.removeOccurrence(e),!i){if(e===this.partStudioBodyIdToOccurrenceId[t]){let i=!1;const s=this.baseComponent||this.previewClone;s&&(i=s.partStudioBodyIdToOccurrenceId.hasOwnProperty(t)),i||(this.viewer.getOccurrenceDataManager().destroyOccurrenceData(e),this.viewer.getOccurrenceIdManager().removeName(this.getPartStudioBodyOccurrenceName(t))),delete this.partStudioBodyIdToOccurrenceId[t]}this.bodyToOccurrenceId.removeNested(t,e),this.unavailableBodyOccurrences.removeNested(t,e),this.damageInstantiatedTriangleCount(),this.contributesToBodyManager()&&this.getBodyManager().removeOccurrence(e,t)}}refreshAllBodyOccurrences(){this.bodyToOccurrenceId.eachNested(((e,t,i)=>(this.refreshBodyOccurrence(+i,t),!1)),this)}refreshBodyOccurrence(e,t){this.removeBodyOccurrence(e,t,!0),this.addBodyOccurrence(e,t,!0)}refreshBodyOccurrenceForBodyId(e){this.refreshBodyOccurrence(this.partStudioBodyIdToOccurrenceId[e],e)}refreshBodyOccurrences(e,t){if(t){const t=this.partStudioBodyIdToOccurrenceId[e];t&&this.refreshBodyOccurrence(t,e)}else{const t=this.bodyToOccurrenceId.get(e);t&&t.each(((t,i)=>(this.refreshBodyOccurrence(+i,e),!1)),this)}}refreshOccurrence(e){const t=this.occurrences[e];t&&t.displayedPartIds.forEach((t=>{this.refreshBodyOccurrence(e,t)}))}updateBodiesWithChangedMeshReferences(){for(const e of this.bodiesWithUpdatedMeshReferences)this.damageComputedBodyTransparency(e),this.refreshBodyOccurrences(e);this.bodiesWithUpdatedMeshReferences.clear()}getInstantiableConstituentIds(e){if(e.isGroupableCompositeBody)throw new Error("Cannot instantiate constituents of grouped composites");if(e.isClosedComposite)return e.constituentBodyIds;const t=new Set;for(let i=0;i<e.constituentBodyIds.length;++i){const s=e.constituentBodyIds[i],n=this.bodyMetaData[s];n&&n.isClosedCompositeConstituent&&n.consumingClosedCompositeData.isGroupableCompositeBody?t.add(n.consumingClosedCompositeData.id):t.add(s)}return Array.from(t)}addOrUpdateOccurrence(e,t){if(!t)return;const i=new Set;for(let e=0;e<t.partIds.length;++e){const s=t.partIds[e],n=this.bodyMetaData[s];if(n&&n.isNonGroupingCompositeBody){const e=this.getInstantiableConstituentIds(n);for(let t=0;t<e.length;++t){const s=e[t];this.knownBodyIds.has(s)&&i.add(s)}}else this.knownBodyIds.has(s)&&i.add(s)}t.displayedPartIds=i;const s=this.occurrences[e]?this.occurrences[e].displayedPartIds:new Set,n=(0,Fs.R)(i,s),r=(0,Fs.R)(s,i);if((n.size>0||this.occurrences[e])&&super.addOrUpdateOccurrence(e,t),this.updateOccurrenceParts(e,t,n,r),i.size>0&&this.contributesToBodyManager()){const t=this.getBodyManager();i.forEach((s=>{const n=this.bodyMetaData[s],r=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(e);n&&t.addOrUpdateOccurrence(e,r,n,i.size)}))}}addPartStudioOccurrences(){for(const e in this.bodyMetaData)this.addPartStudioOccurrenceForBodyId(e);this.updateFlattenedBodyLayout()}addPartStudioOccurrenceForBodyId(e){const t=this.getBodyManager(),i=this.bodyMetaData[e];let s=this.partStudioBodyIdToOccurrenceId[e];if(i.isForFlattenedView()!==this.viewer.getIsForFlattenedDisplay()||i.isNonGroupingCompositeBody||i.canBeGroupedWithOtherConstituents)s&&(this.removeBodyOccurrence(s,e),delete this.partStudioBodyIdToOccurrenceId[e]);else{if(!s){s=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(this.getPartStudioBodyOccurrenceName(e));const n=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(s);if(this.partStudioBodyIdToOccurrenceId[e]=s,this.addBodyOccurrence(s,e),this.contributesToBodyManager()){const e=1;t.addOrUpdateOccurrence(s,n,i,e)}this.hideShowBody(e,i.partStudioVisibility,Jf.KF)}super.addOrUpdateOccurrence(this.partStudioBodyIdToOccurrenceId[e],null)}}updateOccurrenceParts(e,t,i,s,n){s.forEach((t=>{this.removeBodyOccurrence(e,t),this.damageInstantiatedTriangleCount()})),i.forEach((t=>{this.addBodyOccurrence(e,t,!1,n),this.damageInstantiatedTriangleCount()})),t.displayedPartIds.forEach((i=>{this.hideShowBody(i,t.isHidden?Fs.EE.HIDDEN:Fs.EE.VISIBLE,e)}))}reloadOccurrences(){const e=new Set;let t;for(t in this.occurrences){if(t=+t,Jf.KF===t){ut.log.warn("The part studio occurrence should not be reloaded");continue}const i=this.occurrences[t];if(i){const s=!0;this.updateOccurrenceParts(t,i,i.displayedPartIds,e,s)}}}removeOccurrence(e,t){const i=this.occurrences[e];if(i||e===Jf.KF){if(i)i.displayedPartIds.forEach((t=>this.removeBodyOccurrence(e,t)));else for(const e in this.partStudioBodyIdToOccurrenceId)this.removeBodyOccurrence(this.partStudioBodyIdToOccurrenceId[e],e);super.removeOccurrence(e,t)}}changeEntityOwner(e,t){const i=this.idToMetaData[e];if(!i)return void(Tp||(ut.log.error("Metadata for entity "+e+" owner "+t+" that is trying to switch between bodies was not found"),Tp=!0));if(!i.isFromBody())return void ut.log.error("Trying to switch entity to a part that did not belong to a part in the first place");if(i.getBodyId()===t)return;this.removeMeshIncrement(e),this.removeIdMappings(e);const s=this.bodyMetaData[t];if(!s)return void ut.log.error("Failed to find body metadata for body: "+t);const n=i.cloneForNewBody(s);n.getMeshIncrement()?(this.addIdMappings(e,n,t),this.updateEntityGraphics(e,n.getMeshIncrement(),n)):ut.log.error("Failed to find mesh increment for a body entity")}getBodyIdsWithConstituentsInScenegraph(e){const t=new Set(e);for(const i of e){const e=this.bodyMetaData[i];if(e&&e.isNonGroupingCompositeBody&&e.constituentBodyIds)for(const i of e.constituentBodyIds)t.add(i)}return t}getTranslucentEdgeColor(e){const t=this.viewer.translucentModeEdgeColorBodyColorFactor,i=[];return i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=this.viewer.translucentModeEdgeOpacity,i}setIsBodyClippedBySectionPlane(e,t,i,s){if(i){const i=this.getBodyOccurrenceData(e,this.partStudioBodyIdToOccurrenceId[e]);return void(i&&i.setIsClippedBySectionPlanes(t))}const n=this.getBodyIdsWithConstituentsInScenegraph(new Set([e])),r=s?this.getBodyIdsWithConstituentsInScenegraph(s):null;for(const e of n)r&&r.has(e)||this.setIsBodyClippedBySectionPlane(e,t,!0)}setAreOccurrencesClippedBySectionPlaneExcept(e,t){for(const t in this.bodyMetaData)this.setIsBodyClippedBySectionPlane(t,e);for(const i of t)this.setIsBodyClippedBySectionPlane(i,!e)}updateBodyMetaData(e,t,i,s,n,r,a){let o,h=this.bodyMetaData[t],c=!1,l=!1,u=null;h?o=h.consumingClosedCompositeData?h.consumingClosedCompositeData.id:"":(h=new ph.XH(t),this.bodyMetaData[t]=h);let d=!1;if(void 0!==o){d=o!==(r?r.id:"")}const g=h.type,p=h.meshState,m=h.isGroupableCompositeBody;if(h.setColorCycle(this.parent.getPartColorCycle()),i){h.name=i.name,h.meshState=i.meshState;let e=k.wG2.SOLID;i.isSheet?e=k.wG2.SHEET:i.isWire&&(e=k.wG2.WIRE),h.type=e,h.isModifiable!==i.isModifiable&&this.bodyVisibility.removeNested(this.partStudioBodyIdToOccurrenceId[t],t),h.isModifiable=i.isModifiable,h.setAppearanceFromDisplayData(i),h.isActiveSheetMetal=i.isActiveSheetMetal;const s=i.customProperties.properties[k.efh.TESSELLATION_SETTING_PROPERTY_ID];s&&(h.tessellationSettingOverride=+s),h.consumingClosedCompositeData&&(d=!0),h.consumingClosedCompositeData=null,u=new yi.kB(i.lowBoxCorner.getVec3(),i.highBoxCorner.getVec3())}else h.setAppearanceFromDisplayData(n),h.consumingClosedCompositeData=r,s&&(h.type=s.closedConstituentPartData.bodyType,h.isActiveSheetMetal=s.closedConstituentPartData.isActiveSheetMetal,h.meshState=s.closedConstituentPartData.meshState,u=new yi.kB(s.lowBoxCorner.getVec3(),s.highBoxCorner.getVec3()));if(s){const i=h.getFinestTessellationSettingInMemory();h.sheetMetalModelId=s.sheetMetalModelId,h.isFlattenedSheetMetalBody=s.isFlattenedSheetMetalBody,h.isBendCenterLineBody=s.isBendCenterLineBody,h.ownerFlattenedBodyId=s.ownerFlattenedBodyId,h.tessellationSettings=e.getPartTessellationSettings(t),h.sheetMetalOrderId=s.sheetMetalOrderId,s.hasTessellationComplexityInformation&&(h.coarseTriangleCount=s.coarseTriangleCount,h.coarsePlanarFaceTriangleCount=s.coarsePlanarFaceTriangleCount),h.isAssociatedWithFlat=s.isAssociatedWithFlat,h.totalEntityCount=s.totalEntityCount,h.bestAvailableTessellationSetting=s.bestAvailableTessellationSetting,null!==i&&h.getFinestTessellationSettingInMemory()!==i&&(l=!0),h.isComposite=s.isComposite,h.isClosedComposite=s.isClosedComposite,h.updateConstituentBodyIds(s.constituentBodyDeterministicIds,this.bodyMetaData)}if(h&&h.isComposite&&!this.viewer.areOptimizedBuffersEnabled&&h.updateDataDerivedFromConstituents(this.bodyMetaData,e.deterministicPartIdToData),u&&!u.equals(h.bounds)&&(h.bounds=u,h.resetMeshIncrement(),c=!0),h&&h.isClosedComposite){i||ut.log.warn("Expected to have display data for parent composite, but none was present");const t=null;for(let s=0;s<h.constituentBodyIds.length;++s){const n=h.constituentBodyIds[s],r=e.deterministicPartIdToData[n];this.updateBodyMetaData(e,n,t,r,i,h,m)}}if(d=d||"boolean"==typeof a&&a!==h.canBeGroupedWithOtherConstituents,d){this.baseComponent&&this.bodiesHiddenInBase.add(h.meshGroupId);const e=this.bodyToEntity.get(t);e&&(e.each(((e,t)=>{this.refreshEntityGraphics(t,h)})),h.setIsTessellationLoaded(h.canEntitiesBeLoaded()))}(g!==h.type||l||p!==h.meshState)&&this.refreshBodyOccurrences(t),this.updateBodyColor(t),c&&this.updateBodyManagerReferencesForBody(t);const f=this.unavailableBodyOccurrences.get(t);f&&(f.each(((e,i)=>(this.addBodyOccurrence(+i,t),!1))),this.unavailableBodyOccurrences.remove(t))}getBodyColorByBodyId(e){const t=this.bodyMetaData[e];return this.getBodyColor(t)}getBodyColor(e){return e?e.getColor():(0,Fs.zF)(La.y[0])}getBodyColorByBodyIdOccurrence(e,t){const i=this.bodyMetaData[e];return this.getBodyColorByBodyOccurrence(i,t)}getBodyColorByBodyOccurrence(e,t){const i=this.getBodyColor(e),s=this.viewer.getIsolatedOccurrenceManager();return s?.isOccurrenceTranslucent(t)?i[3]*=this.viewer.translucentModeFaceModeOpacity:t&&this.hasOccurrenceAlphaModifier(t.getOccurrenceId())&&(i[3]*=this.getOccurrenceAlphaModifier(t.getOccurrenceId())),i}getFaceColor(e,t){const i=this.idToMetaData[e];if(!i)return null;const s=this.entityStyles[e];if(s){let e=s.getAttribute(sE.COLOR);return this.hasOccurrenceAlphaModifier(t)&&(e=e.slice(),e[3]*=this.getOccurrenceAlphaModifier(t)),e}const n=this.viewer.getOccurrenceDataManager().getOccurrenceData(t);return this.getBodyColorByBodyIdOccurrence(i.getBodyId(),n)}setBodyOpacity(e,t,i){const s=this.bodyMetaData[e];s&&(s.appearance||(s.appearance=new k.QHW),s.appearance.color&&(s.appearance.opacity=t,this.updateBodyColor(e,i)))}setBodyColor(e,t,i){const s=this.bodyMetaData[e];if(s&&(s.appearance||(s.appearance=new k.QHW),s.appearance.color&&(s.appearance.color=t,this.updateBodyColor(e,i)),s.isComposite&&s.constituentBodyIds)){let e;e=lt.T.isElementAtVersionOrLater(k.vgi.V2422_ADJACENCY_CHECK_COPY_FACE)&&s.isOpenCompositeBody?this.replaceConsumedBodyIdsWithConsumingCompositeId(s.constituentBodyIds):s.constituentBodyIds;for(const s of e)this.setBodyColor(s,t,i)}}replaceConsumedBodyIdsWithConsumingCompositeId(e){const t=new Set;for(const i of e)t.add(this.bodyMetaData[i]?.consumingClosedCompositeData?.id??i);return[...t]}updateBodyColor(e,t){const i=this.getBodyColorByBodyId(e);(0,li.arraysEqual)(this.lastSetBodyColor[e],i)||(this.lastSetBodyColor[e]=i,this.damageComputedBodyTransparency(e),this.refreshBodyOccurrences(e,t))}getOccurrenceColor(e){const t=this.viewer.getOccurrenceIdManager().getIdForName(e.toString());if(t===Jf.Qy)return null;const i=this.occurrences[t];if(!i)return null;const s=this.viewer.getOccurrenceDataManager().getOccurrenceData(t);for(const e of i.displayedPartIds){const t=this.getBodyColorByBodyIdOccurrence(e,s);if(t)return t.slice(0)}return null}setOccurrenceAlphaModifier(e,t){if(t<0||t>=1)return void ut.log.warn("Only alpha modifiers in the range [0, 1) are accepted");const i=this.viewer.getOccurrenceIdManager().getIdForName(e.toString());i!==Jf.Qy&&(this.occurrenceAlphaModifiers.set(i,t),this.refreshOccurrence(i))}clearOccurrenceAlphaModifier(e){const t=this.viewer.getOccurrenceIdManager().getIdForName(e.toString());t!==Jf.Qy&&this.occurrenceAlphaModifiers.delete(t)&&this.refreshOccurrence(t)}getEntityColor(e){const t=this.entityStyles[e];if(t){const e=t.getAttribute(sE.COLOR);if(e)return e.slice()}const i=this.idToMetaData[e];return i?this.getBodyColorByBodyId(i.getBodyId()):null}getOccurrenceBounds(e){const t=new yi.kB,i=this.occurrences[e];return i&&i.displayedPartIds.forEach((i=>{t.addBox(this.getBodyManager().getOccurrenceBounds(e,i))})),t}getEntityBodyGroupId(e){const t=e.getBodyId(),i=this.bodyMetaData[t];return i?i.meshGroupId:t}setScalarVisualizationOccurrence(e,t){this.scalarVisualizationOccurrences.add(e),t?this.refreshBodyOccurrence(e,t):this.refreshOccurrence(e)}clearScalarVisualizationOccurrence(e,t){this.scalarVisualizationOccurrences.delete(e),t&&e?this.refreshBodyOccurrence(e,t):e&&this.refreshOccurrence(e)}clearAllScalarVisualizationOccurrences(){this.scalarVisualizationOccurrences=new Set,this.refreshAllBodyOccurrences()}isVisualizingOccurrences(){return this.scalarVisualizationOccurrences.size>0}setGenerativeDesignVisualizationOccurrence(e){this.generativePartInstanceOccurrences.add(e),this.refreshOccurrence(e)}clearGenerativeDesignOccurrence(e){this.generativePartInstanceOccurrences.delete(e),this.refreshOccurrence(e)}clearAllGenerativeDesignOccurrences(){const e=this.generativePartInstanceOccurrences;this.generativePartInstanceOccurrences=new Set;for(const t of e)this.refreshOccurrence(t)}updateEntityHighlight(e,t,i,s){const n=this.idToMetaData[i];if(!n)return!1;const r=this.getEntityBodyGroupId(n);if((s=this.getCorrectedBodyOccurrenceId(r,s))===Jf.Qy||!s)return!1;const a=this.bodyMetaData[n.getBodyId()];if(a&&a.isForFlattenedView()){if(!(a.sheetMetalModelId===this.viewer.getModelViewManagers().getManager().getSelectedSheetmetalModelId())&&!this.isOccurrenceIdForAssembly(s))return!1}return Hd.prototype.updateEntityHighlight.call(this,e,t,i,s)}getBodyOccurrenceData(e,t){return(t=this.getCorrectedBodyOccurrenceId(e,t))!==Jf.Qy&&t&&this.bodyToOccurrenceId.hasNested(e,t)?this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(t):null}hideShowBody(e,t,i){let s=!1;const n=this.bodyMetaData[e];if(n&&n.isClosedComposite&&!n.isGroupableCompositeBody)for(let e=0;e<n.constituentBodyIds.length;++e)s=this.hideShowBody(n.constituentBodyIds[e],t,i)||s;!i&&n&&(n.partStudioVisibility=t);const r=this.getBodyOccurrenceData(e,i);return r&&r.getVisibility()!==t&&(r.setVisibility(t),this.viewer.requestDraw(),s=!0),s&&(0,Yg.PT)()?.getInferenceSetController()?.updateInferencingOnPartVisibilityChange(e,t),s}setBodyCullingState(e,t,i,s){const n=this.getBodyOccurrenceData(i,e);if(n&&n.getMeshGroupCullingState(i)!==t){const r=Dp.getPotentialMeshGroupIdsForBody(i);for(let e=0;e<r.length;++e)n.setCullingState(t,r[e]);t!==Fs.uc.CULLED&&s?this.decalComponent.addOrUpdateOccurrence(i,e):this.decalComponent.removeOccurrence(e,i),this.viewer.requestDraw()}}isEntityHidden(e,t){const i=this.getBodyOccurrenceData(this.getEntityBodyGroupId(e),t);return!!i&&i.getVisibility()===Fs.EE.HIDDEN}getBodyDisplay(e){const t=this.bodyMetaData[e];return t?t.meshIncrement?t.meshIncrement:t.isSolidBody()||t.isSheetBody()?(t.meshIncrement=(0,Au.dO)(t.getBounds().getMin(),t.getBounds().getMax()),t.meshIncrement.id=e,t.meshIncrement.groupId=e,t.meshIncrement.lod=nE.LOWEST,t.meshIncrement.pickId=this.getEntityIdManager().getOrCreateIdForName(e),t.meshIncrement):null:null}getOccurrenceIdForEntity(e){let t;if(this.idToMetaData[e]&&this.idToMetaData[e]instanceof k.Wzw){const i=this.idToMetaData[e];i.bodyMetaData&&(t=this.partStudioBodyIdToOccurrenceId[i.bodyMetaData.id])}return t}getStatistics(e,t=!1){const i={faces:0,triangles:0,edges:0,lines:0,vertices:0,silhouettes:0,settingCounts:{},uniqueParts:0,uniqueSurfaces:0,uniqueCurves:0,uniqueOpenComposites:0,uniqueClosedComposites:0,partOccurrences:0,surfaceOccurrences:0,curveOccurrences:0,openCompositeOccurrences:0,openCompositeConstituentOccurrences:0,closedCompositeOccurrences:0,closedCompositeConstituentOccurrences:0,bodiesPendingRetrieval:0,veryFineParts:new Map,veryFineOccurrences:[]},s=this.getMeshManager(),n=this.getMeshOwnerId(),r=new Set,a=new Set,o=new Map,h=[],c=(l,u,d)=>{if(e){const e=this.bodyToEntity.get(l);e&&e.each(((e,t)=>{const s=this.idToMetaData[t];if(s)return s.isFace()?(i.faces+=1,i.triangles+=s.getMeshIncrement().getTriangleCount()):s.isLine()?(i.edges+=1,i.lines+=s.getMeshIncrement().getLineCount()):s.isVertex()&&(i.vertices+=1),!1}));const t=s.getGroupRangesForGroupTypeAndLod(l,n,Di.MX.SILHOUETTES,nE.DEFAULT);t&&(i.silhouettes+=t.getPrimitiveCount())}const g=this.bodyMetaData[l],p=this.occurrences[u],m=k.ls1.getTessellationSettingIndexFromEnum(k.XiJ.VERY_FINE);if(g&&g.tessellationSettings){if(!g.isClosedCompositeConstituent)for(let e=0;e<g.tessellationSettings.length;++e){const s=g.tessellationSettings[e],n=i.settingCounts[s]||0;i.settingCounts[s]=n+1,t&&s===m&&(p?h.push(p.occurrenceData.occurrence):g&&(o.has(l)||o.set(l,g)))}if(g.isClosedComposite&&!a.has(g)&&(i.uniqueClosedComposites++,a.add(g)),d&&(g.isClosedComposite?i.closedCompositeOccurrences++:g.isSolidBody()?i.partOccurrences++:g.isSheetBody()?i.surfaceOccurrences++:g.isWireBody()&&i.curveOccurrences++),g.isClosedComposite&&d)for(let e=0;e<g.constituentBodyIds.length;++e)c(g.constituentBodyIds[e],u,!1);if(g.isClosedCompositeConstituent&&d){i.closedCompositeConstituentOccurrences++;const e=p?u:g.consumingClosedCompositeData.id;r.has(e)||(c(g.consumingClosedCompositeData.id,u,!1),r.add(u))}else if(g.hasReferencingOpenCompositeBody&&p){const e=this.bodyMetaData[p.partIds[0]];e.isOpenCompositeBody&&(i.openCompositeConstituentOccurrences++,r.has(u)||(i.openCompositeOccurrences++,r.add(u)),a.has(e)||(i.uniqueOpenComposites++,a.add(e)))}}};return this.bodyToOccurrenceId.each(((e,t)=>{const s=this.bodyMetaData[t];return s&&(s.isComposite||s.isClosedCompositeConstituent||(s.isSolidBody()?i.uniqueParts++:s.isSheetBody()?i.uniqueSurfaces++:s.isWireBody()&&i.uniqueCurves++,s.canEntitiesBeLoaded()||i.bodiesPendingRetrieval++)),e.each((function(e,i){return c(t,i,!0),!1})),!1}),this),t&&(i.veryFineParts=o,i.veryFineOccurrences=h),i}getPartStudioBodyOccurrenceIds(){const e=[];for(const t in this.partStudioBodyIdToOccurrenceId)e.push(this.partStudioBodyIdToOccurrenceId[t]);return e}showPartsWithSheetmetalModelIdOnly(e){for(const t in this.partStudioBodyIdToOccurrenceId)if(t in this.bodyMetaData){this.bodyMetaData[t].sheetMetalModelId===e?this.hideShowBody(t,Fs.EE.VISIBLE,Jf.KF):this.hideShowBody(t,Fs.EE.HIDDEN,Jf.KF)}}needsDisplayData(e){let t=!1;for(let i=0;i<e.partDisplayData.length;i++){const s=e.partDisplayData[i];t=t||s.id in this.bodyMetaData&&this.bodyMetaData[s.id].isForFlattenedView()}return t}isBodyActiveInView(e,t){const i=this.bodyMetaData[e];if(i&&i.isComposite&&!t)return!0;const s=this.getCorrectedBodyOccurrenceId(e,this.viewer.getIdForOccurrence(t)),n=this.occurrences[s];return n?n.containsPart(e)||n.displayedPartIds.has(e):!!this.bodyToOccurrenceId.hasNested(e,s)&&(!this.viewer.getIsForFlattenedDisplay()||this.isBodyVisible(s,e))}getTransformFromSheetMetalBodyMetaData(e){const t=e.sheetMetalOrderId.split(" "),i=e.sheetMetalOrder;if(0===i||i>t.length)return de.create();const s=t.slice(0,i).join(" ");return this.sheetMetalOrderIdToTransform[s]}isEntityMeasurable(e,t){const i=this.getEntityMetaData(e);return!!i&&this.isBodyActiveInView(this.getEntityBodyGroupId(i),t)}updateFlattenedBodyLayout(){if(!this.viewer.getIsForFlattenedDisplay())return;if((0,Fs.hW)(this.partStudioBodyIdToOccurrenceId))return;this.sheetMetalOrderIdToTransform={};const e=10*Math.max.apply(Math,Object.values(this.bodyMetaData||{}).map((function(e){return e.bounds.max[2]-e.bounds.min[2]}))),t={},i=Object.keys(this.bodyMetaData||{}),s=this;i.sort((function(e,t){const i=s.bodyMetaData[e],n=s.bodyMetaData[t];return!i.isSubsidiaryBody()&&n.isSubsidiaryBody()?-1:i.isSubsidiaryBody()&&!n.isSubsidiaryBody()?1:i.sheetMetalOrderId<n.sheetMetalOrderId?-1:i.sheetMetalOrderId>n.sheetMetalOrderId?1:0}));const n={};let r="";for(let s=0;s<i.length;s++){const a=i[s],o=this.bodyMetaData[a];let h=t[o.sheetMetalModelId];h||(h=new yi.kB,t[o.sheetMetalModelId]=h);const c=o.sheetMetalOrderId.split(" ");let l=c[0],u=1;for(;u<c.length&&!(r<l);u++)l+=" "+c[u];o.sheetMetalOrder=u,r=l;const d=o.bounds;let g,p;h.isInitialized()?(g=h.max[0]+e-d.min[0],p=h.max[1]-d.max[1]):(g=0,p=0);const m=-d.max[2],f=this.partStudioBodyIdToOccurrenceId[a];f||ut.log.warn("No occurrence for flattened body "+a);let I=de.create();if(ge.w$.translate(I,[g,p,m]),o.isSubsidiaryBody()){const e=n[o.getOwnerBodyId()];e&&(I=e)}this.viewer.getOccurrenceDataManager().setOccurrenceTransform(f,I),this.updateBodyManagerReferencesForBody(a),h.addBox(d,I),n[a]=I,this.sheetMetalOrderIdToTransform[l]=I}}hasBody(e){return this.bodyMetaData.hasOwnProperty(e)}hasBodyOccurrence(e,t){const i=this.getCorrectedBodyOccurrenceId(e,this.viewer.getIdForOccurrence(t));return this.bodyToOccurrenceId.hasNested(e,i)}contributesToBodyManager(){return this.isForBase()}updateBodyManagerReferencesForBody(e){const t=this.bodyMetaData[e];if(!t||!this.contributesToBodyManager())return;const i=this.getBodyManager(),s=this.bodyToOccurrenceId.get(e);s&&s.each(((s,n)=>{n=+n;let r=1;const a=this.occurrences[n];return a&&(r=a.displayedPartIds.size),i.addOrUpdateOccurrence(n,this.getBodyOccurrenceData(e,n),t,r),!1}),this)}setDebugFaceTriangles(e){if(Sp=e,Sp)for(const e in this.idToMetaData){const t=this.idToMetaData[e],i=t.getMeshIncrement();i&&this.addMeshTriangleEdges(i,t)}this.refreshAllBodyOccurrences()}integrityCheck(){const e=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio()===this.parent;for(const t in this.bodyMetaData){if(null!==this.bodyMetaData[t].getFinestTessellationSettingInMemory()){const e=this.bodyToEntity.get(t);e&&!e.isEmpty()||ut.log.info("Body "+t+" is missing entity data in "+this.parent.getFullElementId())}else e&&ut.log.info("Body "+t+" has no tessellation available, but it is in the active part studio: "+this.parent.getFullElementId())}}collectComponentsForHeapDump(e){for(const t in this.idToMetaData){const i=this.idToMetaData[t],s=i.getMeshIncrement();e.meshIncrements.push(s),e.entityData.push(i),i.isFace()&&!i.isPlanarFace()&&e.silhouetteIncrements.push(Xf(s));const n=this.getMeshIncrementDetails(t);n?e.incrementDetails.push(n):console.warn("Did not find increment details for "+t)}this.reset()}getSmoothEdgeCountForCompositeBody(e){return e.constituentBodyIds.reduce(((e,t)=>e+(this.bodyIdToSmoothEdges.get(t)?.size??0)),0)}updateBodiesWithChangedSmoothEdgesCount(){const e=new Set;for(const[t,i]of this.bodyIdToSmoothEdges){const s=this.bodyMetaData[t];s?.consumingClosedCompositeData?.isGroupableCompositeBody?e.add(s.consumingClosedCompositeData):this.updateBodyIfSmoothEdgeCountChanged(s,i.size)}for(const t of e)this.updateBodyIfSmoothEdgeCountChanged(t)}syncPartSmoothEdgeCount(e,t){return e.isGroupableCompositeBody?this.syncGroupableBodySmoothEdgesCount(e):this.syncBodySmoothEdgesCount(e.getId(),t)}syncBodySmoothEdgesCount(e,t){if(!t&&0!==t){const i=this.bodyIdToSmoothEdges.get(e);if(!i)return[0,0];t=i.size}const i=this.previousBodyIdToSmoothEdgesCount.get(e)??0;return this.previousBodyIdToSmoothEdgesCount.set(e,t),[i,t]}syncGroupableBodySmoothEdgesCount(e){let t=0,i=0;for(const s of e.constituentBodyIds){const[e,n]=this.syncBodySmoothEdgesCount(s);i+=n,t+=e}return[t,i]}updateBodyIfSmoothEdgeCountChanged(e,t){const i=e.getId();let s;[s,t]=this.syncPartSmoothEdgeCount(e,t);const n=t>0;if(s>0!==n){const t=this.bodyToOccurrenceId.get(i);if(!t)return;if(n)for(const s of t.getKeys()){const t=this.getBodyOccurrenceData(i,+s),n=this.getEdgeStyleByBodyOccurrence(e,t);this.addSmoothEdgesBodyOccurrenceFromMeshManager(this.getMeshManager(),t,i,e,n),this.getSharedBaseMeshManager()&&!this.bodiesHiddenInBase.has(i)&&this.addSmoothEdgesBodyOccurrenceFromMeshManager(this.getSharedBaseMeshManager(),t,i,e,n)}else for(const e of t.getKeys())this.node.removeMeshGroupFromOccurrence(i+Dp.SMOOTH_EDGE_GROUP_SUFFIX,+e)}}}Dp.PART_STUDIO_BODY_OCCURRENCE_PREFIX="body",Dp.MESH_EDGE_GROUP_SUFFIX="_meshEdges",Dp.SMOOTH_EDGE_GROUP_SUFFIX="_smoothEdges";class Mp extends Hd{constructor(e,t){super(e,t)}getComponentId(){return"error_component."}handlesEntity(e,t){return e.hasTessellationError()&&!this.viewer.getIsForFlattenedDisplay()}expectsTessellation(){return!1}removeBaseIncrement(e){}updateEntityGraphics(e,t,i){}getHideableFeatureIds(){return[]}}const Cp=X.default.getManager(),yp=new Mi;let Pp=0;Object.values(k.ea7).forEach((e=>{(0,Gr.Z)(e)&&(Pp=Math.max(e,Pp))}));const Ap=Math.ceil(Math.log(Pp)/Math.log(2)),Op="sketch_component.";class vp extends kd{constructor(e,t,i){super(e,i,t),this.activeSketches={},this.hasBeenInstantiated=!1,this.entityColors=new Map,this.sketchToSMModelIdMapping={},this.idToPartData={},this.sketchToSketchEntityMapping=new gl.TemplatedNestedMap,this.styledRanges=new gl.TemplatedNestedMap,this.node=e?e.getModelViewManager().getSharedSketchNode():null,this.sketchComponentElementId=this.viewer.getOccurrenceIdManager().getOrCreateIdForName("PART_STUDIO_SKETCHES")}getNode(){return this.node}isEntityInActiveSketch(e){return this.activeSketches.hasOwnProperty(e.getSketchFeatureId())}isSketchInContext(e){return e!==this.sketchComponentElementId&&this.viewer.getModelViewManagers().getManager().displayingPartStudio()}updateMissingEntityGraphicsForSketch(e,t){const i=this.sketchToSketchEntityMapping.get(e);for(const e in i){if(t.deterministicIdToEntity[e])continue;const s=i[e],n=this.idToMetaData[s];if(!n)continue;const r=n.getMeshIncrement();r&&(this.removeMeshIncrement(r.id),this.updateEntityGraphics(s,r,n))}}processAdditionsAndChanges(e,t){const i={};for(const t in e.deterministicPartIdToData){const s=e.deterministicPartIdToData[t];for(let t=0;t<s.entityDIds.length;++t){const n=s.entityDIds[t],r=e.deterministicIdToEntity[n];r&&!r.isDeletion()&&this.handlesEntity(r,s)&&(r.isAssociatedWithFlat=s.isAssociatedWithFlat,r.isAssociatedWithFlat&&(i[r.getFirstFeatureId()]=s.ownerFlattenedBodyId),this.idToPartData[n]=s)}}const s=Object.keys(e.sketchFeatureIdAndTessellationSettingToBuffers);this.processPrecompiledGraphicsBuffers(e.sketchFeatureIdAndTessellationSettingToBuffers);for(const t in this.sketchToSMModelIdMapping)i[t]||this.updateMissingEntityGraphicsForSketch(t,e);if(this.updateEntityAppearanceOverrides(e),super.processAdditionsAndChanges(e,t),t&&this.viewer.areOptimizedBuffersEnabled&&s.length>0){const e=this.sketchComponentElementId;for(const t of s)this.featureToIds.insertKeyOnly(t),this.addSketchFeatureToSceneGraph(t,this.getMeshManager(),e)}}getEntityColor(e){const t=this.entityColors.get(e);return t?t.color:null}getEntityOverrideId(e){const t=this.entityColors.get(e);return t?t.overrideId:""}getOverrideColor(e){return[e.color[0]/255,e.color[1]/255,e.color[2]/255,e.opacity/255]}updateEntityAppearanceOverrides(e){const t=new Set;for(const i in e.appearanceIdToAppearanceOverride){const s=e.appearanceIdToAppearanceOverride[i],n=i===k.QHW.RESET_APPEARANCE_ID?null:this.getOverrideColor(s.appearance);for(let r=0;r<s.entityDeterministicIds.length;++r){const a=s.entityDeterministicIds[r],o=e.deterministicIdToEntity[a]||this.idToMetaData[a];if(!o||!this.handlesEntity(o))continue;const h=o.getLastFeatureId();if(!t.has(h)){t.add(h);for(const e in this.occurrences)this.clearSketchGraphics(h,+e)}if(n){const e={overrideId:i,color:n};this.entityColors.set(a,e)}else this.entityColors.delete(a)}}for(const e of t)for(const t in this.occurrences)this.instantiateSketchGraphics(e,+t)}getColorForSketch(e){const t=this.featureToIds.get(e);let i=null;return t&&t.each(((e,t)=>(i=this.getEntityColor(t),!!i))),i}processDeletions(e){for(const t in e.deterministicIdToEntity){const i=e.deterministicIdToEntity[t];i&&this.handlesEntity(i)&&this.removeEntity(t)}super.processDeletions(e);for(const t in e.deterministicIdToEntity){const i=e.deterministicIdToEntity[t];i&&this.handlesEntity(i)||this.entityColors.delete(t)}}reset(){for(const e in this.idToMetaData)this.removeMeshIncrement(e);this.clearGraphics(),this.entityColors.clear(),this.sketchToSketchEntityMapping.clear(),this.sketchToSMModelIdMapping={},this.idToPartData={},super.reset()}clearGraphics(){for(const e in this.occurrences)this.node?.removeOccurrence(+e);this.styledRanges.eachNested((e=>(e.getMeshRanges().destroy(),!1))),this.styledRanges.clear()}addIdMappings(e,t,i,s){super.addIdMappings(e,t,i,s);const n=t.getSketchFeatureId();this.sketchToSketchEntityMapping.insertNested(n,t.getSketchEntityId(),e);const r=s&&s.incremental,a=this.idToPartData[e],o=!!a&&!a.isAssociatedWithFlat;r&&o&&ua(n)}getSMModelIdForSketch(e){return this.sketchToSMModelIdMapping[e]}removeIdMappings(e){const t=this.idToMetaData[e];if(!t)return;const i=t.getSketchFeatureId();this.sketchToSketchEntityMapping.removeNested(i,t.getSketchEntityId()),delete this.idToPartData[e],delete this.sketchToSMModelIdMapping[i],super.removeIdMappings(e)}retrieveBodyMetaData(e){const t=this.bodyToEntity.get(e);if(t&&t.size()>0){const i=new ph.XH(e);let s=!1,n=!1,r=!1;return t.each(((e,t)=>{const i=this.idToMetaData[t];i&&(i.isVertex()?s=!0:i.isEdge()?n=!0:i.isFace()&&(r=!0))})),r?i.type=k.wG2.SHEET:n?i.type=k.wG2.WIRE:s&&(i.type=k.wG2.POINT),i.isSketchBody=!0,i}return null}getNodeProperties(e,t,i,s){let n=Cp.getNumber("DEFAULT_Z_OFFSET");e.isFace()?n=Cp.getNumber("SKETCH_FACES_Z_OFFSET"):e.isEdge()?n=Cp.getNumber("SKETCH_EDGES_Z_OFFSET"):e.isVertex()?n=Cp.getNumber("SKETCH_POINTS_Z_OFFSET"):e.isDegenerateEdge()&&(n=Cp.getNumber("DEGENERATE_Z_OFFSET"));let r=xi.DO.DEFAULT;return e.isSketchConstructionEntity()&&e.isEdge()&&(ws()?t=!1:this.isEntityInActiveSketch(e)||(r=xi.DO.LOWER)),t&&this.isSketchInContext(i)&&(r=xi.DO.LOWER),new xi.hF({primitiveType:s,isTwoSided:e.isFace(),primitivesHaveTransparency:e.isFace(),material:bi,isPickable:!(t&&e.isFace()),isShowThrough:t,isDepthTested:!t,isStencilTested:t,isHighlightable:!t||e.isSketchConstructionEntity(),zOffset:n,addsToBounds:!e.isVertex()||e.isSketchUserPoint(),priority:r,includedInBlend:!0,isTintedByCompare:!0})}getStyle(e,t,i,s){let n=null,r=null,a=null;if(e.isFace())n=i?Cp.getColor("SKETCH_FACE_SHOW_THROUGH_COLOR"):Cp.getColor("SKETCH_FACE_COLOR");else{if(t){const t=e.getSketchSolveStatus();n=e.isEdge()&&(e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon())?Cp.getColor("SPLINE_HANDLE_COLOR"):e.isPreviewEntity?Cp.getColor("SKETCH_PREVIEW_COLOR"):t&&t!==k.ea7.UNKNOWN?t===k.ea7.UNDER_DEFINED?i?Cp.getColor("UNDERCONSTRAINED_SHOW_THROUGH_LINE_POINT_COLOR"):Cp.getColor("UNDERCONSTRAINED_LINE_POINT_COLOR"):t===k.ea7.FIXED||t===k.ea7.WELL_DEFINED?i?Cp.getColor("CONSTRAINED_SHOW_THROUGH_LINE_POINT_COLOR"):Cp.getColor("CONSTRAINED_LINE_POINT_COLOR"):i?Cp.getColor("OVERCONSTRAINED_SHOW_THROUGH_LINE_POINT_COLOR"):Cp.getColor("OVERCONSTRAINED_LINE_POINT_COLOR"):i?Cp.getColor("SHOW_THROUGH_LINE_POINT_COLOR"):Cp.getColor("LINE_POINT_COLOR")}else n=Cp.getColor("INACTIVE_SKETCH_COLOR");e.isVertex()?(r=t?e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon()?Cp.getNumber("ACTIVE_SKETCH_SPLINE_HANDLE_SIZE"):e.isSketchUserPoint()?Cp.getNumber("ACTIVE_SKETCH_USER_POINT_SIZE"):Cp.getNumber("ACTIVE_SKETCH_POINT_SIZE"):e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon()?Cp.getNumber("INACTIVE_SKETCH_SPLINE_HANDLE_SIZE"):e.isSketchUserPoint()?Cp.getNumber("INACTIVE_SKETCH_USER_POINT_SIZE"):Cp.getNumber("INACTIVE_SKETCH_POINT_SIZE"),a=e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon()?Cp.getPointFont("SKETCH_SPLINE_HANDLE_POINT_FONT"):e.isSketchUserPoint()?Cp.getPointFont("SKETCH_USER_POINT_FONT"):Cp.getPointFont("SKETCH_POINT_FONT")):e.isEdge()?(r=t?i?Cp.getNumber("ACTIVE_SKETCH_SHOW_THROUGH_LINE_WIDTH"):e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon()?Cp.getNumber("SPLINE_HANDLE_LINE_WIDTH"):Cp.getNumber("ACTIVE_SKETCH_LINE_WIDTH"):i?Cp.getNumber("INACTIVE_SKETCH_SHOW_THROUGH_LINE_WIDTH"):e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon()?Cp.getNumber("INACTIVE_SKETCH_SPLINE_HANDLE_SIZE"):Cp.getNumber("INACTIVE_SKETCH_LINE_WIDTH"),a=!e.isSketchConstructionEntity()||e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon()?t?Cp.getStipple("DEFAULT_LINE_STIPPLE"):i?Cp.getStipple("DEFAULT_SHOW_THROUGH_LINE_STIPPLE"):Cp.getStipple("DEFAULT_LINE_STIPPLE"):Cp.getStipple("CONSTRUCTION_LINE_STIPPLE")):e.isDegenerateEdge()&&(r=t?Cp.getNumber("DEGENERATE_EDGE_ACTIVE_SIZE"):Cp.getNumber("DEGENERATE_EDGE_INACTIVE_SIZE"),a=t?Cp.getPointFont("SKETCH_DEGENERATE_EDGE_FONT"):Cp.getPointFont("SKETCH_POINT_FONT"))}if(e.isFace()&&ws()&&e instanceof k.lo2&&(n=(0,Au.KJ)(this.getEntityPlaneId(e))),!t){const e=this.getEntityColor(s);e&&(n=e)}const o=new XI.bg;return n&&o.setAttribute(sE.COLOR,n),null!==r&&o.setAttribute(sE.PRIMITIVE_SIZE,r),a&&o.setAttribute(sE.PRIMITIVE_STYLE,a),o}getEntityPlaneId(e){if(!e.isFace())return 0;const t=e.getMeshIncrement();if(!t)return 0;const i=t.points,s=t.normals;return(0,Au.Tf)([i[0],i[1],i[2]],[s[0],s[1],s[2]])}handlesEntity(e,t){return!(t&&this.viewer.getIsForFlattenedDisplay()&&!t.isForFlattenedView())&&e.isFromSketch()&&(this.viewer.areOptimizedBuffersEnabled||!e.hasTessellationError())}getOwnerFlattenedBodyIdForSketch(e){const t=this.sketchToSketchEntityMapping.get(e);if(!t)return null;let i=null;return t.each(((e,t)=>{const s=this.idToPartData&&this.idToPartData[e];if(s)return s.isAssociatedWithFlat&&(i=s.ownerFlattenedBodyId),!0})),i}getOwnerFlattenedBodyId(e){const t=this.idToPartData[e];return t&&t.isAssociatedWithFlat?t.ownerFlattenedBodyId:null}getSheetMetalModelId(e){const t=this.getOwnerFlattenedBodyId(e);if(t){const e=this.parent.retrieveBodyMetaData(t);if(e)return e.sheetMetalModelId}return null}getTransformForSketchEntity(e){const t=this.getOwnerFlattenedBodyId(e),i=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();if(t&&i){const e=i.retrieveBodyMetaData(t);if(e)return i.getBodyComponent().getTransformFromSheetMetalBodyMetaData(e)}return de.create()}updateSMMapping(e,t){if(this.viewer.getIsForFlattenedDisplay()){const i=this.getOwnerFlattenedBodyId(e);if(this.parent&&i){const e=this.parent.retrieveBodyMetaData(i);e&&(this.sketchToSMModelIdMapping[t.getLastFeatureId()]=e.sheetMetalModelId)}}}updateEntityGraphics(e,t,i){if(!t)return;if(this.viewer.getIsForFlattenedDisplay()){const s=this.getOwnerFlattenedBodyId(e);if(this.parent&&s){const e=this.parent.retrieveBodyMetaData(s);if(e){this.sketchToSMModelIdMapping[i.getSketchFeatureId()]=e.sheetMetalModelId;const s=this.parent.getBodyComponent().getTransformFromSheetMetalBodyMetaData(e);s&&(t=t.createTransformed(s))}}}let s;for(s in this.addMeshIncrement(t),this.occurrences)s=+s,this.isEntityForDisplay(e,i,s)&&this.updateEntityOccurrenceGraphics(e,s,i)}getOccurrenceIdForEntity(e){return this.sketchComponentElementId}getHideableFeatureIds(){return this.featureToIds.getKeys()}copySketchDataToClone(e){e.sketchToSketchEntityMapping=this.sketchToSketchEntityMapping.cloneNested(),e.idToPartData=(0,j.shallowClone)(this.idToPartData),e.sketchToSMModelIdMapping=(0,j.shallowClone)(this.sketchToSMModelIdMapping),e.entityColors=new Map(this.entityColors)}clone(e){const t=new vp(e,this.usage,this.viewer);return this.copyToClone(t),this.copySketchDataToClone(t),t}cloneForPreview(e){const t=new vp(e,fs.L.PREVIEW,this.viewer);this.copyToPreview(t),this.copySketchDataToClone(t);for(const e in this.activeSketches)t.activeSketches[e]=this.activeSketches[e];t.hasBeenInstantiated=!0;for(const e in this.occurrences)t.addOrUpdateOccurrence(+e,this.occurrences[e]);return t}removeMeshIncrement(e){const t=this.getMeshManager().removeMeshIncrement(e,this.getMeshOwnerId());if(!t)return null;let i;for(i in this.occurrences){const s=this.occurrences[i];i=+i,(!s||s.containsPart(e)||s.displayedSketchEntityIds.has(e))&&this.removeEntityFromOccurrence(e,i,t)}return t}onAppearanceConstantsUpdated(){this.clearGraphics();for(const e of this.featureToIds.getKeys())for(const t of Object.keys(this.occurrences))this.instantiateSketchGraphics(e,+t)}removeEntityFromOccurrence(e,t,i){const s=this.idToMetaData[e];if(!s)return;if(!i&&!(i=this.getMeshManager().getIncrementDetails(e,this.getMeshOwnerId())))return;const n=this.isSketchDisplayedAsActive(s.getSketchFeatureId(),t);this.getRanges(e,s,t,n,!1).onIncrementRemoved(i);this.getRanges(e,s,t,n,!0).onIncrementRemoved(i)}accumulateSketchIdsFromBodyId(e,t){const i=this.bodyToEntity.get(e);if(i)for(const e of i.getKeys()){const i=this.idToMetaData[e];if(i&&i.getFeatureIds())for(const e of i.getFeatureIds())t.add(e)}}displaySketchAsActive(e,t){this.activeSketches.hasOwnProperty(e)!==t&&(this.clearSketchGraphics(e),t?this.activeSketches[e]=!0:delete this.activeSketches[e],this.instantiateSketchGraphics(e),t&&this.hideShowFeature(e,Fs.EE.VISIBLE))}isSketchDisplayedAsActive(e,t){return t===this.sketchComponentElementId&&this.activeSketches.hasOwnProperty(e)}hasActiveSketch(){return!(0,j.isEmptyObjectOrArray)(this.activeSketches)}resetPrimitiveAttributes(e,t){this.clearSketchGraphics(e,t),this.instantiateSketchGraphics(e,t)}clearSketchGraphics(e,t){const i=this.featureToIds.get(e);if(!i)return;if(t=t||this.sketchComponentElementId,!this.occurrences.hasOwnProperty(t))return;const s=i.getKeys();for(let e=0;e<s.length;e++)this.removeEntityFromOccurrence(s[e],t)}isEntityForDisplay(e,t,i){const s=this.idToPartData[e],n=!s||s.isAssociatedWithFlat,r=this.occurrences[i];return!r&&n===this.viewer.getIsForFlattenedDisplay()||!!r&&(r.containsPart(e)||r.sketchFeatureId===t.getSketchFeatureId())}instantiateSketchGraphics(e,t){const i=this.featureToIds.get(e);if(!i)return;if(t=t||this.sketchComponentElementId,!this.occurrences.hasOwnProperty(t))return;const s=i.getKeys();for(let e=0;e<s.length;e++){const i=s[e],n=this.idToMetaData[i];n&&(this.isEntityForDisplay(i,n,t)&&this.updateEntityOccurrenceGraphics(i,t,n))}}retrieveSketchEntityDeterministicId(e,t){const i=this.sketchToSketchEntityMapping.getNested(e,t);return i||null}isInstantiated(){return this.hasBeenInstantiated}instantiateForPartStudio(e){super.instantiateForPartStudio(e),this.addOrUpdateOccurrence(this.sketchComponentElementId,null)}removePartStudioInstantiation(e){this.usage===fs.L.PREVIEW&&super.removePartStudioInstantiation(e),this.removeOccurrence(this.sketchComponentElementId,!0)}addOrUpdateOccurrence(e,t){this.hasBeenInstantiated||(this.viewer.areOptimizedBuffersEnabled||this.instantiateEntities(),this.hasBeenInstantiated=!0);const i=this.addOrUpdateOccurrenceFromMeshManager(e,t,this.getMeshManager()),s=this.getSharedBaseMeshManager();s&&this.addOrUpdateOccurrenceFromMeshManager(e,t,s),t&&this.parent.imageComponent.updateDisplaysByOccurrence(e,t,this.getSketchFeatureIdsInstantiatedForOccurrence(t));const n=e===this.sketchComponentElementId;(i||n||this.occurrences.hasOwnProperty(e))&&super.addOrUpdateOccurrence(e,t)}getSketchFeatureIdsInstantiatedForOccurrence(e){const t=new Set;if(e.sketchFeatureId)t.add(e.sketchFeatureId);else for(let i=0;i<e.partIds.length;++i){const s=this.idToMetaData[e.partIds[i]];if(s&&s.getFeatureIds()){const e=s.getFeatureIds();for(let i=0;i<e.length;++i)t.add(e[i])}}return t}addOrUpdateOccurrenceFromMeshManager(e,t,i){if(t){let s=null;const n=t.sketchFeatureId;if(this.viewer.areOptimizedBuffersEnabled&&n.length>0&&this.featureToIds.get(n))return this.addSketchFeatureToSceneGraph(n,i,e),!0;if(n){const e=this.featureToIds.get(n);e&&(s=new Set(e.getKeys()))}else for(let e=0;e<t.partIds.length;++e){const i=t.partIds[e];if(this.idToMetaData.hasOwnProperty(i))s||(s=new Set),s.add(i);else{const e=this.parent.retrieveBodyMetaData(i);if(e&&e.isComposite&&e.constituentBodyIds)for(let t=0;t<e.constituentBodyIds.length;++t){const i=e.constituentBodyIds[t],n=this.bodyToEntity.get(i);n&&(s||(s=new Set),n.each(((e,t)=>{s?.add(t)})))}}}if(!s||0===s.size)return!1;const r=this.occurrences[e]?this.occurrences[e].displayedSketchEntityIds:new Set,a=(0,Fs.R)(s,r);return t.displayedSketchEntityIds=s,this.updateEntitiesOccurrences(e,t,a,s,i),!0}if(!this.occurrences.hasOwnProperty(e)){const s=new Set;Object.entries(this.idToMetaData).forEach((([t,i])=>{this.isEntityForDisplay(t,i,e)&&s.add(t)})),this.updateEntitiesOccurrences(e,t,s,s,i)}return!0}addSketchFeatureToSceneGraph(e,t,i){const s=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(i),n=[Di.MX.LINES,Di.MX.TRIANGLE_STRIP],r=[!1,!0];for(const t of n){const n={isPreviewEntity:!1,getSketchFeatureId:()=>e,isFace:()=>t===Di.MX.TRIANGLE_STRIP,isEdge:()=>t===Di.MX.LINES,isVertex:()=>t===Di.MX.POINTS,getSketchSolveStatus:()=>k.ea7.UNKNOWN,isFromSketchSplineHandle:()=>!1,isFromSketchSplineControlPolygon:()=>!1,isSketchConstructionEntity:()=>!1,isSketchUserPoint:()=>!1,isDegenerateEdge:()=>!1};for(const a of r){const r=this.getNodeProperties(n,a,i,t),o=this.getStyle(n,!1,a,null),h=this.getMeshManager().getGroupRangesForGroupTypeAndLod(e,this.getMeshOwnerId(),t,nE.DEFAULT);h&&this.node.addOccurrenceGeometryToNode(r,s,o,h)}}}updateEntitiesOccurrences(e,t,i,s,n){if(i)for(const t of i){const i=this.idToMetaData[t];i?this.updateEntityOccurrenceGraphics(t,e,i,n):ut.log.warn("Could not find meta data for entity")}if(t){const i=t.isHidden?Fs.EE.HIDDEN:Fs.EE.VISIBLE;for(const t of s)this.hideShowEntity(t,i,e)}}getRanges(e,t,i,s,n){yp.reset(),yp.addBoolean(s),yp.addBoolean(n),yp.addBoolean(t.isPreviewEntity),yp.addBoolean(t.isFace()),yp.addBoolean(t.isEdge()),yp.addBoolean(t.isVertex()),yp.addBoolean(t.isDegenerateEdge()),yp.addBoolean(t.isSketchConstructionEntity()),yp.addBoolean(t.isSketchUserPoint()),yp.addBoolean(t.isFromSketchSplineHandle()),yp.addBoolean(t.isFromSketchSplineControlPolygon()),yp.addNumber(t.getSketchSolveStatus(),Ap);let r=yp.getId().toString();if(ws()&&(r=yp.getIdWithIdAppended(this.getEntityPlaneId(t)).toString()),!s){if(null!==this.getEntityColor(e)){r+=this.getEntityOverrideId(e)}}let a=this.styledRanges.getNested(i,r);if(!a){const o=this.getNodeProperties(t,n,i,II(t)),h=this.getStyle(t,s,n,e),c=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(i),l=new SS("SketchComponent."+i+"."+r);this.usage===fs.L.PREVIEW&&l.setListenForDeletions(!0),a=this.node?.addOccurrenceGeometryToNode(o,c,h,l),this.styledRanges.insertNested(i,r,a)}return a.getMeshRanges()}updateEntityOccurrenceGraphics(e,t,i,s){const n=this.isSketchDisplayedAsActive(i.getSketchFeatureId(),t),r=(s=s||this.getMeshManager()).getIncrementDetails(e,this.getMeshOwnerId());if(!r)return;this.getRanges(e,i,t,n,!1).onIncrementAdded(r);this.getRanges(e,i,t,n,!0).onIncrementAdded(r),(this.isEntityHidden(i,t)||!n&&i&&(i.isFromSketchSplineHandle()||i.isFromSketchSplineControlPolygon()))&&this.hideMeshIncrement(e,t)}isEntityHidden(e,t){if(t===this.sketchComponentElementId)return super.isEntityHidden(e,t);{const e=this.occurrences[t];return!!e&&e.isHidden}}removeOccurrence(e,t){this.occurrences.hasOwnProperty(e)&&(this.styledRanges.remove(e),this.node?.removeOccurrence(e),super.removeOccurrence(e,t))}getEntitiesForOccurrenceSelection(e){const t=this.occurrences[e];if(t&&t.displayedSketchEntityIds){const e=[];for(const i of t.displayedSketchEntityIds){const t=this.idToMetaData[i];!t||t.isFromSketchSplineHandle()||t.isFromSketchSplineControlPolygon()||e.push(i)}return e}return null}updateEntityHighlight(e,t,i,s){let n=s;const r=this.idToMetaData[i];if(r&&s===Jf.KF&&(n=this.sketchComponentElementId,!this.isSketchDisplayedAsActive(r.getSketchFeatureId(),n)&&(r.isFromSketchSplineHandle()||r.isFromSketchSplineControlPolygon())))return!1;if(this.viewer.getIsForFlattenedDisplay()){if(!r)return!1;const e=this.getSheetMetalModelId(i);if(!e||e!==this.viewer.getModelViewManagers().getManager().getSelectedSheetmetalModelId())return!1}return super.updateEntityHighlight(e,t,i,n)}hideShowFeature(e,t,i){const s=this.featureVisibility[e]!==t;this.featureVisibility[e]=t;const n=this.sketchToSMModelIdMapping[e],r=this.viewer.getModelViewManagers().getManager();if(n&&r.hasSelectedSheetmetalModelId()&&n!==r.selectedSheetmetalModelId)return;s&&(0,Yg.PT)()?.getInferenceSetController()?.updateInferencingOnFeatureVisibilityChange(e,t);if(!this.hideShowFeatureEntities(e,t)&&this.insertableIdToTypeToIncrement?.get(e)){const i=this.insertableIdToTypeToIncrement.get(e),s=i.get(Gd.FACE),n=i.get(Gd.EDGE),r=this.sketchComponentElementId;t===Fs.EE.HIDDEN?(s&&this.hideMeshIncrement(s.id,r),n&&this.hideMeshIncrement(n.id,r)):(s&&this.showMeshIncrement(s.id,r),n&&this.showMeshIncrement(n.id,r))}}hideShowFeatureEntity(e,t,i){const s=this.idToMetaData[e];let n=i;!t&&s&&(s.isFromSketchSplineHandle()||s.isFromSketchSplineControlPolygon())&&(n=Fs.EE.HIDDEN);const r=this.getOccurrenceIdForEntity(e),a=this.hideShowEntity(e,n,r);return a&&this.viewer.requestDraw(),a}removeBaseIncrement(e){this.removeBaseIncrementFromOccurrence(e,this.getOccurrenceIdForEntity(e))}hideShowFeatureEntities(e,t){const i=this.getEntitiesForFeature(e);if(!i)return!1;let s=!1;const n=this.activeSketches.hasOwnProperty(e);for(let e=0;e<i.length;++e)s=this.hideShowFeatureEntity(i[e],n,t)||s;return s}showPartsWithSheetmetalModelIdOnly(e){for(const t of this.featureToIds.getKeys()){const i=this.activeSketches.hasOwnProperty(t),s=this.featureToIds.get(t);for(const n of s.getKeys()){const s=this.getSheetMetalModelId(n);s&&s===e?this.hideShowFeatureEntity(n,i,this.featureVisibility[t]):this.hideShowFeatureEntity(n,i,Fs.EE.HIDDEN)}}}getFeatureIdForOccurrence(e){const t=this.occurrences[e];if(!t||!t.displayedSketchEntityIds)return null;if(t.sketchFeatureId)return t.sketchFeatureId;for(const e of t.displayedSketchEntityIds){const t=this.idToMetaData[e];if(t)return t.getSketchFeatureId()}return null}doesSketchContainBody(e,t){const i=this.featureToIds.get(e);if(!i)return!1;let s=!1;return i.each(((e,i)=>{const n=this.idToMetaData[i];return s=n?.getBodyId()===t,s})),s}getEntityTypesContainedWithinSketch(e){const t=new Set,i=this.featureToIds.get(e);return i?(i.each(((e,i)=>(t.add(this.idToMetaData[i].getEntityType()),t.has(k.ZSW.VERTEX)&&t.has(k.ZSW.EDGE)&&t.has(k.ZSW.FACE))),this),t.size>0&&t.add(k.ZSW.BODY),t):t}getComponentId(){return Op}}const Rp=new Si.si;class wp extends vp{constructor(e){super(null,fs.L.BASE,(0,j.as)(eT,e)),this.idManager=new Si.si,this.temporarySketchId=Rp.getId(),this.node=new xi.NB(oI+this.temporarySketchId),this.meshManager=new AS((0,j.as)(eT,e),{bufferAllocationPolicy:$f.MEDIUM}),this.entityIdManager=new eI.E,this.viewer.getSceneGraphs().getMainSceneGraph().getRootNode().addChild(this.node),this.viewer.getModelViewManagers().getManager().addTemporarySketchComponent(this),this.instantiateForPartStudio(this.node)}remove(){this.viewer.getModelViewManagers().getManager().removeTemporarySketchComponent(this),this.node.remove(),Rp.freeId(this.temporarySketchId),this.temporarySketchId=Si.JE,this.reset()}getUniqueId(){return this.temporarySketchId}addTemporaryEntity(e,t){const i=this.idManager.getId().toString(),s=new k.QsM;s.isAssociatedWithFlat=this.viewer.getIsForFlattenedDisplay(),this.idToPartData[i]=s,e.id=i,this.idToMetaData[i]=t,this.featureToIds.insertNested(this.temporarySketchId.toString(),i,!0),this.updateEntityGraphics(i,e,t)}updateTemporaryEntity(e,t,i){this.removeEntity(e);const s=new k.QsM;s.isAssociatedWithFlat=this.viewer.getIsForFlattenedDisplay(),this.idToPartData[e]=s,t.id=e,this.idToMetaData[e]=i,this.featureToIds.insertNested(this.temporarySketchId.toString(),e,!0),this.updateEntityGraphics(e,t,i)}reset(){super.reset(),this.idManager.reset(),this.entityIdManager.reset()}isEntityInActiveSketch(e){return!0}isSketchDisplayedAsActive(e,t){return!0}getNodeProperties(e,t,i){const s=super.getNodeProperties(e,t,i,II(e));return s.isPickable=!1,s.includedInBlend=!1,s.updateId(),s}getEntityIdManager(){return this.entityIdManager}getMeshManager(){return this.meshManager}getSharedBaseMeshManager(){return null}getMeshOwnerId(){return"t"}updateEntityHighlight(e,t,i,s){return s===Jf.KF&&(s=this.sketchComponentElementId),Hd.prototype.updateEntityHighlight.call(this,e,t,i,s)}}var _p=i(66366);const Np=X.default.getManager(),bp=Np.getNumber("CONTROL_POINT_GRID_LINE_WIDTH"),Lp="controlPointGrid",Fp=new xi.hF({primitiveType:Di.MX.LINES,isPickable:!1,isHighlightable:!1,isTwoSided:!1,isShowThrough:!1,isDepthTested:!0}),xp=new xi.hF({primitiveType:Di.MX.LINES,isPickable:!1,isHighlightable:!1,isShowThrough:!0,isTwoSided:!0,isDepthTested:!1,isStencilTested:!0}),Bp=Np.getStipple("CURVATURE_UV_TOOTH_STIPPLE");class Vp extends Ti.u1{constructor(e,t,i,s){super(s),this.edgeId=e,this.controlPointData=t,this.checkboxStates=i,this.id=Lp+"."+e,this.update()}onAppearanceConstantsUpdated(){this.update()}update(){if(this.isHidden)return;const e=[];if(this.checkboxStates[_p.N.CPT_GRIDS]){const t=this.controlPointData.controlPoints;if(t.length){const i=t.length,s=t[0].length/3;for(let n=0;n<i;n++){const i=t[n];for(let t=1;t<s;t++)for(let s=t-1;s<=t;s++){const t=C.fromValues(i[3*s],i[3*s+1],i[3*s+2]);e.push(t)}}for(let n=0;n<s;n++)for(let s=1;s<i;s++)for(let i=s-1;i<=s;i++){const s=C.fromValues(t[i][3*n],t[i][3*n+1],t[i][3*n+2]);e.push(s)}}}const t=Np.getColor("CONTROL_POINT_GRID_COLOR"),i=(0,Au.pf)(e,void 0,t,bp);this.updateMeshIncrement(Lp+".grid",Ti.ZJ,i,Fp);const s=(0,Au.pf)(e,void 0,t,bp,Bp);this.updateMeshIncrement(Lp+".stippled",Ti.ZJ,s,xp)}onCheckboxStatesUpdate(e){this.checkboxStates=e,this.update()}pointToVec3(e){return C.fromValues(e.x,e.y,e.z)}}var Up=i(63964),Gp=i(66146),Hp=i(74203);const kp=X.default.getManager(),Wp="edgeCurvature",zp=new xi.hF({primitiveType:Di.MX.LINES,isPickable:!1,isHighlightable:!1,isTwoSided:!1,isShowThrough:!1,isDepthTested:!0}),Xp=new xi.hF({primitiveType:Di.MX.LINES,isPickable:!1,isHighlightable:!1,isShowThrough:!0,isTwoSided:!0,isDepthTested:!1,isStencilTested:!0}),Zp=new xi.hF({primitiveType:Di.MX.POINTS,isPickable:!1,isHighlightable:!1,isTwoSided:!0,isShowThrough:!0,priority:xi.DO.HIGHEST}),qp=new xi.hF({primitiveType:Di.MX.TRIANGLES,isPickable:!1,isHighlightable:!1,isTwoSided:!0,isShowThrough:!0,priority:xi.DO.HIGHEST}),Yp=kp.getStipple("CURVATURE_UV_TOOTH_STIPPLE"),Kp=kp.getNumber("CURVATURE_TOOTH_LINE_WIDTH"),jp=kp.getNumber("CURVATURE_UV_TOOTH_LINE_WIDTH"),Qp=kp.getNumber("CURVATURE_UV_ROOF_LINE_WIDTH"),$p=kp.getNumber("CURVATURE_ROOF_LINE_WIDTH"),Jp=kp.getStipple("CURVATURE_UV_ROOF_STIPPLE"),em=Math.pow(Ci.W.MAX_MODEL_SIZE,2),tm=kp.getNumber("INFLECTION_POINT_SIZE"),im=kp.getNumber("INFLECTION_TRIANGLE_HEIGHT_PX"),sm=kp.getNumber("INFLECTION_TRIANGLE_WIDTH_PX");class nm extends Ti.u1{constructor(e,t,i,s,n,r,a){super(r),this.edgeId=e,this.curvatureData=t,this.curvatureSize=i,this.checkboxStates=s,this.entityCurvatureWrapper=a,this.curvaturePower=n,this.id=Wp+"."+e,this.listenTo(r.getEventDispatcher(),yD.Hq,this.onActiveSheetMetalModelChanged),this.update()}onAppearanceConstantsUpdated(){this.update()}update(){if(this.isHidden)return;const e=kp.getColor("CURVATURE_TOOTH_COLOR"),t=kp.getColor("CURVATURE_U_TOOTH_COLOR"),i=kp.getColor("CURVATURE_V_TOOTH_COLOR"),s=kp.getColor("CURVATURE_U_ROOF_COLOR"),n=kp.getColor("CURVATURE_V_ROOF_COLOR"),r=kp.getColor("CURVATURE_ROOF_COLOR"),a=[],o=[];let h;if(this.curvatureData&&this.checkboxStates[_p.N.CURVATURE_COMBS]){const e=this.curvatureData.curvatures.length;for(let t=0;t<e;t++){const i=this.curvatureData.curvatures[t],s=this.curvatureData.positions[t],n=C.fromValues(s.x,s.y,s.z),r=this.curvatureData.normals[t],c=C.fromValues(r.x,r.y,r.z),l=this.curvatureSize*Math.pow(i,this.curvaturePower),u=ge.S4.add(n,ge.S4.scale(c,l,C.create()),C.create()),d=t%Gp.y.OVERSAMPLING_SCALE!=0,g=t===e-1&&t>0&&a.length>1&&C.equals(a[0],n)&&C.equals(a[1],u);Math.max(C.squaredLength(n),C.squaredLength(u))<em?(d||g||a.push(n,u),h&&o.push(h,u),h=u):h=void 0}}let c=e,l=Kp,u=r,d=$p;this.entityCurvatureWrapper.isFaceCurvature()&&(c=this.entityCurvatureWrapper.isFaceUCurve()?t:i,l=jp,u=this.entityCurvatureWrapper.isFaceUCurve()?s:n,d=Qp);const g=(0,Au.pf)(a,void 0,c,l);this.updateMeshIncrement(Wp+".teeth",Ti.ZJ,g,zp);const p=(0,Au.pf)(a,void 0,c,l,Yp);this.updateMeshIncrement(Wp+".stippledTeeth",Ti.ZJ,p,Xp);const m=(0,Au.pf)(o,void 0,u,d);this.updateMeshIncrement(Wp+".roof",Ti.ZJ,m,zp);const f=(0,Au.pf)(o,void 0,u,d,Jp);this.updateMeshIncrement(Wp+".stippledroof",Ti.ZJ,f,Xp),this.updateInflectionPointIndicators(),this.updateMinimumRadiusOfCurvatureIndicator()}updateInflectionPointIndicators(){if(!this.curvatureData||!this.curvatureData.inflectionPointPositions)return;const e=[],t=this.curvatureData.inflectionPointPositions.length,i=new Float32Array(15*t),s=new Float32Array(15*t),n=new Int32Array(6*t);if(this.checkboxStates[_p.N.INFLECTION_POINTS]){if(this.curvatureData.inflectionPointPositions.length!==this.curvatureData.tangentsAtInflectionPoints.length)return;for(let r=0;r<t;r++){const t=this.curvatureData.inflectionPointPositions[r],a=C.fromValues(t.x,t.y,t.z);e.push(a);const o=this.curvatureData.tangentsAtInflectionPoints[r],h=C.fromValues(o.x,o.y,o.z),c=this.viewer?.getCamera()?.getPixelSizeAtWorldPoint(a),l=this.viewer?.getCamera()?.projectWorldPointToCanvas(a),u=this.viewer?.getCamera()?.getRay(l[0],l[1]),d=u.direction,g=ge.S4.cross(d,h,C.create());ge.S4.length(g)>Ci.W.ZERO_LENGTH&&ge.S4.normalize(g);const p=ge.S4.cross(d,g,C.create()),m=ge.S4.scale(g,c*im,C.create()),f=ge.S4.scale(g,c*-im,C.create()),I=ge.S4.scale(p,c*-sm/2,C.create()),E=ge.S4.scale(p,c*sm/2,C.create()),S=[ge.S4.add(a,ge.S4.add(m,E,C.create()),C.create()),ge.S4.add(a,ge.S4.add(m,I,C.create()),C.create()),a,ge.S4.add(a,ge.S4.add(f,E,C.create()),C.create()),ge.S4.add(a,ge.S4.add(f,I,C.create()),C.create())],T=[0,1,2,3,4,2];for(let e=0;e<6;e++)5!==e&&(i.set(S[e],15*r+3*e),s.set(d,15*r+3*e)),n[6*r+e]=5*r+T[e]}}const r=new vE(Di.MX.TRIANGLES,i,n);r.normals=s;const a=kp.getColor("INFLECTION_POINT_COLOR");(0,Au.Ab)(a,r),(0,Au.VQ)(tm,r),this.updateMeshIncrement(Wp+".inflectionTriangles",Ti.ZJ,r,qp);const o=new Float32Array(3*e.length),h=new Int32Array(e.length);for(let t=0;t<e.length;++t){h[t]=t;for(let i=0;i<3;++i)o[3*t+i]=e[t][i]}const c=new vE(Di.MX.POINTS,o,h,void 0);(0,Au.Ab)(a,c),(0,Au.VQ)(tm,c),this.updateMeshIncrement(Wp+".inflectionPoint",Ti.ZJ,c,Zp)}updateMinimumRadiusOfCurvatureIndicator(){if(this.checkboxStates[_p.N.MINIMUM_RADIUS]&&this.curvatureData&&this.curvatureData.coordinateSystemOfCurvatureCircle){const e=this.curvatureData.coordinateSystemOfCurvatureCircle.getGlMatrix(),t=C.fromValues(e[12],e[13],e[14]),i=C.fromValues(e[8],e[9],e[10]),s=this.curvatureData.minimumRadiusOfCurvature,n=(0,Au.y)(t,this.curvatureData.minimumRadiusOfCurvature,i,100),r=kp.getColor("RADIUS_OF_CURVATURE_CIRCLE_COLOR");(0,Au.Ab)(r,n),(0,Au.VQ)($p,n),this.updateMeshIncrement(Wp+".radius",Ti.ZJ,n,zp);const a=new Hp.l;a.id="fakeDimensionId",a.featureId="fakeSketchId",a.parameterId="length",a.value=this.curvatureData.minimumRadiusOfCurvature,a.coordinateSystem.m00=1,a.coordinateSystem.m01=0,a.coordinateSystem.m10=0,a.coordinateSystem.m11=1,a.coordinateSystem.m02=0,a.coordinateSystem.m12=0,a.coordinateSystem.m22=1;const o=-Math.PI,h=this.curvatureData.minimumRadiusOfCurvature/2,c=-Math.PI,l=c;a.positionR=h,a.positionT=o,a.witnessEndPoint0r=s,a.witnessEndPoint0t=c,a.witnessEndPoint1r=s,a.witnessEndPoint1t=l,a.planeMatrix=this.curvatureData.coordinateSystemOfCurvatureCircle,a.radiusDisplay=Up.M.RADIAL,a.isDriven=!0,this.diameterGraphics||(this.diameterGraphics=new BI.nl(this.viewer,!0)),this.diameterGraphics.updateFromDisplayData(a)}else this.removeMeshIncrement(Wp+".radius"),this.diameterGraphics&&(this.diameterGraphics.remove(),this.diameterGraphics=null)}updateSizeAndPower(e,t){this.curvatureSize===e&&this.curvaturePower===t||(this.curvatureSize=e,this.curvaturePower=t,this.update())}show(){super.show(),this.diameterGraphics&&this.diameterGraphics.show(),this.update()}hide(){super.hide(),this.diameterGraphics&&this.diameterGraphics.hide()}remove(){super.remove(),this.diameterGraphics&&this.diameterGraphics.remove()}getFitBounds(){return this.getInstantiatedMeshIncrement(Wp+".teeth").meshIncrement.getBounds()}onViewWillDraw(e,t){this.updateInflectionPointIndicators()}onActiveSheetMetalModelChanged(e){this.curvatureData.ownerBodySheetMetalModelId&&(this.curvatureData.ownerBodySheetMetalModelId!==e?this.hide():this.show())}onCheckboxStatesUpdate(e){this.checkboxStates=e,this.update()}}const rm=X.default.getManager(),am="dihedralComb",om=am+".low",hm=am+".mid",cm=am+".high",lm=am+".zeropoint",um=rm.getNumber("DIHEDRAL_TOOTH_LINE_WIDTH"),dm=rm.getNumber("DIHEDRAL_ZERO_POINT_SIZE"),gm=rm.getStipple("DIHEDRAL_TOOTH_STIPPLE"),pm=new xi.hF({primitiveType:Di.MX.POINTS,isPickable:!1,isHighlightable:!1,isTwoSided:!0,isShowThrough:!0,priority:xi.DO.HIGHEST}),mm=new xi.hF({primitiveType:Di.MX.LINES,isPickable:!1,isHighlightable:!1,isTwoSided:!1,isShowThrough:!1,isDepthTested:!0}),fm=new xi.hF({primitiveType:Di.MX.LINES,isPickable:!1,isHighlightable:!1,isShowThrough:!0,isTwoSided:!0,isDepthTested:!1,isStencilTested:!0});class Im extends Ti.u1{constructor(e,t,i,s,n,r,a,o){super(o),this.edgeId=e,this.dihedralData=t,this.scale=i,this.coefficient=s,this.lowRadians=n,this.highRadians=r,this.useThresholdDisplay=a,this.id=am+"."+e,this.update()}onAppearanceConstantsUpdated(){this.update()}update(){if(this.isHidden)return;const e=rm.getColor("DIHEDRAL_HIGH_THRESHOLD_COLOR"),t=rm.getColor("DIHEDRAL_MID_THRESHOLD_COLOR"),i=rm.getColor("DIHEDRAL_LOW_THRESHOLD_COLOR"),s=this.createAndSortLineData();this.updateLines(s.lowLines,i,this.id+om),this.updateLines(s.midLines,t,this.id+hm),this.updateLines(s.highLines,e,this.id+cm),this.updatePoints(s.points)}updatePoints(e){const t=rm.getColor("DIHEDRAL_HIGH_THRESHOLD_COLOR"),i=rm.getColor("DIHEDRAL_MID_THRESHOLD_COLOR"),s=rm.getColor("DIHEDRAL_LOW_THRESHOLD_COLOR"),n=new Float32Array(3*e.length),r=new Int32Array(e.length);for(let t=0;t<e.length;++t){r[t]=t;const i=e[t];for(let e=0;e<3;e++)n[3*t+e]=i[e]}let a=i;this.useThresholdDisplay&&(0<=this.lowRadians?a=s:0>=this.highRadians&&(a=t));const o=new vE(Di.MX.POINTS,n,r,void 0);(0,Au.Ab)(a,o),(0,Au.VQ)(dm,o),this.updateMeshIncrement(this.id+lm,Ti.ZJ,o,pm)}updateLines(e,t,i){const s=(0,Au.pf)(e,void 0,t,um);this.updateMeshIncrement(i,Ti.ZJ,s,mm);const n=(0,Au.pf)(e,void 0,t,um,gm);this.updateMeshIncrement(i+".stipple",Ti.ZJ,n,fm)}getFitBounds(){const e=this.getInstantiatedMeshIncrement(this.id+om).meshIncrement.getBounds(),t=this.getInstantiatedMeshIncrement(this.id+hm).meshIncrement.getBounds(),i=this.getInstantiatedMeshIncrement(this.id+cm).meshIncrement.getBounds();return e.addBox(t),e.addBox(i),e}setScale(e){this.scale=e}setCoefficient(e){this.coefficient=e}setThresholdValues(e,t){this.lowRadians=e,this.highRadians=t}setUseThresholdDisplay(e){this.useThresholdDisplay=e}static getComb(e,t,i){const s=e.position.getVec3(),n=e.direction.getVec3(),r=(0,ic.round)(e.magnitudeRadians,5),a=t*i*r;return[s,C.scaleAndAdd(C.create(),s,n,a),r]}createAndSortLineData(){const e=[],t=[],i=[],s=[],n=this.dihedralData.dihedrals;for(let r=0;r<n.length;r++){const[a,o,h]=Im.getComb(n[r],this.scale,this.coefficient);Math.abs(h)<Im.NEAR_ZERO_RADIAN_THRESHOLD?s.push(a):this.sortCombToArrays(h,a,o,t,e,i)}return{lowLines:t,midLines:e,highLines:i,points:s}}sortCombToArrays(e,t,i,s,n,r){this.useThresholdDisplay?Math.abs(e)<Math.abs(this.lowRadians)?s.push(t,i):Math.abs(e)>Math.abs(this.highRadians)?r.push(t,i):n.push(t,i):n.push(t,i)}}Im.NEAR_ZERO_RADIAN_THRESHOLD=Math.PI/180*.05;const Em=X.default.getManager();class Sm extends Ti.u1{constructor(e,t,i,s,n,r){super(r),this.id="dihedralExtrema."+e,this.dihedral=t,this.scale=i,this.coefficient=s,this.text=n,this.needsUpdating=!0,this.update()}onAppearanceConstantsUpdated(){this.needsUpdating=!0,this.update()}update(){if(this.isHidden||!this.needsUpdating)return;this.textHeightPx=Em.getNumber("DIMENSION_VALUE_HEIGHT_PIXELS"),this.font=Em.getString("DIMENSION_VALUE_FONT"),this.color=Em.getColor("DIMENSION_DRIVING_VALUE_TEXT_COLOR"),this.textDisplay?.remove();const[e,t,i]=Im.getComb(this.dihedral,this.scale,this.coefficient),s=Math.abs(i)<Im.NEAR_ZERO_RADIAN_THRESHOLD?e:t;this.textDisplay=new Ta({origin:s,heightPx:this.textHeightPx,color:this.color,font:this.font,orientToScreen:!0,offsetRight:yi.iK.MID,offsetUp:yi.iK.LOW},this.viewer),this.textDisplay.setText(this.text),this.needsUpdating=!1}remove(){super.remove(),this.textDisplay.remove()}setScaleAndCoefficient(e,t){this.scale=e,this.coefficient=t,this.needsUpdating=!0}setString(e){this.text=e,this.needsUpdating=!0}}const Tm=k.ZIP.VIRIDIS,Dm="simulation-legend-canvas-controls";class Mm extends Yh{constructor(){super(...arguments),this.LEGEND_MAXIMUM_CLICKED=yD.Jm,this.LEGEND_MINIMUM_CLICKED=yD.xy,this.LEGEND_RANGE_CHANGED=yD.pj,this.CANVAS_CONTROLS_PANEL_ID=Dm}updateGraphics(){void 0!==this.visualizedFieldType&&super.updateGraphics()}get SNAPPING_MARGIN_TOP(){return X.default.getManager().getNumber("SIMULATION_TOP_TOOLBAR_HEIGHT_PX")}}var Cm=i(44505);const ym=[0,.125,.25,.375,.5,.625,.75,.875,.92,1,1,1,1,1,.9,.5,.2,0,-.1,-.11,-.05,0,.02,.02,.01,0,-.01,0,0,0,0,0];class Pm extends jh{constructor(e){super(e),this.modelViewManager=e,this.COLOR_MAP_STORAGE_KEY=Cm.S,this.LEGEND_CLOSED=is.Ipz,this.LEGEND_OPENED=is.PXv,this.VISUALIZATION_MANAGER_NODE_ID="SimulationManager",this.graphicsRenderMode=k.P1.SIMULATION_RESULTS,this.meshOwnerId=PS(),this.tessellationCache=new Map,this.occurrenceToMaterial=new Map,this.isAnimating=!1,this.elementIdToResponseData=new Map,this.scalarVisualizationOccurrences=[],this.simulationMass=0,Ki.Jq.SimulationService&&Ki.Jq.SimulationService.getIsAnimatingObservable().subscribe((e=>{e?this.startAnimation():this.stopAnimation()})),this.connectionVisualizationManager=new Eh(Ki.Jq.AnalyticsService,e,this)}getContactBehavior(){return this.connectionVisualizationManager.getContactBehavior()}prepareResources(){super.prepareResources(),this.legend||(this.legend=new Mm(this))}clearScalarVisualizationStatusForOccurrences(e){const t=this.getViewer().getOccurrenceIdManager();for(const i of e){const e=k._oC.getOccurrenceFromPathString(i),s=t.getIdForName(i);if(s===Jf.Qy){ut.log.warn("No occurrence id for "+i);continue}const n=this.modelViewManager.getPartStudioDataFromOccurrence(e);n?n.getBodyComponent().clearScalarVisualizationOccurrence(s):ut.log.debug("No part studio for occurrence "+i)}}get displayedSimulatedField(){return this.visualizationState?this.visualizationState.field:null}hasDisplayableFieldSet(){return!!this.displayedSimulatedField&&this.displayedSimulatedField.type!==k.DDL.UNKNOWN}readyToShowLegend(){return this.viewerIsInScalarVisualizationRenderMode()&&this.hasDisplayableFieldSet()&&this.visualizationState&&!this.visualizationState.connectionVisualizationActive}setVisualizationState(e){const t=new Qo.B7("SimulationManager.setVisualizationState",{setTraceId:!0}),i=!this.visualizationState||!(0,Hs.Z)(this.visualizationState.connectionTypeToHidden,e.connectionTypeToHidden),s=!this.visualizationState||this.visualizationState.restInDeformedState!==e.restInDeformedState,n=!this.visualizationState||this.visualizationState.deformationScale!==e.deformationScale;super.setVisualizationState(e),this.connectionVisualizationManager.setVisible(this.visualizationState.connectionVisualizationActive),i&&this.connectionVisualizationManager.updateGraphics(),this.hasDisplayableFieldSet()&&!this.visualizationState.connectionVisualizationActive||this.hideLegend(),!s&&!n||this.isAnimating||this.resetSimulationOffsetFactor(),t.report()}setContactBehavior(e){this.connectionVisualizationManager.setContactBehavior(e)}getSimulationBounds(){if(!this.rootNode)return null;let e=this.rootNode.getBoundingBox();if(this.isAnimating||this.visualizationState?.restInDeformedState){e=e.clone();const t=this.inputDisplacementRange.max>Ci.W.ZERO_LENGTH?.001*this.inputDisplacementRange.max:0,i=1e3;e.dilate(Math.min(t,i))}return e}hasSimulationResultsForElement(e){return this.elementIdToResponseData.has(e)}updateSimulation(e){const t=new Qo.B7("SimulationManager.updateSimulation",{setTraceId:!0});this.prepareResources();for(const t of e.simulationTessellations)this.tessellationCache.set(this.getTessellationCacheKey(t.sourceElement,t.deterministicId),t);for(const t in e.occurrenceToMaterial)this.occurrenceToMaterial.set(t,e.occurrenceToMaterial[t]);let i=!1,s=null;if(e.activeSimulationUpdates.length>0){if(s=e.activeSimulationUpdates[0].runStatus,s===k.zgQ.JUST_STARTED||s===k.zgQ.INVALID_ASSEMBLY)return this.clearGraphics(),s===k.zgQ.JUST_STARTED&&this.elementIdToResponseData.delete(e.sourceElementId),void(this.legend&&(this.legend.clearRanges(),this.showLegend()))}const n=e.responses[0];if(n)this.elementIdToResponseData.set(e.sourceElementId,n),i=!0;else{const e=this.modelViewManager.getDisplayedAssembly();e&&s===k.zgQ.TRANSMITTED&&this.elementIdToResponseData.has(e.elementId)&&(i=!0)}i&&(this.prepareField(this.displayedSimulatedField),this.updateGraphics()),t.report()}updateContactAnalysis(e){this.connectionVisualizationManager.updateContactAnalysis(e)}getVisualizationState(){return this.visualizationState}isIsolateEffectActive(){return this.connectionVisualizationManager.getVisible()&&this.connectionVisualizationManager.getUseIsolateEffect()}onRenderingModeChanged(){super.onRenderingModeChanged();this.viewerIsInScalarVisualizationRenderMode()&&this.getViewer().setUserEnabledAggressiveRefinement(!1)}resetMeshes(){this.meshManager&&this.meshManager.destroy(),this.meshManager=new AS(this.getViewer(),{bufferAllocationPolicy:$f.MAXIMUM})}onAssemblyDisplayed(){this.updateGraphics(),this.connectionVisualizationManager.updateGraphics()}onAssemblyChanged(){this.connectionVisualizationManager.onAssemblyChanged()}onSectionSetChanged(){this.connectionVisualizationManager.onSectionSetChanged()}onDocumentChange(){this.tessellationCache.clear(),this.elementIdToResponseData.clear()}updateGraphics(){this.clearGraphics();const e=this.modelViewManager.getDisplayedAssembly();if(!e||e.isHidden||this.visualizationState&&this.visualizationState.connectionVisualizationActive)return;this.showLegend();const t=this.elementIdToResponseData.get(e.elementId);if(!t)return void(this.legend&&this.legend.clearRanges());const i=this.getViewer().getOccurrenceIdManager(),s=this.getViewer().getOccurrenceDataManager(),n=t.firstResultDataSet;if(!n)return void ut.log.debug("No data set to display");if(!this.visualizationState||n.isModal!==this.visualizationState.field.isModal||!this.hasDisplayableFieldSet())return;if(!this.viewerIsInScalarVisualizationRenderMode())return;if(!n.canBeUsedToDisplay(this.displayedSimulatedField))return;this.displayedScalarRangeSpecification=n.getRangeSpecification(this.displayedSimulatedField),this.inputDisplacementRange=n.getRangeSpecification(this.displayedSimulatedField?.displacementFieldSpecification).rangeInData;const r=[];for(let e=0;e<Pm.imageMaps.length;++e){const t=new xi.hF({material:this.scalarVisualizationMaterials[e],zOffset:X.default.getManager().getNumber("PART_FACES_Z_OFFSET"),primitiveType:Di.MX.TRIANGLES,includedInBlend:!0,clippedBySectionPlanes:!0,isPickable:!1});r.push(t)}let a=!1;this.simulationMass=0;for(const t in n.occurrenceIdToOccurrenceResult){const o=n.occurrenceIdToOccurrenceResult[t],h=k._oC.getOccurrenceFromPathString(t),c=i.getIdForName(t);if(c===Jf.Qy){ut.log.warn("No occurrence id for "+t);continue}const l=s.getOccurrenceData(c);l||ut.log.warn("No occurrence data for "+t);const u=e.getOccurrenceDisplayData(h);if(!u){ut.log.warn("No occurrence display data for "+t);continue}const d=this.modelViewManager.getPartStudioDataFromOccurrence(h);if(!d){ut.log.debug("No part studio for occurrence "+t);continue}const g=o.getFieldForDisplay(this.displayedSimulatedField);if(!g)continue;if(g.isDisabled){d.getBodyComponent().clearScalarVisualizationOccurrence(c);continue}const p=this.getMeshIncrementForOccurrence(o,u);if(!p){ut.log.debug("No simulation tessellation for "+t),a=!0;break}this.updateMass(o),d.getBodyComponent().setScalarVisualizationOccurrence(c),p.id=t;const m=this.meshManager.addMeshIncrement(p,this.meshOwnerId),f=new SS("Simulated "+t);f.onIncrementAdded(m);const I=d.retrieveBodyMetaData(u.partIds[0]),E=new XI.bg;I&&E.setAttribute(sE.COLOR,I.getColor());for(let e=0;e<r.length;++e)this.nodes[e].addOccurrenceGeometryToNode(r[e],l,E,f);if(this.debugMeshEdges){const e=(0,Au.EK)(p,p.id+".edges"),i=this.meshManager.addMeshIncrement(e,this.meshOwnerId),s=new SS("Simulated "+t+" edges");s.onIncrementAdded(i);for(let e=0;e<r.length;++e)this.nodes[e].addOccurrenceGeometryToNode(op,l,E,s)}this.scalarVisualizationOccurrences.push(t)}if(a)return this.clearGraphics(),void(n.isModal&&this.getViewer().getEventDispatcher().trigger(is.R1N,!1,n));this.cursorAppendage=new ts(this.getViewer(),((e,t)=>this.getCursorText(e,t))),this.legend.setInputRange(this.displayedScalarRangeSpecification),this.visualizedScalarRange&&this.legend.setVisualizedScalarRange(this.visualizedScalarRange),this.updateColorMapping(null,this.displayedColorMap),this.updateMakeUnsignedUniform(),this.getViewer().getEventDispatcher().trigger(is.R1N,!0,n),this.getViewer().requestDraw()}updateMass(e){const t=this.getTessellationForOccurrenceResult(e)?.massProperties;t&&t.hasMass&&(this.simulationMass+=t.mass[0])}clearGraphics(){this.getViewer().getEventDispatcher().trigger(is.R1N,!1),this.resetMeshes(),this.clearScalarVisualizationStatusForOccurrences(this.scalarVisualizationOccurrences),this.scalarVisualizationOccurrences=[],super.clearGraphics()}clearSimulationAndConnectionGraphics(){this.clearGraphics(),this.connectionVisualizationManager.clearGraphics()}prepareField(e){const t=this.getDisplayedResults();t&&e&&e.type===k.DDL.SAFETY_FACTOR&&t.prepareSafetyFactor(((e,t)=>{let i=this.occurrenceToMaterial.get(e);if(!i){const e=this.getTessellationForOccurrenceResult(t);e&&(i=e.material)}return i}))}startAnimation(){if(this.isAnimating)return;this.isAnimating=!0;const e=X.default.getManager().getNumber("SIMULATION_DISPLACEMENT_ANIMATION_CYCLE_PERIOD_SEC");let t=-1,i=0;this.getViewer().getAnimationController().startAnimation((s=>{if(!this.isAnimating)return is.ZK6.COMPLETE;if(t>0){i+=(s-t)/1e3/e;const n=this.displayedSimulatedField?.isModal?this.getModalOffsetFactor(i):this.getDisplacementOffsetFactor(i);this.setSimulationOffsetFactor(n)}return t=s,is.ZK6.ONGOING}))}updateVisualizedScalarRange(){this.legend&&(this.legend.visualizedFieldType=this.visualizationState.field.type),super.updateVisualizedScalarRange()}stopAnimation(){this.isAnimating&&(this.isAnimating=!1,this.resetSimulationOffsetFactor(),this.getViewer().requestDraw())}resetSimulationOffsetFactor(){this.visualizationState?.restInDeformedState?this.setSimulationOffsetFactor(1):this.setSimulationOffsetFactor(0),this.getViewer().requestDraw()}setSimulationOffsetFactor(e){for(const t of this.scalarVisualizationMaterials)t.setCustomFloatUniform("uOffsetFactor",e*this.visualizationState.deformationScale*.001)}getRangeInBaseUnits(e){return e?this.displayedSimulatedField?.hasUnits?this.displayedSimulatedField.isStress?(0,rr.vM)(e,k.L_A.BASE_UNITS):(0,rr.vM)(e,k.jvX.BASE_UNITS):e:null}updateMakeUnsignedUniform(){let e=jm;if(this.visualizationState.field.type===k.DDL.UNSIGNED_VON_MISES_STRESS){const t=this.getDisplayedResults();if(!t)return;const i=t.getAvailableFields();i.has(k.DDL.SIGNED_VON_MISES_STRESS)&&!i.has(k.DDL.UNSIGNED_VON_MISES_STRESS)&&(e=Km)}for(const t of this.scalarVisualizationMaterials)t.setCustomIntUniform("uMakeUnsigned",e)}getDisplayedResults(){const e=this.modelViewManager.getDisplayedAssembly();if(!e)return null;const t=this.elementIdToResponseData.get(e.elementId);return t?t.firstResultDataSet:null}setDebugMeshEdges(e){this.debugMeshEdges=e}getTessellationForOccurrenceResult(e){return this.tessellationCache.get(this.getTessellationCacheKey(e.sourcePartReference,e.sourcePartReference.partId))}getMeshIncrementForOccurrence(e,t){const i=this.getTessellationForOccurrenceResult(e);if(!i)return null;let s=e.getFieldForDisplay(this.displayedSimulatedField);if(!s)return null;let n=e.getFieldForDisplay(this.displayedSimulatedField?.displacementFieldSpecification);if(!n)return null;if(s instanceof k.aj8){const e=1e3*this.visualizationState.field.directDeformationInMeters,t=s.getScaledCopy(e);s=t,n=t}const r=this.getSampleMesh(i,e),a=new vE(Di.MX.TRIANGLES,r.points,r.getAnyIndices());s.isDisabled||a.packScalarsIntoTextureCoordinates(s.values);const o=this.modelViewManager.getPartStudio(e.sourcePartReference);if(o){const e=o.getBodyBounds(i.deterministicId,t.occurrenceData.occurrence);e&&(a.boundingBox=e)}return n instanceof k.jvX?a.offsetVectors=(0,yi.w5)(n.packedOffsetDirections,n.values):ut.log.warn("Unexpected displacement field type"),a}findScalarVisualizationScalar(e,t){const i=super.findScalarVisualizationScalar(e,t);if(null===i)return null;if(this.displayedSimulatedField?.hasUnits){const e=(0,nr.vx)().getUnitForSimulatedField(this.displayedSimulatedField?.type);return(0,rr.WR)(i,this.getRangeInData()?.units,e)}return i}getTessellationCacheKey(e,t){return e.toString()+"."+t}getModalOffsetFactor(e){const t=e*Math.PI*2;return Math.sin(t)}getDisplacementOffsetFactor(e){return(0,yi.HO)(ym,e)}getValueString(e){return Kh.c.getSimulationValueString(e)}getMass(){return this.simulationMass}}var Am=i(70523);class Om extends $h{constructor(e){super(e),this.manager=e,this.LEGEND_MAXIMUM_CLICKED=yD.vk,this.LEGEND_MINIMUM_CLICKED=yD.YW,this.LEGEND_RANGE_CHANGED=yD.WB,this.CANVAS_CONTROLS_PANEL_ID=is.LIN,this.TOP_TOOPBAR_HEIGHT_CONSTANT="THICKNESS_ANALYSIS_TOP_TOOLBAR_HEIGHT_PX"}updateGraphics(){void 0!==this.visualizedFieldType&&super.updateGraphics()}getInputRangeInDisplayUnits(){return this.manager.getRangeInDisplayUnits(this.manager.getRangeInData())}getDefaultDisplayRangeInDisplayUnits(){return this.manager.getRangeInDisplayUnits(this.manager.getDefaultDisplayRange())}isInputMinimumChanged(){return!!k.ZX_.isGradientField(this.visualizedFieldType)||super.isInputMinimumChanged()}requiresHighlightGraphics(){return this.manager.getUseMinValueHighlight()||this.manager.getUseMaxValueHighlight()||this.manager.getUseDimColorScale()}}var vm=i(28574);const Rm=1e-5,wm=[k.NSu.PREPROCESSING,k.NSu.QUEUED,k.NSu.WORKING,k.NSu.POSTPROCESSING,k.NSu.COMPLETE],_m=new Map([[k.NSu.PREPROCESSING,Am.bY.PROCESSING],[k.NSu.QUEUED,Am.bY.PREPARING],[k.NSu.WORKING,Am.bY.CALCULATING],[k.NSu.POSTPROCESSING,Am.bY.POSTPROCESSING],[k.NSu.COMPLETE,Am.bY.COMPLETE]]),Nm=new Map(wm.map(((e,t)=>[e,t])));var bm;!function(e){e[e.LENGTH=0]="LENGTH",e[e.UNITLESS=1]="UNITLESS"}(bm||(bm={}));const Lm=new Map([[k.DDL.ROLLING_BALL_THICKNESS,bm.LENGTH],[k.DDL.RAY_THICKNESS,bm.LENGTH],[k.DDL.ROLLING_BALL_THICKNESS_DERIVATIVE,bm.UNITLESS],[k.DDL.RAY_THICKNESS_DERIVATIVE,bm.UNITLESS]]);class Fm extends Jh{constructor(e){super(e),this.COLOR_MAP_STORAGE_KEY=Am.d0,this.LEGEND_CLOSED=yD.aI,this.LEGEND_OPENED=yD.Cv,this.VISUALIZATION_MANAGER_NODE_ID="ThicknessAnalysisManager",this.graphicsRenderMode=k.P1.THICKNESS_ANALYSIS_VISUALIZATION,this.elementIdToElementState=new Map,this.meshOwnerId=PS(),this.isEnabledSubject=new Is.x,this.bodyFilter=null,this.displayDataFunctionQueue=[],this.displayedScalarRangeSpecification={rangeInData:null,defaultDisplayRange:null},(0,is.eRd)(is.CrY).subscribe((()=>this.updateVisualizedScalarRange()))}getVisualizationStateForField(e){const t=this.getActiveElementState();return t?.visualizationStates.get(e)??null}initializeFieldType(e,t){const i=new k.ZX_,s=new k.dGY;s.addUnits(this.getBaseUnitsForField(t)),i.visualizedRange=s,i.displayedField=t,i.colorMapping=this.getStoredColorMapping();const n=this.computeDefaultFieldRange(t),{visualizationStates:r}=this.getOrCreateElementState(e);r.set(t,{visualizationState:i,defaultRange:{rangeInData:n,defaultDisplayRange:n}})}initializeFieldTypes(e){for(const t of Fm.ENABLED_FIELD_TYPES)this.initializeFieldType(e,t)}updateVisualizationState(){const e=this.getActiveVisualizedField();if(null===e)return;const t=this.getVisualizationStateForField(e);t&&(t.visualizationState.colorMapping=this.getStoredColorMapping(),t.visualizationState.userSetRangeMax||(t.visualizationState.visualizedRange.max=t.defaultRange.defaultDisplayRange?.max),t.visualizationState.userSetRangeMin||(t.visualizationState.visualizedRange.min=t.defaultRange.defaultDisplayRange?.min),this.setVisualizationState(t.visualizationState))}setVisualizationState(e){const t=this.getVisualizationStateForField(e.displayedField),{defaultRange:i}=t;this.displayedScalarRangeSpecification.rangeInData=i.rangeInData,this.displayedScalarRangeSpecification.defaultDisplayRange=i.defaultDisplayRange,this.legend&&(this.legend.visualizedFieldType=e.displayedField,this.legend.setInputRange(this.displayedScalarRangeSpecification)),t.visualizationState=e,super.setVisualizationState(e)}resetMeshes(){this.meshManager?.destroy(),this.meshManager=new AS(this.getViewer(),{bufferAllocationPolicy:$f.MAXIMUM})}prepareResources(){super.prepareResources(),this.getOrCreateElementState(this.activeElementId),this.updateVisualizationState(),null!==this.displayedColorMap&&this.displayedColorMap!==k.ZIP.UNKNOWN||this.setColorMapping(this.getStoredColorMapping()),this.legend||(this.legend=new Om(this))}setVisualizedField(e){const t=this.getActiveElementState();t&&e!==t.visualizedField&&(t.visualizedField=e,this.updateVisualizationState())}convertRadiiToDiameters(e){const t=e.clone();for(const e of t.result.fields){e.minValue*=2,e.maxValue*=2;for(let t=0;t<e.values.length;t+=1)e.values[t]*=2}return t}getOrCreateElementState(e){let t=this.elementIdToElementState.get(e);return t||(t={resultsCache:new Map,visualizedField:k.DDL.ROLLING_BALL_THICKNESS,visualizationStates:new Map,displayedColorMap:this.getStoredColorMapping(),hasScalarVisualizationOccurrences:!1,lastMicroversionIdAndConfiguration:null},this.elementIdToElementState.set(e,t),this.initializeFieldTypes(e)),t}getElementState(e){return this.elementIdToElementState.get(e)??null}getActiveElementState(){return this.getElementState(this.activeElementId)}getActiveVisualizedField(){return this.getActiveElementState()?.visualizedField??null}hasActiveSketch(){return!!this.getViewer().getSketch()||ci._3.getActiveFeatureController()?.isSketchFeatureController()}updateLastMicroversionIdAndConfiguration(e){if(!Rs())return;const t=this.getActiveElementState();t&&(t.lastMicroversionIdAndConfiguration=e)}onUpdate(e){const t=e.sourceElementId,i=this.getOrCreateElementState(t);for(const t of e.results){const e=this.convertRadiiToDiameters(t);i.resultsCache.set(t.bodyDeterministicId,e)}t===this.activeElementId&&(this.updateFieldRanges(),this.updateVisualizationState())}getAnalysisDisplayStatus(e){return e.isComplete&&e.status===k.NSu.WORKING?Am.bY.REFINING:_m.get(e.status)??Am.bY.UNKNOWN}getOverallStatus(e){const t=this.getElementState(e);if(!t)return k.NSu.UNKNOWN;let i=Number.POSITIVE_INFINITY;for(const e of t.resultsCache.values())i=Math.min(i,(s=e.status,Nm.get(s)??Number.POSITIVE_INFINITY));var s;return wm[i]??k.NSu.UNKNOWN}getOverallDisplayStatus(e){const t=this.getElementState(e);if(!t)return Am.bY.UNKNOWN;let i=Am.bY.COMPLETE;for(const e of t.resultsCache.values())i=Math.min(this.getAnalysisDisplayStatus(e),i);return i}resetState(e){const t=this.getElementState(e);t&&t.resultsCache.clear(),e===this.activeElementId&&(this.resetMeshes(),this.clearScalarVisualizationForVisualizedBodies()),this.updateGraphics()}isEnabledForElement(e){return this.getViewer().getRenderingModeOfElement(e)===this.graphicsRenderMode&&this.elementIdToElementState.has(e)}onRenderingModeChanged(){super.onRenderingModeChanged(),this.viewerIsInScalarVisualizationRenderMode()&&(this.getViewer().getUserEnabledAggressiveRefinement()&&this.getViewer().setUserEnabledAggressiveRefinement(!1),this.isEnabledSubject.next([this.activeElementId,!0]))}disable(){Ki.Jq.UserSettingsService.getUserSettings().then((e=>{if(!this.viewerIsInScalarVisualizationRenderMode())return;const t=Number(e.graphicsRenderMode);this.getViewer().setRenderingMode(t)})),this.isEnabledForElement(this.activeElementId)&&(this.resetState(this.activeElementId),this.isEnabledSubject.next([this.activeElementId,!1]))}isEnabled(){return!!this.getActiveElementState()}getNodeProperties(){return Fm.imageMaps.map(((e,t)=>new xi.hF({material:this.scalarVisualizationMaterials[t],zOffset:X.default.getManager().getNumber("PART_FACES_Z_OFFSET"),primitiveType:Di.MX.TRIANGLES,includedInBlend:!0,clippedBySectionPlanes:!0,isPickable:!1})))}getCurrentVisualizedField(e){return e.getFieldOfType(this.visualizationState.displayedField)}computeDefaultFieldRange(e){const t=this.getBaseUnitsForField(e);let i=null;this.getBaseUnitsForField(e);const s=this.getActiveElementState();if(s){for(const n of s.resultsCache.values()){const s=n.getFieldOfType(e);if(!s)continue;const r=k.dGY.fromMinMax(s.minValue,s.maxValue);r.addUnits(t),i=k.dGY.combine(i,r)}return i?.noRange&&(i.min-=Rm,i.max+=Rm),i}}updateFieldRanges(){for(const e of Fm.ENABLED_FIELD_TYPES){const t=this.computeDefaultFieldRange(e);if(!t||Number.isNaN(t.min))continue;const i=this.getVisualizationStateForField(e);if(!i)continue;const{defaultRange:s,visualizationState:n}=i;s.rangeInData=t,s.defaultDisplayRange=t,null===this.getBaseUnitsForField(e)&&(s.defaultDisplayRange=k.dGY.fromMinMax(.05,5)),n.visualizedRange?.noRange&&(n.visualizedRange=s.defaultDisplayRange)}const e=this.getRangeInData();this.updateDefaultDisplayRange(e),this.legend.visualizedFieldType=this.visualizationState.displayedField,this.updateVisualizedScalarRange()}shouldVisualizeBody(e,t){return!!e&&!!e.isSolidBody()}getMeshIncrementForBody(e,t){const i=this.getCurrentVisualizedField(e),{sampleMesh:s}=e,n=new vE(Di.MX.TRIANGLES,s.points,s.getAnyIndices());return n.packScalarsIntoTextureCoordinates(i.values),n.id=t.getId(),n}getBodyComponent(){return this.modelViewManager?.getDisplayedPartStudio()?.getBodyComponent()}clearScalarVisualizationForVisualizedBodies(){const e=this.getElementState(this.activeElementId);if(!e)return;if(!e.hasScalarVisualizationOccurrences)return;const t=this.getBodyComponent();t&&(t.clearAllScalarVisualizationOccurrences(),e.hasScalarVisualizationOccurrences=!1)}updateGraphicsForBody(e,t,i){if(!i.isComplete)return;const s=i.bodyDeterministicId,n=e.getBodyOccurrenceData(s);if(!n)return;const r=n.getOccurrenceId(),a=e.retrieveBodyMetaData(s);if(!this.shouldVisualizeBody(a,n))return;const o=this.getMeshIncrementForBody(i,a),h=this.meshManager.addMeshIncrement(o,this.meshOwnerId),c=new SS(this.VISUALIZATION_MANAGER_NODE_ID+" "+r);c.onIncrementAdded(h);const l=new XI.bg;a&&l.setAttribute(sE.COLOR,a.getColor());for(let e=0;e<t.length&&e<this.nodes.length;++e)this.nodes[e].addOccurrenceGeometryToNode(t[e],n,l,c);e.setScalarVisualizationOccurrence(r,a.getId());const u=this.getActiveElementState();u&&(u.hasScalarVisualizationOccurrences=!0)}clearGraphics(){this.clearScalarVisualizationForVisualizedBodies(),this.resetMeshes(),super.clearGraphics()}updateGraphics(){if(this.clearGraphics(),!this.isEnabled())return;if(!this.viewerIsInScalarVisualizationRenderMode())return;const e=this.getActiveElementState()?.resultsCache;if(!e)return;if(Ns())return;if(this.hasActiveSketch())return;const t=this.getNodeProperties(),i=this.getBodyComponent();if(i&&0!==e.size){this.cursorAppendage||(this.cursorAppendage=new ts(this.getViewer(),((e,t)=>this.getCursorText(e,t))));for(const s of e.values())s&&s.isComplete&&(s.result.fields.length<1||this.updateGraphicsForBody(i,t,s));this.updateColorMapping(null,this.displayedColorMap),this.getViewer().requestDraw()}}getCurrentMicroversionIdAndConfiguration(){return this.modelViewManager.getDisplayedElementMicroversionIdAndConfiguration()}onPartStudioDisplayDataChanged(e){if(e.elementId===this.activeElementId&&!e.isNoop&&this.viewerIsInScalarVisualizationRenderMode()){for(const e of this.displayDataFunctionQueue)e();if(this.displayDataFunctionQueue=[],e.usage===k.rvN.BASE){if(this.hasActiveSketch())this.clearGraphics();else if(!e.microversionIdAndConfigurationInterval.isEmptyInterval())return e.hasPartGeometryChanges()?void this.reactivate(e.elementId):(this.updateLastMicroversionIdAndConfiguration(e.microversionIdAndConfigurationInterval.to),void(this.getActiveElementState()?.hasScalarVisualizationOccurrences||this.updateGraphics()))}else this.clearGraphics()}}hasDefinedRange(){const e=this.visualizedScalarRange;return!!e&&(void 0!==e.min&&void 0!==e.max)}readyToShowLegend(){return!!this.legend&&(!!this.viewerIsInScalarVisualizationRenderMode()&&(!!this.isEnabled()&&(!!this.hasDefinedRange()&&(!!this.hasAnyDisplayableResults()&&(!this.hasActiveSketch()&&(!Ns()&&!!this.getBodyComponent()))))))}hasAnyDisplayableResults(){for(const e of this.getActiveElementState().resultsCache.values())if(e.isComplete)return!0;return!1}getBaseUnitsForField(e){switch(Lm.get(e)){case bm.LENGTH:return rr.ML.MILLIMETER;case bm.UNITLESS:return null}}getCurrentBaseUnits(){const e=this.getActiveVisualizedField();return null===e?null:this.getBaseUnitsForField(e)}getDisplayUnitsForField(e){switch(Lm.get(e)){case bm.LENGTH:return(0,nr.vx)().getLengthUnits();case bm.UNITLESS:return null}}getCurrentDisplayUnits(){return this.getDisplayUnitsForField(this.getActiveVisualizedField())}convertRangeToUnits(e,t){return t?(0,rr.vM)(e,t):k.dGY.fromMinMax(100*e.min,100*e.max)}getRangeInDisplayUnits(e){const t=this.getCurrentDisplayUnits();if(!e)return null;return this.convertRangeToUnits(e,t)}convertValueBetweenDisplayAndBaseUnits(e,t){const i=this.getCurrentDisplayUnits();if(!i)return t?e/100:100*e;const s=this.getCurrentBaseUnits();return t?(0,rr.WR)(e,i,s):(0,rr.WR)(e,s,i)}getUseMinValueHighlight(){return!!this.isDisplayingGradientField()||k.dGY.isMinChanged(this.getDefaultDisplayRange(),this.visualizedScalarRange,Ci.W.ZERO_LENGTH)}getUseMaxValueHighlight(){return k.dGY.isMaxChanged(this.getDefaultDisplayRange(),this.visualizedScalarRange,Ci.W.ZERO_LENGTH)}getUseDimColorScale(){return this.visualizationState.dimColorScale}setUseDimColorScale(e){this.visualizationState.dimColorScale=e,this.updateScalarRangeUniforms(),this.updateGraphics()}reactivate(e){if(e===this.activeElementId){const e=this.getCurrentMicroversionIdAndConfiguration(),t=this.getActiveElementState().lastMicroversionIdAndConfiguration;if(!e)return;if(e.equals(t))return void this.updateGraphics()}Ki.Jq.ThicknessAnalysisService.updateVisualization(e)}getIsEnabledObservable(){return this.isEnabledSubject.asObservable()}getBodyFilter(){return this.bodyFilter||(this.bodyFilter=(0,vm.v)([(0,ns._x)(k.ZSW.BODY),(0,ns.NC)(k.wG2.SOLID),(0,ns.O6)(!0),(0,ns.II)()])),this.bodyFilter}isDisplayingGradientField(){return this.visualizationState?.isDisplayingGradientField()??!1}getMinHighlightColor(){if(this.isDisplayingGradientField()){const e=X.default.getManager(),t=this.getColorMappingName();return e.getColor(jh.DIM_COLOR_CONSTANT+t)}return super.getMinHighlightColor()}setActiveElementId(e){this.activeElementId!==e&&this.runAfterNextDisplayDataUpdate((()=>{this.updateFieldRanges(),this.updateVisualizationState()})),this.activeElementId=e}runAfterNextDisplayDataUpdate(e){this.displayDataFunctionQueue.push(e)}onDocumentDestroyed(){this.resetState(this.activeElementId),this.elementIdToElementState.clear()}}Fm.ENABLED_FIELD_TYPES=[k.DDL.ROLLING_BALL_THICKNESS,k.DDL.RAY_THICKNESS,k.DDL.ROLLING_BALL_THICKNESS_DERIVATIVE,k.DDL.RAY_THICKNESS_DERIVATIVE];var xm=i(67488),Bm=i(76823),Vm=i(6638),Um=i(76048),Gm=i(91669);const Hm=new xi.hF({material:new Ni,zOffset:X.default.getManager().getNumber("PART_FACES_Z_OFFSET"),primitiveType:Di.MX.TRIANGLES,includedInBlend:!0,clippedBySectionPlanes:!0,isPickable:!1,primitivesHaveTransparency:!0});Hm.material?.setCustomFloatUniform("uOcclusionFactor",0);const km=Hm.cloneAndModify({primitivesHaveTransparency:!1});class Wm{constructor(e){this.modelViewManager=e,this.meshOwnerId=PS(),this.runningMultiPart=null,this.previewCache=new Map,this.getViewer().getEventDispatcher().on(is.t0J,(()=>this.onAssemblyDisplayed())),(0,sr.m)().on(ir.C.GET_GENERATIVE_INPUT_TRS,(()=>this.getGenerativeInputTrs())),(0,sr.m)().on(ir.C.CANCEL_GENERATIVE_RUN,(()=>this.cancelGenerativeRun()))}onChangeActiveElement(){this.clearGraphics()}getCachedResponseForElementId(e){return this.previewCache.get(e)}cacheResponse(e){if(!e.hasResults()){const t=this.getCachedResponseForElementId(e.elementId);t?.hasResults()&&(e.generativeFeatureIdToResult=t.generativeFeatureIdToResult)}this.previewCache.set(e.elementId,e)}resetCache(e){const t=new k.ZjL;t.completionPercentage=0,this.previewCache.set(e,t)}restorePreviewForActiveElement(){const e=this.getCachedResponseForElementId(this.getViewer().getActiveElementId());e&&this.displayGenerativeResponse(e)}onAssemblyDisplayed(){this.restorePreviewForActiveElement()}getViewer(){return this.modelViewManager.getViewer()}runGenerative(e){if(0===e.size)return Ki.Jq.MessageBubbleService.showMessageWithAutoDismiss(i18n("No generative features detected."),"warning"),void Ki.Jq.AngularEventService.ensureDigest();this.generativeRunStart=new Date;const t=new k.ijO;t.generativeFeatureIds=[...e],t.skipCompute=!1,t.elementId=this.getViewer().getActiveElementId(),this.runningMultiPart=t.generativeFeatureIds.length>1,this.updateGraphics(),this.resetCache(t.elementId),this.updateBeeper(0),xm.Op.getConnection(xm.tl).send(t)}updateGraphics(){this.clearGraphics()}displayGenerativeResponse(e){if(Object.values(e.generativeFeatureIdToResult).length>0&&this.drawPreview(e),e.isRunComplete)return this.beeper?.stopBeeper(),void(this.beeper=null);this.updateBeeper(e.completionPercentage)}onFgsErrorInfo(e){this.clearGraphics();const t=i18n("Generative returned an error: __errorText__",{errorText:e.errorText});Ki.Jq.MessageBubbleService.showMessageWithWarning(t),Ki.Jq.AngularEventService.ensureDigest(),ut.log.warn(t),this.generativeRunStart&&(ut.log.debug(`generative.onFgsErrorInfo: Generative run finished exceptionally. Client-side timing information: ${Um.B.withStartTime(this.generativeRunStart)}`),this.generativeRunStart=null)}onGenerativeResponse(e){this.getViewer().getActiveElementId()===e.elementId&&this.displayGenerativeResponse(e),this.cacheResponse(e),e.isRunComplete&&this.generativeRunStart&&(ut.log.debug(`generative.onGenerativeResponse: Generative run completed. Client-side timing information: ${Um.B.withStartTime(this.generativeRunStart)}`),this.generativeRunStart=null)}updateBeeper(e,t){let i;if(t)i=t;else if(e){const t=(0,ar.roundTo)(e,2);i=this.runningMultiPart?i18n("Generating designs (__roundedPercentage__%)",{roundedPercentage:t}):i18n("Generating design (__roundedPercentage__%)",{roundedPercentage:t})}else i=this.runningMultiPart?i18n("Generating designs"):i18n("Generating design");if(this.beeper)this.beeper.setExplanation(i);else{const e=new Vm.e("generativeDesign").setImportant(i);this.beeper=(0,Bm.l)().startTaskBeeper(this.getViewer().getActiveElementId(),e)}}resetMeshes(){this.meshManager?.destroy(),this.meshManager=new AS(this.getViewer(),{bufferAllocationPolicy:$f.MAXIMUM})}clearGraphics(){this.resetScenegraphNode(),this.resetMeshes(),this.beeper?.stopBeeper(),this.beeper=null,this.getViewer().requestDraw()}resetScenegraphNode(){this.previewNode?.remove(),this.previewNode=new xi.NB(Wm.PREVIEW_NODE_ID,Hm),this.previewNode.setVisible(!1),this.modelViewManager.getSharedBodyNode().addChild(this.previewNode)}drawPreview(e){const t=this.getViewer().getOccurrenceIdManager(),i=this.getViewer().getOccurrenceDataManager(),s=this.modelViewManager.getDisplayedAssembly();if(s&&s.elementId===e.elementId){for(const n of Object.values(e.generativeFeatureIdToResult)){const r=n.preview.sampleMesh,a=new vE(Di.MX.TRIANGLES,r.points,r.getAnyIndices());(0,Au.wK)(a),a.replicateTextureCoordinate([0,0]);for(const r of n.relatedOccurrences){this.modelViewManager.setOccurrenceAlphaModifier(r,is.M81);const n=r.getPathAsString(),o=t.getIdForName(n);if(o===Jf.Qy){ut.log.warn("No occurrence id for "+n);continue}const h=i.getOccurrenceData(o);h||ut.log.warn("No occurrence data for "+n);const c=s.getOccurrenceDisplayData(r);if(!c){ut.log.warn("No occurrence display data for "+n);continue}const l=this.modelViewManager.getPartStudioDataFromOccurrence(r);if(!l){ut.log.debug("No part studio for occurrence "+n);continue}a.id=n;const u=this.meshManager.addMeshIncrement(a,this.meshOwnerId),d=new SS("Generated "+n);d.onIncrementAdded(u);const g=l.retrieveBodyMetaData(c.partIds[0]),p=new XI.bg;g&&p.setAttribute(sE.COLOR,g.getColor());const m=e.isRunComplete?km:Hm;if(this.previewNode.addOccurrenceGeometryToNode(m,h,p,d),this.debugMeshEdges){const e=(0,Au.EK)(a,a.id+".edges"),t=this.meshManager.addMeshIncrement(e,this.meshOwnerId),i=new SS("Generated "+n+" edges");i.onIncrementAdded(t),this.previewNode.addOccurrenceGeometryToNode(op,h,null,i)}}}this.previewNode.setVisible(!0),this.getViewer().requestDraw()}else ut.log.debug("Tried to display generative response in the wrong element")}getGenerativeInputTrs(){if(!Ki.Jq.CapabilitiesService.checkGenerativeDesignCurrentlyEnabled())return;if(this.requestedInputTrsForAssembly){const e=i18n("Still waiting on an input TRS for __assemblyName__.",{assemblyName:this.requestedInputTrsForAssembly});Ki.Jq.MessageBubbleService.showMessageWithWarning(e)}const e=ci._3.getOpenDocumentController();if(!e)return;const t=e.getActiveAssemblyModel();if(!t)return;const i=e.getElementConnection();if(!i)return;this.updateBeeper(0,i18n("Generating input TRS..."));const s=new k.ijO;s.generativeFeatureIds=t.getUnsuppressedGenerativeFeatures().map((e=>e.featureId)),s.skipCompute=!0,s.elementId=this.getViewer().getActiveElementId(),i.send(s),this.requestedInputTrsForAssembly=t.getName()}onComputedDataResponse(e){this.requestedInputTrsForAssembly?((0,Gm.G)(new Blob([e.computedData]),`${this.requestedInputTrsForAssembly}_generative_input.trs`),this.requestedInputTrsForAssembly=null,this.beeper?.stopBeeper(),this.beeper=null):ut.log.warn("Received unexpected BTFgsComputedDataResponse")}cancelGenerativeRun(){if(!Ki.Jq.CapabilitiesService.isDebugEnabled())return;const e=new k.eng;e.elementId=this.getViewer().getActiveElementId(),ci._3.getOpenDocumentController().getElementConnection().send(e)}}Wm.PREVIEW_NODE_ID="GenerativeDesignPreview";var zm=i(96802),Xm=i(96347);class Zm extends Xm.W{constructor(){super("/js/GraphicsWebAssemblyUtils.js","createGraphicsUtilsModule")}static get module(){return Zm.singleton||(Zm.singleton=new Zm),Zm.singleton}replaySampleMeshRefinementRoutine(e,t){const i=new Qo.B7("GraphicsWebAssemblyUtils.replaySampleMeshRefinementRoutine"),s=this.copyFloat32ArrayToWasmHeap(e.points),n=this.copyInt32ArrayToWasmHeap(e.intIndices),r=this.copyTypedUint8ArrayToWasmHeap(t.history),a=this.module.replaySampleMeshRefinementRoutine(s,e.points.length,n,e.intIndices.length,r,t.recordCount),o=new k.JW9;return o.points=this.copyFloat32ArrayFromWasmHeap(a.getPointsLocation(),a.getPointsSize()),o.intIndices=this.copyInt32ArrayFromWasmHeap(a.getIndicesLocation(),a.getIndicesSize()),this.free(s),this.free(n),this.free(r),a.delete(),i.report(),o}}var qm=i(61252);const Ym={blitFunctions:i(57162).Z,compareFunctions:i(65736).Z,constants:i(71364).Z,contactVisualizationFunctions:i(83535).Z,cosmeticThreadFunctions:i(82488).Z,decalFunctions:i(34951).Z,depthNormalFunctions:i(38599).Z,edgeFragmentUtilityFunctions:i(78904).Z,edgeUtilityFunctions:i(88598).Z,fragmentCurvatureUtilityFunctions:i(10156).Z,fragmentLightingUtilityFunctions:i(45249).Z,"fs-OITAccumulation":i(93192).Z,"fs-OITAccumulation-faces":i(93192).Z,"fs-OITAccumulation-faces-contact":i(36119).Z,"fs-OITAccumulation-faces-decals":i(46251).Z,"fs-OITAccumulation-faces-cosmeticThreads":i(47645).Z,"fs-OITAccumulation-edges":i(12885).Z,"fs-OITAccumulation-silhouettes":i(85504).Z,"fs-OITComposite":i(57878).Z,"fs-OITRevealage":i(30827).Z,"fs-OITRevealage-faces":i(30827).Z,"fs-OITRevealage-faces-contact":i(59335).Z,"fs-OITRevealage-faces-decals":i(29419).Z,"fs-OITRevealage-faces-cosmeticThreads":i(29724).Z,"fs-OITRevealage-edges":i(95946).Z,"fs-OITRevealage-silhouettes":i(21961).Z,"fs-backfacesil-faces":i(25363).Z,"fs-blitBodyCheck":i(14489).Z,"fs-compareBlend":i(61717).Z,"fs-debugPickPass":i(91685).Z,"fs-depth-edges":i(34778).Z,"fs-depth-faces":i(35504).Z,"fs-depth-points":i(46613).Z,"fs-draftAngle-faces":i(76151).Z,"fs-draftShadow-faces":i(75121).Z,"fs-draw-draftAnalysis":i(94487).Z,"fs-draw-edges":i(95946).Z,"fs-draw-endcap":i(97599).Z,"fs-draw-endcap-depth":i(76136).Z,"fs-draw-faces":i(93321).Z,"fs-draw-faces-contact":i(21423).Z,"fs-draw-faces-decals":i(23233).Z,"fs-draw-faces-cosmeticThreads":i(20213).Z,"fs-draw-faces-scalarVisualization":i(54909).Z,"fs-draw-points":i(74295).Z,"fs-draw-qualityVisualization":i(43819).Z,"fs-draw-silhouettes":i(21961).Z,"fs-draw-zebraStripes":i(59063).Z,"fs-drawTexture":i(45758).Z,"fs-edgeDetect":i(89244).Z,"fs-endcapMask-faces":i(96174).Z,"fs-endcapMask-faces-simulation":i(30151).Z,"fs-gaussianFilter":i(67715).Z,"fs-highlightBuffer-faces":i(95928).Z,"fs-highlightDraw-edges":i(55814).Z,"fs-highlightDraw-points":i(62870).Z,"fs-highlightDraw":i(21643).Z,"fs-highlightMask-faces":i(15751).Z,"fs-normalDepth-faces":i(62937).Z,"fs-normalDepthFilter":i(27079).Z,"fs-normalDepthWithMask-edges":i(61739).Z,"fs-normalDepthWithMask-faces":i(46079).Z,"fs-normalDepthWithMask-points":i(68404).Z,"fs-occlusion":i(44675).Z,"fs-occlusionFilter":i(52937).Z,"fs-pick-alternates-edges":i(44684).Z,"fs-pick-alternates-faces":i(78349).Z,"fs-pick-edges":i(95309).Z,"fs-pick-endcap":i(64307).Z,"fs-pick-faces":i(50115).Z,"fs-pick-points":i(83987).Z,"fs-planeId-faces":i(64193).Z,"fs-previewBlend":i(40500).Z,"fs-retrieveScalar-faces":i(44571).Z,"fs-tintByDepth-edges":i(57021).Z,"fs-tintByDepth-points":i(68721).Z,"fs-tintByNormalDepth-faces":i(77823).Z,"fs-tintByNormalDepth-faces-decals":i(52709).Z,"fs-tintByNormalDepth-faces-cosmeticThreads":i(30329).Z,"fs-tintByPlaneId-faces":i(44809).Z,getNormalSign:i(18149).Z,highlightFunctions:i(20261).Z,normalDepthWithMaskFunctions:i(95675).Z,picking:i(90271).Z,planeIdFunctions:i(28040).Z,pointFragmentUtilityFunctions:i(86262).Z,sectionPlaneClippingFunctions:i(29167).Z,sectionPlaneConstants:i(3045).Z,sectionPlaneEndcapFunctions:i(8642).Z,sectionPlaneEndcapMedianFilter:i(22269).Z,sectionPlaneEndcapPatternFunctions:i(18283).Z,sectionPlaneFragmentUtilityFunctions:i(15474).Z,setContactVaryings:i(69536).Z,undercutWeightFunction:i(45011).Z,utilityFunctions:i(25141).Z,vertexPicking:i(58161).Z,vertexUtilityFunctions:i(17318).Z,"vs-OITAccumulation":i(7994).Z,"vs-OITAccumulation-faces":i(7994).Z,"vs-OITAccumulation-faces-contact":i(39492).Z,"vs-OITAccumulation-faces-decals":i(43871).Z,"vs-OITAccumulation-faces-cosmeticThreads":i(52078).Z,"vs-OITAccumulation-edges":i(55116).Z,"vs-OITAccumulation-silhouettes":i(48352).Z,"vs-OITComposite":i(88926).Z,"vs-OITRevealage":i(81301).Z,"vs-OITRevealage-faces":i(81301).Z,"vs-OITRevealage-faces-contact":i(79345).Z,"vs-OITRevealage-faces-decals":i(12487).Z,"vs-OITRevealage-faces-cosmeticThreads":i(86420).Z,"vs-OITRevealage-edges":i(55116).Z,"vs-OITRevealage-silhouettes":i(48352).Z,"vs-backfacesil-faces":i(58091).Z,"vs-blitBodyCheck":i(65486).Z,"vs-compareBlend":i(77356).Z,"vs-debugPickPass":i(99784).Z,"vs-depth-edges":i(7977).Z,"vs-depth-faces":i(99696).Z,"vs-depth-points":i(6621).Z,"vs-draftAngle-faces":i(51188).Z,"vs-draftShadow-faces":i(84539).Z,"vs-draw-draftAnalysis":i(71734).Z,"vs-draw-edges":i(55116).Z,"vs-draw-endcap":i(50895).Z,"vs-draw-endcap-depth":i(18293).Z,"vs-draw-faces":i(89832).Z,"vs-draw-faces-contact":i(6378).Z,"vs-draw-faces-decals":i(6382).Z,"vs-draw-faces-cosmeticThreads":i(719).Z,"vs-draw-faces-scalarVisualization":i(89906).Z,"vs-draw-points":i(35644).Z,"vs-draw-qualityVisualization":i(38464).Z,"vs-draw-silhouettes":i(48352).Z,"vs-draw-zebraStripes":i(91448).Z,"vs-drawTexture":i(95056).Z,"vs-edgeDetect":i(66365).Z,"vs-endcapMask-faces":i(34660).Z,"vs-endcapMask-faces-simulation":i(60486).Z,"vs-gaussianFilter":i(7101).Z,"vs-highlightBuffer-faces":i(21863).Z,"vs-highlightDraw-edges":i(10277).Z,"vs-highlightDraw-points":i(15112).Z,"vs-highlightDraw":i(60297).Z,"vs-highlightMask-faces":i(15045).Z,"vs-normalDepth-faces":i(15980).Z,"vs-normalDepthFilter":i(4916).Z,"vs-normalDepthWithMask-edges":i(27624).Z,"vs-normalDepthWithMask-faces":i(82854).Z,"vs-normalDepthWithMask-points":i(18826).Z,"vs-occlusion":i(76323).Z,"vs-occlusionFilter":i(79966).Z,"vs-pick-alternates-edges":i(35289).Z,"vs-pick-alternates-faces":i(83158).Z,"vs-pick-edges":i(41201).Z,"vs-pick-endcap":i(82054).Z,"vs-pick-faces":i(9318).Z,"vs-pick-points":i(34574).Z,"vs-planeId-faces":i(47223).Z,"vs-previewBlend":i(32147).Z,"vs-retrieveScalar-faces":i(65366).Z,"vs-tintByDepth-edges":i(64166).Z,"vs-tintByDepth-points":i(44093).Z,"vs-tintByNormalDepth-faces":i(54154).Z,"vs-tintByNormalDepth-faces-decals":i(66222).Z,"vs-tintByNormalDepth-faces-cosmeticThreads":i(6147).Z,"vs-tintByPlaneId-faces":i(65161).Z,weightFunctions:i(15521).Z},Km=1,jm=0;var Qm;!function(e){e.SKIP_SECTION_PLANES="SKIP_SECTION_PLANES",e.USE_OCCURRENCE_TEXTURE="USE_OCCURRENCE_TEXTURE",e.USE_SECTION_PLANES="USE_SECTION_PLANES",e.USE_VERTEX_HIGHLIGHT_TEXTURE="USE_VERTEX_HIGHLIGHT_TEXTURE",e.DERIVATIVES_SUPPORTED="DERIVATIVES_SUPPORTED",e.LOOP_BREAK_SUPPORTED="LOOP_BREAK_SUPPORTED"}(Qm||(Qm={}));const $m="-nosection";function Jm(e,t){return t?"#define "+e+" 1\n":""}let ef=null;function tf(e,t){if(ef&&!t)return;if(!Ym)return;const i=(0,z.Z)(Ym);for(const e in i){let t=i[e];const s=/{{{.*}}}/g;let n=0,r=s.exec(t);for(;r;){const a=r[0].substr(3,r[0].length-6);if(!i.hasOwnProperty(a)){ut.log.warn("Missing shader include: "+a);break}const o=r.index+r[0].length;t=t.substr(0,r.index)+i[a]+t.substr(o,t.length-o),++n>100&&ut.log.warn("Encountered a large number of includes while substituting shader "+e+". An include cycle may have been introduced."),s.lastIndex=0,r=s.exec(t)}i[e]=t}ef={};let s=Jm(Qm.USE_SECTION_PLANES,e.supportsGraphicalSectionPlanes());s+=Jm(Qm.USE_VERTEX_HIGHLIGHT_TEXTURE,e.areHighlightVertexTexturesSupported()),s+=Jm(Qm.DERIVATIVES_SUPPORTED,e.areShaderDerivativesSupported()),s+=Jm(Qm.LOOP_BREAK_SUPPORTED,!(0,dt.isPlatformMac)()||(0,dt.isBrowserSafari)());const n=s+Jm(Qm.SKIP_SECTION_PLANES,!0),r=Object.keys(i);for(let e=0;e<r.length;++e){const t=r[e],a=i[t];if(ef[t]=s+a,t.startsWith("fs-")&&-1!==a.indexOf("discardIfPositionFails")){ef[t+$m]=n+a;const e="v"+t.substr(1,t.length);e in i&&(ef[e+$m]=n+i[e])}}}function sf(e,t){const i=e.indexOf($m);return i<0?e+"-"+t:e.substr(0,i)+"-"+t+$m}class nf{constructor(e,t,i,s,n=!1,r=1){this.type=e,this.dimension=t,this.offset=i,this.stride=s,this.normalize=n,this.secondDimension=r,this.columnStride=Bt(this.type)*this.dimension}clone(){return new nf(this.type,this.dimension,this.offset,this.stride,this.normalize,this.secondDimension)}offsetForColumn(e){return this.offset+e*this.columnStride}get multiDimensionStride(){return this.stride+this.secondDimension*this.columnStride}get elementCount(){return this.dimension*this.secondDimension}}function rf(e){const t="vs"+e,i="fs"+e;return ef.hasOwnProperty(t)&&ef.hasOwnProperty(i)}class af extends m.T{constructor(e,t){super(),this.viewer=e,this.id=t,this.vertexShader=null,this.fragmentShader=null,this.shaderProgram=null,this.uniformLocations={},this.attribLocations={},this.boundTextures={},this.shaderValidated=!1,this.disableVertexAttribArrayIfVaoUnavailable=null,(0,Jo.Yk)(e),this.listenTo(this.viewer.getEventDispatcher(),yD.cW,this.onGlContextLost),this.listenTo(this.viewer.getEventDispatcher(),yD.pO,this.onGlContextRestored),this.listenTo(this.viewer.getEventDispatcher(),yD.so,this.destroy),this.reinitialize(),this.disableVertexAttribArrayIfVaoUnavailable=this.viewer.areVertexArrayObjectsAvailable?e=>{}:e=>this.enableVertexAttribArray(e,!1),this.numericId=++af.numericIdIncrementer}getId(){return this.id}getNumericId(){return this.numericId}destroy(){this.stopListening(),this.clearGlReferences()}clearGlReferences(){this.shaderValidated=!1,this.shaderProgram=null,this.vertexShader=null,this.fragmentShader=null,this.uniformLocations={},this.attribLocations={}}onGlContextLost(){this.clearGlReferences()}onGlContextRestored(){this.reinitialize()}reinitialize(){this.initializationFailed||(this.clearGlReferences(),this.viewer.getGlContext()&&(this.shaderProgram=this.initProgram()),this.unbindTextures())}equals(e){return null!==e&&this.id===e.id}deactivate(){if(!this.viewer.areVertexArrayObjectsAvailable)for(const e in this.attribLocations)this.enableVertexAttribArray(e,!1);this.unbindTextures()}unbindTextures(){for(const e in this.boundTextures)eo(this.viewer,e);this.boundTextures={}}makeShader(e,t){const i=ef[e];if(!i||i.length<1)return ut.log.warn('Shader "'+e+'" not found'),null;const s=this.viewer.getGlContext();if(!s)return null;const n=s.createShader(t);return s.shaderSource(n,i),s.compileShader(n),n}getVertexShaderId(){return"vs"+this.id}getFragmentShaderId(){return"fs"+this.id}get initializationFailed(){return this.viewer.badShaders.hasOwnProperty(this.id)}set initializationFailed(e){e?this.viewer.badShaders[this.id]=!0:delete this.viewer.badShaders[this.id]}initProgram(){if(this.initializationFailed)return null;const e=this.viewer.getGlContext();if(this.vertexShader=this.makeShader(this.getVertexShaderId(),e.VERTEX_SHADER),this.fragmentShader=this.makeShader(this.getFragmentShaderId(),e.FRAGMENT_SHADER),!this.vertexShader||!this.fragmentShader)return this.initializationFailed=!0,null;const t=e.createProgram();return e.attachShader(t,this.vertexShader),e.attachShader(t,this.fragmentShader),e.bindAttribLocation(t,0,tE.POSITION),e.linkProgram(t),t}validateProgram(){if(this.shaderValidated)return;this.validateShader(this.vertexShader,this.getVertexShaderId()),this.validateShader(this.fragmentShader,this.getFragmentShaderId());const e=this.viewer.getGlContext();try{if(!e.getProgramParameter(this.shaderProgram,e.LINK_STATUS)&&!e.isContextLost()){this.clearGlReferences();const t=e.getProgramInfoLog(this.shaderProgram);ut.log.warn(vD+"Could not link shaders for "+this.id+":\n "+t),of(this.getVertexShaderId()),of(this.getFragmentShaderId()),this.initializationFailed=!0}}catch(e){this.initializationFailed=!0,ut.log.warn(vD+"Could not link shaders for "+this.id+", and log info retrieval failed. (Try in a different browser to see if it gives you more details.)")}this.shaderValidated=!0}validateShader(e,t){const i=this.viewer.getGlContext();try{e&&(i.getShaderParameter(e,i.COMPILE_STATUS)||i.isContextLost())||(ut.log.warn(vD+"Error compiling shader "+t+":\n"+i.getShaderInfoLog(e)),of(t))}catch(e){ut.log.debug(vD+"Error getting shader info for: "+t+":\n"+e)}}ensureShaderIsInitialized(){this.shaderProgram||this.reinitialize()}useShader(){this.ensureShaderIsInitialized(),this.validateProgram(),this.viewer.getGlContext().useProgram(this.shaderProgram)}getUniformLocation(e){this.ensureShaderIsInitialized();let t=this.uniformLocations[e];return void 0!==t||(t=this.initializationFailed?null:this.viewer.getGlContext().getUniformLocation(this.shaderProgram,e),this.uniformLocations[e]=t),t}hasUniform(e){return!!this.getUniformLocation(e)}outputUniforms(){const e=this.viewer.getGlContext();let t=e.getProgramParameter(this.shaderProgram,e.ACTIVE_UNIFORMS);if(isNaN(t))return;t=+t.toString(),ut.log.debug("Uniforms for shader: "+this.id);const i=function(e){let t="<";for(let i=0;i<e.length;++i)t+=e[i],i<e.length-1&&(t+=", ");return t+=">",t};for(let s=0;s<t;++s){const t=e.getActiveUniform(this.shaderProgram,s);if(t){let s=e.getUniform(this.shaderProgram,this.getUniformLocation(t.name));(s instanceof Float32Array||s instanceof Int32Array||s instanceof Array)&&(s=i(s)),ut.log.debug("  Uniform: "+t.name+", size: "+t.size+", type: "+t.type+", value: "+s)}}}outputAttributes(){const e=this.viewer.getGlContext();let t=e.getProgramParameter(this.shaderProgram,e.ACTIVE_ATTRIBUTES);if(isNaN(t))return;const i=["VERTEX_ATTRIB_ARRAY_BUFFER_BINDING","VERTEX_ATTRIB_ARRAY_ENABLED","VERTEX_ATTRIB_ARRAY_SIZE","VERTEX_ATTRIB_ARRAY_STRIDE","VERTEX_ATTRIB_ARRAY_TYPE","VERTEX_ATTRIB_ARRAY_NORMALIZED","CURRENT_VERTEX_ATTRIB"];t=+t.toString(),ut.log.debug("Attributes for shader: "+this.id);for(let s=0;s<t;++s){const t=e.getActiveAttrib(this.shaderProgram,s);if(t){const n=this.getAttribLocation(t.name);ut.log.debug("  Attribute "+s+": "+t.name+", size: "+t.size+", type: "+t.type),ut.log.debug("    Location: "+n),ut.log.debug("    Pointer offset: "+e.getVertexAttribOffset(n,e.VERTEX_ATTRIB_ARRAY_POINTER));for(let t=0;t<i.length;++t){const s=i[t],r=e.getVertexAttrib(n,e[s]);"CURRENT_VERTEX_ATTRIB"===s?ut.log.debug("    "+s+" : ["+r[0]+", "+r[1]+", "+r[2]+", "+r[3]+"]"):ut.log.debug("    "+s+" : "+r)}}}}getAttribLocation(e){this.ensureShaderIsInitialized();let t=this.attribLocations[e];return void 0!==t||(t=this.initializationFailed?-1:this.viewer.getGlContext().getAttribLocation(this.shaderProgram,e),this.attribLocations[e]=t),t}hasAttribute(e){return this.getAttribLocation(e)>=0}vertexAttribPointer(e,t){const i=this.getAttribLocation(e);if(i<0)return;const s=this.viewer.getGlContext();if(1===t.secondDimension)s.vertexAttribPointer(i,t.dimension,t.type,t.normalize,t.stride,t.offset);else for(let e=0;e<t.secondDimension;++e)s.vertexAttribPointer(i+e,t.dimension,t.type,t.normalize,t.multiDimensionStride,t.offsetForColumn(e));this.enableVertexAttribArray(e,!0,t.secondDimension)}enableVertexAttribArray(e,t,i){void 0===t&&(t=!0);const s=this.getAttribLocation(e);if(!(s<0))if(i)for(let e=0;e<i;++e)this.viewer.enableVertexAttributeArray(s+e,t);else this.viewer.enableVertexAttributeArray(s,t)}useTexture(e,t){if(!this.hasUniform(e))return;let i;i=t instanceof $a?t.updateAndBindTexture(e):Ja(this.viewer,t,e),i<0?this.useBlankTexture(e):(this.boundTextures[e]=i,this.uniform1i(e,i))}setAttribute(e,t){switch(e.dimension){case 1:this.vertexAttrib1f(e.name,t);break;case 2:this.vertexAttrib2fv(e.name,t);break;case 3:this.vertexAttrib3fv(e.name,t);break;case 4:this.vertexAttrib4fv(e.name,t)}}setFloatUniform(e,t){switch(t.length){case 2:this.uniform2fv(e,t);break;case 3:this.uniform3fv(e,t);break;case 4:this.uniform4fv(e,t);break;default:this.uniform1f(e,t)}}setIntUniform(e,t){switch(t.length){case 2:this.uniform2iv(e,t);break;case 3:this.uniform3iv(e,t);break;case 4:this.uniform4iv(e,t);break;default:this.uniform1i(e,t)}}setMatrixUniform(e,t,i=!1){switch(t.length){case 16:this.uniformMatrix4fv(e,i,t);break;case 9:this.uniformMatrix3fv(e,i,t);break;case 4:this.uniformMatrix2fv(e,i,t);break;default:ut.log.debug(`Unsupported matrix size in setMatrixUniform. ${e}, length: ${t.length}`)}}setVectorUniform(e,t){switch(t.length){case 4:this.uniform4fv(e,t);break;case 3:this.uniform3fv(e,t);break;case 2:this.uniform2fv(e,t);break;default:ut.log.debug(`Unsupported vector size in setVectorUniform. ${e}, length: ${t.length}`)}}useBlankTexture(e){if(!this.hasUniform(e))return;const t=this.viewer.getResources().getBlankTexture().updateAndBindTexture(e);t>=0&&(this.boundTextures[e]=t,this.uniform1i(e,t))}uniform1f(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform1f(i,t)}uniform1fv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform1fv(i,t)}uniform1i(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform1i(i,t)}uniform1iv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform1iv(i,t)}uniform2f(e,t,i){const s=this.getUniformLocation(e);null!==s&&this.viewer.getGlContext().uniform2f(s,t,i)}uniform2fv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform2fv(i,t)}uniform2i(e,t,i){const s=this.getUniformLocation(e);null!==s&&this.viewer.getGlContext().uniform2i(s,t,i)}uniform2iv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform2iv(i,t)}uniform3f(e,t,i,s){const n=this.getUniformLocation(e);null!==n&&this.viewer.getGlContext().uniform3f(n,t,i,s)}uniform3fv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform3fv(i,t)}uniform3i(e,t,i,s){const n=this.getUniformLocation(e);null!==n&&this.viewer.getGlContext().uniform3i(n,t,i,s)}uniform3iv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform3iv(i,t)}uniform4f(e,t,i,s,n){const r=this.getUniformLocation(e);null!==r&&this.viewer.getGlContext().uniform4f(r,t,i,s,n)}uniform4fv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform4fv(i,t)}uniform4i(e,t,i,s,n){const r=this.getUniformLocation(e);null!==r&&this.viewer.getGlContext().uniform4i(r,t,i,s,n)}uniform4iv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform4iv(i,t)}uniformMatrix2fv(e,t,i){const s=this.getUniformLocation(e);null!==s&&this.viewer.getGlContext().uniformMatrix2fv(s,t,i)}uniformMatrix3fv(e,t,i){const s=this.getUniformLocation(e);null!==s&&this.viewer.getGlContext().uniformMatrix3fv(s,t,i)}uniformMatrix4fv(e,t,i){const s=this.getUniformLocation(e);null!==s&&this.viewer.getGlContext().uniformMatrix4fv(s,t,i)}vertexAttrib1f(e,t){const i=this.getAttribLocation(e);i<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib1f(i,t))}vertexAttrib1fv(e,t){const i=this.getAttribLocation(e);i<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib1fv(i,t))}vertexAttrib2f(e,t,i){const s=this.getAttribLocation(e);s<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib2f(s,t,i))}vertexAttrib2fv(e,t){const i=this.getAttribLocation(e);i<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib2fv(i,t))}vertexAttrib3f(e,t,i,s){const n=this.getAttribLocation(e);n<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib3f(n,t,i,s))}vertexAttrib3fv(e,t){const i=this.getAttribLocation(e);i<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib3fv(i,t))}vertexAttrib4f(e,t,i,s,n){const r=this.getAttribLocation(e);r<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib4f(r,t,i,s,n))}vertexAttrib4fv(e,t){const i=this.getAttribLocation(e);i<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib4fv(i,t))}}function of(e){const t=ef[e];if(!t||t.length<1)return void ut.log.warn('Shader "'+e+'" not found');const i=t.split("\n");for(let e=0;e<i.length;++e)i[e]=e+1+": "+i[e];ut.log.warn(vD+e+" source:\n"+i.join("\n"))}af.numericIdIncrementer=0;class hf extends Ti.u1{constructor(e,t){super(e),this.POINT_NODE_PROPERTIES=new xi.hF({primitiveType:Di.MX.POINTS,isPickable:!1}),this.LINE_NODE_PROPERTIES=new xi.hF({primitiveType:Di.MX.LINES,isPickable:!1,addsToBounds:!1});const i=e.getSceneBounds().diameter(),s=X.default.getManager();if(t.point){const e=(0,Au.Pu)(t.point,void 0,s.getColor("RAY_COLOR"),s.getNumber("RAY_ORIGIN_WIDTH_PX"));this.updateMeshIncrement("point",Ti.ZJ,e,this.POINT_NODE_PROPERTIES)}const n=(0,Au.W5)(t.point,ge.S4.add(ge.S4.scale(t.direction,i,C.create()),t.point),void 0,s.getColor("RAY_COLOR"),s.getNumber("RAY_LINE_WIDTH_PX"));this.updateMeshIncrement("line",Ti.ZJ,n,this.LINE_NODE_PROPERTIES)}}const cf=new xi.hF({primitiveType:Di.MX.TRIANGLE_STRIP}),lf=new xi.hF({primitiveType:Di.MX.LINES});let uf=null,df=null;class gf extends Ti.u1{constructor(e,t,i){super(t),this.primitiveType=e;const s=de.create();switch(s[12]=32*i.random(),s[13]=18*i.random(),s[14]=18*i.random(),this.setTransform(s),uf||(uf=(0,Au.E3)(100,100),df=(0,Au.sp)(uf)),this.primitiveType){case Di.MX.TRIANGLE_STRIP:this.updateMeshIncrement("s","s",uf,cf);break;case Di.MX.LINES:this.updateMeshIncrement("s","s",df,lf)}}getPrimitiveCount(){switch(this.primitiveType){case Di.MX.TRIANGLE_STRIP:return uf.getTriangleCount();case Di.MX.LINES:return df.getLineCount()}return 0}}class pf{constructor(e,t){this.primitiveType=e,this.viewer=t,this.primitiveCount=0,this.spheres=[],this.randomNumberGenerator=new ue.H(0)}addPrimitivesToScene(){let e=0;for(;e<75e4;){const t=new gf(this.primitiveType,this.viewer,this.randomNumberGenerator);this.spheres.push(t),this.primitiveCount+=t.getPrimitiveCount(),e+=t.getPrimitiveCount()}}getPrimitiveCount(){return this.primitiveCount}remove(){for(let e=0;e<this.spheres.length;++e)this.spheres[e].remove();this.spheres=[]}}class mf{constructor(){this.trianglesPerSecond=0,this.trianglesPerSecondMeasurementHaltedEarly=!1,this.linesPerSecond=0,this.linesPerSecondMeasurementHaltedEarly=!1,this.executionTimeMs=0,this.refreshRate=0,this.testSkippedDueToLowRefreshRate=!0}getScore(){return Math.min(this.getModelSize()/ff.getModelSize(),1)}getModelSize(){return(5*this.linesPerSecond+this.trianglesPerSecond)/20}}const ff=new mf;ff.trianglesPerSecond=8e7,ff.linesPerSecond=6e7;const If=1500,Ef=3e3,Sf=45;class Tf{constructor(){this.deferred=null,this.startTime=null,this.lastFrameTime=null,this.fpsSamples=[]}refreshCallback(){const e=performance.now(),t=e-this.startTime;if(t>=Ef){let e=0;for(let t=0;t<this.fpsSamples.length;++t)e+=this.fpsSamples[t];const t=this.fpsSamples.length>0?e/this.fpsSamples.length:0;this.deferred.resolve(t)}else t>If&&null!==this.lastFrameTime&&this.fpsSamples.push(1e3/(e-this.lastFrameTime)),this.lastFrameTime=e,window.requestAnimationFrame((()=>this.refreshCallback()))}measureRefreshRate(){return this.deferred||(this.deferred=Ur.defer(),this.startTime=window.performance.now(),window.requestAnimationFrame((()=>this.refreshCallback()))),this.deferred.promise}}class Df{constructor(e){this.viewer=e,this.deferred=null,this.frameBuffer=null,this.blitPass=null,this.canvasViewport=y.fromValues(0,0,1,1),this.testViewport=y.fromValues(0,0,1,1),this.startTime=0,this.results=new mf,this.fastFrameThresholdMS=1e3/45}execute(){if(this.deferred)return this.deferred.promise;this.startTime=(0,Fs.Wj)(),this.canvasViewport=this.viewer.getCamera().getViewport(),this.testViewport=y.fromValues(0,0,1280,720),this.viewer.renderContext.pushViewport(this.canvasViewport),this.viewer.getCamera().setViewport(this.testViewport),this.viewer.renderContext.pushViewport(this.testViewport);const e=this.viewer.getGlContext();this.frameBuffer=this.viewer.getOrCreateFrameBuffer(e.UNSIGNED_BYTE,"",{storageType:e.DEPTH_STENCIL,attachmentType:e.DEPTH_STENCIL_ATTACHMENT}),this.frameBuffer.update(this.viewer.renderContext),this.viewer.renderContext.popViewport(),this.blitPass=new S(this.viewer,this.frameBuffer),this.deferred=Ur.defer();return(new Tf).measureRefreshRate().then((e=>{this.results.refreshRate=e,e<Sf?(this.results.testSkippedDueToLowRefreshRate=!0,this.resolve()):(this.results.testSkippedDueToLowRefreshRate=!1,this.measureTrianglesPerSecond())})),this.deferred.promise}resolve(){this.frameBuffer.destroy(),this.viewer.renderContext.popViewport(),this.results.executionTimeMs=(0,Fs.Es)(this.startTime),this.deferred.resolve(this.results)}measureFrameTime(e){const t=(0,dt.isBrowserSafari)()?20:5;let i=!1,s=0,n=0,r=0,a=0;const o={performFrameTiming:!1};this.viewer.getCamera().setViewport(this.testViewport),this.viewer.getPrimaryViewController().setStandardView("XZ"),this.viewer.zoomFit();let h=500;const c=l=>{const u=(0,Fs.Wj)(),d=this.viewer.getPrimaryViewController();if(d.rotateAbout(.0698131701,[0,0,1],d.camera.focalPoint()),r){a+=u-r,++s}i?r=u:(n=u,i=!0);const g=u-n;if(g>500&&2500!==h){a/s>=this.fastFrameThresholdMS&&(h=2500)}s>=t&&g>=h?e(a/s):(this.frameBuffer.bindBuffer(),this.viewer.getCamera().setViewport(this.testViewport),this.viewer.renderContext.pushViewport(this.testViewport),this.viewer.draw(l),this.viewer.renderContext.popViewport(),this.viewer.getCamera().setViewport(this.canvasViewport),this.frameBuffer.unbindBuffer(),this.blitPass.draw(this.viewer.renderContext),this.viewer.requestDraw(c,o,!0))};this.viewer.requestDraw(c,o,!0)}measureTrianglesPerSecond(){this.measurePrimitivesPerSecond(Di.MX.TRIANGLE_STRIP,ff.trianglesPerSecond,((e,t)=>{this.results.trianglesPerSecond=e,this.results.trianglesPerSecondMeasurementHaltedEarly=t,this.measureLinesPerSecond()}))}measureLinesPerSecond(){this.measurePrimitivesPerSecond(Di.MX.LINES,ff.linesPerSecond,((e,t)=>{this.results.linesPerSecond=e,this.results.linesPerSecondMeasurementHaltedEarly=t,this.resolve()}))}measurePrimitivesPerSecond(e,t,i){const s=new pf(e,this.viewer);s.addPrimitivesToScene();const n=10*t,r=e=>{const t=s.getPrimitiveCount()/e*1e3;e<this.fastFrameThresholdMS&&t<=n?(s.addPrimitivesToScene(),this.measureFrameTime(r)):(s.remove(),this.viewer.cleanUpOrphanedObjects(),i(t,t>n))};this.measureFrameTime(r)}}function Mf(e){return new Df(e).execute()}class Cf{constructor(){this.TOTAL_PROPERTY="total",this.BYTE_TO_MB=1/1048576,this.memoryUsage={}}reset(){this.memoryUsage={}}incrementMemoryUsage(e,t){if(e===this.TOTAL_PROPERTY)throw'Do not use "'+this.TOTAL_PROPERTY+'" as memory type.';this.memoryUsage.hasOwnProperty(e)?this.memoryUsage[e]+=t:this.memoryUsage[e]=t}decrementMemoryUsage(e,t){if(e===this.TOTAL_PROPERTY)throw'Do not use "'+this.TOTAL_PROPERTY+'" as memory type.';this.memoryUsage.hasOwnProperty(e)&&(this.memoryUsage[e]-=t)}addToStatistics(){const e=(0,yn.qn)();for(const t in this.memoryUsage)e.increment("MB "+t,this.memoryUsage[t]*this.BYTE_TO_MB)}getUsageDetails(){const e=(0,z.Z)(this.memoryUsage);let t=0;for(const e in this.memoryUsage)t+=this.memoryUsage[e];return e[this.TOTAL_PROPERTY]=t,e}}var yf=i(2246);const Pf=X.default.getManager();let Af=new Int32Array(0),Of=new Float32Array(0),vf=new Int32Array(0),Rf=0,wf=0;const _f=1024*Pf.getNumber("MAX_EDGE_BASED_SILHOUETTE_MEMORY_USE_MB")*1024;function Nf(){return wf>=_f}let bf=0,Lf=[];const Ff=function(e,t,i,s,n,r,a,o,h,c,l,u,d){const g=e.normals[3*l+0],p=e.normals[3*l+1],m=e.normals[3*l+2],f=e.normals[3*u+0],I=e.normals[3*u+1],E=e.normals[3*u+2],S=e.normals[3*d+0],T=e.normals[3*d+1],D=e.normals[3*d+2],M=(0,ar.crossProduct)(o-n,h-r,c-a,n-t,r-i,a-s);ge.S4.normalize(M);let y=g*M[0]+p*M[1]+m*M[2];y<0&&(ge.S4.negate(M),y*=-1);const P=f*M[0]+I*M[1]+E*M[2],A=S*M[0]+T*M[1]+D*M[2],O=Ci.W.FACE_NORMAL_IS_BAD;return(y<O||P<O||A<O)&&C.set(M,(g+f+S)/3,(p+I+T)/3,(m+E+D)/3),M},xf=function(e,t,i,s,n,r,a){let o;o=t<i?t+"__"+i:i+"__"+t;let h=a[o],c=0;void 0!==h?(c=Af[h],Af[h]=c+1):(h=Rf,a[o]=h,vf[2*h+0]=s,vf[2*h+1]=n,Af[h]=1,Rf++),c<2&&(Of[6*h+3*c+0]=r[0],Of[6*h+3*c+1]=r[1],Of[6*h+3*c+2]=r[2])},Bf=function(e,t,i,s,n){let r=ge.S4.subtract(t,e,n);ge.S4.normalize(r),r=ge.S4.cross(r,i,r);const a=Math.atan2(i[1],i[0]),o=ge.gv.length(i),h=Math.atan2(i[2],o),c=C.dot(i,s),l=C.dot(r,s),u=Math.atan2(l,c);C.set(n,a,h,u)},Vf=function(e,t){if(e.indices.length<3||e.indices.length>Pf.getNumber("MAX_SINGLE_SILHOUETTE_INCREMENT_SIZE"))return null;!function(e){Rf=0;const t=2*e;Af.length<t&&(Af=new Int32Array(t),Of=new Float32Array(6*t),vf=new Int32Array(2*t))}(e.indices.length);const i={},s=function(t,s,n){return function(t,i){return C.set(i,e.points[3*t+0],e.points[3*t+1],e.points[3*t+2])}(vf[2*i[t]+s],n)},n=function(e,t,s){const n=i[e];C.set(s,Of[6*n+3*t+0],Of[6*n+3*t+1],Of[6*n+3*t+2])};for(let t=2;t<e.indices.length;++t){const s=e.indices[t-2],n=e.indices[t-1],r=e.indices[t];if(!(s===n||n===r||s===r)){const t=e.points[3*s+0],a=e.points[3*s+1],o=e.points[3*s+2],h=(0,Au.nw)(t,a,o),c=e.points[3*n+0],l=e.points[3*n+1],u=e.points[3*n+2],d=(0,Au.nw)(c,l,u),g=e.points[3*r+0],p=e.points[3*r+1],m=e.points[3*r+2],f=(0,Au.nw)(g,p,m),I=Ff(e,t,a,o,c,l,u,g,p,m,s,n,r);xf(0,h,d,s,n,I,i),xf(0,d,f,n,r,I,i),xf(0,h,f,s,r,I,i)}}const r=function(e){return 2===Af[i[e]]},a=[];for(const e in i)r(e)&&a.push(e);const o=a.length;if(0===o)return null;const h=new Float32Array(6*o),c=new Int32Array(2*o),l=new Float32Array(6*o),u=C.create(),d=C.create(),g=C.create(),p=C.create(),m=C.create();for(let e=0;e<o;++e){const t=a[e];s(t,0,u),s(t,1,d),n(t,0,g),n(t,1,p),Bf(u,d,g,p,m),c[2*e]=2*e,c[2*e+1]=2*e+1;for(let t=0;t<3;++t)h[6*e+t]=u[t],h[6*e+3+t]=d[t],l[6*e+t]=m[t],l[6*e+3+t]=m[t]}const f=new vE(Di.MX.SILHOUETTES,h,c,t,!0);f.normals=l,f.prepareForBuffering();const I=!Nf();return wf+=e.getTriangleCount()*yf.a.SILHOUETTE_BYTES_PER_TRIANGLE,I&&Nf()&&ut.log.info("Edge-based silhouette memory use exhausted"),f};function Uf(e,t){return e.getFullId()+"_"+t}class Gf{constructor(e,t,i){this.parentIncrement=e,this.usage=t,this.callback=i,this.key=Uf(e,t),this.id=(bf++,bf);const s=this.parentIncrement.getBounds();this.bboxDiameter=s.diameter()}}class Hf{constructor(e,t){this.parentIncrementGuid=e,this.silhouetteIncrement=t}}const kf=function(e){for(let t=Lf.length-1;t>=0;--t)if(Lf[t].parentIncrementGuid===e)return Lf[t];return null},Wf=function(e){Lf.length>=100&&Lf.shift(),Lf.push(e)};function zf(e){return e+"_siledges"}function Xf(e){const t=e.getGloballyUniqueId(),i=kf(t);let s=null;if(i)s=i.silhouetteIncrement;else{const i=zf(e.id);s=Vf(e,i),s&&Wf(new Hf(t,s))}return s}class Zf{constructor(e){this.viewer=e,this.silhouetteIncrementToRequest={},this.silhouetteRequestQueue=[],this.silhouetteRequestQueueIsSorted=!1}process(e){if(this.hasPendingWork())for(this.silhouetteRequestQueueIsSorted||(this.silhouetteRequestQueue.sort((function(e,t){return t.bboxDiameter-e.bboxDiameter})),this.silhouetteRequestQueueIsSorted=!0);this.silhouetteRequestQueue.length>0;){if(Nf())return this.silhouetteRequestQueue=[],void(this.silhouetteIncrementToRequest={});const t=this.silhouetteRequestQueue.shift();if(this.silhouetteIncrementToRequest[t.key]!==t.id)continue;delete this.silhouetteIncrementToRequest[t.key];const i=Xf(t.parentIncrement);if(i&&(e&&e.addVertexCost(i.vertexCount()),t.callback(t.parentIncrement,i)),e&&e.budgetExceeded())break}}hasPendingWork(){return this.silhouetteRequestQueue.length>0}postSilhouetteRequest(e,t,i){if(!this.viewer.areEdgeSilhouettesEnabled())return;if(Nf())return;const s=new Gf(e,t,i);this.silhouetteRequestQueue.push(s),this.silhouetteRequestQueueIsSorted=!1,this.silhouetteIncrementToRequest[s.key]=s.id}clearPendingRequests(){this.silhouetteRequestQueue=[]}clearPendingRequestsForUsage(e){const t=[];for(let i=0;i<this.silhouetteRequestQueue.length;++i){const s=this.silhouetteRequestQueue[i];s.usage!==e&&t.push(s)}this.silhouetteRequestQueue=t,this.silhouetteRequestQueue=this.silhouetteRequestQueue.filter((function(t){return t.usage!==e}))}removePendingRequest(e,t){delete this.silhouetteIncrementToRequest[Uf(e,t)]}}function qf(){Lf=[]}class Yf{constructor(e,t){this.viewer=e,this.sceneGraphs=t,this.nodes={},this.meshManager=new AS(this.viewer,{bufferAllocationPolicy:$f.MEDIUM}),this.onSessionEnded=()=>{this.meshManager.destroy(),this.viewer.getEventDispatcher().off(yD.so,this.onSessionEnded)},this.viewer.getEventDispatcher().on(yD.so,this.onSessionEnded)}getMeshManager(){return this.meshManager}getNode(e){if(!this.nodes[e]){const t=new xi.NB("uinode");this.nodes[e]=t,this.sceneGraphs.getSceneGraph(e).getRootNode().addChild(t)}return this.nodes[e]}destroyPreviewGraphics(){delete this.nodes[Zo.Vv]}clean(){this.meshManager.removeEmptyMeshes();for(const e in this.nodes)this.nodes[e].cleanEmptyMeshNodes()}}const Kf=new Ni({diffuseFactor:.5,ambientFactor:.5});function jf(){return{0:new xi.hF({isPickable:!1,zOffset:3,isShowThrough:!0,primitiveType:Di.MX.POINTS}),1:new xi.hF({isPickable:!1,zOffset:4,isShowThrough:!0,primitiveType:Di.MX.LINES,priority:xi.DO.HIGHEST}),4:new xi.hF({isPickable:!1,isTwoSided:!0,zOffset:5,primitiveType:Di.MX.TRIANGLE_STRIP,material:Kf,primitivesHaveTransparency:!0})}}class Qf extends Ti.u1{constructor(e,t){super(t),this.sheetMetalModelId=null,this.incrementIdToHightlight={};X.default.getManager();e.forEach(((e,t)=>{let i=null;if(e instanceof k.TT0&&(i=e,this.sheetMetalModelId=i.sheetMetalModelId,i.deterministicId&&i.style===k.$76.ERROR)){const e=(0,Ce.cF)(i.deterministicId);if(e)return void(0,Ce.yb)().add(e)}const s=fI(e);if(s){if(!s.colors){const e=pI(k.FVx.FEATURE_ERROR,s.primitiveType);(0,Au.Ab)(e,s)}s.primitiveType===Di.MX.POINTS?s.primitiveSizes||(0,Au.VQ)(7,s):s.primitiveType===Di.MX.LINES&&(0,Au.VQ)(2.5,s);const e=jf(),n="id"+t;if(this.updateMeshIncrement(n,Ti.ZJ,s,e[s.primitiveType]),i&&i.style===k.$76.ERROR){const e=this.addNewHighlightToIncrement(n,dn.o2.ERROR);this.incrementIdToHightlight[n]=e,this.hideIncrement(n)}this.viewer.getIsolatedOccurrenceManager()?.addIdsToIsolate([this.graphicsOccurrenceId])}}),this)}show(){super.show();for(const e in this.incrementIdToHightlight){const t=this.addNewHighlightToIncrement(e,dn.o2.ERROR);this.incrementIdToHightlight[e]=t,this.hideIncrement(e)}}hide(){super.hide();for(const e in this.incrementIdToHightlight)this.removeHighlightFromIncrement(e,this.incrementIdToHightlight[e]);this.freeAllocatedHighlights()}remove(){(0,Ce.yb)().reset(),this.viewer.getIsolatedOccurrenceManager()?.removeFromIsolate([this.graphicsOccurrenceId]),super.remove()}}var $f,Jf=i(23056),eI=i(64733),tI=i(98609);class iI extends Ti.u1{constructor(e,t){super(t,Zo.lL),this.idToSilhouetteInfo={},this.sketchProperties=new xi.hF({isPickable:!0,isShowThrough:!0,isDepthTested:!1,primitiveType:Di.MX.LINES,zOffset:1}),this.worldProperties=new xi.hF({isPickable:!0,isShowThrough:!0,isDepthTested:!0,primitiveType:Di.MX.LINES,zOffset:1});const i=X.default.getManager();let s;for(this.width=i.getNumber("SKETCH_SILHOUETTE_WIDTH"),this.sketchColor=i.getColor("SKETCH_PREVIEW_COLOR"),this.worldColor=i.getColor("SKETCH_SILHOUETTE_WORLD_COLOR"),this.hoverWidth=i.getNumber("HIGHLIGHT_LINE_WIDTH_MIN"),this.hoverColor=i.getColor("PRE_HIGHLIGHT_COLOR_BORDER"),this.worldStipple=i.getStipple("SKETCH_SILHOUETTE_WORLD_STIPPLE"),s=0;s<e.length;++s){const t=e[s].silhouetteId;this.idToSilhouetteInfo[t]=e[s],this.updateSilhouette(t,!1),this.listenTo(this,Ti.zw.MOUSE_ENTER+t,this.onMouseEnter),this.listenTo(this,Ti.zw.MOUSE_LEAVE+t,this.onMouseLeave),this.listenTo(this,Ti.zw.CLICK+t,this.onMouseClick)}}updateAllSilhouettes(){Object.entries(this.idToSilhouetteInfo).forEach((([e,t])=>{this.updateSilhouette(e,!1)}))}updateSilhouette(e,t){const i=this.idToSilhouetteInfo[e];if(!i)return;(0,Au.Ab)(t?this.hoverColor:this.worldColor,i.worldMesh),(0,Au.VQ)(t?this.hoverWidth:this.width,i.worldMesh),(0,Au.KZ)(this.worldStipple,i.worldMesh),this.updateMeshIncrement(e,e,i.worldMesh,this.worldProperties);const s=this.getProjectedMeshId(e),n=Za(this.viewer,i.sketchPolyline);(0,Au.Ab)(t?this.hoverColor:this.sketchColor,n),(0,Au.VQ)(t?this.hoverWidth:this.width,n),this.updateMeshIncrement(s,e,n,this.sketchProperties)}getProjectedMeshId(e){return e+".ske"}getClearModelSelectionsOnPrehilite(){return!1}onMouseEnter(e){this.updateSilhouette(e.selectionId,!0),(0,Fs.vm)()}onMouseLeave(e){this.updateSilhouette(e.selectionId,!1),(0,Fs.vm)()}onMouseClick(e){const t=this.idToSilhouetteInfo[e.selectionId];t&&this.trigger(tI.AW,this,t.disambiguation,e.selectionId)}removeOtherSilhouettes(e){for(const t in this.idToSilhouetteInfo)t!==e&&(this.removeMeshIncrement(t),this.removeMeshIncrement(this.getProjectedMeshId(t)),delete this.idToSilhouetteInfo[t]);this.stopListening(),this.updateSilhouette(e,!1),(0,Fs.vm)()}}!function(e){e[e.MINIMUM=0]="MINIMUM",e[e.MEDIUM=1]="MEDIUM",e[e.MAXIMUM=2]="MAXIMUM"}($f||($f={}));const sI=(0,yn.qn)();class nI extends m.T{constructor(e,t){super(),this.viewer=e,this.bufferSets=[],this.buffersNeedCompilation=!1,this.vertexSize=0,(0,Jo.Yk)(e),this.bufferAllocationPolicy=t&&void 0!==t.bufferAllocationPolicy?t.bufferAllocationPolicy:$f.MINIMUM,this.id=t?t.id:void 0,this.primitiveType=Di.MX.PRIMITIVE_UNKNOWN,this.incrementToBufferSetIndex=new gl.TemplatedCountedMap,this.listenTo(this.viewer.getEventDispatcher(),yD.pO,this.onGlContextRestored),this.listenTo(this.viewer.getEventDispatcher(),yD.so,this.onGlContextDestroyed)}destroy(){let e;for(e=0;e<this.bufferSets.length;++e)this.bufferSets[e].destroy();this.incrementToBufferSetIndex.clear(),this.stopListening()}getBufferSetWithIndex(e){return this.bufferSets[e]}getId(){return this.id}onGlContextRestored(e){for(let e=0;e<this.bufferSets.length;++e)this.bufferSets[e].reinitialize()}onGlContextDestroyed(){this.destroy()}getPrimitiveType(){return this.primitiveType}setPrimitiveType(e){this.primitiveType=e}getBuffersNeedCompilation(){return this.buffersNeedCompilation}setBuffersNeedCompilation(){this.buffersNeedCompilation=!0}onPermanentlyRemoved(){this.destroy()}incrementStatisticsForCall(e,t){switch(sI.increment(yn.kW.DRAW_CALLS,t),this.primitiveType){case Di.MX.LINES:sI.increment(yn.kW.LINES,Math.floor(e/6));break;case Di.MX.POINTS:sI.increment(yn.kW.POINTS,Math.floor(e/6));break;case Di.MX.TRIANGLES:sI.increment(yn.kW.TRIANGLES,Math.floor(e/3));break;case Di.MX.TRIANGLE_STRIP:sI.increment(yn.kW.TRIANGLES,e-2)}}getPrimitiveMode(){const e=this.viewer.getGlContext();switch(this.primitiveType){case Di.MX.POINTS:case Di.MX.INFINITE_LINES:case Di.MX.TRIANGLES:case Di.MX.SILHOUETTES:return e.TRIANGLES;case Di.MX.TRIANGLE_STRIP:return e.TRIANGLE_STRIP;case Di.MX.LINES:return this.viewer.areOptimizedBuffersEnabled?e.LINES:e.TRIANGLES;default:ut.log.warn("Unknown mesh primitive type: "+this.primitiveType)}return 0}getAlternatePrimitiveMode(){const e=this.viewer.getGlContext();switch(this.primitiveType){case Di.MX.LINES:return e.POINTS;case Di.MX.TRIANGLE_STRIP:return e.LINE_STRIP}return 0}getBufferSetIndexForIncrement(e){return this.incrementToBufferSetIndex.has(e)?this.incrementToBufferSetIndex.get(e):-1}addBufferSet(e){this.bufferSets.push(e),e.setParentMesh(this)}removeBufferSet(e){const t=this.bufferSets.indexOf(e);t>-1&&this.bufferSets.splice(t,1)}addIncrement(e){if(!e.getFullId())return ut.log.warn("An attempt was made to add a increment without a valid id"),null;if(!this.updateMeshPropertiesFromIncrement(e))return null;let t=null,i=-1;const s=this.getBufferSetIndexForIncrement(e.getFullId());let n=null;if(s>=0&&!this.bufferSets[s].hasOptimizedBuffers()&&(n=this.bufferSets[s],n.deleteIncrement(e.getFullId())),!e.isPrecompiledBuffer)for(let s=0;s<this.bufferSets.length;++s){if(this.bufferSets[s].hasOptimizedBuffers())continue;if(t=this.bufferSets[s].incorporateIncrement(e),t){i=s;break}}if(e.isPrecompiledBuffer&&s>=0)t=n.incorporateIncrement(e);else{if(i<0){const s=new fS(this,e.isPrecompiledBuffer);t=s.incorporateIncrement(e),t?(i=this.bufferSets.length,this.bufferSets.push(s)):ut.log.warn("A new buffer set failed to incorporate a single mesh increment")}i>=0&&this.incrementToBufferSetIndex.insert(e.getFullId(),i),this.setBuffersNeedCompilation()}return t}updateMeshPropertiesFromIncrement(e){if(this.primitiveType===Di.MX.PRIMITIVE_UNKNOWN)this.primitiveType=e.primitiveType;else if(this.primitiveType!==e.primitiveType)return ut.log.warn("Tried to add two different increment types to the same mesh."),!1;const t=e.getVertexSize();if(this.vertexSize){if(this.vertexSize!==t)return ut.log.warn("Encountered primitives with different sized vertices in the same mesh"),!1}else this.vertexSize=t;return!0}getIncrementDetails(e){const t=this.getBufferSetIndexForIncrement(e);if(t<0||this.bufferSets[t].hasOptimizedBuffers())return null;return this.bufferSets[t].getIncrementDetails(e)}deleteIncrement(e){const t=this.getBufferSetIndexForIncrement(e);let i=null;if(t<0||this.bufferSets[t].hasOptimizedBuffers())return null;return i=this.bufferSets[t].deleteIncrement(e),this.incrementToBufferSetIndex.remove(e),this.setBuffersNeedCompilation(),i}updateIncrementAttribute(e,t,i){const s=this.getBufferSetIndexForIncrement(t);if(s<0||this.bufferSets[s].hasOptimizedBuffers())return;this.bufferSets[s].updateIncrementAttribute(e,t,i),this.setBuffersNeedCompilation()}extractMeshIncrement(e){const t=this.getBufferSetIndexForIncrement(e);if(t<0||this.bufferSets[t].hasOptimizedBuffers())return null;return this.bufferSets[t].getIncrement(e)}compileBuffers(e){if(!this.buffersNeedCompilation)return;const t=new Qo.B7("Mesh.compileBuffers");this.buffersNeedCompilation=!1;let i=!1;for(let e=0;e<this.bufferSets.length;++e){if(this.bufferSets[e].hasOptimizedBuffers())continue;const t=this.bufferSets[e];i=t.updateBuffers()||i,this.buffersNeedCompilation=this.buffersNeedCompilation||t.hasBufferUpdates()}e&&i&&e.setLastBufferBound(null),t.report()}copyOptimizedBuffersToGl(e){let t=!1;for(let e=0;e<this.bufferSets.length;++e)this.bufferSets[e].hasOptimizedBuffers()&&(t=this.bufferSets[e].copyBuffersToGl()||t);e&&t&&e.setLastBufferBound(null)}isEmpty(){return this.incrementToBufferSetIndex.isEmpty()}}const rI="element.",aI="elementpreview.",oI="temporary_sketch_component.",hI="partStudio.",cI="assembly.",lI="occurrence",uI="",dI={bufferAllocationPolicy:$f.MAXIMUM};function gI(e,t,i){const s=e.getMeshIncrement(),n=s?s.clone():fI(e);return n&&(t&&(n.id=t),n.pickId=i),n}function pI(e,t){let i="";switch(e){case k.FVx.RED:i="CPP_RED";break;case k.FVx.GREEN:i="CPP_GREEN";break;case k.FVx.BLUE:i="CPP_BLUE";break;case k.FVx.CYAN:i="CPP_CYAN";break;case k.FVx.YELLOW:i="CPP_YELLOW";break;case k.FVx.MAGENTA:i="CPP_MAGENTA";break;case k.FVx.BLACK:i="CPP_BLACK";break;case k.FVx.TRANSLUCENT_PURPLE:i="CPP_TRANSLUCENT_PURPLE";break;case k.FVx.FEATURE_ERROR:case k.FVx.FEATURE_DEBUG:i="FEATURE_ERROR_GRAPHIC_COLOR";break;case k.FVx.TRANSLUCENT_GREEN:i="CPP_TRANSLUCENT_GREEN";break;case k.FVx.TRANSLUCENT_BLUE:i="CPP_TRANSLUCENT_BLUE";break;case k.FVx.TRANSLUCENT_CYAN:i="CPP_TRANSLUCENT_CYAN";break;case k.FVx.TRANSLUCENT_YELLOW:i="CPP_TRANSLUCENT_YELLOW";break;case k.FVx.TRANSLUCENT_BLACK:i="CPP_TRANSLUCENT_BLACK";break;case k.FVx.TRANSLUCENT_ORANGE:i="CPP_TRANSLUCENT_ORANGE";break;case k.FVx.ORANGE:i="CPP_ORANGE";break;default:i="CPP_RED"}const s=X.default.getManager().getColor(i);return e!==k.FVx.FEATURE_ERROR||t!==Di.MX.POINTS&&t!==Di.MX.LINES?s:[s[0],s[1],s[2],1]}const mI=function(e){let t=null;if(e&&e.length>1){const i=new Float32Array(e.buffer,0,6),s=new Uint16Array(e.buffer,24);t=new Float32Array(s.length);const n=(i[3]-i[0])/65535,r=(i[4]-i[1])/65535,a=(i[5]-i[2])/65535,o=i[0],h=i[1],c=i[2];for(let e=0;e<s.length;e+=3)t[e+0]=o+n*s[e+0],t[e+1]=h+r*s[e+1],t[e+2]=c+a*s[e+2]}return t};function fI(e){let t=null;switch(e.getMessageName()){case"display.GBTEntityFace":const i=e;if(i.decompress(),!i.points||!i.indices||!i.normals)return null;t=new vE(Di.MX.TRIANGLE_STRIP,i.points,i.indices),t.normals=i.normals;break;case"display.GBTEntityEdge":const s=e;if((!s.points||s.points.length<6)&&(!s.compressedPoints||s.compressedPoints.length<6))return null;s.compressedPoints&&s.compressedPoints.length>1&&(s.points=mI(s.compressedPoints),s.compressedPoints=new Uint8Array(0));const n=Math.floor(s.points.length/3)-1,r=new Int32Array(2*n);for(let e=0;e<n;++e)r[2*e]=e,r[2*e+1]=e+1;t=new vE(Di.MX.LINES,s.points,r,void 0,!0);break;case"display.GBTEntityPoint":case"display.GBTEntityDegenerateEdge":const a=e;if(!a.point)return null;t=new vE(Di.MX.POINTS,a.point,[0],void 0,!0);break;case"display.GBTFeatureEntity":case"display.GBTConstructionPlaneEntity":case"display.GBTBodyEntity":case"display.GBTPointEntity":case"display.GBTOriginEntity":case"display.GBTMateConnectorEntity":case"display.GBTSketchEntity":const o=e;t=o.getGeometry()?fI(o.getGeometry()):null;break;case"display.GBTDebugGeometry":const h=e;if(!h.tessellation)return null;if(t=fI(h.tessellation),h.style!==k.$76.ERROR){const e=pI(h.color,t.primitiveType);(0,Au.Ab)(e,t),t.primitiveType===Di.MX.POINTS&&(h.style===k.$76.STAR?((0,Au.KZ)(X.default.getManager().getPointFont("STAR_POINT"),t),(0,Au.VQ)(X.default.getManager().getNumber("STAR_POINT_SIZE"),t)):(0,Au.VQ)(X.default.getManager().getNumber("DEBUG_POINT_SIZE"),t))}}return t}function II(e){switch(e.getEntityType()){case k.ZSW.VERTEX:return Di.MX.POINTS;case k.ZSW.EDGE:return Di.MX.LINES;case k.ZSW.FACE:return Di.MX.TRIANGLE_STRIP;case k.ZSW.DEGENERATE_EDGE:return Di.MX.POINTS}return Di.MX.PRIMITIVE_UNKNOWN}function EI(e,t,i){if(!e)return[];let s;return i?(s=[],e.each((function(e,n){return i(t[n])&&s.push(n),!1}))):s=e.getKeys(),s}function SI(e){return!!e&&-1!==e.indexOf(".")}const TI={mouseup:"mouseup"};class DI{constructor(e,t){this.element=e,this.firstMiddleMouseButtonUp=!1,this.timeOfFirstMiddleMouseUp=-1,this.elementDoubleClickHandler=t,this.mouseUpHandler=e=>this.MouseUpHandler(e),this.setupEventHandlers()}setupEventHandlers(){this.element&&this.element.on(TI.mouseup,this.mouseUpHandler)}off(){this.element&&this.element.off(TI.mouseup,this.mouseUpHandler)}resetFirstMiddleButtonUpState(){this.firstMiddleMouseButtonUp=!1,this.timeOfFirstMiddleMouseUp=-1}setFirstMiddleButtonUpState(){this.firstMiddleMouseButtonUp=!0,this.timeOfFirstMiddleMouseUp=(0,Fs.Wj)()}MouseUpHandler(e){if(e.which!==Hn.tc.MIDDLE)return void this.resetFirstMiddleButtonUpState();if(!this.firstMiddleMouseButtonUp)return void this.setFirstMiddleButtonUpState();if((0,Fs.Es)(this.timeOfFirstMiddleMouseUp)<=X.default.getManager().getNumber("MIDDLE_MOUSE_BUTTON_DOUBLE_CLICK_TIMEOUT"))return this.resetFirstMiddleButtonUpState(),void this.elementDoubleClickHandler(e);this.setFirstMiddleButtonUpState()}}var MI=i(55718);function CI(e,t,i,s,n){let r,a=t;for(;t!==i;)if(a=Math.floor(.5*(t+i)),r=e[a][s],n>r)a=t=a+1;else{if(!(n<r))break;i=a}return a}function yI(e,t){if(t.length<1)t.push(e.slice(0));else{const i=CI(t,0,t.length,0,e[0]);let s=!1,n=0,r=e[1];i>0&&t[i-1][1]>=e[0]&&(s=!0,r=Math.max(r,t[i-1][1]));for(let s=i;s<t.length&&t[s][0]<=e[1];++s)++n,r=Math.max(r,t[s][1]);s?(t[i-1][1]=r,t.splice(i,n)):t.splice(i,n,[e[0],r])}}const PI=[0,1];function AI(e,t,i){PI[0]=e,PI[1]=t,yI(PI,i)}function OI(e,t){if(e[0]===e[1])return;const i=CI(t,0,t.length,1,e[0]),s=CI(t,i,t.length,0,e[1]);if(i>=t.length||i===s)return void ut.log.warn("Failed to find range to remove");let n=null,r=null;t[i][0]<e[0]&&(n=[t[i][0],e[0]]),t[s-1][1]>e[1]&&(r=[e[1],t[s-1][1]]),n&&r?t.splice(i,s-i,n,r):n?t.splice(i,s-i,n):r?t.splice(i,s-i,r):t.splice(i,s-i)}function vI(e,t){let i=0;for(let s=0;s<t.length;++s){const n=t[s],r=n[0]-i,a=n[1]-n[0];e.splice(r,a),i+=a}}const RI=X.default.getManager(),wI="uViewport",_I="uBlitTextureOffset",NI=-1,bI=[0,0],LI=[1,1];let FI=!1;class xI extends m.T{constructor(e){super(),this.viewer=e,this.MAXIMUM_Z_OFFSET=RI.getNumber("MAXIMUM_Z_OFFSET"),this.activeShader=null,this.shaderStack=[],this.modelViewMatrixStack=[],this.projectionMatrixStack=[],this.viewport=[0,0,1,1],this.viewportStack=[],this.materialPushedShaderStack=[!1],this.activePass=null,this.lastPolygonOffsetFactor=NaN,this.lastPolygonOffsetUnits=NaN,this.overridePolygonOffset=!1,this.lastCullFace=null,this.pickBackFaces=!1,this.pickPrimitiveAlternates=!1,this.baseHighlightsEnabled=!0,this.activeCamera=null,this.isPickingHiddenOccurrences=!1,this.useHiddenOpacityForEdgeHighlights=!1,this.frameId=0,this.lastBufferBound=null,this.lastStyleApplied=new XI.bg,this.hasIsolate=!1,this.nodeOccurrenceFilterFunction=null,this.isWebXrEnabled=!1,(0,Jo.Yk)(e),this.state=new hi,this.modelViewMatrix=de.create(),this.projectionMatrix=de.create(),this.materialStack=[Li],this.overrideFaceCullingMode=uh.UNSPECIFIED,this.renderingMode=k.P1.SHADED_WITH_EDGES,this.detailSettings=new $r,this.listenTo(this.viewer.getEventDispatcher(),yD.cW,this.onGlContextLost),this.listenTo(this.viewer.getEventDispatcher(),yD.b3,this.onDevicePixelRatioChanged),Ki.Jq.CapabilitiesService.isWebxrEnabled().then((e=>{this.isWebXrEnabled=e}))}onNewContext(e){this.state.setGlContext(e),this.setFacesToCull(uh.BACK)}onDevicePixelRatioChanged(e){if(this.activeShader){const e=(0,Ji.x_)();this.activeShader.uniform1f("uDevicePixelRatio",e)}}destroy(){this.stopListening()}onGlContextLost(){this.activeShader=null}setOccurrencePickId(e){this.activeShader&&this.activeShader.uniform4fv("uOccurrencePickId",e)}getViewer(){return this.viewer}setActiveCamera(e){this.activeCamera=e}getActiveCamera(){return this.activeCamera}getState(){return this.state}pushModelViewMatrix(e){this.modelViewMatrixStack.push(this.modelViewMatrix),this.modelViewMatrix=e}getModelViewMatrix(){return this.modelViewMatrix}popModelViewMatrix(){0!==this.modelViewMatrixStack.length?this.modelViewMatrix=this.modelViewMatrixStack.pop():ut.log.warn("Tried to pop modelview matrix from stack with zero length")}updateModelviewUniforms(){const e=this.activeShader;e&&(e.uniformMatrix4fv("uMVMatrix",!1,this.modelViewMatrix),e.uniformMatrix4fv("uMVMatrix_fs",!1,this.modelViewMatrix))}pushProjectionMatrix(e){this.projectionMatrixStack.push(this.projectionMatrix),this.projectionMatrix=e,this.updateProjectionUniforms()}updateProjectionUniforms(){this.activeShader&&(this.activeShader.uniformMatrix4fv("uPMatrix",!1,this.projectionMatrix),this.activeShader.uniformMatrix4fv("uPMatrix_fs",!1,this.projectionMatrix))}getProjectionMatrix(){return this.projectionMatrix}popProjectionMatrix(){0!==this.projectionMatrixStack.length?(this.projectionMatrix=this.projectionMatrixStack.pop(),this.updateProjectionUniforms()):ut.log.warn("Tried to pop projection matrix from stack with zero length")}updateViewportUniforms(){const e=this.getActiveShader();if(e&&e.getUniformLocation(wI)&&e.uniform4fv(wI,this.viewport),e&&e.getUniformLocation(_I)){let t=bI,i=LI;this.isWebXrEnabled&&!this.isCustomViewportActive&&(t=Q.fromValues(this.viewport[0]/this.viewer.getBaseFrameBufferWidth(),this.viewport[1]/this.viewer.getBaseFrameBufferHeight()),i=Q.fromValues(this.viewport[2]/this.viewer.getBaseFrameBufferWidth(),this.viewport[3]/this.viewer.getBaseFrameBufferHeight())),e.uniform2fv(_I,t),e.uniform2fv("uBlitTextureScale",i)}}setViewport(e){this.viewport=e,this.viewer.getGlContext().viewport(e[0],e[1],e[2],e[3]),this.updateViewportUniforms()}pushViewport(e){this.viewportStack.push(this.viewport),this.setViewport(e)}getViewport(){return this.viewport}popViewport(){if(0===this.viewportStack.length)return void ut.log.warn("Tried to pop viewport from stack with zero length");const e=this.viewportStack.pop();this.setViewport(e)}get isCustomViewportActive(){return this.viewportStack.length>1}activateShader(e,t){if((null===this.activeShader||!this.activeShader.equals(e))&&(this.activeShader&&this.activeShader.deactivate(),this.lastBufferBound=null,this.defaultStyle=null,this.lastStyleApplied.clear(),this.activeShader=e,t||(this.shaderStack=[this.activeShader]),null!==this.activeShader)){this.lastNormalMatrixComputed=null,this.activeShader.useShader(),this.updateProjectionUniforms(),this.updateModelviewUniforms(),this.updateViewportUniforms();const e=[0,0,0,0],t=[0,0,0,-1],i=[0,0,0,0];this.activeShader.vertexAttrib4fv(tE.COLOR,t),this.activeShader.vertexAttrib4fv(tE.HIGHLIGHT_ID,e),this.activeShader.vertexAttrib4fv(tE.PRIMITIVE_STYLE,i),this.activeShader.vertexAttrib1f(tE.OCCURRENCE_ID,0),this.activeShader.uniform2fv("uHighlightPointFont",RI.getPointFont("HIGHLIGHT_POINT_FONT")),this.activeShader.uniform1f("uHighlightPointSizeMin",RI.getNumber("HIGHLIGHT_POINT_SIZE_MIN_PX")),this.activeShader.uniform1f("uHighlightPointSizeScale",RI.getNumber("HIGHLIGHT_POINT_SIZE_SCALE")),this.activeShader.uniform4fv("uHighlightLineStipple",RI.getStipple("HIGHLIGHT_LINE_STIPPLE")),this.activeShader.uniform1f("uHighlightLineWidthMin",RI.getNumber("HIGHLIGHT_LINE_WIDTH_MIN_PX")),this.activeShader.uniform1f("uHighlightLineWidthScale",RI.getNumber("HIGHLIGHT_LINE_WIDTH_SCALE")),this.activeShader.uniform1f("uHighlightCount",this.viewer.getReferenceHighlights().sortedHighlights.length),this.activeShader.uniform4fv("uBackgroundColor",RI.getColor("BACKGROUND_COLOR"));const s=(0,Ji.x_)();this.activeShader.uniform1f("uDevicePixelRatio",s),this.activePass?.onShaderActivated(this,this.activeShader)}}getActiveShader(){return this.activeShader}pushShader(e){this.shaderStack.push(e)}activateTopShader(){this.shaderStack.length>0&&this.activateShader(this.shaderStack[this.shaderStack.length-1],!0)}popShader(){0!==this.shaderStack.length?this.shaderStack.pop():ut.log.warn("Tried to pop a shader off of an empty stack")}getExtendedShaderForMaterial(e){const t=e.getExtendedShaderId();if(!t)return null;const i=sf((this.shaderStack.length>0?this.shaderStack[this.shaderStack.length-1]:this.activeShader).getId(),t);return rf(i)?this.viewer.getShader(i):null}pushMaterial(e){this.materialStack.push(e);const t=this.getExtendedShaderForMaterial(e);t&&this.pushShader(t),this.materialPushedShaderStack.push(!!t)}setMaterial(){this.activeShader&&this.materialStack&&this.materialStack.length>0&&this.materialStack[this.materialStack.length-1].setAttributes(this.activeShader,this)}popMaterial(){if(0===this.materialStack.length)return void ut.log.warn("Tried to pop a material off of an empty stack");this.materialStack.pop();this.materialPushedShaderStack.pop()&&this.popShader()}setActivePass(e){this.activePass=e}getActivePass(){return this.activePass}setIsPickingHiddenOccurrences(e){this.isPickingHiddenOccurrences=e}getIsPickingHiddenOccurrences(){return this.isPickingHiddenOccurrences}isPicking(){return!!this.activePass&&this.activePass.isPickPass()}isHighlighting(){return!!this.activePass&&this.activePass.isHighlightPass()}getActiveHighlightType(){return this.activePass?this.activePass.getActiveHighlightType():null}needsAttribute(e){return!!this.activePass&&this.activePass.needsAttribute(e)}getPickPassIteration(){return this.activePass&&this.activePass.isPickPass()?this.activePass.getPickIteration():-1}isShowthrough(){return!!this.activePass&&this.activePass.isShowthroughPass()}setBackFacePicking(e){this.pickBackFaces=e}isPickingBackFaces(){return this.isPicking()&&this.pickBackFaces}setOverrideFaceCullingMode(e){this.overrideFaceCullingMode=e}clearOverrideFaceCullingMode(){this.overrideFaceCullingMode=uh.UNSPECIFIED}nodeFilter(e){return!0}setZOffset(e){const t=e/this.MAXIMUM_Z_OFFSET;this.setPolygonOffset(t,e)}setOverridePolygonOffset(e,t){this.overridePolygonOffset=!1,this.setPolygonOffset(e,t),this.overridePolygonOffset=!0}clearOverridePolygonOffset(){this.overridePolygonOffset=!1}setPolygonOffset(e,t){if(this.overridePolygonOffset||e===this.lastPolygonOffsetFactor&&t===this.lastPolygonOffsetUnits)return;const i=this.viewer.getGlContext();0===e&&0===t?i.disable(i.POLYGON_OFFSET_FILL):(i.polygonOffset(e,t),i.enable(i.POLYGON_OFFSET_FILL)),this.lastPolygonOffsetFactor=e,this.lastPolygonOffsetUnits=t}setFacesToCull(e){if(this.lastCullFace===e)return;let t=e;this.overrideFaceCullingMode!==uh.UNSPECIFIED&&(t=this.overrideFaceCullingMode);const i=this.viewer.getGlContext();uh.BACK===t?(i.enable(i.CULL_FACE),i.cullFace(i.BACK)):uh.FRONT===t?(i.enable(i.CULL_FACE),i.cullFace(i.FRONT)):uh.NONE===t?i.disable(i.CULL_FACE):ut.log.error("Unknown face culling parameter: "+t)}setPointSize(e){this.setPrimitiveSize(e)}setPointFont(e){this.setPrimitiveStyle([e[0],e[1],0,0])}setLineWidth(e){this.setPrimitiveSize(e)}setLineStipple(e){this.setPrimitiveStyle(e)}setPrimitiveSize(e){const t=this.getActiveShader();t&&t.vertexAttrib1f(tE.PRIMITIVE_SIZE,e)}setPrimitiveStyle(e){const t=this.getActiveShader();t&&t.vertexAttrib4fv(tE.PRIMITIVE_STYLE,e)}setPickPrimitiveAlternates(e){this.pickPrimitiveAlternates=e}getPickPrimitiveAlternates(){return this.pickPrimitiveAlternates}setBaseHighlightsEnabled(e){this.baseHighlightsEnabled=e}getBaseHighlightsEnabled(){return this.baseHighlightsEnabled}setUseHiddenOpacityForEdgeHighlights(e){this.useHiddenOpacityForEdgeHighlights=e}getUseHiddenOpacityForEdgeHighlights(){return this.useHiddenOpacityForEdgeHighlights}prepareForNextFrame(){this.frameId<yi.s9?this.frameId+=1:this.frameId=0,this.hasIsolate=this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances(),!FI&&this.materialStack.length>5&&(ut.log.warn("Material stack has grown unexpectedly long"),FI=!0)}getFrameId(){return this.frameId}getHasIsolate(){return this.hasIsolate}setRenderingMode(e){this.renderingMode=e}setDetailSettings(e){this.detailSettings=e}getDetailSettings(){return this.detailSettings}setUsage(e){this.usage=e}getUsage(){return this.usage}getLastBufferBound(){return this.lastBufferBound}setLastBufferBound(e){this.lastBufferBound=e}applyStyle(e){e&&!(0,XI.d8)(e,this.lastStyleApplied)&&e.applyStyle(this),e?this.lastStyleApplied.copyFrom(e):this.lastStyleApplied.clear()}activePassNeedsIsolationTest(){return!!this.activePass&&this.activePass.testIsolation(this)}activePassIsForIsolate(){return!!this.activePass&&this.activePass.forIsolate()}activePassIsForSectionPlaneEndcapMask(){return!!this.activePass&&this.activePass.forSectionPlaneEndcapMask()}setNodeOccurrenceFilterFunction(e){this.nodeOccurrenceFilterFunction=e}doesNodeOcccurrencePassFilter(e){return!this.nodeOccurrenceFilterFunction||this.nodeOccurrenceFilterFunction(e)}activePassNeedsFaceAppearances(){return!this.activePass||this.activePass.needsFaceAppearances()}}var BI=i(51937);class VI{constructor(){this.mouseKeyFlags={},this.mouseKeyManipulationModeBinding={},this.hasShiftKeyBinding=!1,this.hasControlKeyBinding=!1,this.hasAltKeyBinding=!1,this.mouseKeyFlags[Hn.tc.MIDDLE]=1,this.mouseKeyFlags[Hn.tc.RIGHT]=2,this.mouseKeyFlags[cs.R8.SHIFT]=4,this.mouseKeyFlags[cs.R8.CONTROL]=8,this.mouseKeyFlags[cs.R8.ALT]=16}getMouseKeyCombinationID(e,t){let i=0,s=0;for(s=0;s<e.length;++s)i|=this.mouseKeyFlags[e[s]];for(s=0;s<t.length;++s)i|=this.mouseKeyFlags[t[s]];return i}clearMouseKeyManipulationBindings(){this.mouseKeyManipulationModeBinding={},this.hasShiftKeyBinding=!1,this.hasControlKeyBinding=!1,this.hasAltKeyBinding=!1}addMouseKeyManipulationModeBinding(e,t,i){const s=this.getMouseKeyCombinationID(e,t);s>0&&(this.mouseKeyManipulationModeBinding[s]=i,this.hasControlKeyBinding||(this.hasControlKeyBinding=0!=(s&this.mouseKeyFlags[cs.R8.CONTROL])),this.hasShiftKeyBinding||(this.hasShiftKeyBinding=0!=(s&this.mouseKeyFlags[cs.R8.SHIFT])),this.hasAltKeyBinding||(this.hasAltKeyBinding=0!=(s&this.mouseKeyFlags[cs.R8.ALT])))}getManipulationMode(e,t){return this.mouseKeyManipulationModeBinding[this.getMouseKeyCombinationID(e,t)]}isManipulationModeEnabled(e,t,i){const s=this.getMouseKeyCombinationID(t,i);for(const t in this.mouseKeyManipulationModeBinding){const i=parseInt(t,10);if(this.mouseKeyManipulationModeBinding[i]===e){if((s&i)===i)return!0}}return!1}getClosestMode(e,t,i){let s=IC.k.NONE,n=0;for(const r in this.mouseKeyManipulationModeBinding){const a=parseInt(r,10),o=this.mouseKeyManipulationModeBinding[a];o!==i&&(this.isManipulationModeEnabled(o,e,t)&&a>n&&(n=a,s=o))}return s}usesShiftKey(){return this.hasShiftKeyBinding}usesControlKey(){return this.hasControlKeyBinding}usesAltKey(){return this.hasAltKeyBinding}}let UI=null;function GI(){return UI||(UI=new VI,UI.addMouseKeyManipulationModeBinding([Hn.tc.RIGHT],[],IC.k.ROTATE),UI.addMouseKeyManipulationModeBinding([Hn.tc.RIGHT],[cs.R8.ALT],IC.k.AXIS_ROTATE),UI.addMouseKeyManipulationModeBinding([Hn.tc.RIGHT],[cs.R8.CONTROL],IC.k.PAN),UI.addMouseKeyManipulationModeBinding([Hn.tc.MIDDLE],[],IC.k.PAN)),UI}function HI(e,t){if(t.length<1)t.push(e.slice(0));else{const i=CI(t,0,t.length,0,e[0]);let s,n=!1,r=0,a=e[1];if(i>0){const r=t[i-1];r[1]>=e[0]&&((0,XI.d8)(r[2],e[2])?(n=!0,a=Math.max(a,r[1])):(r[1]>a&&(s=[e[1],r[1],r[2]]),r[1]=e[0]))}for(let s=i;s<t.length;++s){const i=t[s];if(!(i[0]<=e[1]))break;i[1]<=e[1]?++r:(0,XI.d8)(i[2],e[2])?(++r,a=Math.max(a,i[1])):i[0]<a&&(i[0]=a)}n?(t[i-1][1]=a,t.splice(i,r)):s?t.splice(i,r,[e[0],a,e[2]],s):t.splice(i,r,[e[0],a,e[2]])}}function kI(e,t){if(e[0]===e[1])return;const i=CI(t,0,t.length,1,e[0]),s=CI(t,i,t.length,0,e[1]);if(i>=t.length||i===s)return;let n=null,r=null;t[i][0]<e[0]&&(n=[t[i][0],e[0],t[i][2]]),t[s-1][1]>e[1]&&(r=[e[1],t[s-1][1],t[s-1][2]]),n&&r?t.splice(i,s-i,n,r):n?t.splice(i,s-i,n):r?t.splice(i,s-i,r):t.splice(i,s-i)}function WI(e){return 0===e.length?"[]":"[["+e.join("],[")+"]]"}function zI(e){const t=new Array(e.length);for(let i=0;i<e.length;++i)t[i]=e[i].slice();return t}var XI=i(61449),ZI=i(5947);class qI extends ZI.q{constructor(){super(2),this.baseIterator=null,this.resetStyle=null}setResetStyle(e){this.resetStyle=e}reset(e){return this.baseIterator=e,this.nextResult=this.findNextRange(),this}findNextRange(){const e=this.baseIterator.getNextRange();if(!e)return null;const t=this.getStorageForNextResult();return t[0]=e[0],t[1]=e[1],t[2]=(0,XI.TS)(e[2],this.resetStyle,this.getStyleMergeStorage()),t}}class YI{constructor(){this.operand=null,this.iterator=new qI}setResetStyle(e){this.iterator.setResetStyle(e)}setOperand(e){this.operand=e}getRangeIteratorForBufferSet(e){if(!this.operand)return null;const t=this.operand.getRangeIteratorForBufferSet(e);return t?this.iterator.reset(t):null}makeSceneDebugObject(){const e={text:"StyleResetOperator",children:[]};return(0,Fs.n9)(e,this.operand),e}}const KI=new YI;class jI{constructor(e,t,i,s,n){this.parent=e,this.style=t,this.meshRanges=i,this.styleOverrideRanges=s,this.styleOverrideOperator=null,this.meshRangeGroupIdHash=null,this.meshRanges.addBoundable(this),n&&(this.rangeSkipOperator=new OS,this.rangeSkipOperator.setSubtrahend(n))}destroy(){this.meshRanges.removeBoundable(this)}getMeshRanges(){return this.meshRanges}getMeshRangesGroupIdHash(){if(this.meshRangeGroupIdHash)return this.meshRangeGroupIdHash;const e=this.getMeshRangesGroupId();if(e){this.meshRangeGroupIdHash=0;for(let t=0;t<e.length;t++)this.meshRangeGroupIdHash+=e.charCodeAt(t)}return this.meshRangeGroupIdHash}getMeshRangesGroupId(){return this.meshRanges.getMeshGroupId()}draw(e,t){if(!this.meshRanges.shouldDrawForOccurrences(t))return;e.applyStyle(this.style);let i=t.getMeshRangeOperator(e);i!==$I&&(i&&i.setOperand(this.meshRanges),this.rangeSkipOperator&&(this.rangeSkipOperator.setOperand(i||this.meshRanges),i=this.rangeSkipOperator),e.activePassNeedsFaceAppearances()&&this.styleOverrideRanges&&(this.styleOverrideOperator||(this.styleOverrideOperator=new VE,this.styleOverrideOperator.setOverwriteOperand(this.styleOverrideRanges),this.styleOverrideOperator.setDefaultStyle(this.style)),this.styleOverrideOperator.setOperand(i||this.meshRanges),i=this.styleOverrideOperator),e.activePassNeedsFaceAppearances()||(KI.setOperand(i||this.meshRanges),KI.setResetStyle(this.style),i=KI),this.meshRanges.draw(e,i))}isCheaplyBoundable(){return this.meshRanges.isCheaplyBoundable()}damageBounds(){this.parent.damageBounds()}getBounds(e,t){return this.meshRanges.getBounds(e,t)}makeSceneDebugObject(e){let t="Styled mesh range: (style: "+this.style+")";const i=[this.meshRanges.makeSceneDebugObject(e)];return this.styleOverrideRanges&&(i.push(this.styleOverrideRanges.makeSceneDebugObject()),t+=", with style overrides"),{text:t,children:i}}}class QI{getRangeIteratorForBufferSet(e){return null}setOperand(e){}makeSceneDebugObject(){return{text:"NoRangeOperator",children:[]}}}const $I=new QI,JI=Ft;class eE{constructor(e,t,i,s,n=!1,r=1){this.name=e,this.dimension=t,this.type=i,this.incrementProperty=s,this.normalize=n,this.secondDimension=r,this.elementCount=this.dimension*this.secondDimension,this.secondDimension>1&&this.dimension!==this.secondDimension&&ut.log.warn("Only square matrices are supported as glsl attributes. Attribute "+this.name+" will have issues")}typeSize(){return Bt(this.type)}sizeInBytes(){return this.elementCount*this.typeSize()}}var tE,iE;!function(e){e.POSITION="aVertexPosition",e.NORMAL="aVertexNormal",e.OFFSET_VECTOR="aOffsetVector",e.COLOR="aVertexColor",e.PICKING="aPickId",e.TEXTURE="aTextureCoordinate",e.HIGHLIGHT_ID="aHighlightId",e.POINT_DATA="aPointData",e.EDGE_DATA="aEdgeData",e.PRIMITIVE_SIZE="aPrimitiveSize",e.PRIMITIVE_STYLE="aPrimitiveStyle",e.PRIMITIVE_RESTART="aPrimitiveRestart",e.OCCURRENCE_ID="aOccurrenceId",e.CONTACT_TRACTION="aContactTraction",e.CONTACT_PAIR_COORDINATE="aContactPairCoordinate"}(tE||(tE={})),function(e){e.POINT="points",e.NORMAL="normals",e.OFFSET_VECTOR="offsetVectors",e.COLOR="colors",e.TEXTURE="textureCoordinates",e.POINT_DATA="pointData",e.EDGE_DATA="edgeData",e.PRIMITIVE_SIZE="primitiveSizes",e.PRIMITIVE_STYLE="primitiveStyles",e.HIGHLIGHT_ID="highlightVisibility",e.CONTACT_TRACTION="contactTraction",e.CONTACT_PAIR_COORDINATE="contactPairCoordinate",e.INDEX="indices"}(iE||(iE={}));const sE={POINT:new eE(tE.POSITION,3,JI.FLOAT,iE.POINT),NORMAL:new eE(tE.NORMAL,3,JI.FLOAT,iE.NORMAL),OFFSET_VECTOR:new eE(tE.OFFSET_VECTOR,3,JI.FLOAT,iE.OFFSET_VECTOR),COLOR:new eE(tE.COLOR,4,JI.UNSIGNED_BYTE,iE.COLOR,!0),TEXTURE:new eE(tE.TEXTURE,2,JI.FLOAT,iE.TEXTURE),POINT_DATA:new eE(tE.POINT_DATA,1,JI.FLOAT,iE.POINT_DATA),EDGE_DATA:new eE(tE.EDGE_DATA,4,JI.FLOAT,iE.EDGE_DATA),PRIMITIVE_SIZE:new eE(tE.PRIMITIVE_SIZE,1,JI.FLOAT,iE.PRIMITIVE_SIZE),PRIMITIVE_STYLE:new eE(tE.PRIMITIVE_STYLE,4,JI.UNSIGNED_BYTE,iE.PRIMITIVE_STYLE),HIGHLIGHT_ID:new eE(tE.HIGHLIGHT_ID,4,JI.UNSIGNED_BYTE,iE.HIGHLIGHT_ID,!0),CONTACT_TRACTION:new eE(tE.CONTACT_TRACTION,4,JI.UNSIGNED_BYTE,iE.CONTACT_TRACTION,!1,4),CONTACT_PAIR_COORDINATE:new eE(tE.CONTACT_PAIR_COORDINATE,4,JI.FLOAT,iE.CONTACT_PAIR_COORDINATE,!1,4)};var nE;!function(e){e.LOWEST="LOWEST",e.LOW="LOW",e.MEDIUM="MEDIUM",e.HIGH="HIGH",e.DEFAULT="MEDIUM"}(nE||(nE={}));var rE=i(22189);const aE=sE,oE={globallyUniqueId:!0,pickId:!0,properties:!0},hE=sh.create(),cE=de.create(),lE=C.create(),uE=C.create();Math.pow(2,16);function dE(e,t){return t?t+"."+e:e}let gE=1;const pE=function(e,t,i,s,n,r,a,o,h,c,l,u,d,g){return t[3*e+0]=o[0],t[3*e+1]=o[1],t[3*e+2]=o[2],h&&(i[3*e+0]=h[0],i[3*e+1]=h[1],i[3*e+2]=h[2]),c&&(s[4*e+0]=c[0],s[4*e+1]=c[1],s[4*e+2]=c[2],s[4*e+3]=c[3]),null!==l&&(n[e]=l),u&&(r[4*e+0]=u[0],r[4*e+1]=u[1],r[4*e+2]=u[2],r[4*e+3]=u[3]),a[4*e+0]=d[0],a[4*e+1]=d[1],a[4*e+2]=d[2],a[4*e+3]=g,e+1},mE=C.create(),fE=C.create(),IE=C.create(),EE=C.create(),SE=y.create(),TE=y.create(),DE=C.create(),ME=C.create(),CE=y.create(),yE=y.create(),PE=C.create(),AE=C.create(),OE=C.create();class vE{addVertexAttribute(e){this.additionalVertexAttributes&&(this.additionalVertexAttributes.add(e.incrementProperty),this.totalVertexBufferDimensionSize+=e.dimension)}hasAsAVertexAttribute(e){return this.additionalVertexAttributes&&this.additionalVertexAttributes.has(e.incrementProperty)}constructor(e,t,i,s,n,r=!1){this.primitiveType=e,this.points=t,this.isPrecompiledBuffer=r,this.properties={},this.additionalVertexAttributes=null,this.totalVertexBufferDimensionSize=aE.POINT.dimension,this.id=s||"",this.indices=i,n||this.prepareForBuffering(),r&&(this.additionalVertexAttributes=new Set)}clone(e){const t=new vE(this.primitiveType,this.points,this.indices,this.id,!0,this.isPrecompiledBuffer);(0,j.overwriteMatchingProperties)(t,this,oE);for(const e in this.properties)oE[e]||(t.properties[e]=this.properties[e]);return e&&(t.ownerId=e),t.additionalVertexAttributes=this.additionalVertexAttributes,t.totalVertexBufferDimensionSize=this.totalVertexBufferDimensionSize,t}setProperty(e,t){null==t?delete this.properties[e]:this.properties[e]=t}set indices(e){this.setProperty("indices",e)}get indices(){return this.properties.indices||null}set normals(e){this.setProperty("normals",e)}get normals(){return this.properties.normals||null}set offsetVectors(e){this.setProperty("offsetVectors",e)}get offsetVectors(){return this.properties.offsetVectors||null}set colors(e){this.setProperty("colors",e)}get colors(){return this.properties.colors||null}set textureCoordinates(e){this.setProperty("textureCoordinates",e)}get textureCoordinates(){return this.properties.textureCoordinates||null}set primitiveSizes(e){this.setProperty("primitiveSizes",e)}get primitiveSizes(){return this.properties.primitiveSizes||null}set primitiveStyles(e){this.setProperty("primitiveStyles",e)}get primitiveStyles(){return this.properties.primitiveStyles||null}set contactTraction(e){this.setProperty("contactTraction",e)}get contactTraction(){return this.properties.contactTraction||null}set contactPairCoordinate(e){this.setProperty("contactPairCoordinate",e)}get contactPairCoordinate(){return this.properties.contactPairCoordinate||null}set pointData(e){this.setProperty("pointData",e)}get pointData(){return this.properties.pointData||null}set edgeData(e){this.setProperty("edgeData",e)}get edgeData(){return this.properties.edgeData||null}set pickId(e){this.setProperty("pickId",e)}get pickId(){return this.properties.pickId||void 0}set groupId(e){this.setProperty("groupId",e)}get groupId(){return this.properties.groupId||""}set ownerId(e){this.setProperty("ownerId",e)}get ownerId(){return this.properties.ownerId||""}set boundingBox(e){this.setProperty("boundingBox",e)}get boundingBox(){return this.properties.boundingBox||null}set globallyUniqueId(e){this.setProperty("globallyUniqueId",e)}get globallyUniqueId(){return this.properties.globallyUniqueId||null}set lod(e){this.setProperty("lod",e)}get lod(){return this.properties.lod||nE.DEFAULT}getFullId(){return dE(this.id,this.ownerId)}getFullGroupId(){return dE(this.groupId,this.ownerId)}isAPrecompiledBuffer(){return this.isPrecompiledBuffer}getPoint(e,t){const i=3*e;return e<0||i>=this.points.length?null:t?(t[0]=this.points[i],t[1]=this.points[i+1],t[2]=this.points[i+2],t):this.points instanceof Float32Array?this.points.subarray(i,i+3):this.points.slice(i,i+3)}getLinesLength(){if(this.primitiveType!==Di.MX.LINES)return-1;this.isPreparedForBuffering()||this.prepareForBuffering();let e=0;for(let t=0;t<this.indices.length;t+=6)e+=ge.S4.dist(this.getPoint(this.indices[t+0]),this.getPoint(this.indices[t+1]));return e}getPositionAtDistanceAlongLines(e){if(this.primitiveType!==Di.MX.LINES)return null;this.isPreparedForBuffering()||this.prepareForBuffering();let t=0;for(let i=0;i<this.indices.length;i+=6){const s=this.getPoint(this.indices[i+0]),n=this.getPoint(this.indices[i+1]),r=ge.S4.dist(s,n);if(t+r>=e){const i=(e-t)/r;return ge.S4.add(s,ge.S4.scale(ge.S4.subtract(n,s,C.create()),i),C.create())}t+=r}return null}getLineDirection(e){if(!this.isLines())return null;if(this.isPreparedForBuffering()||this.prepareForBuffering(),e<0||6*(e+1)>this.indices.length)return null;const t=6*e,i=ge.S4.subtract(this.getPoint(this.indices[t+1]),this.getPoint(this.indices[t+0]),C.create());return ge.S4.normalize(i)}getRepresentativeDirection(){return this.isLines()?this.getLineDirection(0):this.isTriangles()&&this.normals&&this.normals.length>=3?this.normals instanceof Float32Array?this.normals.subarray(0,3):this.normals.slice(0,3):null}equals(e){return!(!e||this.primitiveType!==e.primitiveType)&&(this.id===e.id&&(null===this.additionalVertexAttributes&&null===e.additionalVertexAttributes||(0,rE.n)(this.additionalVertexAttributes,e.additionalVertexAttributes))&&this.totalVertexBufferDimensionSize===e.totalVertexBufferDimensionSize&&(0,li.arraysEqual)(this.pickId,e.pickId)&&(0,li.arraysEqual)(this.points,e.points)&&(0,li.arraysEqual)(this.indices,e.indices)&&(0,li.arraysEqual)(this.normals,e.normals)&&(0,li.arraysEqual)(this.offsetVectors,e.offsetVectors)&&(0,li.arraysEqual)(this.colors,e.colors)&&(0,li.arraysEqual)(this.textureCoordinates,e.textureCoordinates)&&(0,li.arraysEqual)(this.primitiveSizes,e.primitiveSizes)&&(0,li.arraysEqual)(this.primitiveStyles,e.primitiveStyles)&&(0,li.arraysEqual)(this.pointData,e.pointData)&&(0,li.arraysEqual)(this.edgeData,e.edgeData))}getBounds(){if(!this.boundingBox){const e=sE.POINT.dimension,t=this.getTotalVertexBufferDimensionsSize();this.boundingBox=new yi.kB;const i=this.boundingBox,s=this.points.length/t*e;for(let t=0;t<s;t+=e)i.addXYZ(this.points[t],this.points[t+1],this.points[t+2])}return this.boundingBox}getGloballyUniqueId(){return this.globallyUniqueId||(this.globallyUniqueId=gE,gE+=1),this.globallyUniqueId}isPreparedForBuffering(){return this.isPrecompiledBuffer||this.isTriangles()||this.isPoints()&&!!this.pointData||this.isLines()&&!!this.edgeData}hasAttribute(e){const t=sE[e];if(!t)return!1;const i=t.incrementProperty;return!(this.isPrecompiledBuffer||!(this.isLines()&&"edgeData"===i||this.isPoints()&&"pointData"===i))||(!(!this.isPrecompiledBuffer||!this.additionalVertexAttributes.has(i))||!!this[i])}getPrimitiveType(){return this.primitiveType}prepareForBuffering(){this.isPrecompiledBuffer||(this.points&&this.indices&&!this.pointData&&this.isPoints()&&this.createPointData(),this.points&&this.indices&&!this.edgeData&&this.isLines()&&this.createEdgeData())}isPoints(){return this.primitiveType===Di.MX.POINTS}isLines(){return this.primitiveType===Di.MX.LINES||this.primitiveType===Di.MX.INFINITE_LINES||this.primitiveType===Di.MX.SILHOUETTES}isTriangles(){return this.primitiveType===Di.MX.TRIANGLES||this.primitiveType===Di.MX.TRIANGLE_STRIP}getTriangleCount(){return this.primitiveType===Di.MX.TRIANGLES?this.indices.length/3:this.primitiveType===Di.MX.TRIANGLE_STRIP?this.indices.length-2:0}getLineCount(){return this.isLines()?this.isPreparedForBuffering()?this.indices.length/6:this.indices.length/2:0}createPointData(){const e=this.indices.length,t=4*e,i=6*e,s=new Float32Array(aE.POINT.dimension*t),n=new Int32Array(i),r=this.colors?new Uint8Array(aE.COLOR.dimension*t):null,a=this.primitiveSizes?new Float32Array(aE.PRIMITIVE_SIZE.dimension*t):null,o=this.primitiveStyles?new Uint8Array(aE.PRIMITIVE_STYLE.dimension*t):null,h=new Float32Array(aE.POINT_DATA.dimension*t);let c=0;const l=function(e,t,i,n,l){s[3*c+0]=e[0],s[3*c+1]=e[1],s[3*c+2]=e[2],t&&(r[4*c+0]=t[0],r[4*c+1]=t[1],r[4*c+2]=t[2],r[4*c+3]=t[3]),null!==i&&(a[c]=i),n&&(o[4*c+0]=n[0],o[4*c+1]=n[1],o[4*c+2]=n[2],o[4*c+3]=n[3]),h[c]=l,c+=1};let u=0;for(let t=0;t<e;++t){const e=this.indices[t],i=[this.points[3*e+0],this.points[3*e+1],this.points[3*e+2]];let s=null;if(this.colors){s=[this.colors[4*e+0],this.colors[4*e+1],this.colors[4*e+2],this.colors[4*e+3]]}let r=null;this.primitiveSizes&&(r=this.primitiveSizes[4*e]);let a=null;if(this.primitiveStyles){a=[this.primitiveStyles[4*e+0],this.primitiveStyles[4*e+1],this.primitiveStyles[4*e+2],this.primitiveStyles[4*e+3]]}l(i,s,r,a,1),l(i,s,r,a,2),l(i,s,r,a,3),l(i,s,r,a,4),n[6*t+0]=u+0,n[6*t+1]=u+1,n[6*t+2]=u+2,n[6*t+3]=u+0,n[6*t+4]=u+2,n[6*t+5]=u+3,u+=4}this.points=s,this.indices=n,this.colors=r,this.primitiveSizes=a,this.primitiveStyles=o,this.pointData=h,this.normals=null,this.textureCoordinates=null}createEdgeData(){this.indices.length%2!=0&&ut.log.warn("Trying to create lines with an odd number of indices");const e=Math.floor(this.indices.length/2),t=4*e,i=6*e,s=new Float32Array(aE.POINT.dimension*t),n=new Int32Array(i),r=this.normals?new Float32Array(aE.NORMAL.dimension*t):null,a=this.colors?new Uint8Array(aE.COLOR.dimension*t):null,o=this.primitiveSizes?new Float32Array(aE.PRIMITIVE_SIZE.dimension*t):null,h=this.primitiveStyles?new Uint8Array(aE.PRIMITIVE_STYLE.dimension*t):null,c=new Float32Array(aE.EDGE_DATA.dimension*t);let l=0,u=0,d=1;for(let t=0;t<e;++t){const e=this.indices[2*t+0],i=C.set(IE,this.points[3*e+0],this.points[3*e+1],this.points[3*e+2]),g=this.normals?C.set(EE,this.normals[3*e+0],this.normals[3*e+1],this.normals[3*e+2]):null,p=this.colors?y.set(SE,this.colors[4*e+0],this.colors[4*e+1],this.colors[4*e+2],this.colors[4*e+3]):null,m=this.primitiveSizes?this.primitiveSizes[e]:null,f=this.primitiveStyles?y.set(TE,this.primitiveStyles[4*e+0],this.primitiveStyles[4*e+1],this.primitiveStyles[4*e+2],this.primitiveStyles[4*e+3]):null,I=this.indices[2*t+1];let E=C.set(DE,this.points[3*I+0],this.points[3*I+1],this.points[3*I+2]);const S=this.normals?C.set(ME,this.normals[3*I+0],this.normals[3*I+1],this.normals[3*I+2]):null,T=this.colors?y.set(CE,this.colors[4*I+0],this.colors[4*I+1],this.colors[4*I+2],this.colors[4*I+3]):null,D=this.primitiveSizes?this.primitiveSizes[I]:null,M=this.primitiveStyles?y.set(yE,this.primitiveStyles[4*I+0],this.primitiveStyles[4*I+1],this.primitiveStyles[4*I+2],this.primitiveStyles[4*I+3]):null,P=ge.S4.subtract(E,i,mE),A=ge.S4.length(P);ge.S4.normalize(P);let O=d;d+=A;let v=d;this.primitiveType===Di.MX.INFINITE_LINES&&(O=-O,v=-v,E=i),l=pE(l,s,r,a,o,h,c,i,g,p,m,f,ge.S4.scale(P,1,fE),O),l=pE(l,s,r,a,o,h,c,E,S,T,D,M,ge.S4.scale(P,2,fE),v),l=pE(l,s,r,a,o,h,c,E,S,T,D,M,ge.S4.scale(P,3,fE),v),l=pE(l,s,r,a,o,h,c,i,g,p,m,f,ge.S4.scale(P,4,fE),O),n[6*t+0]=u+0,n[6*t+1]=u+1,n[6*t+2]=u+2,n[6*t+3]=u+0,n[6*t+4]=u+2,n[6*t+5]=u+3,u+=4}this.points=s,this.indices=n,this.normals=r,this.colors=a,this.primitiveSizes=o,this.primitiveStyles=h,this.edgeData=c,this.textureCoordinates=null}createTransformed(e){let t;const i=[0,0,0],s=ge.w$.toMat3(ge.w$.toRotationMat(e,cE),hE),n=this.clone();for(n.boundingBox=null,n.points=new Float32Array(n.points.length),t=0;t<this.points.length;t+=3)i[0]=this.points[t],i[1]=this.points[t+1],i[2]=this.points[t+2],ge.w$.multiplyVec3(e,i),n.points[t]=i[0],n.points[t+1]=i[1],n.points[t+2]=i[2];function r(e){const n=new Float32Array(e.length);for(t=0;t<e.length;t+=3)i[0]=e[t],i[1]=e[t+1],i[2]=e[t+2],ge.xB.multiplyVec3(s,i),ge.S4.normalize(i),n[t]=i[0],n[t+1]=i[1],n[t+2]=i[2];return n}if(this.normals&&(n.normals=r(this.normals)),this.offsetVectors&&(n.offsetVectors=r(this.offsetVectors)),this.edgeData){const e=this.edgeData,r=new Float32Array(n.edgeData.length);for(t=0;t<this.edgeData.length;t+=4){i[0]=e[t],i[1]=e[t+1],i[2]=e[t+2];const n=ge.S4.length(i);ge.xB.multiplyVec3(s,i),ge.S4.scale(i,n/ge.S4.length(i)),r[t]=i[0],r[t+1]=i[1],r[t+2]=i[2],r[t+3]=this.edgeData[t+3]}n.edgeData=r}return n}concatenate(e){if(!(e&&e.primitiveType===this.primitiveType&&(0,j.objectsDefinedInSameWay)(this.normals,e.normals)&&(0,j.objectsDefinedInSameWay)(this.offsetVectors,e.offsetVectors)&&(0,j.objectsDefinedInSameWay)(this.colors,e.colors)&&(0,j.objectsDefinedInSameWay)(this.textureCoordinates,e.textureCoordinates)&&(0,j.objectsDefinedInSameWay)(this.primitiveSizes,e.primitiveSizes)&&(0,j.objectsDefinedInSameWay)(this.primitiveStyles,e.primitiveStyles)&&(0,j.objectsDefinedInSameWay)(this.edgeData,e.edgeData)&&(0,j.objectsDefinedInSameWay)(this.pointData,e.pointData)))return null;const t=(0,Fs.Mz)(this.points,e.points),i=new Int32Array(this.indexLengthWithDegenerates()+e.indices.length);i.set(this.indices);const s=this.indexLengthWithDegenerates(),n=this.vertexCount();for(let t=0;t<e.indices.length;++t)i[s+t]=e.indices[t]+n;this.primitiveType===Di.MX.TRIANGLE_STRIP&&(i[s-2]=this.indices[this.indices.length-1],this.indices.length%2&&(i[s-3]=this.indices[this.indices.length-1]),i[s-1]=e.indices[0]+n);const r=new vE(this.primitiveType,t,i,void 0,!0);return this.normals&&e.normals&&(r.normals=(0,Fs.Mz)(this.points,e.points)),this.colors&&e.colors&&(r.colors=(0,Fs.Lf)(this.colors,e.colors)),this.textureCoordinates&&e.textureCoordinates&&(r.textureCoordinates=(0,Fs.Mz)(this.textureCoordinates,e.textureCoordinates)),this.primitiveSizes&&e.primitiveSizes&&(r.primitiveSizes=(0,Fs.Mz)(this.primitiveSizes,e.primitiveSizes)),this.primitiveStyles&&e.primitiveStyles&&(r.primitiveStyles=(0,Fs.Lf)(this.primitiveStyles,e.primitiveStyles)),this.edgeData&&e.edgeData&&(r.edgeData=(0,Fs.Mz)(this.edgeData,e.edgeData)),this.pointData&&e.pointData&&(r.pointData=(0,Fs.Mz)(this.pointData,e.pointData)),this.offsetVectors&&e.offsetVectors&&(r.offsetVectors=(0,Fs.Mz)(this.offsetVectors,e.offsetVectors)),r}indexLengthWithDegenerates(){return this.primitiveType!==Di.MX.TRIANGLE_STRIP||this.isPrecompiledBuffer?this.indices.length:this.indices.length%2==0?this.indices.length+2:this.indices.length+3}getTotalVertexBufferDimensionsSize(){return this.totalVertexBufferDimensionSize}vertexCount(){return this.points.length/this.getTotalVertexBufferDimensionsSize()}getPreparedVertexCount(){return this.isPreparedForBuffering()?this.vertexCount():4*this.vertexCount()}getPreparedIndexCount(){if(this.isPreparedForBuffering())return this.indexLengthWithDegenerates();if(this.isLines()){return 6*Math.floor(this.indices.length/2)}return this.isPoints()?6*this.indices.length:(ut.log.warn("Found unprepared increment that was not lines or points"),this.indexLengthWithDegenerates())}getVertexSize(){let e=0;for(const t in sE){const i=sE[t];(this.hasAttribute(t)||i.name===tE.OCCURRENCE_ID)&&(e+=i.sizeInBytes())}return e}iteratePrimitives(e){switch(this.primitiveType){case Di.MX.POINTS:this.iteratePoints(e);break;case Di.MX.LINES:this.iterateLines(e);break;case Di.MX.TRIANGLES:this.iterateTriangles(e);break;case Di.MX.TRIANGLE_STRIP:this.iterateTriangleStrip(e);break;default:ut.log.warn("Cannot iterate over primitive type "+this.primitiveType)}}iteratePoints(e){this.prepareForBuffering();for(let t=0;t<this.indices.length;t+=6)e(this.getPoint(this.indices[t],PE))}iterateLines(e){this.prepareForBuffering();for(let t=0;t<this.indices.length;t+=6)e(this.getPoint(this.indices[t],PE),this.getPoint(this.indices[t+1],AE))}iterateTriangles(e){const t=Math.floor(this.indices.length/3);for(let i=0;i<3*t;i+=3)e(this.getPoint(this.indices[i],PE),this.getPoint(this.indices[i+1],AE),this.getPoint(this.indices[i+2],OE))}iterateTriangleStrip(e){for(let t=0;t<this.indices.length-2;++t)this.indices[t]!==this.indices[t+1]&&this.indices[t]!==this.indices[t+2]&&this.indices[t+1]!==this.indices[t+2]&&(t%2?e(this.getPoint(this.indices[t],PE),this.getPoint(this.indices[t+2],AE),this.getPoint(this.indices[t+1],OE)):e(this.getPoint(this.indices[t],PE),this.getPoint(this.indices[t+1],AE),this.getPoint(this.indices[t+2],OE)))}getPositionNearCenter(){return this.getPositionNearPoint(this.getBounds().center()).position}getPositionNearPoint(e){let t=null,i=1/0;function s(s){const n=ge.S4.distanceSquared(e,s);n<i&&(t=C.clone(s),i=n)}function n(t,i){s((0,yi.vu)(t,i,e))}return this.iteratePrimitives((function(e,t,i){t||i?i?function(e,t,i){n(e,t),n(t,i),n(i,e);const r=lE;ge.S4.add(r,ge.S4.scale(e,1/3,uE)),ge.S4.add(r,ge.S4.scale(t,1/3,uE)),ge.S4.add(r,ge.S4.scale(i,1/3,uE)),s(r)}(e,t,i):n(e,t):s(e)})),{position:t,distance:i}}packScalarsIntoTextureCoordinates(e){const t=new Float32Array(this.vertexCount()*sE.TEXTURE.dimension);if(e.length!==this.vertexCount())return void ut.log.debug(`Scalars of length ${e.length} did not match increment vertex count of ${this.vertexCount()}`);const i=[1,0];for(let s=0;s<this.vertexCount();++s)i[1]=e[s],t.set(i,sE.TEXTURE.dimension*s);this.textureCoordinates=t}replicateTextureCoordinate(e){const t=new Float32Array(this.vertexCount()*sE.TEXTURE.dimension);for(let i=0;i<this.vertexCount();++i)t.set(e,sE.TEXTURE.dimension*i);this.textureCoordinates=t}}var RE=i(40315);class wE{constructor(){this.bufferSetRanges=new wi.N,this.boundables=new Set,this.iterator=new RE.I,this.listenForDeletions=!1,this.listenerId=pS()}getMeshGroupId(){return null}destroy(){this.setListenForDeletions(!1)}copyDataTo(e){const t=this.bufferSetRanges.getKeyValues();for(let i=0;i<t.length;i+=2)e.bufferSetRanges.set(t[i],zI(t[i+1]));e.boundables=new Set(this.boundables),e.setListenForDeletions(this.listenForDeletions)}getListenerId(){return this.listenerId}onIncrementDeleted(e){this.onIncrementRemoved(e)}setListenForDeletions(e){if(this.listenForDeletions===e)return;this.listenForDeletions=e;const t=this.bufferSetRanges.getKeyValues();for(let e=0;e<t.length;e+=2)this.listenForDeletions?t[e].addIncrementDeletionListener(this):t[e].removeIncrementDeletionListener(this)}isEmpty(){return 0===this.bufferSetRanges.size}onIncrementAdded(e,t){let i=this.bufferSetRanges.get(e.bufferSet);i||(i=[],this.bufferSetRanges.set(e.bufferSet,i));let s=e.indexRange;return t&&(s=[s[0],s[1],t]),HI(s,i),this.damageBounds(),!0}onIncrementRemoved(e){const t=this.bufferSetRanges.get(e.bufferSet);return!!t&&(kI(e.indexRange,t),0===t.length&&this.bufferSetRanges.delete(e.bufferSet),this.damageBounds(),!0)}addBoundable(e){this.boundables.add(e)}removeBoundable(e){this.boundables.delete(e)}damageBounds(){for(const e of this.boundables.values())e.damageBounds()}isCheaplyBoundable(){return!1}getRangeIteratorForBufferSet(e){const t=this.bufferSetRanges.get(e);return t?(this.iterator.resetForRangeSet(t),this.iterator):null}shouldDrawForOccurrences(e){return!0}draw(e,t){const i=this.bufferSetRanges.getKeyValues();for(let s=0;s<i.length;s+=2)i[s].draw(e,t||this)}getChildSceneDebugObjects(){const e=[],t=this.bufferSetRanges.getKeyValues();for(let i=0;i<t.length;i+=2){const s=t[i];e.push({text:"Buffer set "+(s.getIsForPrecompiledIncrements()?"(For precompiled increments) ":"")+s.getDebugId()+" ranges: ("+WI(t[i+1])+")",children:[]})}return e}}var _E=i(91851);class NE extends _E.Y{constructor(){super(),this.operandA=null,this.currentARange=null,this.operandB=null,this.currentBRange=null}reset(e,t){this.operandA=e,this.currentARange=null,this.operandB=t,this.currentBRange=null,this.nextResult=this.findNextRange()}findNextRange(){if(this.currentARange||(this.currentARange=this.operandA.getNextRange()),!this.currentARange)return null;for(;this.bIsBehind();)this.currentBRange=this.operandB.getNextRange();if(!this.currentBRange)return null;if(this.currentARange[1]<=this.currentBRange[0])return this.currentARange=null,this.findNextRange();const e=this.getStorageForNextResult();return e[2]=this.currentARange[2],this.currentARange[0]>=this.currentBRange[0]?e[0]=this.currentARange[0]:e[0]=this.currentBRange[0],this.currentARange[1]<=this.currentBRange[1]?(e[1]=this.currentARange[1],this.currentARange[1]===this.currentBRange[1]&&(this.currentBRange=null),this.currentARange=null):(e[1]=this.currentBRange[1],this.currentBRange=null),e}bIsBehind(){return this.currentBRange?this.currentBRange[1]<=this.currentARange[0]:this.operandB.hasMoreRanges()}}class bE{constructor(){this.operandA=null,this.operandB=null,this.iterator=new NE}setOperandA(e){this.operandA=e}setOperand(e){this.operandB=e}getRangeIteratorForBufferSet(e){if(!this.operandA||!this.operandB)return null;const t=this.operandA.getRangeIteratorForBufferSet(e);if(!t)return null;const i=this.operandB.getRangeIteratorForBufferSet(e);return i?(this.iterator.reset(t,i),this.iterator):null}makeSceneDebugObject(){const e={text:"IntersectOperator",children:[]};return(0,Fs.n9)(e,this.operandA),(0,Fs.n9)(e,this.operandB),e}}function LE(e){return t=>{const i=t.getAttribute(sE.COLOR);if(i){const s=t.clone(),n=i.slice();return n[3]*=e,s.setAttribute(sE.COLOR,n),s}return t}}class FE{constructor(e){this.styleModifier=e,this.baseIterator=null}reset(e){return this.baseIterator=e,this}hasMoreRanges(){return this.baseIterator.hasMoreRanges()}getNextRange(){const e=this.baseIterator.getNextRange();if(e){const t=[e[0],e[1],e[2]];return t[2]&&(t[2]=this.styleModifier(t[2])),t}return null}}class xE{constructor(e){this.baseOperand=null,this.iterator=new FE(e)}setOperand(e){this.baseOperand=e}getRangeIteratorForBufferSet(e){if(!this.baseOperand)return null;const t=this.baseOperand.getRangeIteratorForBufferSet(e);return t?this.iterator.reset(t):null}makeSceneDebugObject(){const e={text:"StyleModificationOperator",children:[]};return(0,Fs.n9)(e,this.baseOperand),e}}class BE extends ZI.q{constructor(){super(4),this.baseIterator=null,this.currentBaseRange=null,this.currentBaseOffset=-1,this.overwriteIterator=null,this.currentOverwriteRange=null,this.defaultStyle=null}setDefaultStyle(e){this.defaultStyle=e}reset(e,t){return this.baseIterator=e,this.currentBaseRange=null,this.currentBaseOffset=-1,this.overwriteIterator=t,this.currentOverwriteRange=null,this.nextResult=this.findNextRange(),this}findNextRange(){if(this.currentBaseRange||(this.currentBaseRange=this.baseIterator.getNextRange(),this.currentBaseOffset=-1),!this.currentBaseRange)return null;for(;this.overwriteIteratorIsBehind();)this.currentOverwriteRange=this.overwriteIterator.getNextRange();const e=this.getStorageForNextResult();if(!this.currentOverwriteRange||this.currentOverwriteRange[0]>=this.currentBaseRange[1])e[0]=this.currentBaseOffset>=0?this.currentBaseOffset:this.currentBaseRange[0],e[1]=this.currentBaseRange[1],e[2]=(0,XI.TS)(this.defaultStyle,this.currentBaseRange[2],this.getStyleMergeStorage()),this.currentBaseRange=null;else{const t=this.currentBaseOffset>=0?this.currentBaseOffset:this.currentBaseRange[0];e[0]=t;const i=(0,XI.TS)(this.defaultStyle,this.currentBaseRange[2],this.getStyleMergeStorage());this.currentOverwriteRange[0]<=t?(e[2]=(0,XI.TS)(i,this.currentOverwriteRange[2],this.getStyleMergeStorage()),this.currentBaseRange[1]<this.currentOverwriteRange[1]?(e[1]=this.currentBaseRange[1],this.currentBaseRange=null):this.currentBaseRange[1]>this.currentOverwriteRange[1]?(e[1]=this.currentOverwriteRange[1],this.currentBaseOffset=this.currentOverwriteRange[1],this.currentOverwriteRange=null):(e[1]=this.currentBaseRange[1],this.currentBaseRange=null,this.currentOverwriteRange=null)):(e[1]=this.currentOverwriteRange[0],e[2]=i,this.currentBaseOffset=this.currentOverwriteRange[0])}return e}overwriteIteratorIsBehind(){if(this.overwriteIterator){if(this.currentOverwriteRange){const e=this.currentBaseOffset>=0?this.currentBaseOffset:this.currentBaseRange[0];return this.currentOverwriteRange[1]<=e}return this.overwriteIterator.hasMoreRanges()}return!1}}class VE{constructor(){this.baseOperand=null,this.overwriteOperand=null,this.iterator=new BE}setDefaultStyle(e){this.iterator.setDefaultStyle(e)}setOverwriteOperand(e){this.overwriteOperand=e}setOperand(e){this.baseOperand=e}getRangeIteratorForBufferSet(e){if(!this.baseOperand)return null;const t=this.baseOperand.getRangeIteratorForBufferSet(e);if(!t)return null;const i=this.overwriteOperand?this.overwriteOperand.getRangeIteratorForBufferSet(e):null;return this.iterator.reset(t,i)}makeSceneDebugObject(){const e={text:"StyleOverwriteOperator",children:[]};return(0,Fs.n9)(e,this.baseOperand),(0,Fs.n9)(e,this.overwriteOperand),e}}let UE=new bE,GE=new xr,HE=new VE,kE={};const WE=new XI.bg;WE.setAttribute(sE.HIGHLIGHT_ID,[0,0,0,0]);class zE{constructor(){this.entityHighlightRanges=new Map,this.entityHighlights=new Map,this.occurrenceHighlights=new Map}destroy(){for(const e of this.entityHighlightRanges.values())e.destroy();this.occurrenceHighlights.clear()}hasHighlight(){if(this.occurrenceHighlights.size>0)return!0;for(const e of this.entityHighlightRanges.values())if(!e.isEmpty())return!0;return!1}hasHighlightOfType(e){return this.entityHighlightRanges.has(e)}entityHasHighlight(e){if(this.occurrenceHighlights.size>0)return!0;for(const t of this.entityHighlightRanges.values())if(t.containsIncrement(e))return!0;return!1}getEntityHighlights(e){return this.entityHighlights.get(e)}removeEntityHighlights(e){this.entityHighlights.delete(e)}getOrCreateEntityRangesForType(e){let t=this.entityHighlightRanges.get(e);return t||(t=new SS(e),this.entityHighlightRanges.set(e,t),t.setListenForDeletions(!0)),t}updateEntityHighlight(e,t,i){const s=this.getOrCreateEntityRangesForType(t.type),n=(0,gl.getOrCreateSubMap)(this.entityHighlights,i),r=this.getHighestPriorityHighlightFromMap(n);if(e===dn.aU.ADD){if(n.set(t.getIdString(),t),!r||r.priority<t.priority){if(r){const e=this.entityHighlightRanges.get(r.type);e&&e.onIncrementRemoved(i)}s.onIncrementAdded(i,t.getStyle())}}else{n.delete(t.getIdString()),s.onIncrementRemoved(i);const e=this.getHighestPriorityHighlightFromMap(n);if(e){this.getOrCreateEntityRangesForType(e.type).onIncrementAdded(i,e.getStyle())}s.isEmpty()&&(this.entityHighlightRanges.delete(t.type),s.destroy()),0===n.size&&this.entityHighlights.delete(i)}}updateOccurrenceHighlight(e,t){let i;e===dn.aU.ADD?(i=(0,gl.getOrCreateSubMap)(this.occurrenceHighlights,t.type),i.set(t.getIdString(),t)):(i=this.occurrenceHighlights.get(t.type),i&&(i.delete(t.getIdString()),0===i.size&&this.occurrenceHighlights.delete(t.type)))}getHighestPriorityOccurrenceHighlight(){if(0===this.occurrenceHighlights.size)return null;let e=null;for(const t of this.occurrenceHighlights.values())for(const i of t.values())(!e||i.priority>e.priority)&&(e=i);return e}clearHighlight(e){this.occurrenceHighlights.delete(e.type);const t=this.entityHighlightRanges.get(e.type);t&&(this.entityHighlightRanges.delete(e.type),t.destroy()),this.entityHighlights.forEach(((t,i)=>{let s=!1;if(t.forEach(((i,n)=>{i.type===e.type&&(s=!0,t.delete(n))})),s)if(t.size>0){const s=this.getHighestPriorityHighlightFromMap(t);if(s&&s.priority<=e.priority){this.getOrCreateEntityRangesForType(s.type).onIncrementAdded(i,s.getStyle())}}else this.entityHighlights.delete(i)}))}clearAllOccurrenceLevelHighlights(){this.occurrenceHighlights.clear()}getUnionOperator(e,t){let i=kE[e];return i||(kE[e]=i=new qE),i.setOperandA(t),i.setOperand(null),i}getHighestPriorityHighlightFromMap(e){if(!e)return null;let t=null;for(const i of e.values())(!t||i.priority>t.priority)&&(t=i);return t}getFirstHighlightFromMap(e){if(e)for(const t of e.values())return t;return null}getFirstOccurrenceHighlightOfType(e){return this.getFirstHighlightFromMap(this.occurrenceHighlights.get(e))}getHighlightOperator(e){const t=e.getActiveHighlightType(),i=this.getFirstOccurrenceHighlightOfType(t);if(i)return e.applyStyle(i.getStyle()),null;const s=this.entityHighlightRanges.get(t);return s?(UE.setOperandA(s),UE):$I}getHighlightStyleOperator(e,t){if(!e.getActiveShader().hasAttribute(tE.HIGHLIGHT_ID)||!this.hasHighlight())return t;const i=HE;i.setDefaultStyle(WE);let s=null,n=null;const r=e.getActiveHighlightType(),a=e.getViewer().getReferenceHighlights().getSortedHighlights();for(let e=0;e<a.length;++e){const t=a[e].type;if(r&&t!==r)continue;const o=this.getFirstOccurrenceHighlightOfType(t);if(o){i.setDefaultStyle(o.getStyle()),s=null,n=null;continue}const h=this.entityHighlightRanges.get(t);if(h){const t=this.getUnionOperator(e,h);s||(s=t),n&&n.setOperand(t),n=t}}return i.setOverwriteOperand(s),t?GE.resetWithOperands(t,i):i}makeSceneDebugObject(e){const t=[],i=[];for(const e of this.entityHighlightRanges.values())i.push(e.makeSceneDebugObject());t.push({text:"entityHighlightRanges",children:i}),t.push({text:"entityHighlights",children:this.getEntityHighlightsDebugInfo()});const s=[];return this.occurrenceHighlights.forEach(((e,t)=>{const i=[];for(const t of e.keys())i.push({text:t.toString(),children:[]});s.push({text:t.toString(),children:i})})),t.push({text:"occurrenceHighlights",children:s}),{text:e,children:t}}getEntityHighlightsDebugInfo(){const e=[];return this.entityHighlights.forEach(((t,i)=>{const s=[];for(const e of t.keys()){const i=[],n=t.get(e);n.debugStack&&i.push({text:"Stack: "+n.debugStack}),s.push({text:e.toString(),children:i})}e.push({text:i.increment.id,children:s})})),e}}function XE(){UE=new bE,GE=new xr,HE=new VE,kE={}}class ZE extends _E.Y{constructor(){super(),this.iteratorA=null,this.currentARange=null,this.currentAOffset=-1,this.iteratorB=null,this.currentBRange=null,this.currentBOffset=-1}reset(e,t){return this.iteratorA=e,this.currentARange=null,this.currentAOffset=-1,this.iteratorB=t,this.currentBRange=null,this.currentBOffset=-1,this.nextResult=this.findNextRange(),this}findNextRange(){if(this.currentARange||(this.currentARange=this.iteratorA.getNextRange(),this.currentAOffset=-1),this.currentBRange||(this.currentBRange=this.iteratorB.getNextRange(),this.currentBOffset=-1),!this.currentARange&&!this.currentBRange)return null;const e=this.getStorageForNextResult();if(!this.currentARange){const t=this.currentBOffset>=0?this.currentBOffset:this.currentBRange[0];return e[0]=t,e[1]=this.currentBRange[1],e[2]=this.currentBRange[2],this.currentBRange=null,e}if(!this.currentBRange){const t=this.currentAOffset>=0?this.currentAOffset:this.currentARange[0];return e[0]=t,e[1]=this.currentARange[1],e[2]=this.currentARange[2],this.currentARange=null,e}const t=this.currentAOffset>=0?this.currentAOffset:this.currentARange[0],i=this.currentBOffset>=0?this.currentBOffset:this.currentBRange[0];return t<i?(e[0]=t,e[2]=this.currentARange[2],i<this.currentARange[1]?(e[1]=i,this.currentAOffset=i):(e[1]=this.currentARange[1],this.currentARange=null)):i<t?(e[0]=i,e[2]=this.currentBRange[2],t<this.currentBRange[1]?(e[1]=t,this.currentBOffset=t):(e[1]=this.currentBRange[1],this.currentBRange=null)):(e[0]=i,e[2]=this.currentBRange[2],this.currentARange[1]<this.currentBRange[1]?(e[1]=this.currentARange[1],this.currentBOffset=this.currentARange[1],this.currentARange=null):this.currentBRange[1]<this.currentARange[1]?(e[1]=this.currentBRange[1],this.currentAOffset=this.currentBRange[1],this.currentBRange=null):(e[1]=this.currentARange[1],this.currentARange=null,this.currentBRange=null)),e}}class qE{constructor(){this.operandA=null,this.operandB=null,this.iterator=new ZE}setOperandA(e){this.operandA=e}setOperand(e){this.operandB=e}getRangeIteratorForBufferSet(e){const t=this.operandA?this.operandA.getRangeIteratorForBufferSet(e):null,i=this.operandB?this.operandB.getRangeIteratorForBufferSet(e):null;return t||i?t?i?this.iterator.reset(t,i):t:i:null}makeSceneDebugObject(){const e={text:"StyleUnionOperator",children:[]};return(0,Fs.n9)(e,this.operandA),(0,Fs.n9)(e,this.operandB),e}}let YE=!1;function KE(){return YE}function jE(e){YE=e}const QE=[];function $E(e,t){let i=1/0,s=-1,n=1/0,r=-1;for(let t=0;t<QE.length;++t)QE[t].byteLength>=e&&QE[t].byteLength<n?(n=QE[t].byteLength,r=t):QE[t].byteLength<i&&(i=QE[t].byteLength,s=t);if(r>=0){const i=QE[r];return t&&(0,Fs.rS)(i,e),QE.splice(r,1),i}return s>=0&&QE.splice(s,1),new ArrayBuffer(e)}function JE(e){e&&QE.push(e)}class eS{constructor(e,t,i,s){this.viewer=e,this.target=i,this.componentCount=s,this.GAUGE_MEMORY_TYPE="Vertex buffer",this.scratchSpace=null,this.floatView=null,this.indexView=null,this.uint8View=null,this.initialCopyPerfomed=!1,this.rangesToCopy=[],this.gl=this.viewer.getGlContext(),this.size=t,this.webGlBuffer=this.gl.createBuffer(),this.webGlBuffer||ut.log.error("Failed to create gl buffer")}ensureScratchSpace(){if(!this.scratchSpace){const e=!this.initialCopyPerfomed;this.scratchSpace=$E(this.size,e)}}releaseScratchSpace(){this.scratchSpace&&!KE()&&(JE(this.scratchSpace),this.scratchSpace=null,this.floatView=null,this.indexView=null,this.uint8View=null)}destroy(){this.gl&&this.webGlBuffer&&this.gl.deleteBuffer(this.webGlBuffer),this.webGlBuffer&&this.viewer.getMemoryGauge().decrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.size),this.webGlBuffer=null}getComponentCount(){return this.componentCount}copyToGl(){if(!this.scratchSpace)return this.rangesToCopy.length>0&&ut.log.warn("Encountered buffer with ranges that need copying, but no scratch space to copy from"),!1;let e;return e=this.initialCopyPerfomed?this.copyPartialUpdatesToGl():this.copyWholeBufferToGl(),this.releaseScratchSpace(),e}copyWholeBufferToGl(){if(!this.webGlBuffer)return!1;this.gl.bindBuffer(this.target,this.webGlBuffer);const e=new DataView(this.scratchSpace,0,this.size);return this.gl.bufferData(this.target,e,this.gl.STATIC_DRAW),this.gl.bindBuffer(this.target,null),this.viewer.getMemoryGauge().incrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.size),this.initialCopyPerfomed=!0,this.rangesToCopy=[],!0}addRangeToCopyToGl(e,t){this.initialCopyPerfomed&&AI(e,t,this.rangesToCopy)}copyPartialUpdatesToGl(){if(this.rangesToCopy.length<1)return!1;this.gl.bindBuffer(this.target,this.webGlBuffer);for(let e=0;e<this.rangesToCopy.length;++e){const t=this.rangesToCopy[e],i=new Uint8Array(this.scratchSpace,t[0],t[1]-t[0]);this.gl.bufferSubData(this.target,t[0],i)}return this.gl.bindBuffer(this.target,null),this.rangesToCopy=[],!0}getSize(){return this.size}getFloatView(){return this.ensureScratchSpace(),this.floatView||(this.floatView=new Float32Array(this.scratchSpace,0,this.size/4)),this.floatView}getIndexView(e){if(this.ensureScratchSpace(),!this.indexView){const t=e===Uint32Array?4:2;this.indexView=new e(this.scratchSpace,0,this.size/t)}return this.indexView}getUint8View(){return this.ensureScratchSpace(),this.uint8View||(this.uint8View=new Uint8Array(this.scratchSpace,0,this.size)),this.uint8View}getGlBuffer(){return this.webGlBuffer}bind(){this.webGlBuffer?this.gl.bindBuffer(this.target,this.webGlBuffer):ut.log.warn("Attempting to bind a null gl buffer")}makeSceneDebugObject(e){const t=new e(this.scratchSpace),i=[];for(let e=0;e<t.length;++e)i.push(t[e].toString());return"["+i.join(", ")+"]"}}const tS=de.create();class iS{constructor(e,t){this.parent=e,this.occurrenceData=t,this.styledRanges=[],this.bounds=null,this.occurrenceData.addBoundable(this)}destroy(){for(let e=0;e<this.styledRanges.length;++e)this.styledRanges[e].destroy();this.occurrenceData.removeBoundable(this)}addStyledMeshRanges(e,t,i,s){const n=new jI(this,e,t,i,s);return this.styledRanges.push(n),n}removeAllChildrenForMeshGroup(e){return this.removeStyledMeshRangesForGroup(e)}removeStyledMeshRangesForGroup(e){const t=[];let i=!1;for(let s=0;s<this.styledRanges.length;++s){const n=this.styledRanges[s];n.getMeshRangesGroupId()===e?(i=!0,n.destroy()):t.push(n)}return this.styledRanges=t,i}get isEmpty(){return 0===this.styledRanges.length}draw(e){const t=e.getActiveShader();if(!t)return;if(!this.occurrenceData.isVisible(e)&&!e.getIsPickingHiddenOccurrences())return;if(!e.doesNodeOcccurrencePassFilter(this))return;if(e.activePassNeedsIsolationTest()&&e.activePassIsForIsolate()!==this.occurrenceData.getIsolated()&&!e.viewer.getIsolatedOccurrenceManager()?.isOccurrenceTranslucent(this.occurrenceData)&&(!e.viewer.getIsolatedOccurrenceManager()?.isInPickingMode()||!e.activePass.isPickPass()))return;let i=!1;const s=e.viewer.areOptimizedBuffersEnabled?1:0;for(let n=0;n<this.styledRanges.length;++n){const r=this.styledRanges[n];this.occurrenceData.isStyledRangeCulled(r,e)||(t.uniform1f("uUsePrimitiveLines",s),i||(this.pushGraphicsState(e,t),i=!0),this.occurrenceData.getShouldSetOccurrenceUniform()&&t.uniform1f("uMeshGroupIdHash",r.getMeshRangesGroupIdHash()),r.draw(e,this.occurrenceData))}i&&iS.popGraphicsState(e)}pushGraphicsState(e,t){iS.pushGraphicsState(e,t,this.occurrenceData,this.parent)}static pushGraphicsState(e,t,i,s){if(e.pushModelViewMatrix(ge.w$.multiply(e.getModelViewMatrix(),i.getTransform(),tS)),e.updateModelviewUniforms(),e.activePassIsForSectionPlaneEndcapMask()){const s=e.viewer.getIsolatedOccurrenceManager()?.isInIsolateOrMakeTransparentMode()&&!i.getIsolated();t.uniform1f("uOutsideIsolation",s?1:0)}i.getShouldSetOccurrenceUniform()&&t.uniform1f("uOccurrenceId",i.getOccurrenceId()),t.uniform1i("uClippedBySectionPlanes",s.getClippedBySectionPlanes()&&i.getIsClippedBySectionPlanes()?1:0);let n=e.isPicking()?s.getPickZOffset():s.getZOffset();e.getHasIsolate()&&!i.getIsolated()&&(n+=iS.NON_ISOLATED_Z_OFFSET_ADDITION),e.setZOffset(n)}static popGraphicsState(e){e.popModelViewMatrix()}damageBounds(){this.bounds&&this.bounds.reset(),this.parent.damageBounds()}addBounds(e,t){if(this.bounds||(this.bounds=new yi.kB),(this.occurrenceData.isBoundable()||t&&t.includeHiddenBounds)&&!this.bounds.isInitialized()){let e,t=!1;for(e=0;e<this.styledRanges.length;++e)if(this.styledRanges[e].isCheaplyBoundable()){const i=this.styledRanges[e].getBounds(this.occurrenceData,this.parent.getUsage());i.isInitialized()&&(this.bounds.addBox(i,this.occurrenceData.getTransform()),t=!0)}if(!t)for(e=0;e<this.styledRanges.length;++e)this.bounds.addBox(this.styledRanges[e].getBounds(this.occurrenceData,this.parent.getUsage()),this.occurrenceData.getTransform())}e.addBox(this.bounds,null,!0)}makeSceneDebugObject(e){const t="NodeOccurrence: (Occurrence id: "+this.occurrenceData.getOccurrenceId()+")",i=[this.occurrenceData.makeSceneDebugObject()];this.bounds&&i.push(this.bounds.makeSceneDebugObject());for(let e=0;e<this.styledRanges.length;++e)i.push(this.styledRanges[e].makeSceneDebugObject(this.occurrenceData));return{text:t,children:i,state:{opened:!0}}}parentHasTransparency(){return this.parent.hasTransparency()}}iS.NON_ISOLATED_Z_OFFSET_ADDITION=X.default.getManager().getNumber("NON_ISOLATED_Z_OFFSET_ADDITION");const sS=sE,nS=[sS.POINT,sS.NORMAL,sS.OFFSET_VECTOR,sS.COLOR,sS.TEXTURE,sS.POINT_DATA,sS.EDGE_DATA,sS.PRIMITIVE_SIZE,sS.PRIMITIVE_STYLE,sS.CONTACT_TRACTION,sS.CONTACT_PAIR_COORDINATE];class rS{constructor(e){this.parentMesh=e,this.vertexBuffer=null,this.indexBuffer=null,this.attributeBindings=null}getVertexBuffer(){return this.vertexBuffer}getIndexBuffer(){return this.indexBuffer}getParentMesh(){return this.parentMesh}setParentMesh(e){this.parentMesh=e}logInconsistency(e){rS.loggedInconsistency||(ut.log.warn(e),rS.loggedInconsistency=!0)}hasOptimizedBuffers(){return!1}getComponentCount(){return this.vertexBuffer?this.vertexBuffer.getComponentCount():0}isTriangleStrip(){return this.parentMesh.getPrimitiveType()===Di.MX.TRIANGLE_STRIP}reinitialize(){this.vertexBuffer=null,this.indexBuffer=null}areBuffersInitialized(){return(0,j.objectsDefinedInSameWay)(this.vertexBuffer,this.indexBuffer)||this.logInconsistency("BEL-56218, BEL-55900, BEL-56214 The vertex buffer and index buffer were initialized independently"),!!this.vertexBuffer&&!!this.indexBuffer}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null),this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=null)}bindBuffers(e,t,i,s,n){e.setLastBufferBound(this)}buffersNeedBinding(e){return e.getLastBufferBound()!==this}initializeAttributes(e,t,i){for(let t=0;t<nS.length;++t){const i=nS[t],s=this.attributeBindings[i.name];s?e.vertexAttribPointer(i.name,s):e.enableVertexAttribArray(i.name,!1)}}bindAttributeStateWithoutVAOs(e,t,i,s){e&&(this.bindBuffers(i,t,s,!0,!1),this.initializeAttributes(t,i,s))}copyBuffersToGl(){if(!this.vertexBuffer||!this.indexBuffer)return;let e=this.vertexBuffer.copyToGl();return e=this.indexBuffer.copyToGl()||e,e}}rS.loggedInconsistency=!1;const aS=0,oS=1,hS=[1/0,1/0,1/0],cS=8388608,lS=new nf(Ft.UNSIGNED_BYTE,4,0,0,!0);let uS=null;class dS{constructor(e,t,i,s){this.increment=e,this.bufferSet=s,this.vertexRange=t,this.indexRange=i,this.pickId=e?.pickId}}let gS=1;function pS(){return gS++}let mS=0;class fS extends rS{constructor(e,t=!1){super(e),this.isForPrecompiledIncrements=t,this.lineStripIndexBuffer=null,this.pickIdBuffers=[],this.indexRangesToDelete=[],this.pendingFreeSpace=[[],[]],this.freeSpace=[[],[]],this.incrementDeletionListeners=null,this.shaderIdToVAOs=new Map,this.initialVertexCount=t?0:1,this.initialIndexCount=t?0:this.getDefaultIndexCount(),this.incrementsToBuffer=new gl.TemplatedCountedMap,this.increments=new gl.TemplatedCountedMap,this.debugId=mS++}clone(e){const t=new fS(e);if(t.increments.insertCountedMap(this.increments),this.attributeBindings){t.attributeBindings={};for(const e in this.attributeBindings)this.attributeBindings[e]&&(t.attributeBindings[e]=this.attributeBindings[e].clone())}t.initialVertexCount=this.initialVertexCount,t.initialIndexCount=this.initialIndexCount;for(let e=0;e<this.freeSpace[aS].length;++e)t.freeSpace[aS].push(this.freeSpace[aS][e].slice(0));for(let e=0;e<this.freeSpace[oS].length;++e)t.freeSpace[oS].push(this.freeSpace[oS][e].slice(0));return t.markAllIncrementsForBuffering(),t.updateBuffers({forClone:!0}),t}markAllIncrementsForBuffering(){this.incrementsToBuffer.insertCountedMap(this.increments)}getIsForPrecompiledIncrements(){return this.isForPrecompiledIncrements}destroy(){if(super.destroy(),this.lineStripIndexBuffer&&(this.lineStripIndexBuffer.destroy(),this.lineStripIndexBuffer=null),this.pickIdBuffers){for(let e=0;e<this.pickIdBuffers.length;++e)this.pickIdBuffers[e].destroy();this.pickIdBuffers=[]}if(this.parentMesh.viewer.areVertexArrayObjectsAvailable){for(const[e,t]of this.shaderIdToVAOs)this.parentMesh.viewer.getVertexArrayExtension().deleteVertexArrayOES(t);this.shaderIdToVAOs.clear()}}getDebugId(){return this.debugId.toString()}addIncrementDeletionListener(e){this.incrementDeletionListeners||(this.incrementDeletionListeners={}),this.incrementDeletionListeners[e.getListenerId()]=e}removeIncrementDeletionListener(e){this.incrementDeletionListeners&&delete this.incrementDeletionListeners[e.getListenerId()]}triggerDeletedListeners(e){if(e&&this.incrementDeletionListeners)for(const t in this.incrementDeletionListeners)this.incrementDeletionListeners[t].onIncrementDeleted(e)}getDefaultIndexCount(){return!this.isForPrecompiledIncrements&&this.isTriangleStrip()?1:0}getUsedVertexCount(){let e=0;return this.increments.each((function(t){return e+=t.increment.points.length/3,!1}),this),e}addFreeSpace(e,t,i,s){AI(t,i,s?this.pendingFreeSpace[e]:this.freeSpace[e])}incorporatePendingFreeSpace(){for(let e=0;e<this.pendingFreeSpace.length;++e){const t=this.pendingFreeSpace[e],i=this.freeSpace[e];for(let e=0;e<t.length;++e)yI(t[e],i);t.splice(0,t.length)}}findFreeSpace(e,t){for(let i=0;i<this.freeSpace[e].length;++i){const s=this.freeSpace[e][i];if(s[1]-s[0]>=t)return s[0]}return-1}markFreeSpaceUsed(e,t,i){OI([t,t+i],this.freeSpace[e])}getLastUsedIndex(){const e=this.freeSpace[oS][this.freeSpace[oS].length-1],t=this.indexBuffer.getComponentCount();return e&&e[1]===t?e[0]:t}reinitialize(){super.reinitialize(),this.lineStripIndexBuffer=null,this.pickIdBuffers=[],this.markAllIncrementsForBuffering(),this.updateBuffers({forReinitialize:!0}),this.shaderIdToVAOs=new Map}getIncrement(e){const t=this.increments.get(e);return t?t.increment:null}incorporateIncrement(e){if(!e||!e.getFullId())return null;let t,i;const s=e.getPreparedVertexCount(),n=e.getPreparedIndexCount(),r=this.findFreeSpace(aS,s),a=this.findFreeSpace(oS,n);if(r>=0&&a>=0)t=[r,r+s],i=[a,a+n],this.markFreeSpaceUsed(aS,r,s),this.markFreeSpaceUsed(oS,a,n);else if(!this.areBuffersInitialized()){const r=ai(),a=this.initialVertexCount+s<=r;!a&&e.isPrecompiledBuffer&&ut.log.warn(`USE_DISPLAY_DATA_GPU_BUFFERS error: Cannot fit increment id ${e.getFullId()} with vertexCount ${s} into BufferSet with maximum vertices per VBO ${r}`);const o=(this.initialVertexCount+s)*this.parentMesh.vertexSize,h=o<=cS,c=this.initialIndexCount===this.getDefaultIndexCount();if(o>268435456){const t=fS.mapOwnerIdToMaxSingleIncrementWarningsShownCount.get(e.ownerId)??1;t<=5&&(ut.log.warn(`Warning ${t}/5: size exceeds safe limit for single mesh increment with id ${e.getFullId()} and size ${o}`),fS.mapOwnerIdToMaxSingleIncrementWarningsShownCount.set(e.ownerId,t+1))}a&&(h||c)&&(t=[this.initialVertexCount,this.initialVertexCount+s],i=[this.initialIndexCount,this.initialIndexCount+n],this.initialVertexCount+=s,this.initialIndexCount+=n)}if(t&&i){const s=new dS(e,t,i,this);return this.incrementsToBuffer.insert(e.getFullId(),s),this.increments.insert(e.getFullId(),s),s}return null}getIncrementDetails(e){return this.increments.get(e)||null}deleteIncrement(e){const t=this.increments.get(e);return t&&(this.addFreeSpace(aS,t.vertexRange[0],t.vertexRange[1],!1),this.addFreeSpace(oS,t.indexRange[0],t.indexRange[1],!0),yI(t.indexRange,this.indexRangesToDelete),this.increments.remove(e)),this.incrementsToBuffer.remove(e),this.triggerDeletedListeners(t),t||null}hasBufferUpdates(){return!this.incrementsToBuffer.isEmpty()||this.indexRangesToDelete.length>0}updateBuffers(e){this.areBuffersInitialized()||this.initializeBuffers(e),this.processDeletedRanges(),this.processNewIncrements();const t=this.copyBuffersToGl();return this.incorporatePendingFreeSpace(),t}validateBufferIndices(e){if(!KE())return void ut.log.warn("Can only validate index buffers when getTestingBuffers is true");const t=this.vertexBuffer.getUint8View(),i=this.indexBuffer.getIndexView(si());for(const s in this.attributeBindings){const n=this.attributeBindings[s],r=n.elementCount*Bt(n.type);e||(e=[0,i.length]);for(let a=e[0];a<e[1];++a){const e=i[a];if(n.offset+e*(n.stride+r)+r>t.length){ut.log.warn("Found inconsistency in buffer set "+this.debugId+" for attribute "+s);break}}}}copyBuffersToGl(){let e=super.copyBuffersToGl();this.lineStripIndexBuffer&&(e=this.lineStripIndexBuffer.copyToGl()||e);for(let t=0;t<this.pickIdBuffers.length;++t)e=this.pickIdBuffers[t].copyToGl()||e;return e}initializeBuffers(e){if(this.areBuffersInitialized())return;const t=this.parentMesh.viewer,i=t.getGlContext();let s,n=this.initialVertexCount,r=this.initialIndexCount;const a=e&&e.forClone,o=e&&e.forReinitialize;if(this.parentMesh.bufferAllocationPolicy===$f.MAXIMUM&&this.parentMesh.vertexSize>0){const e=Math.floor(cS/this.parentMesh.vertexSize);n=Math.max(n,e);const t=Math.ceil(1.5*n);r=Math.max(r,t)}else if(this.parentMesh.bufferAllocationPolicy===$f.MEDIUM)n=Math.max(n,512),r=Math.max(r,2048);else if(this.isForPrecompiledIncrements&&this.parentMesh.bufferAllocationPolicy===$f.MINIMUM&&1===this.increments.size()){const e=this.increments.get(this.increments.firstKey()).increment;n=e.getPreparedVertexCount(),r=e.getPreparedIndexCount()}if(this.vertexBuffer=new eS(t,n*this.parentMesh.vertexSize,i.ARRAY_BUFFER,n),this.indexBuffer=new eS(t,r*ri(),i.ELEMENT_ARRAY_BUFFER,r),!this.isForPrecompiledIncrements){this.initialVertexCount<n&&!a&&!o&&this.addFreeSpace(aS,this.initialVertexCount,n,!1);const e=this.vertexBuffer.getFloatView();for(s=0;s<sS.POINT.dimension;++s)e[s]=hS[s];this.initialIndexCount<r&&!a&&!o&&this.addFreeSpace(oS,this.initialIndexCount,r,!1);const h=this.indexBuffer.getIndexView(si());for(s=0;s<this.getDefaultIndexCount();++s)h[s]=0;this.isTriangleStrip()&&(this.lineStripIndexBuffer=new eS(t,r*ri(),i.ELEMENT_ARRAY_BUFFER,r),function(e,t){const i=e.getGlContext();uS||(uS=new nf(i.FLOAT,1,0,0)),(!e.getResources().primitiveRestartBuffer||e.getResources().primitiveRestartBuffer.getComponentCount()<t)&&(e.getResources().primitiveRestartBuffer=new eS(e,4*t,i.ARRAY_BUFFER,t),e.getResources().primitiveRestartBuffer.getFloatView()[0]=16384,e.getResources().primitiveRestartBuffer.copyToGl())}(t,r))}this.pickIdBuffers=[]}processDeletedRanges(){for(let e=0;e<this.indexRangesToDelete.length;++e){const t=this.indexRangesToDelete[e],i=t[1]-t[0],s=t[0],n=this.indexBuffer.getIndexView(si());for(let e=t[0];e<t[1];++e)n[e]=0;this.isTriangleStrip()&&this.updateLineStripIndices(t),this.indexBuffer.addRangeToCopyToGl(s*ri(),(s+i)*ri())}this.indexRangesToDelete=[]}updateLineStripIndices(e){if(!this.isTriangleStrip()||this.isForPrecompiledIncrements)return;if(!this.lineStripIndexBuffer)return void ut.log.warn("Did not find line strip index buffer for triangle strip");const t=this.indexBuffer.getIndexView(si()),i=this.lineStripIndexBuffer.getIndexView(si());let s=!1,n=0;i[e[0]]=0;for(let r=e[0]+1;r<e[1]-1;++r)s?(t[r]!==t[r-1]?++n:n=0,2===n&&(s=!1,i[r-2]=t[r-2],i[r-1]=t[r-1])):t[r]===t[r-1]&&(s=!0,n=0),i[r]=s?0:t[r];i[e[1]-1]=0,this.lineStripIndexBuffer.addRangeToCopyToGl(e[0]*ri(),e[1]*ri())}processNewIncrements(){this.incrementsToBuffer.each(((e,t)=>(e.increment.isPreparedForBuffering()||e.increment.prepareForBuffering(),this.copyIncrementVertices(e.increment,e.vertexRange),this.copyIncrementPickIds(e,e.vertexRange),this.copyIncrementIndices(e.increment,e.indexRange,e.vertexRange),!1))),this.incrementsToBuffer.clear()}replicateAttributeValue(e,t,i,s){if(e.elementCount!==s.length)return void ut.log.warn("An attempt was made to update a vertex attribute with a value with the wrong dimension");const n=t/e.typeSize(),r=n+i[0]*e.elementCount,a=n+i[1]*e.elementCount,o=e.type===Ft.FLOAT?this.vertexBuffer.getFloatView():this.vertexBuffer.getUint8View();for(let t=r;t<a;t+=e.elementCount)o.set(s,t)}copyIncrementVertices(e,t){const i=this.vertexBuffer.getComponentCount(),s=this.vertexBuffer.getFloatView(),n=this.vertexBuffer.getUint8View(),r=e.vertexCount(),a=t[0];let o=0,h=0,c=0,l=!1;this.attributeBindings||(this.attributeBindings={},l=!0);for(let t=0;t<nS.length;++t){const u=nS[t];let d=!1;e.hasAsAVertexAttribute(u)?d=!0:e[u.incrementProperty]&&(u.type===Ft.FLOAT?s.set(e[u.incrementProperty],o+u.elementCount*a):n.set(e[u.incrementProperty],h+u.elementCount*a),d=!0),l&&d&&(this.attributeBindings[u.name]=new nf(+u.type,u.dimension,c,0,u.normalize,u.secondDimension),c+=u.sizeInBytes()*i),d&&(this.vertexBuffer.addRangeToCopyToGl(h+a*u.sizeInBytes(),h+(a+r)*u.sizeInBytes()),h+=u.sizeInBytes()*i,o+=u.sizeInBytes()/4*i)}}updateIncrementAttribute(e,t,i){if(this.areBuffersInitialized()||this.updateBuffers(),this.isForPrecompiledIncrements)return void ut.log.debug("Not supporting updating increment attributes for buffersets with precompiled increments.");const s=this.increments.get(t);if(!s)return void ut.log.warn("Increment was not found in updateIncrementAttribute");const n=this.attributeBindings[e.name];n?(this.replicateAttributeValue(e,n.offset,s.vertexRange,i),this.vertexBuffer.addRangeToCopyToGl(n.offset+s.vertexRange[0]*e.sizeInBytes(),n.offset+s.vertexRange[1]*e.sizeInBytes())):ut.log.warn("An attempt was made to update an attribute that did not have a binding")}copyIncrementPickIds(e,t){const i=e.pickId;if((0,Si.rp)(i)){this.parentMesh.viewer.notifyOfPickPassCount(i.length);for(let e=0;e<i.length;++e){let s=this.pickIdBuffers[e];s||(this.pickIdBuffers[e]=s=new eS(this.parentMesh.viewer,4*this.vertexBuffer.getComponentCount(),this.parentMesh.viewer.getGlContext().ARRAY_BUFFER,this.vertexBuffer.getComponentCount()));const n=s.getUint8View(),r=(0,Fs.fA)(i[e]);for(let e=t[0];e<t[1];++e)n.set(r,4*e);s.addRangeToCopyToGl(4*t[0],4*t[1])}}}copyIncrementIndices(e,t,i){if(!this.indexBuffer)return;const s=this.indexBuffer.getIndexView(si());if(e.isPrecompiledBuffer)return void s.set(e.indices,0);let n=0;this.isTriangleStrip()&&(s[t[0]]=i[0]+e.indices[n],n=1);let r=0;for(r=0;r<e.indices.length;++r)s[t[0]+r+n]=i[0]+e.indices[r];if(this.isTriangleStrip()){const n=i[0]+e.indices[e.indices.length-1];for(;r<e.indexLengthWithDegenerates();++r)s[t[0]+r]=n;this.updateLineStripIndices(t)}this.indexBuffer.addRangeToCopyToGl(t[0]*ri(),t[1]*ri())}bindBuffers(e,t,i,s,n){super.bindBuffers(e,t,i,s,n),s&&this.vertexBuffer.bind();let r=this.indexBuffer;e.getPickPrimitiveAlternates()&&i&&(r=this.lineStripIndexBuffer),r.bind(),n&&e.isPicking()&&e.getPickPassIteration()>=0&&(this.pickIdBuffers[e.getPickPassIteration()]?this.pickIdBuffers[e.getPickPassIteration()].bind():t.vertexAttrib4fv(tE.PICKING,Fs.o0))}initializeAttributes(e,t,i){super.initializeAttributes(e,t,i),t.isPicking()&&t.getPickPassIteration()>=0?this.pickIdBuffers[t.getPickPassIteration()]?(this.pickIdBuffers[t.getPickPassIteration()].bind(),e.vertexAttribPointer(tE.PICKING,lS)):e.vertexAttrib4fv(tE.PICKING,Fs.o0):e.enableVertexAttribArray(tE.PICKING,!1),t.getPickPrimitiveAlternates()&&i?(this.parentMesh.viewer.getResources().primitiveRestartBuffer.bind(),e.vertexAttribPointer(tE.PRIMITIVE_RESTART,uS)):e.enableVertexAttribArray(tE.PRIMITIVE_RESTART,!1)}bindAttributeStateWithVAOs(e,t,i,s){let n=t.getNumericId();i.getPickPassIteration()>0&&(n=1e3*n+i.getPickPassIteration());let r=this.shaderIdToVAOs.get(n);e?r?(this.parentMesh.viewer.bindVao(r),this.bindBuffers(i,t,s,!1,!0)):(r=this.parentMesh.viewer.getVertexArrayExtension().createVertexArrayOES(),this.shaderIdToVAOs.set(n,r),this.parentMesh.viewer.bindVao(r),this.bindAttributeStateWithoutVAOs(e,t,i,s)):this.parentMesh.viewer.bindVao(r)}draw(e,t){this.drawRanges(e,t)}drawRanges(e,t){if(this.parentMesh.compileBuffers(e),!this.attributeBindings)return;if(!this.areBuffersInitialized())return void this.logInconsistency("BEL-53632 BufferSet.prototype.draw without initialized buffers");const i=t.getRangeIteratorForBufferSet(this);if(!i||!i.hasMoreRanges())return;const s=e.getActiveShader(),n=this.parentMesh.viewer.getGlContext(),r=this.isTriangleStrip(),a=e.getPickPrimitiveAlternates()?this.parentMesh.getAlternatePrimitiveMode():this.parentMesh.getPrimitiveMode(),o=this.buffersNeedBinding(e);this.parentMesh.viewer.areVertexArrayObjectsAvailable?this.bindAttributeStateWithVAOs(o,s,e,r):this.bindAttributeStateWithoutVAOs(o,s,e,r);let h=0,c=0;for(;i.hasMoreRanges();){const t=i.getNextRange();if(!t)continue;let s=t[0],o=t[1]-t[0];1&s&&r&&(o-=1,s+=1),o<3&&r||(e.applyStyle(t[2]),n.drawElements(a,o,ni(),s*ri()),h++,c+=o,e.getPickPrimitiveAlternates()&&r&&n.drawElements(n.POINTS,o,ni(),s*ri()))}this.parentMesh.incrementStatisticsForCall(c,h)}makeSceneDebugObject(){const e={};if(this.increments.isEmpty())return e;this.markAllIncrementsForBuffering(),this.processNewIncrements(),e.vertexBuffer=this.vertexBuffer.makeSceneDebugObject(Uint8Array),e.indexBuffer=this.indexBuffer.makeSceneDebugObject(si()),this.lineStripIndexBuffer&&(e.lineStripIndexBuffer=this.lineStripIndexBuffer.makeSceneDebugObject(si())),e.pickIdBuffers=[];for(let t=0;t<this.pickIdBuffers.length;++t)e.pickIdBuffers.push(this.pickIdBuffers[t].makeSceneDebugObject(Uint32Array));return this.copyBuffersToGl(),e}addGroupIncrementsToBounds(e,t,i,s){this.increments.each((function(n){const r=n.increment;return r.groupId===e&&r.ownerId===t&&r.lod===i&&s.addBox(r.getBounds()),!1}),this)}}fS.mapOwnerIdToMaxSingleIncrementWarningsShownCount=new Map;class IS extends _E.Y{constructor(){super(),this.minuendRangeIterator=null,this.currentMinuendRange=null,this.minuendSubRangeStart=-1,this.subtrahendRangeIterator=null,this.currentSubtrahendRange=null}reset(e,t){this.minuendRangeIterator=e,this.currentMinuendRange=null,this.minuendSubRangeStart=-1,this.subtrahendRangeIterator=t,this.currentSubtrahendRange=null,this.nextResult=this.findNextRange()}findNextRange(){if(this.currentMinuendRange||(this.currentMinuendRange=this.minuendRangeIterator.getNextRange()),!this.currentMinuendRange)return null;for(;this.subtrahendIsBehind();)this.currentSubtrahendRange=this.subtrahendRangeIterator.getNextRange();const e=this.getStorageForNextResult();if(!this.currentSubtrahendRange||this.currentSubtrahendRange[0]>this.currentMinuendRange[1])e[0]=this.minuendSubRangeStart>=0?this.minuendSubRangeStart:this.currentMinuendRange[0],e[1]=this.currentMinuendRange[1],e[2]=this.currentMinuendRange[2],this.currentMinuendRange=null,this.minuendSubRangeStart=-1;else{const t=this.minuendSubRangeStart>=0?this.minuendSubRangeStart:this.currentMinuendRange[0];if(this.currentSubtrahendRange[0]<=t)return this.currentSubtrahendRange[1]>=this.currentMinuendRange[1]?(this.currentMinuendRange=null,this.minuendSubRangeStart=-1):this.minuendSubRangeStart=this.currentSubtrahendRange[1],this.findNextRange();e[0]=t,e[1]=this.currentSubtrahendRange[0],e[2]=this.currentMinuendRange[2],this.currentSubtrahendRange[1]>=this.currentMinuendRange[1]?(this.currentMinuendRange=null,this.minuendSubRangeStart=-1):this.minuendSubRangeStart=this.currentSubtrahendRange[1]}return e}subtrahendIsBehind(){if(this.currentSubtrahendRange){const e=this.minuendSubRangeStart>=0?this.minuendSubRangeStart:this.currentMinuendRange[0];return this.currentSubtrahendRange[1]<=e}return this.subtrahendRangeIterator.hasMoreRanges()}}class ES extends wE{constructor(e,t,i,s){super(),this.groupId=e,this.ownerId=t,this.primitiveType=i,this.lod=s,this.bounds=null}getOwnerId(){return this.ownerId}getMeshGroupId(){return this.groupId}cloneForPreview(){const e=new ES(this.groupId,this.ownerId,this.primitiveType,this.lod);return this.copyDataTo(e),e.setListenForDeletions(!0),e.setBounds(this.bounds),e}onIncrementDeleted(e){e.increment.groupId===this.groupId&&e.increment.ownerId===this.ownerId&&this.onIncrementRemoved(e)}makeSceneDebugObject(e){const t=e?this.shouldDrawForOccurrences(e):void 0,i="Group ranges: (ownerId: "+this.ownerId+", groupId: "+this.groupId+", primitiveType: "+(0,Di.E1)(this.primitiveType)+", lod: "+this.lod+", shouldDrawForOccurrence: "+t+", listenForDeletions: "+this.listenForDeletions+")",s=this.getChildSceneDebugObjects();return this.bounds&&s.push(this.bounds.makeSceneDebugObject()),{text:i,children:s,state:{opened:t}}}isCheaplyBoundable(){return this.lod===nE.LOWEST}damageBounds(){this.bounds=null,wE.prototype.damageBounds.apply(this,[...arguments])}setBounds(e){this.bounds=e}getBounds(e,t){if(!this.bounds){this.bounds=new yi.kB;const e=this.bufferSetRanges.getKeyValues();for(let t=0;t<e.length;t+=2){e[t].addGroupIncrementsToBounds(this.groupId,this.ownerId,this.lod,this.bounds)}}return this.bounds}shouldDrawForOccurrences(e){return e.getLod()===this.lod}getPrimitiveCount(){let e=0;const t=this.bufferSetRanges.getKeyValues();for(let i=0;i<t.length;i+=2){const s=t[i+1];for(let t=0;t<s.length;++t){const i=s[t];this.primitiveType===Di.MX.TRIANGLE_STRIP?e+=i[1]-i[0]-2:this.primitiveType===Di.MX.TRIANGLES?e+=(i[1]-i[0])/3:this.primitiveType===Di.MX.SILHOUETTES&&(e+=(i[1]-i[0])/6)}}return e}}class SS extends wE{constructor(e,t){super(),this.debugId=e,this.sourceMeshGroupId=t,this.incrementDetails=new Set}clone(){const e=new SS(this.debugId,this.sourceMeshGroupId);return e.incrementDetails=new Set(this.incrementDetails),this.copyDataTo(e),e}getMeshGroupId(){return this.sourceMeshGroupId}makeSceneDebugObject(){let e="",t=!0;this.incrementDetails.forEach((function(i){t||(e+=","),t=!1,e+=i.increment.getFullId()}));return{text:"Increment ranges "+this.debugId+": (incrementIds: ["+e+"], listenForDeletions: "+this.listenForDeletions+")",children:this.getChildSceneDebugObjects()}}isEmpty(){return 0===this.incrementDetails.size}containsIncrement(e){return this.incrementDetails.has(e)}onIncrementAdded(e,t){if(this.incrementDetails.has(e)&&!t)return!1;this.incrementDetails.add(e);const i=wE.prototype.onIncrementAdded.apply(this,[...arguments]);return this.listenForDeletions&&e.bufferSet.addIncrementDeletionListener(this),i}onIncrementRemoved(e){if(!this.incrementDetails.has(e))return!1;this.incrementDetails.delete(e);const t=wE.prototype.onIncrementRemoved.apply(this,[...arguments]);return this.listenForDeletions&&!this.bufferSetRanges.has(e.bufferSet)&&e.bufferSet.removeIncrementDeletionListener(this),t}getListenerId(){return this.listenerId}onIncrementDeleted(e){this.onIncrementRemoved(e)}getBounds(e,t){const i=new yi.kB;return this.incrementDetails.forEach((s=>{e.isIncrementBoundable(s,t)&&i.addBox(s.increment.getBounds())})),i}}class TS{constructor(e){this.subtractMeshRanges=e}getRangeIteratorForBufferSet(e){return SS.prototype.getRangeIteratorForBufferSet.call(this.subtractMeshRanges,e)}makeSceneDebugObject(){const e={text:"SubtractMeshRangeIncrementProvider",children:[]};return(0,Fs.n9)(e,this.subtractMeshRanges),e}}class DS extends SS{constructor(e){super(e),this.subtractOperator=new OS,this.subtractOperator.setSubtrahend(new TS(this)),this.setListenForDeletions(!0)}setOperand(e){this.subtractOperator.setOperand(e)}getRangeIteratorForBufferSet(e){return this.subtractOperator.getRangeIteratorForBufferSet(e)}}const MS=new Mi;function CS(e){MS.reset(),MS.addNumber(e.getPrimitiveType(),Di.ip);for(const t in sE)MS.addBoolean(e.hasAttribute(t));return MS.addBoolean(e.isAPrecompiledBuffer()),MS.getId()}let yS=1;function PS(){const e=yS.toString();return++yS,e}class AS{constructor(e,t){this.viewer=e,this.meshCreationOptions=t,this.meshes={},this.incrementIdToMesh=new Map,this.groupRanges={},this.ownsMeshes=!0}destroy(){if(this.ownsMeshes)for(const e in this.meshes)this.meshes[e].destroy();for(const e in this.groupRanges)this.groupRanges[e].destroy()}cloneForPreview(e){const t=new AS(this.viewer,this.meshCreationOptions);t.ownsMeshes=!1,t.meshes=(0,z.Z)(this.meshes),t.incrementIdToMesh=new Map(this.incrementIdToMesh);for(const i in this.groupRanges){this.groupRanges[i].getOwnerId()===e&&(t.groupRanges[i]=this.groupRanges[i].cloneForPreview())}return t}addMeshIncrement(e,t,i){this.removeMeshIncrement(e.id,t),e.ownerId=t;const s=CS(e);let n=this.meshes[s];if(!n){const t=e.isPrecompiledBuffer?{bufferAllocationPolicy:$f.MINIMUM}:this.meshCreationOptions;this.meshes[s]=n=new nI(this.viewer,t)}const r=n.addIncrement(e);if(r){this.incrementIdToMesh.set(e.getFullId(),n);const t=this.getGroupRangesForIncrement(e);t&&(t.onIncrementAdded(r),i&&t.setBounds(i))}return r}getIncrementDetails(e,t){const i=dE(e,t),s=this.incrementIdToMesh.get(i);return s?s.getIncrementDetails(i):null}removeMeshIncrement(e,t){const i=dE(e,t),s=this.incrementIdToMesh.get(i);let n=null;if(s){if(n=s.deleteIncrement(i),n){const e=this.getGroupRangesForIncrement(n.increment);e&&e.onIncrementRemoved(n)}this.incrementIdToMesh.delete(i)}return n}getGroupRangesForIncrement(e){return e.groupId?this.getOrCreateGroupRangesForGroupTypeAndLod(e.groupId,e.ownerId,e.primitiveType,e.lod):null}getGroupRangesId(e,t,i,s){return e+"."+t+"."+i+"."+s}getOrCreateGroupRangesForGroupTypeAndLod(e,t,i,s){const n=this.getGroupRangesId(e,t,i,s);let r=this.groupRanges[n];return r||(this.groupRanges[n]=r=new ES(e,t,i,s)),r}getGroupRangesForGroupTypeAndLod(e,t,i,s){const n=this.getGroupRangesId(e,t,i,s);return this.groupRanges[n]||null}removeEmptyMeshes(){const e=[];let t=null;for(t in this.meshes)this.meshes[t].isEmpty()&&e.push(t);for(let i=0;i<e.length;++i)t=e[i],this.meshes[t].destroy(),delete this.meshes[t]}getMeshForIncrement(e){return this.meshes[CS(e)]||null}compileBuffers(){const e=new Qo.B7("MeshManager: Compiling Vertex Buffers");for(const e in this.meshes)this.meshes[e].compileBuffers();e.report()}}class OS{constructor(){this.minuend=null,this.subtrahend=null,this.resultIterator=new IS}setOperand(e){this.minuend=e}setSubtrahend(e){this.subtrahend=e}getRangeIteratorForBufferSet(e){if(!this.minuend||!this.subtrahend)return ut.log.info("SubtractOperator.getRangeIteratorForBufferSet should be called with subtrahend and minuend"),null;const t=this.minuend.getRangeIteratorForBufferSet(e);if(!t)return null;const i=this.subtrahend.getRangeIteratorForBufferSet(e);return i?(this.resultIterator.reset(t,i),this.resultIterator):t}makeSceneDebugObject(e){const t={text:"SubtractOperator",children:[]};return(0,Fs.n9)(t,this.minuend),(0,Fs.n9)(t,this.subtrahend),t}}var vS=i(65026),RS=i(65688),wS=i(16120),_S=i(84813),NS=i(8473),bS=i(68386),LS=i(64113),FS=i(99972),xS=i(83199),BS=i(16153),VS=i(35692);const US=i(98902),GS=1600,HS=1200,kS=new Set([k.P1.DRAFT_ANALYSIS,k.P1.THICKNESS_ANALYSIS_VISUALIZATION]);FS.ZR(Array);{const e=window;e.vec2=Q,e.vec3=C,e.vec4=y,e.mat2=BS,e.mat3=sh,e.mat4=de,e.quat4=Gs}let WS=0;function zS(e,t){return Math.floor(e*t)}if(window.matchMedia){window.matchMedia("print").addListener((function(e){e.matches?(0,oi.lp)():(0,oi.py)()}))}window.onbeforeprint=oi.lp,window.onafterprint=oi.py;const XS=X.default.getManager();class ZS{constructor(e){this.elementId=e,this.camera=null,this.userEnabledAggressiveRefinement=!1,this.activeSectionPlanes=[],this.zebraStripeCount=XS.getNumber("ZEBRA_STRIPE_COUNT"),this.zebraStripeRotation=XS.getNumber("ZEBRA_STRIPE_ROTATION"),this.zebraStripeEdgesOn=!0,this.renderingMode=k.P1.SHADED_WITH_EDGES,this.smoothEdgeStyle=k.YUG.VISIBLE}}var qS;!function(e){e[e.VIEWER_DESTROYED=-1]="VIEWER_DESTROYED",e[e.WAITING_FOR_DISPLAY_DATA=0]="WAITING_FOR_DISPLAY_DATA",e[e.WAITING_FOR_COMPARE_DISPLAY_DATA=1]="WAITING_FOR_COMPARE_DISPLAY_DATA",e[e.LOADING_DISPLAY_DATA=2]="LOADING_DISPLAY_DATA",e[e.LOADED_DISPLAY_DATA=3]="LOADED_DISPLAY_DATA",e[e.LOADED_ALL_DATA=4]="LOADED_ALL_DATA"}(qS||(qS={}));const YS={performFrameTiming:!0},KS={performFrameTiming:!1};let jS={antialias:!0,depth:!0,stencil:!0,preserveDrawingBuffer:!0,powerPreference:"high-performance"};const QS=localStorage.getItem("osWebGlContextOptions");if(QS)try{ut.log.info("Using custom set of WebGL context options: "+QS),jS=JSON.parse(QS)}catch(e){ut.log.warn("Failed to use custom WebGL context options: "+QS)}const $S={},JS=new Set([k.P1.SIMULATION_RESULTS,k.P1.SHADED_CURVATURE_VISUALIZATION,k.P1.THICKNESS_ANALYSIS_VISUALIZATION]);class eT extends vS.View{resetTranslucentModeValues(){const e=X.default.getManager();this.translucentModeFaceModeOpacity=e.getNumber("ISOLATE_TRANSLUCENT_MODE_FACE_OPACITY"),this.translucentModeEdgeOpacity=e.getNumber("ISOLATE_TRANSLUCENT_MODE_EDGE_OPACITY"),this.translucentModeEdgeColorBodyColorFactor=e.getNumber("ISOLATE_TRANSLUCENT_MODE_EDGE_COLOR_BODY_COLOR_FACTOR")}constructor(e){super(e),this.viewerPreferences=new xS.g,this.shouldUpdatePairedViewer=!1,this.scalarRetrievalPasses=[],this.hasMouseOver=!1,this.boundVAO=null,this.areOptimizedBuffersEnabled_=void 0,this.loggedPickIssue=!1,this.renderModeSubject=new Is.x,this.isBrowserTabVisible="visible"===document.visibilityState,this.debugCamera=null,this.isSynchingView=!0,this.themeChangeSubscription=null,this.followGraphicsData=new k.xzX,this.followGraphicsDataSubject=new Is.x,this.resetTranslucentModeValues(),WS=X.default.getManager().getNumber("PICK_WINDOW_PREVENT_CULL_MARGIN_PIXELS"),this.followGraphicsData.zebraStripeCount=XS.getNumber("ZEBRA_STRIPE_COUNT"),this.followGraphicsData.zebraStripeRotation=XS.getNumber("ZEBRA_STRIPE_ROTATION")}get areOptimizedBuffersEnabled(){return void 0===this.areOptimizedBuffersEnabled_&&(this.areOptimizedBuffersEnabled_=Ki.Jq.CapabilitiesService.checkDebugCurrentlyEnabled()&&"true"===localStorage.getItem("osForceEnableGPUBuffers")||Ki.Jq.CapabilitiesService.checkUseDisplayDataGPUBuffersCurrentlyEnabled()),this.areOptimizedBuffersEnabled_}bindVao(e){this.boundVAO!==e&&(this.getVertexArrayExtension().bindVertexArrayOES(e),this.boundVAO=e)}initialize(e){if(this.eventDispatcher=new yD.pB,this.gl=null,this.requestDraw=this.requestDrawUsingTimer,window.requestAnimationFrame&&(this.requestDraw=this.requestDrawUsingAnimationFrame),this.timeOfContextLoss=null,this.extensions={},this.highlightVertexTexturesSupported=null,this.SSAOFilteringSupported=null,this.highPrecisionSupportedInFragmentShader=null,this.hidden=!1,this.readyState=!1,this.isForFlattenedDisplay=e&&!!e.isForFlattenedDisplay,this.isForPreviousVersionDisplay=e&&!!e.isForPreviousVersionDisplay,this.renderContext=new xI(this),this.frameTimer=new Fo(this),this.handleContextLoss=e=>{!function(e,t){const i=e.getMemoryGauge().getUsageDetails(),s={};Object.entries(i).forEach((([e,t])=>{s[e]=(t/1048576).toFixed(1)+" MB"})),ut.log.warn(vD+"The WebGL context was lost. Memory usage at time of loss: "+JSON.stringify(s)),e.gl=null,e.timeOfContextLoss=(0,Fs.Wj)(),e.getEventDispatcher().trigger(yD.cW),e.showWebGLContextLostMessage(),t.preventDefault()}(this,e)},this.handleContextRestored=e=>{!function(e,t){e.getGlContext()&&(ut.log.info("A context restore was received without a context loss - simulating"),e.gl=null,e.getEventDispatcher().trigger(yD.cW)),e.setupGlContext(),ut.log.warn(vD+"The WebGL context was restored after "+(0,Fs.Es)(e.timeOfContextLoss).toFixed(0)+" ms"),e.timeOfContextLoss=null,e.getEventDispatcher().trigger(yD.pO,e.getGlContext()),e.onResize(),e.requestDraw(),e.hideWebGLContextLostMessage(),t.preventDefault()}(this,e)},!this.el)return void(this.viewerDestroyed=!0);this.el.addEventListener("webglcontextlost",this.handleContextLoss),this.el.addEventListener("webglcontextrestored",this.handleContextRestored);const t=e&&e.hidden;if(e&&e.glContext)this.gl=e.glContext,this.onNewGlContext();else if(!t&&(this.setupGlContext(),!this.gl))return;t&&this.hide(),(0,RS.WD)(this.getRendererInfo()),this.glSyncEveryFrame=!1,this.occurrenceDataManager=new lh(this),this.modelViewManagers=new ih(this.occurrenceDataManager,this),this.sceneGraphs=new Yo,this.uiResourceManager=new Yf(this,this.sceneGraphs),this.uiSelectionManager=new dh.z,this.edgePointController=null,this.silhouetteTask=new Zf(this),this.occurrenceIdManager=new Jf.yx(this);e&&e.dontSetActive||((0,Jo.e$)(this),(0,yD.xA)().trigger(yD.zT)),this.getIsPrimaryViewer()&&(this.curvatureAnalysisManager=new cc(this)),this.disableAutomaticDrawing=e&&!!e.disableAutomaticDrawing,this.disableViewManipulator=e&&!!e.disableViewManipulator,this.instantiatedShaders={},this.badShaders={},this.attribVertexEnabled={},this.boundTextures={},this.listenTo(this.getEventDispatcher(),yD.so,this.onSessionEnded),this.listenTo(this.getEventDispatcher(),yD.cW,this.onGlContextLost),this.listenTo(this.getEventDispatcher(),yD.pO,this.onGlContextRestored),this.listenTo(this.getEventDispatcher(),yD.u9,this.onViewDidDrawSynchronizeLocalView),tf(this),(0,Fs.jo)(this.getViewerId(),this),this.animationController=new YT(this),this.viewController=null,this.viewInitialized=!1,this.detailManager=new Jr(Ki.Jq.AnalyticsService,this,this.frameTimer),this.loadTimer=null,this.bodyLoadTimer=null,this.elementLoadState=qS.WAITING_FOR_DISPLAY_DATA,this.shouldWaitForCompareDisplayData=!0,this.readyToUpdateElementLoadState=!1,this.receivedFeatureData=!1,this.receivedAssemblyDefinition=!1,this.isReadyForDrawOnLinkOpen=!0,this.initializedForDrawing=!1,this.renderingMode=k.P1.SHADED_WITH_EDGES,this.drawPasses=[],this.mainDrawPass=null,this.combinedPickPass=null,this.depthRetrievalPass=null,this.draftAngleRetrievalPass=null,this.depthSamplingPass=null,this.uiElements={},this.elementToPerElementState={},this.activeElementId="",this.printCanvas=null,this.suppressModelSelection=!1,this.queuedBaseData=null,this.selectionMapperForQueuedBase=null,this.queuedDisplayData=[],this.haveUnitsBeenReceived=!1,this.elementUnitChangedSubscription=(0,nr.vx)().elementUnitChangedObservable.subscribe((()=>this.requestDraw())),this.memoryGauge=new Cf,this.boxSelectionDeferred=null,this.cursorStack=[],this.selectionCursor=Nn.C.DEFAULT,this.lastMouseLocation=[-1,-1],this.frustumToPreventCulling=null;e&&e.disableSpaceball||va(),this.canEdit=!0,this.timestampOfLastDraw=0,this.averagePickDuration=-1,this.pickRadius=this.getDefaultPickRadius(),this.bodyLoadTasks=new Yc(this),this.bodyLoadTask=this.bodyLoadTasks.getLoadTask(),this.bodyManager=new Hc(this,this.bodyLoadTasks.getUnloadTask()),this.modelViewManagers.getManager().setBodyLoadTasks(this.bodyLoadTasks),e.isForFlattenedDisplay||e.isForPreviousVersionDisplay||(this.isolatedOccurrenceManager=new CD(this)),this.taskManager=new $T,this.taskManager.addTask(this.bodyLoadTasks.getUnloadTask(),jT),this.taskManager.addTask(this.bodyLoadTask,QT),this.taskManager.addTask(this.silhouetteTask,jT),this.lastDevicePixelRatio=0,this.recordCapabilitiesTimeout=null,this.hidden||(this.recordCapabilitiesTimeout=window.setTimeout((()=>{JD(this.gl),this.recordCapabilitiesTimeout=null}),5e3)),this.MAX_TEXTURE_UNITS=8,this.textureNameToUnitMap={},this.textureUnitToNameMap={},this.textureAtlasFactory=null,this.sharedFrameBuffers={},this.sharedRenderBuffers={},this.resources=new wn(this),this.activeElementPreviewManager=null;const i=(e,t)=>{let i=null;const s=this.pick(e,t);for(let e=0;e<s.length&&!i;++e)i=s[e].getModelSelection();let n;this.getModelViewManagers().getManager().displayingPartStudio()&&i&&i.isModifiable()&&(n=(0,Ce.fM)(i),n&&n.getIsShowDimensionsEligible()&&n.getIsComputed()&&(0,sr.m)().trigger(ir.C.SHOW_DIMENSIONS_FOR_NODE_WITH_ID,n.getNodeId()))};this.inputHandler=null;e&&e.disableInput||(this.inputHandler=new gs(i,this)),this.sketch=null,this.returnToPerspective=!1,this.viewManipulator=null,e&&e.disableViewManipulator||(this.viewManipulator=new BT(this,e.contextMenuMgr)),this.pickPassCount=0,this.drawTimer=null,this.standardRequestCallbackQueued=!1,this.inRequestDrawCallback=!1,this.referenceHighlights=new Sn(this),this.highlightManager=new Tn(this.referenceHighlights),this.compareHighlightManager=new Tn(this.referenceHighlights),this.compareHighlightManager.usage=fs.L.PREVIEW,this.selectionsToKeepHiddenFromPick=[],this.performBodyCheck=!1,this.bodyCheckPass=new mt(this),this.hasElementPreviewLoaded=!1,this.storedCameraState=null,this.contextLossTimeout=null,this.zoomToSelectionBounds=null,this.listenTo(this.getEventDispatcher(),yD.ox,this.onMouseEnter),this.listenTo(this.getEventDispatcher(),yD.u5,this.onMouseLeave),this.latestDisplayDataUsageSubscription=ys().latestDisplayDataUsageChangedObservable.subscribe((()=>this.onDisplayDataUsageChange())),this.listenTo((0,yD.xA)(),yD.Cr,this.onDefaultUnitsChanged),this.filteredEntitiesHighlightController=null,this.interferenceCallId="",this.xrController=new BM(this),this.localDisplayDataCacheCleared=!1,this.debugShowSilhouetteEdgesOnNonVisibleTangentEdgeStyle=!1,this.smoothEdgeStyle=k.YUG.VISIBLE,this.browserTabVisibilityHandler=()=>this.onBrowserTabVisibilityChanged(),document.addEventListener("visibilitychange",this.browserTabVisibilityHandler),this.themeChangeSubscription=fl.G.getThemeChangedObservable().subscribe((()=>this.onAppearanceConstantsUpdated())),this.pickRectPixelOffset=1}onViewDidDrawSynchronizeLocalView(){this.pairedViewer&&this.getIsSynchingView()&&this.shouldUpdatePairedViewer&&this.syncPairedView(),this.shouldUpdatePairedViewer=!0}onViewerReactivated(){this.getBodyManager().resetSelectionListHandlers(),this.isolatedOccurrenceManager?.stopListening(),this.isolatedOccurrenceManager?.setUpListeners(),this.modelViewManagers.getManager().resetSelectionListHandlers(),this.clearElementPreview(),this.elementToPerElementState={},this.localDisplayDataCacheCleared=!1;const e=this.getModelViewManagers().getManager().getSimulationManager();e&&e.onDocumentChange(),this.resetViewState()}showWebGLContextLostMessage(){const e=this.getModelViewManagers().getManager();if(e.displayingPartStudio()||e.displayingAssembly()){const e=VS('<div class="context-loss-message">'+i18n("One moment…")+"</div>").appendTo(this.$el.parent());this.clearContextLossTimeout(),this.contextLossTimeout=window.setTimeout((()=>{e.html(US())}),X.default.getManager().getNumber("WEBGL_CONTEXT_WARNING_TIMEOUT_MS")),this.viewManipulator&&this.viewManipulator.hide()}}clearContextLossTimeout(){(0,Gr.Z)(this.contextLossTimeout)&&(window.clearTimeout(this.contextLossTimeout),this.contextLossTimeout=null)}hideWebGLContextLostMessage(){const e=this.$el.parent().find(".context-loss-message");e.length>0&&(e.remove(),this.viewManipulator&&!this.hidden&&this.viewManipulator.show())}getEventDispatcher(){return this.eventDispatcher}setEventDispatcher(e){this.eventDispatcher=e}getOccurrenceIdManager(){return this.occurrenceIdManager}getActiveElementId(){return this.activeElementId}getBodyManager(){return this.bodyManager}getIdForOccurrence(e){return e?this.occurrenceIdManager.getIdForName(e.getPathAsString()):Jf.KF}getModelViewManagers(){return this.modelViewManagers}isReadyToUpdateElementLoadState(){return this.readyToUpdateElementLoadState}getReceivedFeatureData(){return this.receivedFeatureData}getSceneGraphs(){return this.sceneGraphs}getUiResourceManager(){return this.uiResourceManager}getOccurrenceDataManager(){return this.occurrenceDataManager}getIsolatedOccurrenceManager(){return this.isolatedOccurrenceManager}getUISelectionManager(){return this.uiSelectionManager}getSilhouetteTask(){return this.silhouetteTask}areEdgeSilhouettesEnabled(){return this.detailManager.areFullDetailEdgeSilhouettesEnabled()}isInteractiveFramerateBelowThreshold(){return this.detailManager.isInteractiveFramerateBelowThreshold()}areInteractiveDetailsSignficantlyReduced(){return this.detailManager.getInteractiveSettings().lowLevelBodyProportion>0}isInteractiveSsaoEnabled(){return this.detailManager.isInteractiveSsaoEnabled()}areInteractiveSilhouettesEnabled(){return this.detailManager.areInteractiveSilhouettesEnabled()}getEdgePointController(){return this.edgePointController}createEdgePointController(){this.edgePointController&&this.edgePointController.disable(),this.edgePointController=new Ei(this)}getDefaultStandardView(){return this.getIsForFlattenedDisplay()?"XY":"Trimetric"}onMouseEnter(){(0,Jo.KO)(this),this.hasMouseOver=!0}onMouseLeave(){this.hasMouseOver=!1}getHasMouseOver(){return this.hasMouseOver}getIsForFlattenedDisplay(){return!!this.isForFlattenedDisplay}getIsForPreviousVersionDisplay(){return!!this.isForPreviousVersionDisplay}getIsPrimaryViewer(){return!this.getIsForFlattenedDisplay()&&!this.getIsForPreviousVersionDisplay()}getSupportsPreview(){return!this.getIsForPreviousVersionDisplay()}requestDrawUsingTimer(e,t,i){t=t||YS;const s=this;if(!this.drawTimer||i){if(!e){if(this.disableAutomaticDrawing)return;e=function(){s.drawTimer=null;s.draw(undefined,t)}}this.drawTimer=window.setTimeout(e,10)}}requestDrawUsingAnimationFrame(e,t,i){if(this.isOngoingRenderLoopRunning)return;t=t||YS;const s=this;if(i||e||!this.standardRequestCallbackQueued&&!this.inRequestDrawCallback){if(e){const t=e;e=e=>{this.inRequestDrawCallback=!0,t(e),this.inRequestDrawCallback=!1}}else{if(this.disableAutomaticDrawing)return;e=function(e){s.standardRequestCallbackQueued=!1,s.inRequestDrawCallback=!0,s.draw(e,t),s.inRequestDrawCallback=!1},s.standardRequestCallbackQueued=!0}window.requestAnimationFrame(e)}}setInRequestDrawCallback(e){this.inRequestDrawCallback=e}forceRequestDraw(e){this.requestDraw(void 0,e,!0)}requestDrawForInteractiveProcessing(){this.requestDrawUsingTimer(undefined,KS)}resetPickPassCount(){this.pickPassCount=0}notifyOfPickPassCount(e){e>this.pickPassCount&&(this.pickPassCount=e)}getPickPassCount(){return this.pickPassCount}onGlContextLost(){this.resetCachedState(),this.resetSharedBuffers(),this.memoryGauge.reset(),this.frameTimer.onContextLost()}onGlContextRestored(){this.frameTimer.onContextRestored()}onSessionEnded(){this.resetShaders(),this.resetSharedBuffers(),this.resources.reset()}bindTextureToUnit(e,t){this.gl&&this.boundTextures[t]!==e&&(this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.boundTextures[t]=e)}getSketch(){return this.sketch}setSketch(e){this.sketch&&(e&&this.sketch.id===e.id||this.getModelViewManagers().getManager().displaySketchAsInactive(this.sketch.id),this.sketch=null);const t=this.getPrimaryViewController();e?(e.viewer=this,this.sketch=e,this.getModelViewManagers().getManager().displaySketchAsActive(this.sketch.id),t&&t.isPerspective()&&(this.returnToPerspective=!0,this.setPrimaryViewController(t.getMatchingOrthographicController())),(0,yD.xA)().trigger(yD.Fc,ji.SKETCH)):this.returnToPerspective&&(t&&t.isOrthographic()&&this.setPrimaryViewController(t.getMatchingPerspectiveController()),this.returnToPerspective=!1),this.getInputHandler()&&this.getInputHandler().setSketch(this.sketch),this.sketch||(0,yD.xA)().trigger(yD.Fc,ji.PART_STUDIO)}disableCurrentLaminarHighlightController(){const e=this.getFilteredEntitiesHighlightController();e&&(e.disable(),this.setFilteredEntitiesHighlightController(null))}clearSketch(e){this.sketch===e?this.setSketch(null):ut.log.info("sketch to be cleared does not match the current sketch")}setHoveredSelection(e){if(this.clearHoveredSelection(),e instanceof Ce.Y1)(0,Ce.a3)(e);else if(e instanceof dh.i){const t=this.getUISelectionManager();t&&t.setHoveredSelection(e,{})}}setUISelection(e){const t=this.getUISelectionManager();t&&t.setSelection(e)}clearHoveredSelection(){const e=this.getUISelectionManager();e&&e.setHoveredSelection(null,{});(0,Ce.Zs)(!0,!1)}getInputHandler(){return this.inputHandler}setSuppressMouseMovePick(e){this.inputHandler&&this.inputHandler.setSuppressMouseMovePick(e)}getLastMouseMovedEvent(){return this.inputHandler?this.inputHandler.getLastMouseMovedEvent():null}getLastMouseLocation(){return this.lastMouseLocation}getFrustumToPreventCulling(){return this.frustumToPreventCulling}getResources(){return this.resources}setViewInitialized(e){this.viewInitialized=e}resetCachedState(){this.attribVertexEnabled={},this.boundTextures={}}resetShaders(){this.instantiatedShaders={},this.resetCachedState()}resetSharedBuffers(){this.sharedFrameBuffers={},this.sharedRenderBuffers={}}getOrCreateFrameBuffer(e,t,i){if(!t)return new xo(this,e,t,i);let s=this.sharedFrameBuffers[t];return s||(this.sharedFrameBuffers[t]=s=new xo(this,e,t,i)),s}getOrCreateRenderBuffer(e,t,i){const s=i?.id;let n=null;if(!this.gl)return null;if(!s)return n=this.gl.createRenderbuffer(),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,n),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,i.storageType,e,t),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),n;const r=this.sharedRenderBuffers[s];return r&&r.width===e&&r.height===t?r.buffer:(n=this.gl.createRenderbuffer(),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,n),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,i.storageType,e,t),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.sharedRenderBuffers[s]={buffer:n,width:e,height:t},n)}resetExtensions(){const e=Object.keys(this.extensions);this.extensions={};for(let t=0;t<e.length;++t)this.getExtension(e[t])}getExtension(e){if(!this.gl)return ut.log.warn(`Tried to get webgl extension ${e} without valid webgl context`),null;let t=this.extensions[e];return void 0!==t||(t=this.gl.getExtension(e),this.extensions[e]=t),t}getMaximumTextureSize(){return this.gl?this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE):1024}isExtensionSupported(e){return!!this.getExtension(e)}areFloatTexturesSupported(){return this.isExtensionSupported("OES_texture_float")}isFloatBufferBlendingSupported(){return this.isExtensionSupported("EXT_float_blend")}are32BitIndicesSupported(){return this.isExtensionSupported("OES_element_index_uint")}areShaderDerivativesSupported(){return!!this.getExtension("OES_standard_derivatives")}isHighPrecisionFragmentShaderSupported(){return(0,Fs.J5)(this.gl)}getAnisotropicExtension(){return this.getExtension("EXT_texture_filter_anisotropic")||this.getExtension("WEBKIT_EXT_texture_filter_anisotropic")}getDrawbuffersExtension(){return this.getExtension("WEBGL_draw_buffers")||this.getExtension("EXT_draw_buffers")}getVertexArrayExtension(){return this.getExtension("OES_vertex_array_object")}getHalfFloatType(){const e=this.getExtension("OES_texture_half_float");return e?e.HALF_FLOAT_OES:0}getDefaultFloatTextureType(){return this.getHalfFloatType()||this.gl?.FLOAT}getHighPrecisionFloatTextureType(){return this.gl?.FLOAT}getReferenceHighlights(){return this.referenceHighlights}getHighlightManager(e){return fs.L.PREVIEW===e?this.compareHighlightManager:this.highlightManager}resetHighlightManagers(){this.highlightManager=new Tn(null),this.compareHighlightManager=new Tn(null)}updateHighlightColors(e){is.PoX.forEach((t=>{this.getReferenceHighlights().updateHighlightColor(t,e)})),ll(e);for(const e in this.uiElements)this.uiElements[e].onHighlightColorUpdated()}areHighlightVertexTexturesSupported(){if(null===this.highlightVertexTexturesSupported)if(this.gl){const e=this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this.highlightVertexTexturesSupported=e>1}else ut.log.warn("An attempt was made to evaluate whether or not highlight vertex textures are supported before the gl context was initialized");return!!this.highlightVertexTexturesSupported}getRendererInfo(){return this.rendererInfo||(this.rendererInfo=Zt(this.gl)),this.rendererInfo}isSSAOFilteringSupported(){return null===this.SSAOFilteringSupported&&(this.SSAOFilteringSupported=!/intel/gi.test(this.getRendererInfo().glRenderer)),this.SSAOFilteringSupported}isHighPrecisionSupportedInFragmentShader(){if(null!==this.highPrecisionSupportedInFragmentShader)return this.highPrecisionSupportedInFragmentShader;if(!this.gl)return!1;const e=this.gl.getShaderPrecisionFormat(this.gl.FRAGMENT_SHADER,this.gl.HIGH_FLOAT);return this.highPrecisionSupportedInFragmentShader=!!e&&0!==e.precision,this.highPrecisionSupportedInFragmentShader}supportsOrderIndependentTranslucency(){return this.areFloatTexturesSupported()}supportsGraphicalSectionPlanes(){return this.areFloatTexturesSupported()&&this.isFloatBufferBlendingSupported()}getIsExcludingItemsForSection(){return(0,LS.Ky)().getIsExcludingItemsForSection()}supportsDraftAnalysis(){return this.areFloatTexturesSupported()}getTextureAtlasFactory(){return this.textureAtlasFactory||(this.textureAtlasFactory=new pM.Fk),this.textureAtlasFactory}debugGetAllocatedTextureUnitsString(){const e=Object.keys(this.textureNameToUnitMap);let t="Texture allocation: ";for(let i=0;i<e.length;++i)t+=e[i]+": "+this.textureNameToUnitMap[e[i]]+", ";return t}getOrAllocateTextureUnit(e){if(this.textureNameToUnitMap.hasOwnProperty(e))return this.textureNameToUnitMap[e];let t=0;for(;t<this.MAX_TEXTURE_UNITS&&this.textureUnitToNameMap[t];)t++;return t>=this.MAX_TEXTURE_UNITS?(ut.log.error("Ran out of texture units (max "+this.MAX_TEXTURE_UNITS+") storing "+e+". Allocation: "+this.debugGetAllocatedTextureUnitsString()),-1):(this.textureNameToUnitMap[e]=t,this.textureUnitToNameMap[t]=e,t)}releaseTextureUnit(e){if(!this.textureNameToUnitMap.hasOwnProperty(e))return void ut.log.error("Could not find texture unit for "+e);const t=this.textureNameToUnitMap[e];delete this.textureNameToUnitMap[e],delete this.textureUnitToNameMap[t]}getTextureUnit(e){return this.textureNameToUnitMap[e]}getGlContext(){return this.gl}getShader(e){let t=this.instantiatedShaders[e];return t||(t=new af(this,e),this.instantiatedShaders[e]=t),t}enableVertexAttributeArray(e,t){(this.areVertexArrayObjectsAvailable||this.attribVertexEnabled[e]!==t)&&this.gl&&(t?this.gl.enableVertexAttribArray(e):this.gl.disableVertexAttribArray(e),this.areVertexArrayObjectsAvailable||(this.attribVertexEnabled[e]=t))}disableAllVertexAttributeArrays(){for(const e in this.attribVertexEnabled)this.enableVertexAttributeArray(+e,!1)}setupGlContext(){if(this.gl=null,!(this.el instanceof HTMLCanvasElement))return;let e=null;const t=["webgl","experimental-webgl","webkit-3d","moz-webgl"];for(let i=0;i<t.length;++i){try{e=this.el.getContext(t[i],jS),e instanceof WebGLRenderingContext||e instanceof CaptureContext||(e=null)}catch(e){}if(e)break}e&&(this.gl=e,this.onNewGlContext())}onNewGlContext(){this.gl&&(this.gl.frontFace(this.gl.CCW),this.gl.enable(this.gl.DEPTH_TEST)),this.resetExtensions(),this.rendererInfo=Zt(this.gl),(0,RS.WD)(this.rendererInfo),this.glSyncEveryFrame=(0,dt.isPlatformMac)()&&(0,dt.isBrowserSafari)()&&/intel/i.test(this.rendererInfo.glVendor),this.renderContext.onNewContext(this.gl),ii(this.are32BitIndicesSupported()),(0,gh.Vp)(this.rendererInfo),this.areVertexArrayObjectsAvailable=!!this.getVertexArrayExtension(),this.frameTimer.onContextCreated()}getWebGlSupport(){let e=NS.c.SUPPORTED;return this.el?window.WebGLRenderingContext?this.gl||(e=NS.c.OTHER_PROBLEM):e=NS.c.MISSING:e=NS.c.OTHER_PROBLEM,e}getViewerId(){return this.cid}getFrameTimer(){return this.frameTimer}setDevicePixelRatioOverride(e){const t=zS(Math.max(this.$el.width(),1),e),i=zS(Math.max(this.$el.height(),1),e);(0,Ji.Lt)(e),this.el.width=t,this.el.height=i,this.getCamera()?.setViewportFromCanvasElement(this.$el),this.stopBoxSelection(),this.draw()}onResize(e){e=void 0===e||e;const t=this.getGlContext();if(!t)return;if(!this.el)return;let i=(0,Ji.XC)(),s=zS(Math.max(this.$el.width(),1),i),n=zS(Math.max(this.$el.height(),1),i);if((0,dt.isBrowserSafari)()){const e=zS(screen.width,i),t=zS(screen.height,i);if(s>e||n>t){const r=Math.min(e/s,t/n);ut.log.info("Canvas dimensions exceeded screen size, scaling by a factor of: "+r.toFixed(4)),i*=r,(0,Ji.Lt)(i),s=zS(Math.max(this.$el.width(),1),i),n=zS(Math.max(this.$el.height(),1),i)}else(0,Ji.eu)()}this.el.width=s,this.el.height=n,t.viewportWidth=this.el.width,t.viewportHeight=this.el.height,t.aspectRatio=this.el.width/this.el.height,this.mainDrawPass&&(this.setUserIsManipulatingWithTimeout(),this.getCamera()?.setViewportFromCanvasElement(this.$el),this.stopBoxSelection(),e&&this.requestDraw())}pushCameraState(e){const t=e||this.getCamera();t?(this.renderContext.setActiveCamera(t),this.renderContext.pushModelViewMatrix(t.getViewMatrix()),this.renderContext.pushProjectionMatrix(t.getProjectionMatrix()),this.renderContext.pushViewport(t.getViewport())):ut.log.warn("Camera not found")}popCameraState(){this.renderContext.popModelViewMatrix(),this.renderContext.popProjectionMatrix(),this.renderContext.popViewport()}setBaseFrameBuffer(e){this.baseFrameBuffer=e}setBaseFrameBufferToDefault(){this.baseFrameBuffer=null}getBaseFrameBufferWidth(){return this.baseFrameBuffer?this.baseFrameBuffer.getWidth():this.getCamera().getCanvasWidth()}getBaseFrameBufferHeight(){return this.baseFrameBuffer?this.baseFrameBuffer.getHeight():this.getCamera().getCanvasHeight()}onComputedData(e){if(e.elementId!==this.activeElementId)return;(this.modelViewManagers.getPreviewManager()||this.modelViewManagers.getManager()).processManagedData(e),this.readyAndUpdateElementLoadState(e.elementId)}readyAndUpdateElementLoadState(e){e===this.activeElementId&&(this.readyToUpdateElementLoadState=!0,this.updateElementLoadState())}onFeatureData(e){e===this.activeElementId&&(this.receivedFeatureData=!0,this.updateElementLoadState())}onAssemblyDefinition(e){e===this.activeElementId&&(this.receivedAssemblyDefinition=!0,this.readyToUpdateElementLoadState=!0,this.updateElementLoadState())}setWaitingForLinkOpen(){this.isReadyForDrawOnLinkOpen=!1}onReadyForDrawOnLinkOpen(){this.isReadyForDrawOnLinkOpen=!0,this.updateElementLoadState()}prepareElementDisplayData(){this.elementLoadState===qS.LOADING_DISPLAY_DATA&&(this.modelViewManagers.getManager().getModelBounds(),this.loadingDisplayDataTimer?.report(),this.loadingDisplayDataTimer=null,this.elementLoadState=qS.LOADED_DISPLAY_DATA,this.updateElementLoadState())}updateElementLoadState(){const e=this.modelViewManagers.getManager();this.elementLoadState!==qS.LOADED_DISPLAY_DATA||!this.readyToUpdateElementLoadState||!this.isReadyForDrawOnLinkOpen||!this.receivedFeatureData&&e.displayingPartStudio()||!this.receivedAssemblyDefinition&&e.displayingAssembly()||(this.getEventDispatcher().trigger(yD.cp,this.activeElementId),this.elementLoadState=qS.LOADED_ALL_DATA,this.clearElementPreview(),this.bodyLoadTask.hasPendingWork()?(this.doesControlBodySpinner()&&(0,Bm.l)().startBodyLoadBeeper(),this.bodyLoadTimer=new Qo.B7("Loading bodies, isForFlattened: "+this.getIsForFlattenedDisplay(),iT())):this.doesControlBodySpinner()&&(0,Bm.l)().stopBodyLoadBeeper(),this.loadTimer&&(this.loadTimer.report(),this.loadTimer=null),this.setReadyState(!0),this.requestDraw())}hasPendingBodiesToLoad(){return this.bodyLoadTask.hasPendingWork()}getPendingBodiesToLoadPromise(){return this.bodyLoadTask.getTaskFinishedPromise()}hasPendingWork(){return this.bodyLoadTask.hasPendingWork()||this.taskManager.hasPendingWork()}doesControlBodySpinner(){return!this.getIsForFlattenedDisplay()}getRenderContext(){return this.renderContext}getMemoryGauge(){return this.memoryGauge}getRenderingMode(){return this.renderingMode}isRenderingModeSafeForLinkSharing(e){return e!==k.P1.UNKNOWN&&!kS.has(e)}preventChangeToRenderMode(e){return!!this.getCurvatureAnalysisManager()?.preventChangeToRenderMode(e)||(!!this.preventZebraStripesDuringInterferenceDetection(e)||!this.getIsPrimaryViewer()&&e===k.P1.SHADED_CURVATURE_VISUALIZATION)}preventZebraStripesDuringInterferenceDetection(e){const t=i18n("Zebra stripes are not supported during interference detection");if(void 0===e&&this.renderingMode===k.P1.CURVATURE_VISUALIZATION)return Ki.Jq.MessageBubbleService.showMessageWithAutoDismiss(t,"warning"),this.resetToDefaultRenderingMode(),!0;if(e===k.P1.CURVATURE_VISUALIZATION){if(ci._3.getOpenDocumentController().isInterferenceDetectionActive())return Ki.Jq.MessageBubbleService.showMessageWithAutoDismiss(t,"warning"),!0}return!1}setRenderingMode(e){if(this.preventChangeToRenderMode(e))return;this.renderingMode=e,this.renderContext.setRenderingMode(e),this.mainDrawPass?.setRenderingMode(e),this.combinedPickPass?.setRenderingMode(e);const t=this.getModelViewManagers().getManager().getSimulationManager();t&&t.onRenderingModeChanged(),this.getCurvatureAnalysisManager()?.onRenderingModeChanged(),this.getThicknessAnalysisManager()?.onRenderingModeChanged(),this.resources.onRenderingModeChanged(),this.modelViewManagers.onRenderingModeChanged(),this.renderModeSubject.next(e),this.getIsPrimaryViewer()&&(this.followGraphicsData.renderingMode=e,this.followGraphicsDataSubject.next(this.followGraphicsData)),this.requestDraw()}resetToDefaultRenderingMode(){Ki.Jq.CapabilitiesService.checkAngularViewcubeMenuCurrentlyEnabled()?this.setRenderingMode((0,Jo.uQ)().getViewerPreferences().renderingMode):this.setRenderingMode(k.P1.SHADED_WITH_EDGES)}toggleDebugShowSilhouetteEdgesOnNonVisibleTangentEdgeStyle(){this.debugShowSilhouetteEdgesOnNonVisibleTangentEdgeStyle=!this.debugShowSilhouetteEdgesOnNonVisibleTangentEdgeStyle}debugIsShowingSilhouetteEdgesOnNonVisibleTangentEdgeStyle(){return this.debugShowSilhouetteEdgesOnNonVisibleTangentEdgeStyle}showTangencyInformationMissingMessage(){this.localDisplayDataCacheCleared||(ut.log.trace("Unknown smoothness status edge found, clearing local display data cache"),(0,sr.m)().trigger(ir.C.CLEAR_LOCAL_DISPLAY_DATA_CACHE),this.localDisplayDataCacheCleared=!0),Ki.Jq.MessageBubbleService.showMessageWithAutoDismiss(i18n("Render mode could not be applied. Necessary information is missing in older display data."),"warning")}getSmoothEdgesRenderStyle(){return this.smoothEdgeStyle}setSmoothEdgesRenderStyle(e){if(this.smoothEdgeStyle===e)return;this.smoothEdgeStyle=e,this.resources.updateSmoothEdgeMaterial();const t=this.getModelViewManagers();if(t.getManager().refreshSmoothEdgesForAllPartStudios()){if(t.previewManagerExists()&&t.getPreviewManager().refreshSmoothEdgesForAllPartStudios(),!this.getIsForFlattenedDisplay()){const t=ta.t.getController();t&&t.onSmoothEdgeStyleChanged(this);const i=ci._3.getOpenDocumentController();if(i){const t=i.getSheetMetalViewer();t&&this!==t&&this.getActiveElementId()===t.getActiveElementId()&&(t.setSmoothEdgesRenderStyle(e),t.requestDraw())}}this.getIsPrimaryViewer()&&(this.followGraphicsData.smoothEdgeStyle=e,this.followGraphicsDataSubject.next(this.followGraphicsData))}else this.setSmoothEdgesRenderStyle(k.YUG.VISIBLE)}initializeForDrawing(){this.initializedForDrawing||(this.onResize(),this.mainDrawPass=new Ct(this),this.drawPasses.push(this.mainDrawPass),this.combinedPickPass=new ve(this,this.mainDrawPass),this.mainDrawPass.getDebugDrawPickPass().setPickPass(this.combinedPickPass),this.drawPasses.push(this.combinedPickPass),this.depthRetrievalPass=new We(this),this.drawPasses.push(this.depthRetrievalPass),this.draftAngleRetrievalPass=new ht(this),this.drawPasses.push(this.draftAngleRetrievalPass),this.depthSamplingPass=new ce(this),this.drawPasses.push(this.depthSamplingPass),this.mainDrawPass.prepareShaders(),this.combinedPickPass.prepareShaders(),this.depthRetrievalPass.prepareShaders(),this.depthSamplingPass.prepareShaders(),this.viewController||(this.viewController=new Qn(this),this.viewController.getCamera().setViewportFromCanvasElement(this.$el),this.viewController.setStandardView(this.getDefaultStandardView())),this.initializedForDrawing=!0,(0,dt.isPlatformChromebook)()&&(0,dt.getChromeVersion)()>=107&&this.mainDrawPass.setClearColor(1,1,1,1))}initializeView(){if(!this.viewInitialized){const e=this.getCamera(),t=e.getViewportWidth()*e.getViewportHeight()>=XS.getNumber("MIN_MODEL_PIXEL_SIZE"),i=this.getModelBounds();if(t&&i.isInitialized()&&i.isExtensive()){const e=!0;this.zoomFit(e),this.viewInitialized=!0}this.findDepthsInRect(0,0,1,1)}}hasResourcesNeededForDrawing(){const e=!this.isForFlattenedDisplay||this.modelViewManagers.getManager().hasSelectedSheetmetalModelId();return(this.hasElementPreviewLoaded||this.elementLoadState===qS.LOADED_ALL_DATA)&&!Ka()&&e}isReadyForDrawing(){return!!this.getGlContext()&&this.initializedForDrawing&&this.hasResourcesNeededForDrawing()}getFilteredEntitiesHighlightController(){return this.filteredEntitiesHighlightController}onLaminarEdgesChanged(e){this.getIsPrimaryViewer()&&(this.followGraphicsData.isBoundaryEdgeHighlightOn=e,this.followGraphicsDataSubject.next(this.followGraphicsData))}setFilteredEntitiesHighlightController(e){return this.filteredEntitiesHighlightController=e,this.filteredEntitiesHighlightController}draw(e,t){if(this.viewerDestroyed)return;const i=this.getGlContext();if(!i)return;t=t||$S;const s=(0,Ji.x_)();if(s!==this.lastDevicePixelRatio){t.forPrint||this.el.width===zS(this.$el.width(),s)&&this.el.height===zS(this.$el.height(),s)||this.onResize(!1),this.lastDevicePixelRatio=s;const e=t.camera||this.getCamera();this.getEventDispatcher().trigger(yD.b3,e),this.resources.onDevicePixelRatioChanged(t.forPrint);for(const t in this.uiElements)this.uiElements[t].onDevicePixelRatioChanged(e);this.resetPickRadius()}if(e){if(e===this.timestampOfLastDraw)return;this.timestampOfLastDraw=e,_a(this,e)}if(this.initializeForDrawing(),!this.mainDrawPass)return;if(this.prepareElementDisplayData(),!this.hasResourcesNeededForDrawing())return void(this.hidden||this.processPendingWork());this.initializeView(),t.performFrameTiming&&this.frameTimer.onDrawStart(),this.renderContext.setDetailSettings(this.detailManager.getDetailSettings()),(0,yn.qn)().resetCounters();const n=t.camera?t.camera:this.getCamera();this.triggerOnViewWillDraw(n),this.processPendingWork(),this.cleanUpOrphanedObjects(),n.setSceneBounds(this.getSceneBounds()),this.pushCameraState(n),t.skipUpdateBodyCulling||this.bodyManager.updateForFrame(this.renderContext,!0),this.renderContext.prepareForNextFrame(),this.mainDrawPass.drawInputs(this.renderContext),this.mainDrawPass.draw(this.renderContext),this.popCameraState(),this.getEventDispatcher().trigger(yD.u9,this),this.memoryGauge.addToStatistics(),(0,yn.qn)().updateModel(),this.performBodyCheckAsNeeded(),this.glSyncEveryFrame&&i.finish(),t.performFrameTiming&&this.frameTimer.onDrawEnd()}triggerOnViewWillDraw(e){const t=(0,nr.vx)();this.getEventDispatcher().trigger(yD.Hv,e,t);for(const i in this.uiElements)this.uiElements[i].onViewWillDraw(e,t)}processPendingWork(){this.taskManager.hasPendingWork()&&!this.frameTimer.userIsInteracting()&&(this.taskManager.processInteractively(),this.requestDrawForInteractiveProcessing()),this.bodyLoadTask.hasPendingWork()||(this.bodyLoadTimer&&(this.doesControlBodySpinner()&&(0,Bm.l)().stopBodyLoadBeeper(),this.bodyManager.initiateAutomaticRetrieval(!0),this.bodyLoadTimer.report(),this.frameTimer.resetTimings(),this.bodyLoadTimer=null),this.hasResourcesNeededForDrawing()||this.modelViewManagers.getManager().getMeshManager().compileBuffers())}performBodyCheckAsNeeded(){this.performBodyCheck&&this.areFloatTexturesSupported()&&!this.bodyLoadTask.hasPendingWork()&&this.modelViewManagers.getManager().displayingPartStudio()&&(this.bodyCheckPass.draw(this.renderContext),this.performBodyCheck=!1)}cleanUpOrphanedObjects(){this.getUiResourceManager().clean(),(0,xi.Gy)(),this.disableAllVertexAttributeArrays()}getSceneBounds(){let e=new yi.kB;const t=this.sceneGraphs.getMainSceneGraph().getRootNode().getBoundingBox({includeHiddenBounds:this.renderContext.getIsPickingHiddenOccurrences()}),i=this.sceneGraphs.getPreviewSceneGraph().getRootNode().getBoundingBox();e.addBox(t),e.addBox(i);const s=this.modelViewManagers.getManager().getSimulationManager();s&&e.addBox(s.getSimulationBounds());return(!e.isInitialized()||!e.isExtensive())&&this.hasElementPreviewLoaded&&this.activeElementPreviewManager&&e.addBox(this.activeElementPreviewManager.getModelBounds()),this.zoomToSelectionBounds&&this.zoomToSelectionBounds.isFinite()&&e.addBox(this.zoomToSelectionBounds),e.isInitialized()&&e.isExtensive()||(e=this.getDefaultBounds()),e}getDefaultBounds(){const e=new yi.kB;return e.set([-1,-1,-1],[1,1,1]),e}getModelBounds(e){const t=new yi.kB,i=this.modelViewManagers.getManager().getModelBounds(e);i&&t.addBox(i,null);const s=this.modelViewManagers.getPreviewManager();return s&&t.addBox(s.getModelBounds(e),null),t.isInitialized()&&t.isExtensive()||!this.hasElementPreviewLoaded||!this.activeElementPreviewManager||t.addBox(this.activeElementPreviewManager.getModelBounds()),t}getUiElementsBounds(){const e=new yi.kB;for(const t in this.uiElements){const i=this.uiElements[t];i.isVisibleToUser()&&e.addBox(i.getFitBounds(),i.getTransform())}return e}getFitBounds(e){let t=this.getUiElementsBounds();if(t.addBox(this.getModelBounds()),!t.isInitialized()||!t.isExtensive())return this.getSceneBounds();if((0,LS.ti)()>0&&this.isReadyForDrawing()&&this.depthSamplingPass){e||(e=this.getCamera()?.getFrame());const i=this.getPrimaryViewController()?.getZoomFitTargetCamera(e,t,!0);if(!i)return t;this.pushCameraState(i),(0,LS.qf)(),this.bodyManager.updateForFrame(this.renderContext,!1),this.depthSamplingPass.retrieve(this.renderContext,{numSamples:XS.getNumber("HIGH_QUALITY_DEPTH_SAMPLES_PER_VIEWPORT"),performIsolationTest:!1}),this.popCameraState();const s=new yi.kB;for(let e=0;e<this.depthSamplingPass.points.length;++e)s.addPoint(i.canvasToWorld(this.depthSamplingPass.points[e]));if(!s.isInitialized()||!s.isExtensive())return this.getSceneBounds();s.maxDimension()/t.maxDimension()<.9&&s.scale(XS.getNumber("CAMERA_ZOOM_TO_FIT_SECTION_PLANE_EXTRA_SLOP")),t=s}return t}getAnimationController(){return this.animationController}getPrimaryViewController(){return this.viewController}getFollowGraphicsDataObservable(){return this.followGraphicsDataSubject.asObservable()}getCurrentFollowingGraphicsData(){return this.followGraphicsData}getCamera(){return this.debugCamera?this.debugCamera:this.viewController?this.viewController.getCamera():null}setPrimaryViewController(e){this.viewController!==e&&(this.viewController=(0,j.as)(Kn,e),this.requestDraw())}setPickRadius(e){this.pickRadius=e}needToChangePickRectDimensions(){if(!(0,dt.isPlatformWindows)())return!1;if(!this.getRendererInfo())return!1;const e=this.getRendererInfo().glRenderer.toLowerCase();return e.includes("adreno")&&e.includes("qualcomm")||(0,dt.isBrowserFirefox)()&&Kt(e)&&e.includes("direct3d")}getDefaultPickRadius(){let e=XS.getNumber("MOUSE_PICK_RADIUS_PX");return e<8&&this.needToChangePickRectDimensions()&&(e<=3?e=4:e<=5?e=6:e<=7&&(e=8),this.pickRectPixelOffset=0),e}resetPickRadius(){this.setPickRadius(this.getDefaultPickRadius())}pick(e,t,i){return this.pickIteratively(e,t,this.getDefaultPickTerminationEvaluator(),i)}getDefaultPickTerminationEvaluator(){let e=0;return(t,i)=>++e>100||(!this.combinedPickPass||this.combinedPickPass.updatePickMask(t,this.renderingMode,i))}pickIteratively(e,t,i,s){const n=[];let r,a;const o=2*this.pickRadius+this.pickRectPixelOffset,h=2*this.pickRadius+this.pickRectPixelOffset,c=e-this.pickRadius,l=t-this.pickRadius;let u=!1,d=0;const g={},p=(0,j.as)(th,this.modelViewManagers.getManagerForUsage(vs())),m=this.getRenderingMode();for(;;){const e=this.pickInRect(c,l,o,h,{pickHiddenOccurrences:!!s&&!!s.pickHiddenOccurrences,cameraOverride:s?s.cameraOverride:null});if(e.length<1)break;for(r=0;r<e.length;++r){a=e[r];const t=a.getModelSelection();if(t){const e=t.getIdForCollection();if(!e||g[e])continue;g[e]=e}a.fromPass=d,a.entityMetaData&&this.getSketch()&&(a.isFromActiveSketch=a.entityMetaData.getSketchFeatureId()===this.getSketch()?.getId()),n.push(a)}if(i(e,s))break;for(r=0;r<e.length;++r)e[r].canPickThrough(m,this,s)&&(this.hidePick(e[r],p),u=!0);++d}return this.combinedPickPass?.clearPickMask(),u&&this.resetIdsHiddenFromPick(),s&&s.altKey?(0,bS.Z)(n,(e=>{const t=e.getModelSelection();if(null===t)return ut.log.warn("Cannot determine translucency of pick element for sorting, assuming default opacity."),!1;if(t.entityMetaData&&t.entityMetaData.isTranslucent())return!0;const i=t.getOccurrence(),s=e.getOccurrenceId(),n=p.getPartStudioDataFromOccurrence(i);if(!n)return!1;const r=n.getBodyComponent().getFaceColor(e?.deterministicId,s);return r&&r[3]<1})):n.sort(bS.G)}pickMany(e,t,i,s){const n=2*i+1,r=2*i+1,a=e-i,o=t-i;return this.pickManyInRect(a,o,n,r,!0,!1,s)}pickInRect(e,t,i,s,n){if(!this.isReadyForDrawing()||!this.combinedPickPass)return[];const r=n&&n.cameraOverride?n.cameraOverride:this.getCamera();this.getEventDispatcher().trigger(yD.b9,r,(0,nr.vx)());const a=n?.pickHiddenOccurrences;let o,h;this.renderContext.setIsPickingHiddenOccurrences(!!a),r?.setSceneBounds(this.getSceneBounds()),this.pushCameraState(r),this.combinedPickPass.setPickRect(e,t,i,s,n&&n.sampleLimit),n&&n.doNotAffectFrustumCulling||(this.frustumToPreventCulling=this.combinedPickPass.getPickFrustum(this.renderContext,WS)),this.renderContext.setDetailSettings(this.detailManager.getInteractiveSettings()),this.bodyManager.updateForFrame(this.renderContext,!1),n&&n.nodeFilterOverride?this.combinedPickPass.setNodeFilterOverride(n.nodeFilterOverride):this.combinedPickPass.setNodeFilterOverride(null),this.combinedPickPass.setPickFromPreview(Os()||!!n&&!!n.forcePreviewPick),this.combinedPickPass.draw(this.renderContext),this.renderContext.setIsPickingHiddenOccurrences(!1),this.popCameraState();const c=this.combinedPickPass.gatherPicksFromPickPass(),l=[];let u;const d=this.modelViewManagers.getManagerForUsage(this.combinedPickPass.getUsage());for(h in c){h=+h;const e=this.getOccurrenceIdManager().getNameForId(+h);e||h===Jf.QC||this.loggedPickIssue||(ut.log.warn("Did not find valid occurrence name for occurrence id: "+h),this.loggedPickIssue=!0);let t=null,i=null;const s=(0,MI.E)(e);if(s){if(i=this.uiElements[e],!i){this.loggedPickIssue||(ut.log.warn("Could not find ui element with name: "+e),this.loggedPickIssue=!0);continue}}else e&&"PART_STUDIO_SKETCHES"!==e&&0!==e.indexOf("body.")&&(t=k._oC.getOccurrenceFromPathString(e));for(o in c[h]){if(u=c[h][o],s){if(u.uiSelection=i?.getSelection(u.occurrenceId,u.primitiveId),!u.uiSelection){this.loggedPickIssue||(ut.log.warn("Could not find owner of mouse pick"),this.loggedPickIssue=!0);continue}u.uiSelection.sourcePick=u}else{if(this.bodyManager.isBodyManagerOccurrence(t)){a?this.bodyManager.updatePickData(u)&&l.push(u):n&&n.bodyPicks?n.bodyPicks.push(u):this.bodyManager.pickedOccurrenceId(u.primitiveId);continue}{if(u.deterministicId=d.getDeterministicIdForPickId(t,u.primitiveId),!u.deterministicId){this.loggedPickIssue||(ut.log.warn("Did not find picked entity's deterministic id"),this.loggedPickIssue=!0);continue}const e=d.retrieveEntityMetaData(t,u.deterministicId);if(u.featureIdList=d.retrieveAssociatedFeatureIds(t,u.deterministicId),e)u.entityMetaData=e;else if(u.bodyMetaData=d.retrieveBodyMetaData(t,u.deterministicId),!u.bodyMetaData){this.loggedPickIssue||(ut.log.warn("Did not find picked deterministic id's metadata"),this.loggedPickIssue=!0);continue}u.occurrence=t}}l.push(u)}}return this.mainDrawPass?.getDebugDrawPickPass().getEnabled()&&this.requestDraw(),l}retrieveVisiblePicks(e,t,i,s){if(!this.combinedPickPass)return ut.log.warn("Pick pass is not initialized"),null;this.combinedPickPass.setEnablePickViewportScaling(!1);const n=this.pickInRect(e,t,i,s);return this.combinedPickPass.setEnablePickViewportScaling(!0),n}getUiElements(){return this.uiElements}pickManyInRect(e,t,i,s,n,r,a){this.combinedPickPass?.setPickAlternatesEnabled(!0),this.renderContext.setBackFacePicking(n),r&&this.subtractEntitiesIntersectingBox(e,t,i,s);const o=this.pickManyInRectInternal(e,t,i,s,a);return this.renderContext.setBackFacePicking(!1),this.combinedPickPass?.setPickAlternatesEnabled(!1),this.resetIdsHiddenFromPick(),o}subtractEntitiesIntersectingBox(e,t,i,s){const n=this.getCamera();if(!n)return;const r=Math.max(e-1,0),a=Math.max(t-1,0),o=Math.min(t+s,n.getViewportHeight()-1),h=Math.min(e+i,n.getViewportWidth()-1);this.pickAllInBox(r,a,h-r,1),this.pickAllInBox(r,o,h-r,1),o-a>2&&(this.pickAllInBox(r,a+1,1,o-a-2),this.pickAllInBox(h,a+1,1,o-a-2))}pickAllInBox(e,t,i,s){this.pickManyInRectInternal(e,t,i,s,void 0,void 0,!0)}performingBoxSelection(){return!!this.boxSelectionDeferred}performBoxSelection(e,t,i,s,n,r=!1){if(this.performingBoxSelection())return null;if(0===i||0===s)return null;if(r&&!(0,Ce.cU)())return null;(0,Bm.l)().startBoxSelectionBeeper(),(0,Ce.B8)(),this.combinedPickPass?.setPickAlternatesEnabled(!0),this.combinedPickPass?.setIsBoxSelecting(!0),this.renderContext.setBackFacePicking(!0),n&&this.subtractEntitiesIntersectingBox(e,t,i,s),this.boxSelectionDeferred=Ur.defer();const a=this.boxSelectionDeferred.promise,o=this,h=function(){if(!o.performingBoxSelection())return;o.setUserIsManipulatingWithTimeout();const n=o.pickManyInRectInternal(e,t,i,s,void 0,15,!0);n.length>0?((0,Ce.d)(n,r),r||(0,yD.xA)().trigger(is.f4Y,n),o.draw(),setTimeout(h,45)):((0,Ce.mO)(r),o.stopBoxSelection())};return setTimeout(h,10),a}setSuppressNonIsolatedPicks(e){this.combinedPickPass?.setSuppressNonIsolatedPicks(e)}stopBoxSelection(){this.performingBoxSelection()&&(this.renderContext.setBackFacePicking(!1),this.combinedPickPass?.setIsBoxSelecting(!1),this.combinedPickPass?.setPickAlternatesEnabled(!1),this.resetIdsHiddenFromPick(),this.boxSelectionDeferred?.resolve(),this.boxSelectionDeferred=null,(0,Bm.l)().stopBoxSelectionBeeper(),(0,Ce.B8)(),this.processQueuedDisplayData(),this.doPreHighlightPick(!0),(0,yD.xA)().trigger(is.KB0))}canProcessDisplayData(){return this.haveUnitsBeenReceived&&!this.performingBoxSelection()}processQueuedDisplayData(e){if(e&&this.stopBoxSelection(),this.canProcessDisplayData()){for(let e=0;e<this.queuedDisplayData.length;++e){const t=this.queuedDisplayData[e];t.displayData instanceof k.hDL?this.onNewPartStudioDisplayData(t.displayData,t.selectionMapper):t.displayData instanceof k.F_7&&this.onRootAssemblyDisplayData(t.displayData)}this.queuedDisplayData=[]}}setUnitsReceived(e){this.haveUnitsBeenReceived=e,e&&this.processQueuedDisplayData()}isPickFromHiddenOccurrence(e){const t=this.occurrenceDataManager.getOccurrenceData(e.occurrenceId);return!!t&&t.getVisibility()===Fs.EE.HIDDEN}resetIdsHiddenFromPick(){this.occurrenceDataManager.resetHiddenFromPick(),(0,LS.X9)();const e=this.getModelViewManagers().getManager();for(let t=0;t<this.selectionsToKeepHiddenFromPick.length;++t){const i=this.selectionsToKeepHiddenFromPick[t],s=e.getEntityIdsForSelection(i),n=e.getOccurrenceIdForSelection(i),r=i.getOccurrence();if((0,Jf.$J)(n))for(let t=0;s&&t<s.length;++t)e.hideEntityFromPick(s[t],n,r)}}setSelectionsToKeepHiddenFromPick(e){this.selectionsToKeepHiddenFromPick=e,this.resetIdsHiddenFromPick()}resetSelectionsToKeepHiddenFromPick(){this.setSelectionsToKeepHiddenFromPick([])}getClosestPointAtPixel(e,t,i){const s=2*i+1,n=2*i+1,r=e-i,a=t-i,o=this.findDepthsInRect(r,a,s,n);let h=null,c=1/0;for(let e=0;e<o.length;++e)if(o[e][2]!==Fs.BG){const t=o[e],i=t[2];i<c&&(h=t,c=i)}return h?(h[0]=e,h[1]=t,this.getCamera().canvasToWorld(h)):null}pickManyInRectInternal(e,t,i,s,n,r,a){const o=[];let h=new gt.StringSet;const c=new gt.StringSet,l=(0,Fs.Wj)();let u=!1;const d=a?(0,Ce.y_)():(0,Ce.Nd)();if(a){u=(0,Ce.Ac)().allowsBodies}const g=(0,j.as)(th,this.modelViewManagers.getManagerForUsage(vs()));let p=0;do{const r=this.pickInRect(e,t,i,s),a=new gt.StringSet;for(let e=0;e<r.length;++e){const t=r[e];t.fromPass=p;let i=!0,s=t.getId();const l=t.getBodyId();if(l&&u){const e=l+un.ID_SEPARATOR+t.occurrenceId;c.contains(e)?i=!1:!d||d.doesBodyLevelSelectionPass(t.getModelSelection())?(g.hideBodyFromPick(l,t.occurrenceId,t.occurrence),c.add(e),s=e):this.hidePick(t,g)}else this.hidePick(t,g);if(h.contains(s))return ut.log.warn("The same pick was found twice, when it should have been hidden"),[];if(a.add(s),i&&o.push(t),n&&o.length>=n)break}if(0===r.length||n&&o.length>=n)break;h=a,++p}while(void 0===r||(0,Fs.Wj)()-l<r);return o}hidePick(e,t){e.isUIPick()?e.uiSelection.hideFromPick():!e.deterministicId&&e.isBodyPick()?this.bodyManager.hideBodyFromPick(e):t.hideEntityFromPick(e.getIncrementId(),e.occurrenceId,e.occurrence),(0,LS.Mi)(e.occurrenceId)}findDepthsInRect(e,t,i,s,n,r){return this.isReadyForDrawing()&&this.depthRetrievalPass?(this.pushCameraState(r),this.renderContext.setDetailSettings(this.detailManager.getInteractiveSettings()),this.bodyManager.updateForFrame(this.renderContext,!1),n=void 0===n||n,this.depthRetrievalPass.setPickRect(e,t,i,s),this.depthRetrievalPass.retrieve(this.renderContext,n),this.popCameraState(),this.depthRetrievalPass.points):[]}findDraftAngle(e,t,i,s,n){return s=s||1,n=n||1,this.isReadyForDrawing()&&this.draftAngleRetrievalPass&&this.mainDrawPass?(this.pushCameraState(),this.renderContext.setDetailSettings(this.detailManager.getInteractiveSettings()),this.bodyManager.updateForFrame(this.renderContext,!1),this.draftAngleRetrievalPass.setOccurrenceIds(this.mainDrawPass.draftAnalysisPass.getIdsToParts()),this.draftAngleRetrievalPass.setDirection(e),this.draftAngleRetrievalPass.setPickRect(t,i,s,n),this.draftAngleRetrievalPass.retrieve(this.renderContext),this.popCameraState(),this.draftAngleRetrievalPass.points):[]}findScalarVisualizationScalar(e,t,i,s,n,r){if(!this.isReadyForDrawing())return[];n=n||1,r=r||1;let a=this.scalarRetrievalPasses.find((t=>t.managerNodeId===e));a||(a=new Ot(this,e),this.scalarRetrievalPasses.push(a),this.drawPasses.push(a)),this.pushCameraState(),this.renderContext.setDetailSettings(this.detailManager.getInteractiveSettings()),this.bodyManager.updateForFrame(this.renderContext,!1),a.setPickRect(i,s,n,r);const o=a.retrieve(this.renderContext,t);return this.popCameraState(),o}retrieveSelectionPosition(e){return this.retrieveCanvasLocationWorldPosition(e.getPickLocation())}retrieveCanvasLocationWorldPosition(e){if(!this.isReadyForDrawing()||!this.depthRetrievalPass)return null;const t=e;if(!t)return null;this.depthRetrievalPass.setRetrieveFromPreview(!1);const i=this.findDepthsInRect(t[0],t[1],1,1);return this.depthRetrievalPass.setRetrieveFromPreview(!0),i.length>0&&i[0][2]!==Fs.BG?this.getCamera().canvasToWorld(i[0]):null}retrieveDepthSampling(e){return this.isReadyForDrawing()&&this.depthSamplingPass?(this.pushCameraState(),this.renderContext.setDetailSettings(this.detailManager.getInteractiveSettings()),this.bodyManager.updateForFrame(this.renderContext,!1),this.depthSamplingPass.retrieve(this.renderContext,e),this.popCameraState(),this.depthSamplingPass.points):[]}retrieveHighlightsOnlyDepthSampling(){return this.isReadyForDrawing()&&this.depthSamplingPass?(this.pushCameraState(),this.renderContext.setDetailSettings(this.detailManager.getInteractiveSettings()),this.bodyManager.updateForFrame(this.renderContext,!1),this.depthSamplingPass.retrieve(this.renderContext,{useHighlightsOnly:!0}),this.popCameraState(),this.depthSamplingPass.points):[]}addUIElement(e){this.uiElements[e.getCollectionId()]=e}removeUIElement(e){delete this.uiElements[e.getCollectionId()],this.uiSelectionManager.removeSelectionForUiElement(e)}destroy(){if(this.viewerDestroyed)return;this.selectOtherView&&this.selectOtherView.destroy(),this.areSectionPlanesEnabled()&&(0,LS.UB)(!1),(0,Au.G0)(),this.stopBoxSelection();const e=this.uiElements;this.uiElements={};for(const t in e)e[t]&&e[t].remove();this.referenceHighlights.destroy(),this.resetHighlightManagers(),this.getEventDispatcher()&&this.getEventDispatcher().trigger(yD.so),this.sceneGraphs.destroySceneGraphs(),this.cleanUpOrphanedObjects(),this.getOccurrenceIdManager().reset(),Ra(),this.el.removeEventListener("webglcontextlost",this.handleContextLoss,!1),this.el.removeEventListener("webglcontextrestored",this.handleContextRestored,!1),this.el.width=0,this.el.height=0,this.renderContext.destroy(),this.bodyManager.destroy(),qf(),(0,Fs.Dz)(this.getViewerId()),this.resetPickPassCount(),(0,Gr.Z)(this.recordCapabilitiesTimeout)&&(clearTimeout(this.recordCapabilitiesTimeout),this.recordCapabilitiesTimeout=null),(0,Gr.Z)(this.drawTimer)&&(clearTimeout(this.drawTimer),this.drawTimer=null),this.remove(),this.$el.off(),this.elementUnitChangedSubscription.unsubscribe(),this.modelViewManagers.clearTheManagers(),this.sceneGraphs.destroySceneGraphs(),this.occurrenceDataManager.destroy(),this.isolatedOccurrenceManager?.destroy(),this.edgePointController&&this.edgePointController.disable(),this.inputHandler&&this.inputHandler.remove(),this.themeChangeSubscription?.unsubscribe(),this.latestDisplayDataUsageSubscription?.unsubscribe(),this.printCanvas&&this.onAfterPrint(),this===(0,Jo.uQ)()&&(0,Jo.e$)(null),this===(0,Jo.N9)()&&(0,Jo.KO)(null),document.removeEventListener("visibilitychange",this.browserTabVisibilityHandler),(0,j.clearObject)(this),this.viewerDestroyed=!0}setBaseHighlightsEnabled(e){this.renderContext.setBaseHighlightsEnabled(e)}visualizeInferenceSceneGraph(e){this.mainDrawPass&&(this.mainDrawPass.visualizeInferenceSceneGraph(e),this.requestDraw())}getCanvasCoordinateFromEvent(e){if(!e)return[0,0];const t=this.el.getBoundingClientRect(),i=(0,Ji.x_)();return[(e.pageX-t.left)*i,(e.pageY-t.top)*i]}getPageCoordinateFromCanvasXY(e,t){const i=(0,Ji.x_)(),s=this.el.getBoundingClientRect();return[e/i+s.left,t/i+s.top]}zoomFit(e){this.resetZoomToSelectionBounds(),this.getPrimaryViewController()?.zoomFit(this.getFitBounds(),e)}rotateInDirection(e,t){t===is.Vf$.COARSE?this.rotateInDirectionWithAngle(e,(0,yi.Yr)(X.default.getManager().getNumber("COARSE_ROTATE_ANGLE"))):t===is.Vf$.FINE?this.rotateInDirectionWithAngle(e,(0,yi.Yr)(X.default.getManager().getNumber("PRECISION_ROTATE_ANGLE"))):this.rotateInDirectionWithAngle(e,(0,yi.Yr)(X.default.getManager().getNumber("ROTATE_ANGLE")))}rotateInDirectionWithAngle(e,t){this.resetZoomToSelectionBounds(),this.getPrimaryViewController()?.rotateInDirection(e,t)}animateToStandardView(e){this.resetZoomToSelectionBounds(),this.getPrimaryViewController()?.animateToStandardView(e,this.getFitBounds(Zn[e]))}animateToStandardViewIgnoringUIPanels(e,t){this.resetZoomToSelectionBounds(),this.getPrimaryViewController()?.animateToStandardViewIgnoringUIPanels(e,this.getFitBounds(Zn[e]),t)}animateZoomFit(e){e?this.zoomToSelectionBounds=e:this.resetZoomToSelectionBounds(),this.getPrimaryViewController()?.animateZoomToFit(e||this.getFitBounds())}resetZoomToSelectionBounds(){this.zoomToSelectionBounds=null}animateZoomToRectangle(e,t,i,s){const n=this.getCamera();if(!n)return;const r=[e,t,0],a=n.canvasToWorld(r),o=[e+i,t+s,0],h=n.canvasToWorld(o),c=new yi.kB;c.addPoint(a),c.addPoint(h),this.animateZoomFit(c)}animateTo(e){this.resetZoomToSelectionBounds(),this.animateToWithBounds(e,this.getFitBounds(e))}animateToWithBounds(e,t){this.getPrimaryViewController()?.animateToFrameWithZoomFit(e,t,XS.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"))}animateRotation(e,t,i){this.getPrimaryViewController()?.animateRotation(e,t,XS.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"),i)}setWaitingForDisplayData(){this.elementLoadState=qS.WAITING_FOR_DISPLAY_DATA,this.waitingForDisplayDataTimer=new Qo.B7("Waiting for display data",iT())}setWaitingForCompareDisplayData(){this.elementLoadState=qS.WAITING_FOR_COMPARE_DISPLAY_DATA}stopWaitingForCompareDisplayData(){if(this.elementLoadState===qS.WAITING_FOR_COMPARE_DISPLAY_DATA){const e=!1;this.setGraphicsLoading(e,0)}this.elementLoadState===qS.WAITING_FOR_DISPLAY_DATA&&(this.shouldWaitForCompareDisplayData=!1)}setGraphicsLoading(e,t){this.waitingForDisplayDataTimer?.report(),this.waitingForDisplayDataTimer=null,this.loadingDisplayDataTimer=new Qo.B7("Loading display data on client",iT()),this.elementLoadState=qS.LOADING_DISPLAY_DATA,this.getEventDispatcher().trigger(yD.Wp,this.activeElementId,e,t),this.shouldWaitForCompareDisplayData=!0,this.requestDrawForInteractiveProcessing()}onNewPartStudioDisplayData(e,t){if(this.getIsPrimaryViewer()&&e.isReadyForMetricsReporting()&&(this.eventDispatcher.trigger(is.pFt,is.$_3,e.deserializeDurationInMillis,e.fromDisplayCache,e._serializedByteLength,e.elementId),e.resetTimes()),!this.canProcessDisplayData())return void this.queuedDisplayData.push({displayData:e,selectionMapper:t});const i=new Qo.B7("Viewer.onNewPartStudioDisplayData",{setTraceId:!0}),s=this.activeElementId===e.elementId||this.activeElementId===e.forCachedElement,n=this.elementLoadState===qS.WAITING_FOR_DISPLAY_DATA,r=this.elementLoadState===qS.WAITING_FOR_COMPARE_DISPLAY_DATA;let a=!1;if(!s)return void ut.log.info("Received display data for inactive element: "+e.elementId);if(ws()){const t=e.usage===k.rvN.BASE,i=e.usage===k.rvN.COMPARE_TARGET;if(n&&t)this.shouldWaitForCompareDisplayData?this.setWaitingForCompareDisplayData():a=!0;else if(r&&i)a=!0;else if(n&&i)return}else n&&(a=!0);if(a){const t=e.microversionIdAndConfigurationInterval.hasFromMicroversion()&&e.microversionIdAndConfigurationInterval.isEmptyInterval();this.setGraphicsLoading(e.fromDisplayCache||t,e.fromDisplayCache||t?100:0)}const o=this.isForFlattenedDisplay&&this.viewInitialized&&!this.isHidden();let h=!1;if(o){const e=this.getModelBounds({doNotBoundTemporarySketchEntities:!0});h=!e.isInitialized()||this.getCamera().doBoundsFitInViewport(e)}if(this.queuedBaseData&&this.queuedBaseData.elementId===e.elementId&&(this.queuedBaseData.incremental||this.modelViewManagers.resetPreviewManager(),t=this.selectionMapperForQueuedBase,this.modelViewManagers.getManager().processPartStudioDisplayData(this.queuedBaseData,t),this.queuedBaseData=null,this.selectionMapperForQueuedBase=null),e.usage===k.rvN.PREVIEW_BEFORE)return this.queuedBaseData=e,void(this.selectionMapperForQueuedBase=t);let c=this.modelViewManagers.getManager();switch(e.usage){case k.rvN.PREVIEW_AFTER:case k.rvN.PREVIEW_FINAL:case k.rvN.COMPARE_TARGET:c=this.modelViewManagers.getPreviewManager(e)}const l=ci._3.activeFeatureControllerIsSketch(),u=e.usage===k.rvN.PREVIEW_FINAL&&!l;this.setSuppressModelSelection(u),this.setBaseHighlightsEnabled(!u),this.isForPreviousVersionDisplay&&this.setSuppressModelSelection(!0),this.mainDrawPass&&this.mainDrawPass.updateHideInteriorSelections(),this.getSupportsPreview()&&(ys().latestDisplayDataUsage=e.usage);const d=c.processPartStudioDisplayData(e,t);e.usage!==k.rvN.BASE?(this.bodyLoadTasks.completeTasks(),this.getIsForFlattenedDisplay()||this.bodyManager.initiateAutomaticRetrieval(!d)):(this.bodyLoadTask.performInitialLoad(),this.bodyLoadTask.hasPendingWork()||this.getIsForFlattenedDisplay()||this.bodyManager.initiateAutomaticRetrieval(!d)),this.setUserIsManipulatingWithTimeout(),e.usage===k.rvN.BASE&&(this.performBodyCheck=!0),this.requestDrawForInteractiveProcessing(),this.detailManager.updateFromLoadedScene(),o&&h&&this.getModelBounds().isInitialized()&&this.animateZoomFit(),i.report()}onNewInsertableDisplayData(e){this.getModelViewManagers().getManager().processReceivedInsertableDisplayData(e)}onRootAssemblyDisplayData(e,t,i){if(!this.getIsForFlattenedDisplay()&&e.isReadyForMetricsReporting()&&(this.eventDispatcher.trigger(is.pFt,is.uvd,e.deserializeDurationInMillis,e.fromDisplayCache,e._serializedByteLength,e.elementId),e.resetTimes()),!this.canProcessDisplayData())return void this.queuedDisplayData.push({displayData:e,selectionMapper:null});if(!(this.activeElementId===e.elementId||t&&this.activeElementId===t.elementId))return void ut.log.info("Received display data for inactive element: "+e.elementId);if(this.elementLoadState===qS.WAITING_FOR_DISPLAY_DATA&&this.activeElementId===e.elementId&&!i){const t=e.fromDisplayCache?100:e.getPartstudioDisplayDataNoopPercent();this.setGraphicsLoading(e.fromDisplayCache,t)}const s=this.bodyLoadTask.hasPendingWork();this.modelViewManagers.getManager().processRootAssemblyDisplayData(e,t),!s&&this.bodyLoadTask.hasPendingWork()&&this.bodyLoadTask.performInitialLoad(),e.isCollapsible&&this.setUserIsManipulatingWithTimeout(),this.detailManager.updateFromLoadedScene()}updateGraphicsData(e){if(e.renderingMode!==this.getRenderingMode()&&this.setRenderingMode(e.renderingMode),e.smoothEdgeStyle!==this.getSmoothEdgesRenderStyle()&&this.setSmoothEdgesRenderStyle(e.smoothEdgeStyle),e.zebraStripeCount!==this.getZebraStripeCount()&&this.setZebraStripeCount(e.zebraStripeCount),e.zebraStripeRotation!==this.getZebraStripeRotation()&&this.setZebraStripeRotation(e.zebraStripeRotation),e.zebraStripeEdgesOn!==this.getZebraStripeEdgesOn()&&this.setZebraStripeEdgesOn(e.zebraStripeEdgesOn),e.isBoundaryEdgeHighlightOn){const e=this.setFilteredEntitiesHighlightController(this.createFilteredEntitiesHighlightController(is.i8U));e?.enable()}else{const e=this.getFilteredEntitiesHighlightController();e&&(e.disable(),this.setFilteredEntitiesHighlightController(null))}}destroyPreviewGraphics(){wS.L.resetPartListToBase(this.activeElementId),this.modelViewManagers.resetPreviewManager(),Ps(),this.mainDrawPass&&this.mainDrawPass.setHideSelectionInterior(!1),this.requestDraw()}setForceHideInteriorSelections(e){this.mainDrawPass?.setForceHideInteriorSelections(e)}updateLastMouseLocation(e){this.lastMouseLocation=this.getCanvasCoordinateFromEvent(e)}resetLastMouseLocation(){this.lastMouseLocation=[-1,-1]}raycast(e,t,i,s){let n=-1,r=null;const a=C.create(),o=this.getCamera().getRay(e,t);let h=de.create();s&&(o.point=ge.w$.multiplyVec3(s,o.point,C.create()),o.direction=C.clone(ge.w$.multiplyVec3(s,C.fromValues(o.direction[0],o.direction[1],o.direction[2]),C.create())),h=ge.w$.inverse(s));const c=i.points,l=i.indices,u=function(e){return e*=3,C.fromValues(c[e],c[e+1],c[e+2])},d=Ci.W.ZERO_LENGTH,g=this.getCamera(),p=Q.fromValues(e,t),m=C.create(),f=C.create(),I=C.create(),E=C.create(),S=C.create();for(let e=0;e<l.length-2;e++){if(l[e+2]===l[e+1]||l[e+1]===l[e]||l[e]===l[e+2])continue;const t=[u(l[e]),u(l[e+1]),u(l[e+2])];ge.S4.subtract(t[1],t[0],f),ge.S4.subtract(t[2],t[0],I),ge.S4.cross(o.direction,I,E);const i=C.dot(E,f);if(Math.abs(i)<d)continue;const s=1/i;ge.S4.subtract(o.point,t[0],m);const c=C.dot(m,E)*s;if(c<0||c>1)continue;ge.S4.cross(m,f,S);const T=C.dot(o.direction,S)*s;if(T<0||c+T>1)continue;const D=C.dot(I,S)*s;if(!(D<d)&&(n<0||n>D)){n=D,r=null;for(let e=0;e<3;e++)if(ge.gv.dist(g.projectWorldPointToCanvas(ge.w$.multiplyVec3(h,t[e],C.create())),p)<12){r=t[e],ge.S4.cross(f,I,a);break}}}return new Ce.O5(r,a)}doPick(e,t,i,s,n){const r=Os()&&!this.modelViewManagers.getPreviewManager();if(this.performingBoxSelection()||r)return!1;(n=n||{}).mouseX=e,n.mouseY=t,n.camera=this.getCamera(),n.click&&(this.getEventDispatcher().trigger(yD.rw),this.getEventDispatcher().trigger(yD.AD));const a=(0,Fs.Wj)(),o=this.pick(e,t,n);let h=!1;for(let e=0;e<o.length&&!h;++e){const t=o[e],r=t.getModelSelection();if(r&&!this.suppressModelSelection)h=(0,Ce.rQ)(r,i,s,n),h&&(i&&t.isUIPick()?this.uiSelectionManager.processUiPick(t,n):this.uiSelectionManager.handleEmptyUiPick(i,n));else if(t.isUIPick()&&(t.uiSelection.isInteractionEnabled()&&n.click&&this.getEventDispatcher().trigger(yD.fu),h=this.uiSelectionManager.processUiPick(t,n),h&&!this.suppressModelSelection)){const e=t.getUISelection();e&&!e.getClearModelSelectionsOnPrehilite()||(0,Ce.Zs)(i,!0,n)}}h||(this.suppressModelSelection||(0,Ce.Zs)(i,!1,n),this.uiSelectionManager.handleEmptyUiPick(i,n)),h&&i&&this.setUserIsManipulatingWithTimeout();const c=(0,Fs.Wj)()-a;return this.averagePickDuration<0?this.averagePickDuration=c:this.averagePickDuration=.8*this.averagePickDuration+.2*c,h}doPreHighlightPick(e){this.doPick(this.lastMouseLocation[0],this.lastMouseLocation[1],!0,!0,{skipPreHighlight:e,shiftKey:this.inputHandler?.getAltHeld()})}onDoubleClick(e,t,i){const s={};s.mouseX=e,s.mouseY=t,s.camera=this.getCamera(),s.doubleClick=!0,s.altKey=i.altKey;const n=this.pick(e,t,s);let r=!1;for(let e=0;e<n.length&&!r;++e){const t=n[e];t.isUIPick()&&(r=this.uiSelectionManager.processUiPick(t,s))}return r}getAveragePickDuration(){return Math.max(0,this.averagePickDuration)}setSuppressModelSelection(e){this.suppressModelSelection=e,this.suppressModelSelection&&this.stopBoxSelection()}getSuppressModelSelection(){return this.suppressModelSelection}getCameraPropertiesForElement(e){let t=null;const i={graphicsElementId:e=e||"",isValid:!1,projectionType:"",viewMatrix:de.create(),projectionMatrix:de.create(),verticalFieldOfView:0,viewportHeight:0,viewportWidth:0};if(this.elementToPerElementState&&this.elementToPerElementState.hasOwnProperty(e)){const s=this.elementToPerElementState[e];s&&(t=s.camera,t&&(i.isValid=!0,t.isOrthographic()?i.projectionType="orthographic":t.isPerspective()&&(i.projectionType="perspective"),i.viewMatrix=t.getViewMatrix(),i.projectionMatrix=t.getProjectionMatrix(),i.verticalFieldOfView=t.getFieldOfView(),i.viewportHeight=t.getViewportHeight(),i.viewportWidth=t.getViewportWidth()))}return i}closeSelectOtherView(){this.selectOtherView.close()}resetActiveElement(){this.modelViewManagers.getManager().resetDisplayedElement()}setActiveElement(e,t,i,s,n){if(!this.selectOtherView){const e={viewer:this};this.selectOtherView=new _S.Q(e)}if(this.selectOtherView.setActiveElement(s,n),e===this.activeElementId)return;if(this.loadTimer=new Qo.B7("Time from element switch to graphics display",iT()),ws()||this.destroyPreviewGraphics(),Rs()&&!i&&Ea(this,70,40),this.activeElementId&&this.elementToPerElementState&&this.viewInitialized){const e=this.getCamera();if(e){let t=this.elementToPerElementState[this.activeElementId];t||(t=this.elementToPerElementState[this.activeElementId]=new ZS(this.activeElementId)),t.camera=e.clone(),t.renderingMode=this.renderingMode,t.smoothEdgeStyle=this.smoothEdgeStyle,t.activeFilteredEntitiesHighlightController=this.filteredEntitiesHighlightController,t.userEnabledAggressiveRefinement=this.bodyManager.getUserEnabledAggressiveRefinement(),t.activeFilteredEntitiesHighlightController&&t.activeFilteredEntitiesHighlightController.disable(),this.getIsPrimaryViewer()&&(t.sectionViewState=(0,LS.o_)(this.activeElementId))}}let r=!1;s&&(r=s.getIsPublicationItem()),this.modelViewManagers.getManager().onChangeActiveElement(e,t,r),this.draw(),this.activeElementId=e||"";const a=t===k.GNh.PARTSTUDIO||t===k.GNh.ASSEMBLY,o=this.elementToPerElementState[this.activeElementId];if(a&&o){const e=o.camera;if(e&&(this.viewController?.isPerspective()!==e.isPerspective()&&(this.viewController?.isPerspective()?this.viewController=new Qn(this):this.viewController=new jn(this)),e.setViewportFromCanvasElement(this.$el),this.getCamera()?.copyFrom(e)),this.setZebraStripeEdgesOn(o.zebraStripeEdgesOn),this.setRenderingMode(o.renderingMode),t!==k.GNh.PARTSTUDIO&&t!==k.GNh.ASSEMBLY||this.setSmoothEdgesRenderStyle(o.smoothEdgeStyle),Ki.Jq.CapabilitiesService.checkViewCubeMenuUserPreferenceCurrentlyEnabled()&&t===k.GNh.PARTSTUDIO&&o.activeFilteredEntitiesHighlightController){const e=this.setFilteredEntitiesHighlightController(o.activeFilteredEntitiesHighlightController);e?.enable()}else this.disableCurrentLaminarHighlightController();this.getIsPrimaryViewer()&&(0,LS.Wh)(o.sectionViewState,this.activeElementId),this.bodyManager.setUserEnabledAggressiveRefinement(o.userEnabledAggressiveRefinement),"number"==typeof o.zebraStripeCount&&this.setZebraStripeCount(o.zebraStripeCount),"number"==typeof o.zebraStripeRotation&&this.setZebraStripeRotation(o.zebraStripeRotation),this.viewInitialized=!0}else this.viewController&&this.resetViewState();this.setWaitingForDisplayData(),this.readyToUpdateElementLoadState=!1,this.receivedFeatureData=!1,this.receivedAssemblyDefinition=!1,this.averagePickDuration=-1,this.frameTimer.resetTimings(),this.detailManager.onSettingStateChange(),this.uiSelectionManager.reset(),this.bodyManager.resetOccurrenceRetrieval(),qf(),this.resetLastMouseLocation(),this.setReadyState(!1);let h=ji.UNSUPPORTED;t===k.GNh.PARTSTUDIO?h=ji.PART_STUDIO:t===k.GNh.ASSEMBLY?h=ji.ASSEMBLY:this.hideWebGLContextLostMessage(),(0,yD.xA)().trigger(yD.Fc,h)}resetViewState(){this.initializedForDrawing&&(this.viewInitialized=!1,this.viewController?.isPerspective()&&(this.viewController=this.viewController.getMatchingOrthographicController()),this.viewController?.setStandardView(this.getDefaultStandardView()),Ki.Jq.UserSettingsService.getUserSettings().then((e=>{if(this.viewerPreferences.isolateHideTransparent="true"===e.isolateHideTransparent,this.viewerPreferences.isolateTranslucentMode="true"===e.isolateTranslucentMode,this.viewerPreferences.makeTransparentTranslucentMode="true"===e.makeTransparentTranslucentMode,Ki.Jq.CapabilitiesService.checkAngularViewcubeMenuCurrentlyEnabled())if(this.viewerPreferences.renderingMode=Number(e.graphicsRenderMode),this.viewerPreferences.smoothEdge=Number(e.graphicsSmoothEdge),this.viewerPreferences.highlightLaminarEdges="true"===e.highlightLaminarEdges,this.viewerPreferences.perspectiveModeOn="true"===e.perspectiveModeOn,this.setSmoothEdgesRenderStyle(Number(e.graphicsSmoothEdge)),this.setRenderingMode(Number(e.graphicsRenderMode)),Ki.Jq.CapabilitiesService.checkViewCubeMenuUserPreferenceCurrentlyEnabled()){if("true"===e.highlightLaminarEdges){const e=this.setFilteredEntitiesHighlightController(new LM(this,is.i8U));e?.enable()}else this.setFilteredEntitiesHighlightController(null);if("true"===e.perspectiveModeOn){const e=this.getCamera();e?.setSceneBounds(this.getSceneBounds());const t=this.getPrimaryViewController();this.setPrimaryViewController(t.getMatchingPerspectiveController())}}else this.setFilteredEntitiesHighlightController(null);else this.setRenderingMode(k.P1.SHADED_WITH_EDGES),this.setSmoothEdgesRenderStyle(k.YUG.VISIBLE)})),this.filteredEntitiesHighlightController&&this.filteredEntitiesHighlightController.disable(),this.bodyManager.setUserEnabledAggressiveRefinement(!1),this.debugShowSilhouetteEdgesOnNonVisibleTangentEdgeStyle=!1,this.mainDrawPass?.setZebraStripeCount(XS.getNumber("ZEBRA_STRIPE_COUNT")),this.mainDrawPass?.setZebraStripeRotation(XS.getNumber("ZEBRA_STRIPE_ROTATION")))}getViewerPreferences(){return this.viewerPreferences}updateCanvasVisibility(){this.readyState&&!this.hidden?(this.$el.show(),this.viewManipulator&&this.viewManipulator.show()):(this.$el.hide(),this.viewManipulator&&this.viewManipulator.hide())}setReadyState(e){this.readyState=e,e?this.storedCameraState&&(this.updateCamera(this.storedCameraState),this.storedCameraState=null):this===(0,Jo.N9)()&&(0,Jo.KO)(null),this.updateCanvasVisibility()}isHidden(){return this.hidden}hide(){this.hidden=!0,this.updateCanvasVisibility()}show(){this.hidden=!1,this.gl||this.setupGlContext(),this.updateCanvasVisibility(),this.modelViewManagers.getManager().onViewerShown()}setSelectionCountCursor(e){this.selectionCursor=e,0===this.cursorStack.length&&this.$el.css({cursor:e})}pushCursor(e){this.$el.css({cursor:e}),this.cursorStack.push(e)}peekCursor(){return this.cursorStack&&this.cursorStack.length>0?this.cursorStack[this.cursorStack.length-1]:null}popCursor(){0!==this.cursorStack.length?(this.cursorStack.pop(),this.cursorStack.length>0?this.$el.css({cursor:this.cursorStack[this.cursorStack.length-1]}):this.$el.css({cursor:this.selectionCursor})):ut.log.warn("Tried to pop a cursor off an empty stack in the graphics viewer")}removeTopOccurrenceOfCursor(e,t){if(0===this.cursorStack.length&&!t)return void ut.log.warn("Tried to remove a cursor from an empty stack in the graphics viewer");const i=(0,li.findLastIndex)(this.cursorStack,(function(t){return t===e}));i<0?t||ut.log.warn("Tried to remove a cursor not present on stack in graphics viewer"):i===this.cursorStack.length-1?this.popCursor():this.cursorStack.splice(i,1)}onBeforePrint(){const e=this.getCamera()?.getViewport();if(!e)return;this.printCanvas||(this.printToCanvas(e[2],e[3],e[2],e[3]),VS(this.printCanvas).css({width:"100%"}));const t=VS("body");t.addClass("printing"),t.append(this.printCanvas)}onAfterPrint(){VS(this.printCanvas).remove(),this.printCanvas=null,VS("body").removeClass("printing")}printToCanvas(e,t,i,s,n){if(!this.isReadyForDrawing())return;this.viewManipulator&&this.viewManipulator.hide();const r=this.getCamera();if(!r)return;const a=r.clone();let o=null;n&&(o={previousOverride:(0,Ji.AO)()},(0,Ji.Lt)(n));const h=r.getViewportWidth(),c=r.getViewportHeight(),l=e/i,u=i*l,d=s*l,g=h*l,p=c*l,m=(h-i)/2*l,f=(c-s)/2*l;a?.setViewport([0,0,g,p]);const I=u,E=d,S=1024,T=1024,D=1042,M=1042,C=this.el.width,y=this.el.height;this.el.width=Math.max(D,C),this.el.height=Math.max(M,y),a?.setCanvasDimensions(this.el.width,this.el.height);const P=Math.ceil(I/S),A=Math.ceil(E/T);this.printCanvas=document.createElement("canvas"),this.printCanvas.id="print-canvas",this.printCanvas.width=I,this.printCanvas.height=E;const O=this.printCanvas.getContext("2d"),v=new Uint8Array(4343056),R=O.createImageData(S,T),w=this.getGlContext(),_=[0,0,D,M];this.frameTimer.resetInteractionStatus();for(let e=0;e<A;++e)for(let t=0;t<P;++t){_[0]=m+t*S-9,_[1]=f+e*T-9,a?.setTileViewport(_);const i=null;this.draw(i,{forPrint:!0,camera:a}),w.readPixels(0,0,D,M,w.RGBA,w.UNSIGNED_BYTE,v);for(let e=0;e<T;++e)for(let t=0;t<S;++t){const i=4*((T-e-1)*S+t),s=4*((e+9)*D+t+9),n=1/(v[s+3]/255);R.data[i]=v[s]*n,R.data[i+1]=v[s+1]*n,R.data[i+2]=v[s+2]*n,R.data[i+3]=v[s+3]}O?.putImageData(R,t*S,e*T)}this.el.width=C,this.el.height=y,this.viewManipulator&&this.viewManipulator.show(),o&&(o.previousOverride?(0,Ji.Lt)(o.previousOverride):(0,Ji.eu)()),this.draw()}createPrintView(e,t,i,s,n,r,a){const o=11800;if(!this.mainDrawPass)return;const h=this.mainDrawPass.getClearColor();this.mainDrawPass.setClearColor(0,0,0,0);let c=null;if(a){c=a*o/XS.getNumber("DEFAULT_LINE_WIDTH")}this.printToCanvas(e*o,t*o,s,n,c),VS(this.printCanvas).css({width:100*e+"cm",height:100*t+"cm"}),r?this.printCanvas?.toBlob((e=>{(0,Gm.G)(e,i+".png"),this.onAfterPrint()})):window.print(),this.mainDrawPass.setClearColor(h[0],h[1],h[2],h[3])}getEntityCanvasLocation(e){const t=this.modelViewManagers.getManager().extractMeshIncrement(e);if(t&&t.points&&t.points.length>=3){const e=[t.points[0],t.points[1],t.points[2]];return this.getCamera()?.projectWorldPointToCanvas(e)}return null}triggerContextLoss(e){const t=this.getExtension("WEBGL_lose_context");t?(t.loseContext(),setTimeout((function(){t.restoreContext()}),e||500)):alert("This system does not support the context loss extension")}toggleDebugDrawPickPass(){const e=this.mainDrawPass?.getDebugDrawPickPass();e?.setEnabled(!e?.getEnabled())}isMouseInsideViewManipulator(){return!!this.viewManipulator&&this.viewManipulator.isMouseInside()}setCanEdit(e){this.canEdit=e}getCanEdit(){return this.canEdit}completeTasks(){this.taskManager.complete(),this.draw()}getSelectionFitBounds(e){if(!e)return null;const t=this.getModelViewManagers().getManagerForUsage(e.getUsage());if(!t)return null;const i=t.getSelectionFitBounds(e);if(this.getIsForFlattenedDisplay()&&i){const s=t.getDisplayedElement();if(s instanceof xd){const t=s.getBodyTransform(e.getBodyId(),this);if(t)return i.createTransformedCopy(t)}}return i}retrieveViewportAsImage(e){const t=e.width,i=e.height,s=this.getCamera();if(!s)return null;const n=s.clone();s.setViewport([0,0,t,i]),s.setCanvasDimensions(t,i);let r=this.getFitBounds();e.zoomToSelection&&(r=new yi.kB,(0,Ce.vi)().each((e=>{r.addBox(this.getSelectionFitBounds(e))})),r.isFinite()&&r.isExtensive()||ut.log.warn("zoomToSelection was requested in retrieveZoomedFitViewport but a valid bounds was not found")),(0,LS.jf)(!0),void 0===e.zoomToFit&&(e.zoomToFit=!0),e.zoomToFit&&this.getPrimaryViewController().zoomFitWithoutPanels(r),!e.showViewCube&&this.viewManipulator&&this.viewManipulator.hide(),e.useInteractiveSettings?this.frameTimer.setUserIsAdjustingCamera():this.frameTimer.resetInteractionStatus(),this.mainDrawPass?.setClearColor(1,1,1,1),this.draw();const a=new Uint8Array(t*i*4),o=this.getGlContext();return o&&o.readPixels(0,0,t,i,o.RGBA,o.UNSIGNED_BYTE,a),(0,Fs.Dy)(a,t,i),this.getCamera()?.copyFrom(n),this.mainDrawPass?.setClearColor(0,0,0,0),!e.showViewCube&&this.viewManipulator&&this.viewManipulator.show(),(0,LS.jf)(!1),{width:t,height:i,data:a}}retrievePrintedCanvasPixels(e){const t=this.createPrintOfCanvas(e.width,e.height,GS,HS,!0),i=this.printCanvas?.getContext("2d"),s=i?.getImageData(0,0,GS,HS);return this.removePrintOfCanvas(t),{width:GS,height:HS,data:s.data}}printToCanvasRenderingContext(e,t,i,s,n){const r=(0,Ji.x_)(),a=r*i,o=r*s;this.getEventDispatcher().trigger(yD.m2);const h=this.createPrintOfCanvas(a,o,a,o);this.getEventDispatcher().trigger(yD.nh),n.drawImage(this.printCanvas,e,t,i,s),this.removePrintOfCanvas(h)}createPrintOfCanvas(e,t,i,s,n){const r=this.getCamera();if(!r)return null;const a=r.clone();return r.setViewport([0,0,e,t]),n&&this.getPrimaryViewController()?.zoomFitWithoutPanels(this.getFitBounds()),this.printToCanvas(i,s,e,t),a}removePrintOfCanvas(e){VS(this.printCanvas)?.remove(),this.getCamera()?.copyFrom(e)}getViewData(e,t){const i=new k.Lf5,s=this.getCamera();let n=s.getFrame();if(e){const t=this.modelViewManagers.getManager().getOccurrenceTransform(e);if(t){const e=ge.w$.inverse(t,de.create());n=ge.w$.multiply(e,n,de.create())}}i.viewMatrix=n,i.isPerspective=s.isPerspective();const r=s;r.top&&r.bottom&&r.right&&r.left?i.cameraViewport=[r.top,r.bottom,r.right,r.left]:i.cameraViewport=[0,0,0,0];const a=s;a.angle?i.angle=a.angle:i.angle=0;const o=function(e){const t=new k.d0F;return t.x=e[0],t.y=e[1],t.z=e[2],t},h=[];return(0,LS.nL)().forEach((function(e){const t=new k.cB6;t.center=o(e.center),t.tangent=o(e.tangent),t.normal=o(e.normal),h.push(t)})),i.sectionPlaneParameters=h,t||(i.sectionViewData=(0,LS.p$)()),i}getViewDataWithPersistentSectionedItemQueries(e){return(0,LS.bm)().then((e=>{const t=this.getViewData(null,!0);return t.sectionViewData=e,t}))}animateToView(e,t){const i=this.getCameraForViewData(e,t);this.prepareViewControllerForNewCamera(e.isPerspective);const s=X.default.getManager(),n=this.getPrimaryViewController();n?.animateToCustomView(i,s.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"),e.name)}prepareViewControllerForNewCamera(e){const t=this.getPrimaryViewController();e?t?.isOrthographic()&&this.setPrimaryViewController(t.getMatchingPerspectiveController()):t?.isPerspective()&&this.setPrimaryViewController(t.getMatchingOrthographicController())}getCameraForViewData(e,t){const i=this.getCamera();i.setSceneBounds(this.getSceneBounds());let s=e.viewMatrix;const n=e.cameraViewport,r=e.angle;if(t){const e=k._oC.getOccurrenceFromPathString(t),i=this.modelViewManagers.getManager().getOccurrenceTransform(e);i&&(s=ge.w$.multiply(i,s,de.create()))}let a;return e.isPerspective?(a=i.getPerspectiveCamera(),a.angle=r):(a=i.getOrthographicCamera(),a.top=n[0],a.bottom=n[1],a.right=n[2],a.left=n[3],a.correctAspectRatio()),a.setFrame(s),a}animateIsolation(e,t){const i=X.default.getManager().getNumber("ISOLATE_CONTEXT_TRANSITION_TIME_MS"),s=(0,Fs.Wj)();this.animationController.startAnimation((n=>{const r=(0,Fs.Es)(s),a=Math.min((0,yi.CW)(0,1,r/i),1);let o=is.ZK6.ONGOING;return a>=1&&(o=is.ZK6.COMPLETE,t&&t()),Ye(e?a:1-a),o}))}onIsolateChanged(){for(const e in this.uiElements)this.uiElements[e].onIsolateChanged()}setUserIsManipulatingWithTimeout(){this.frameTimer.setUserIsManipulatingWithTimeout()}setUserIsAdjustingCamera(){this.bodyManager.onUserIsAdjustingCamera(),this.frameTimer.setUserIsAdjustingCamera()}setSystemIsAnimating(){this.frameTimer.setSystemIsAnimating()}executePerformanceTests(){return this.elementLoadState=qS.LOADED_ALL_DATA,(0,gh.Xd)(gh.oA.OFF),this.initializeForDrawing(),this.onResize(),this.viewInitialized=!0,Mf(this)}getInteractiveFrameDetails(){return this.frameTimer.getTimingDetails(is.QpP.INTERACTIVE)}getPingStats(){if(!this.isReadyForDrawing()||!this.isBrowserTabVisible||this.taskManager.hasPendingWork())return null;const e=this.getInteractiveFrameDetails(),t=this.getCamera();return e&&e.hasTimings()&&t?{framerate:e.getAverageFramerate(),triangleCount:this.modelViewManagers.getManager().getInstantiatedTriangleCount(),pixelCount:t.getViewportWidth()*t.getViewportHeight()}:null}areSectionPlanesEnabled(){return!this.isForFlattenedDisplay}onDisplayDataUsageChange(){this.detailManager.onSettingStateChange()}onDefaultUnitsChanged(e){for(const t in this.uiElements)this.uiElements[t].onDefaultUnitsChanged(e)}setDraftAnalysisPullDirection(e){this.mainDrawPass?.setDraftAnalysisPullDirection(e),this.requestDraw()}setDraftAnalysisMinimumAngle(e){this.mainDrawPass?.setDraftAnalysisMinimumAngle(e),this.requestDraw()}setDraftAnalysisParts(e){this.mainDrawPass?.setDraftAnalysisParts(e),this.requestDraw()}setDraftAnalysisShowUndercut(e){this.mainDrawPass?.setDraftAnalysisShowUndercut(e),this.requestDraw()}clearDraftAnalysis(){this.setDraftAnalysisPullDirection(null),this.setDraftAnalysisMinimumAngle(k.zG4.DEFAULT_MINIMUM_ANGLE_RADIANS),this.setDraftAnalysisParts([])}getRenderingModeOfElement(e){const t=this.elementToPerElementState[e];return t?t.renderingMode:null}updateElementPreviewNodeVisibility(e){const t=this.getModelViewManagers().getManager().getElementRootNode().getParent();if(t)for(let i=0;i<t.getChildCount();++i)t.getChildByIndex(i).setVisible(!e);const i=this.getModelViewManagers().getManager().getElementPreviewRootNode();i&&i.setVisible(e)}onElementPreviewDisplayData(e){ut.log.trace("Invoking onElementPreviewDisplayData for element "+e.elementId),this.activeElementId===e.elementId&&this.elementLoadState!==qS.LOADED_ALL_DATA?(this.activeElementPreviewManager=new dl(this),this.activeElementPreviewManager.processGLDisplayDataResponse(e),this.hasElementPreviewLoaded=!0,this.setReadyState(!0),this.updateElementPreviewNodeVisibility(!0),this.requestDraw(),this.getEventDispatcher().trigger(yD.Vp,this.activeElementId),ut.log.trace("Drawing Preview for element "+e.elementId)):ut.log.trace("Skipping processing previewDisplayData because display data has been loaded "+e.elementId)}clearElementPreview(){this.updateElementPreviewNodeVisibility(!1),this.activeElementPreviewManager&&(ut.log.trace("Removing elementPreviewManager for elementId "+this.activeElementId),this.activeElementPreviewManager.destroy(),this.activeElementPreviewManager=null,this.requestDraw()),this.hasElementPreviewLoaded=!1}getCameraData(e){const t={camera:null,cameraExtents:null};let i=ge.w$.inverse(e,de.create());return i||(i=de.create()),t.camera=this.getCamera().clone(),t.camera.setFrame(ge.w$.multiply(i,t.camera.getFrame())),this.getCamera()?.isOrthographic()&&(t.cameraExtents=this.getCamera().getExtents()),t}updateCamera(e){const t=e.camera;t&&e.honorPerspective&&this.prepareViewControllerForNewCamera(t.isPerspective());const i=this.getCamera();i.isOrthographic()&&e.cameraExtents&&i.setExtents(e.cameraExtents),t&&(e.honorPerspective?i.copyFrom(t):i.copyFrom(t.getOrthographicCamera())),i.setViewportFromCanvasElement(this.$el),this.setViewInitialized(!0)}storeCameraState(e){this.storedCameraState=e}setInterferenceCallId(e){this.interferenceCallId=e}getInterferenceCallId(){return this.interferenceCallId}createDistanceDisplay(e,t){return new uM(e,t,this)}createAngleDisplay(e,t,i,s,n,r){return new dM(e,t,i,s,n,r,this)}getDimensionComponent(){const e=this.getModelViewManagers().getManager().getDisplayedPartStudio();return e?e.getDimensionComponent():null}createCombDisplay(e,t,i,s,n){return new gM(e,t,i,s,n,this)}createAngularDimension(e,t){return new BI.$R(this,e,t)}createCurveLengthDimension(e,t){return new BI.U8(this,e,t)}createLinearDimension(e,t){return new BI.mI(this,e,t)}createEllipseDiameterDimension(e,t){return new BI.Xk(this,e,t)}createRadialDimension(e,t){return new BI.nl(this,e,t)}createArcLengthDimension(e,t){return new BI.uU(this,e,t)}createCenterlineDimension(e,t){return new BI.SM(this,e,t)}createCountDimension(e,t){return new BI.JO(this,e,t)}createBezierDegreeDimension(e,t){return new BI.z$(this,e,t)}createAngularWithArrowManipulator(){return new vr(this)}createLinearManipulator(e){return new Tr(this,e)}createPlanarManipulator(e){return new yr(this,e)}createTriadManipulator(e,t){return new Fr._(this,e,t)}createFeatureManipulator(e,t){return(0,ml.wA)(e,this,t)}createLinearToolPreview(e,t,i,s,n){return Xs(e,t,i,s,this,n)}createAngularToolPreview(e,t,i,s,n){return Ws(e,t,i,s,n,this)}createAxes(e){return new Yi(this,e)}createEmptyBoundingBox(){return new yi.kB}createOrthographicCamera(){return new oh}createPerspectiveCamera(){return new ah}createCommentIndicator(e,t){return new Cd(e,t,this)}createCenterOfMassIndicator(e){return new yd(e,this)}createFeatureDisplay(e){return new Qf(e,this)}createControlPointGridDisplay(e,t,i){return new Vp(e,t,i,this)}createEdgeCurvatureDisplay(e,t,i,s,n,r){return new nm(e,t,i,s,n,this,r)}createDihedralDisplay(e,t,i,s){return new Im(e,t,i,s,0,0,!1,this)}createDihedralExtremaDisplay(e,t,i,s,n){return new Sm(e,t,i,s,n,this)}createFixedMateIndicator(e,t){return new Vg(e,t,this)}createImageDisplay(e,t,i,s,n,r,a,o,h,c){return new Gn(e,t,i,s,n,r,a,this,o,h,c)}createInferenceDisplay(e,t){return new Yd(e,this,t)}createInferencePicker(e,t,i){return new WT(this,e,t,i)}createInterferenceDisplay(e,t,i,s,n,r,a){return new ZT(e,this,t,i,s,n,r,a)}createFilteredEntitiesHighlightController(e){return new LM(this,e)}createMateConnectorManager(){return this.activeMateConnectorManager=new cn.d,this.activeMateConnectorManager}destroyMateConnectorManager(){this.activeMateConnectorManager&&(this.activeMateConnectorManager.destroy(),this.activeMateConnectorManager=null)}getMateConnectorManager(){return this.activeMateConnectorManager}setMateConnectorInteractionEnabled(e){hl.setInteractionEnabled(e)}createMeshIncrement(e,t,i,s,n){return new vE(e,t,i,s,n)}createSnapIndicator(){return new $d(this)}createPointElement(e,t,i,s,n){return new Zl(e,t,i,s,this,n)}createSilhouette(e){return new iI(e,this)}canUserEnableAggressiveRefinement(){return!JS.has(this.renderingMode)}getUserEnabledAggressiveRefinement(){return this.bodyManager.getUserEnabledAggressiveRefinement()}setUserEnabledAggressiveRefinement(e){return this.getUserEnabledAggressiveRefinement()||!e||this.canUserEnableAggressiveRefinement()?(this.bodyManager.setUserEnabledAggressiveRefinement(e),!0):(Ki.Jq.MessageBubbleService.showMessageWithAutoDismiss(i18n("Viewing in high quality is disabled for this view mode."),"warning"),!1)}getOrCreateActiveElementViewerState(){let e=this.elementToPerElementState[this.activeElementId];return void 0===e&&(e=this.elementToPerElementState[this.activeElementId]=new ZS(this.activeElementId)),e}getActiveElementViewerState(){return this.elementToPerElementState[this.activeElementId]}setZebraStripeCount(e){this.getOrCreateActiveElementViewerState().zebraStripeCount=e,this.mainDrawPass?.setZebraStripeCount(e),this.getIsPrimaryViewer()&&(this.followGraphicsData.zebraStripeCount=e,this.followGraphicsDataSubject.next(this.followGraphicsData))}setZebraStripeRotation(e){this.getOrCreateActiveElementViewerState().zebraStripeRotation=e,this.mainDrawPass?.setZebraStripeRotation(e),this.getIsPrimaryViewer()&&(this.followGraphicsData.zebraStripeRotation=e,this.followGraphicsDataSubject.next(this.followGraphicsData))}getZebraStripeCount(){return this.getActiveElementViewerState()?.zebraStripeCount??XS.getNumber("ZEBRA_STRIPE_COUNT")}getZebraStripeRotation(){return this.getActiveElementViewerState()?.zebraStripeRotation??XS.getNumber("ZEBRA_STRIPE_ROTATION")}getZebraStripeEdgesOn(){return this.getActiveElementViewerState()?.zebraStripeEdgesOn??!0}setZebraStripeEdgesOn(e){this.getOrCreateActiveElementViewerState().zebraStripeEdgesOn=e,this.renderingMode===k.P1.CURVATURE_VISUALIZATION&&this.setRenderingMode(this.renderingMode),this.requestDraw(),this.getIsPrimaryViewer()&&(this.followGraphicsData.zebraStripeEdgesOn=e,this.followGraphicsDataSubject.next(this.followGraphicsData))}getRenderModeObservable(){return this.renderModeSubject.asObservable()}logDisplayDataRefinementState(){ut.log.info("Display data refinement state logged. Details:\n\n"+this.bodyManager.getDisplayDataRefinementState())}unloadSelectedBodies(){(0,Ce.vi)().each((e=>{this.bodyManager.unloadSelectionBody(e)}))}isIsolateEffectInUseForVisualization(){const e=this.modelViewManagers.getManager().getSimulationManager();return!!e&&e.isIsolateEffectActive()}onBrowserTabVisibilityChanged(){switch(document.visibilityState){case"hidden":this.isBrowserTabVisible=!1;break;case"visible":this.isBrowserTabVisible=!0,this.frameTimer.resetTimings()}}getCurvatureAnalysisManager(){return this.curvatureAnalysisManager}getThicknessAnalysisManager(){return this.modelViewManagers.getManager()?.getThicknessAnalysisManager()??null}getXrController(){return this.xrController}get isOngoingRenderLoopRunning(){return this.xrController?.getIsXrRunning()}getXrInputCamera(e){const t=new oh;t.setFrame(de.multiply(de.create(),this.xrController.modelTransformInverse,e.worldSpacePose)),t.setViewportFromCanvasElement(this.$el);const i=1e-4,s=t.getViewportWidth()*i*.5,n=t.getViewportHeight()*i*.5;t.setExtentsByComponent(-s,s,-n,n),t.sceneBounds=this.getSceneBounds();const r=GM,a=Math.max(t.near+.001,C.dot(t.getForward(),C.subtract(C.create(),t.sceneBounds.center(),t.getEye()))+t.sceneBounds.diameter()/2);return t.setNearFar(r,a),t}pickWithXrInput(e){if(e.picks)return e.picks;const t=this.getXrInputCamera(e),i=t.getViewportWidth()/2,s=t.getViewportHeight()/2;return e.picks=this.pickIteratively(i,s,this.getDefaultPickTerminationEvaluator(),{cameraOverride:t}),e.picks}getDepthForXrInput(e){const t=this.getXrInputCamera(e),i=t.getViewportWidth()/2,s=t.getViewportHeight()/2,n=this.findDepthsInRect(i-2,s-2,5,5,!1,t);if(0===n.length)return-1;let r=0;const a=e.modelSpaceRay;for(const e of n)r+=a.findPositionOfPoint(t.canvasToWorld(e));return r/n.length}getIsSynchingView(){return this.isSynchingView}setIsSynchingView(e){this.isSynchingView=e,this.pairedViewer&&(this.pairedViewer.isSynchingView=e)}setShouldUpdatePairedViewer(e){this.shouldUpdatePairedViewer=e}syncPairedView(){if(!this.pairedViewer.getCamera())return;const e=this.getCameraData(de.identity(de.create()));e.honorPerspective=!0,this.pairedViewer.updateCamera(e),this.pairedViewer.setShouldUpdatePairedViewer(!1),this.pairedViewer.requestDraw()}onAppearanceConstantsUpdated(){this.resources.onAppearanceConstantsUpdated();for(const e of Object.values(this.uiElements))e.onAppearanceConstantsUpdated();const e=this.getReferenceHighlights();Object.values(e.highlights).forEach((t=>{e.updateHighlightColor(t.type)})),this.getModelViewManagers().onAppearanceConstantsUpdated(),this.mainDrawPass?.onAppearanceConstantsUpdated(),this.requestDraw()}onActiveFeatureChanged(e){for(const t of[this.modelViewManagers.getManager(),this.modelViewManagers.getPreviewManager()])if(t){const i=t.getDisplayedPartStudio()?.getDimensionComponent();i&&i.onActiveFeatureChanged(e)}}onActiveAnnotationChanged(e){const t=this.modelViewManagers.getManager();if(t){const i=t.getDisplayedPartStudio()?.getAnnotationComponent();i&&i.onActiveAnnotationChanged(e)}}createLineDisplay(e,t,i){return new Ks(this,e,t,i)}}function tT(e){return new eT({el:e,disableAutomaticDrawing:!0,disableInput:!0,disableViewManipulator:!0})}function iT(){if(localStorage.getItem("osDisplayDataTimersLoggingEnabled"))return{logResult:!0}}var sT=i(19962),nT=i(10783),rT=i(35692);const aT=i(94807),oT=X.default.getManager(),hT="viewManipulatorEvent";let cT=null;function lT(e){cT=e}var uT;function dT(e){return 0===e.indexOf("Trimetric")}!function(e){e.TOP="Top",e.BOTTOM="Bottom",e.FRONT="Front",e.BACK="Back",e.RIGHT="Right",e.LEFT="Left",e.TRIMETRIC_TOP_RIGHT_FRONT="Trimetric",e.TRIMETRIC_TOP_LEFT_FRONT="TrimetricTopLeftFront",e.TRIMETRIC_TOP_RIGHT_BACK="TrimetricTopRightBack",e.TRIMETRIC_TOP_LEFT_BACK="TrimetricTopLeftBack",e.TRIMETRIC_BOTTOM_RIGHT_FRONT="TrimetricBottomRightFront",e.TRIMETRIC_BOTTOM_LEFT_FRONT="TrimetricBottomLeftFront",e.TRIMETRIC_BOTTOM_RIGHT_BACK="TrimetricBottomRightBack",e.TRIMETRIC_BOTTOM_LEFT_BACK="TrimetricBottomLeftBack",e.LEFT_ARROW="LeftArrow",e.RIGHT_ARROW="RightArrow",e.UP_ARROW="UpArrow",e.DOWN_ARROW="DownArrow",e.CW_ARROW="CwArrow",e.CCW_ARROW="CcwArrow",e.VIEW_CONTROL_ICON="ViewCtrlIcon"}(uT||(uT={}));const gT=new xi.hF({primitiveType:Di.MX.TRIANGLES,material:bi,zOffset:2}),pT=new xi.hF({isPickable:!1,primitiveType:Di.MX.LINES,isVisible:!1}),mT=new xi.hF({isPickable:!1,primitiveType:Di.MX.LINES}),fT=mT,IT=new xi.hF({isPickable:!1,isShowThrough:!0,isDepthTested:!1,isStencilTested:!0,primitiveType:Di.MX.LINES}),ET=new xi.hF({isPickable:!1,primitiveType:Di.MX.TRIANGLES,material:null}),ST=new xi.hF({isPickable:!1,isShowThrough:!0,isDepthTested:!1,primitiveType:Di.MX.TRIANGLES,material:null});let TT;const DT=.5,MT=.5*oT.getNumber("VIEW_CUBE_ARROW_WIDTH"),CT=.5*oT.getNumber("VIEW_CUBE_ARROW_HEIGHT"),yT=DT-CT;function PT(){return(DT-2*MT)/1.6-oT.getNumber("VIEW_CUBE_AXIS_TEXT_HEIGHT_PX")/TT/1.5}let AT;const OT="viewmanipulator",vT="viewmanipulatorbuttons",RT=".highlight";class wT extends Ti.u1{constructor(e){super(e,Zo.EG),this.staticIncrements=null,this.cubeCenter=[0,0,0],this.setId(vT),this.highlightedId=Ti.ZJ;for(const e of Object.values(uT))this.listenTo(this,Ti.zw.CLICK+e,this.onMouseClick),this.listenTo(this,Ti.zw.MOUSE_ENTER+e,this.onMouseEnter),this.listenTo(this,Ti.zw.MOUSE_LEAVE+e,this.onMouseLeave),e===uT.VIEW_CONTROL_ICON&&this.listenTo(this.viewer.getEventDispatcher(),yD.oL,this.unselectViewControlIcon)}onDevicePixelRatioChanged(e){this.staticIncrements=null,this.updateGraphics()}setCubeCenter(e){this.cubeCenter=e}getStaticIncrements(){if(this.staticIncrements)return this.staticIncrements;const e=this;this.staticIncrements={};const t=function(t,i,s,n){ge.S4.scale(i,TT),ge.S4.scale(s,TT),ge.S4.scale(n,TT);const r=t+"Face",a=(0,Au.aT)(i,s,n);e.staticIncrements[r]={selection:t,data:a,type:gT,color:oT.getColor("VIEW_CUBE_ARROW_COLOR")}};t(uT.LEFT_ARROW,[-.5,0,-.5],[-yT,-MT,-.5],[-yT,MT,-.5]),t(uT.RIGHT_ARROW,[DT,0,-.5],[yT,MT,-.5],[yT,-MT,-.5]),t(uT.UP_ARROW,[0,DT,-.5],[-MT,yT,-.5],[MT,yT,-.5]),t(uT.DOWN_ARROW,[0,-.5,-.5],[MT,-yT,-.5],[-MT,-yT,-.5]);const i=Math.sin(Math.PI/4),s=Math.cos(Math.PI/4),n=Math.sin(Math.PI/4-CT/DT),r=Math.cos(Math.PI/4-CT/DT);t(uT.CW_ARROW,[s*DT,i*DT,-.5],[s*(DT-2*MT),i*(DT-2*MT),-.5],[r*(DT-MT),n*(DT-MT),-.5]),t(uT.CCW_ARROW,[-s*(DT-2*MT),i*(DT-2*MT),-.5],[-s*DT,i*DT,-.5],[-r*(DT-MT),n*(DT-MT),-.5]);const a=function(t,i,s){const n=Math.ceil(36*Math.abs(s-i)/Math.PI),r=(DT-MT-oT.getNumber("VIEW_CUBE_ARROW_ARC_WIDTH")/2)*TT,a=(DT-MT+oT.getNumber("VIEW_CUBE_ARROW_ARC_WIDTH")/2)*TT,o=(0,Au.zl)([0,0,0],r,[0,0,1],n,[1,0,0],i,s),h=(0,Au.zl)([0,0,0],a,[0,0,1],n,[1,0,0],i,s),c=(h.length+o.length)/3,l=new Float32Array(3*c);for(let e=0;e<c/2;++e)l[6*e+0]=o[3*e+0],l[6*e+1]=o[3*e+1],l[6*e+2]=o[3*e+2],l[6*e+3]=h[3*e+0],l[6*e+4]=h[3*e+1],l[6*e+5]=h[3*e+2];const u=t+"ArcFace",d=new Float32Array(3*c);for(let e=0;e<c;++e)d[3*e+0]=0,d[3*e+1]=0,d[3*e+2]=1;const g=new Int32Array(6*(c/2-1));for(let e=0;e<c/2-1;++e)g[6*e+0]=2*e+0,g[6*e+1]=2*e+1,g[6*e+2]=2*e+2,g[6*e+3]=2*e+1,g[6*e+4]=2*e+3,g[6*e+5]=2*e+2;const p=new vE(Di.MX.TRIANGLES,l,g);p.normals=d,e.staticIncrements[u]={selection:t,data:p,type:gT,color:oT.getColor("VIEW_CUBE_ARROW_COLOR")}};return a(uT.CW_ARROW,.25*Math.PI,.4*Math.PI),a(uT.CCW_ARROW,.6*Math.PI,.75*Math.PI),e.staticIncrements}updateGraphics(){this.updateIncrementsOnEntity(uT.LEFT_ARROW,"Face"),this.updateIncrementsOnEntity(uT.RIGHT_ARROW,"Face"),this.updateIncrementsOnEntity(uT.UP_ARROW,"Face"),this.updateIncrementsOnEntity(uT.DOWN_ARROW,"Face"),this.updateIncrementsOnEntity(uT.CW_ARROW,"Face"),this.updateIncrementsOnEntity(uT.CCW_ARROW,"Face"),this.updateIncrementsOnEntity(uT.CW_ARROW,"ArcFace"),this.updateIncrementsOnEntity(uT.CCW_ARROW,"ArcFace")}updateIncrementsOnEntity(e,t){const i=this,s=this.getStaticIncrements();(s[e+t].type===gT||s[e+t].type===mT&&s[e+t].color)&&(0,Au.Ab)(i.highlightedId===s[e+t].selection?oT.getColor("VIEW_CUBE_FACE_HIGHLIGHT"):s[e+t].color,s[e+t].data),this.updateMeshIncrement(e+t,s[e+t].selection,s[e+t].data.clone(),s[e+t].type)}updateTransform(){const e=de.create();e[12]=this.cubeCenter[0],e[13]=this.cubeCenter[1],e[14]=this.cubeCenter[2],this.setTransform(e),this.hasMeshIncrements()||this.updateGraphics()}onMouseClick(e,t,i){this.trigger(hT,e.selectionId),Ki.Jq.AnalyticsService.trackEventForDocumentId("VIEW_CUBE_COMMAND","click_"+e.selectionId,(0,kr.n)());let s="";uT.LEFT_ARROW===e.selectionId?s="left":uT.RIGHT_ARROW===e.selectionId?s="right":uT.UP_ARROW===e.selectionId?s="up":uT.DOWN_ARROW===e.selectionId?s="down":uT.CW_ARROW===e.selectionId?s="clockwise":uT.CCW_ARROW===e.selectionId&&(s="counterclockwise"),s&&(t.shiftKey?this.viewer.rotateInDirection(s,is.Vf$.COARSE):t.ctrlKey?this.viewer.rotateInDirection(s,is.Vf$.FINE):this.viewer.rotateInDirection(s,is.Vf$.DEFAULT),i.requestSelectedStatus=!1)}unselectViewControlIcon(){this.highlightedId===uT.VIEW_CONTROL_ICON&&(this.highlightedId=Ti.ZJ,this.updateGraphics()),this.viewer.requestDraw()}onMouseEnter(e,t){this.highlightedId=e.selectionId,this.updateGraphics(),this.viewer.requestDraw()}onMouseLeave(e,t){this.highlightedId===e.selectionId&&(this.highlightedId=Ti.ZJ,this.updateGraphics()),this.viewer.requestDraw()}isViewManipulator(){return!0}shouldTreatCtrlClickAsClick(e){return e.which===is.tcH.LEFT&&e.ctrlKey}}const _T="label",NT="label.showthrough",bT=(0,yi.Yr)(oT.getNumber("VIEW_CUBE_AXIS_LABEL_FADE_START_ANGLE")),LT=(0,yi.Yr)(oT.getNumber("VIEW_CUBE_AXIS_LABEL_FADE_END_ANGLE"));class FT extends Ti.u1{constructor(e,t,i,s){super(s,Zo.EG),this.label=e,this.direction=t,this.colorName=i,this.labelTexture=null,this.center=[0,0,0,0],this.cubeCenter=C.create(),this.lastSetOpacity=-1,this.nodeProperties=new xi.hF(ET),this.nodeProperties.material=Fi(),this.nodeProperties.updateId(),this.showThroughNodeProperties=new xi.hF(ST),this.showThroughNodeProperties.material=this.nodeProperties.material,this.showThroughNodeProperties.updateId(),this.ensureTexture()}onDevicePixelRatioChanged(e){this.refreshGraphics()}onAppearanceConstantsUpdated(){this.refreshGraphics()}refreshGraphics(){this.labelTexture&&(this.labelTexture.destroy(),this.labelTexture=null),this.viewer.getGlContext()&&(this.ensureTexture(),this.updateIncrements())}remove(){this.labelTexture&&this.labelTexture.destroy(),this.nodeProperties.material&&(this.nodeProperties.material.destroy(),this.nodeProperties.material=null),super.remove()}updateIncrements(){if(!this.labelTexture)return;const e=oT.getNumber("VIEW_CUBE_AXIS_TEXT_HEIGHT_PX"),t=this.labelTexture.filledWidthPx,i=(0,Au.fQ)([-t/2,-e/2,0],[t/2,-e/2,0],[-t/2,e/2,0],void 0,[this.labelTexture.leftCoordinate,this.labelTexture.bottomCoordinate],[this.labelTexture.rightCoordinate,this.labelTexture.topCoordinate]);(0,Au.Ab)([1,1,1,.5],i),this.updateMeshIncrement(_T,Ti.ZJ,i,this.nodeProperties);const s=i.clone();(0,Au.Ab)([1,1,1,oT.getNumber("VIEW_CUBE_HIDDEN_AXIS_OPACITY")],s),this.updateMeshIncrement(NT,Ti.ZJ,s,this.showThroughNodeProperties);const n=TT*AT,r=oT.getNumber("VIEW_CUBE_AXIS_GAP"),a=[-n-r,-n-r,-n-r],o=Math.sqrt(t*t+e*e)/2+3,h=ge.S4.add(ge.S4.scale(this.direction,2*n+o,C.create()),a);this.center=[h[0],h[1],h[2],0]}ensureTexture(){this.viewer.getGlContext()&&(this.labelTexture||(this.labelTexture=_o(this.viewer,this.label,{color:oT.getColor(this.colorName),font:oT.getString("VIEW_CUBE_TEXT_FONT"),size:oT.getNumber("VIEW_CUBE_AXIS_TEXT_HEIGHT_PX")}),this.nodeProperties.material.ambientTexture=this.labelTexture,this.showThroughNodeProperties.material.ambientTexture=this.labelTexture,this.updateIncrements()))}setCubeCenter(e){this.cubeCenter=e}setOpacity(e){if(e===this.lastSetOpacity)return;const t=new Uint8Array([255,255,255,255*e]);this.updateIncrementAttribute(_T,sE.COLOR,t),t[3]=255*Math.min(e,oT.getNumber("VIEW_CUBE_HIDDEN_AXIS_OPACITY")),this.updateIncrementAttribute(NT,sE.COLOR,t),this.lastSetOpacity=e}updateTransform(e){const t=Math.acos(Math.abs(C.dot(e.getForward(),this.direction))),i=(0,yi.CW)(LT,bT,t);this.setOpacity(i);const s=ge.w$.multiplyVec4(e.getViewMatrix(),this.center,y.create()),n=ge.S4.add(s,this.cubeCenter);this.setTransform(ge.w$.translate(de.create(),n))}}let xT=class extends vS.View{constructor(e,t){super(t),this.contextMenuMgr=e}initialize(e){this.viewer=e.viewer,this.parentManipulator=e.parentManipulator,this.mouseMoveFunction=e=>this.onMouseMove(e),this.mouseUpFunction=e=>this.onMouseUp(e),this.distanceDraggedPx=0,this.rightPostion=-1,this.topPosition=-1,this.$el.hide(),this.$el.html(aT()),this.$el.attr("data-bs-original-title",i18n("Camera and render options")),this.userLanguageChangeSubscription=Ki.Jq.LocaleService.getUserLanguageChangeObservable().subscribe((()=>{this.$el.attr("data-bs-original-title",i18n("Camera and render options"))}));const t=oT.getNumber("VIEW_CUBE_SCREEN_SIZE_PX")/(0,Ji.x_)();this.$el.find(".os-view-cube-bounds").css({width:t+"px",height:t+"px",right:0,bottom:"5px"})}remove(){return this.userLanguageChangeSubscription.unsubscribe(),super.remove()}appendToCanvasParent(){this.$el.appendTo(this.viewer.$el.parent()),this.delegateEvents()}position(e,t){this.rightPostion===e&&this.topPosition===t||(this.$el.css({right:e,top:t}),this.rightPostion=e,this.topPosition=t)}onClick(){this.distanceDraggedPx<=oT.getNumber("LEFT_MOUSE_DRAG_DISTANCE_TOLERANCE")&&Ki.Jq.CapabilitiesService.isAngularViewcubeMenuEnabled().then((e=>{e?cT?.toggleViewCubeMenuVisibility(this.$el,this.viewer):this.$el.hasClass("os-dropdown-open")?this.contextMenuMgr.closeAllContextMenus():rT("#content-div .viewControlPopup").osContextMenu()})),this.distanceDraggedPx=0}getCanvasPositionFromEvent(e){const t=this.viewer.getCanvasCoordinateFromEvent(e);return{mouseX:t[0],mouseY:t[1]}}onMouseDown(e){this.viewer.isReadyForDrawing()&&(Ki.Jq.FlyoutService.collapseAllFlyouts(),1===e.which&&(this.parentManipulator.setDragStart(this.getCanvasPositionFromEvent(e)),rT(document).on("mousemove",this.mouseMoveFunction),rT(document).on("mouseup",this.mouseUpFunction)))}onMouseMove(e){this.viewer.isReadyForDrawing()&&(this.distanceDraggedPx+=this.parentManipulator.updateDragPosition(this.getCanvasPositionFromEvent(e)))}onMouseUp(e){rT(document).off("mousemove",this.mouseMoveFunction),rT(document).off("mouseup",this.mouseUpFunction)}};xT=(0,sT.__decorate)([(0,nT.g)({className:"os-graphics-dropdown",events:{click:"onClick",mousedown:"onMouseDown"}}),(0,sT.__metadata)("design:paramtypes",[Object,Object])],xT);class BT extends Ti.u1{constructor(e,t){super(e,Zo.EG),this.contextMenuMgr=t,this.labelTextures={},this.labelProperties={},this.topRightCorner=C.create(),this.center=C.create(),this.staticIncrements=null,this.axisLabels={},this.dropdownButton=null,this.i18next=i18n,"function"!=typeof this.i18next&&(this.i18next=function(e){return e}),TT=oT.getNumber("VIEW_CUBE_SCREEN_SIZE_PX"),AT=PT(),this.setId(OT),this.highlightedId=Ti.ZJ,this.oldDevicePixelRatio=(0,Ji.x_)(),this.manipulatorButtons=new wT(this.viewer),this.listenTo(this.viewer.getEventDispatcher(),yD.pO,this.ensureTextures);for(const e of Object.values(uT))this.listenTo(this,Ti.zw.CLICK+e,this.onMouseClick),this.listenTo(this,Ti.zw.MOUSE_ENTER+e,this.onMouseEnter),this.listenTo(this,Ti.zw.MOUSE_LEAVE+e,this.onMouseLeave),this.listenTo(this,Ti.zw.DRAG_START+e,this.onDragStart),this.listenTo(this,Ti.zw.DRAG+e,this.onDrag),this.listenTo(this,Ti.zw.DRAG_STOP+e,this.onDragStop),this.listenTo(this.manipulatorButtons,Ti.zw.DRAG_START+e,this.onDragStart),this.listenTo(this.manipulatorButtons,Ti.zw.DRAG+e,this.onDrag),this.listenTo(this.manipulatorButtons,Ti.zw.DRAG_STOP+e,this.onDragStop);this.axisLabels.X=new FT("X",[1,0,0],"X_AXIS_COLOR",this.viewer),this.axisLabels.Y=new FT("Y",[0,1,0],"Y_AXIS_COLOR",this.viewer),this.axisLabels.Z=new FT("Z",[0,0,1],"Z_AXIS_COLOR",this.viewer),this.viewer.getIsPrimaryViewer()&&(this.dropdownButton=new xT(t,{viewer:this.viewer,parentManipulator:this})),this.ensureTextures(),this.userLanguageChangeSubscription=Ki.Jq.LocaleService.getUserLanguageChangeObservable().subscribe((()=>{this.refreshGraphics()}))}onDevicePixelRatioChanged(e){const t=(0,Ji.x_)();ge.S4.scale(this.topRightCorner,t/this.oldDevicePixelRatio),this.oldDevicePixelRatio=t,TT=oT.getNumber("VIEW_CUBE_SCREEN_SIZE_PX"),AT=PT(),this.refreshGraphics(),this.updateDropdownPosition()}onAppearanceConstantsUpdated(){this.refreshGraphics()}refreshGraphics(){this.staticIncrements=null,this.destroyTextures(),this.viewer.getGlContext()&&(this.ensureTextures(),this.updateGraphics())}destroyTextures(){Object.values(this.labelTextures).forEach((function(e){e.destroy()})),this.labelTextures={}}remove(){Object.values(this.labelProperties).forEach((function(e){e.material&&(e.material.destroy(),e.material=null)})),this.dropdownButton&&this.dropdownButton.remove(),this.userLanguageChangeSubscription.unsubscribe(),super.remove()}hide(){super.hide(),this.manipulatorButtons.hide(),Object.values(this.axisLabels).forEach((function(e){e.hide()})),this.dropdownButton&&this.dropdownButton.$el.hide()}show(){super.show(),this.manipulatorButtons.show(),Object.values(this.axisLabels).forEach((function(e){e.show()})),this.dropdownButton&&(this.dropdownButton.appendToCanvasParent(),this.dropdownButton.$el.show())}getPickPriority(e){return dT(e.selectionId)?qm.z.UI+5:qm.z.UI}onViewWillDraw(e,t){this.updateTransform(e),this.manipulatorButtons.updateTransform();for(const t in this.axisLabels)this.axisLabels[t].updateTransform(e)}ensureTextures(){if(!this.viewer.getGlContext())return;const e=this,t=function(t,i,s,n){e.labelTextures[t]||(e.labelTextures[t]=_o(e.viewer,i,{color:n?oT.getColor("VIEW_CUBE_TEXT_COLOR_HIGHLIGHT"):oT.getColor("VIEW_CUBE_TEXT_COLOR"),font:oT.getString("VIEW_CUBE_TEXT_FONT"),size:s,paddingWithinBorder:oT.getNumber("VIEW_CUBE_TEXT_BACKGROUND_PADDING")}));let r=e.labelProperties[t];r||(r=new xi.hF(ET),r.material=Fi(),e.labelProperties[t]=r),r.material.ambientTexture=e.labelTextures[t],r.updateId()},i=function(e,i,s){t(e,i,s,!1),t(e+RT,i,s,!0)};i(uT.TOP,this.i18next("Top"),oT.getNumber("VIEW_CUBE_TEXT_HEIGHT_PX")),i(uT.BOTTOM,this.i18next("Bottom"),oT.getNumber("VIEW_CUBE_TEXT_HEIGHT_PX")),i(uT.FRONT,this.i18next("Front"),oT.getNumber("VIEW_CUBE_TEXT_HEIGHT_PX")),i(uT.BACK,this.i18next("Back"),oT.getNumber("VIEW_CUBE_TEXT_HEIGHT_PX")),i(uT.RIGHT,this.i18next("Right"),oT.getNumber("VIEW_CUBE_TEXT_HEIGHT_PX")),i(uT.LEFT,this.i18next("Left"),oT.getNumber("VIEW_CUBE_TEXT_HEIGHT_PX"));for(const e in this.axisLabels)this.axisLabels[e].ensureTexture()}updateCenter(e){const t=e.getViewport(),i=-hh(t)[0]-.5*TT;this.center=ge.S4.add([t[0]+t[2]-TT/2,t[1]+t[3]-TT/2,i],this.topRightCorner);const s=t[0]+oT.getNumber("VIEW_CUBE_LEFT_MARGIN_PX")+TT/2,n=t[1]+oT.getNumber("VIEW_CUBE_BOTTOM_MARGIN_PX")+TT/2,r=t[0]+t[2]-oT.getNumber("VIEW_CUBE_RIGHT_MARGIN_PX")-TT/2,a=t[1]+t[3]-oT.getNumber("VIEW_CUBE_TOP_MARGIN_PX")-TT/2;this.center[0]=Math.min(Math.max(s,this.center[0]),r),this.center[1]=Math.min(Math.max(n,this.center[1]),a),this.topRightCorner=[this.center[0]+TT/2-t[0]-t[2],this.center[1]+TT/2-t[1]-t[3],0],this.updateDropdownPosition();for(const e in this.axisLabels)this.axisLabels[e].setCubeCenter(this.center);this.manipulatorButtons.setCubeCenter(this.center)}getStaticIncrements(){if(this.staticIncrements)return this.staticIncrements;const e=this;this.staticIncrements={};const t=function(t,i,s,n){ge.S4.scale(i,TT),ge.S4.scale(s,TT),ge.S4.scale(n,TT);const r=ge.S4.subtract(s,i,C.create()),a=ge.S4.subtract(n,i,C.create()),o=ge.S4.add(i,ge.S4.scale(ge.S4.add(r,a,C.create()),.5),C.create()),h=ge.S4.length(r),c=ge.S4.length(a);ge.S4.scale(r,1/h),ge.S4.scale(a,1/c);const l=(h+c)/2*oT.getNumber("VIEW_CUBE_CORNER_SIZE"),u=t+"Front",d=h*oT.getNumber("VIEW_CUBE_FRONT_SIZE"),g=c*oT.getNumber("VIEW_CUBE_FRONT_SIZE");let p=ge.S4.add(ge.S4.scale(r,-.5*d,C.create()),ge.S4.scale(a,-.5*g,C.create()),C.create());p=ge.S4.add(p,o);const m=ge.S4.add(ge.S4.scale(r,d,C.create()),p),f=ge.S4.add(ge.S4.scale(a,g,C.create()),p),I=(0,Au.Dw)(p,m,f,l,9);e.staticIncrements[u]={selection:t,data:I,type:gT,color:oT.getColor("VIEW_CUBE_FRONT_COLOR")};const E=t+"Edge",S=I.points;let T=S.length/3;const D=new Int32Array(2*T);for(let e=0;e<T;++e)D[2*e]=e,D[2*e+1]=(e+1)%T;const M=new vE(Di.MX.LINES,S,D);e.staticIncrements[E]={selection:t,data:M,type:pT,color:oT.getColor("VIEW_CUBE_EDGE_HIGHLIGHT")};const y=t+"Back",P=h*oT.getNumber("VIEW_CUBE_BACK_SIZE"),A=c*oT.getNumber("VIEW_CUBE_BACK_SIZE");let O=ge.S4.add(ge.S4.scale(r,-.5*P,C.create()),ge.S4.scale(a,-.5*A,C.create()),C.create());O=ge.S4.add(O,o);const v=ge.S4.add(ge.S4.scale(r,P,C.create()),O),R=ge.S4.add(ge.S4.scale(a,A,C.create()),O),w=(0,Au.Dw)(O,R,v,l,9);e.staticIncrements[y]={selection:t,data:w,type:gT,color:oT.getColor("VIEW_CUBE_BACK_COLOR")};const _=t+"BackEdge",N=w.points;T=S.length/3;const b=new Int32Array(2*T);for(let e=0;e<T;++e)b[2*e]=e,b[2*e+1]=(e+1)%T;const L=new vE(Di.MX.LINES,N,b);e.staticIncrements[_]={selection:t,data:L,type:pT,color:oT.getColor("VIEW_CUBE_EDGE_HIGHLIGHT")};const F=t+"Label",x=e.labelTextures[t],B=x.filledWidthPx,V=x.filledHeightPx,U=(h-B)/2,G=(c-V)/2,H=ge.S4.add(ge.S4.scale(r,U,C.create()),ge.S4.scale(a,G,C.create()),C.create());ge.S4.add(H,i);const k=ge.S4.add(H,ge.S4.scale(r,B,C.create()),C.create()),W=ge.S4.add(H,ge.S4.scale(a,V,C.create()),C.create()),z=(0,Au.fQ)(H,k,W,void 0,[x.leftCoordinate,x.bottomCoordinate],[x.rightCoordinate,x.topCoordinate]);e.staticIncrements[F]={selection:t,data:z,type:e.labelProperties[t],color:null},e.staticIncrements[F+RT]={selection:t,data:z,type:e.labelProperties[t+RT],color:null}},i=AT;t(uT.TOP,[-i,-i,i],[i,-i,i],[-i,i,i]),t(uT.BOTTOM,[-i,i,-i],[i,i,-i],[-i,-i,-i]),t(uT.FRONT,[-i,-i,-i],[i,-i,-i],[-i,-i,i]),t(uT.BACK,[i,i,-i],[-i,i,-i],[i,i,i]),t(uT.RIGHT,[i,-i,-i],[i,i,-i],[i,-i,i]),t(uT.LEFT,[-i,i,-i],[-i,-i,-i],[-i,i,i]);const s=function(t,i,s,n){ge.S4.scale(i,TT),n*=TT;const r=t+"Face",a=(0,Au.$)(i,n,s,36);e.staticIncrements[r]={selection:t,data:a,type:gT,color:oT.getColor("VIEW_CUBE_FRONT_COLOR")};const o=t+"Edge",h=a.points,c=h.length/3,l=new Int32Array(2*c);for(let e=0;e<c;++e)l[2*e]=e,l[2*e+1]=(e+1)%c;const u=new vE(Di.MX.LINES,h,l);e.staticIncrements[o]={selection:t,data:u,type:pT,color:oT.getColor("VIEW_CUBE_EDGE_HIGHLIGHT")}},n=.8*i,r=.24*i;return s(uT.TRIMETRIC_TOP_RIGHT_FRONT,[n,-n,n],[1,-1,1],r),s(uT.TRIMETRIC_TOP_LEFT_FRONT,[-n,-n,n],[-1,-1,1],r),s(uT.TRIMETRIC_TOP_RIGHT_BACK,[n,n,n],[1,1,1],r),s(uT.TRIMETRIC_TOP_LEFT_BACK,[-n,n,n],[-1,1,1],r),s(uT.TRIMETRIC_BOTTOM_RIGHT_FRONT,[n,-n,-n],[1,-1,-1],r),s(uT.TRIMETRIC_BOTTOM_LEFT_FRONT,[-n,-n,-n],[-1,-1,-1],r),s(uT.TRIMETRIC_BOTTOM_RIGHT_BACK,[n,n,-n],[1,1,-1],r),s(uT.TRIMETRIC_BOTTOM_LEFT_BACK,[-n,n,-n],[-1,1,-1],r),e.staticIncrements}updateGraphics(){const e=uT,t=[e.TOP,e.BOTTOM,e.FRONT,e.BACK,e.LEFT,e.RIGHT];let i;for(i=0;i<t.length;i++)this.updateIncrementsOnEntity(t[i],"Front"),this.updateIncrementsOnEntity(t[i],"Edge"),this.updateIncrementsOnEntity(t[i],"Back"),this.updateIncrementsOnEntity(t[i],"BackEdge"),this.highlightedId===t[i]?(this.removeMeshIncrement(t[i]+"Label"),this.updateIncrementsOnEntity(t[i],"Label"+RT)):(this.removeMeshIncrement(t[i]+"Label"+RT),this.updateIncrementsOnEntity(t[i],"Label"));const s=[e.TRIMETRIC_TOP_RIGHT_FRONT,e.TRIMETRIC_TOP_LEFT_FRONT,e.TRIMETRIC_TOP_RIGHT_BACK,e.TRIMETRIC_TOP_LEFT_BACK,e.TRIMETRIC_BOTTOM_RIGHT_FRONT,e.TRIMETRIC_BOTTOM_LEFT_FRONT,e.TRIMETRIC_BOTTOM_RIGHT_BACK,e.TRIMETRIC_BOTTOM_LEFT_BACK];for(i=0;i<s.length;i++)this.updateIncrementsOnEntity(s[i],"Face"),this.updateIncrementsOnEntity(s[i],"Edge");this.addAxes()}addAxes(){const e=this,t=function(t,i,s){const n=TT*AT,r=oT.getNumber("VIEW_CUBE_AXIS_GAP"),a=[-n-r,-n-r,-n-r],o=ge.S4.add(ge.S4.scale(i,2*n,C.create()),a),h=(0,Au.W5)(a,o);(0,Au.VQ)(oT.getNumber("VIEW_CUBE_AXIS_WIDTH"),h),(0,Au.Ab)(s,h),e.updateMeshIncrement(t,Ti.ZJ,h,fT);const c=h.clone();(0,Au.KZ)(oT.getStipple("VIEW_CUBE_HIDDEN_AXIS_STIPPLE"),c);const l=s.slice(0);l[3]=oT.getNumber("VIEW_CUBE_HIDDEN_AXIS_OPACITY"),(0,Au.Ab)(l,c),e.updateMeshIncrement(t+".st",Ti.ZJ,c,IT)};t("X",[1,0,0],oT.getColor("X_AXIS_COLOR")),t("Y",[0,1,0],oT.getColor("Y_AXIS_COLOR")),t("Z",[0,0,1],oT.getColor("Z_AXIS_COLOR"))}updateIncrementsOnEntity(e,t){const i=this,s=this.getStaticIncrements();s[e+t].type===gT?(0,Au.Ab)(i.highlightedId===s[e+t].selection?oT.getColor("VIEW_CUBE_FACE_HIGHLIGHT"):s[e+t].color,s[e+t].data):s[e+t].type===mT&&(0,Au.Ab)(s[e+t].color,s[e+t].data),this.updateMeshIncrement(e+t,s[e+t].selection,s[e+t].data.clone(),s[e+t].type)}updateTransform(e){this.updateCenter(e);const t=de.create();t[12]=this.center[0],t[13]=this.center[1],t[14]=this.center[2];const i=ge.w$.lookAt([0,0,0,1],e.direction,e.up,de.create()),s=ge.w$.multiply(t,i,de.create());this.setTransform(s),this.hasMeshIncrements()||this.updateGraphics()}isMouseInside(){return this.highlightedId!==Ti.ZJ||this.manipulatorButtons.highlightedId!==Ti.ZJ}onMouseClick(e,t,i){this.trigger(hT,e.selectionId),Ki.Jq.AnalyticsService.trackEventForDocumentId("VIEW_CUBE_COMMAND","click_"+e.selectionId,(0,kr.n)()),uT.TOP===e.selectionId?this.viewer.animateToStandardView("XY"):uT.BOTTOM===e.selectionId?this.viewer.animateToStandardView("XYback"):uT.FRONT===e.selectionId?this.viewer.animateToStandardView("XZ"):uT.BACK===e.selectionId?this.viewer.animateToStandardView("XZback"):uT.RIGHT===e.selectionId?this.viewer.animateToStandardView("YZ"):uT.LEFT===e.selectionId?this.viewer.animateToStandardView("YZback"):dT(e.selectionId)&&this.viewer.animateToStandardView(e.selectionId),i.requestSelectedStatus=!1}onMouseEnter(e,t){this.highlightedId=e.selectionId,this.updateGraphics(),this.viewer.requestDraw()}onMouseLeave(e,t){this.highlightedId===e.selectionId&&(this.highlightedId=Ti.ZJ,this.updateGraphics()),this.viewer.requestDraw()}onDragStart(e,t,i){i.requestDrag=!0,this.setDragStart(t)}onDrag(e,t){this.updateDragPosition(t)}setDragStart(e){this.dragStart=[e.mouseX,e.mouseY]}updateDragPosition(e){this.topRightCorner[0]+=e.mouseX-this.dragStart[0],this.topRightCorner[1]+=-(e.mouseY-this.dragStart[1]);const t=Math.abs(e.mouseX-this.dragStart[0])+Math.abs(e.mouseY-this.dragStart[1]);return this.setDragStart(e),this.manipulatorButtons.updateGraphics(),this.updateDropdownPosition(),this.viewer.requestDraw(),t}updateDropdownPosition(){if(this.dropdownButton){const e=(0,Ji.x_)(),t=oT.getNumber("VIEW_CUBE_SCREEN_SIZE_PX");this.dropdownButton.position(-this.topRightCorner[0]/e,(-this.topRightCorner[1]+t)/e-this.dropdownButton.$el.height()+5)}}onDragStop(e,t){delete this.dragStart,this.viewer.requestDraw()}isViewManipulator(){return!0}}const VT=new xi.hF({isPickable:!1,primitiveType:Di.MX.LINES,isStencilWritten:!1,includedInBlend:!0}),UT="text",GT=X.default.getManager();class HT extends Ti.u1{constructor(e,t,i){super(i),this.name=e,this.featureModel=t,this.minPlanePoint=null,this.maxPlanePoint=null,this.textTexture=null,this.planeMatrix=null,this.planeMatrixInverse=null,this.lineColor=GT.getColor("SKETCH_PLANE_LINE_COLOR"),this.textColor=GT.getColor("SKETCH_PLANE_TEXT_COLOR"),this.textMaterial=Fi(),this.textNodeProperties=new xi.hF({isPickable:!1,isTwoSided:!0,primitiveType:Di.MX.TRIANGLES,material:this.textMaterial}),this.onPlaneChange(),this.listenTo(t,"change:planeMatrix",this.onPlaneChange),this.listenTo(t,"change:hasRegenError",this.onRegenErrorChange)}remove(){this.destroyText(),this.textMaterial&&(this.textMaterial.destroy(),this.textMaterial=null),super.remove()}destroyText(){this.textTexture&&(this.textTexture.destroy(),this.textTexture=null)}onRegenErrorChange(){this.featureModel.getHasRegenError()===k.AAq.ERROR!==this.isHidden&&this.onPlaneChange()}onPlaneChange(){this.planeMatrix=null,this.planeMatrixInverse=null,this.destroyText(),this.minPlanePoint=null,this.maxPlanePoint=null;const e=this.featureModel.getHasRegenError()===k.AAq.ERROR;this.viewer.getSketch()&&!e?(this.planeMatrix=this.viewer.getSketch().getPlaneMatrix(),this.planeMatrixInverse=ge.w$.inverse(this.planeMatrix,de.create()),this.show()):this.hide(),(0,Fs.vm)()}getEntityBoundsCenter(){const e=this.featureModel.parameters[0].getBtParameterForCurrentConfiguration();if(this.featureModel&&this.featureModel.parameters&&this.featureModel.parameters.length>0&&e.getIsAQueryList()&&!e.getIsEmptyQueryList()){const t=e.getQueryListItems()[0],i=t.getDeterministicIds();if(i&&i.length>0){const e=this.viewer.getModelViewManagers().getManager(),s=e.extractMeshIncrement(i[0]);if(s){let t=null;const n=e.getDisplayedElement();if(n instanceof xd){const e=(0,Ce.cF)(i[0]);e&&(t=n.getBodyTransform(e.getBodyId(),this.viewer))}return t?ge.w$.multiplyVec3(t,s.getBounds().center()):s.getBounds().center()}const n=e.getMateConnectorGraphics(null,t.getFeatureId());if(n)return n.worldSpacePosition}}return null}hasBounds(){return!!this.minPlanePoint&&!!this.maxPlanePoint}updateBounds(e){if(!this.planeMatrix||this.hasBounds())return;const t=this.getEntityBoundsCenter();if(!t)return;let i=(0,yi.Oh)(t,this.planeMatrixInverse);const s=e.projectWorldPointToViewport(t);if(s[0]<e.getViewportLeft()||s[0]>=e.getViewportWidth()||s[1]<e.getViewportBottom()||s[1]>=e.getViewportHeight()){const t=e.viewportToCanvas([e.getViewportWidth()/2,e.getViewportHeight()/2,0]),s=e.getRay(t[0],t[1]),n=.258819,r=(0,yi.bZ)(s,this.planeMatrix,n);r&&(i=(0,yi.Oh)(r,this.planeMatrixInverse))}const n=e.getPixelSizeAtWorldPoint((0,yi.KU)(i,this.planeMatrix)),r=GT.getNumber("VIEWPORT_HEIGHT_TO_PLANE_HEIGHT_RATIO")*e.getViewportHeight()*n,a=r*GT.getNumber("PLANE_DEFAULT_WIDTH_HEIGHT_RATIO");this.minPlanePoint=[i[0]-a/2,i[1]-r/2],this.maxPlanePoint=[i[0]+a/2,i[1]+r/2];const o=(0,yi.KU)([this.minPlanePoint[0],this.minPlanePoint[1]],this.planeMatrix),h=(0,yi.KU)([this.maxPlanePoint[0],this.minPlanePoint[1]],this.planeMatrix),c=(0,yi.KU)([this.maxPlanePoint[0],this.maxPlanePoint[1]],this.planeMatrix),l=(0,yi.KU)([this.minPlanePoint[0],this.maxPlanePoint[1]],this.planeMatrix),u=(0,Au.pf)([o,h,h,c,c,l,l,o]);(0,Au.Ab)(this.lineColor,u),this.updateMeshIncrement("edges",Ti.ZJ,u,VT)}updateText(e){if(!this.planeMatrix||!this.hasBounds())return;const t=this.getTextTexture(),i=(0,yi.KU)([this.minPlanePoint[0],this.minPlanePoint[1]],this.planeMatrix),s=(0,yi.KU)([this.maxPlanePoint[0],this.minPlanePoint[1]],this.planeMatrix),n=(0,yi.KU)([this.minPlanePoint[0],this.maxPlanePoint[1]],this.planeMatrix),r=ge.S4.subtract(s,i,C.create()),a=ge.S4.length(r);ge.S4.normalize(r);const o=ge.S4.subtract(n,i,C.create()),h=ge.S4.length(o);ge.S4.normalize(o);const c=1/e.getUnitSizeAtWorldPoint(n);let l=c*t.filledWidthPx,u=c*t.filledHeightPx;const d=c*GT.getNumber("PLANE_TEXT_MARGIN");if(l>a-2*d||u>h-2*d){const e=Math.min((a-2*d)/l,(h-2*d)/u);if(e<=0)return void this.removeMeshIncrement(UT);l*=e,u*=e}const g=ge.S4.add(n,ge.S4.scale(o,-d-u,C.create()),C.create());ge.S4.add(g,ge.S4.scale(r,d,C.create()));const p=ge.S4.add(g,ge.S4.scale(r,l,C.create()),C.create()),m=ge.S4.add(g,ge.S4.scale(o,u,C.create()),C.create());this.textMaterial.ambientTexture=t;const f=(0,Au.fQ)(g,p,m,void 0,[t.leftCoordinate,t.bottomCoordinate],[t.rightCoordinate,t.topCoordinate]);this.updateMeshIncrement(UT,Ti.ZJ,f,this.textNodeProperties)}getTextTexture(){return this.textTexture||(this.textTexture=_o(this.viewer,this.name,{color:this.textColor,font:GT.getString("PLANE_TEXT_FONT"),size:GT.getNumber("PLANE_TEXT_HEIGHT_PX"),paddingWithinBorder:GT.getNumber("PLANE_TEXT_BACKGROUND_PADDING")})),this.textTexture}onViewWillDraw(e,t){this.updateBounds(e),this.updateText(e)}onAppearanceConstantsUpdated(){this.lineColor=GT.getColor("SKETCH_PLANE_LINE_COLOR"),this.textColor=GT.getColor("SKETCH_PLANE_TEXT_COLOR"),this.onPlaneChange()}}const kT=X.default.getManager();class WT extends Ti.u1{constructor(e,t,i,s){super(e,Zo.Jh),this.pickPass=new Re(this.viewer),this.pickPass.setSceneGraph(this.getSceneGraph()),this.pointSizeConstantName=void 0!==t?t:"INFERENCE_POINT_SIZE_PX",this.lineWidthConstantName=void 0!==i?i:"INFERENCE_LINE_WIDTH_PX",this.pickRadiusConstantName=void 0!==s?s:"INFERENCE_PICK_RADIUS_PX",this.inferencePointMaterial=new Ni({color:kT.getColor("INFERENCE_DEBUG_POINT_COLOR"),pointSize:kT.getNumber(this.pointSizeConstantName)}),this.inferenceLineMaterial=new Ni({color:kT.getColor("INFERENCE_DEBUG_LINE_COLOR"),lineWidth:kT.getNumber(this.lineWidthConstantName)}),this.inferenceCurveMaterial=new Ni({base:kT.getColor("INFERENCE_DEBUG_CURVE_COLOR"),lineWidth:kT.getNumber(this.lineWidthConstantName)}),this.pointNodeProperties=new xi.hF({primitiveType:Di.MX.POINTS,isShowThrough:!0,isDepthTested:!1,material:this.inferencePointMaterial,priority:xi.DO.HIGHER}),this.importantNodeProperties=new xi.hF({primitiveType:Di.MX.POINTS,isShowThrough:!0,isDepthTested:!1,material:this.inferencePointMaterial,priority:xi.DO.HIGHEST}),this.linesNodeProperties=new xi.hF({primitiveType:Di.MX.INFINITE_LINES,isShowThrough:!0,isDepthTested:!1,material:this.inferenceLineMaterial,priority:xi.DO.LOWER}),this.curvesNodeProperties=new xi.hF({primitiveType:Di.MX.LINES,isShowThrough:!0,isDepthTested:!1,material:this.inferenceCurveMaterial,priority:xi.DO.DEFAULT}),this.pickRadius=kT.getNumber(this.pickRadiusConstantName),this.viewer.visualizeInferenceSceneGraph(this.getSceneGraph())}getSceneGraph(){return this.viewer.getSceneGraphs().getSceneGraph(Zo.Jh)}onDevicePixelRatioChanged(e){this.pickRadius=kT.getNumber(this.pickRadiusConstantName),this.inferencePointMaterial.pointSize=kT.getNumber(this.pointSizeConstantName),this.inferenceLineMaterial.lineWidth=kT.getNumber(this.lineWidthConstantName),this.inferenceCurveMaterial.lineWidth=kT.getNumber(this.lineWidthConstantName)}remove(){super.remove(),this.viewer&&this.viewer.visualizeInferenceSceneGraph(null),this.inferencePointMaterial.destroy(),this.inferenceLineMaterial.destroy(),this.inferenceCurveMaterial.destroy()}setIncrementPickId(e,t){if(!t.pickId)throw"InferencePicker should be supplied increments that already have a pick id set"}pick(e,t){if(this.viewer){const i=this.pickInRect(e,t,this.pickRadius),s=i.length>0?i[0]:null;return s?s.primitiveId:Si.JE}return Si.JE}pickMultiple(e,t){if(this.viewer){const i=this.pickIteratively(e,t,this.pickRadius,kT.getNumber("MAXIMUM_INFERENCE_PICKS")).map((function(e){return e?e.primitiveId:Si.JE}));return this.getHighestPriorityInferences(i)}return[]}pickInRect(e,t,i){if(!this.viewer.isReadyForDrawing())return[];const s=2*i+1,n=2*i+1,r=e-i,a=t-i;this.viewer.pushCameraState(),this.pickPass.setSceneGraph(this.getSceneGraph()),this.pickPass.setPickRect(r,a,s,n),this.pickPass.draw(this.viewer.getRenderContext()),this.viewer.popCameraState();const o=this.pickPass.gatherPicksFromPickPass(),h=[];for(const e in o){const t=o[e];for(const e in t)h.push(t[e])}return h.sort(bS.G)}pickIteratively(e,t,i,s){const n=[];let r,a,o=!1,h=0;for(;!(h>s);){const s=this.pickInRect(e,t,i);if(s.length<1)break;for(r=0;r<s.length;++r)a=s[r],a.fromPass=h,n.push(a);for(r=0;r<s.length;++r)this.hideIncrementFromPick(s[r].primitiveId.toString()),o=!0;++h}return o&&this.occurrenceData.resetHiddenFromPick(),n}getHighestPriorityInferences(e){if(0===e.length)return[];const t=[e[0]],i=this.getRenderOrderPriority(e[0]);for(let s=1;s<e.length;s++){const n=this.getRenderOrderPriority(e[s]);if(n<0)return t;if(n!==i)break;t.push(e[s])}return t}getMeshIncrementForPrimitiveId(e){const t=this.getInstantiatedMeshIncrement(e.toString());return t?t.meshIncrement:null}getRenderOrderPriority(e){const t=this.getInstantiatedMeshIncrement(e.toString());return t?t.nodeProperties.priority:-1}updateInference(e,t){const i=e.id;if(!i)return;let s=null;e.primitiveType===Di.MX.POINTS?(s=t?this.importantNodeProperties:this.pointNodeProperties,(0,Au.VQ)(kT.getNumber(this.pointSizeConstantName),e)):e.primitiveType===Di.MX.INFINITE_LINES?(s=this.linesNodeProperties,(0,Au.VQ)(kT.getNumber(this.lineWidthConstantName),e)):e.primitiveType===Di.MX.LINES&&(s=this.curvesNodeProperties,(0,Au.VQ)(kT.getNumber(this.lineWidthConstantName),e)),s&&this.updateMeshIncrement(i,i,e,s)}deleteInference(e){this.removeMeshIncrement(e)}resetInferences(){this.removeMeshIncrements()}}var zT=i(70137);const XT="boxId";class ZT extends Ti.u1{constructor(e,t,i,s,n,r,a,o){super(t),this.firstClashParentId=i,this.secondClashParentId=s,this.interferenceIndex=n,this.boundingBox=r,this.LINE_WIDTH=2.5,this.lineNodeProps=new xi.hF({primitiveType:Di.MX.LINES,isPickable:!0,isHighlightable:!0,isTwoSided:!0,isShowThrough:!1}),this.boxLineNodeProps=new xi.hF({primitiveType:Di.MX.LINES,isPickable:!1,isHighlightable:!0,isVisible:!1}),this.faceNodeProps=new xi.hF({isPickable:!0,primitiveType:Di.MX.TRIANGLE_STRIP}),this.interferenceIndex=n,this.selectionId=i+s+n,e.tessellation.forEach(((t,i)=>{const s=fI(t),n=e.appearance,r="id"+i;let a;if(s.primitiveType===Di.MX.LINES){a=this.lineNodeProps,(0,Au.VQ)(this.LINE_WIDTH,s);const e=pI(n,Di.MX.LINES);(0,Au.Ab)(e,s)}else if(s.primitiveType===Di.MX.TRIANGLE_STRIP){a=this.faceNodeProps;const e=pI(n,Di.MX.TRIANGLE_STRIP);(0,Au.Ab)(e,s)}a&&(this.updateMeshIncrement(r,this.selectionId,s,a),this.viewer.getIsolatedOccurrenceManager()?.addIdsToIsolate([this.graphicsOccurrenceId],!0))})),this.boxIncrement=(0,Au.U0)(this.boundingBox.minCorner.getVec3(),this.boundingBox.maxCorner.getVec3()).createTransformed(a.getGlMatrix()),o&&this.setTransform(o.getGlMatrix())}getSelectionId(){return this.selectionId}remove(){this.viewer.getIsolatedOccurrenceManager()?.removeFromIsolate([this.graphicsOccurrenceId]),super.remove()}getModelSelection(){return new zT.Y(k.lQt.TEMPORARY_GEOMETRY,this.selectionId)}processResetSelection(e){e===dn.o2.SECONDARY&&this.boxIncrement&&this.removeMeshIncrement(XT),this.removeHighlightFromOccurrence(e)}processAddSelection(e,t){this.selectionId===e&&(t===dn.o2.SECONDARY&&this.boxIncrement&&this.updateMeshIncrement(XT,this.selectionId,this.boxIncrement,this.boxLineNodeProps),this.addNewHighlightToOccurrence(t))}processRemoveSelection(e,t){this.selectionId===e&&this.removeHighlightFromOccurrence(t)}}class qT extends Ti.u1{constructor(e,t,i,s,n,r){super(n,r);const a=(0,Au.fQ)(e,t,i);this.updateMeshIncrement("quad",Ti.ZJ,a,s)}}class YT{constructor(e){this.viewer=e,this.cameraAnimationCallback=null,this.animationLoopInProgress=!1,this.animationSequenceCounter=0,this.animationSequenceStartTime=0,this.animationSequenceFrameCount=0,this.frameCallback=e=>this.onRequestDrawFulfilled(e),this.ongoingAnimations=new Set,this.incrementAnimationSequence()}onRequestDrawFulfilled(e){if(this.viewer.isOngoingRenderLoopRunning)return;const t=this.advanceAnimation(e);this.viewer.draw(t?e:void 0)}advanceAnimation(e){if(!this.animationLoopInProgress)return!1;let t=!1;if(this.cameraAnimationCallback){this.cameraAnimationCallback(e)===Wn.Z.COMPLETE?this.cameraAnimationCallback=null:t=!0}for(const i of this.ongoingAnimations.values()){i(e)===Wn.Z.COMPLETE?this.ongoingAnimations.delete(i):t=!0}if(t)this.viewer.setSystemIsAnimating(),this.viewer.isOngoingRenderLoopRunning||this.viewer.requestDraw(this.frameCallback),++this.animationSequenceFrameCount;else if(this.animationLoopInProgress=!1,this.incrementAnimationSequence(),this.viewer.setSuppressMouseMovePick(!1),this.viewer.isOngoingRenderLoopRunning||this.viewer.getInputHandler().isMouseInCanvas()&&this.viewer.doPreHighlightPick(),this.animationSequenceFrameCount>0){const e=(this.animationSequenceFrameCount/((0,Fs.Es)(this.animationSequenceStartTime)/1e3)).toFixed(1);ut.log.trace("Animation completed with average framerate of "+e+" fps")}return t}requestAnimationFrameIfNeeded(){this.animationLoopInProgress&&!this.viewer.isOngoingRenderLoopRunning&&this.viewer.requestDraw(this.frameCallback)}startCameraAnimation(e){this.haltCameraAnimation(),this.cameraAnimationCallback=e,this.startAnimationRenderLoop()}isCameraAnimating(){return!!this.cameraAnimationCallback}haltCameraAnimation(){this.cameraAnimationCallback=null}startAnimation(e){this.ongoingAnimations.add(e),this.startAnimationRenderLoop()}incrementAnimationSequence(){this.viewer.$el.attr("animation-sequence",++this.animationSequenceCounter)}startAnimationRenderLoop(){this.animationLoopInProgress||(this.viewer.setSuppressMouseMovePick(!0),this.viewer.setSystemIsAnimating(),this.viewer.isOngoingRenderLoopRunning||this.viewer.requestDraw(this.frameCallback),this.animationLoopInProgress=!0,this.animationSequenceStartTime=(0,Fs.Wj)(),this.animationSequenceFrameCount=0)}}class KT{constructor(e,t){this.timeBudget=e,this.vertexBudget=t,this.startTime=0,this.verticesSpent=0}addVertexCost(e){this.verticesSpent+=e}reset(){this.startTime=(0,Fs.Wj)(),this.verticesSpent=0}budgetExceeded(){return this.verticesSpent>this.vertexBudget||(0,Fs.Es)(this.startTime)>this.timeBudget}}const jT=new KT(X.default.getManager().getNumber("GRAPHICS_TASK_SMALL_INTERACTIVE_TIME_BUDGET"),X.default.getManager().getNumber("GRAPHICS_TASK_SMALL_INTERACTIVE_VERTEX_BUDGET")),QT=new KT(X.default.getManager().getNumber("GRAPHICS_TASK_MEDIUM_INTERACTIVE_TIME_BUDGET"),X.default.getManager().getNumber("GRAPHICS_TASK_MEDIUM_INTERACTIVE_VERTEX_BUDGET"));class $T{constructor(){this.tasks=[]}addTask(e,t){this.tasks.push({task:e,budget:t})}processWithBudget(e){e&&e.reset();for(let t=0;t<this.tasks.length&&(!e||!e.budgetExceeded());++t)this.tasks[t].task.process(e)}processInteractively(){let e=null;for(let t=0;t<this.tasks.length;++t)if(this.tasks[t].task.hasPendingWork()){e=this.tasks[t].budget;break}e&&this.processWithBudget(e)}complete(){this.processWithBudget(null)}hasPendingWork(){for(let e=0;e<this.tasks.length;++e)if(this.tasks[e].task.hasPendingWork())return!0;return!1}}var JT=i(35692);class eD{constructor(e){this.gl=e;for(const t in this.gl)"gl"!==t&&("function"==typeof e[t]?t in this||(this[t]=function(e,t,i){return function(){return i.apply(e,arguments)}}(this.gl,0,this.gl[t])):function(e,t){e[t]=e.gl[t]}(this,t))}apply(){}printState(){ut.log.debug("BLEND \t\t"+this.gl.isEnabled(this.gl.BLEND)),ut.log.debug("CULL_FACE \t\t"+this.gl.isEnabled(this.gl.CULL_FACE)),ut.log.debug("DEPTH_TEST \t\t"+this.gl.isEnabled(this.gl.DEPTH_TEST)),ut.log.debug("DITHER \t\t"+this.gl.isEnabled(this.gl.DITHER)),ut.log.debug("POLYGON_OFFSET_FILL \t\t"+this.gl.isEnabled(this.gl.POLYGON_OFFSET_FILL)),ut.log.debug("SAMPLE_ALPHA_TO_COVERAGE \t\t"+this.gl.isEnabled(this.gl.SAMPLE_ALPHA_TO_COVERAGE)),ut.log.debug("SAMPLE_COVERAGE \t\t"+this.gl.isEnabled(this.gl.SAMPLE_COVERAGE)),ut.log.debug("SCISSOR_TEST \t\t"+this.gl.isEnabled(this.gl.SCISSOR_TEST)),ut.log.debug("STENCIL_TEST \t\t"+this.gl.isEnabled(this.gl.STENCIL_TEST)),ut.log.debug("\n")}}class tD{constructor(e,t){this.callCounts={},t=void 0!==t&&t,this.gl=e;for(const i in this.gl)"gl"!==i&&"callCounts"!==i&&"printCallStats"!==i&&("function"==typeof e[i]?i in this||(this[i]=((e,i,s)=>()=>(t&&(i in this.callCounts?this.callCounts[i]++:this.callCounts[i]=1),ut.log.debug(s.toString()),s.apply(e,arguments)))(this.gl,i,this.gl[i])):function(e,t){e[t]=e.gl[t]}(this,i))}printCallStats(){let e=[];for(const t in this.callCounts)e.push([t,this.callCounts[t]]);e=e.sort((function(e,t){return t[1]-e[1]}));for(const t in e)ut.log.debug(e[t][0]+" "+e[t][1])}}class iD extends eD{constructor(e){super(e),this.nextId=1,this.uniqueIds=new Map}assignNextId(e){e.tempId=this.nextId,this.uniqueIds.set(e,this.nextId),this.nextId++}createProgram(){const e=this.gl.createProgram();return this.assignNextId(e),e}}class sD extends eD{constructor(e){super(new iD(e)),this.currentProgram=null,this.programFlags=[],this.programNames={},this.programSources=[]}getProgramFlags(){return this.programFlags}setProgramFlags(e){this.programFlags=e}onlyProgram(e){for(let t=0;t<this.programFlags.length;t++)this.programFlags[t]=e===t}allButProgram(e){for(let t=0;t<this.programFlags.length;t++)this.programFlags[t]=e!==t}allPrograms(){for(let e=0;e<this.programFlags.length;e++)this.programFlags[e]=!0}noPrograms(){for(let e=0;e<this.programFlags.length;e++)this.programFlags[e]=!1}createProgram(e){const t=super.createProgram();return this.programNames[t.tempId]=e,t}useProgram(e){this.currentProgram=e,this.gl.useProgram(e),e.tempId in this.programFlags||(this.programFlags[e.tempId]=!0)}drawArrays(e,t,i){this.programFlags[this.currentProgram.tempId]&&this.gl.drawArrays(e,t,i)}drawElements(e,t,i,s){this.programFlags[this.currentProgram.tempId]&&this.gl.drawElements(e,t,i,s)}}class nD extends eD{constructor(e,t,i){super(e),this.numChanges=t,this.numRepeats=i}enable(e){this.gl.enable(e);for(let t=0;t<this.numChanges;t++)this.gl.disable(e),this.gl.enable(e);for(let t=0;t<this.numRepeats;t++)this.gl.enable(e)}disable(e){this.gl.disable(e);for(let t=0;t<this.numChanges;t++)this.gl.enable(e),this.gl.disable(e);for(let t=0;t<this.numRepeats;t++)this.gl.disable(e)}enableVertexAttribArray(e){this.gl.enableVertexAttribArray(e);for(let t=0;t<this.numChanges;t++)this.gl.disableVertexAttribArray(e),this.gl.enableVertexAttribArray(e);for(let t=0;t<this.numRepeats;t++)this.gl.enableVertexAttribArray(e)}disableVertexAttribArray(e){this.gl.disableVertexAttribArray(e);for(let t=0;t<this.numChanges;t++)this.gl.enableVertexAttribArray(e),this.gl.disableVertexAttribArray(e);for(let t=0;t<this.numRepeats;t++)this.gl.disableVertexAttribArray(e)}useProgram(e){this.gl.useProgram(e);for(let t=0;t<this.numChanges;t++)this.gl.useProgram(null),this.gl.useProgram(e);for(let t=0;t<this.numRepeats;t++)this.gl.useProgram(e)}activeTexture(e){this.gl.activeTexture(e);for(let t=0;t<this.numChanges;t++)this.gl.activeTexture(this.gl.TEXTURE25),this.gl.activeTexture(e);for(let t=0;t<this.numRepeats;t++)this.gl.activeTexture(e)}bindTexture(e,t){this.gl.bindTexture(e,t);for(let i=0;i<this.numChanges;i++)this.gl.bindTexture(e,null),this.gl.bindTexture(e,t);for(let i=0;i<this.numRepeats;i++)this.gl.bindTexture(e,t)}}class rD extends eD{constructor(e,t,i){super(e),this.numChanges=t,this.numRepeats=i;const s=e=>()=>{e.apply(this.gl,arguments);for(let t=0;t<this.numRepeats;t++)e.apply(this.gl,arguments)},n=this;for(let e=1;e<=4;e++)JT.each(["f","i","fv","iv"],(function(t,i){let r="uniform"+e+i;n[r]=s(n.gl[r]),e>1&&(r="uniformMatrix"+e+i,n[r]=s(n.gl[r]))}));for(let e=1;e<=4;e++)JT.each(["f","fv"],(function(t,i){const r="vertexAttrib"+e+i;n[r]=s(n.gl[r])}))}}class aD extends eD{constructor(e){super(e),this.programUniforms=[],this.attributes=[],this.state=new Map,this.attribarraystate=new Map,this.currentProgram=e.getParameter(e.CURRENT_PROGRAM),this.currentProgramSent=e.getParameter(e.CURRENT_PROGRAM),this.activeTextureUnit=e.getParameter(e.ACTIVE_TEXTURE),this.activeTextureUnitSent=e.getParameter(e.ACTIVE_TEXTURE),this.textureUnits=new Map}getUniformLocation(e,t){const i=this.gl.getUniformLocation(e,t),s=this.programUniforms[e.tempId].length;return i&&(i.tempId=s,this.programUniforms[e.tempId][i.tempId]=null),i}apply(){this.applyProgram(),this.applyAttributes()}applyProgram(){this.currentProgramSent!==this.currentProgram&&(this.gl.useProgram(this.currentProgram),this.currentProgramSent=this.currentProgram);const e=this.programUniforms[this.currentProgram.tempId];if(e)for(let t=0;t<e.length;t++){const i=e[t];if(i){if(i[2])continue;const e=i[0],t=i[1];e.apply(this.gl,t),i[2]=!0}}}applyAttributes(){for(let e=0;e<this.attributes.length;e++){const t=this.attributes[e];if(t){if(t[2])continue;const e=t[0],i=t[1];e.apply(this.gl,i),t[2]=!0}}}createProgram(){const e=this.gl.createProgram();return this.programUniforms[e.tempId]=[],e}useProgram(e){this.currentProgram=e}deleteProgram(e){return this.gl.deleteProgram(e)}getCurrentProgramUniforms(){let e=this.programUniforms[this.currentProgram.tempId];return e||(e=[],this.programUniforms[this.currentProgram.tempId]=e),e}uniform1f(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform1f,n[2]=n[2]&&n[1][1]===t,n[1][1]=t):i[s]=[this.gl.uniform1f,[e,t],!1]}uniform1i(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform1i,n[2]=n[2]&&n[1][1]===t,n[1][1]=t):i[s]=[this.gl.uniform1i,[e,t],!1]}uniform2f(e,t,i){const s=this.getCurrentProgramUniforms(),n=e.tempId,r=s[n];r&&r[1].length===arguments.length?(r[0]=this.gl.uniform2f,r[2]=r[2]&&r[1][1]===t&&r[1][2]===i,r[1][1]=t,r[1][2]=i):s[n]=[this.gl.uniform2f,[e,t,i],!1]}uniform2i(e,t,i){const s=this.getCurrentProgramUniforms(),n=e.tempId,r=s[n];r&&r[1].length===arguments.length?(r[0]=this.gl.uniform2i,r[2]=r[2]&&r[1][1]===t&&r[1][2]===i,r[1][1]=t,r[1][2]=i):s[n]=[this.gl.uniform2i,[e,t,i],!1]}uniform3f(e,t,i,s){const n=this.getCurrentProgramUniforms(),r=e.tempId,a=n[r];a&&a[1].length===arguments.length?(a[0]=this.gl.uniform3f,a[2]=a[2]&&a[1][1]===t&&a[1][2]===i&&a[1][3]===s,a[1][1]=t,a[1][2]=i,a[1][3]=s):n[r]=[this.gl.uniform3f,[e,t,i,s],!1]}uniform3i(e,t,i,s){const n=this.getCurrentProgramUniforms(),r=e.tempId,a=n[r];a&&a[1].length===arguments.length?(a[0]=this.gl.uniform3i,a[2]=a[2]&&a[1][1]===t&&a[1][2]===i&&a[1][3]===s,a[1][1]=t,a[1][2]=i,a[1][3]=s):n[r]=[this.gl.uniform3i,[e,t,i,s],!1]}uniform4f(e,t,i,s,n){const r=this.getCurrentProgramUniforms(),a=e.tempId,o=r[a];o&&o[1].length===arguments.length?(o[0]=this.gl.uniform4f,o[2]=o[2]&&o[1][1]===t&&o[1][2]===i&&o[1][3]===s&&(o[1][4]=n),o[1][1]=t,o[1][2]=i,o[1][3]=s,o[1][4]=n):r[a]=[this.gl.uniform4f,[e,t,i,s,n],!1]}uniform4i(e,t,i,s,n){const r=this.getCurrentProgramUniforms(),a=e.tempId,o=r[a];o&&o[1].length===arguments.length?(o[0]=this.gl.uniform4i,o[2]=o[2]&&o[1][1]===t&&o[1][2]===i&&o[1][3]===s&&(o[1][4]=n),o[1][1]=t,o[1][2]=i,o[1][3]=s,o[1][4]=n):r[a]=[this.gl.uniform4i,[e,t,i,s,n],!1]}uniform1fv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform1fv,n[2]=n[2]&&(0,Hs.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform1fv,[e,t],!1]}uniform1iv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform1iv,n[2]=n[2]&&(0,Hs.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform1iv,[e,t],!1]}uniform2fv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform2fv,n[2]=n[2]&&(0,Hs.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform2fv,[e,t],!1]}uniform2iv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform2iv,n[2]=n[2]&&(0,Hs.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform2iv,[e,t],!1]}uniform3fv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform3fv,n[2]=n[2]&&(0,Hs.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform3fv,[e,t],!1]}uniform3iv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform3iv,n[2]=n[2]&&(0,Hs.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform3iv,[e,t],!1]}uniform4fv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform4fv,n[2]=n[2]&&(0,Hs.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform4fv,[e,t],!1]}uniform4iv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform4iv,n[2]=n[2]&&(0,Hs.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform4iv,[e,t],!1]}uniformMatrix2fv(e,t,i){const s=this.getCurrentProgramUniforms(),n=e.tempId,r=s[n];r&&r[1].length===arguments.length?(r[0]=this.gl.uniformMatrix2fv,r[2]=r[2]&&r[1][1]===t&&(0,Hs.Z)(r[1][2],i),r[1][1]=t,r[1][2]=i):s[n]=[this.gl.uniformMatrix2fv,[e,t,i],!1]}uniformMatrix3fv(e,t,i){const s=this.getCurrentProgramUniforms(),n=e.tempId,r=s[n];r&&r[1].length===arguments.length?(r[0]=this.gl.uniformMatrix3fv,r[2]=r[2]&&r[1][1]===t&&(0,Hs.Z)(r[1][2],i),r[1][1]=t,r[1][2]=i):s[n]=[this.gl.uniformMatrix3fv,[e,t,i],!1]}uniformMatrix4fv(e,t,i){const s=this.getCurrentProgramUniforms(),n=e.tempId,r=s[n];r&&r[1].length===arguments.length?(r[0]=this.gl.uniformMatrix4fv,r[2]=r[2]&&r[1][1]===t&&(0,Hs.Z)(r[1][2],i),r[1][1]=t,r[1][2]=i):s[n]=[this.gl.uniformMatrix4fv,[e,t,i],!1]}vertexAttrib1f(e,t){const i=this.attributes[e];i&&i[1].length===arguments.length?(i[0]=this.gl.vertexAttrib1f,i[2]=i[2]&&i[1][1]===t,i[1][1]=t):this.attributes[e]=[this.gl.vertexAttrib1f,[e,t],!1]}vertexAttrib2f(e,t,i){const s=this.attributes[e];s&&s[1].length===arguments.length?(s[0]=this.gl.vertexAttrib2f,s[2]=s[2]&&s[1][1]===t&&s[1][2]===i,s[1][1]=t,s[1][2]=i):this.attributes[e]=[this.gl.vertexAttrib2f,[e,t,i],!1]}vertexAttrib3f(e,t,i,s){const n=this.attributes[e];n&&n[1].length===arguments.length?(n[0]=this.gl.vertexAttrib3f,n[2]=n[2]&&n[1][1]===t&&n[1][2]===i&&n[1][3]===s,n[1][1]=t,n[1][2]=i,n[1][3]=s):this.attributes[e]=[this.gl.vertexAttrib3f,[e,t,i,s],!1]}vertexAttrib4f(e,t,i,s,n){const r=this.attributes[e];r&&r[1].length===arguments.length?(r[0]=this.gl.vertexAttrib4f,r[2]=r[2]&&r[1][1]===t&&r[1][2]===i&&r[1][3]===s&&r[1][4]===n,r[1][1]=t,r[1][2]=i,r[1][3]=s,r[1][4]=n):this.attributes[e]=[this.gl.vertexAttrib4f,[e,t,i,s,n],!1]}vertexAttrib1fv(e,t){const i=this.attributes[e];i&&i[1].length===arguments.length?(i[0]=this.gl.vertexAttrib1fv,i[2]=i[2]&&(0,Hs.Z)(i[1][1],t),i[1][1]=t):this.attributes[e]=[this.gl.vertexAttrib1fv,[e,t],!1]}vertexAttrib2fv(e,t){const i=this.attributes[e];i&&i[1].length===arguments.length?(i[0]=this.gl.vertexAttrib2fv,i[2]=i[2]&&(0,Hs.Z)(i[1][1],t),i[1][1]=t):this.attributes[e]=[this.gl.vertexAttrib2fv,[e,t],!1]}vertexAttrib3fv(e,t){const i=this.attributes[e];i&&i[1].length===arguments.length?(i[0]=this.gl.vertexAttrib3fv,i[2]=i[2]&&(0,Hs.Z)(i[1][1],t),i[1][1]=t):this.attributes[e]=[this.gl.vertexAttrib3fv,[e,t],!1]}vertexAttrib4fv(e,t){const i=this.attributes[e];i&&i[1].length===arguments.length?(i[0]=this.gl.vertexAttrib4fv,i[2]=i[2]&&(0,Hs.Z)(i[1][1],t),i[1][1]=t):this.attributes[e]=[this.gl.vertexAttrib4fv,[e,t],!1]}drawArrays(e,t,i){this.apply(),this.gl.drawArrays(e,t,i)}drawElements(e,t,i,s){this.apply(),this.gl.drawElements(e,t,i,s)}}var oD=i(81172);class hD extends m.T{enableTranslucentMode(){this.isTranslucentModeEnabled=!0,this.viewer.mainDrawPass.setTranslucentEdgesEnabled(!0),this.refreshTranslucentOccurrences()}disableTranslucentMode(e){this.isTranslucentModeEnabled=!1,this.viewer.resetTranslucentModeValues(),this.viewer.mainDrawPass.setTranslucentEdgesEnabled(!1),this.refreshTranslucentOccurrences(),e||this.resetAffectWithIsolatableIds(this.getSeedPartOrOccurrenceIds())}isDialogOpen(){return!!this.dialog&&(0,$i.Xt)().getIsPanelOpen(this.dialog.getPanelId())}constructor(e,t){super(),this.viewer=e,this.isolatedOccurrencesManager=t,this.affectedOccurrenceIds=[],this.centersOfInitialAffectedInstances=null,this.degreeOfDistance=0,this.degreeOfConnectivity=-1,this.isPersistentModeEnabled=!1,this.dialog=null,this.setUpListeners()}destroy(){this.dialog&&(this.dialog.destroy(),this.dialog=null),this.stopListening()}setIsIsolateFullyTransparent(e){this.viewer.getViewerPreferences().isolateHideTransparent!==e&&(Ki.Jq.UserSettingsService.updateIsolateHideTransparent(e?"true":"false"),this.viewer.getViewerPreferences().isolateHideTransparent=e,this.triggerIsolateFullyTransparentChangeEvent())}getIsolatedOccurrenceManager(){return this.isolatedOccurrencesManager}triggerIsolateFullyTransparentChangeEvent(){this.isolatedOccurrencesManager.onIsIsolateFullyTransparentChanged(),this.viewer.requestDraw()}setIsIsolateFullyTransparentAsDefault(){this.viewer.getViewerPreferences().isolateHideTransparent=!0}getIsIsolateFullyTransparent(){return this.viewer.getViewerPreferences().isolateHideTransparent&&this.getIsolatedOccurrenceManager().isInIsolateOrMakeTransparentMode()}clearEffectNoAnimation(){this.hasAffectedInstances()&&(this.clearEffect(),this.viewer.onIsolateChanged(),(0,Fs.vm)()),this.dialog&&(this.dialog.destroy(),this.dialog=null)}clearEffect(){this.isTranslucentModeEnabled&&this.disableTranslucentMode(!0)}clearEffectExit(e){if(this.viewer!==e)return;let t=!0;this.currentRenderModeSupportsAnimation()?this.hasAffectedInstances()&&(t=!1,this.viewer.animateIsolation(!1,(()=>{this.destroyDialog(),this.clearEffect(),this.viewer.onIsolateChanged(),(0,Fs.vm)()}))):this.clearEffectNoAnimation(),t&&this.destroyDialog(),this.viewer.resetTranslucentModeValues(),this.degreeOfConnectivity=-1,this.degreeOfDistance=0}destroyDialog(){this.dialog&&(this.dialog.destroy(),this.dialog=null)}currentRenderModeSupportsAnimation(){return!(this.viewer.getRenderingMode()===k.P1.TRANSLUCENT)}getModelViewManager(){return this.viewer.getModelViewManagers().getManager()}getPreviewViewManager(){return this.viewer.getModelViewManagers().getPreviewManager()}hasAffectedInstances(){return this.affectedOccurrenceIds.length>0}addIdsToAffect(e,t){if(this.hasAffectedInstances()||t){let t=!1;for(let i=0;i<e.length;i++)this.affectedOccurrenceIds.indexOf(e[i])<0&&(this.affectedOccurrenceIds.push(e[i]),t=!0);t&&this.updateOccurrenceManagerAndPreviewBoundingBoxes()}}removeFromEffect(e){if(this.hasAffectedInstances()){let t=!1;for(let i=0;i<e.length;i++){const s=this.affectedOccurrenceIds.indexOf(e[i]);s>-1&&(this.affectedOccurrenceIds.splice(s,1),t=!0)}t&&this.updateOccurrenceManagerAndPreviewBoundingBoxes()}}makeTransparent(e,t){const i=t?function(){const e=(0,Jo.uQ)();e.setSuppressMouseMovePick(!1),e.getInputHandler().isMouseInCanvas()&&e.doPreHighlightPick()}:()=>{};e&&this.currentRenderModeSupportsAnimation()?this.viewer.animateIsolation(!0):(Ye(1),this.viewer.requestDraw((()=>{this.viewer.getAnimationController().incrementAnimationSequence(),i()})))}getSelectionFromNodeModelOrSelection(e){return CD.getSelectionFromNodeModelOrSelection(e,this.viewer)}setAffectedOccurrenceIds(e){this.affectedOccurrenceIds=e,this.updateOccurrenceManagerAndPreviewBoundingBoxes()}isIsolateInEffectMode(){return!!this.dialog||this.isolatedOccurrencesManager.initializingDialog===oD.P.ISOLATE||this.isPersistentModeEnabled}isWithinDistanceOfAnInitialAffectedOccurrence(e,t){const i=this.getModelViewManager().getOccurrenceBounds(t);return!!i&&this.isBoundsWithinDistanceOfInitialAffectedInstances(i,e)}isBoundsWithinDistanceOfInitialAffectedInstances(e,t){const i=e.center();return this.isPointWithinDistanceOfInitialAffectedInstances(i,t)}isPointWithinDistanceOfInitialAffectedInstances(e,t){for(const i of this.centersOfInitialAffectedInstances){if(ge.S4.distanceSquared(i,e)<t)return!0}return!1}expandEffectByProximity(e){this.degreeOfDistance=e}getMinDistanceSquaredFromInitialAffectedInstanceToCenterOfModel(){let e=1/0;const t=this.getModelBoundsForEffect();if(t){const i=t.center();this.updateCentersOfInitialAffectedInstances();const s=this.centersOfInitialAffectedInstances.map((function(e){return ge.S4.distanceSquared(e,i)}));e=Math.min(...s)}return e}getModelBoundsForEffect(){return this.viewer.getModelBounds()}expandEffectByConnectivity(e){this.degreeOfConnectivity=e}getAffectedOccurrences(){return[]}initialAffectedOccurrencesHaveConnectedOccurrences(){return!1}affectOccurrences(e,t,i){}updateOccurrenceManagerAndPreviewBoundingBoxes(){this.updateOccurrenceDataManager(),this.updatePreviewBoundingBoxes(),this.viewer.onIsolateChanged()}updatePreviewBoundingBoxes(){this.viewer.getBodyManager().refreshReducedDetailBoxes()}clearAffectedOccurrenceIdsNoGraphicsUpdate(){this.affectedOccurrenceIds=[]}}var cD=i(6806),lD=i(71113);const uD=function(e){return e.getPathAsString()};function dD(e,t,i,s,n,r){const a=new Map;function o(e){const t=e.trimToTopLevel();return a.set(t.getPathAsString(),t),!1}Array.isArray(e)?e.forEach(o):e&&e.each(o);const h=()=>t.viewer.getIsolatedOccurrenceManager().isInTranslucentMode();for(const e of a.values()){const a=t.getOccurrencesStartingWithPath(e);for(let e=0;e<a.length;++e){const t=a[e].getPathAsString();i.has(t)?h()&&n.has(a[e])&&r.push(a[e]):(i.set(t,a[e]),s.set(t,a[e]),h()&&!n.has(a[e])&&r.push(a[e]))}}}class gD extends hD{getSeedPartOrOccurrenceIds(){return this.initialAffectedOccurrences}refreshTranslucentOccurrences(e=[]){const t=this.getModelViewManager().getDisplayedAssembly(),i=[...this.getOccurrencesWithAffectedGraphics(),...e];for(const e of i){const i=t.getBodyComponent(e),s=this.viewer.getIdForOccurrence(e);i?.refreshOccurrence(s)}this.viewer.requestDraw()}resetAffectWithIsolatableIds(e){this.affectOccurrences(e,DD.INITIAL)}constructor(e,t){super(e,t),this.initialAffectedOccurrences=[],this.affectedOccurrences=[],this.setSeedComponentsNull()}setUpListeners(){this.stopListening(),this.listenTo(this.viewer.getEventDispatcher(),yD.hj,this.onAssemblyDataProcessed)}setSeedComponentsNull(){this.nodeModelOrSelection=null,this.includeSelections=!1,this.initialSelectionList=null}onAssemblyDataProcessed(){this.hasAffectedInstances()&&(0,lt._R)()&&(this.updateNodeModelOrSelection(),this.reAffectComponents(DD.ASSEMBLY_DATA_UPDATE,!1))}setIsolationForRelatedGraphics(e,t){const i=this.getModelViewManager().getDisplayedAssembly();if(i)for(const s of e){const e=i.getMateConnectorGraphicsForOccurrence(s,false);for(let i=0;i<e.length;i++)e[i].getOccurrenceData().setIsolated(t);const n=i.getMateIndicatorsForOccurrence(s,false);for(let e=0;e<n.length;e++)n[e].setIsolated(t);const r=i.getSketchImagesForOccurrence(s);for(let e=0;e<r.length;++e)r[e].setIsolated(t)}}affectComponents(e,t,i,s,n){this.viewer===s&&(this.includeSelections=t,i&&0!==i.length?this.reaffectSelections(i,DD.INITIAL,n):(this.nodeModelOrSelection=e,this.reAffectComponents(DD.INITIAL,n)))}reaffectSelections(e,t,i){let s=[];e.forEach((e=>{s=s.concat(e.getOccurrencesFromSelection())})),s=(0,j.unionWithoutDuplicateValues)(s,uD);const n=!this.getIsOperationInProgress()&&t!==DD.ASSEMBLY_DATA_UPDATE&&!ci._3.getOpenDocumentController().getActiveElementController().getViewAlignmentController().isSectionViewDialogVisible();n&&(0,Ce.MO)(),this.shouldAddPreexistingOccurrences()&&(s=(0,j.unionWithoutDuplicateValues)([...s,...this.initialAffectedOccurrences],uD)),this.affectOccurrences(s,t,i),n&&(0,Ce.IQ)()}reAffectComponents(e,t){if(this.nodeModelOrSelection||this.includeSelections){const i=this.getSelectionFromNodeModelOrSelection(this.nodeModelOrSelection),s=[];if(i&&s.push(i),this.includeSelections){e!==DD.ASSEMBLY_DATA_UPDATE&&(this.initialSelectionList=(0,z.Z)((0,Ce.vi)())),this.initialSelectionList?.forEach((e=>{s.push(e)}))}this.reaffectSelections(s,e,t)}}affectOccurrences(e,t,i,s){if(0===e.length&&!this.isPersistentModeEnabled)return(0,sr.m)().trigger(ir.C.EXIT_ISOLATE,this.viewer),void(0,sr.m)().trigger(ir.C.EXIT_MAKE_TRANSPARENT,this.viewer);const n=t!==DD.EXPAND;let r=!0;this.hasAffectedInstances()&&(r=!1),this.shouldClearOccurrenceIds()&&this.setAffectedOccurrenceIds([]),this.isTranslucentModeEnabled||this.resetIsolationForRelatedGraphics(e),n?this.setInitialAffectedOccurrences(e):this.setAffectedOccurrences(e),this.isTranslucentModeEnabled?this.refreshTranslucentOccurrences(s):this.makeTransparent(r,i),n&&this.isolatedOccurrencesManager.initializingDialog!==is.Pmj.ISOLATE&&this.showDialog()}areSelectionsAlreadyAffected(e){const t=this.getSelectionFromNodeModelOrSelection(e),i=[];return(0,Ce.vi)().forEach((e=>{i.push(e)})),t&&i.push(t),this.areSelectionsInListAlreadyAffected(i)}areSelectionsInListAlreadyAffected(e){if((0,lt._R)()){let t=[];e.forEach((e=>{t=t.concat(e.getOccurrencesFromSelection())}));const i=(0,j.unionWithoutDuplicateValues)(t,uD);return(0,j.hasEquivalentValues)(i,this.initialAffectedOccurrences,(e=>e.toString()))}return!1}setInitialAffectedOccurrences(e){this.initialAffectedOccurrences=e,this.centersOfInitialAffectedInstances=null,this.setAffectedOccurrences(e)}setAffectedOccurrences(e){this.affectedOccurrences=e,this.setAffectedOccurrenceIdsFromOccurrences(e)}setAffectedOccurrenceIdsFromOccurrences(e){const t=e.map((e=>this.viewer.getIdForOccurrence(e)));this.setAffectedOccurrenceIds(t)}expandEffectByProximity(e){super.expandEffectByProximity(e);const{affectedIds:t,changedIds:i}=this.getAffectedOccurrencesForExpandEffectByProximity(e);t&&this.affectOccurrences(t,DD.EXPAND,!1,i)}updateCentersOfInitialAffectedInstances(){if(!this.centersOfInitialAffectedInstances){const e=this.getModelViewManager(),t=function(t){const i=e.getOccurrenceBounds(t);return i?i.center():null},i=this.initialAffectedOccurrences.map(t,this);this.centersOfInitialAffectedInstances=i.filter(j.isDefined,this)}}expandEffectByConnectivity(e){super.expandEffectByConnectivity(e);const{affectedIds:t,changedIds:i}=this.getAffectedOccurrencesForExpandEffectByConnectivity(e);this.affectOccurrences(t,DD.EXPAND,!1,i)}getAffectedOccurrencesForExpandEffectByConnectivity(e){if(-1===e){const e=new Set(this.initialAffectedOccurrences);return{affectedIds:this.initialAffectedOccurrences,changedIds:this.affectedOccurrences.filter((t=>!e.has(t)))}}{const t=this.getModelViewManager(),i=new Map,s=[],n=new Set(this.affectedOccurrences);let r=new Map;if(dD(this.initialAffectedOccurrences,t,i,r,n,s),r.size===this.initialAffectedOccurrences.length&&(e+=1),e>=1){const a=t.getDisplayedAssembly();if(a)for(let o=1;o<=e;o++){const e=a.getMateIndicatorConnectivityMap(r),o=r;r=new Map;for(const[a,h]of o){dD(e.get(h.getPathAsString()),t,i,r,n,s)}}}return{affectedIds:Array.from(i.values()),changedIds:s}}}initialAffectedOccurrencesHaveConnectedOccurrences(){const{affectedIds:e}=this.getAffectedOccurrencesForExpandEffectByConnectivity(0);return e.length>this.initialAffectedOccurrences.length}getAffectedOccurrencesForExpandEffectByProximity(e){if(0===e){const e=new Set(this.initialAffectedOccurrences);return{affectedIds:this.initialAffectedOccurrences,changedIds:this.affectedOccurrences.filter((t=>!e.has(t)))}}const t=this.getModelViewManager().getDisplayedAssembly();if(t){const i=Object.values(t.occurrences).map((function(e){return e.occurrenceData.occurrence}));this.updateCentersOfInitialAffectedInstances();const s=e*e,n=new Set(this.affectedOccurrences),r=[],a=[];for(const e of i)this.isWithinDistanceOfAnInitialAffectedOccurrence(s,e)?(r.push(e),n.has(e)||a.push(e)):n.has(e)&&a.push(e);return{affectedIds:(0,j.unionWithoutDuplicateValues)([...r,...this.initialAffectedOccurrences],uD),changedIds:a}}return null}getIsOperationInProgress(){const e=lt.T.getOpenDocumentActiveElement();return ci._3.hasActiveFeatureController()||e&&e.get("isOperationInProgress")}getAffectedOccurrences(){return this.affectedOccurrences}updateNodeModelOrSelection(){if(this.nodeModelOrSelection&&this.nodeModelOrSelection instanceof cD.I){const e=lD.AssemblyTreeMap.getTreeItem(this.nodeModelOrSelection.getFeatureId());if(!e)return;if(!e.children||!this.nodeModelOrSelection.children)return;e.children.length<this.nodeModelOrSelection.children.length&&(this.initialAffectedOccurrences=[]),this.nodeModelOrSelection=e}}affectId(e){this.initialAffectedOccurrences.push(e),this.affectOccurrences(this.initialAffectedOccurrences,DD.INITIAL,!1,[e])}deAffectId(e){this.initialAffectedOccurrences=this.initialAffectedOccurrences.filter((t=>t!==e)),this.affectOccurrences(this.initialAffectedOccurrences,DD.INITIAL,!1,[e])}}class pD extends gD{getOccurrencesWithAffectedGraphics(){const e=this.viewer.getOccurrenceDataManager().getOccurrencesData(),t=[];for(const i of e)if(!i.getIsolated()&&!i.isUIElement){const e=this.viewer.getOccurrenceIdManager().getNameForId(i.getOccurrenceId()),s=k._oC.getOccurrenceFromPathString(e);t.push(s)}return t}setUpListeners(){super.setUpListeners(),this.listenTo((0,sr.m)(),ir.C.EXIT_ISOLATE,this.clearEffectExit),this.listenTo((0,sr.m)(),ir.C.ISOLATE_COMPONENTS,this.affectComponents)}clearIsolateNoAnimation(){this.clearEffectNoAnimation()}hasIsolatedInstances(){return this.hasAffectedInstances()}areSelectionsAlreadyIsolated(e){return this.areSelectionsAlreadyAffected(e)}areSelectionsInListAlreadyIsolated(e){return this.areSelectionsInListAlreadyAffected(e)}isInIsolateMode(){return this.isIsolateInEffectMode()}addIdsToIsolate(e,t){this.addIdsToAffect(e,t)}removeFromIsolate(e){this.removeFromEffect(e)}isolateOccurrences(e,t){this.affectOccurrences(e,t)}getIsolatedOccurrences(){return this.getAffectedOccurrences()}setIsolatedOccurrenceIds(e){this.setAffectedOccurrenceIds(e)}clearEffect(){super.clearEffect(),this.setSeedComponentsNull(),this.setIsolationForRelatedGraphics(this.affectedOccurrences,!1),this.setInitialAffectedOccurrences([])}shouldAddPreexistingOccurrences(){return!1}shouldClearOccurrenceIds(){return this.hasAffectedInstances()}resetIsolationForRelatedGraphics(e){this.setIsolationForRelatedGraphics(this.affectedOccurrences,!1),this.setIsolationForRelatedGraphics(e,!0)}showDialog(){this.dialog?this.dialog.onAssemblyOrPartStudioDataProcessed():this.dialog=TD.createIsolateDialog(this)}updateOccurrenceDataManager(){TD.updateOccurrenceDataManager(this.affectedOccurrenceIds,this.viewer.getOccurrenceDataManager())}}var mD=i(64054);class fD extends gD{constructor(e,t){super(e,t)}getTransparentOccurrences(){return this.getAffectedOccurrences()}getOccurrencesWithAffectedGraphics(){return this.affectedOccurrences}areSelectionsAlreadyTransparent(e){return this.areSelectionsAlreadyAffected(e)}areSelectionsInListAlreadyTransparent(e){return this.areSelectionsInListAlreadyAffected(e)}hasTransparentInstances(){return this.hasAffectedInstances()}clearTransparentNoAnimation(){this.clearEffectNoAnimation()}setUpListeners(){super.setUpListeners(),this.listenTo((0,sr.m)(),ir.C.MAKE_TRANSPARENT_COMPONENTS,this.affectComponents),this.listenTo((0,sr.m)(),ir.C.EXIT_MAKE_TRANSPARENT,this.clearEffectExit)}showDialog(){if(this.dialog)this.dialog.onAssemblyOrPartStudioDataProcessed();else{const e={isolateManager:this};this.dialog=new mD.o8(e)}}clearEffect(){super.clearEffect(),this.viewer.getOccurrenceDataManager().clearIsolation(),this.isolatedOccurrencesManager.removeMakeTransparentManager()}updateOccurrenceDataManager(){0===this.affectedOccurrenceIds.length?this.viewer.getOccurrenceDataManager().isolateAll():this.affectedOccurrenceIds.forEach((e=>{e!==Jf.Qy&&this.viewer.getOccurrenceDataManager().setOccurrenceIsolated(e,!1)}))}shouldAddPreexistingOccurrences(){return!0}shouldClearOccurrenceIds(){return!0}resetIsolationForRelatedGraphics(e){this.setIsolationForRelatedGraphics(this.affectedOccurrences,!0),this.setIsolationForRelatedGraphics(e,!1)}}class ID extends hD{constructor(e,t){super(e,t),this.initialAffectedPartIds=[],this.initialAffectedSheetMetalIds=new Set,this.affectedPartIds=[]}getSeedPartOrOccurrenceIds(){return this.initialAffectedPartIds}refreshTranslucentOccurrences(e){const t=this.getBodyComponent(fs.L.BASE),i=this.getPartIdsWithAffectedGraphics(t);e&&i.push(...e);for(const e of i)t.refreshBodyOccurrenceForBodyId(e);const s=this.getBodyComponent(fs.L.PREVIEW);if(s){const e=this.getPartIdsWithAffectedGraphics(s);for(const t of e)s.refreshBodyOccurrenceForBodyId(t)}this.viewer.requestDraw()}affectId(e){this.affectPartIds([e],this.viewer,!0,[e])}deAffectId(e){this.initialAffectedPartIds=this.initialAffectedPartIds.filter((t=>t!==e)),this.affectPartIds([],this.viewer,!0)}resetAffectWithIsolatableIds(e){this.initialAffectedPartIds=e,this.affectPartIds([],this.viewer,!0)}setUpListeners(){this.stopListening(),this.listenTo(this.viewer.getEventDispatcher(),yD.CD,this.onPartDataProcessed)}onPartDataProcessed(e){const t=e.elementId,i=ci._3.getOpenDocumentController().getDeterministicIdMapper(t);i&&(this.initialAffectedPartIds=this.initialAffectedPartIds.map((t=>i.remapDetId(t,e.featureIdToOperationIndices))),this.isIsolateInEffectMode()&&(0,lt._B)()&&this.reAffectParts(this.initialAffectedPartIds,DD.PART_STUDIO_UPDATE,!1))}affectParts(e,t,i,s){return this.affectPartIds(e.map((e=>e.id)),t,this.shouldAddPreexistingParts(),void 0,i,s)}affectPartIds(e,t,i,s,n,r){this.viewer===t&&(r&&this.setIsIsolateFullyTransparentAsDefault(),this.reAffectParts(e,DD.INITIAL,n,i,s))}clearEffectExit(e){const t=this.viewer.getModelViewManagers().getManager().isDisplayingIncontextAssembly();t?(this.clearEffectNoAnimation(),(0,yD.xA)().trigger(yD.bh,t)):(super.clearEffectExit(e),this.updateLaminarEdges())}clearEffectNoAnimation(){super.clearEffectNoAnimation(),this.updateLaminarEdges()}reAffectParts(e,t,i,s=!1,n){(s||this.shouldAddPreexistingParts())&&(e=(0,j.unionWithoutDuplicateValues)([...e,...this.initialAffectedPartIds],(e=>e))),t===DD.INITIAL&&(this.initialAffectedSheetMetalIds=this.getSheetMetalIds(e,this.getModelViewManager()));let r=this.getAssociatedPartIdsFromSheetMetalIds(this.initialAffectedSheetMetalIds,this.getModelViewManager());this.getPreviewViewManager()&&(r=r.concat(this.getAssociatedPartIdsFromSheetMetalIds(this.initialAffectedSheetMetalIds,this.getPreviewViewManager()))),e=(0,j.unionWithoutDuplicateValues)([...e,...r],(e=>e));const a=this.getIndividualOccurrenceIdsFromPartIds(e);if(!this.isPersistentModeEnabled&&0===a.length)return void this.triggerExit();let o=!0;this.shouldNotDoAnimation()&&(o=!1),this.shouldClearOccurrenceIds()&&this.setAffectedOccurrenceIds([]);!(0,Ce.yz)()&&t!==DD.PART_STUDIO_UPDATE&&!ci._3.getOpenDocumentController().getActiveElementController().getViewAlignmentController().isSectionViewDialogVisible()&&((0,Ce.MO)(),(0,Ce.IQ)()),t!==DD.INITIAL&&t!==DD.PART_STUDIO_UPDATE||(this.initialAffectedPartIds=e,this.centersOfInitialAffectedInstances=null),this.affectedPartIds=e,this.isTranslucentModeEnabled||this.refreshMateIsolation(this.affectedPartIds),this.affectPartOccurrenceIds(a,t,o,i,n)}getSheetMetalIds(e,t){const i=t.getDisplayedPartStudio(),s=new Set;return e.forEach((e=>{const t=i.retrieveBodyMetaData(e);t&&t.sheetMetalModelId&&s.add(t.sheetMetalModelId)})),s}getAssociatedPartIdsFromSheetMetalIds(e,t){const i=t.getDisplayedPartStudio(),s=[];for(const t in i.bodyComponent.bodyMetaData){const n=i.bodyComponent.bodyMetaData[t];n.sheetMetalModelId&&e.has(n.sheetMetalModelId)&&s.push(t)}return s}getBodyComponent(e){return this.viewer.getModelViewManagers().getManagerForUsage(e)?.getDisplayedPartStudio()?.getBodyComponent()}setIsolatedPartMates(e,t){const i=this.getModelViewManager().getDisplayedPartStudio();if(i){const s=i.getAllMateConnectorGraphics(null).filter((e=>""!==e.definition.partId));this.isolateMateConnectors(s,this.getModelViewManager(),e,t)}const s=this.getPreviewViewManager();if(s){const i=s.getDisplayedPartStudio();if(i){const n=i.getAllMateConnectorGraphics(null).filter((e=>""!==e.definition.partId));this.isolateMateConnectors(n,s,e,t)}}}isolateMateConnectors(e,t,i,s){if(s){const n=this.getIndividualPartIds(s,t),r=t.getDisplayedPartStudio();e.forEach((e=>{let t=e.definition.partId;const s=r.retrieveBodyMetaData(t);s&&s.consumingClosedCompositeData&&(t=s.consumingClosedCompositeData.id),n.has(t)&&e.getOccurrenceData().setIsolated(i)}))}else e.forEach((e=>{e.getOccurrenceData().setIsolated(i)}))}shouldAddSketchesToEffect(){return!0}updateLaminarEdges(){const e=this.viewer.getFilteredEntitiesHighlightController();e&&e.updateSetOfFilteredEntities()}affectPartOccurrenceIds(e,t,i,s,n){this.isPersistentModeEnabled||0!==e.length?(this.shouldAddSketchesToEffect()&&e.push(this.getModelViewManager().getDisplayedPartStudio().getSketchComponent().sketchComponentElementId),this.hasAffectedInstances()&&this.setAffectedOccurrenceIds([]),this.addIdsToAffect(e,!0),this.isTranslucentModeEnabled?this.refreshTranslucentOccurrences(n):(this.refreshMateIsolation(this.affectedPartIds),this.makeTransparent(i,s),null!==!this.isolatedOccurrencesManager.initializingDialog&&(t===DD.INITIAL||t===DD.PART_STUDIO_UPDATE&&this.isIsolateInEffectMode())&&this.showDialog(),this.updateLaminarEdges())):this.triggerExit()}getIndividualOccurrenceIdsFromPartIds(e){const t=[],i=this.getIndividualPartIds(e,this.getModelViewManager()),s=this;return i.forEach((e=>{const i=s.getOccurrenceIdFromPartId(e);i&&t.push(i)})),t}getIndividualPartIds(e,t){const i=t.getDisplayedPartStudio(),s=new Set;return e.forEach((e=>{const t=i.retrieveBodyMetaData(e);t&&(t.isComposite&&!t.isGroupableCompositeBody?t.constituentBodyIds.forEach((e=>{s.add(e)})):s.add(e))})),s}getOccurrenceIdFromPartId(e){const t=this.getModelViewManager().getDisplayedPartStudio().getBodyComponent().getBodyOccurrenceData(e);if(t){const e=t.getOccurrenceId();if(e&&e!==Jf.Qy)return e}return null}areSelectionsAlreadyAffected(e){if((0,lt._B)()){const t=ID.getSelectedParts(e,this.viewer);return this.arePartsAlreadyAffected(t)}return!1}areSelectionsInListAlreadyAffected(e){const t=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio().id;if((0,lt._B)()){const i=(0,Ce.mZ)(t,e);return this.arePartsAlreadyAffected(i)}return!1}arePartsAlreadyAffected(e){const t=e.map((e=>e.id));return(0,j.hasEquivalentValues)(t,this.initialAffectedPartIds,(e=>e))}static getSelectedParts(e,t){const i=CD.getSelectionFromNodeModelOrSelection(e,t),s=t.getModelViewManagers().getManager().getDisplayedPartStudio();if(!s)return[];const n=s.getElementId();let r;return i&&(r=wS.L.getPartModelFromPartId(i.getPartId(),n)),(0,Ce.JA)(n,r)}updateCentersOfInitialAffectedInstances(){if(!this.centersOfInitialAffectedInstances){const e=[];this.initialAffectedPartIds.forEach((t=>{const i=this.getModelViewManager().getBodyBounds(t,null);i&&e.push(i.center())})),this.centersOfInitialAffectedInstances=e.filter(j.isDefined,this)}}expandEffectByProximity(e){super.expandEffectByProximity(e);let{affectedIds:t,changedIds:i}=this.getAffectedPartIdsForExpandEffectByProximity(e,this.getModelViewManager(),!1),s=this.getIndividualOccurrenceIdsFromPartIds(t);const n=this.getPreviewViewManager();if(n){const{affectedIds:i}=this.getAffectedPartIdsForExpandEffectByProximity(e,n,!0),r=n.getDisplayedPartStudio().getBodyComponent(),a=[];i.forEach((e=>{const t=r.getBodyOccurrenceData(e);t&&a.push(t.getOccurrenceId())})),t=(0,j.unionWithoutDuplicateValues)([...t,...i],(e=>e)),s=(0,j.unionWithoutDuplicateValues)([...s,...a],(e=>e+"")),s=s.concat(this.getAffectedOwnerlessMatesOccurrenceIdsByProximity(e,n))}this.affectedPartIds=t,this.affectPartOccurrenceIds(s,DD.EXPAND,!1,!1,i)}getAffectedOwnerlessMatesOccurrenceIdsByProximity(e,t){if(Math.abs(e)<=Ci.W.ZERO_LENGTH)return[];const i=[],s=t.getDisplayedPartStudio().getAllMateConnectorGraphics(null).filter((e=>""===e.definition.partId)),n=e*e;for(const e of s)this.isPointWithinDistanceOfInitialAffectedInstances(e.worldSpacePosition,n)&&i.push(e.getOccurrenceData().getOccurrenceId());return i}getAffectedPartIdsForExpandEffectByProximity(e,t,i){const s=this.getAssociatedPartIdsFromSheetMetalIds(this.initialAffectedSheetMetalIds,t);if(!i&&Math.abs(e)<=Ci.W.ZERO_LENGTH){const e=new Set(this.initialAffectedPartIds);return{affectedIds:(0,j.unionWithoutDuplicateValues)([...this.initialAffectedPartIds,...s],(e=>e)),changedIds:this.affectedPartIds.filter((t=>!e.has(t)))}}this.updateCentersOfInitialAffectedInstances();const n=t.getDisplayedPartStudio().getBodyComponent(),r=[],a=e*e,o=[],h=this.isTranslucentModeEnabled?new Set(this.affectedPartIds):null;for(const e in n.partStudioBodyIdToOccurrenceId)this.isWithinDistanceOfAnInitialIsolatedPart(a,e,null,t)?(r.push(e),h?.has(e)||o.push(e)):h?.has(e)&&o.push(e);const c=this.getSheetMetalIds(r,t),l=this.getAssociatedPartIdsFromSheetMetalIds(c,t);return{affectedIds:(0,j.unionWithoutDuplicateValues)([...r,...this.initialAffectedPartIds,...l,...s],(e=>e)),changedIds:o}}isWithinDistanceOfAnInitialIsolatedPart(e,t,i,s){const n=s.getBodyBounds(t,i);return!!n&&this.isBoundsWithinDistanceOfInitialAffectedInstances(n,e)}}class ED extends ID{getPartIdsWithAffectedGraphics(e){return e.getBodyIds((e=>!this.affectedPartIds.includes(e.getId())))}setUpListeners(){super.setUpListeners(),this.listenTo((0,sr.m)(),ir.C.EXIT_ISOLATE,this.clearEffectExit),this.listenTo((0,sr.m)(),ir.C.ISOLATE_PARTS,this.affectParts)}clearIsolateNoAnimation(){this.clearEffectNoAnimation()}hasIsolatedInstances(){return this.hasAffectedInstances()}areSelectionsAlreadyIsolated(e){return this.areSelectionsAlreadyAffected(e)}areSelectionsInListAlreadyIsolated(e){return this.areSelectionsInListAlreadyAffected(e)}isInIsolateMode(){return this.isIsolateInEffectMode()}addIdsToIsolate(e,t){this.addIdsToAffect(e,t)}removeFromIsolate(e){this.removeFromEffect(e)}isolateOccurrences(e,t){this.affectOccurrences(e,t)}getIsolatedOccurrences(){return this.getAffectedOccurrences()}setIsolatedOccurrenceIds(e){this.setAffectedOccurrenceIds(e)}clearEffect(){this.initialAffectedPartIds=[],this.setAffectedOccurrenceIds([]),this.setIsolatedPartMates(!1),this.initialAffectedSheetMetalIds=new Set,super.clearEffect()}triggerExit(){(0,sr.m)().trigger(ir.C.EXIT_ISOLATE,this.viewer)}shouldNotDoAnimation(){return this.hasAffectedInstances()}shouldClearOccurrenceIds(){return this.hasAffectedInstances()}refreshMateIsolation(e){this.setIsolatedPartMates(!1),this.setIsolatedPartMates(!0,e)}shouldAddPreexistingParts(){return!1}shouldAddSketchesToIsolate(){return!0}showDialog(){this.dialog?this.dialog.onAssemblyOrPartStudioDataProcessed():this.dialog=TD.createIsolateDialog(this)}updateOccurrenceDataManager(){TD.updateOccurrenceDataManager(this.affectedOccurrenceIds,this.viewer.getOccurrenceDataManager())}}class SD extends ID{getPartIdsWithAffectedGraphics(e){return this.affectedPartIds}constructor(e,t,i,s){super(e,t)}getTransparentOccurrences(){return this.getAffectedOccurrences()}areSelectionsAlreadyTransparent(e){return this.areSelectionsAlreadyAffected(e)}areSelectionsInListAlreadyTransparent(e){return this.areSelectionsInListAlreadyAffected(e)}hasTransparentInstances(){return this.hasAffectedInstances()}clearTransparentNoAnimation(){this.clearEffectNoAnimation()}setUpListeners(){super.setUpListeners(),this.listenTo((0,sr.m)(),ir.C.MAKE_TRANSPARENT_PARTS,this.affectParts),this.listenTo((0,sr.m)(),ir.C.EXIT_MAKE_TRANSPARENT,this.clearEffectExit)}showDialog(){if(this.dialog)this.dialog.onAssemblyOrPartStudioDataProcessed();else{const e={isolateManager:this};this.dialog=new mD.o8(e)}}clearEffect(){super.clearEffect(),this.viewer.getOccurrenceDataManager().clearIsolation(),this.isolatedOccurrencesManager.removeMakeTransparentManager(),this.updateLaminarEdges()}updateOccurrenceDataManager(){if(0===this.affectedOccurrenceIds.length){let e=this.getModelViewManager().getDisplayedPartStudio().getPartStudioOccurrenceIds();this.getPreviewViewManager()&&(e=e.concat(this.getPreviewViewManager().getDisplayedPartStudio().getPartStudioOccurrenceIds())),e.forEach((e=>{e!==Jf.Qy&&this.viewer.getOccurrenceDataManager().setOccurrenceIsolated(e,!0)}))}else this.affectedOccurrenceIds.forEach((e=>{e!==Jf.Qy&&this.viewer.getOccurrenceDataManager().setOccurrenceIsolated(e,!1)}))}refreshMateIsolation(e){this.setIsolatedPartMates(!0),this.setIsolatedPartMates(!1,e)}triggerExit(){(0,sr.m)().trigger(ir.C.EXIT_MAKE_TRANSPARENT,this.viewer)}shouldAddPreexistingParts(){return!0}shouldAddSketchesToEffect(){return!1}shouldNotDoAnimation(){return this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()}shouldClearOccurrenceIds(){return!0}}class TD{static createIsolateDialog(e){const t={isolateManager:e};return new mD.sl(t)}static updateOccurrenceDataManager(e,t){e&&t&&(0===e.length?t.clearIsolation():e.forEach((e=>{e!==Jf.Qy&&t.setOccurrenceIsolated(e,!0)})))}}var DD,MD=i(75129);!function(e){e[e.INITIAL=0]="INITIAL",e[e.ASSEMBLY_DATA_UPDATE=1]="ASSEMBLY_DATA_UPDATE",e[e.EXPAND=2]="EXPAND",e[e.PART_STUDIO_UPDATE=3]="PART_STUDIO_UPDATE"}(DD||(DD={}));class CD extends m.T{constructor(e){super(),this.viewer=e,this.contextTransparencyMultiplier=1,(0,lt._B)()?this.currentIsolateManager=new ED(e,this):this.currentIsolateManager=new pD(e,this),this.setUpListeners()}isInMakeTransparentModeWithoutDialog(){return this.isInMakeTransparentMode()&&!this.currentMakeTransparentManager.isDialogOpen()}isInIsolateModeWithoutDialog(){return this.isInIsolateMode()&&!this.currentIsolateManager.isDialogOpen()}switchActiveElement(e){this.currentIsolateManager.destroy(),this.currentMakeTransparentManager&&(this.currentMakeTransparentManager.destroy(),this.currentMakeTransparentManager=null),this.currentIsolateManager=e?new ED(this.viewer,this):new pD(this.viewer,this)}clearIsolateManagerNoGraphicsUpdate(){this.currentIsolateManager.clearAffectedOccurrenceIdsNoGraphicsUpdate()}removeMakeTransparentManager(){this.currentMakeTransparentManager&&this.currentMakeTransparentManager.destroy(),this.currentMakeTransparentManager=null}getContextTransparencyMultiplier(){return this.contextTransparencyMultiplier}getIsIsolateFullyTransparent(){return this.currentMakeTransparentManager?this.currentMakeTransparentManager.getIsIsolateFullyTransparent():this.currentIsolateManager.getIsIsolateFullyTransparent()}onIsIsolateFullyTransparentChanged(){this.trigger(CD.IS_ISOLATE_FULLY_TRANSPARENT_CHANGED_EVENT)}setContextTransparencyMultiplier(e){this.contextTransparencyMultiplier=e,this.viewer.requestDraw()}onMakeTransparentParts(e,t){if(0===e.length||this.currentMakeTransparentManager)this.currentMakeTransparentManager&&this.currentMakeTransparentManager.showDialog();else{this.currentMakeTransparentManager=new SD(t,this,e,t),this.currentMakeTransparentManager.affectParts(e,t);const i=t.getFilteredEntitiesHighlightController();i&&i.updateSetOfFilteredEntities()}}onMakeTransparentComponents(e,t,i,s){this.currentMakeTransparentManager||(this.currentMakeTransparentManager=new fD(this.viewer,this),this.currentMakeTransparentManager.affectComponents(e,t,i,s))}static partCanBeIsolated(e){return e.bodyType===k.wG2.SOLID||e.bodyType===k.wG2.SHEET||e.bodyType===k.wG2.WIRE||e.isComposite}setUpListeners(){this.listenTo((0,sr.m)(),ir.C.MAKE_TRANSPARENT_COMPONENTS,this.onMakeTransparentComponents),this.listenTo((0,sr.m)(),ir.C.MAKE_TRANSPARENT_PARTS,this.onMakeTransparentParts),this.currentIsolateManager.setUpListeners()}destroy(){this.currentIsolateManager.destroy(),this.currentMakeTransparentManager&&this.currentMakeTransparentManager.destroy()}isIsolateManagerInUse(){return this.isInIsolateMode()||!!(0,Ce.Eo)()||ci._3.getOpenDocumentController().isInterferenceDetectionActive()}clearAllIsolateNoAnimation(){this.currentIsolateManager.clearIsolateNoAnimation(),this.currentMakeTransparentManager&&this.currentMakeTransparentManager.clearTransparentNoAnimation()}hasIsolatedInstances(){return this.currentIsolateManager.hasIsolatedInstances()||this.currentMakeTransparentManager&&this.currentMakeTransparentManager.hasTransparentInstances()}areSelectionsAlreadyIsolated(e){return this.currentIsolateManager.areSelectionsAlreadyIsolated(e)}areSelectionsInListAlreadyIsolated(e){return this.currentIsolateManager.areSelectionsInListAlreadyIsolated(e)}isInIsolateMode(){return this.currentIsolateManager.isInIsolateMode()}addIdsToIsolate(e,t){this.currentIsolateManager.addIdsToIsolate(e,t)}removeFromIsolate(e){this.currentIsolateManager.removeFromIsolate(e)}isolateOccurrences(e,t){this.currentIsolateManager.isolateOccurrences(e,t)}getIsolatedOccurrences(){return this.currentMakeTransparentManager?this.currentMakeTransparentManager.getTransparentOccurrences():this.currentIsolateManager.getIsolatedOccurrences()}setIsolatedOccurrenceIds(e){this.currentIsolateManager.setIsolatedOccurrenceIds(e)}isInMakeTransparentMode(){return!!this.currentMakeTransparentManager||this.initializingDialog===is.Pmj.MAKE_TRANSPARENT}isInTranslucentMode(){return this.currentIsolateManager?.isTranslucentModeEnabled||this.currentMakeTransparentManager?.isTranslucentModeEnabled}isInPickingMode(){return this.currentIsolateManager?.isInPickingMode||this.currentMakeTransparentManager?.isInPickingMode}areSelectionsInListAlreadyTransparent(e){if(this.currentMakeTransparentManager)return this.currentMakeTransparentManager.areSelectionsInListAlreadyTransparent(e);{let t=!0;return e.forEach((e=>{this.noOccurrencesOrPartsSelected(e)||(t=!1)})),t}}areSelectionsAlreadyTransparent(e){return this.currentMakeTransparentManager?this.currentMakeTransparentManager.areSelectionsAlreadyTransparent(e):this.noOccurrencesOrPartsSelected(e)}isInIsolateOrMakeTransparentMode(){return this.isInIsolateMode()||this.isInMakeTransparentMode()}isInIsolateOrMakeTransparentModeWithoutDialog(){return this.currentMakeTransparentManager?.isPersistentModeEnabled||this.currentIsolateManager?.isPersistentModeEnabled}affectSelection(e,t){(0,lt._R)()?e.forEach((e=>t.affectId(e.getOccurrence()))):e.forEach((e=>t.affectId(e.getBodyId()))),t.isDialogOpen()||t.showDialog()}isolateSelections(e){this.affectSelection(e,this.currentIsolateManager)}makeTransparentSelections(e){this.affectSelection(e,this.currentMakeTransparentManager)}noOccurrencesOrPartsSelected(e){if((0,lt._B)())return 0===ID.getSelectedParts(e,this.viewer).length;if((0,lt._R)()){if(e){if(0!==CD.getSelectionFromNodeModelOrSelection(e,this.viewer).getOccurrencesFromSelection().length)return!1}let t=!1;return(0,Ce.vi)().forEach((e=>{0!==e.getOccurrencesFromSelection().length&&(t=!0)})),!t}return!0}static getSelectionFromNodeModelOrSelection(e,t){return e?e instanceof Ce.Y1?e:e instanceof MD.e?e.getSelection():e.getSelection(t):null}isOccurrenceIdForInContext(e){return this.viewer.getModelViewManagers().getManager().isOccurrenceIdForInContext(e)}isOccurrenceTranslucent(e){if(!e)return!1;if(this.isOccurrenceIdForInContext(e.getOccurrenceId()))return!1;let t;return this.isInMakeTransparentMode()?t=this.currentMakeTransparentManager:this.isInIsolateMode()&&(t=this.currentIsolateManager),t?.isTranslucentModeEnabled&&!e.getIsolated()&&!e.isUIElement}}CD.IS_ISOLATE_FULLY_TRANSPARENT_CHANGED_EVENT="IS_ISOLATE_FULLY_TRANSPARENT_CHANGED_EVENT";var yD=i(78613);class PD{constructor(){this.zoomScrollDirection=!1,this.viewManipulationMouseKeyMapping={},this.allowDefaultAxisRotationLock=!1,this.axisRotationLock=!1,this.mouseStringCodeMap={},this.keyStringCodeMap={},this.defaultReverseScrollWheelZoomDirection=!1,this.mouseStringCodeMap.LMB=Hn.tc.LEFT,this.mouseStringCodeMap.MMB=Hn.tc.MIDDLE,this.mouseStringCodeMap.RMB=Hn.tc.RIGHT,this.keyStringCodeMap.CTRL=cs.R8.CONTROL,this.keyStringCodeMap.SHIFT=cs.R8.SHIFT,this.keyStringCodeMap.ALT=cs.R8.ALT,this.allowDefaultAxisRotationLock=Ki.Jq.CapabilitiesService.checkAllowDefaultAxisRotationLockCurrentlyEnabled()}setMouseSettings(e){this.zoomScrollDirection=e.reverseScrollWheelZoomDirection,this.viewManipulationMouseKeyMapping=e.viewManipulationMouseKeyMapping,this.axisRotationLock=e.axisRotationLock,this.applyViewManipulationMouseKeyMapping()}getMouseButtons(e){const t=[];return e.forEach((e=>{this.mouseStringCodeMap.hasOwnProperty(e)&&t.push(this.mouseStringCodeMap[e])})),t}getKeyCodes(e){const t=[];return e.forEach((e=>{this.keyStringCodeMap.hasOwnProperty(e)&&t.push(this.keyStringCodeMap[e])})),t}applyViewManipulationMouseKeyMapping(){if(!this.viewManipulationMouseKeyMapping)return;const e=GI();e.clearMouseKeyManipulationBindings(),Object.keys(this.viewManipulationMouseKeyMapping).forEach((t=>{let i=IC.k.NONE;switch(t){case"pan3DMapping":i=IC.k.PAN;break;case"zoom3DMapping":i=IC.k.ZOOM;break;case"rotate3DMapping":i=!0===this.axisRotationLock&&this.allowDefaultAxisRotationLock?IC.k.AXIS_ROTATE:IC.k.ROTATE;break;case"axisRotate3DMapping":i=!0===this.axisRotationLock&&this.allowDefaultAxisRotationLock?IC.k.ROTATE:IC.k.AXIS_ROTATE;break;default:i=IC.k.NONE}if(i!==IC.k.NONE){const s=this.viewManipulationMouseKeyMapping[t];for(let t=0;t<s.length;++t){const n=s[t],r=this.getMouseButtons(n.mouseButtons),a=this.getKeyCodes(n.keys);(0,j.isEmptyObjectOrArray)(r)&&(0,j.isEmptyObjectOrArray)(a)||e.addMouseKeyManipulationModeBinding(r,a,i)}}}))}isScrollZoomDefault(){return this.zoomScrollDirection===this.defaultReverseScrollWheelZoomDirection}}let AD=null;function OD(){return AD||(AD=new PD),AD}i(35692);const vD="WebGL Error: ",RD=200;function wD(e){const t=e.getCamera(),i=e.retrieveVisiblePicks(0,0,t.getViewportWidth(),t.getViewportHeight());GD(e,i)}const _D=new xi.hF({primitiveType:Di.MX.POINTS,isShowThrough:!0,isDepthTested:!1,isPickable:!1}),ND=new xi.hF({primitiveType:Di.MX.LINES,isShowThrough:!0,isDepthTested:!1,isPickable:!1}),bD=new Map;function LD(e){let t=bD.get(e);return t||(t=new Ti.u1(e),bD.set(e,t)),t}let FD=0;function xD(e,t,i,s,n,r){const a=LD(e),o=X.default.getManager(),h=(0,Au.Pu)(i,"p"+FD++);(0,Au.Ab)(s||o.getColor("DEBUG_POINT_DEFAULT_COLOR"),h),(0,Au.VQ)(n||o.getNumber("DEBUG_POINT_DEFAULT_SIZE"),h),(0,Au.KZ)(r||o.getPointFont("DEBUG_POINT_DEFAULT_POINT_FONT"),h),a.updateMeshIncrement(t,Ti.ZJ,h,_D),e.requestDraw()}function BD(e,t,i,s){const n=LD(e),r=X.default.getManager(),a=(0,Au.U0)(i.getMin(),i.getMax());(0,Au.Ab)(s||r.getColor("DEBUG_BOUNDINGBOX_DEFAULT_COLOR"),a),n.updateMeshIncrement(t,Ti.ZJ,a,ND),e.requestDraw()}function VD(e,t,i,s,n){const r=(0,Au.W5)(i,s,t,n);LD(e).updateMeshIncrement(t,Ti.ZJ,r,ND),e.requestDraw()}function UD(e,t,i){const s=X.default.getManager(),n=i.origin.getVec3(),r=100*e.getCamera().getPixelSizeAtWorldPoint(n);VD(e,t+".xAxis",n,C.scaleAndAdd(C.create(),n,i.xAxis.getVec3(),r),s.getColor("DEBUG_X_AXIS_COLOR")),VD(e,t+".yAxis",n,C.scaleAndAdd(C.create(),n,i.yAxis.getVec3(),r),s.getColor("DEBUG_Y_AXIS_COLOR")),VD(e,t+".zAxis",n,C.scaleAndAdd(C.create(),n,i.zAxis.getVec3(),r),s.getColor("DEBUG_Z_AXIS_COLOR"))}function GD(e,t){const i=X.default.getManager(),s=LD(e),n=e.getCamera();s.removeMeshIncrements();const r=function(t,i,s,r,a){const o=n.canvasToWorld([i[0],i[1],.5]);xD(e,t,o,s,r,a)};for(let e=0;e<t.length;++e){const s=t[e];let n=[1,1,1];const a=s.getEntityMetaData();a&&a.isVertex()?n=i.getColor("DEBUG_PICK_VERTEX_COLOR"):a&&a.isEdge()?n=i.getColor("DEBUG_PICK_EDGE_COLOR"):a&&a.isFace()&&(n=i.getColor("DEBUG_PICK_FACE_COLOR"));const o=ge.S4.add(n,[.2,.2,.2],C.create());for(let t=0;t<s.locationSamples.length;++t)r(e+"."+t,s.locationSamples[t],o,i.getNumber("DEBUG_PICK_SAMPLE_SIZE"));r(e+".average",ge.gv.scale(s.locationSum,1/s.locationCount,Q.create()),ge.S4.scale(n,.6,C.create()),i.getNumber("DEBUG_PICK_AVERAGE_SIZE"),i.getPointFont("DEBUG_PICK_POINT_AVERAGE_FONT")),r(e+".location",s.location,n,i.getNumber("DEBUG_PICK_SIZE"),i.getPointFont("DEBUG_PICK_POINT_FONT"))}e.requestDraw()}let HD=null,kD=!1;const WD=null;let zD=null;function XD(e){if(HD&&HD.closed&&(HD=null,kD=!1),!HD){HD=window.open("/debugwindows/scenedebug.html");let e=0;const t=setInterval((function(){HD?.document&&"complete"===HD.document.readyState&&(kD=!0,zD&&(zD(),zD=null)),(kD||e++>RD)&&clearInterval(t)}),200)}const t=(0,oi.f1)(!!e&&e.useSheetMetalViewer),i=t.getSceneGraphs().getMainSceneGraph().makeSceneDebugObject(),s=t.getSceneGraphs().getPreviewSceneGraph().makeSceneDebugObject(),n=t.getSceneGraphs().getHudSceneGraph().makeSceneDebugObject(),r=t.getOccurrenceDataManager().makeSceneDebugObject(),a=location.protocol+"//"+location.hostname+(location.port?":"+location.port:""),o=function(){HD?.postMessage([r,i,s,n],a)};kD?o():zD=o}let ZD=0;function qD(e){ZD=0;let t=0,i=0;const s=(e=e||{}).numFrames?e.numFrames:720;let n=null;const r=(0,oi.f1)(!!e?.flat);if(!r)return;r.draw(),r.setSuppressMouseMovePick(!0),r.completeTasks(),e?.forceLowDetail&&r.detailManager.forceLowestDetailSettings();let a=0,o=[],h=[];const c=r.getGlContext();let l=[];if(e?.timeShadersPrograms){const e=c.getProgramFlags().length;h=[],l=[],o=[];for(let t=0;t<e;t++)if(t in c.programNames){const i=new Array(e);for(let s=0;s<e;s++)i[s]=s===t;h.push(i),l.push(t)}let t,i=new Array(e);for(t=0;t<e;t++)i[t]=!1;for(h.push(i),i=new Array(e),t=0;t<e;t++)i[t]=!0;h.push(i),console.dir(h),a=0,c.setProgramFlags(h[0])}const u={performFrameTiming:!1},d=function(){const g=window.performance.now();if(n&&(t+=(g-n)/1e3,++i),n=g,i<s){const e=r.getPrimaryViewController();e?.rotateAbout(.0698131701,[0,1,0],e.camera.focalPoint()),r.setUserIsAdjustingCamera(),r.forceRequestDraw(u)}else if(e?.timeShadersPrograms&&a<h.length)o[a]=t/i*1e3,a++,a<h.length&&c.setProgramFlags(h[a]),t=0,i=0,n=null;else{r.getEventDispatcher()?.off(yD.u9,d);const s=(i/t).toFixed(2);t=t.toFixed(2),ZD=1e3*t/i;const n="Rendered "+i+" frames in "+t+" seconds at "+s+" fps "+ZD.toFixed(2)+" ms frametime";if(Ki.Jq.MessageBubbleService.showMessage(n),ut.log.debug(n),r.setSuppressMouseMovePick(!1),e?.timeShadersPrograms){for(let e=0;e<o.length-2;e++)l[e]in c.programNames&&ut.log.debug("program "+e+" "+c.programNames[l[e]]+" "+o[e]+" ms");ut.log.debug("no programs  "+o[o.length-2]+" ms"),ut.log.debug("all programs "+o[o.length-1]+" ms")}e?.browserProfile&&console.profile&&console.profileEnd()}};r.getEventDispatcher()?.on(yD.u9,d),e?.browserProfile&&console.profile&&console.profile(e.browserProfileName||"timeRendering"),d()}function YD(){const e=(0,Na.getActiveViewer)();return e?(e.completeTasks(),e.getMemoryGauge().getUsageDetails()):null}function KD(e){const t=e.getError();if(t!==e.NO_ERROR){let i="Unknown: 0x"+t.toString(16);switch(t){case e.INVALID_ENUM:i="GL_INVALID_ENUM";break;case e.INVALID_VALUE:i="GL_INVALID_VALUE";break;case e.INVALID_OPERATION:i="GL_INVALID_OPERATION";break;case e.INVALID_FRAMEBUFFER_OPERATION:i="GL_INVALID_FRAMEBUFFER_OPERATION";break;case e.OUT_OF_MEMORY:i="GL_OUT_OF_MEMORY"}return ut.log.warn("GL error: "+i),!0}return!1}class jD{constructor(){this.meshIncrements=[],this.silhouetteIncrements=[],this.entityData=[],this.incrementDetails=[]}removeCrossReferences(){for(const e of this.entityData)e.setMeshIncrement(null),e.setBodyMetaData(null);for(const e of this.incrementDetails)e.increment=null}}function QD(){const e=new jD;(0,Na.getActiveViewer)().getModelViewManagers().getManager().collectComponentsForHeapDump(e),e.removeCrossReferences(),window.trackedGraphicsComponents=e;let t=0;for(let i=0;i<e.meshIncrements.length;++i)t+=e.meshIncrements[i].getTriangleCount();ut.log.info("Graphics triangle count: "+t+"\nGraphics body entity count: "+e.entityData.length)}var $D=i(52728);function JD(e){const t={angleInstancedArrays:"ANGLE_instanced_arrays",extTextureFilterAnisotropic:"EXT_texture_filter_anisotropic",oesElementIndexUint:"OES_element_index_uint",oesStandardDerivatives:"OES_standard_derivatives",oesTextureFloat:"OES_texture_float",oesTextureFloatLinear:"OES_texture_float_linear",oesTextureHalfFloat:"OES_texture_half_float",oesTextureHalfFloatLinear:"OES_texture_half_float_linear",oesVertexArrayObject:"OES_vertex_array_object",compressedTextureS3tc:"WEBGL_compressed_texture_s3tc",depthTexture:"WEBGL_depth_texture",drawBuffers:"WEBGL_draw_buffers"};let i,s={};if(e){const n=Zt(e);for(i in s=n?{vendor:n.glVendor,renderer:n.glRenderer}:{vendor:"unavailable",renderer:"unavailable"},t){const n=t[i];try{s[i]=!!e.getExtension(n)}catch(e){ut.log.warn('Web client capability - failed at "gl.getExtension" call on '+n+" -- "+e)}}}else for(i in ut.log.warn("No gl context was available when attempting to get renderer information"),s={vendor:"unsupported",renderer:"unsupported"},t)s[i]=!1;s.has3dMouse=wa(),s.screenWidth=window.screen.width,s.screenHeight=window.screen.height;const n=document.createElement("canvas");try{s.supportsWebGL2=!!n.getContext("webgl2")}catch(e){ut.log.warn("Web client capability - failed at checking supportsWebGL2 -- "+e)}n.remove(),s.devicePixelRatio=window.devicePixelRatio?window.devicePixelRatio:-1,(async()=>{if(navigator.storage?.estimate)try{const e=await navigator.storage.estimate();s.clientBrowserStorageUsed=e.usage/1048576,s.clientBrowserStorageQuota=e.quota/1048576}catch(e){ut.log.info("Error in estimating storage: "+e),s.clientBrowserStorageUsed=-1,s.clientBrowserStorageQuota=-1}else ut.log.info("Storage estimation is not supported in this browser."),s.clientBrowserStorageUsed=-1,s.clientBrowserStorageQuota=-1;if(navigator.gpu)try{s.supportsWebGPU=!!await navigator.gpu.requestAdapter()}catch(e){ut.log.warn("Web client capability - failed at checking gpu.requestAdapter -- "+e)}else s.supportsWebGPU=!1;if(window.localStorage)try{window.localStorage.setItem("webClientCapabilities",JSON.stringify(s))}catch(e){ut.log.warn("Error writing client capabilities to local storage: "+e)}})()}const eM=new xi.hF({isPickable:!1,isShowThrough:!0,isDepthTested:!1,primitiveType:Di.MX.LINES}),tM=new xi.hF({isPickable:!1,isShowThrough:!0,isDepthTested:!1,primitiveType:Di.MX.POINTS}),iM=new xi.hF({primitiveType:Di.MX.LINES,isPickable:!1,isHighlightable:!1,isTwoSided:!1,isShowThrough:!1,isDepthTested:!0}),sM=new xi.hF({primitiveType:Di.MX.LINES,isPickable:!1,isHighlightable:!1,isShowThrough:!0,isTwoSided:!0,isDepthTested:!1,isStencilTested:!0}),nM=X.default.CONSTANT_DEFAULTS,rM=X.default.getManager(),aM=rM.getStipple("CURVATURE_UV_TOOTH_STIPPLE"),oM=rM.getNumber("CURVATURE_TOOTH_LINE_WIDTH"),hM=rM.getNumber("CURVATURE_ROOF_LINE_WIDTH"),cM=rM.getStipple("CURVATURE_UV_ROOF_STIPPLE"),lM="distanceedge";class uM extends Ti.u1{constructor(e,t,i){super(i),this.startPoint=e,this.endPoint=t,this.drawDeltaP=!1,this.drawStartPointP=!1,this.drawEndPointP=!1,this.drawDistanceP=!1,this.deltaPoint=ge.S4.subtract(t,e,C.create()),this.distance=ge.S4.length(this.deltaPoint),this.distanceColor=rM.getColor("PROJECT_MEASUREMENT_DISTANCE_COLOR"),this.componentColors=[rM.getColor("X_AXIS_COLOR"),rM.getColor("Y_AXIS_COLOR"),rM.getColor("Z_AXIS_COLOR")],this.measurementStipple=rM.getStipple("PROJECT_MEASUREMENT_STIPPLE"),this.pointSize=nM.PROJECT_MEASUREMENT_POINT_SIZE,this.lineWidth=nM.PROJECT_MEASUREMENT_DISTANCE_LINE_WIDTH}onViewWillDraw(e,t){this.updateGraphics()}onAppearanceConstantsUpdated(){this.distanceColor=rM.getColor("PROJECT_MEASUREMENT_DISTANCE_COLOR"),this.componentColors=[rM.getColor("X_AXIS_COLOR"),rM.getColor("Y_AXIS_COLOR"),rM.getColor("Z_AXIS_COLOR")]}updateGraphics(){if(this.drawDistanceP||this.drawDeltaP){const e=[this.deltaPoint[0],0,0],t=[0,this.deltaPoint[1],0],i=ge.S4.add(this.startPoint,e,C.create()),s=ge.S4.add(i,t,C.create()),n=this.endPoint;if(this.drawDeltaP){const e=(0,Au.W5)(this.startPoint,i);(0,Au.Ab)(this.componentColors[0],e),(0,Au.VQ)(this.lineWidth,e),(0,Au.KZ)(this.measurementStipple,e),this.updateMeshIncrement("xedge",Ti.ZJ,e,eM);const t=(0,Au.W5)(i,s);(0,Au.Ab)(this.componentColors[1],t),(0,Au.VQ)(this.lineWidth,t),(0,Au.KZ)(this.measurementStipple,t),this.updateMeshIncrement("yedge",Ti.ZJ,t,eM);const r=(0,Au.W5)(s,n);(0,Au.Ab)(this.componentColors[2],r),(0,Au.VQ)(this.lineWidth,r),(0,Au.KZ)(this.measurementStipple,r),this.updateMeshIncrement("zedge",Ti.ZJ,r,eM)}if(this.drawDistanceP){const e=(0,Au.W5)(this.startPoint,this.endPoint);(0,Au.Ab)(this.distanceColor,e),(0,Au.VQ)(this.lineWidth,e),(0,Au.KZ)(this.measurementStipple,e),this.updateMeshIncrement(lM,Ti.ZJ,e,eM)}}else if(this.drawStartPointP&&this.startPoint){const e=(0,Au.Pu)(this.startPoint,"startPoint",this.distanceColor,this.pointSize);this.updateMeshIncrement("point0",Ti.ZJ,e,tM)}else if(this.drawEndPointP&&this.endPoint){const e=(0,Au.Pu)(this.endPoint,"endPoint",this.distanceColor,this.pointSize);this.updateMeshIncrement("point1",Ti.ZJ,e,tM)}}setPermanentlyHighlightDistance(e){this.permanentlyHighlightDistance=e}drawNothing(){this.removeMeshIncrements(),this.drawDeltaP=!1,this.drawStartPointP=!1,this.drawEndPointP=!1,this.permanentlyHighlightDistance?this.drawDistanceP=!0:this.drawDistanceP=!1,this.viewer.requestDraw()}drawDelta(){this.removeMeshIncrements(),this.drawDeltaP=!0,this.drawStartPointP=!1,this.drawEndPointP=!1,this.permanentlyHighlightDistance?this.drawDistanceP=!0:this.drawDistanceP=!1,this.viewer.requestDraw()}drawStartPoint(){this.removeMeshIncrements(),this.drawDeltaP=!1,this.drawStartPointP=!0,this.drawEndPointP=!1,this.permanentlyHighlightDistance?this.drawDistanceP=!0:this.drawDistanceP=!1,this.viewer.requestDraw()}drawEndPoint(){this.removeMeshIncrements(),this.drawDeltaP=!1,this.drawStartPointP=!1,this.drawEndPointP=!0,this.permanentlyHighlightDistance?this.drawDistanceP=!0:this.drawDistanceP=!1,this.viewer.requestDraw()}drawDistance(){this.removeMeshIncrements(),this.drawDeltaP=!1,this.drawStartPointP=!1,this.drawEndPointP=!1,this.drawDistanceP=!0,this.viewer.requestDraw()}drawAngle(){}drawComb(){}callMethod(e){switch(e){case"drawAngle":this.drawAngle();break;case"drawComb":this.drawComb();break;case"drawDistance":this.drawDistance();break;case"drawDelta":this.drawDelta();break;case"drawStartPoint":this.drawStartPoint();break;case"drawEndPoint":this.drawEndPoint();break;default:this.drawNothing()}}getValue(){return this.distance}getDeltaPoint(){return this.deltaPoint}getStartPoint(){return this.startPoint}getEndPoint(){return this.endPoint}}class dM extends uM{constructor(e,t,i,s,n,r,a){super(e,t,a),this.startVector=i,this.endVector=s,this.angle=r,this.isInvalid=!1,this.drawAngleP=!1,this.startLength=ge.S4.length(i),this.startDir=ge.S4.normalize(i,C.create()),this.endLength=ge.S4.length(s),this.endDir=ge.S4.normalize(s,C.create()),this.normalDir=n,this.angleColor=rM.getColor("PROJECT_MEASUREMENT_ANGLE_COLOR"),this.angleLineWidth=nM.PROJECT_MEASUREMENT_ANGLE_LINE_WIDTH,this.measurementStipple=rM.getStipple("PROJECT_MEASUREMENT_STIPPLE")}onAppearanceConstantsUpdated(){this.angleColor=rM.getColor("PROJECT_MEASUREMENT_ANGLE_COLOR"),super.onAppearanceConstantsUpdated()}getValue(){return this.angle}updateGraphics(){if(this.drawAngleP){const e=50,t=(0,Au.W5)(this.getStartPoint(),this.getEndPoint());(0,Au.Ab)(this.distanceColor,t),(0,Au.VQ)(this.lineWidth,t),(0,Au.KZ)(this.measurementStipple,t),this.updateMeshIncrement(lM,Ti.ZJ,t,eM);const i=ge.S4.add(this.getStartPoint(),this.startVector,C.create()),s=ge.S4.add(this.getStartPoint(),this.endVector,C.create()),n=ge.S4.add(this.getEndPoint(),this.startVector,C.create()),r=ge.S4.add(this.getEndPoint(),this.endVector,C.create()),a=(0,Au.W5)(this.getStartPoint(),i);(0,Au.Ab)(this.angleColor,a),(0,Au.VQ)(this.angleLineWidth,a),this.updateMeshIncrement("edge00",Ti.ZJ,a,eM);const o=(0,Au.W5)(this.getStartPoint(),s);(0,Au.Ab)(this.angleColor,o),(0,Au.VQ)(this.angleLineWidth,o),(0,Au.KZ)(rM.getStipple("PROJECT_MEASUREMENT_STIPPLE"),o),this.updateMeshIncrement("edge01",Ti.ZJ,o,eM);const h=(this.startLength+this.endLength)/4,c=(0,Au.QV)(this.getStartPoint(),h,this.normalDir,this.startDir,0,this.angle,e);(0,Au.Ab)(this.angleColor,c),(0,Au.VQ)(this.angleLineWidth,c),this.updateMeshIncrement("arc0",Ti.ZJ,c,eM);const l=(0,Au.W5)(this.getEndPoint(),n);(0,Au.Ab)(this.angleColor,l),(0,Au.VQ)(this.angleLineWidth,l),(0,Au.KZ)(rM.getStipple("PROJECT_MEASUREMENT_STIPPLE"),l),this.updateMeshIncrement("edge10",Ti.ZJ,l,eM);const u=(0,Au.W5)(this.getEndPoint(),r);(0,Au.Ab)(this.angleColor,u),(0,Au.VQ)(this.angleLineWidth,u),this.updateMeshIncrement("edge11",Ti.ZJ,u,eM);const d=(0,Au.QV)(this.getEndPoint(),h,this.normalDir,this.startDir,0,this.angle,e);(0,Au.Ab)(this.angleColor,d),(0,Au.VQ)(this.angleLineWidth,d),this.updateMeshIncrement("arc1",Ti.ZJ,d,eM)}}drawNothing(){this.removeMeshIncrements(),this.drawAngleP=!1,(0,Fs.vm)()}drawAngle(){this.removeMeshIncrements(),this.drawAngleP=!0,(0,Fs.vm)()}drawDistance(){}drawDelta(){}drawStartPoint(){}drawEndPoint(){}}class gM extends uM{constructor(e,t,i,s,n,r){super(e[0],e[0],r),this.isInvalid=!1,this.drawCombP=!1,this.combIndex=0,this.oversampling=1,this.points=e,this.normals=t,this.lengths=i,this.combIndex=s,this.oversampling=n}getValue(){return 0}updateGraphics(){if(this.drawCombP){const e=this.points.length,t=[],i=[],s=[];for(let s=0;s<e;s++){const e=C.create();ge.S4.linComb(this.points[s],1,this.normals[s],this.lengths[s],e),i.push(e),s%this.oversampling||t.push(this.points[s],e)}for(let t=1;t<e;t++)s.push(i[t-1]),s.push(i[t]);const n=(0,Au.pf)(t,"comb",rM.getColor(this.combIndex?"PROJECT_MEASUREMENT_CURVATURE_COLOR_2":"PROJECT_MEASUREMENT_CURVATURE_COLOR_1"),oM);this.updateMeshIncrement("combIncrement",Ti.ZJ,n,iM);const r=(0,Au.pf)(t,"stippledComb",rM.getColor(this.combIndex?"PROJECT_MEASUREMENT_CURVATURE_COLOR_2":"PROJECT_MEASUREMENT_CURVATURE_COLOR_1"),oM,aM);this.updateMeshIncrement("stippledCombIncrement",Ti.ZJ,r,sM);const a=(0,Au.pf)(s,"spine",rM.getColor(this.combIndex?"PROJECT_MEASUREMENT_CURVATURE_COLOR_2":"PROJECT_MEASUREMENT_CURVATURE_COLOR_1"),hM);this.updateMeshIncrement("spineCombIncrement",Ti.ZJ,a,iM);const o=(0,Au.pf)(s,"stippledSpine",rM.getColor(this.combIndex?"PROJECT_MEASUREMENT_CURVATURE_COLOR_2":"PROJECT_MEASUREMENT_CURVATURE_COLOR_1"),hM,cM);this.updateMeshIncrement("stippledSpineIncrement",Ti.ZJ,o,sM)}}drawNothing(){this.removeMeshIncrements(),this.drawCombP=!1,(0,Fs.vm)()}drawComb(){this.removeMeshIncrements(),this.drawCombP=!0,(0,Fs.vm)()}drawDistance(){}drawDelta(){}drawStartPoint(){}drawEndPoint(){}}var pM=i(67777);const mM=X.default.getManager(),fM=new xi.hF({isPickable:!0,isTwoSided:!0,isStencilWritten:!1,primitivesHaveTransparency:!0,primitiveType:Di.MX.LINES,material:bi,includedInBlend:!0}),IM=new xi.hF({isPickable:!0,isTwoSided:!0,isTintedByCompare:!0,primitiveType:Di.MX.LINES,includedInBlend:!0}),EM=C.create(),SM=C.create(),TM=C.create();var DM;!function(e){e.TOP_LEFT="TOP_LEFT",e.TOP_RIGHT="TOP_RIGHT",e.BOTTOM_LEFT="BOTTOM_LEFT",e.BOTTOM_RIGHT="BOTTOM_RIGHT"}(DM||(DM={}));const MM=new xi.hF({isPickable:!0,primitiveType:Di.MX.TRIANGLES,primitivesHaveTransparency:!0,material:bi,isTwoSided:!0,includedInBlend:!0,isTintedByCompare:!0,zOffset:X.default.getManager().getNumber("CPLANE_Z_OFFSET")});function CM(e){const t=e.getProperties().id;return t===MM.id||t===IM.id||t===fM.id}const yM="quadFace",PM="outline";class AM extends Ti.u1{constructor(e,t,i,s,n){super(n,i),this.textColorName=e,this.entityId=t,this.planeId=s,this.name="",this.center=C.create(),this.centerOffset=C.create(),this.xAxis=C.fromValues(1,0,0),this.yAxis=C.fromValues(0,1,0),this.lastSetAppearance=void 0,this.node=null,this.width=0,this.height=0,this.initialWidth=0,this.initialHeight=0,this.increments={},this.lastTextScale=-1,this.textTexture=null,this.resizeManipulators={},this.usage=i===Zo.Vv?fs.L.PREVIEW:fs.L.BASE,this.textMaterial=Fi(),this.textNodeProperties=new xi.hF({isPickable:!1,isTwoSided:!0,primitiveType:Di.MX.TRIANGLES,material:this.textMaterial,includedInBlend:!0}),this.occurrenceData.setCanIsolateChange(!0),this.occurrenceData.setIsolated(!1)}getDebugId(){return"ConstructionPlaneDisplay"}onDevicePixelRatioChanged(e){this.destroyText()}remove(){this.destroyText(),this.textMaterial&&(this.textMaterial.destroy(),this.textMaterial=null),this.removeResizeManipulators(),super.remove()}destroyText(){this.textTexture&&(this.textTexture.destroy(),this.textTexture=null)}setName(e){e=(0,un.truncate)(e,32),this.name!==e&&(this.destroyText(),(0,Fs.vm)()),this.name=e}updateAppearance(e){if(e&&e instanceof k.yVM){if(this.lastSetAppearance&&this.lastSetAppearance.equals(e))return;this.lastSetAppearance=e.clone(),this.width=e.width,this.height=e.height}else{if(null===this.lastSetAppearance)return;this.lastSetAppearance=null,this.width=this.initialWidth,this.height=this.initialHeight,this.centerOffset=[0,0,0]}this.updateDefinition(this.name,this.center,this.xAxis,this.yAxis,!0,!0),(0,Fs.vm)()}updateDefinition(e,t,i,s,n,r){if(this.name===e&&C.equals(t,this.center)&&C.equals(i,this.xAxis)&&C.equals(s,this.yAxis)||(this.destroyText(),(0,Fs.vm)()),0!==this.initialWidth||0!==this.initialHeight||C.equals(i,this.xAxis)||C.equals(s,this.yAxis)||(this.initialWidth=2*ge.S4.length(i),this.initialHeight=2*ge.S4.length(s)),this.width>0&&this.height>0&&(i=ge.S4.scale(ge.S4.normalize(i,C.create()),this.width/2,C.create()),s=ge.S4.scale(ge.S4.normalize(s,C.create()),this.height/2,C.create())),this.setName(e),this.center=t,this.xAxis=i,this.yAxis=s,Rs()?n&&this.updateResizeManipulators(!1):this.removeResizeManipulators(),this.lastSetAppearance&&(!n||r)){const e=ge.S4.normalize(ge.S4.cross(this.xAxis,this.yAxis,C.create()),C.create());this.centerOffset=ge.S4.subtract((0,yi.qm)([this.lastSetAppearance.xOffset,this.lastSetAppearance.yOffset],this.center,e,ge.S4.normalize(this.xAxis,C.create())),this.center,C.create())}this.updatePlaneGraphics(),this.updateResizeManipulators(!1),this.isHidden&&this.hideIncrements()}updateResizeManipulators(e){const t=this,i=function(i,s,n){const r=ge.S4.add(t.center,t.centerOffset,C.create()),a=ge.S4.normalize(ge.S4.cross(t.xAxis,t.yAxis,C.create())),o=ge.S4.scale(t.xAxis,s,C.create()),h=ge.S4.scale(t.yAxis,n,C.create()),c=ge.S4.add(ge.S4.add(r,o,C.create()),h,C.create());t.resizeManipulators[i]?t.resizeManipulators[i].updateDefinition(c,a,o,h):e&&(t.resizeManipulators[i]=new bM(i,c,a,t,o,h,t.viewer))};i(DM.TOP_LEFT,-1,1),i(DM.TOP_RIGHT,1,1),i(DM.BOTTOM_LEFT,-1,-1),i(DM.BOTTOM_RIGHT,1,-1)}removeResizeManipulators(){for(const e in this.resizeManipulators){const t=this.resizeManipulators[e];t&&(t.cleanup(),t.remove()),this.resizeManipulators[e]=null}}updateText(e){const t=this.getTextTexture(),i=ge.S4.add(this.center,this.centerOffset,C.create()),s=ge.S4.add(i,ge.S4.scale(this.xAxis,-1,C.create()),C.create());ge.S4.add(s,this.yAxis);const n=e.getPixelSizeAtWorldPoint(this.transformPoint(s));let r=n*t.filledWidthPx,a=n*t.filledHeightPx,o=Math.min(ge.S4.length(this.xAxis)/r,ge.S4.length(this.yAxis)/a);if(o<0&&(o=0),o<1&&(r*=o,a*=o),Math.abs(this.lastTextScale-o)<=Ci.W.ZERO_LENGTH)return;this.lastTextScale=o;const h=ge.S4.normalize(this.xAxis,C.create()),c=ge.S4.normalize(this.yAxis,C.create()),l=ge.S4.add(s,ge.S4.scale(c,-a,C.create()),C.create()),u=ge.S4.add(l,ge.S4.scale(h,r,C.create()),C.create()),d=ge.S4.add(l,ge.S4.scale(c,a,C.create()),C.create());this.updateMeshIncrement("quad",Ti.ZJ,(0,Au.fQ)(l,u,d,void 0,[t.leftCoordinate,t.bottomCoordinate],[t.rightCoordinate,t.topCoordinate]),this.textNodeProperties),this.textMaterial.ambientTexture=t}updatePlaneGraphics(){const e=ge.S4.add(this.center,this.centerOffset,C.create()),t=X.default.getManager(),i=t.getColor("CONSTRUCTION_PLANE_OUTLINE_COLOR"),s=t.getNumber("CONSTRUCTION_PLANE_OUTLINE_WIDTH"),n=(0,Au.PU)(e,this.xAxis,this.yAxis,i,s),r=ws()?IM:fM;this.updateMeshIncrement(PM,PM,n,r),this.increments[PM]=n;const a=ge.S4.add(ge.S4.add(e,ge.S4.scale(this.xAxis,-1,C.create()),C.create()),this.yAxis,C.create()),o=ge.S4.add(ge.S4.add(e,ge.S4.scale(this.xAxis,-1,C.create()),C.create()),ge.S4.scale(this.yAxis,-1,C.create()),C.create()),h=ge.S4.add(ge.S4.add(e,this.xAxis,C.create()),ge.S4.scale(this.yAxis,-1,C.create()),C.create()),c=(0,Au.fQ)(o,h,a);let l;if(ws()){const e=ge.S4.cross(this.xAxis,this.yAxis,C.create()),t=(0,Au.X)(this.center,e);(0,Au.FT)(t,c)}else{l=t.getColor("CONSTRUCTION_PLANE_AMBIENT_COLOR").slice(0),l[3]=t.getNumber("CONSTRUCTION_PLANE_OPACITY"),(0,Au.Ab)(l,c)}this.increments[yM]=c,this.updateMeshIncrement(yM,yM,c,MM),this.invalidateTextGraphics()}getIncrement(e){return e&&this.increments[e]?this.increments[e].clone():this.increments[yM]?this.increments[yM].clone():null}getBounds(){const e=new yi.kB,t=ge.S4.add(this.center,this.centerOffset,EM);for(let i=-1;i<=1;i+=2)for(let s=-1;s<=1;s+=2){const n=ge.S4.add(ge.S4.add(ge.S4.scale(this.xAxis,i,SM),ge.S4.scale(this.yAxis,s,TM)),t);e.addPoint(n)}return e}invalidateTextGraphics(){this.lastTextScale=-1}getTextTexture(){return this.textTexture||(this.textTexture=_o(this.viewer,this.name,{color:mM.getColor(this.textColorName),font:mM.getString("PLANE_TEXT_FONT"),size:mM.getNumber("PLANE_TEXT_HEIGHT_PX"),paddingWithinBorder:mM.getNumber("PLANE_TEXT_BACKGROUND_PADDING")}),this.invalidateTextGraphics()),this.textTexture}onViewWillDraw(e,t){this.isHidden||this.name&&this.updateText(e)}canPickThrough(){return!0}getModelSelection(e){const t=e.uiElement.getUsage(),i=(0,Ce.cF)(this.entityId,void 0,t);return i&&(i.sourcePick=e.sourcePick,i.secondarySelectionData={isFromPlaneEdge:e.selectionId===PM}),i}getPickPriority(e){return e.selectionId===PM?qm.z.CONSTRUCTION_PLANE_EDGE:qm.z.CONSTRUCTION_PLANE}getUsage(){return this.usage}addHighlight(e){this.addHighlightToIncrement(PM,e),this.addHighlightToIncrement(yM,e),e.type!==dn.o2.ENTITY&&e.type!==dn.o2.FEATURE||!Rs()||this.isHidden||this.updateResizeManipulators(!0),(0,Fs.vm)()}removeHighlight(e){return this.removeHighlightFromIncrement(PM,e),this.removeHighlightFromIncrement(yM,e),e.type!==dn.o2.ENTITY&&e.type!==dn.o2.FEATURE||this.removeResizeManipulators(),(0,Fs.vm)(),!0}cloneForPreview(){const e=ws()?"CONSTRUCTION_PLANE_COMPARE_TEXT_COLOR":"CONSTRUCTION_PLANE_TEXT_COLOR",t=new AM(e,this.entityId,Zo.Vv,this.planeId,this.viewer);return t.width=this.width,t.height=this.height,t.centerOffset=this.centerOffset,t.setName(this.name),t.updatePlaneGraphics(),t}isInteractionEnabled(){return!1}getCenter(){return C.fromValues(this.center[0],this.center[1],this.center[2])}getXAxis(){return C.fromValues(this.xAxis[0],this.xAxis[1],this.xAxis[2])}getYAxis(){return C.fromValues(this.yAxis[0],this.yAxis[1],this.yAxis[2])}getName(){return this.name}onAppearanceConstantsUpdated(){this.destroyText(),this.updatePlaneGraphics()}}const OM=X.default.getManager(),vM=1e-6,RM=500,wM="move",_M=new xi.hF({primitiveType:Di.MX.TRIANGLES,material:bi,zOffset:2,isTwoSided:!0,includedInBlend:!1,primitivesHaveTransparency:!0,isShowThrough:!0,isDepthTested:!1,addsToBounds:!1}),NM=new xi.hF({primitiveType:Di.MX.TRIANGLE_STRIP,material:bi,zOffset:2,isTwoSided:!0,includedInBlend:!1,primitivesHaveTransparency:!0,isShowThrough:!0,isDepthTested:!1,addsToBounds:!1});class bM extends Ti.u1{constructor(e,t,i,s,n,r,a){super(a,s.usage===fs.L.BASE?Zo.lL:Zo.Vv),this.highlighted=!1,this.dragOffset=[0,0],this.resizeUniformly=!1,this.cursorString="",this.staticIncrements=null,this.center=t,this.normal=i,this.direction0=n,this.direction1=r,this.offset=Q.create(),this.parent=s,this.selectionId=e,this.listenTo(this,Ti.zw.MOUSE_ENTER+this.selectionId,this.onMouseEnter),this.listenTo(this,Ti.zw.MOUSE_LEAVE+this.selectionId,this.onMouseLeave),this.listenTo(this,Ti.zw.DRAG_START+this.selectionId,this.onDragStart),this.listenTo(this,Ti.zw.DRAG+this.selectionId,this.onDrag),this.listenTo(this,Ti.zw.DRAG_STOP+this.selectionId,this.onDragStop)}onViewWillDraw(e,t){this.updateTransform(e),this.hasMeshIncrements()||this.updateGraphics()}onAppearanceConstantsUpdated(){this.removeMeshIncrements(),this.staticIncrements=null}updateTransform(e){const t=de.create(),i=C.fromValues(this.center[0],this.center[1],this.center[2]),s=(ge.S4.length(this.parent.getXAxis())+ge.S4.length(this.parent.getYAxis()))/2,n=Math.min(e.getPixelSizeAtWorldPoint(this.transformPoint(i)),s/16),r=(0,Ji.x_)();t[0]=n*r,t[5]=n*r,t[10]=n*r,t[12]=this.center[0],t[13]=this.center[1],t[14]=this.center[2],this.setTransform(t)}getClearModelSelectionsOnPrehilite(){return!1}getStaticIncrements(){if(this.staticIncrements)return this.staticIncrements;this.staticIncrements={};const e=[0,0,0],t=ge.S4.normalize(this.direction0,C.create()),i=OM.getNumber("RESIZE_MANIPULATOR_RADIUS"),s=this.selectionId+"FrontFace",n=(0,Au.$)(e,i,this.normal,36);this.staticIncrements[s]={selection:this.selectionId,data:n,type:_M,color:OM.getColor("RESIZE_MANIPULATOR_INNER_COLOR")};const r=this.selectionId+"Border",a=(0,Au.I$)(e,i,1.3*i,this.normal,t,0,2*Math.PI,36);return this.staticIncrements[r]={selection:this.selectionId,data:a,type:NM,color:OM.getColor("RESIZE_MANIPULATOR_OUTER_COLOR")},this.staticIncrements}updateGraphics(){this.updateIncrementsOnEntity(this.selectionId,"FrontFace"),this.updateIncrementsOnEntity(this.selectionId,"Border")}updateIncrementsOnEntity(e,t){const i=this,s=this.getStaticIncrements();s[e+t].type===_M?(0,Au.Ab)(s[e+t].color,s[e+t].data):s[e+t].type===NM&&(0,Au.Ab)(i.highlighted?OM.getColor("RESIZE_MANIPULATOR_OUTER_COLOR_HIGHLIGHT"):s[e+t].color,s[e+t].data),this.updateMeshIncrement(e+t,s[e+t].selection,s[e+t].data.clone(),s[e+t].type)}cleanup(){this.cursorString===wM&&(this.cursorString="",this.viewer.popCursor())}updateDefinition(e,t,i,s){this.staticIncrements=null,this.center=e,this.normal=ge.S4.normalize(t,C.create()),this.direction0=ge.S4.normalize(i,C.create()),this.direction1=ge.S4.normalize(s,C.create()),this.updateGraphics()}onMouseEnter(e,t){this.highlighted=!0,0===this.cursorString.length&&(this.cursorString=wM,this.viewer.pushCursor(this.cursorString)),this.updateGraphics(),(0,Fs.vm)()}onMouseLeave(e,t){this.highlighted&&(this.highlighted=!1,this.updateGraphics()),this.cursorString===wM&&(this.cursorString="",this.viewer.popCursor()),(0,Fs.vm)()}getOffsetFromEvent(e){const t=e.camera.getRay(e.mouseX,e.mouseY),i=C.create(),s=this.normal,n=y.fromValues(s[0],s[1],s[2],-C.dot(s,this.center)),r=(0,yi.fE)(t,n);if(null===r)return null;return[C.dot(ge.S4.subtract(r,this.center,i),this.direction0),C.dot(ge.S4.subtract(r,this.center,i),this.direction1)]}onDragStart(e,t,i){const s=this.getOffsetFromEvent(t);s&&(this.dragOffset=ge.gv.subtract(s,this.offset,Q.create()),i.requestDrag=!0,this.resizeUniformly=this.viewer.getLastMouseMovedEvent().shiftKey)}onDrag(e,t){const i=this.getOffsetFromEvent(t);if(!i)return;this.offset=ge.gv.subtract(i,this.dragOffset,Q.create());for(let e=0;e<this.offset.length;e++)this.offset[e]=parseFloat(this.offset[e].toFixed(8));let s,n,r=0,a=0;this.resizeUniformly?(s=2*ge.S4.length(this.parent.getXAxis())+2*this.offset[0],n=2*ge.S4.length(this.parent.getYAxis())+2*this.offset[1],s>vM&&s<RM&&(this.parent.width=s),n>vM&&n<RM&&(this.parent.height=n)):(s=2*ge.S4.length(this.parent.getXAxis())+1*this.offset[0],n=2*ge.S4.length(this.parent.getYAxis())+1*this.offset[1],s>vM&&s<RM&&(this.parent.width=s,r=this.offset[0]/2*C.dot(this.direction0,ge.S4.normalize(this.parent.getXAxis(),C.create()))),n>vM&&n<RM&&(this.parent.height=n,a=this.offset[1]/2*C.dot(this.direction1,ge.S4.normalize(this.parent.getYAxis(),C.create()))),this.parent.centerOffset=ge.S4.subtract(ge.S4.add(this.parent.centerOffset,(0,yi.qm)([r,a],this.parent.getCenter(),this.normal,ge.S4.normalize(this.parent.getXAxis(),C.create())),C.create()),this.parent.getCenter(),C.create())),this.parent.updateDefinition(this.parent.getName(),this.parent.getCenter(),this.parent.getXAxis(),this.parent.getYAxis(),!0),(0,Fs.vm)()}onDragStop(e,t){const i=new k.yVM;i.width=this.parent.width,i.height=this.parent.height;const s=(0,yi.LK)(ge.S4.add(this.parent.centerOffset,this.parent.getCenter(),C.create()),this.parent.getCenter(),this.normal,ge.S4.normalize(this.parent.getXAxis(),C.create()));i.xOffset=s[0],i.yOffset=s[1],this.viewer.getEventDispatcher().trigger(yD.P1,i,this.parent.planeId),this.offset=[0,0]}}class LM extends m.T{constructor(e,t){super(),this.isEnabled=!1,this.selectionList=new Ce.nZ(LM.SELECTION_LIST_NAME),(0,Jo.Yk)(e),this.graphicsViewer=e,this.highlightFilterFunction=t}getIsEnabled(){return this.isEnabled}enable(){this.isEnabled=!0,this.setupHandlers(),this.updateSetOfFilteredEntities(),this.stopListening(),this.listenTo(this.graphicsViewer.getEventDispatcher(),yD.cy,this.updateSetOfFilteredEntities),this.latestDisplayDataUsageSubscription=ys().latestDisplayDataUsageChangedObservable.subscribe((()=>this.updateSetOfFilteredEntities())),this.graphicsViewer.onLaminarEdgesChanged(!0)}disable(){this.isEnabled&&(this.isEnabled=!1,this.removeHandlers(),this.stopListening(),this.latestDisplayDataUsageSubscription.unsubscribe(),this.clearSelections(),this.graphicsViewer.onLaminarEdgesChanged(!1))}setupHandlers(){this.graphicsViewer.getModelViewManagers().getManager().handleSelectionListHighlights(LM.SELECTION_LIST_NAME,this.selectionList,dn.o2.FILTERED_ENTITIES);const e=(0,j.as)(th,this.graphicsViewer.getModelViewManagers().getPreviewManager());e?.handleSelectionListHighlights(LM.SELECTION_LIST_NAME,this.selectionList,dn.o2.FILTERED_ENTITIES)}removeHandlers(){this.graphicsViewer.getModelViewManagers().getManager().removeSelectionListHandler(LM.SELECTION_LIST_NAME);const e=(0,j.as)(th,this.graphicsViewer.getModelViewManagers().getPreviewManager());e?.removeSelectionListHandler(LM.SELECTION_LIST_NAME)}clearSelections(){this.selectionList.reset()}getSelectionList(){return this.selectionList}updateSetOfFilteredEntities(){this.clearSelections();const e=this.graphicsViewer.getModelViewManagers().getManager();this.updateHighlightsForPartStudio((0,j.as)(xd,e.getDisplayedPartStudio()));const t=(0,j.as)(th,this.graphicsViewer.getModelViewManagers().getPreviewManager());t&&this.updateHighlightsForPartStudio(t.getDisplayedPartStudio())}updateHighlightsForPartStudio(e){if(!e)return;const t=e.getFilteredEntityIds(this.highlightFilterFunction),i=!this.graphicsViewer.getIsolatedOccurrenceManager()?.isInIsolateOrMakeTransparentMode(),s=e.getBodyComponent();for(let n=0;n<t.length;++n){const r=(0,Ce.cF)(t[n],null,e.usage);r&&e.getBodyVisibility(r.getBodyId())===Fs.EE.VISIBLE&&(i||s.isBodyIsolated(Jf.KF,r.getBodyId()))&&this.selectionList.add(r)}}}LM.SELECTION_LIST_NAME="filteredEntitiesList";var FM=i(35692),xM=i(32775);class BM{constructor(e){this.viewer=e,this.supportedSessionTypes=new Set,this.activeSessionType=null,this.startingSession=!1,this.animationFrameCallback=null,this.overrideCamera=new ch,this.modelViewInitialized=!1,this.modelTransform_=de.create(),this.modelTransformInverse_=de.create(),this.orderIndependentTransparencyEnabledOutsideXr=!0,this.xrInputDispatcher=new jM(this.viewer,this),this.xrSelectionHandler=new tC(this.viewer),this.xrInputDispatcher.addSelectHandler(this.xrSelectionHandler),this.xrInputDispatcher.addGamepadButtonHandler(this),this.xrViewController=new lC(e,this.xrInputDispatcher),this.xrMarkupController=new eC(e,this.xrInputDispatcher),this.xrCommentController=new UM(e,this.xrInputDispatcher),this.animationFrameCallback=(e,t)=>this.onAnimationFrame(e,t),Ki.Jq.CapabilitiesService.isWebxrEnabled().then((t=>{if(!t)return;const i=hC();i&&(i.isSessionSupported("immersive-vr").then((e=>{e&&this.supportedSessionTypes.add(xM.$.VR)})),i.isSessionSupported("immersive-ar").then((e=>{e&&this.supportedSessionTypes.add(xM.$.AR)}))),this.xrBaseFrameBuffer=new xo(e)}))}getSupportedSessionTypes(){return this.supportedSessionTypes}getActiveSessionType(){return this.activeSessionType}get xrReferenceSpace(){return this.xrReferenceSpace_}set modelTransform(e){this.modelTransform_=e,de.invert(this.modelTransformInverse_,e),this.xrInputDisplay&&this.xrInputDisplay.onModelTransformChange(this.modelTransformInverse_)}get modelTransform(){return this.modelTransform_}get modelTransformInverse(){return this.modelTransformInverse_}startXr(e){if(this.startingSession)return void ut.log.info("Attempt to start xr while session start was already pending");if(this.xrSession)throw new Error("XR session already in progress");if(!e)throw new Error("Invalid XrSessionType "+e);if(!this.supportedSessionTypes.has(e))throw new Error("Attempt to start unsuppported XrSessionType "+e);const t=this.viewer.getGlContext();t?.makeXRCompatible?(this.modelViewInitialized=!1,this.startingSession=!0,this.xrCommentController.checkMicrophonePermission().finally((()=>{t.makeXRCompatible().then((()=>this.startXrSession(e))).catch((e=>{ut.log.warn("Error making context xr compatible: "+e)})).finally((()=>{this.startingSession=!1}))}))):ut.log.warn("Could not make XR compatible context")}startXrSession(e){const t=hC();t?t.requestSession(e).then((t=>(this.activeSessionType=e,this.xrSession=t,this.xrInputDispatcher.setXrSession(this.xrSession),(0,dt.isPlatformMetaQuest)()&&this.reduceDetailForSession(),this.xrSession.updateRenderState({baseLayer:new XRWebGLLayer(this.xrSession,this.viewer.getGlContext())})))).then((()=>{this.startXrRendering()})).catch((e=>{ut.log.warn("Failed to create xr session: "+e)})):ut.log.warn("Could not get xr system")}stopXr(){this.xrSession&&((0,dt.isPlatformMetaQuest)()&&this.restoreNonXrDetail(),this.xrInputDispatcher.resetXrSession(),this.xrSession.end().catch((e=>{ut.log.debug("XR session end failed: "+e)})).finally((()=>{this.viewer.viewManipulator.show(),this.viewer.forceRequestDraw()})),this.modelTransform=de.identity(de.create()),this.removeInputDisplay(),this.xrMarkupController.clearMarkup(),FM(".exit-xr-button").remove(),this.xrSession=null,this.activeSessionType=null,this.viewer.getAnimationController().requestAnimationFrameIfNeeded())}getIsXrRunning(){return!!this.xrSession}getXrInputDispatcher(){return this.xrInputDispatcher}startXrRendering(){this.xrSession?.requestReferenceSpace("local").then((e=>{this.xrReferenceSpace_=e,this.lastXrFrameTimeMs=(0,Fs.Wj)(),this.xrSession?.requestAnimationFrame(this.animationFrameCallback);const t=this.activeSessionType===xM.$.AR?i18n("Exit AR"):i18n("Exit VR");FM(`<button class="btn btn-default exit-xr-button" type="button">${t}</button>`).appendTo(".canvas-container").click((()=>{this.stopXr()}))})).catch((e=>{ut.log.warn("Failed to get xr reference space: "+e)}))}onAnimationFrame(e,t){if(!this.xrSession)return;this.updateInput(t),this.viewer.setInRequestDrawCallback(!0);const i=t.getViewerPose(this.xrReferenceSpace_);if(!i)return ut.log.debug("No pose found for device"),void this.xrSession.requestAnimationFrame(this.animationFrameCallback);const s=this.xrSession?.renderState?.baseLayer;if(!s)return;this.viewer.setSystemIsAnimating(),this.viewer.getAnimationController().advanceAnimation(e);const n=this.viewer.getGlContext();if(!n)return;n.bindFramebuffer(n.FRAMEBUFFER,s.framebuffer),this.xrBaseFrameBuffer.setExternalFrameBuffer(this.getFrameBufferWidth(),this.getFrameBufferHeight(),s.framebuffer),this.viewer.setBaseFrameBuffer(this.xrBaseFrameBuffer),this.activeSessionType===xM.$.VR&&(n.clearColor(1,1,1,1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT|n.STENCIL_BUFFER_BIT));for(let e=0;e<i.views.length;++e){const t=i.views[e];this.overrideCamera.setTransforms(this.modelTransform_,t.transform.inverse.matrix,t.projectionMatrix),this.lastXrViewMatrixInverse=de.copy(de.create(),t.transform.inverse.matrix),this.initializeModelView();const n=s.getViewport(t);this.overrideCamera.setViewport([n.x,n.y,n.width,n.height]);const r=null;this.viewer.draw(r,{camera:this.overrideCamera,performFrameTiming:0===e}),this.imageCaptureSuccessCallback&&"right"===t.eye&&this.performImageCapture(n)}const r=(0,Fs.Wj)();r-this.lastXrFrameTimeMs>=5e3&&(ut.log.debug("XR frame rate: "+this.viewer.getFrameTimer().getAverageFrameRate(is.QpP.INTERACTIVE)+" fps"),this.lastXrFrameTimeMs=r),n.bindFramebuffer(n.FRAMEBUFFER,null),this.viewer.setBaseFrameBufferToDefault(),this.viewer.setInRequestDrawCallback(!1),this.xrSession.requestAnimationFrame(this.animationFrameCallback)}getCamera(){return this.overrideCamera}captureViewportImage(){return new Promise(((e,t)=>{this.imageCaptureSuccessCallback=e,this.imageCaptureErrorCallback=t}))}performImageCapture(e){const t=this.viewer.getGlContext();if(!this.imageCaptureSuccessCallback||!t)return;const i=X.default.getManager().getNumber("XR_COMMENT_VIEW_CAPTURE_PROPORTION"),s=Math.floor(e.width*i),n=Math.floor(e.height*i),r=e.x+Math.floor(s/2),a=e.y+Math.floor(n/2),o=new Uint8Array(s*n*4);t.readPixels(r,a,s,n,t.RGBA,t.UNSIGNED_BYTE,o),(0,Fs.Dy)(o,s,n),this.imageCaptureSuccessCallback({width:s,height:n,data:o}),this.imageCaptureSuccessCallback=null,this.imageCaptureErrorCallback=null}getFrameBufferWidth(){return this.xrSession?.renderState&&this.xrSession.renderState.baseLayer?this.xrSession.renderState.baseLayer.framebufferWidth:null}getFrameBufferHeight(){return this.xrSession?.renderState&&this.xrSession.renderState.baseLayer?this.xrSession.renderState.baseLayer.framebufferHeight:null}initializeModelView(){this.modelViewInitialized||(this.viewer.viewManipulator.hide(),this.xrViewController.initializeModelView(this.overrideCamera),this.modelViewInitialized=!0)}updateInput(e){const t=this.xrSession?.inputSources;if(!t)return;this.xrInputDispatcher.onFrameStart(e);let i=null;for(let e=0;e<t.length;++e)if(t[e].handedness===this.xrInputDispatcher.primaryControllerHandedness){i=t[e];break}if(!i||!this.xrSession)return void this.removeInputDisplay();const s=e.getPose(i.targetRaySpace,this.xrReferenceSpace_);s&&s.transform&&(this.xrInputDisplay||(this.xrInputDisplay=new zM(this.viewer,this.modelTransformInverse)),this.xrInputDisplay.update(s.transform.matrix,s.transform.inverse.matrix))}removeInputDisplay(){this.xrInputDisplay&&(this.xrInputDisplay.remove(),this.xrInputDisplay=null)}getDominantXrInputDisplay(){return this.xrInputDisplay}onGamepadButtonDown(e){return this.isStopXrButton(e)}onGamepadButtonDrag(e){}onGamepadButtonUp(e){this.isStopXrButton(e)&&this.stopXr()}isStopXrButton(e){return e.buttonNumber===is.qT7.B&&e.handType===is.dPT.DOMINANT}reduceDetailForSession(){this.orderIndependentTransparencyEnabledOutsideXr=(0,Fs.Z)(),(0,Fs.uP)(!1)}restoreNonXrDetail(){(0,Fs.uP)(this.orderIndependentTransparencyEnabledOutsideXr)}}const VM=window.SpeechRecognition||window.webkitSpeechRecognition;class UM{constructor(e,t){this.viewer=e,this.commentStarted=!1,this.commentImage=null,this.recognition=null,this.recognitionResult="",this.lastPreviewedText="",this.textPreview=null,t.addGamepadButtonHandler(this),VM?(this.recognition=new VM,this.recognition.continuous=!0,this.recognition.lang="en-US",this.recognition.interimResults=!0,this.recognition.onstart=()=>{ut.log.trace("Speech recognition started")},this.recognition.onerror=e=>{ut.log.info("Speech recognition error: "+e.error),this.abortComment()},this.recognition.onresult=e=>this.processRecognitionResult(e),this.recognition.onend=()=>{this.finishComment()}):ut.log.debug("Speech recognition not available")}checkMicrophonePermission(){return new Promise(((e,t)=>{const i="os-microphone-permission-check-completed";if(localStorage.getItem(i))e();else{const s=new VM;function n(){s.abort(),localStorage.setItem(i,"true"),e()}s.continuous=!0,s.lang="en-US",s.interimResults=!0,s.onstart=n,s.onerror=n,s.start()}}))}onGamepadButtonDown(e){return!(!this.commentStarted||!this.isAbortCommentButton(e))||!!this.recognition&&this.isDoCommentButton(e)}onGamepadButtonDrag(e){}onGamepadButtonUp(e){this.isDoCommentButton(e)?this.commentStarted?this.stopRecognition():this.startComment():this.isAbortCommentButton(e)&&this.abortComment()}isDoCommentButton(e){return e.buttonNumber===is.qT7.A&&e.handType===is.dPT.NON_DOMINANT}isAbortCommentButton(e){return e.buttonNumber===is.qT7.B&&e.handType===is.dPT.NON_DOMINANT}startComment(){this.commentStarted||(this.commentStarted=!0,this.recognitionResult="",this.lastPreviewedText="",this.viewer.getXrController().getIsXrRunning()?(this.viewer.getXrController().captureViewportImage().then((e=>{this.commentImage=e})).finally((()=>{this.startRecognition()})),this.updateTextPositionFromCamera(this.viewer.getXrController().getCamera())):(this.commentImage=this.viewer.retrieveViewportAsImage({width:this.viewer.getCamera().getCanvasWidth(),height:this.viewer.getCamera().getCanvasHeight(),useFlattenedView:!1,usePrint:!1,zoomToFit:!1,zoomToSelection:!1,showViewCube:!0}),this.updateTextPositionFromCamera(this.viewer.getCamera()),this.startRecognition()))}startRecognition(){this.updateTextDisplay("Listening for comment…"),this.recognition?.start()}processRecognitionResult(e){if(void 0===e.results)return ut.log.debug("Speech recognition gave no result"),void this.abortComment();let t="";for(let i=e.resultIndex;i<e.results.length;++i)e.results[i].isFinal?this.recognitionResult+=e.results[i][0].transcript:t+=e.results[i][0].transcript;this.updateTextDisplay(this.recognitionResult+t)}stopRecognition(){this.recognition?.stop()}finishComment(){if(!this.commentStarted)return;if(this.commentStarted=!1,!this.commentImage)return void ut.log.warn("No image for xr comment");const e=this.recognitionResult;e?(0,Fs.Z$)(this.commentImage).then((t=>{const i={isNew:!0,elementId:this.viewer.getActiveElementId(),attachment:new File([t],"XR view.jpg")};(0,sr.m)().trigger(ir.C.PUBLISH_NEW_COMMENT,e,i)})):ut.log.trace("Cannot post comment without message"),this.clearTextDisplay(),this.recognitionResult="",this.commentImage=null}abortComment(){this.clearTextDisplay(),this.commentStarted=!1,this.commentImage=null,this.recognition?.abort()}updateTextPositionFromCamera(e){this.textPreviewRight=C.copy(C.create(),e.getRight()),this.textPreviewUp=C.copy(C.create(),e.getUp());this.textPreviewOrigin=C.add(C.create(),e.getEye(),C.scale(C.create(),e.getForward(),1.5))}clearTextDisplay(){this.textPreview&&(this.textPreview.remove(),this.textPreview=null)}updateTextDisplay(e){if(this.lastPreviewedText===e)return;this.clearTextDisplay(),this.lastPreviewedText=e;let t="New comment:\n\n";const i=e.split(" ");let s=0;for(let e=0;e<i.length;++e)s>0&&(t+=" ",s+=1),t+=i[e],s+=i[e].length,s>=50&&(t+="\n",s=0);t+="\n\nLeft A: confirm     Left B: cancel",this.textPreview=new Ta({origin:this.textPreviewOrigin,right:this.textPreviewRight,up:this.textPreviewUp,heightPx:20},this.viewer),this.textPreview.setText(t),this.textPreview.updateOnEachFrame=!1}}const GM=.102,HM=[[-.032,0,0],[.032,0,0],[-.032,0,0],[0,-.038,0],[.032,0,0],[0,-.038,0],[0,0,-GM],[-.032,0,0],[0,0,-GM],[.032,0,0],[0,0,-GM],[0,-.038,0]],kM=new xi.hF({isVisible:!0,isPickable:!1,isTwoSided:!0,isShowThrough:!1,isDepthTested:!0,priority:xi.DO.DEFAULT,primitiveType:Di.MX.LINES}),WM=kM.cloneAndModify({addsToBounds:!1});class zM extends Ti.u1{constructor(e,t){super(e),this.modelTransformInverse=t,this.color=[1,0,0,1],this.pose=de.create(),this.combinedTransform=de.create(),this.hidePointerRay_=!1;const i=(0,Au.pf)(HM,null,this.color);this.updateMeshIncrement("LINES",Ti.ZJ,i,kM)}update(e,t){if(!this.hidePointerRay_){const e=(0,Au.pf)([[0,0,-GM],[0,0,-10]],null,this.color);this.updateMeshIncrement("RAY",Ti.ZJ,e,WM)}de.copy(this.pose,e),this.updateTransform()}onModelTransformChange(e){this.modelTransformInverse=e,this.updateTransform()}hidePointerRay(){this.removeMeshIncrement("RAY"),this.hidePointerRay_=!0}showPointerRay(){this.hidePointerRay_=!1}updateTransform(){de.multiply(this.combinedTransform,this.modelTransformInverse,this.pose),this.setTransform(this.combinedTransform)}}var XM;!function(e){e.select="select",e.selectstart="selectstart",e.selectend="selectend",e.squeeze="squeeze",e.squeezestart="squeezestart",e.squeezeend="squeezeend"}(XM||(XM={}));class ZM{constructor(e,t,i,s){this.worldSpacePose=e,this.worldSpaceRay=t,this.modelSpacePose=i,this.modelSpaceRay=s}}class qM{constructor(e,t,i){this.handType=e,this.buttonNumber=t,this.xrInputEvent=i}}class YM{constructor(e,t,i){this.handType=e,this.gamepad=t,this.xrInputEvent=i}}class KM{}class jM{constructor(e,t){this.viewer=e,this.xrController=t,this.eventToCallback=new Map,this.selectHandlers=[],this.activeSelectHandler=null,this.activeSelectSource=null,this.squeezeHandlers=[],this.activeSqueezeHandler=null,this.activeSqueezeSource=null,this.gamepadButtonStates=[],this.gamepadButtonHandlers=[],this.activeGamepadButtonHandlers=new Map,this.gamepadAxesHandlers=[],this.activeGamepadAxesHandler=[null,null],this.primaryControllerHandedness_=null,this.resetGamepadState()}resetGamepadState(){this.gamepadButtonStates=[],this.activeGamepadButtonHandlers=new Map;for(let e=is.dPT.DOMINANT;e<=is.dPT.NON_DOMINANT;++e){const t=[],i=new Map;for(let e=0;e<10;++e)t.push(new KM),i.set(e,null);this.gamepadButtonStates.push(t),this.activeGamepadButtonHandlers.set(e,i)}}destroy(){this.removeXrSessionListeners()}get primaryControllerHandedness(){return this.primaryControllerHandedness_}setXrSession(e){this.xrSession!==e?(this.xrSession&&this.resetXrSession(),this.xrSession=e,this.bindListener(XM.select,this.onSelect),this.bindListener(XM.selectstart,this.onSelectStart),this.bindListener(XM.selectend,this.onSelectEnd),this.bindListener(XM.squeeze,this.onSqueeze),this.bindListener(XM.squeezestart,this.onSqueezeStart),this.bindListener(XM.squeezeend,this.onSqueezeEnd)):ut.log.debug("Called setXrSession twice for same session")}resetXrSession(){this.removeXrSessionListeners(),this.xrSession=null}removeXrSessionListeners(){for(const[e,t]of this.eventToCallback)this.xrSession?.removeEventListener(e,t);this.eventToCallback.clear()}addHandler(e,t){t.indexOf(e)<0&&t.unshift(e)}removeHandler(e,t){const i=t.indexOf(e);i>=0&&t.splice(i,1)}addSelectHandler(e){this.addHandler(e,this.selectHandlers)}removeSelectHandler(e){this.removeHandler(e,this.selectHandlers),this.activeSelectHandler===e&&(this.activeSelectHandler=null)}addSqueezeHandler(e){this.addHandler(e,this.squeezeHandlers)}removeSqueezeHandler(e){this.removeHandler(e,this.squeezeHandlers),this.activeSqueezeHandler===e&&(this.activeSqueezeHandler=null)}addGamepadButtonHandler(e){this.addHandler(e,this.gamepadButtonHandlers)}removeGamepadButtonHandler(e){this.removeHandler(e,this.gamepadButtonHandlers);for(const[t,i]of this.activeGamepadButtonHandlers)for(const[t,s]of i)s===e&&i.set(t,null)}addGamepadAxesHandler(e){this.addHandler(e,this.gamepadAxesHandlers)}removeGamepadAxesHandler(e){this.removeHandler(e,this.gamepadAxesHandlers);for(let t=0;t<this.activeGamepadAxesHandler.length;++t)this.activeGamepadAxesHandler[t]===e&&(this.activeGamepadAxesHandler[t]=null)}onFrameStart(e){const t=new Map;if(this.activeSelectSource&&this.activeSelectHandler){const i=this.getOsEventFromFrameAndSource(e,this.activeSelectSource,t);i&&this.activeSelectHandler.onXrSelectDrag(i)}if(this.activeSqueezeSource&&this.activeSqueezeHandler){const i=this.getOsEventFromFrameAndSource(e,this.activeSqueezeSource,t);i&&this.activeSqueezeHandler.onXrSqueezeDrag(i)}if(this.primaryControllerHandedness_||this.initializeHandedness(),!this.xrSession)return;let i=null,s=null;for(let e=0;e<this.xrSession.inputSources.length;++e)this.xrSession.inputSources[e].gamepad&&(this.xrSession.inputSources[e].handedness===this.primaryControllerHandedness?i||(i=this.xrSession.inputSources[e]):s||(s=this.xrSession.inputSources[e]));i&&this.updateGamepadState(is.dPT.DOMINANT,i,e,t),s&&this.updateGamepadState(is.dPT.NON_DOMINANT,s,e,t)}updateGamepadState(e,t,i,s){const n=t.gamepad;if(t.gamepad){for(let r=0;r<n.buttons.length;++r){if(r>=10){ut.log.debug("Trying to track a button beyond what we support: "+r);continue}const a=n.buttons[r],o=this.gamepadButtonStates[e][r],h=this.activeGamepadButtonHandlers.get(e).get(r);if(a.pressed&&!o.timePressed){o.timePressed=(0,Fs.Wj)();const n=new qM(e,r,this.getOsEventFromFrameAndSource(i,t,s));for(const t of this.gamepadButtonHandlers)if(t.onGamepadButtonDown(n)){this.activeGamepadButtonHandlers.get(e).set(r,t);break}}else if(!a.pressed&&o.timePressed){if(o.timePressed=null,h){const n=new qM(e,r,this.getOsEventFromFrameAndSource(i,t,s));h.onGamepadButtonUp(n),this.activeGamepadButtonHandlers.get(e).set(r,null)}}else if(a.pressed&&h){const n=new qM(e,r,this.getOsEventFromFrameAndSource(i,t,s));h.onGamepadButtonDrag(n)}}if(this.activeGamepadAxesHandler[e]){const r=new YM(e,n,this.getOsEventFromFrameAndSource(i,t,s));this.activeGamepadAxesHandler[e].onGamepadAxesUpdate(r)||(this.activeGamepadAxesHandler[e]=null)}else if(this.gamepadButtonHandlers.length>0){const r=new YM(e,n,this.getOsEventFromFrameAndSource(i,t,s));for(const t of this.gamepadAxesHandlers)t.onGamepadAxesUpdate(r)&&(this.activeGamepadAxesHandler[e]=t)}}else ut.log.warn("Should only update with gamepad input sources")}initializeHandedness(){if(!this.xrSession)return;let e,t;for(let i=0;i<this.xrSession.inputSources.length;++i)this.xrSession.inputSources[i].gamepad&&("right"===this.xrSession.inputSources[i].handedness?e=!0:"left"===this.xrSession.inputSources[i].handedness&&(t=!0));e?this.primaryControllerHandedness_="right":t&&(this.primaryControllerHandedness_="left")}bindListener(e,t){const i=e=>{t.bind(this)(this.getOsEventFromSourceEvent(e),e)};this.xrSession.addEventListener(e,i),this.eventToCallback.set(e,i)}getOsEventFromSourceEvent(e){return this.getOsEventFromFrameAndSource(e.frame,e.inputSource)}getOsEventFromFrameAndSource(e,t,i){const s=i?.get(t);if(s)return s;const n=e.getPose(t.targetRaySpace,this.xrController.xrReferenceSpace);if(!n?.transform)return null;const r=this.xrController.modelTransformInverse,a=ge.w$.multiplyVec3(n.transform.matrix,[0,0,0]),o=ge.w$.multiplyVec3(r,a,C.create()),h=ge.w$.multiplyVec4(n.transform.matrix,[0,0,-1,0]),c=ge.w$.multiplyVec4(r,h,y.create()),l=new yi.zH(a,h),u=new yi.zH(o,c),d=de.multiply(de.create(),r,n.transform.matrix),g=new ZM(n.transform.matrix,l,d,u);return i&&i.set(t,g),g}onSelectStart(e,t){for(let t=0;t<this.selectHandlers.length;++t)if(this.selectHandlers[t].onXrSelectStart(e)){this.activeSelectHandler=this.selectHandlers[t];break}this.activeSelectSource=t.inputSource}onSelect(e,t){if(t.inputSource.handedness!==this.primaryControllerHandedness_){this.primaryControllerHandedness_=t.inputSource.handedness;const e=this.gamepadButtonStates[is.dPT.DOMINANT];return this.gamepadButtonStates[is.dPT.DOMINANT]=this.gamepadButtonStates[is.dPT.NON_DOMINANT],void(this.gamepadButtonStates[is.dPT.NON_DOMINANT]=e)}this.activeSelectHandler&&this.activeSelectHandler.onXrSelect(e)}onSelectEnd(e,t){this.activeSelectHandler&&(this.activeSelectHandler.onXrSelectEnd(e),this.activeSelectHandler=null),this.activeSelectSource=null}onSqueezeStart(e,t){for(let t=0;t<this.squeezeHandlers.length;++t)if(this.squeezeHandlers[t].onXrSqueezeStart(e)){this.activeSqueezeHandler=this.squeezeHandlers[t];break}this.activeSqueezeSource=t.inputSource}onSqueeze(e,t){this.activeSqueezeHandler&&this.activeSqueezeHandler.onXrSqueeze(e)}onSqueezeEnd(e,t){this.activeSqueezeHandler&&(this.activeSqueezeHandler.onXrSqueezeEnd(e),this.activeSqueezeHandler=null),this.activeSqueezeSource=null}}const QM=new xi.hF({isVisible:!0,isPickable:!1,isTwoSided:!0,isShowThrough:!1,isDepthTested:!0,priority:xi.DO.DEFAULT,primitiveType:Di.MX.LINES});class $M extends Ti.u1{constructor(e,t,i){super(e);const s=(0,Au.pf)(t,null,i,2);this.updateMeshIncrement("LINES",Ti.ZJ,s,QM)}}const JM=[1,0,0,1];class eC{constructor(e,t){this.viewer=e,this.lineMarkup=[],this.inProgressLine=[],this.inProgressMarkup=null,t.addGamepadButtonHandler(this)}clearMarkup(){for(const e of this.lineMarkup)e.remove();this.lineMarkup=[]}onGamepadButtonDown(e){return this.isDrawMarkupButton(e)?(this.inProgressLine=[],this.updateLineMarkupWithCurrentPosition(e),this.viewer.getXrController().getDominantXrInputDisplay().hidePointerRay(),!0):this.isClearMarkupButton(e)}onGamepadButtonDrag(e){this.isDrawMarkupButton(e)&&this.updateLineMarkupWithCurrentPosition(e)}onGamepadButtonUp(e){this.isDrawMarkupButton(e)?(this.inProgressMarkup&&(this.lineMarkup.push(this.inProgressMarkup),this.inProgressMarkup=null,this.inProgressLine=[]),this.viewer.getXrController().getDominantXrInputDisplay().showPointerRay()):this.isClearMarkupButton(e)&&this.clearMarkup()}updateLineMarkupWithCurrentPosition(e){const t=e.xrInputEvent.modelSpaceRay.evaluate(GM);if(0===this.inProgressLine.length)return void this.inProgressLine.push(t);const i=this.inProgressLine[this.inProgressLine.length-1];C.dist(i,t)<1e-4||(1===this.inProgressLine.length||this.inProgressLine.push(i),this.inProgressLine.push(t),this.inProgressMarkup&&this.inProgressMarkup.remove(),this.inProgressMarkup=new $M(this.viewer,this.inProgressLine,JM))}isDrawMarkupButton(e){return e.buttonNumber===is.qT7.A&&e.handType===is.dPT.DOMINANT}isClearMarkupButton(e){return e.buttonNumber===is.qT7.B&&e.handType===is.dPT.NON_DOMINANT}}class tC{constructor(e){this.viewer=e,this.draggedUiElement=null}onXrSelectStart(e){this.draggedUiElement=null;const t=this.handleEvent(e,!0);return!(!t.handledUiSelection||!t.handledUiSelection.uiElement.triggerXrDragStart(t.handledUiSelection,e))&&(this.draggedUiElement=t.handledUiSelection,!0)}onXrSelectDrag(e){this.draggedUiElement&&this.draggedUiElement.uiElement.triggerXrDrag(this.draggedUiElement,e)}onXrSelect(e){this.draggedUiElement&&ut.log.debug("Had dragged ui element during xr select event")}onXrSelectEnd(e){this.draggedUiElement&&(this.draggedUiElement.uiElement.triggerXrDragStop(this.draggedUiElement,e),this.draggedUiElement=null)}handleEvent(e,t){const i=this.viewer.pickWithXrInput(e),s={};s.click=!t;let n=!1;const r=this.viewer.getUISelectionManager(),a={handledUiSelection:null};for(let e=0;e<i.length&&!n;++e){const o=i[e],h=o.getModelSelection();if(h&&!this.viewer.getSuppressModelSelection())n=(0,Ma.rQ)(h,t,true,s),n&&r.handleEmptyUiPick(t,s);else if(o.isUIPick()&&(n=r.processUiPick(o,{}),n&&!this.viewer.getSuppressModelSelection())){const e=o.getUISelection();e&&!e.getClearModelSelectionsOnPrehilite()||(0,Ma.Zs)(t,!0),a.handledUiSelection=o.uiSelection}}return n||this.viewer.getSuppressModelSelection()||(0,Ma.Zs)(t,!1),a}}const iC=new xi.hF({isVisible:!0,isPickable:!1,isTwoSided:!0,isShowThrough:!0,isDepthTested:!1,priority:xi.DO.DEFAULT,primitiveType:Di.MX.LINES}),sC=[0,1,0,1],nC=[0,0,1];class rC extends Ti.u1{constructor(e){super(e);const t=(0,Au.y)([0,0,0],.5,nC,128);(0,Au.Ab)(sC,t),(0,Au.VQ)(2,t),this.updateMeshIncrement("preview_circle",Ti.ZJ,t,iC)}updateLocation(e){const t=de.create();de.translate(t,t,e),this.setTransform(t)}}const aC=de.rotateX(de.create(),de.identity(de.create()),-Math.PI/2),oC=de.invert(de.create(),aC);function hC(){return navigator.xr}var cC;!function(e){e[e.NONE=0]="NONE",e[e.FORWARD=1]="FORWARD",e[e.ROTATE_LEFT=2]="ROTATE_LEFT",e[e.ROTATE_RIGHT=3]="ROTATE_RIGHT"}(cC||(cC={}));class lC{constructor(e,t){this.viewer=e,this.initialModelTransform=null,this.initialWorldTransformInverse=null,this.activeTeleportMode=cC.NONE,this.teleportPreview=null,this.modelCamera=new oh,t.addSqueezeHandler(this),t.addGamepadAxesHandler(this)}initializeModelView(e){const t=this.viewer.getCamera();if(!t)return;const i=this.viewer.getModelViewManagers().getManager().getModelBounds();if(!i.isInitialized()||!i.isFinite())return void ut.log.warn("Could not initialize xr view with bounds: "+i);const s=[e.getDirection()[0],0,e.getDirection()[2]];C.normalize(s,s);let n=null;const r=this.viewer.retrieveCanvasLocationWorldPosition([t.getCanvasWidth()/2,t.getCanvasHeight()/2]);if(r){const e=t.getPixelSizeAtWorldPoint(r),s=t.getCanvasHeight()*e,n=2;if(i.diameter()>s*n){const e=s/2/Math.tan((0,yi.Yr)(rh/2)),i=C.scaleAndAdd(C.create(),r,t.getForward(),-e);return void this.setModelTransform(this.getTransform(i,t.getForward()))}}if(!n){const t=.4+i.diameter()/5,r=C.add(C.create(),e.getEye(),C.scale(C.create(),s,t));r[1]-=i.diameter()/2,n=de.translate(de.create(),de.identity(de.create()),r)}this.setModelTransform(de.multiply(de.create(),n,aC))}onXrSqueezeStart(e){return this.initialWorldTransformInverse=de.invert(de.create(),e.worldSpacePose),this.initialModelTransform=de.copy(de.create(),this.viewer.getXrController().modelTransform),!0}onXrSqueezeDrag(e){const t=de.multiply(de.create(),e.worldSpacePose,this.initialWorldTransformInverse);this.setModelTransform(de.multiply(de.create(),t,this.initialModelTransform))}onXrSqueeze(e){}onXrSqueezeEnd(e){this.initialWorldTransformInverse=null,this.initialModelTransform=null}onGamepadAxesUpdate(e){if(e.handType===is.dPT.NON_DOMINANT)return!1;const t=Math.abs(e.gamepad.axes[2])>=.5&&(this.activeTeleportMode===cC.NONE||this.activeTeleportMode===cC.ROTATE_LEFT||this.activeTeleportMode===cC.ROTATE_RIGHT),i=e.gamepad.axes[3]<-.5&&(this.activeTeleportMode===cC.NONE||this.activeTeleportMode===cC.FORWARD);if(t)e.gamepad.axes[2]<0?(this.updateRotationTeleport(45),this.activeTeleportMode=cC.ROTATE_LEFT):(this.updateRotationTeleport(-45),this.activeTeleportMode=cC.ROTATE_RIGHT);else if(i)this.updateTeleportLocationAndPreview(e),this.activeTeleportMode=cC.FORWARD;else{if(this.activeTeleportMode!==cC.NONE){this.teleportPreview&&(this.teleportPreview.remove(),this.teleportPreview=null);const e=C.fromValues(this.xrTeleportLocation[0],this.xrTeleportLocation[1],this.xrTeleportLocation[2]);this.setModelTransform(this.getTransform(e,this.xrTeleportDirection))}this.activeTeleportMode=cC.NONE}return this.activeTeleportMode!==cC.NONE}updateRotationTeleport(e){const t=this.viewer.getXrController().getCamera().getViewMatrixInverse(),i=de.rotateY(de.create(),de.create(),(0,yi.Yr)(e));de.multiply(i,this.viewer.getXrController().lastXrViewMatrixInverse,i);const s=y.transformMat4(y.create(),[0,0,-1,0],i);this.xrTeleportDirection=y.transformMat4(y.create(),s,t),this.xrTeleportLocation=C.transformMat4(C.create(),[0,0,0],t)}updateTeleportLocationAndPreview(e){this.teleportPreview||(this.teleportPreview=new rC(this.viewer));const t=this.viewer.getDepthForXrInput(e.xrInputEvent);t<0&&ut.log.debug("Teleport depth distance was negative: "+t.toFixed(3)),this.teleportPreview.show();const i=e.xrInputEvent.modelSpaceRay.evaluate(t);this.xrTeleportLocation=C.copy(C.create(),i);this.xrTeleportLocation[2]+=1.7;const s=y.transformMat4(y.create(),[0,0,-1,0],this.viewer.getXrController().lastXrViewMatrixInverse);this.xrTeleportDirection=y.transformMat4(y.create(),s,this.viewer.getXrController().getCamera().getViewMatrixInverse()),this.teleportPreview.updateLocation(i)}setModelTransform(e){this.viewer.getXrController().modelTransform=e}getTransform(e,t){const i=C.fromValues(t[0],t[1],0);C.normalize(i,i);const s=C.fromValues(0,0,1);return this.modelCamera.setViewPositionAndOrientation(e,i,s),this.modelCamera.getViewMatrix()}}const uC=new xi.hF({isShowThrough:!1,isPickable:!1,primitiveType:Di.MX.LINES});class dC extends Ti.u1{constructor(e,t){super(e),this.graphicsId=dC.GRAPHICS_ID_PREFIX+t,this.setId(this.graphicsId)}getExplodeLineNodeProperties(){return uC}onAppearanceConstantsUpdated(){this.updateGraphics()}}dC.GRAPHICS_ID_PREFIX="EXPLODE_LINE_GRAPHICS_";const gC=X.default.getManager();class pC extends dC{constructor(e,t){super(e,t)}updateDefinition(e){e.startPosition&&e.center&&e.axis&&e.hasOwnProperty("angle")&&(this.startPosition=e.startPosition,this.arcCenter=e.center,this.arcAxis=e.axis,this.arcAngle=e.angle),this.updateGraphics()}updateGraphics(){const e=ge.S4.subtract(this.startPosition,this.arcCenter,C.create()),t=ge.S4.normalize(e,C.create()),i=ge.S4.length(e),s=this.arcAngle,n=gC.getNumber("EXPLODE_LINE_CIRCLE_SEGMENT_COUNT")*Math.abs(s-0)/(2*Math.PI),r=(0,Au.QV)(this.arcCenter,i,this.arcAxis,t,0,s,n);(0,Au.VQ)(1,r),(0,Au.Ab)(gC.getColor("EXPLODE_LINE_COLOR"),r),(0,Au.KZ)(gC.getStipple("EXPLODE_LINE_STIPPLE"),r);const a=this.graphicsId+"_MESH_INCREMENT";this.updateMeshIncrement(a,Ti.ZJ,r,this.getExplodeLineNodeProperties())}}const mC=X.default.getManager();class fC extends dC{constructor(e,t){super(e,t),this.startPosition=null,this.endPosition=null}updateDefinition(e){this.startPosition=e.startPosition,this.endPosition=e.endPosition,this.updateGraphics()}updateGraphics(){const e=(0,Au.W5)(this.startPosition,this.endPosition);(0,Au.VQ)(1,e),(0,Au.Ab)(mC.getColor("EXPLODE_LINE_COLOR"),e),(0,Au.KZ)(mC.getStipple("EXPLODE_LINE_STIPPLE"),e);const t=this.graphicsId+"_MESH_INCREMENT";this.updateMeshIncrement(t,Ti.ZJ,e,this.getExplodeLineNodeProperties())}}var IC=i(64089),EC=i(33212),SC=i(90645);class TC extends f{constructor(e,t,i,s){super(e,null),this.pass1=t,this.pass2=i,this.predicate=s,this.childPasses=[this.pass1,this.pass2]}setInput(e,t){this.pass1.setInput(e,t),this.pass2.setInput(e,t)}prepareShaders(){this.predicate()?this.pass1.prepareShaders():this.pass2.prepareShaders()}drawInputs(e){this.predicate()?this.pass1.drawInputs(e):this.pass2.drawInputs(e)}preDraw(e){return this.predicate()?this.pass1.preDraw(e):this.pass2.preDraw(e)}justBeforeDraw(e){this.predicate()?this.pass1.justBeforeDraw(e):this.pass2.justBeforeDraw(e)}postDraw(e){this.predicate()?this.pass1.postDraw(e):this.pass2.postDraw(e)}justAfterDraw(e){this.predicate()?this.pass1.justAfterDraw(e):this.pass2.justAfterDraw(e)}draw(e){this.predicate()?this.pass1.draw(e):this.pass2.draw(e)}setEnabled(e){this.pass1.setEnabled(e),this.pass2.setEnabled(e)}destroy(){this.pass1.destroy(),this.pass2.destroy()}setCheckFrameId(e){this.pass1.setCheckFrameId(e),this.pass2.setCheckFrameId(e)}getSceneGraph(){return this.predicate()?this.pass1.getSceneGraph():this.pass2.getSceneGraph()}isPickPass(){return this.predicate()?this.pass1.isPickPass():this.pass2.isPickPass()}isHighlightPass(){return this.predicate()?this.pass1.isHighlightPass():this.pass2.isHighlightPass()}getActiveHighlightType(){return this.predicate()?this.pass1.getActiveHighlightType():this.pass2.getActiveHighlightType()}isShowthroughPass(){return this.predicate()?this.pass1.isShowthroughPass():this.pass2.isShowthroughPass()}forIsolate(){return this.predicate()?this.pass1.forIsolate():this.pass2.forIsolate()}getShaderId(){return this.predicate()?this.pass1.getShaderId():this.pass2.getShaderId()}needsAttribute(e){return this.predicate()?this.pass1.needsAttribute(e):this.pass2.needsAttribute(e)}getPickIteration(){return this.predicate()?this.pass1.getPickIteration():this.pass2.getPickIteration()}nodeFilter(e){return this.predicate()?this.pass1.nodeFilter(e):this.pass2.nodeFilter(e)}getLastRenderedFrame(){return this.predicate()?this.pass1.getLastRenderedFrame():this.pass2.getLastRenderedFrame()}setHideSelectionInterior(e){this.pass1.setHideSelectionInterior(e),this.pass2.setHideSelectionInterior(e)}getPerformIsolationTest(){return this.pass1.getPerformIsolationTest()||this.pass2.getPerformIsolationTest()}setPerformIsolationTest(e){this.pass1.setPerformIsolationTest(e),this.pass2.setPerformIsolationTest(e)}needsFaceAppearances(){return this.predicate()?this.pass1.needsFaceAppearances():this.pass2.needsFaceAppearances()}onAppearanceConstantsUpdated(){this.predicate()?this.pass1.onAppearanceConstantsUpdated():this.pass2.onAppearanceConstantsUpdated()}}class DC extends TC{setExtraMeshNodeFilter(e){this.pass1.setExtraMeshNodeFilter(e),this.pass2.setExtraMeshNodeFilter(e)}setOpacity(e){this.pass1.setOpacity(e),this.pass2.setOpacity(e)}setSceneGraph(e){this.pass1.setSceneGraph(e),this.pass2.setSceneGraph(e)}setEnableColorWrites(e){this.pass1.setEnableColorWrites(e),this.pass2.setEnableColorWrites(e)}setNodeFilter(e){this.pass1.setNodeFilter(e),this.pass2.setNodeFilter(e)}appliesTranslucentAlphaToAll(e){this.pass1.appliesTranslucentAlphaToAll(e),this.pass2.appliesTranslucentAlphaToAll(e)}}class MC extends TC{setEdgesEnabled(e){this.pass1.setEdgesEnabled(e)}appliesTranslucentAlphaToAll(e){this.pass1.appliesTranslucentAlphaToAll(e)}setDepthOpacity(e){this.pass1.setDepthOpacity(e)}setDepthPassEnabled(e){this.pass1.setDepthPassEnabled(e)}setExtraMeshNodeFilter(e){this.pass1.setExtraMeshNodeFilter(e),this.pass2.setExtraMeshNodeFilter(e)}}},19586:function(e,t,i){i.d(t,{a:function(){return r}});class s{constructor(){this.activeManipulator=null}setActiveManipulator(e){this.activeManipulator&&this.activeManipulator.removeDisplacementMeshIncrements(),this.activeManipulator=e}resetActiveManipulator(){this.setActiveManipulator(null)}}let n=null;function r(){return n||(n=new s),n}},66607:function(e,t,i){i.d(t,{$o:function(){return L},AF:function(){return z},Ad:function(){return d},Ao:function(){return S},B$:function(){return de},CD:function(){return K},CW:function(){return Q},Cu:function(){return Ne},E7:function(){return X},FE:function(){return f},HO:function(){return j},KU:function(){return b},Kb:function(){return ve},Kf:function(){return Re},LK:function(){return Z},Lr:function(){return k},Oh:function(){return N},Ot:function(){return pe},S_:function(){return I},TE:function(){return oe},Tc:function(){return E},Tu:function(){return Oe},Ux:function(){return te},WW:function(){return R},Wm:function(){return Se},Yr:function(){return ee},_O:function(){return Pe},_k:function(){return Ae},bZ:function(){return F},cP:function(){return we},cl:function(){return se},df:function(){return Ee},dm:function(){return le},eB:function(){return ge},fB:function(){return u},fE:function(){return x},g7:function(){return v},g9:function(){return Ce},iD:function(){return ye},iK:function(){return T},iM:function(){return fe},jP:function(){return me},kB:function(){return C},nP:function(){return ie},n_:function(){return ne},o5:function(){return ue},qm:function(){return q},r7:function(){return ae},rQ:function(){return A},s9:function(){return m},sc:function(){return _},ss:function(){return W},tO:function(){return D},tV:function(){return re},tl:function(){return p},tm:function(){return g},u3:function(){return ce},uZ:function(){return Y},vG:function(){return Me},vu:function(){return w},w5:function(){return Be},wd:function(){return he},xV:function(){return _e},zD:function(){return Te},zH:function(){return O},zL:function(){return De}});var s=i(55858),n=i(18265),r=i(45666);if(666==i.j)var a=i(90342);var o=i(72751),h=i(60036),c=i(80462);const l=666==i.j?[0,0,0]:null;function u(e){return s.squaredLength(e)<Math.pow(h.W.MAX_MODEL_SIZE,2)}"undefined"!=typeof window&&(window.glMatrixArrayType=Array);const d=n.create();function g(e,t){return r.squaredLength(c.gv.subtract(e,t,r.create()))<h.W.ZERO_LENGTH_SQUARED}const p=53,m=Number.MAX_SAFE_INTEGER?Number.MAX_SAFE_INTEGER:9007199254740991;function f(e,t,i){const n=s.dot(e,t),r=s.dot(c.S4.cross(e,t,s.create()),c.S4.normalize(i,s.create()));return Math.atan2(r,n)}function I(e){return e<0?Math.floor(e):Math.ceil(e)}function E(e){return e<0?Math.ceil(e):Math.floor(e)}function S(e,t,i,s){return!(e>t||i>s)&&(e<i?i<t-h.W.ZERO_LENGTH:e<s-h.W.ZERO_LENGTH)}var T;!function(e){e[e.LOW=0]="LOW",e[e.MID=.5]="MID",e[e.HIGH=1]="HIGH"}(T||(T={}));class D{constructor(){this.reset()}isInitialized(){for(let e=0;e<2;++e)if(this.min[e]>this.max[e])return!1;return!0}reset(){this.min=[1/0,1/0],this.max=[-1/0,-1/0]}set(e,t){r.copy(this.min,e),r.copy(this.max,t)}copyFrom(e){this.set(e.min,e.max)}add(e){const t=e.length;for(let i=0;i<t;++i)for(let t=0;t<2;++t)e[i][t]<this.min[t]&&(this.min[t]=e[i][t]),e[i][t]>this.max[t]&&(this.max[t]=e[i][t])}addPoint(e){for(let t=0;t<2;++t)e[t]<this.min[t]&&(this.min[t]=e[t]),e[t]>this.max[t]&&(this.max[t]=e[t])}addPointXY(e,t){e<this.min[0]&&(this.min[0]=e),e>this.max[0]&&(this.max[0]=e),t<this.min[1]&&(this.min[1]=t),t>this.max[1]&&(this.max[1]=t)}addBox(e){if(e.isInitialized())for(let t=0;t<2;++t)this.min[t]=Math.min(this.min[t],e.min[t]),this.max[t]=Math.max(this.max[t],e.max[t])}getDimensions(){return c.gv.subtract(this.max,this.min,r.create())}overlapsWith(e){return S(this.min[0],this.max[0],e.min[0],e.max[0])&&S(this.min[1],this.max[1],e.min[1],e.max[1])}contains(e){return e[0]>=this.min[0]&&e[1]>=this.min[1]&&e[0]<=this.max[0]&&e[1]<=this.max[1]}makeCenteredBoxOnPoint(e,t){const i=.5*t;this.min[0]=e[0]-i,this.min[1]=e[1]-i,this.max[0]=e[0]+i,this.max[1]=e[1]+i}center(e){return e=e||r.create(),c.gv.scale(c.gv.add(this.min,this.max,e),.5)}getCorners(e){if(!e){e=[];for(let t=0;t<4;++t)e.push(r.create())}for(let t=0;t<2;++t)for(let i=0;i<2;++i){const s=e[2*i+t];s[0]=0===t?this.min[0]:this.max[0],s[1]=0===i?this.min[1]:this.max[1]}return e}translate(e){c.gv.add(this.min,e,this.min),c.gv.add(this.max,e,this.max)}}const M=[0,0,0];class C{constructor(e,t){this.min=s.create(),this.max=s.create(),void 0!==e&&void 0!==t?this.set(e,t):this.reset()}clone(){return new C(this.min,this.max)}toString(){return"min: "+this.min+", max: "+this.max}makeSceneDebugObject(){let e="BoundingBox: ";if(this.isInitialized()){const t=[],i=[];for(let e=0;e<3;++e)t.push(this.min[e].toFixed(5)),i.push(this.max[e].toFixed(5));e+="(min: "+t+", max: "+i+")"}else e+="(Uninitialized)";return{text:e,children:[]}}getMin(){return s.clone(this.min)}getMax(){return s.clone(this.max)}set(e,t){s.copy(this.min,e),s.copy(this.max,t)}copyFrom(e){this.set(e.min,e.max)}reset(){this.set([1/0,1/0,1/0],[-1/0,-1/0,-1/0])}equals(e){for(let t=0;t<3;++t)if(this.min[t]!==e.min[t]||this.max[t]!==e.max[t])return!1;return!0}setInfinite(){this.set([-1/0,-1/0,-1/0],[1/0,1/0,1/0])}isInitialized(){for(let e=0;e<3;++e)if(this.min[e]>this.max[e])return!1;return!0}isInfinite(){for(let e=0;e<3;++e)if(this.min[e]===-1/0||this.max[e]===1/0)return!0;return!1}isFinite(){return this.isInitialized()&&!this.isInfinite()}areBoundDimensionsSmallerThan(e){for(let t=0;t<3;++t)if(this.max[t]-this.min[t]>=e)return!1;return!0}addPoint(e){for(let t=0;t<3;++t)e[t]<this.min[t]&&(this.min[t]=e[t]),e[t]>this.max[t]&&(this.max[t]=e[t])}addXYZ(e,t,i){e<this.min[0]&&(this.min[0]=e),e>this.max[0]&&(this.max[0]=e),t<this.min[1]&&(this.min[1]=t),t>this.max[1]&&(this.max[1]=t),i<this.min[2]&&(this.min[2]=i),i>this.max[2]&&(this.max[2]=i)}addPointArray(e){for(let t=0;t<e.length;++t)for(let i=0;i<3;++i)e[t][i]<this.min[i]&&(this.min[i]=e[t][i]),e[t][i]>this.max[i]&&(this.max[i]=e[t][i])}createTransformedCopy(e){const t=new C;return t.addBox(this,e),t}addBox(e,t,i){if(e&&e.isInitialized())if(e.isInfinite())this.setInfinite();else{if(i&&y.copyFrom(this),!t||ne(t))this.addXYZ(e.min[0],e.min[1],e.min[2]),this.addXYZ(e.max[0],e.max[1],e.max[2]);else{const i=[e.min,e.max];for(let e=0;e<2;e++)for(let s=0;s<2;s++)for(let n=0;n<2;n++){const r=[i[e][0],i[s][1],i[n][2]];c.w$.multiplyVec3(t,r),this.addPoint(r)}}i&&!A(this)&&this.copyFrom(y)}}getCorners(){const e=[this.min,this.max],t=[];if(!this.isInitialized())return null;for(let i=0;i<2;i++)for(let n=0;n<2;n++)for(let r=0;r<2;r++)t.push(s.fromValues(e[i][0],e[n][1],e[r][2]));return t}getLocationInBox(e,t,i){return[K(this.min[0],this.max[0],e),K(this.min[1],this.max[1],t),K(this.min[2],this.max[2],i)]}isExtensive(){for(let e=0;e<3;e++)if(Math.abs(this.max[e]-this.min[e])>h.W.ZERO_LENGTH)return!0;return!1}center(e){e||(e=s.create());const t=c.S4.add(this.min,this.max,e);return c.S4.scale(t,.5),t}diagonalVector(e){return e||(e=s.create()),c.S4.subtract(this.max,this.min,e)}diameter(){return c.S4.length(c.S4.subtract(this.max,this.min,M))}maxDimension(){const e=c.S4.subtract(this.max,this.min,s.create());return Math.max(Math.abs(e[0]),Math.max(Math.abs(e[1]),Math.abs(e[2])))}scale(e){const t=this.center();c.S4.subtract(this.max,t),c.S4.scale(this.max,e),c.S4.add(this.max,t),c.S4.subtract(this.min,t),c.S4.scale(this.min,e),c.S4.add(this.min,t)}dilate(e){const t=s.fromValues(e,e,e);c.S4.add(this.max,t),c.S4.subtract(this.min,t)}getXyBounds(){const e=new D;return e.set([this.min[0],this.min[1]],[this.max[0],this.max[1]]),e}}const y=new C;let P=!1;function A(e){return!!e&&(!!e.isInitialized()&&(!!e.areBoundDimensionsSmallerThan(h.W.MAX_BOUNDS_DIMENSION)||(P||(o.log.info("Found scenegraph node with very large bounds. It will be omitted from bounds computation"),P=!0),!1)))}class O{constructor(e,t){this.point=s.clone(e),this.direction=c.S4.normalize(t,s.create())}setPoint(e){this.point=s.clone(e)}setDirection(e){this.direction=c.S4.normalize(e,s.create())}evaluate(e,t){return c.S4.add(c.S4.scale(this.direction,e,t||s.create()),this.point)}findClosestPositionToOtherRay(e){const t=s.dot(this.direction,this.direction),i=s.dot(this.direction,e.direction),n=s.dot(e.direction,e.direction),r=t*n-i*i;if(Math.abs(r)<h.W.ZERO_ANGLE)return null;const a=c.S4.subtract(this.point,e.point,s.create()),o=s.dot(this.direction,a);return(i*s.dot(e.direction,a)-n*o)/r}findPositionOfPoint(e){return s.dot(this.direction,c.S4.subtract(e,this.point,s.create()))}}function v(e,t){const i=e[0]*t[0]+e[1]*t[1],s=Math.sqrt(e[0]*e[0]+e[1]*e[1]),n=Math.sqrt(t[0]*t[0]+t[1]*t[1]);if(s<=h.W.ZERO_LENGTH||n<=h.W.ZERO_LENGTH)return null;return i/(s*n)}function R(e,t,i){const s=i[0],n=i[1],r=(s*t[0]-s*e[0]+n*t[1]-n*e[1])/(s*s+n*n);t[0]=s*r+e[0],t[1]=n*r+e[1]}function w(e,t,i){const n=c.S4.subtract(t,e,s.create()),r=(s.dot(i,n)-s.dot(e,n))/s.squaredLength(n);return r<=0?(n[0]=e[0],n[1]=e[1],n[2]=e[2]):r>=1?(n[0]=t[0],n[1]=t[1],n[2]=t[2]):c.S4.add(c.S4.scale(n,r),e),n}function _(e){const t=s.create();t[0]=e[8],t[1]=e[9],t[2]=e[10];const i=s.create();i[0]=e[12],i[1]=e[13],i[2]=e[14];const n=s.dot(t,i),r=a.create();return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=-n,r}function N(e,t){let i=a.create();const s=a.create();return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=1,i=c.w$.multiplyVec4(t,s,i),[i[0],i[1],i[2]]}function b(e,t){let i=a.create();const s=a.create();return s[0]=e[0],s[1]=e[1],s[2]=0,s[3]=1,i=c.w$.multiplyVec4(t,s,i),[i[0],i[1],i[2]]}function L(e,t){let i=a.create();const s=a.create();return s[0]=e[0],s[1]=e[1],s[2]=0,s[3]=0,i=c.w$.multiplyVec4(t,s,i),[i[0],i[1],i[2]]}function F(e,t,i){return x(e,_(t),i)}function x(e,t,i){const n=s.dot(e.point,t),r=s.dot(e.direction,t);if(i=i||h.W.ZERO_ANGLE,Math.abs(r)<i)return null;{const i=-(n+t[3])/r;return c.S4.linComb(e.point,1,e.direction,i,s.create())}}const B=s.create(),V=s.create(),U=s.create(),G=s.create(),H=s.create();function k(e,t,i){let n,r=!0;const a=B,o=V,h=U;for(n=0;n<3;++n)e.point[n]<t.min[n]?(a[n]=1,h[n]=t.min[n],r=!1):e.point[n]>t.max[n]?(a[n]=0,h[n]=t.max[n],r=!1):a[n]=2;if(r)return i=i||s.create(),s.copy(i,e.point),i;for(n=0;n<3;++n)2!==a[n]&&0!==e.direction[n]?o[n]=(h[n]-e.point[n])/e.direction[n]:o[n]=-1;let c=0;for(n=1;n<3;++n)o[c]<o[n]&&(c=n);if(o[c]<0)return null;for(i=i||s.create(),n=0;n<3;++n)if(c!==n){if(i[n]=e.point[n]+o[c]*e.direction[n],i[n]<t.min[n]||i[n]>t.max[n])return null}else i[n]=h[n];return i}function W(e,t,i,n){const r=s.dot(e.direction,e.direction),a=2*e.direction[0]*(e.point[0]-t[0])+2*e.direction[1]*(e.point[1]-t[1])+2*e.direction[2]*(e.point[2]-t[2]);let o=a*a-4*r*(s.dot(t,t)+s.dot(e.point,e.point)-2*s.dot(t,e.point)-i*i);if(o<-h.W.ZERO_LENGTH_SQUARED)return null;if(Math.abs(o)<h.W.ZERO_LENGTH_SQUARED){const t=-a/2*r;return e.evaluate(t,n)}{o=Math.sqrt(o);const t=(-a-o)/(2*r);return t<0&&(-a+o)/(2*r)<0?null:t<0?s.copy(n||s.create(),e.point):e.evaluate(t,n)}}function z(e,t,i,n){const r=1e-6,a=B,o=V,h=U,l=G,u=H;c.S4.subtract(i,t,a),c.S4.subtract(n,t,o),c.S4.cross(e.direction,o,h);const d=s.dot(a,h);if(d>-r&&d<r)return;const g=1/d;c.S4.subtract(e.point,t,u);const p=s.dot(u,h)*g;if(p<0||p>1)return;c.S4.cross(u,a,l);const m=s.dot(e.direction,l)*g;if(m<0||p+m>1)return;const f=s.dot(o,l);return f>r?f:void 0}function X(e,t){const i=[],n=s.create();return t&&t.isTriangles()&&k(e,t.getBounds(),n)?(t.iteratePrimitives((function(t,s,n){if(!s||!n)return;const r=z(e,t,s,n);void 0!==r&&i.push(r)})),i):i}function Z(e,t,i,n){const r=c.S4.subtract(e,t,s.create());return[s.dot(r,n),s.dot(r,c.S4.cross(i,n,s.create()))]}function q(e,t,i,n){const r=c.S4.normalize(n,s.create()),a=c.S4.scale(r,e[0],s.create()),o=c.S4.scale(c.S4.cross(i,r,s.create()),e[1],s.create());return c.S4.add(t,c.S4.add(a,o,s.create()),s.create())}function Y(e,t,i){return Math.min(i,Math.max(e,t))}function K(e,t,i){return(1-i)*e+i*t}function j(e,t){if(!e||0===e.length)return;const i=(t-Math.floor(t))*e.length,s=Math.floor(i),n=(s+1)%e.length,r=i-s;return K(e[s],e[n],r)}function Q(e,t,i){return(i=Y((i-e)/(t-e),0,1))*i*(3-2*i)}const $=Math.PI/180,J=180/Math.PI;function ee(e){return e*$}function te(e){return e*J}function ie(e,t){if(e===t)return!0;const i=!!e;if(i!==!!t)return!1;if(!i)return!0;if(e.length!==t.length)return!1;for(let i=0;i<e.length;++i)if(Math.abs(e[i]-t[i])>=h.W.ZERO_LENGTH)return!1;return!0}const se=ie;function ne(e){return!!e&&se(e,d)}function re(e,t){return e[0]*t[1]-e[1]*t[0]}function ae(e,t){return[e[0]-t[0],e[1]-t[1]]}function oe(e,t,i,s,n){const r=[];return!!le(e,t,i,s,r)&&(n[0]=e[0]+r[0]*t[0],n[1]=e[1]+r[0]*t[1],!0)}function he(e,t,i,s,n){const r=[];return!!le(e,t,i,[s[0]-i[0],s[1]-i[1]],r)&&(r[0]>=0&&r[1]>=0&&r[1]<=1&&(n[0]=i[0]+r[0]*t[0],n[1]=i[1]+r[0]*t[1],!0))}function ce(e,t,i,s,n){const r=[t[0]-e[0],t[1]-e[1]],a=[];return!!le(e,r,i,[s[0]-i[0],s[1]-i[1]],a)&&(a[0]>=0&&a[0]<=1&&a[1]>=0&&a[1]<=1&&(n[0]=e[0]+a[0]*r[0],n[1]=e[1]+a[0]*r[1],!0))}function le(e,t,i,s,n){const r=re(t,s);if(Math.abs(r)<h.W.ZERO_LENGTH)return!1;const a=ae(i,e);return n[0]=re(a,s)/r,n[1]=re(a,t)/r,!0}function ue(e,t,i){const s=[i[0],i[1]];return R(e,s,[t[0]-e[0],t[1]-e[1]]),s[0]<=Math.max(e[0],t[0])&&s[0]>=Math.min(e[0],t[0])&&s[1]<=Math.max(e[1],t[1])&&s[1]>=Math.min(e[1],t[1])?de(i,s):Math.min(de(i,e),de(i,t))}function de(e,t){return Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)}function ge(e,t,i,s){i[0]=(e[0]+t[0])/2,i[1]=(e[1]+t[1])/2;const n=[t[0]-e[0],t[1]-e[1]],r=[n[1],-n[0]],a=Math.sqrt(r[0]*r[0]+r[1]*r[1]);return!(a<h.W.ZERO_LENGTH)&&(s[0]=r[0]/a,s[1]=r[1]/a,!0)}function pe(e,t){return[e[0],e[1],e[2],t]}function me(e){return Math.abs(1-s.squaredLength(e))<=h.W.ZERO_LENGTH_SQUARED}function fe(e,t){return t||(t=n.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=0,t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=0,t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}const Ie=666==i.j?[0,0,0]:null;function Ee(e,t){if(Ce(e,Ie),Math.abs(1-Math.abs(e[2]/Ie[0]))>h.W.ZERO_ANGLE){t[1]=-Math.asin(e[2]/Ie[0]);const i=Math.cos(t[1]);t[0]=Math.atan2(e[6]/(i*Ie[1]),e[10]/(i*Ie[2])),t[2]=Math.atan2(e[1]/(i*Ie[0]),e[0]/(i*Ie[0]))}else t[2]=0,e[2]<0?(t[1]=Math.PI/2,t[0]=t[2]+Math.atan2(e[4]/Ie[1],e[8]/Ie[2])):(t[1]=-Math.PI/2,t[0]=-t[2]+Math.atan2(-e[4]/Ie[1],-e[8]/Ie[2]))}function Se(e){const t=Math.cos(e[0]),i=Math.sin(e[0]),s=Math.cos(e[1]),r=Math.sin(e[1]),a=Math.cos(e[2]),o=Math.sin(e[2]),h=n.create();return h[0]=s*a,h[1]=s*o,h[2]=-r,h[4]=i*r*a-t*o,h[5]=i*r*o+t*a,h[6]=i*s,h[8]=t*r*a+i*o,h[9]=t*r*o-i*a,h[10]=t*s,h}function Te(e,t,i,s){const r=n.create(),a=t[2]/e[2],o=t[3]/e[3];c.w$.scale(r,[a,o,1]);const h=e[0]-i+e[2]/2,l=e[1]-s+e[3]/2,u=1-2*h/t[2],d=2*l/t[3]-1;return c.w$.translate(r,[u,d,0]),r}function De(e,t,i){const s=i-(t[1]+t[3]);return Te(e,t,t[0],s)}function Me(e,t){return Te(e,t,0,0)}function Ce(e,t){for(let i=0;i<3;++i){for(let t=0;t<3;++t)l[t]=e[4*i+t];t[i]=c.S4.length(l)}}function ye(e,t,i){const s=Math.cos(i),n=Math.sin(i);return[e[0]+s*t,e[1]+n*t]}function Pe(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])}function Ae(e,t){return e-2*Math.round((e-t)/(2*Math.PI))*Math.PI}function Oe(e,t){return e-2*Math.floor((e-t)/(2*Math.PI))*Math.PI}function ve(e,t){return e+2*Math.floor((t-e)/(2*Math.PI))*Math.PI}function Re(e,t,i,s){let n;return s-i<2*Math.PI?(n=Oe(e,i),n>s&&(n=Oe(n,s)-s>Oe(i,n)-n?i:s)):(n=Ae(e,t),n>s?n=Oe(n,i):n<i&&(n=ve(n,s))),n}function we(e){let t=1;for(;t<e;)t*=2;return t}function _e(e){return e.length?Ne(e):Number.isFinite(e)}function Ne(e){for(let t=0;t<e.length;++t)if(!Number.isFinite(e[t]))return!1;return!0}const be=666==i.j?1023:null,Le=511,Fe=1/Le;function xe(e){return e>Le?e-1024:e}function Be(e,t){const i=new Float32Array(3*e.length);let s=0;for(let n=0;n<e.length;++n){const r=t?t[n]*Fe:Fe,a=0|e[n];i[s++]=xe(a&be)*r,i[s++]=xe(a>>10&be)*r,i[s++]=xe(a>>20&be)*r}return i}},20042:function(e,t,i){i.d(t,{$:function(){return M},AD:function(){return P},Ab:function(){return U},Ae:function(){return ie},CO:function(){return G},Dw:function(){return _},E3:function(){return d},EK:function(){return u},FT:function(){return H},G0:function(){return te},Gn:function(){return c},HR:function(){return q},I$:function(){return O},JP:function(){return J},KE:function(){return A},KJ:function(){return ee},KZ:function(){return W},L4:function(){return f},PF:function(){return Z},PU:function(){return w},Pu:function(){return T},QF:function(){return p},QV:function(){return y},Tf:function(){return Q},U0:function(){return F},Ug:function(){return S},VO:function(){return X},VQ:function(){return k},W5:function(){return m},X:function(){return $},Z4:function(){return g},Zx:function(){return V},aT:function(){return v},b1:function(){return B},dO:function(){return L},fQ:function(){return R},nw:function(){return Y},pf:function(){return E},qT:function(){return I},sp:function(){return l},tn:function(){return x},ut:function(){return z},wK:function(){return se},y:function(){return C},zl:function(){return D}});var s=i(72751),n=i(81194),r=i(95417);if(666==i.j)var a=i(55858);var o=i(80462),h=i(6057);function c(e){const t=[];let i=!0;for(let s=0;s<e.length-2;s++)e[s+2]!==e[s+1]&&e[s+1]!==e[s]?(i&&(t.push(e[s]),t.push(e[s+1]),i=!1),t.push(e[s]),t.push(e[s+2]),t.push(e[s+1]),t.push(e[s+2])):i=!0;return t}function l(e,t){const i=new h.B7("createEdgesFromTriangleStrip"),s=c(e.indices);return i.report(),new r.MeshIncrement(r.PrimitiveType.LINES,e.points,s,t)}function u(e,t){if(e.primitiveType!==r.PrimitiveType.TRIANGLES)throw new Error("createEdgesFromTriangles can only be called with triangle primitives");const i=[];for(let t=0;t<e.indices.length;t+=3)i.push(e.indices[t]),i.push(e.indices[t+1]),i.push(e.indices[t]),i.push(e.indices[t+2]),i.push(e.indices[t+1]),i.push(e.indices[t+2]);return new r.MeshIncrement(r.PrimitiveType.LINES,e.points,i,t)}function d(e,t){t||(t=12),e||(e=12);const i=[],s=[],n=[],r=function(e,t,n){i.push(e),i.push(t),i.push(n),s.push(e),s.push(t),s.push(n)};let a,o;for(r(0,0,1),a=0;a<t;a++){const i=a*Math.PI*2/t,s=Math.cos(i),n=Math.sin(i);for(o=1;o<=e;o++){const t=o*Math.PI/(e+1),i=Math.sin(t);r(i*s,i*n,Math.cos(t))}}r(0,0,-1);const h=function(i,s){return e*(s%t)+i+1},c=function(){n.push(n[n.length-1])};for(a=0;a<t;a++){for(n.length>1&&c(),n.push(0),o=0;o<e;o++)n.push(h(o,a)),n.push(h(o,a+1));n.push(e*t+1),c(),n.length%2==0&&c()}return X(i,n,s)}function g(e){(!e||e<3)&&(e=12);const t=[],i=[],s=[],n=function(e){const s=Math.cos(e),n=Math.sin(e);t.push(s),t.push(n),t.push(1),i.push(s),i.push(n),i.push(0),t.push(s),t.push(n),t.push(0),i.push(s),i.push(n),i.push(0)};let r,a;for(r=0;r<e;r++)a=2*Math.PI*r/e,n(a);for(r=0;r<e;r++)s.push(2*r),s.push(2*r+1);return s.push(0),s.push(1),X(t,s,i)}function p(e){(!e||e<3)&&(e=12);const t=[],i=[],s=[],n=function(e){const s=Math.cos(e),n=Math.sin(e),r=[s,n,1];o.S4.normalize(r),t.push(0),t.push(0),t.push(1),i.push(r[0]),i.push(r[1]),i.push(r[2]),t.push(s),t.push(n),t.push(0),i.push(r[0]),i.push(r[1]),i.push(r[2])};let r,a;for(r=0;r<e;r++)a=2*Math.PI*r/e,n(a);for(r=0;r<e;r++)s.push(2*r),s.push(2*r+1);return s.push(0),s.push(1),X(t,s,i)}function m(e,t,i,s,n,a){const o=[e[0],e[1],e[2],t[0],t[1],t[2]],h=new r.MeshIncrement(r.PrimitiveType.LINES,o,[0,1],i);return s&&U(s,h),void 0!==n&&k(n,h),a&&W(a,h),h}function f(e,t,i,s,n,r){e.addIncrement(m(t,i,s,n,r))}function I(e,t,i,s){const n=new Float32Array(3*e.length),a=new Int32Array(2*e.length);for(let t=0;t<e.length;++t){for(let i=0;i<3;++i)n[3*t+i]=e[t][i];a[2*t]=t,a[2*t+1]=(t+1)%e.length}const o=new r.MeshIncrement(r.PrimitiveType.LINES,n,a,t);return i&&U(i,o),void 0!==s&&k(s,o),o}function E(e,t,i,s,n){const a=new Float32Array(3*e.length),o=new Int32Array(e.length);for(let t=0;t<e.length;++t){o[t]=t;for(let i=0;i<3;++i)a[3*t+i]=e[t][i]}const h=new r.MeshIncrement(r.PrimitiveType.LINES,a,o,t);return i&&U(i,h),void 0!==s&&k(s,h),n&&W(n,h),h}function S(e,t,i,s,n){e.addIncrement(E(t,i,s,n))}function T(e,t,i,s,n){const a=new r.MeshIncrement(r.PrimitiveType.POINTS,e,[0],t);return i&&U(i,a),void 0!==s&&k(s,a),n&&W(n,a),a}function D(e,t,i,s,r,h,c){let l=r;l||(l=a.fromValues(1,0,0),(0,n.areUnitVectorsParallel)(i,l)&&(l=[0,1,0]));const u=o.S4.normalize(o.S4.cross(i,l,a.create()));l=o.S4.normalize(o.S4.cross(u,i,a.create())),void 0===h&&(h=0),void 0===c&&(c=2*Math.PI);const d=new Float32Array(3*(s+1));let g=h;const p=(c-h)/s,m=a.create(),f=a.create(),I=a.create();for(let i=0;i<s+1;++i){const s=t*Math.cos(g),n=t*Math.sin(g);o.S4.add(e,o.S4.add(o.S4.scale(u,n,f),o.S4.scale(l,s,I),m),m);for(let e=0;e<3;++e)d[3*i+e]=m[e];g+=p}return d}function M(e,t,i,s){const n=D(e,t,i,s=Math.floor(Math.max(3,s)));let a;const o=n.length/3,h=new Float32Array(3*o);for(a=0;a<o;++a)for(let e=0;e<3;++e)h[3*a+e]=i[e];const c=s-2,l=new Int32Array(3*c);for(a=0;a<c;++a)l[3*a]=0,l[3*a+1]=a+1,l[3*a+2]=a+2;const u=new r.MeshIncrement(r.PrimitiveType.TRIANGLES,n,l);return u.normals=h,u}function C(e,t,i,s){const n=D(e,t,i,s=Math.floor(Math.max(3,s)));let a;const o=new Int32Array(2*s);for(a=0;a<s;++a)o[2*a]=a,o[2*a+1]=a+1;return o[o.length-1]=0,new r.MeshIncrement(r.PrimitiveType.LINES,n,o)}function y(e,t,i,s,n,a,o){const h=D(e,t,i,o=Math.floor(Math.max(3,o)),s,n,a),c=new Int32Array(2*o);for(let e=0;e<o;++e)c[2*e]=e,c[2*e+1]=e+1;return new r.MeshIncrement(r.PrimitiveType.LINES,h,c)}function P(e,t,i,s,n,r){const h=e,c=o.S4.add(o.S4.scale(t,s,a.create()),h),l=o.S4.add(o.S4.scale(t,n,a.create()),c),u=o.S4.add(o.S4.scale(i,-r,a.create()),c),d=o.S4.add(o.S4.scale(i,r,a.create()),c);return E([h,c,u,d,u,l,d,l])}function A(e,t,i,s,n,r){const h=e,c=o.S4.scale(t,.5*n,a.create()),l=o.S4.add(o.S4.scale(t,s,a.create()),h),u=o.S4.add(c,l,a.create()),d=o.S4.add(o.S4.scale(i,-r,a.create()),l),g=o.S4.add(o.S4.scale(i,r,a.create()),l),p=o.S4.add(o.S4.scale(t,n,a.create()),l),m=o.S4.add(d,c,a.create()),f=o.S4.add(g,c,a.create());return E([h,l,d,g,d,u,g,u,m,f,m,p,f,p])}function O(e,t,i,s,n,a,o,h){h=Math.floor(Math.max(3,h));const c=(0,r.concatenateFloat32Arrays)(D(e,t,s,h,n,a,o),D(e,i,s,h,n,a,o)),l=h+1,u=new Int32Array(2*l);for(let e=0;e<l;++e)u[2*e]=e,u[2*e+1]=l+e;const d=new r.MeshIncrement(r.PrimitiveType.TRIANGLE_STRIP,c,u);return B(s,d),d}function v(e,t,i,s,n,h,c){const l=o.S4.subtract(t,e,a.create()),u=o.S4.subtract(i,e,a.create()),d=o.S4.normalize(o.S4.cross(l,u,a.create())),g=new Float32Array(9),p=new Float32Array(9),m=function(e,t){for(let i=0;i<3;++i)g[3*e+i]=t[i],p[3*e+i]=d[i]};let f;if(m(0,e),m(1,t),m(2,i),n&&h&&c){f=new Float32Array(6);const e=function(e,t,i){f[2*e]=t,f[2*e+1]=i};e(0,n[0],n[1]),e(1,h[0],h[1]),e(2,c[0],c[1])}const I=new r.MeshIncrement(r.PrimitiveType.TRIANGLES,g,[0,1,2],s);return I.normals=p,I.textureCoordinates=f||null,I}function R(e,t,i,s,n,h){const c=o.S4.subtract(t,e,a.create()),l=o.S4.subtract(i,e,a.create()),u=o.S4.normalize(o.S4.cross(c,l,a.create())),d=new Float32Array(12),g=new Float32Array(12),p=function(e,t){for(let i=0;i<3;++i)d[3*e+i]=t[i],g[3*e+i]=u[i]};let m;if(p(0,e),p(1,t),p(2,o.S4.add(t,l,a.create())),p(3,i),n&&h){m=new Float32Array(8);const e=function(e,t,i){m[2*e]=t,m[2*e+1]=i};e(0,n[0],n[1]),e(1,h[0],n[1]),e(2,h[0],h[1]),e(3,n[0],h[1])}const f=new r.MeshIncrement(r.PrimitiveType.TRIANGLES,d,[0,1,2,0,2,3],s);return f.normals=g,f.textureCoordinates=m||null,f}function w(e,t,i,s,n){const r=o.S4.add(e,o.S4.scale(t,-1,a.create()),a.create());o.S4.add(r,i);const h=o.S4.add(r,o.S4.scale(t,2,a.create()),a.create()),c=o.S4.add(r,o.S4.scale(i,-2,a.create()),a.create()),l=o.S4.add(h,o.S4.scale(i,-2,a.create()),a.create());return E([r,c,c,l,l,h,h,r],"outlineLines",s,n)}function _(e,t,i,s,n,h){const c=o.S4.subtract(t,e,a.create()),l=o.S4.subtract(i,e,a.create()),u=o.S4.length(c),d=o.S4.length(l);o.S4.normalize(c),o.S4.normalize(l);const g=o.S4.normalize(o.S4.cross(c,l,a.create())),p=o.S4.add(o.S4.scale(c,u,a.create()),o.S4.scale(l,d,a.create())),m=o.S4.add(e,p,a.create()),f=(o.S4.add(o.S4.scale(p,.5,a.create()),e),o.S4.add(o.S4.add(o.S4.scale(c,s,a.create()),o.S4.scale(l,s,a.create())),e)),I=o.S4.add(o.S4.add(o.S4.scale(c,-s,a.create()),o.S4.scale(l,s,a.create())),t),E=o.S4.add(o.S4.add(o.S4.scale(c,s,a.create()),o.S4.scale(l,-s,a.create())),i),S=o.S4.add(o.S4.add(o.S4.scale(c,-s,a.create()),o.S4.scale(l,-s,a.create())),m),T=4*(n+1),M=new Float32Array(3*T),C=new Float32Array(3*T);let y=0;const P=function(e,t){for(let i=0;i<3;++i)M[3*e+i]=t[i],C[3*e+i]=g[i]},A=function(e,t,i){const r=D(e,s,g,n,c,t,i);for(let e=0;e<r.length/3;++e)P(y++,[r[3*e],r[3*e+1],r[3*e+2]])};A(I,-Math.PI/2,0),A(S,0,Math.PI/2),A(E,Math.PI/2,Math.PI),A(f,-Math.PI,-Math.PI/2);const O=[];for(let e=1;e<T-1;++e)O.push(0),O.push(e),O.push(e+1);const v=new r.MeshIncrement(r.PrimitiveType.TRIANGLES,M,O,h);return v.normals=C,v}const N=666==i.j?[0,1,2,3,3,4,4,5,6,7,7,8,8,9,10,11,11,12,12,13,14,15,15,16,16,17,18,19,19,20,20,21,22,23]:null,b=666==i.j?[-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1]:null;function L(e,t){const i=new Float32Array(72);let s=0;const n=new Float32Array(3),a=function(r,a){n[r]=a?t[r]:e[r];const o=0===r?2:1===r?0:1,h=0===r?1:1===r?2:0;for(let r=0;r<2;++r)for(let c=0;c<2;++c)n[o]=a!==(0===c)?e[o]:t[o],n[h]=0===r?e[h]:t[h],i.set(n,4*s*3+3*(2*r+c));++s};a(0,!1),a(0,!0),a(1,!1),a(1,!0),a(2,!1),a(2,!0);const o=new r.MeshIncrement(r.PrimitiveType.TRIANGLE_STRIP,i,N);return o.normals=b,o}function F(e,t){const i=[],s=[e,t];for(let e=0;e<2;e++)for(let t=0;t<2;t++)for(let n=0;n<2;n++)i.push(a.fromValues(s[e][0],s[t][1],s[n][2]));const n=[];for(let e=0;e<i.length;e++)for(let t=e+1;t<i.length;t++){const s=i[e],r=i[t],a=s[0]===r[0],o=s[1]===r[1],h=s[2]===r[2];(a&&o||a&&h||o&&h)&&(n.push(s),n.push(r))}return E(n)}function x(e,t,i,s,n,r,a){e.addIncrement(R(t,i,s,n,r,a))}function B(e,t){const i=t.vertexCount(),s=new Float32Array(3*i);for(let t=0;t<i;++t)for(let i=0;i<3;++i)s[3*t+i]=e[i];t.normals=s}function V(e,t){const i=t.vertexCount(),s=new Float32Array(2*i);for(let t=0;t<i;++t)for(let i=0;i<2;++i)s[2*t+i]=e[i];t.textureCoordinates=s}function U(e,t){const i=[255,255,255,255];for(let t=0;t<4&&t<e.length;++t)i[t]=255*e[t];G(i,t)}function G(e,t){const i=t.vertexCount(),n=new Uint8Array(4*i);let r;if(4===e.length){for(r=0;r<i;++r)for(let t=0;t<4;++t)n[4*r+t]=e[t];t.colors=n}else s.log.warn("Tried to add a color with the wrong number of channels to a mesh increment")}function H(e,t){G((0,r.convertIntToUcharArray)(e),t)}function k(e,t){const i=t.vertexCount(),s=new Float32Array(i);for(let t=0;t<i;++t)s[t]=e;t.primitiveSizes=s}function W(e,t){const i=t.vertexCount(),s=new Uint8Array(r.Attributes.PRIMITIVE_STYLE.dimension*i);let n;const a=[];for(n=0;n<r.Attributes.PRIMITIVE_STYLE.dimension;++n)n<e.length?a.push((0,r.clamp)(Math.round(e[n]),0,255)):a.push(0);for(n=0;n<i;++n)for(let e=0;e<r.Attributes.PRIMITIVE_STYLE.dimension;++e)s[n*r.Attributes.PRIMITIVE_STYLE.dimension+e]=a[e];t.primitiveStyles=s}function z(e,t,i,s){const n=new r.MeshIncrement(r.PrimitiveType.TRIANGLES,e,t,i);return s&&U(s,n),n}function X(e,t,i,s){const n=new r.MeshIncrement(r.PrimitiveType.TRIANGLE_STRIP,e,t);return i&&(n.normals=i),s&&U(s,n),n}function Z(e){return e.toFixed(10).slice(0,12)}function q(e){return Y(e[0],e[1],e[2])}function Y(e,t,i){return Z(e)+"_"+Z(t)+"_"+Z(i)}let K={},j=1;function Q(e,t){let i=a.dot(e,t);i<0&&(i=-i,t=a.fromValues(-t[0],-t[1],-t[2]));const s=q(t)+"_"+Z(i);return K[s]||(K[s]=j,j=Math.max((j+1)%24,1)),K[s]}function $(e,t){return J(Q(e,t))}function J(e){const t=(0,r.convertIntToUcharArray)(1<<e);return t[1]<<8|t[2]<<16|t[3]<<24}function ee(e){const t=J(e),i=(0,r.convertIntToUcharArray)(t);return(0,r.convertRGBA255ToRGBA)(i)}function te(){K={},j=1}function ie(e,t){const i=e.vertexCount(),s=new Uint8Array(4*i);let n,r;for(n=0;n<i;++n)for(let i=0;i<4;++i)r=4*n+i,e.colors?s[r]=e.colors[r]:s[r]=255,(r+1)%4==0&&(s[r]=255*t);return e.colors=s,e}function se(e){if(e.primitiveType!==r.PrimitiveType.TRIANGLES)return;const t=new Float32Array(3*e.indices.length),i=new Int32Array(e.indices.length),s=new Float32Array(3*e.indices.length),n=a.create(),o=a.create();for(let r=0;r<i.length;r+=3){i[r]=r;const h=e.getPoint(e.indices[r],t.subarray(3*r));i[r+1]=r+1;const c=e.getPoint(e.indices[r+1],t.subarray(3*(r+1)));i[r+2]=r+2;const l=e.getPoint(e.indices[r+2],t.subarray(3*(r+2))),u=a.cross(s.subarray(3*r),a.normalize(n,a.subtract(n,c,h)),a.normalize(o,a.subtract(o,l,h)));a.copy(s.subarray(3*(r+1)),u),a.copy(s.subarray(3*(r+2)),u)}e.points=t,e.indices=i,e.normals=s}},61252:function(e,t,i){i.d(t,{D:function(){return l},z:function(){return h}});var s=i(90316),n=i(45454),r=i(72751),a=i(83057);if(666==i.j)var o=i(45666);var h,c=i(80462);!function(e){e[e.UNKNOWN=-10]="UNKNOWN",e[e.REDUCED_DIMENSION_PRIORITY=-1]="REDUCED_DIMENSION_PRIORITY",e[e.CONSTRUCTION_PLANE=0]="CONSTRUCTION_PLANE",e[e.CONSTRUCTION_PLANE_EDGE=1]="CONSTRUCTION_PLANE_EDGE",e[e.PART_FACE=5]="PART_FACE",e[e.NON_MODIFIABLE_FACE=7]="NON_MODIFIABLE_FACE",e[e.NON_MODIFIABLE_EDGE=8]="NON_MODIFIABLE_EDGE",e[e.NON_MODIFIABLE_VERTEX=9]="NON_MODIFIABLE_VERTEX",e[e.SKETCH_FACE=10]="SKETCH_FACE",e[e.ORIGIN=15]="ORIGIN",e[e.SECTION_PLANE=16]="SECTION_PLANE",e[e.PART_EDGE=20]="PART_EDGE",e[e.POINT_BODY=25]="POINT_BODY",e[e.PART_VERTEX=30]="PART_VERTEX",e[e.DIMENSION=45]="DIMENSION",e[e.MATE_CONNECTOR=46]="MATE_CONNECTOR",e[e.DEGENERATE_SKETCH_EDGE=47]="DEGENERATE_SKETCH_EDGE",e[e.SKETCH_EDGE=50]="SKETCH_EDGE",e[e.INACTIVE_SKETCH_VERTEX=59]="INACTIVE_SKETCH_VERTEX",e[e.ACTIVE_SKETCH_VERTEX_CONSTRAINED=60]="ACTIVE_SKETCH_VERTEX_CONSTRAINED",e[e.ACTIVE_SKETCH_VERTEX_UNCONSTRAINED=61]="ACTIVE_SKETCH_VERTEX_UNCONSTRAINED",e[e.UI=70]="UI"}(h||(h={}));class l{constructor(e,t,i,s){this.occurrenceId=t,this.location=i,this.usage=s,this.deterministicId=null,this.partId=null,this.locationCount=1,this.locationsSinceSample=0,this.distance=1,this.coverage=0,this.fromPass=0,this.isFromActiveSketch=!1,this.entityMetaData=null,this.bodyMetaData=null,this.uiSelection=null,this.occurrence=null,this.featureIdList=null,this.isPickThrough=null,this.primitiveId=e.slice(0),this.locationSum=o.clone(i),this.locationSamples=[this.location],this.pickedOccurrenceId=t}incorporateLocation(e){c.gv.add(this.locationSum,e,this.locationSum),++this.locationCount;const t=this.locationSamples.length<10?5:this.locationSamples.length<20?50:500;this.locationsSinceSample>=t?(this.locationSamples.push(e),this.locationsSinceSample=0):++this.locationsSinceSample}determineBestLocation(){const e=c.gv.scale(this.locationSum,1/this.locationCount,o.create());let t=1/0;for(let i=0;i<this.locationSamples.length;++i){const s=c.gv.distanceSquared(e,this.locationSamples[i]);s<t&&(this.location=this.locationSamples[i],t=s)}}isUIPick(){return!!this.uiSelection}getUISelection(){return this.uiSelection?this.uiSelection.uiElement:null}isEntityPick(){return!!this.entityMetaData}isBodyPick(){return!!this.bodyMetaData}isModelPick(){return this.isBodyPick()||this.isEntityPick()}getBodyId(){return this.bodyMetaData?this.bodyMetaData.id:this.entityMetaData?this.entityMetaData.getBodyId():null}getOccurrence(){return this.occurrence}getId(){return this.primitiveId+s.ID_SEPARATOR+this.occurrenceId}getModelSelection(){if(this.isEntityPick())return new n.Y1(a.lQt.ENTITY,this.deterministicId,this.occurrence,{entityMetaData:this.entityMetaData,source:n.Hw.PICK,sourcePick:this,usage:this.usage,featureIdList:this.featureIdList,name:this.entityMetaData.getName()});if(this.isBodyPick())return new n.Y1(a.lQt.BODY,this.deterministicId,this.occurrence,{bodyMetaData:this.bodyMetaData,source:n.Hw.PICK,sourcePick:this,usage:this.usage,name:this.bodyMetaData.getName()});const e=this.isUIPick()?this.uiSelection.getModelSelection():null;return e&&(e.sourcePick||(e.sourcePick=this),e.source=n.Hw.PICK,e.usage=this.usage),e}getPickPriority(){if(this.isUIPick()){const e=this.uiSelection.getPickPriority();return null!==e?e:h.UI}if(this.entityMetaData){if(this.entityMetaData.isFromOrigin())return h.ORIGIN;if(this.entityMetaData.isPointEntity())return h.POINT_BODY;if(this.entityMetaData.isFromSketch()){if(this.entityMetaData.isFace())return h.SKETCH_FACE;if(this.entityMetaData.isEdge())return h.SKETCH_EDGE;if(this.entityMetaData.isDegenerateEdge())return h.DEGENERATE_SKETCH_EDGE;{if(!this.isFromActiveSketch)return h.INACTIVE_SKETCH_VERTEX;const e=this.entityMetaData.getSketchSolveStatus();return e===a.ea7.FIXED||e===a.ea7.OVER_DEFINED||e===a.ea7.WELL_DEFINED?h.ACTIVE_SKETCH_VERTEX_CONSTRAINED:h.ACTIVE_SKETCH_VERTEX_UNCONSTRAINED}}if(this.entityMetaData.isFromBody())return this.entityMetaData.getBodyMetaData()&&!this.entityMetaData.getBodyMetaData().isModifiableBody()?this.entityMetaData.isFace()?h.NON_MODIFIABLE_FACE:this.entityMetaData.isEdge()?h.NON_MODIFIABLE_EDGE:h.NON_MODIFIABLE_VERTEX:this.entityMetaData.isFace()?h.PART_FACE:this.entityMetaData.isEdge()?h.PART_EDGE:h.PART_VERTEX}return h.UNKNOWN}getIncrementId(){if(this.isModelPick()){if(this.deterministicId)return this.deterministicId;r.log.warn("Found a model pick without a valid entity id")}else{if(this.uiSelection)return this.uiSelection.meshIncrementId;if(this.primitiveId)return this.primitiveId.toString();r.log.warn("Found a pick without an owner from which to retrieve an increment id")}return""}getEntityMetaData(){if(this.entityMetaData)return this.entityMetaData;const e=this.getModelSelection();return e?e.getEntityMetaData():null}getDeterministicId(){if(this.deterministicId)return this.deterministicId;const e=this.getModelSelection();return e?e.getDeterministicId():""}setIsPickThrough(e){this.isPickThrough=e}canPickThrough(e,t,i){if(i&&i.pickHiddenOccurrences&&t.isPickFromHiddenOccurrence(this))return!0;if(null===this.isPickThrough)if(this.uiSelection)this.isPickThrough=this.uiSelection.canPickThrough();else{const s=this.getEntityMetaData();if(s){let n=s.isTranslucent();if(!!i&&i.altKey&&s.isFromBody()&&s.isFace()){const e=t.getModelViewManagers().getManagerForUsage(this.usage).getPartStudioDataFromOccurrence(this.occurrence).getBodyComponent().getFaceColor(this.deterministicId,this.occurrenceId);n=!!e&&e[3]<1}this.isPickThrough=n&&e!==a.P1.HIDDEN_LINE_REMOVED||s.isFromSketch()}else this.isPickThrough=!1}return this.isPickThrough}getOccurrenceId(){return this.occurrenceId}}},68386:function(e,t,i){i.d(t,{G:function(){return r},Z:function(){return a}});var s=i(45454),n=i(61252);function r(e,t){if(!e&&!t)return 0;if(e&&!t)return-1;if(!e&&t)return 1;const i=e.getPickPriority(),r=t.getPickPriority();if(i>r)return-1;if(i<r)return 1;if(i!==n.z.INACTIVE_SKETCH_VERTEX&&i!==n.z.ACTIVE_SKETCH_VERTEX_CONSTRAINED&&i!==n.z.ACTIVE_SKETCH_VERTEX_UNCONSTRAINED){if(e.fromPass<t.fromPass)return-1;if(e.fromPass>t.fromPass)return 1}const a=(1+e.distance)*(1-e.coverage),o=(1+t.distance)*(1-t.coverage);if(a<o)return-1;if(a>o)return 1;if((i===n.z.INACTIVE_SKETCH_VERTEX||i===n.z.ACTIVE_SKETCH_VERTEX_CONSTRAINED||i===n.z.ACTIVE_SKETCH_VERTEX_UNCONSTRAINED)&&e.deterministicId&&t.deterministicId){const i=s.X8.unpackDetId(e.deterministicId),n=s.X8.unpackDetId(t.deterministicId);if(i.operationIdx<n.operationIdx)return-1;if(i.operationIdx>n.operationIdx)return 1;if(i.entityIdx<n.entityIdx)return-1;if(i.entityIdx>n.entityIdx)return 1}return 0}function a(e,t){return e.sort(((e,i)=>{const s=e.getModelSelection(),n=i.getModelSelection();if(!s||!n)return r(e,i);if(s.isPlane()||n.isPlane())return r(e,i);if(s.isFace()!==n.isFace())return r(e,i);const a=t(e);return a===t(i)?r(e,i):a?1:-1}))}},91851:function(e,t,i){i.d(t,{Y:function(){return s}});class s{constructor(){this.resultRange1=[0,0,null],this.resultRange2=[0,0,null],this.nextResult=null}hasMoreRanges(){return!!this.nextResult}getNextRange(){const e=this.nextResult;return this.nextResult=this.findNextRange(),e}getStorageForNextResult(){const e=this.nextResult===this.resultRange1?this.resultRange2:this.resultRange1;return e[2]=null,e}}},68669:function(e,t,i){i.d(t,{Y:function(){return u}});var s=i(93103),n=i(20042),r=i(83861),a=i(95417);const o=i(17922).default.getManager(),h=new r.hF({primitiveType:a.PrimitiveType.TRIANGLES,isPickable:!1,isHighlightable:!1,isTwoSided:!0,isShowThrough:!1,isDepthTested:!0,zOffset:-1}),c=new r.hF({primitiveType:a.PrimitiveType.TRIANGLES,isPickable:!1,isHighlightable:!1,isTwoSided:!0,isShowThrough:!1,isDepthTested:!0,primitivesHaveTransparency:!0,zOffset:-2}),l=new r.hF({primitiveType:a.PrimitiveType.LINES,isPickable:!1,isHighlightable:!1,isTwoSided:!0,isShowThrough:!1,isDepthTested:!0,zOffset:-3});class u extends(666==i.j?s.u1:null){constructor(e,t,i,s,n,r){super(r),this.checkerboardScale=1,this.showColor=!0,this.needsUpdate=!0,this.showGraphics=!0,this.points=e,this.uvs=t,this.facets=i,this.edges=s,this.distortions=n,this.showFacets=!1,this.showEdges=!0,this.showDistortions=!0,this.showCheckerboard=!1,this.showColor=!0,this.checkerboardTexture=this.createTexture(),this.checkerboardTexture.hasTransparency=!1,this.textureMaterial=(0,a.createTextureMaterial)(),this.textureMaterial.ambientTexture=this.checkerboardTexture}onViewWillDraw(e,t){this.updateGraphics()}updateGraphics(){if(!this.needsUpdate)return;if(this.removeMeshIncrements(),!this.showGraphics)return;const e=[],t=[];for(const t of this.points)e.push(t[0],t[1],t[2]);for(const e of this.uvs)t.push(e[0]*this.checkerboardScale,e[1]*this.checkerboardScale);if(this.showColor||this.showCheckerboard){const i=this.showColor||this.showCheckerboard?o.getColor("FLATTENED_SURFACE_COLOR"):[0,0,0,0],c=(0,n.ut)(e,this.facets,"flattendisp",i);let l;c.textureCoordinates=t,l=this.showCheckerboard?new r.hF({primitiveType:a.PrimitiveType.TRIANGLES,isPickable:!1,isHighlightable:!1,isTwoSided:!0,isShowThrough:!1,isDepthTested:!0,material:this.textureMaterial}):h,this.updateMeshIncrement("flattendispinc",s.ZJ,c,l)}if(this.showDistortions){const t=[];for(const e of this.distortions){let i=[255,0,0,0];e>0?i[3]=e>=1?255:Math.round(255*e):e<0&&(i=[0,0,255,Math.round(255*-e)],e<=-1&&(i[3]=255)),t.push(...i)}const i=(0,n.ut)(e,this.facets,"distortions",[0,0,0,0]);i.colors=t;const r=c;this.updateMeshIncrement("distortioninc",s.ZJ,i,r)}if(this.showFacets){const e=[],t=this.facets.length/3;for(let i=0;i<t;i++){const t=this.facets[3*i],s=this.facets[3*i+1],n=this.facets[3*i+2],r=[t,s,n];if(t!==s&&s!==n&&n!==t)for(let t=0;t<3;t++){const i=this.points[r[t]],s=this.points[r[(t+1)%3]];e.push(i),e.push(s)}}const i=(0,n.pf)(e,"facets",o.getColor("FLATTENED_SURFACE_FACET_COLOR"));this.updateMeshIncrement("facetsinc",s.ZJ,i,l)}if(this.showEdges){const e=[],t=this.edges.length;for(let i=0;i<t;i++){const t=this.points[this.edges[i]];e.push(t)}const i=(0,n.pf)(e,"edges",o.getColor("FLATTENED_SURFACE_EDGE_COLOR"));this.updateMeshIncrement("edgesinc",s.ZJ,i,l)}this.needsUpdate=!1}remove(){this.textureMaterial&&(this.textureMaterial.destroy(),this.textureMaterial=null,this.checkerboardTexture.destroy(),this.checkerboardTexture=null),super.remove()}static createTextureDef(e){const t=[];for(let e=0;e<8;e++)for(let i=0;i<8;i++){const s=e%2==i%2?0:255;t[4*(8*e+i)]=s,t[4*(8*e+i)+1]=s,t[4*(8*e+i)+2]=s,t[4*(8*e+i)+3]=255}const i=new Uint8Array(t),s=new a.TextureDefinition(e);return s.bytes=i,s.width=8,s.height=8,s.wrapS=e.REPEAT,s.wrapT=e.REPEAT,s}createTexture(){return new a.Texture(this.viewer,u.createTextureDef)}touch(){this.needsUpdate=!0,this.viewer?.requestDraw()}getFitBounds(){const e=this.getInstantiatedMeshIncrement("flattendispinc")?.meshIncrement.getBounds();return e}}},83861:function(e,t,i){i.d(t,{DO:function(){return u},Gy:function(){return I},NB:function(){return E},hF:function(){return p},hn:function(){return f}});var s=i(95417),n=i(17922),r=i(85036);if(666==i.j)var a=i(73511);var o=i(72751);if(666==i.j)var h=i(18265);var c=i(80462);const l=n.default.getManager();var u;!function(e){e[e.LOWER=0]="LOWER",e[e.DEFAULT=1]="DEFAULT",e[e.HIGHER=2]="HIGHER",e[e.HIGHEST=3]="HIGHEST",e[e.COUNT=4]="COUNT"}(u||(u={}));const d=Math.ceil(Math.log(u.COUNT)/Math.log(2)),g=new s.BitShiftId;class p{constructor(e){this.isVisible=!0,this.isPickable=!0,this.isHighlightable=!0,this.isTwoSided=!1,this.isTintedByCompare=!1,this.isShowThrough=!1,this.isDepthTested=!0,this.isStencilTested=!1,this.isStencilWritten=!0,this.clippedBySectionPlanes=!1,this.addsToSectionMask=!0,this.primitivesHaveTransparency=!1,this.zOffset=0,this.pickZOffset=0,this.addsToBounds=!0,this.includedInBlend=!1,this.debugId="",this.priority=u.DEFAULT,this.primitiveType=s.PrimitiveType.PRIMITIVE_UNKNOWN,this.material=s.DEFAULT_MATERIAL,this.initializeFromProperties(e),this.updateId()}initializeFromProperties(e){e&&(0,r.overwriteMatchingProperties)(this,e),e?.hasOwnProperty("pickZOffset")||(this.pickZOffset=this.zOffset),e?.hasOwnProperty("isStencilWritten")||this.primitiveType!==s.PrimitiveType.TRIANGLES&&this.primitiveType!==s.PrimitiveType.TRIANGLE_STRIP||(this.isStencilWritten=!1)}clone(){return new p(this)}cloneAndModify(e,t){const i=new p(this);return t||(i.debugId=void 0),i.initializeFromProperties(e),i.updateId(),i}toString(e){return e?(this.primitiveType!==s.PrimitiveType.PRIMITIVE_UNKNOWN?"primitiveType:"+(0,s.getPrimitiveTypeDescription)(this.primitiveType):"")+(this.material?",m:"+this.material.id:""):"NodeProperties: primitiveType:"+(0,s.getPrimitiveTypeDescription)(this.primitiveType)+",m:"+(this.material?this.material.id:"null")+",iV:"+this.isVisible+",iP:"+this.isPickable+",iH:"+this.isHighlightable+",iTS:"+this.isTwoSided+",iTBC:"+this.isTintedByCompare+",iShTh:"+this.isShowThrough+",iDT:"+this.isDepthTested+",iStTe:"+this.isStencilTested+",iStWr:"+this.isStencilWritten+",cBSP:"+this.clippedBySectionPlanes+",aTSM:"+this.addsToSectionMask+",pHT:"+this.primitivesHaveTransparency+",p:"+this.priority+",zO:"+this.zOffset+",pZO:"+this.pickZOffset+",aTB:"+this.addsToBounds+",iIB:"+this.includedInBlend}makeSceneDebugObject(){const e=[];return e.push((0,s.createTextDebugObject)("primitiveType",(0,s.getPrimitiveTypeDescription)(this.primitiveType))),e.push(this.material?this.material.makeSceneDebugObject():(0,s.createTextDebugObject)("material",null)),(0,s.addChildDebugObjectsFromProperties)(e,this,{id:!0,primitiveType:!0,material:!0}),{text:"[Node properties] "+this.id+" "+this.toString(!0),children:e}}updateId(){g.reset(),g.addBoolean(this.isVisible),g.addBoolean(this.isPickable),g.addBoolean(this.isHighlightable),g.addBoolean(this.isTwoSided),g.addBoolean(this.isShowThrough),g.addBoolean(this.isDepthTested),g.addBoolean(this.isStencilTested),g.addBoolean(this.isStencilWritten),g.addBoolean(this.clippedBySectionPlanes),g.addBoolean(this.addsToSectionMask),g.addBoolean(this.primitivesHaveTransparency),g.addBoolean(this.includedInBlend),g.addNumber(this.priority,d),g.addNumber(this.primitiveType,s.PRIMITIVE_TYPE_BITS),g.addNumber(this.zOffset+31,6),g.addNumber(this.pickZOffset+31,6),Math.abs(this.zOffset)>31&&o.log.warn("zOffset "+this.zOffset+" could result in a duplicate node id, resulting in bad z offset state"),Math.abs(this.pickZOffset)>31&&o.log.warn("pickZOffset "+this.pickZOffset+" could result in a duplicate node id, resulting in bad pick z offset state"),g.addBoolean(this.addsToBounds);let e=g.getId();this.material&&(e=g.getIdWithIdAppended(this.material.id)),this.id=e}}let m=666==i.j?[]:null;function f(e){m.push(e)}function I(){for(let e=0;e<m.length;++e){const t=m[e];t&&!t.getParent()&&t.onPermanentlyRemoved()}m=[]}class E{constructor(e,t,i){this.id=e,this.pose=null,this.children=null,this.childMap={},this.parent=null,this.areBoundsDamaged=!1,this.nodeOccurrences=null,this.usage=void 0!==i?i:s.BTGraphicsUsage.BASE,this.properties=new p(t),this.boundingBox=new s.BoundingBox}integrityCheck(){this.nodeOccurrences&&this.children&&this.children.length>0&&o.log.error("Found non-leaf scenegraph node with a node occurrences. Node id: "+this.id)}getId(){return this.id}setPose(e){e&&this.pose&&h.equals(e,this.pose)||(this.pose=e,this.damageBounds())}getPose(){return this.pose}damageBounds(){this.areBoundsDamaged||(this.areBoundsDamaged=!0,this.parent&&this.parent.damageBounds())}getUsage(){return this.usage}updateBounds(e){const t=!!e&&!!e.includeHiddenBounds;if(this.areBoundsDamaged||t)if(this.boundingBox.reset(),this.nodeOccurrences){if(this.getAddsToBounds()||t){const t=this.nodeOccurrences.getKeyValues();for(let i=0;i<t.length;i+=2)t[i+1].addBounds(this.boundingBox,e)}this.areBoundsDamaged=!1}else if(this.children){this.areBoundsDamaged=!1;for(let t=0;t<this.children.length;++t){const i=this.children[t].getBoundingBox(e);this.children[t].getIsVisible()&&this.children[t].getAddsToBounds()&&(0,s.isValidForBounding)(i)&&(this.boundingBox.addBox(i,this.pose),this.areBoundsDamaged=this.areBoundsDamaged||this.children[t].areBoundsDamaged)}}}getBoundingBox(e){return(this.areBoundsDamaged||e&&e.includeHiddenBounds)&&this.updateBounds(e),this.boundingBox}getOccurrenceBounds(e,t){if(this.getAddsToBounds())if(this.nodeOccurrences){const i=this.nodeOccurrences.get(e);i&&i.addBounds(t)}else if(this.children)for(let i=0;i<this.children.length;++i)this.children[i].getOccurrenceBounds(e,t)}addChild(e,t){if(e){switch(this.children||(this.children=[]),void 0===t?this.children.push(e):(t=(0,s.clamp)(Math.round(t),0,this.children.length),this.children.splice(t,0,e)),this.childMap[e.id]=e,e.parent=this,e.usage){case s.BTGraphicsUsage.PREVIEW:this.usage!==s.BTGraphicsUsage.PREVIEW&&o.log.warn("Adding PREVIEW node to non-PREVIEW node (usage "+this.usage+")");break;case s.BTGraphicsUsage.BASE:e.usage=this.usage}this.damageBounds(),this.integrityCheck()}else o.log.warn("A scenegraph node cannot add a null child")}findOrCreateChildNodeByProperties(e){const t=e.id.toString();let i=this.getChildById(t);return i||(i=new E(t.toString(),e,this.usage),this.addChild(i)),i}addOccurrenceGeometryToNode(e,t,i,s,n,r){const a=this.findOrCreateChildNodeByProperties(e),o=a.findOrCreateNodeOccurrenceByData(t).addStyledMeshRanges(i,s,n,r);return a.damageBounds(),o}findOrCreateNodeOccurrenceByData(e){this.nodeOccurrences||(this.nodeOccurrences=new a.N);let t=this.nodeOccurrences.get(e.getOccurrenceId());return t||(t=new s.NodeOccurrence(this,e),this.nodeOccurrences.set(e.getOccurrenceId(),t)),t}removeOccurrenceFromNode(e,t){const i=e.id.toString(),s=this.getChildById(i);s&&s.removeOccurrence(t),this.cleanEmptyMeshNodes()}hasNonIsolatedOccurrences(){if(this.nodeOccurrences){const e=this.nodeOccurrences.getKeyValues();for(let t=1;t<e.length;t+=2){if(!e[t].occurrenceData.getIsolated())return!0}}return!1}removeOccurrence(e){if(e=+e,this.nodeOccurrences){const t=this.nodeOccurrences.get(e);t&&(t.destroy(),this.nodeOccurrences.delete(e),this.damageBounds())}else{for(let t=0;this.children&&t<this.children.length;++t)this.children[t].removeOccurrence(e);this.cleanEmptyMeshNodes()}}removeMeshGroupFromOccurrence(e,t){if(t=+t,this.isMeshNode()){const i=this.nodeOccurrences.get(t);if(i){i.removeAllChildrenForMeshGroup(e)&&(i.isEmpty&&(i.destroy(),this.nodeOccurrences.delete(t)),this.damageBounds())}}else{for(let i=0;this.children&&i<this.children.length;++i)this.children[i].removeMeshGroupFromOccurrence(e,t);this.cleanEmptyMeshNodes()}}removeChild(e,t){if(!this.children)return;const i=this.children.indexOf(e);i>-1&&(delete this.childMap[e.id],this.children.splice(i,1),e.onRemoved(t),this.damageBounds())}removeChildById(e){if(!this.children)return;const t=this.childMap[e];t&&this.removeChild(t)}removeAllChildren(){if(this.children){for(let e=0;e<this.children.length;++e)this.children[e].onRemoved();this.childMap={},this.children=[],this.damageBounds()}}remove(){this.parent?this.parent.removeChild(this):o.log.error("Trying to remove parentless child")}onRemoved(e){this.parent=null,e||f(this)}onPermanentlyRemoved(){if(this.children)for(let e=0;e<this.children.length;++e)this.children[e]&&this.children[e].onPermanentlyRemoved();else if(this.nodeOccurrences){const e=this.nodeOccurrences.getKeyValues();for(let t=0;t<e.length;t+=2)e[t+1].destroy();this.nodeOccurrences=null}}cleanEmptyMeshNodes(){if(this.children)for(let e=0;e<this.children.length;++e)this.children[e].isMeshNode()?this.children[e].isEmptyMeshNode()&&this.children[e].remove():this.children[e].cleanEmptyMeshNodes()}getParent(){return this.parent}getChildById(e){return this.children&&this.childMap[e]||null}getChildrenWithPrefix(e){if(!this.children)return null;let t=null;for(const i in this.childMap)0===i.indexOf(e)&&(t=t||[],t.push(this.childMap[i]));return t}getChildByIndex(e){return!this.children||e>=this.children.length||e<0?null:this.children[e]}getChildCount(){return this.children?this.children.length:0}isMeshNode(){return!!this.nodeOccurrences}isEmptyMeshNode(){return this.isMeshNode()&&0===this.nodeOccurrences.size}getPrimitiveType(){return this.properties?this.properties.primitiveType:s.PrimitiveType.PRIMITIVE_UNKNOWN}isFaces(){if(!this.isMeshNode())return!1;const e=this.getPrimitiveType();return e===s.PrimitiveType.TRIANGLES||e===s.PrimitiveType.TRIANGLE_STRIP}isEdges(){if(!this.isMeshNode())return!1;const e=this.getPrimitiveType();return e===s.PrimitiveType.LINES||e===s.PrimitiveType.INFINITE_LINES}isPoints(){if(!this.isMeshNode())return!1;return this.getPrimitiveType()===s.PrimitiveType.POINTS}isSilhouettes(){if(!this.isMeshNode())return!1;return this.getPrimitiveType()===s.PrimitiveType.SILHOUETTES}getProperties(){return this.properties}getMaterial(){return this.properties.material}getIsVisible(){return this.properties.isVisible&&(!this.properties.material||this.properties.material.isVisible)}getIsPickable(){return this.properties.isPickable}getIsHighlightable(){return this.properties.isHighlightable}getIsTwoSided(){return this.properties.isTwoSided}getIsTintedByCompare(){return this.properties.isTintedByCompare}getIsShowThrough(){return this.properties.isShowThrough}getIsDepthTested(){return this.properties.isDepthTested}getIsStencilTested(){return this.properties.isStencilTested}getIsStencilWritten(){return this.properties.isStencilWritten}getClippedBySectionPlanes(){return this.properties.clippedBySectionPlanes}getAddsToSectionMask(){return this.properties.addsToSectionMask}hasTransparency(){return this.properties.primitivesHaveTransparency||!!this.properties.material&&this.properties.material.hasTransparency()}getRenderOrderPriority(){return this.properties.priority}getIncludedInBlend(){return this.properties.includedInBlend}getAddsToBounds(){return this.properties.addsToBounds}getZOffset(){return this.properties.zOffset}getPickZOffset(){return this.properties.pickZOffset}draw(e){if((!e.isHighlighting()||this.getIsHighlightable())&&(e.isHighlighting()||e.isPicking()||this.getIsVisible())&&(this.children||e.nodeFilter(this))){if(this.pose&&e.pushModelViewMatrix(c.w$.multiply(e.getModelViewMatrix(),this.pose,h.create())),this.isMeshNode()){this.properties.material&&e.pushMaterial(this.properties.material),e.activateTopShader();const t=e.getActiveShader();if(!t)return this.properties.material&&e.popMaterial(),void(this.pose&&e.popModelViewMatrix());e.setMaterial(),e.updateModelviewUniforms(),e.setUsage(this.usage);const i=this.nodeOccurrences?this.nodeOccurrences.getKeyValues():null;if(i&&e.isHighlighting()){this.isEdges()?(e.getUseHiddenOpacityForEdgeHighlights()?(t.uniform1f("uHighlightOpacity",l.getNumber("HIGHLIGHT_HIDDEN_EDGE_OPACITY")),t.uniform1f("uHighlightBorderOpacity",l.getNumber("HIGHLIGHT_HIDDEN_EDGE_BORDER_OPACITY"))):(t.uniform1f("uHighlightOpacity",l.getNumber("HIGHLIGHT_EDGE_OPACITY")),t.uniform1f("uHighlightBorderOpacity",l.getNumber("HIGHLIGHT_EDGE_BORDER_OPACITY"))),e.setLineWidth(this.properties.material.lineWidth),e.setLineStipple(this.properties.material.lineStipple)):this.isPoints()&&(t.uniform1f("uHighlightOpacity",l.getNumber("HIGHLIGHT_POINT_OPACITY")),e.setPointSize(this.properties.material.pointSize)),e.setFacesToCull(s.CullFace.NONE);for(let t=0;t<i.length;t+=2)i[t+1].draw(e);e.setFacesToCull(s.CullFace.BACK)}if((this.getIsVisible()||e.isPicking())&&!e.isHighlighting()&&(this.getIsTwoSided()||e.isPickingBackFaces()?e.setFacesToCull(s.CullFace.NONE):e.setFacesToCull(s.CullFace.BACK),this.isPoints()?(e.setPointSize(this.properties.material.pointSize),e.setPointFont(this.properties.material.pointFont)):(this.isEdges()||this.isSilhouettes())&&(e.setLineWidth(this.properties.material.lineWidth),e.setLineStipple(this.properties.material.lineStipple)),t.uniform1i("uClippedBySectionPlanes",this.getClippedBySectionPlanes()?1:0),t.uniform1f("uAddsToSectionMask",this.getAddsToSectionMask()?1:0),i))for(let t=0;t<i.length;t+=2)i[t+1].draw(e);this.properties.material&&e.popMaterial()}else if(this.children)for(let t=0;t<this.children.length;++t)this.children[t].draw(e);this.pose&&e.popModelViewMatrix()}}passesNodeFilter(e){if(e(this))return!0;if(this.children)for(let t=0;t<this.children.length;++t)if(this.children[t].passesNodeFilter(e))return!0;return!1}walk(e){if(e(this))return!0;let t=!1;for(let i=0;i<this.getChildCount()&&!t;++i)t=this.getChildByIndex(i).walk(e);return t}getIdPath(){let e="",t=this;for(;t;)e.length>0&&(e="."+e),e=t.id+e,t=t.parent;return e}makeSceneDebugObject(e){const t=this.properties.debugId;let i="Node: "+(t||this.getId());this.properties.primitiveType!==s.PrimitiveType.PRIMITIVE_UNKNOWN&&(i+=" ",i+=this.properties.toString(!0));const n=[];n.push(this.properties.makeSceneDebugObject());const r=this.getBoundingBox();if(r&&n.push(r.makeSceneDebugObject()),this.isMeshNode()){const t=this.nodeOccurrences.getKeyValues();for(let i=0;i<t.length;i+=2)n.push(t[i+1].makeSceneDebugObject(e+1))}else for(let t=0;t<this.getChildCount();t++)n.push(this.getChildByIndex(t).makeSceneDebugObject(e+1));return{text:i,children:n,state:{opened:e<2}}}setVisible(e){if(this.getIsVisible()!==e){const t=this.properties.cloneAndModify({isVisible:e},!0);this.properties=t}}}},40315:function(e,t,i){i.d(t,{I:function(){return s}});class s{constructor(){this.rangeSet=null,this.index=0}resetForRangeSet(e){this.rangeSet=e,this.index=0}hasMoreRanges(){return!!this.rangeSet&&this.index<this.rangeSet.length}getNextRange(){return this.hasMoreRanges()?this.rangeSet[this.index++]:null}}},61449:function(e,t,i){if(i.d(t,{Gb:function(){return r},TS:function(){return o},bg:function(){return n},d8:function(){return a}}),666==i.j)var s=i(73511);class n{constructor(){this.attributeSettings=new s.N,this.floatUniformSettings=new s.N}copyFrom(e){this.attributeSettings.setAll(e.attributeSettings),this.floatUniformSettings.setAll(e.floatUniformSettings)}clone(){const e=new n;return e.copyFrom(this),e}clear(){this.attributeSettings.clear(),this.floatUniformSettings.clear()}equals(e){return!!e&&(this===e||!!r(this.attributeSettings,e.attributeSettings)&&!!r(this.floatUniformSettings,e.floatUniformSettings))}setAttribute(e,t){this.attributeSettings.set(e,t)}getAttribute(e){return this.attributeSettings.get(e)}setFloatUniform(e,t){this.floatUniformSettings.set(e,t)}applyStyle(e){const t=e.getActiveShader();if(!t)return;const i=this.attributeSettings.getKeyValues();for(let e=0;e<i.length;e+=2)t.setAttribute(i[e],i[e+1]);const s=this.floatUniformSettings.getKeyValues();for(let e=0;e<s.length;e+=2)t.setFloatUniform(s[e],s[e+1])}toString(){let e="Style: ";const t=this.attributeSettings.getKeyValues(),i=", ";for(let s=0;s<t.length;s+=2){const n=t[s],r=t[s+1];s>0&&(e+=i),e+=n.name+": "+r}t.length>0&&(e+=i);const s=this.floatUniformSettings.getKeyValues();for(let t=0;t<s.length;t+=2)t>0&&(e+=i),e+=s[t]+": "+s[t+1];return e}}function r(e,t){if(e.size!==t.size)return!1;const i=e.getKeyValues();for(let e=0;e<i.length;e+=2){const s=i[e],n=i[e+1],r=t.get(s);if(n!==r){if(void 0===r)return!1;if(void 0===n.length&&void 0===r.length)return!1;if(n.length!==r.length)return!1;for(let e=0;e<n.length;++e)if(n[e]!==r[e])return!1}}return!0}function a(e,t){return e&&t?e.equals(t):!(e||t)}function o(e,t,i){return e?t?(i.clear(),i.copyFrom(e),i.copyFrom(t),i):e:t}},5947:function(e,t,i){if(i.d(t,{q:function(){return r}}),666==i.j)var s=i(91851);if(666==i.j)var n=i(61449);class r extends(666==i.j?s.Y:null){constructor(e){super(),this.styleMergeStorage=[],this.currentStyleMergeStoragePointer=0;for(let t=0;t<e;++t)this.styleMergeStorage.push(new n.bg)}getStyleMergeStorage(){const e=this.styleMergeStorage[this.currentStyleMergeStoragePointer];return this.currentStyleMergeStoragePointer=(this.currentStyleMergeStoragePointer+1)%this.styleMergeStorage.length,e}}},91296:function(e,t,i){i.d(t,{C:function(){return S},O:function(){return E}});var s=i(90645),n=i(85332),r=i(95417),a=i(64113);if(666==i.j)var o=i(33212);var h=i(99826),c=i(31286),l=i(51232);if(666==i.j)var u=i(55858);if(666==i.j)var d=i(90342);if(666==i.j)var g=i(18265);var p=i(80462);if(666==i.j)var m=i(37654);if(666==i.j)var f=i(39986);var I=i(45454);class E extends(666==i.j?r.UIElement:null){constructor(e,t,i,s,n,a=1){super(n),this.normal=e,this.tangent=t,this.center=i,this.elementConnection=s,this.faceSize=a,this.isPreSelected=!1,this.isSelected=!1,this.isHiddenFromPick=!1,this.manipulator=null,this.inversePreManipulationMatrix=null,this.preManipulationCenter=null,this.preManipulationNormal=null,this.preManipulationTangent=null,this.inferredCenter=null,this.label=-1,this.isManipulatorRemovedOnDeselection=!0,this.editSubject=new m.x,this.listenTo(this,r.UiEvents.CLICK+o.s_,this.onClick),this.listenTo(this,r.UiEvents.MOUSE_ENTER+o.s_,this.onMouseEnter),this.listenTo(this,r.UiEvents.MOUSE_LEAVE+o.s_,this.onMouseLeave),this.listenTo(this,r.UiEvents.SELECT+o.s_,this.onSelect),this.listenTo(this,r.UiEvents.DESELECT+o.s_,this.onDeselect),this.listenTo(this,r.UiEvents.DOUBLE_CLICK+o.s_,this.onDoubleClick),this.center=u.clone(i),e.length<4?this.normal=d.fromValues(e[0],e[1],e[2],0):this.normal=d.clone(e),t.length<4?this.tangent=d.fromValues(t[0],t[1],t[2],0):this.tangent=d.clone(t)}getSelection(e,t){return new r.UISelection(this,o.s_,"")}getPickPriority(e){return r.PickPriority.SECTION_PLANE}shouldBeClearedWithSelections(){return!1}allowSelection(){const e=this.viewer.getModelViewManagers().getManager().hasActiveSketch(),t=!(0,r.isUsageBase)();return!o.X5&&!e&&!t}onClick(e,t,i){(0,a.Ky)().sectionPlaneToFocus=this,(0,a.Ky)().pickOnSectionPlaneToFocus=e.sourcePick,i.requestSelectedStatus=this.allowSelection()}onTriadDoubleClick(e,t){(0,a.Ky)()?.hasFaceEntities()||this.onDoubleClick(t)}onDoubleClick(e){(0,a.Ky)().sectionPlaneToFocus=this,(0,a.Ky)().pickOnSectionPlaneToFocus=e.sourcePick,(0,c.m)().trigger(l.C.EDIT_SECTION_VIEW)}onMouseEnter(){this.isPreSelected=this.allowSelection(),(0,r.requestDraw)()}onMouseLeave(){this.isPreSelected=!1,(0,r.requestDraw)()}isInteractionEnabled(){return this.allowSelection()}setupManipulator(e){e||(e=this.getSelection()),this.manipulator?this.checkAndCreateInferenceControllerIfNeeded():this.createManipulator(e)}onSelect(e){this.isSelected=!0,this.setupManipulator(e),(0,r.requestDraw)()}listenToManipulator(e){this.listenTo(e,s.w0.DOUBLE_CLICKED,this.onTriadDoubleClick),this.listenTo(e,s.w0.REPOSITION_START,this.onRepositionStart),this.listenTo(e,s.w0.REPOSITION_END,this.onRepositionEnd),this.listenTo(e,s.w0.ENTER_INFERENCE,this.onEnterInference),this.listenTo(e,s.w0.LEAVE_INFERENCE,this.onLeaveInference),this.listenTo(e,h.Wb.CLICKED,this.onManipulatorClicked),this.listenTo(e,s.w0.ROTATION_START,this.onRotationStart),this.listenTo(e,s.w0.ROTATION_CHANGE,this.onRotationChange),this.listenTo(e,s.w0.ROTATION_EDIT,this.onRotationEdit),this.listenTo(e,s.w0.ROTATION_END,this.onRotationEnd),this.listenTo(e,s.w0.TRANSLATION_START,this.onTranslationStart),this.listenTo(e,s.w0.TRANSLATION_CHANGE,this.onTranslationChange),this.listenTo(e,s.w0.TRANSLATION_EDIT,this.onTranslationEdit),this.listenTo(e,s.w0.TRANSLATION_END,this.onTranslationEnd),this.listenTo((0,I.vi)(),"reset",this.onDeselect)}createManipulator(e){let t=this.center;const i=e.sourcePick?e.sourcePick.location:null;if(i){const e=this.viewer.getCamera().getRay(i[0],i[1]),s=(0,r.intersectRayPlane)(e,this.getWorldSpacePlaneEquation());s&&(t=s)}this.manipulator=new r.Triad(this.viewer,h.Ak.PLANE,{displayEditView:!0}),this.manipulator.updateDefinition(this.getWorldSpaceMatrix(t)),this.viewer.getEventDispatcher().trigger(r.CREATE_SECTION_PLANE_INFERENCE_CONTROLLER,this.manipulator,this.elementConnection),this.listenToManipulator(this.manipulator),this.previewStateChangeSubscription=(0,r.getEditState)().stateChangedObservable.pipe((0,f.h)((e=>e===r.Events.PREVIEW_STATE_CHANGE))).subscribe((()=>this.onPreviewStateChange()))}onRepositionStart(){const e=this.checkAndCreateInferenceControllerIfNeeded();null!==e&&e.startInferencing(),this.preManipulationCenter=this.center,this.editSubject.next(!1)}checkAndCreateInferenceControllerIfNeeded(){const e=n._3.getOpenDocumentController();if(!e)return null;const t=e.getSectionPlaneInferenceControllerManager();return t&&t.activeManipulator!==this.manipulator?(this.viewer.getEventDispatcher().trigger(r.CREATE_SECTION_PLANE_INFERENCE_CONTROLLER,this.manipulator,this.elementConnection),t.activeController):null}onRepositionEnd(){this.inferredCenter?(this.center=this.inferredCenter,(0,a.P_)(!0)):this.manipulator.updateOrigin(this.preManipulationCenter),this.inferredCenter=null,this.editSubject.next(!0)}onEnterInference(e){this.inferredCenter=e}onLeaveInference(){this.inferredCenter=null}onPreviewStateChange(){(0,r.isUsageBase)()||this.onDeselect()}onDeselect(){this.manipulator&&(this.getIsManipulatorRemovedOnDeselection()?this.destroyManipulator():this.manipulator.removeEditViewAndHighlights()),this.isSelected=!1,(0,r.requestDraw)()}destroyManipulator(){this.manipulator&&(this.stopListening(this.manipulator),this.previewStateChangeSubscription.unsubscribe(),this.manipulator.remove(),this.manipulator=null,this.viewer.getEventDispatcher().trigger(r.DESTROY_SECTION_PLANE_INFERENCE_CONTROLLER))}getIsManipulatorRemovedOnDeselection(){return this.isManipulatorRemovedOnDeselection}setIsManipulatorRemovedOnDeselection(e){this.isManipulatorRemovedOnDeselection=e}rotationStart(e){this.preManipulationCenter=u.fromValues(this.center[0],this.center[1],this.center[2]),this.preManipulationNormal=d.fromValues(this.normal[0],this.normal[1],this.normal[2],0),this.preManipulationTangent=d.fromValues(this.tangent[0],this.tangent[1],this.tangent[2],0),this.inversePreManipulationMatrix=p.w$.inverse(e,g.create())}onManipulatorClicked(e){if(e instanceof r.Linear){const e=this.manipulator,t=g.clone(e.transform),i=0;e.processUpdateFromAngularManipulator(i,t,Math.PI),this.onRotationEdit(t);const s=e.linearManipulators[0];if(s){const e=s.initialRay;if(e){const t=p.S4.scale(e.direction,-1,u.create());s.initialRay=new r.Ray(e.point,t)}}}}onRotationStart(){this.rotationStart(this.manipulator.transform),this.editSubject.next(!1)}onRotationChange(){const e=p.w$.multiply(this.manipulator.transform,this.inversePreManipulationMatrix,g.create());this.center=p.w$.multiplyVec3(e,this.preManipulationCenter,u.create()),this.normal=p.w$.multiplyVec4(e,this.preManipulationNormal,d.create()),this.tangent=p.w$.multiplyVec4(e,this.preManipulationTangent,d.create()),(0,a.P_)(!0)}onRotationEdit(e){this.rotationStart(e),this.onRotationChange(),this.editSubject.next(!0)}onRotationEnd(){this.editSubject.next(!0)}equals(e){return(0,r.areVectorsEqual)(this.normal,e.normal)&&(0,r.areVectorsEqual)(this.tangent,e.tangent)&&(0,r.areVectorsEqual)(this.center,e.center)}onTranslationStart(){this.preManipulationCenter=u.fromValues(this.center[0],this.center[1],this.center[2]),this.editSubject.next(!1)}onTranslationChange(e){p.S4.add(this.preManipulationCenter,e,this.center),(0,a.P_)(!0)}onTranslationEdit(e){this.onTranslationStart(),this.onTranslationChange(e),this.editSubject.next(!0)}onTranslationEnd(){this.editSubject.next(!0)}onRemove(){this.onDeselect()}getWorldSpacePlaneEquation(){const e=u.dot(this.normal,this.center);return d.fromValues(this.normal[0],this.normal[1],this.normal[2],-e)}getWorldSpaceMatrix(e){const t=p.S4.cross(this.tangent,this.normal,u.create());return g.fromValues(this.tangent[0],this.tangent[1],this.tangent[2],0,t[0],t[1],t[2],0,-this.normal[0],-this.normal[1],-this.normal[2],0,e[0],e[1],e[2],1)}getCameraSpacePlaneEquation(e,t){const i=p.w$.multiplyVec4(e,this.normal,d.create()),s=u.dot(i,t);return d.fromValues(i[0],i[1],i[2],-s)}getCameraSpaceTangent(e){return p.w$.multiplyVec4(e,this.tangent,d.create())}getCameraSpaceCenter(e){return p.w$.multiplyVec3(e,this.center,u.create())}getPlaneMatrix(e){e||(e=g.create()),e[0]=this.tangent[0],e[1]=this.tangent[1],e[2]=this.tangent[2],e[3]=0;const t=u.create(),i=u.create();return p.S4.cross(this.normal,this.tangent,i),p.S4.normalize(i,t),e[4]=t[0],e[5]=t[1],e[6]=t[2],e[7]=0,e[8]=this.normal[0],e[9]=this.normal[1],e[10]=this.normal[2],e[11]=0,e[12]=this.center[0],e[13]=this.center[1],e[14]=this.center[2],e[15]=1,e}getViewManipulatorOrigin(e){return e||(e=u.create()),e[0]=this.manipulator?this.manipulator.transform[12]:this.center[0],e[1]=this.manipulator?this.manipulator.transform[13]:this.center[1],e[2]=this.manipulator?this.manipulator.transform[14]:this.center[2],e}getEditObservable(){return this.editSubject.asObservable()}isMeshIncrementCoplanar({points:e},t){const i=u.create();for(let s=0;s<e.length;s+=3)if(i[0]=e[s]-this.center[0],i[1]=e[s+1]-this.center[1],i[2]=e[s+2]-this.center[2],Math.abs(u.dot(i,this.normal))>t)return!1;return!0}}function S(e){const t=e.getUISelectionManager().getSelection();if(t&&t.selectionId===o.s_&&t.uiElement instanceof E&&(t.uiElement.isSelected||t.uiElement.isPreSelected))return t.uiElement}},64113:function(e,t,i){i.d(t,{aA:function(){return W},oj:function(){return G},cP:function(){return ee},ny:function(){return Ee},HX:function(){return se},Lz:function(){return ie},tz:function(){return te},Ky:function(){return X},nL:function(){return Q},j1:function(){return U},tb:function(){return Ie},qT:function(){return J},ti:function(){return ye},WC:function(){return ne},rv:function(){return Pe},OR:function(){return Ne},p$:function(){return Fe},bm:function(){return xe},Mi:function(){return Oe},eQ:function(){return Ae},Wh:function(){return we},F6:function(){return Ce},qf:function(){return re},v5:function(){return Me},UB:function(){return De},X9:function(){return ve},o_:function(){return Re},jf:function(){return le},Rb:function(){return Ve},rH:function(){return Ue},CF:function(){return k},hJ:function(){return Se},N3:function(){return Te},P_:function(){return V},qS:function(){return ue},cV:function(){return pe},fI:function(){return ge},le:function(){return de}});var s=i(47178),n=i(17922),r=i(37952),a=i(72751),o=i(45454),h=i(8277),c=i(83057),l=i(78613),u=i(33212),d=i(91296),g=i(63971),p=i(31126),m=i(21324),f=i(85036),I=i(14115),E=i(18265),S=i(55858),T=i(90342),D=i(80462),M=i(31286),C=i(51232),y=i(37654),P=i(6638),A=i(95417),O=i(26738);const v=new A.NodeProperties({primitiveType:A.PrimitiveType.LINES,isPickable:!0,isHighlightable:!0,isTwoSided:!0,isShowThrough:!1,isVisible:!0,zOffset:n.default.getManager().getNumber("SECTION_EDGES_Z_OFFSET")}),R=new A.NodeProperties({primitiveType:A.PrimitiveType.POINTS,isPickable:!0,isHighlightable:!0,isTwoSided:!0,isShowThrough:!1,isVisible:!1,isSectionEntity:!0,zOffset:n.default.getManager().getNumber("SECTION_POINTS_Z_OFFSET")}),w=new A.NodeProperties({primitiveType:A.PrimitiveType.TRIANGLE_STRIP,isPickable:!0,isHighlightable:!0,isVisible:!0,zOffset:n.default.getManager().getNumber("PART_FACES_Z_OFFSET"),pickZOffset:n.default.getManager().getNumber("SECTION_FACES_Z_OFFSET")});let _=null;function N(){return null===_&&(_=new Map([[A.PrimitiveType.LINES,{nodeProperties:v,entityType:c.ZSW.EDGE,pickPriority:A.PickPriority.PART_EDGE}],[A.PrimitiveType.POINTS,{nodeProperties:R,entityType:c.ZSW.VERTEX,pickPriority:A.PickPriority.PART_VERTEX}],[A.PrimitiveType.TRIANGLE_STRIP,{nodeProperties:w,entityType:c.ZSW.FACE,pickPriority:A.PickPriority.PART_FACE}]])),_}class b extends A.UIElement{constructor(e,t,i){super(i),this.elementId=e,this.state=t,this.incrementData=new Map,this.hasFace=!1,this.isCleaningUp=!1,this.selectedEntities=new Set,this.preselectedEntities=new Set,this.secondarySelectedEntities=new Set,this.sectionPlaneSelections=[],this.selectionLists={selection:(0,o.vi)(),preselection:(0,o.Wf)(),secondary:(0,o.wT)()},this.initializePlaneSelectionCounts(),this.listenToSelectionLists(),this.listenTo(this.viewer.getIsolatedOccurrenceManager(),A.IsolatedOccurrencesManager.IS_ISOLATE_FULLY_TRANSPARENT_CHANGED_EVENT,this.updateEntityVisibility)}initializePlaneSelectionCounts(){for(const e of this.state.getSectionPlanes())this.sectionPlaneSelections.push(0)}incrementPlaneSelectionCount(e,t){const i=this.sectionPlaneSelections[e];if(0===i){const i=this.state.getSectionPlanes()[e];i?.onDeselect(),i?.setupManipulator(t)}this.sectionPlaneSelections[e]=i+1}decrementPlaneSelectionCount(e){const t=this.sectionPlaneSelections[e],i=Math.max(0,t-1);if(this.sectionPlaneSelections[e]=i,0===i){const t=this.state.getSectionPlanes()[e];t?.onDeselect()}}getHighlightType(e){return e===this.selectionLists.preselection?A.HighlightType.PRE:e===this.selectionLists.secondary?A.HighlightType.SECONDARY:A.HighlightType.ENTITY}getSelectedSetFromSelectionList(e){return e===this.selectionLists.preselection?this.preselectedEntities:e===this.selectionLists.secondary?this.secondarySelectedEntities:this.selectedEntities}findAssociatedPlaneIndex(e){const t=this.state.getSectionPlanes();let i=-1;return t.forEach(((t,s)=>{t.isMeshIncrementCoplanar(e,1e-5)&&(i=s)})),i}getSelectedFaceEntityForAlignment(){for(const e of this.preselectedEntities)return e;for(const e of this.selectedEntities)return e;return null}onSelectFace(e,t,i){this.getSelectedSetFromSelectionList(i).add(e),this.isCleaningUp||i===this.selectionLists.selection&&this.incrementPlaneSelectionCount(e.associatedPlaneIndex,t)}onDeselectFace(e,t){this.getSelectedSetFromSelectionList(t).delete(e),this.isCleaningUp||t===this.selectionLists.selection&&this.decrementPlaneSelectionCount(e.associatedPlaneIndex)}handleChangeSelectionList({list:e,selection:t,doAdd:i,doDraw:s=!0}){if(!t.isSectionEntity())return;const n=t.getIdString(),r=this.getHighlightType(e),a=this.addHighlightToSection(r,n);i?a?.entityType===c.ZSW.FACE&&this.onSelectFace(a,t,e):(a?.entityType===c.ZSW.FACE&&this.onDeselectFace(a,e),this.removeHighlightFromSection(r,n)),s&&this.viewer.requestDraw()}clearHighlightsOfType(e){for(const t of this.incrementData.values()){const i=t.highlights.get(e);void 0!==i&&(this.removeHighlightFromIncrement(t.incrementId,i),t.highlights.delete(e))}}handleResetSelectionList(e){const t=this.getHighlightType(e);this.clearHighlightsOfType(t);if(this.getSelectedSetFromSelectionList(e).clear(),e===this.selectionLists.selection)for(let e=0;e<this.sectionPlaneSelections.length;e+=1)this.sectionPlaneSelections[e]=0;e.forEach((t=>{this.handleChangeSelectionList({list:e,selection:t,doAdd:!0,doDraw:!1})})),this.viewer.requestDraw()}listenForChangesToSelectionList(e){this.listenTo(e,"add",(t=>{this.handleChangeSelectionList({list:e,selection:t,doAdd:!0})})),this.listenTo(e,"remove",(t=>{this.handleChangeSelectionList({list:e,selection:t,doAdd:!1})})),this.listenTo(e,"reset",(()=>{this.handleResetSelectionList(e)}))}listenToSelectionLists(){this.listenForChangesToSelectionList(this.selectionLists.preselection),this.listenForChangesToSelectionList(this.selectionLists.selection),this.listenForChangesToSelectionList(this.selectionLists.secondary)}getBodyId(e,t){return e.occurrenceList[t]?.getPathAsString()??e.partIds[t]}getFullId(e,t){const i=this.getBodyId(e,t);return`${c.FBt.SECTION_IDENTIFIER}-${i}`}getEntityTypeFromPrimitiveType(e){return N().get(e)?.entityType??c.ZSW.UNKNOWN}getColor(e){const t=this.viewer.getModelViewManagers().getManager();return e.occurrence?t.getOccurrenceColor(e.occurrence):e.partId?t.getPartColor(e.partId):null}isDebugSectionEntitiesDisplay(){return O.Jq.CapabilitiesService.checkDebugCurrentlyEnabled()&&Boolean(JSON.parse(localStorage.getItem("debugSectionEntitiesDisplay")))}populate(e){const t=this.isDebugSectionEntitiesDisplay();e.entities.forEach(((i,s)=>{const r=this.getFullId(e,s);i.forEach(((i,a)=>{i.tessellation.forEach(((i,o)=>{const h=(0,A.createMeshIncrementForEntityData)(i),l=`${c.FBt.ID}${s}-${a}-${o}`;if(t){const e=n.default.getManager().getColor("CPP_RED");(0,A.addColorToIncrement)(e,h)}const u=`${c.FBt.ID}${a}-${o}`,d=`${r}-${u}`,g=N().get(h.primitiveType)?.nodeProperties;if(g){const t={incrementId:l,selectionId:d,primitiveType:g.primitiveType,entityType:this.getEntityTypeFromPrimitiveType(g.primitiveType),highlights:new Map,occurrence:e.occurrenceList[s],partId:e.partIds[s],metadata:this.createEntityMetadata(l,i),meshIncrement:h};if(t.entityType===c.ZSW.FACE){const e=this.findAssociatedPlaneIndex(h);-1!==e&&(t.associatedPlaneIndex=e);const i=this.getColor(t);this.hasFace=!0,i&&(0,A.addColorToIncrement)(i,h)}this.incrementData.set(d,t),this.updateMeshIncrement(l,d,h,g)}}))}))})),this.updateEntityVisibility()}hasFaceEntities(){return this.hasFace}createEntityMetadata(e,t){const i=new c.kdl;return i.setBodyId(e),i.setGeometry(t),i}getMeshIncrementForUISelection(e){const t=this.getInstantiatedMeshIncrement(e.meshIncrementId);return t?.meshIncrement??null}getPickPriority(e){const t=this.getMeshIncrementForUISelection(e);let i=null;return t&&(i=N().get(t.primitiveType)?.pickPriority),i??A.PickPriority.UNKNOWN}getModelSelection(e){const t=new o.Y1(c.lQt.ENTITY,e.selectionId,(0,r._R)()?new c._oC:null,{sourcePick:e.sourcePick}),i=this.findIncrementData(e.selectionId);return i&&(t.setNameFromSectionDetails({entityType:i.entityType,partId:i.partId,occurrence:i.occurrence,elementId:this.elementId}),t.entityMetaData=i.metadata),t}getEntityMetaData(e){return this.findIncrementData(e)?.metadata??null}findIncrementData(e){return this.incrementData.get(e)??null}addHighlightToSection(e,t){const i=this.viewer.getHighlightManager(A.BTGraphicsUsage.BASE).createHighlightForSelection(e,t),s=this.findIncrementData(t);return s?(s.highlights.has(e)&&(this.removeHighlightFromIncrement(s.incrementId,s.highlights.get(e)),s.highlights.delete(e)),this.addHighlightToIncrement(s.incrementId,i),s.highlights.set(e,i),s):null}removeHighlightFromSection(e,t){const i=this.findIncrementData(t);i&&this.removeHighlightFromIncrementData(e,i)}removeHighlightFromIncrementData(e,t){const i=t.highlights.get(e);i&&(this.removeHighlightFromIncrement(t.incrementId,i),t.highlights.delete(e))}clearSelections(e){const t=e.filter((e=>e?.isSectionEntity()));e.remove(t)}remove(){this.isCleaningUp=!0,this.clearSelections((0,o.Wf)()),this.clearSelections((0,o.vi)()),super.remove()}onIsolateChanged(){this.updateEntityVisibility()}updateEntityVisibility(){const e=this.viewer.getModelViewManagers().getManager(),t=this.viewer.getIsolatedOccurrenceManager()?.isInIsolateOrMakeTransparentMode(),i=this.viewer.getIsolatedOccurrenceManager()?.getIsIsolateFullyTransparent();for(const s of this.incrementData.values()){let n;if(s.occurrence){const e=this.viewer.getOccurrenceIdManager().getIdForName(s.occurrence.toString());n=this.viewer.getOccurrenceDataManager().getOccurrenceData(e)}else{const t=e.getDisplayedPartStudio();t&&(n=t.getBodyComponent().getBodyOccurrenceData(s.partId))}t&&n&&i&&!n.getIsolated()?this.hideIncrement(s.incrementId):this.showIncrement(s.incrementId)}}extractMeshIncrement(e){const t=this.findIncrementData(e);return t?.meshIncrement??null}}var L=i(85332);const F=n.default.getManager();let x=!1,B=0;function V(e){x=e}function U(){return 3}var G;!function(e){e[e.Excluded=0]="Excluded",e[e.Included=1]="Included"}(G||(G={}));let H=!1;function k(e){H=e,X()?.setEntitiesEnabled(H)}class W extends s.T{constructor(e=!0){super(),this.sectionPlanes=[],this.sectionedItems=[null,null],this.currentSectionedItemType=G.Excluded,this.isListening=!1,this.elementId="",this.eligibleCompositeParts=[new Set,new Set],this.areEntitiesEnabled=!1,this.entitiesElement=null,this.isRequestingEntities=!1,this.editSubject=new y.x,this.planeEditSubscriptions=new Map,this.hasVisibilityUpdate=!1,e&&this.setEntitiesEnabled(H)}isNotEmpty(){return this.sectionPlanes.length>0||this.sectionedItems[G.Excluded]?.selections.length>0||this.sectionedItems[G.Included]?.selections.length>0}setupListeners(){this.isListening=!0,this.listenTo((0,l.xA)(),l.CD,this.onPartStudioDisplayDataChanged),this.listenTo((0,l.xA)(),l.sJ,this.onPartVisibilityChanged),this.listenTo((0,l.xA)(),l.hj,this.onAssemblyDataProcessed),this.listenTo((0,M.m)(),C.C.EXIT_EDIT_INCONTEXT,this.removeAssemblyParts)}stopListening(e,t,i){this.isListening&&(super.stopListening(e,t,i),this.isListening=!1)}updateEntitiesIfEnabled(){this.areEntitiesEnabled&&this.updateEntities((0,m.uQ)(),this.getElementConnection())}updateEntitiesIfMicroversionChanged(e){e.to.deepEquals(e.from)?this.entitiesElement?.hide():this.updateEntitiesIfEnabled()}onPartStudioDisplayDataChanged(e){this.setAllOccurrencesClippedExceptSelectedOnes(this.getIsExcludingItemsForSection()),(e.hasPartGeometryChanges()||this.hasVisibilityUpdate)&&(this.updateEntitiesIfMicroversionChanged(e.microversionIdAndConfigurationInterval),this.hasVisibilityUpdate=!1)}onPartVisibilityChanged(){this.hasVisibilityUpdate=!0,this.clearEntities()}onAssemblyDataProcessed(e){this.removeDeletedOccurrencesFromSectionedItems(e),this.setAllOccurrencesClippedExceptSelectedOnes(this.getIsExcludingItemsForSection());const t=e.occurrences.length,i=e.deletedOccurrences.length;(t>0||i>0)&&this.updateEntitiesIfMicroversionChanged(e.microversionIdAndConfigurationInterval)}removeDeletedOccurrencesFromSectionedItems(e){if(0===e.deletedOccurrences.length)return;const t=this.getSectionedItems();if(t&&t.length>0){const i=new Set(e.deletedOccurrences.map((e=>e.getPathAsString())));t.reset(t.filter((e=>!i.has(e.getOccurrence()?.getPathAsString()))))}}setAllOccurrencesClippedExceptSelectedOnes(e){const t=(0,m.uQ)(),i=t.getModelViewManagers().getManager(),s=(0,r._R)()?i.getDisplayedAssembly():i.getDisplayedInContextAssembly();if(s){const t=this.getSectionedItemsAsSetOfOccurrencePaths();s.setAreOccurrencesClippedBySectionPlaneExcept(e,t)}if((0,r._B)()){const s=!0,n=this.getSectionedItemsAsSetOfBodyIds(s),r=i.getDisplayedPartStudio();if(r&&r.getBodyComponent().setAreOccurrencesClippedBySectionPlaneExcept(e,n),t.getModelViewManagers().previewManagerExists()){const i=t.getModelViewManagers().getPreviewManager().getDisplayedPartStudio();i&&i.getBodyComponent().setAreOccurrencesClippedBySectionPlaneExcept(e,n)}}}getIsExcludingItemsForSection(){return this.currentSectionedItemType===G.Excluded}getCurrentSectionedItemType(){return this.currentSectionedItemType}getElementConnection(){return L._3.getOpenDocumentController().elementConnection}onSectionPlaneEdit(e,t){if(this.editSubject.next({plane:e,isValidForEntities:t}),this.areEntitiesEnabled)if(t){const e=(0,m.uQ)(),t=this.getElementConnection();this.updateEntities(e,t)}else this.clearEntities()}setIsExcludingItemsForSection(e){this.currentSectionedItemType=e?G.Excluded:G.Included,x=!0,this.setAllOccurrencesClippedExceptSelectedOnes(e);(0,m.uQ)().requestDraw()}getSectionPlanes(){return this.sectionPlanes}clearSectionPlanes(){this.sectionPlanes=[],this.clearEntities()}addSectionPlane(e){this.sectionPlanes.push(e);const t=e.getEditObservable().subscribe((t=>{this.onSectionPlaneEdit(e,t)}));this.planeEditSubscriptions.set(e,t),this.onSectionPlaneEdit(e,!0)}removeSectionPlane(e){this.onSectionPlaneEdit(e,!0),this.sectionPlanes=this.sectionPlanes.filter((t=>t!==e));const t=this.planeEditSubscriptions.get(e);t&&(t.unsubscribe(),this.planeEditSubscriptions.delete(e))}getEditObservable(){return this.editSubject.asObservable()}destroySectionedItems(){this.currentSectionedItemType=G.Excluded,this.sectionedItems.forEach((e=>{e&&e.destroy()})),this.stopListening(),this.sectionedItems=[null,null],this.eligibleCompositeParts.forEach((e=>e.clear())),this.elementId=""}setElementId(e,t){this.elementId!==e&&(""!==this.elementId&&this.destroySectionedItems(),this.elementId=e,this.sectionedItems[G.Excluded]=new h.w(e),this.sectionedItems[G.Included]=new h.w(e),t&&this.setupListeners())}getElementId(){return this.elementId}setIsItemClipped(e,t){if(!e)return;const i=(0,m.uQ)(),s=i.getModelViewManagers().getManager(),n=(0,r._R)()?s.getDisplayedAssembly():s.getDisplayedInContextAssembly();let a=!1;if(n){const i=e.getOccurrence();i&&(n.setAllLeafOccurrencesClippedForOccurrence(i,t),a=!0)}(0,r._B)()&&!a&&s.getDisplayedPartStudio().getBodyComponent().setIsBodyClippedBySectionPlane(e.getBodyId(),t,!1,this.getHasEligibleCompositeParts()?this.getSectionedItemsAsSetOfBodyIds():null),i.requestDraw()}getHasEligibleCompositeParts(e){return e=e??this.currentSectionedItemType,this.eligibleCompositeParts[e].size>0}addSectionedItem(e,t){""!==this.getElementId()?(null==t&&(t=this.currentSectionedItemType),this.getSectionedItems(t)?.add(e),t===this.currentSectionedItemType&&this.setIsItemClipped(e,!this.getIsExcludingItemsForSection()),e.getBodyMetaData()?.isNonGroupingCompositeBody&&this.eligibleCompositeParts[t].add(e.getBodyId()),x=!0):a.log.warn("SectionViewState.addSectionedItem used without initializing via setElementId")}removeSectionedItem(e,t){if(""===this.getElementId())return void a.log.warn("SectionViewState.removeSectionedItem used without initializing via setElementId");null==t&&(t=this.currentSectionedItemType);const i=this.getSectionedItems(t)?.remove(e);i&&(t===this.currentSectionedItemType&&this.setIsItemClipped(e,this.getIsExcludingItemsForSection()),e.getBodyMetaData()?.isNonGroupingCompositeBody&&this.eligibleCompositeParts[t].delete(e.getBodyId()),x=!0)}getSectionedItems(e){return""===this.getElementId()?(a.log.error("SectionViewState.getSectionedItems used without initializing via setElementId"),null):(null==e&&(e=this.currentSectionedItemType),this.sectionedItems[e]?this.sectionedItems[e].selections:null)}getSectionedItemsAsSetOfBodyIds(e){const t=new Set,i=this.getSectionedItems();return i&&i.forEach((i=>{!i||e&&i.getOccurrence()||t.add(i.getBodyId())})),t}getSectionedItemsAsSetOfOccurrencePaths(){const e=new Set,t=this.getSectionedItems();return t&&t.forEach((t=>{const i=t.getOccurrence();i&&e.add(i.getPathAsString())})),e}resetSectionedItems(e,t){if(""===this.getElementId())return void a.log.warn("SectionViewState.resetSectionedItems used without initializing via setElementId");const i=new o.nZ("newSelectionList",e),s=this.getSectionedItems(t);for(let e=s.length-1;e>=0;--e){const n=s.at(e);i.has(n)||this.removeSectionedItem(n,t)}i.forEach((e=>{s.has(e)||this.addSectionedItem(e,t)}))}destroy(){this.clearEntities(),De(!1),this.destroySectionedItems()}static copy(e,t,i){if(e&&t){t.sectionPlanes=[];for(const i of e.sectionPlanes)t.addSectionPlane(i);t.currentSectionedItemType=e.currentSectionedItemType,""!==e.getElementId()&&(t.elementId="",t.setElementId(e.getElementId(),i),t.getSectionedItems(G.Excluded)?.reset(e.getSectionedItems(G.Excluded).toArray()),t.getSectionedItems(G.Included)?.reset(e.getSectionedItems(G.Included).toArray()),t.eligibleCompositeParts[G.Excluded]=new Set(e.eligibleCompositeParts[G.Excluded]),t.eligibleCompositeParts[G.Included]=new Set(e.eligibleCompositeParts[G.Included]))}}clone(e){const t=new W;return W.copy(this,t,e),t}setFrom(e,t){if(!e)return!1;W.copy(e,this,t);const i=this.sectionPlanes.length>0;return i&&(x=!0,this.sectionPlanes.forEach((function(e){e.viewer.getEventDispatcher().trigger(l.Sr,e)}))),i}getSectionedItemsSize(e){return""===this.getElementId()?(a.log.warn("SectionViewState.getSectionedItemsSize used without initializing via setElementId"),0):this.getSectionedItems(e)?.length??0}removeAssemblyParts(){const e=[],t=t=>{t.occurrence&&e.push(t)};this.sectionedItems[G.Excluded].selections.forEach(t),this.sectionedItems[G.Included].selections.forEach(t),e.forEach((e=>this.removeSectionedItem(e)))}getSerializedSectionPlanes(){return this.getSectionPlanes().map((e=>{const t=new c.hPA;return t.center.updateFromArray(e.center),t.normal.updateFromArray(e.normal),t.tangent.updateFromArray(e.tangent),t}))}clearEntities(){this.setEntitiesElement(null),this.isRequestingEntities=!1}disableEntities(){this.clearEntities(),this.areEntitiesEnabled=!1}updateEntities(e,t){this.areEntitiesEnabled&&this.clearEntities(),this.generateEntities(e,t)}enableEntities(e=!1){const t=(0,m.uQ)(),i=this.getElementConnection();this.areEntitiesEnabled?e&&this.updateEntities(t,i):(this.areEntitiesEnabled=!0,this.generateEntities(t,i))}setEntitiesEnabled(e,t=!1){e?this.enableEntities(t):this.disableEntities()}setEntitiesElement(e){this.entitiesElement?.remove(),this.entitiesElement=e}generateEntities(e,t){if(this.entitiesElement)return;const i=new c.Nsz;if(i.elementId=this.elementId,i.sectionPlanes=this.getSerializedSectionPlanes(),i.currentSectionedItemType=this.getCurrentSectionedItemType(),0===i.sectionPlanes.length)return;const s=[],n=[];this.getSectionedItems()?.forEach((e=>{let t=e.getOccurrence();if(t?.isAssemblyRoot()&&(t=new c._oC),t)return void s.push(t);const i=e.getPartId();i&&n.push(i)})),i.selectedItems=s,i.partIds=n;const r=performance.now(),o=new P.e("sectionplane_helpers.SectionViewState.generateEntities");o.setImportant(i18n("Generating entities")),t.callAndPromiseWithFeedback(i,o).then((t=>{if(!(t instanceof c.FBt))return;if(!this.areEntitiesEnabled||!this.isRequestingEntities)return;const i=performance.now()-r,s=t.occurrenceList.length+t.partIds.length;a.log.debug(`Toggle section entities time taken ${i}ms. Number of bodies=${s}`),this.setEntitiesElement(new b(this.elementId,this,e)),this.entitiesElement.populate(t)})).catch((e=>{a.log.error(e),this.clearEntities()})),this.isRequestingEntities=!0}hasEntities(){return!!this.entitiesElement}hasFaceEntities(){return this.entitiesElement?.hasFaceEntities()??!1}getSelectedFaceEntityForAlignment(){return this.entitiesElement?.getSelectedFaceEntityForAlignment()??null}extractMeshIncrement(e){return this.entitiesElement?.extractMeshIncrement(e)??null}getEntityMetaData(e){return this.entitiesElement?.getEntityMetaData(e)??null}}const z=new W(!1);function X(){return z}const Z=E.create(),q=E.create(),Y=E.create();let K=[];const j=function(){K=Q()};function Q(){const e=[];return z.getSectionPlanes().forEach((function(t){const i={};i.center=S.clone(t.center),i.tangent=T.clone(t.tangent),i.normal=T.clone(t.normal),e.push(i)})),e}const $=function(e,t){if(!t&&B===e.getFrameId())return;let i,s;const n=z.getSectionPlanes();for(i=0;i<n.length;++i){const t=n[i].getCameraSpaceCenter(e.modelViewMatrix),r=n[i].getCameraSpacePlaneEquation(e.modelViewMatrix,t),a=n[i].getCameraSpaceTangent(e.modelViewMatrix);for(s=0;s<4;++s)Z[4*s+i]=r[s],Y[4*s+i]=a[s];for(s=0;s<3;++s)q[4*s+i]=t[s]}t||(B=e.getFrameId())};function J(e){let t=-1,i=-1;return z.getSectionPlanes().forEach((function(s,n){!1!==e&&s.isPreSelected?t=-1===t?n:-2:s.isSelected&&(i=-1===i?n:-2)})),t>-1?t:i>-1?i:-1}function ee(){const e=z.getSectionPlanes();for(let t=0;t<e.length;t++){const i=e[t];if(i.isSelected||i.isPreSelected)return!0}return!1}function te(e){const t=z.getSectionPlanes();return(e<0||e>=t.length)&&a.log.warn("attempting to retrieve a section plane with an invalid index"),t[e]}function ie(e,t){z.getSectionPlanes().forEach(e,t)}function se(e,t){return z.getSectionPlanes().filter(e,t)}function ne(){const e=[];return z.getSectionPlanes().forEach((function(t){e.push(t.graphicsOccurrenceId)})),e}function re(){B=-1}const ae=F.getNumber("SECTION_PLANE_ENDCAP_ORTHOGRAPHIC_Z_FIGHTING_FACTOR"),oe=F.getNumber("SECTION_PLANE_ENDCAP_PERSPECTIVE_Z_FIGHTING_FACTOR"),he=F.getNumber("SECTION_PLANE_INTER_ENDCAP_Z_FIGHTING_FACTOR");let ce=!1;function le(e){ce=e}function ue(e,t,i){const s=e.getRenderContext(),n=s.getActiveShader(),r=z.getSectionPlanes();if(!t||!e.areSectionPlanesEnabled()||0===r.length)return void n.uniform1f("uSectionPlaneCount",0);$(s,i),n.uniformMatrix4fv("uSectionPlaneEquations",!1,Z),n.uniform1f("uSectionPlaneCount",r.length);const a=s.getActiveCamera(),o=a.getFarDepth()-a.getNearDepth(),h=o*(a.isOrthographic()?ae:oe),c=o*he;n.uniform1f("uEndcapZFightingThreshold",h),n.uniform1f("uInterEndcapZFightingThreshold",c),n.uniform1f("uUseOccurrenceIdForHatchOffset",ce?0:1)}function de(e,t){const i=z.getSectionPlanes();if(t<0||i.length<=t)return;const s=e.getActiveShader();s.uniformMatrix4fv("uSectionPlaneCenters",!1,q),s.uniformMatrix4fv("uSectionPlaneTangents",!1,Y)}function ge(e,t){const i=z.getSectionPlanes();if(t<0||i.length<=t)return;const s=i[t],n=e.getActiveShader();n.uniform1f("uOccurrenceId",s.graphicsOccurrenceId);const r=[0,0,0,0];for(let e=0;e<i.length;++e)r[e]=i[e].isHiddenFromPick?1:0;n.uniform4fv("uSectionPlaneIsHiddenFromPick",r)}function pe(e,t){const i=z.getSectionPlanes();if(t<0||i.length<=t)return;const s=i[t],n=e.getActiveShader();n.uniform1f("uSectionPlaneIsPreSelected",s.isPreSelected?1:0),n.uniform1f("uSectionPlaneIsSelected",s.isSelected?1:0),n.uniform4fv("uSectionPlanePreSelectColor",F.getColor("SECTION_PLANE_PRE_HIGHLIGHT_COLOR")),n.uniform4fv("uSectionPlaneSelectColor",F.getColor("ENTITY_HIGHLIGHT_COLOR1")),n.uniform4fv("uSectionPlaneIntersectingColor",F.getColor("SECTION_PLANE_INTERSECTING_COLOR"));const r=F.getColor("SECTION_PLANE_SELECTOR_COLOR_0"),a=F.getColor("SECTION_PLANE_SELECTOR_COLOR_1"),o=F.getColor("SECTION_PLANE_SELECTOR_COLOR_2"),h=F.getColor("SECTION_PLANE_SELECTOR_COLOR_3");n.uniformMatrix4fv("uSectionPlaneSelectorColor",!1,E.fromValues(r[0],a[0],o[0],h[0],r[1],a[1],o[1],h[1],r[2],a[2],o[2],h[2],r[3],a[3],o[3],h[3]));const l=e.getActiveCamera();if(l.isPerspective()){const e=l.getSceneBounds().diameter(),t=(l.distanceToCenter()+.5*e)/l.getViewportHeight();n.uniform1f("uSectionPlanePatternScale",t*F.getNumber("SECTION_PLANE_PERSPECTIVE_PATTERN_SCALE"))}else{const e=1/(l.projectionMatrix[5]*l.getViewportHeight());n.uniform1f("uSectionPlanePatternScale",e*F.getNumber("SECTION_PLANE_ORTHOGRAPHIC_PATTERN_SCALE"))}n.uniform1f("uSectionPlanePatternFade",F.getNumber("SECTION_PLANE_PATTERN_FADE")),n.uniform1f("uSectionPlanePatternThickness",F.getNumber("SECTION_PLANE_PATTERN_THICKNESS")),n.uniform1f("uSectionPlanePatternPacingVariation",F.getNumber("SECTION_PLANE_PATTERN_PACING_VARIATION"));let u=0,d=1;switch(e.renderingMode){case c.P1.HIDDEN_LINE_REMOVED:case c.P1.HIDDEN_LINE_VISIBLE:case c.P1.WIREFRAME:case c.P1.CURVATURE_VISUALIZATION:u=1;break;case c.P1.TRANSLUCENT:d=F.getNumber("TRANSLUCENT_PASS_ALPHA")}n.uniform1f("uSectionPlanePatternIsBlackAndWhite",u),n.uniform1f("uSectionPlaneEndcapAlpha",d),n.uniform1f("uSectionPlaneIsolateContextOpacity",F.getNumber("ISOLATE_CONTEXT_FACE_TRANSPARENCY")),n.uniform1f("uSectionPlaneIntersectingAdditionalAlpha",F.getNumber("SECTION_PLANE_INTERSECTING_ADDITIONAL_ALPHA"))}const me=function(e){z.getSectionPlanes().length<3?(z.addSectionPlane(e),x=!0,e.viewer.getEventDispatcher().trigger(l.Sr,e)):e.viewer.getEventDispatcher().trigger(l.F5)},fe=function(e,t){if(z.getSectionPlanes().length<3){me(e);const i=new g.i(e,u.s_,"");i.sourcePick=t;e.viewer.getUISelectionManager().setSelection(i)}else e.viewer.getEventDispatcher().trigger(l.F5)};function Ie(){return K}function Ee(){K=[]}function Se(e,t,i,s){const n=s.getModelViewManagers().getManager().getMateConnectorGraphics(e,t);if(!n)return;const r=S.clone(n.worldSpacePosition),a=D.w$.multiplyVec4(n.transform,T.fromValues(0,0,1,0),T.create());D.jA.negate(a),D.Jb.normalize(a);const o=D.w$.multiplyVec4(n.transform,T.fromValues(1,0,0,0),T.create());D.Jb.normalize(o),fe(new d.O(a,o,r,i,s))}function Te(e,t,i,s,n){if(!t||s||!i)return;const r=T.fromValues(t[8],t[9],t[10],0),a=T.fromValues(t[0],t[1],t[2],0),o=S.fromValues(t[12],t[13],t[14]),h=S.dot(r,o)-S.dot(i.center(),r),c=D.S4.add(i.center(),D.S4.scale(r,h,S.create()),S.create()),l=(0,p.HB)().getCamera();S.dot(l.direction,r)<0&&(D.S4.negate(r),D.S4.negate(a)),fe(new d.O(r,a,c,n,e,i.diameter()))}function De(e){e?j():K=[],z.getSectionPlanes().forEach((function(e){Me(e)})),z.clearSectionPlanes(),x=!0}function Me(e){z.removeSectionPlane(e),e.onRemove(),x=!0,e.viewer.getEventDispatcher().trigger(l.zK,e)}function Ce(e,t,i,s){De(!1),e.forEach((function(e){const n=new d.O(e.normal,e.tangent,e.center,t,i);X().sectionPlaneToFocus&&X().sectionPlaneToFocus.equals(n)?(X().sectionPlaneToFocus=n,fe(n,X().pickOnSectionPlaneToFocus)):(me(n),s&&n.setupManipulator())}))}function ye(){return z.getSectionPlanes().length}function Pe(){return z.getSectionedItemsSize()}function Ae(){return!(0,f.isEmptyObjectOrArray)(z.getSectionPlanes())}function Oe(e){z.getSectionPlanes().forEach((function(t){t.graphicsOccurrenceId===e&&(t.isHiddenFromPick=!0)}))}function ve(){z.getSectionPlanes().forEach((function(e){e.isHiddenFromPick=!1}))}function Re(e){if(e!==z.getElementId())return new W(!1);const t=z.clone(!1);return z.destroy(),t}function we(e,t){if(t!==e.getElementId())return!1;z.destroy();return z.setFrom(e,!0)}let _e=new c.tS4;function Ne(){const e=[];return be(e),e}function be(e){z.getSerializedSectionPlanes().forEach((t=>{e.push(t)}))}function Le(){_e=_e.clone(),_e.sectionPlanes=[],be(_e.sectionPlanes),_e.isExcluding=z.getIsExcludingItemsForSection();const e=z.getElementId();return _e.elementId=e,e.length>0}function Fe(){return x&&(Le()&&Be(_e,!1),x=!1),_e}function xe(){let e=null;return x&&Le()&&(e=Be(_e,!0))?e.then((()=>(x=!1,_e))):(x=!1,Promise.resolve(_e))}function Be(e,t){return t?new Promise((t=>{const i=(0,I.ZU)(z.getSectionedItems(G.Excluded).toArray()),s=(0,I.ZU)(z.getSectionedItems(G.Included).toArray());Promise.all([i,s]).then((i=>{e.selectionsToExclude=i[0],e.selectionsToInclude=i[1],t()}))})):(e.selectionsToExclude=(0,I.xX)(z.getSectionedItems(G.Excluded).toArray()),e.selectionsToInclude=(0,I.xX)(z.getSectionedItems(G.Included).toArray()),null)}function Ve(e,t,i){let s;const n=z.getSectionPlanes();if(e.length===n.length&&e.length>0)for(x=!0,s=0;s<e.length;s++)n[s].center=S.fromValues(e[s].center.x,e[s].center.y,e[s].center.z),n[s].normal=T.fromValues(e[s].normal.x,e[s].normal.y,e[s].normal.z,0),n[s].tangent=T.fromValues(e[s].tangent.x,e[s].tangent.y,e[s].tangent.z,0);else for(n.length>0&&De(!1),s=0;s<e.length;s++){const n=S.fromValues(e[s].center.x,e[s].center.y,e[s].center.z),r=T.fromValues(e[s].normal.x,e[s].normal.y,e[s].normal.z,0),a=T.fromValues(e[s].tangent.x,e[s].tangent.y,e[s].tangent.z,0);me(new d.O(r,a,n,t,i))}}function Ue(e,t,i){Ve(e.sectionPlanes,t,i),function(e,t){const i=z.getElementId();!e||""===e.elementId||""!==i&&e.elementId!==i||(z.setElementId(e.elementId,!0),z.setIsExcludingItemsForSection(e.isExcluding),(0,I.rP)(e.selectionsToExclude,t).then((e=>{z.resetSectionedItems(e,G.Excluded)})),(0,I.rP)(e.selectionsToInclude,t).then((e=>{z.resetSectionedItems(e,G.Included)})))}(e,i)}},72264:function(e,t,i){i.d(t,{G7:function(){return z},KL:function(){return _},Te:function(){return L},WD:function(){return P},Wt:function(){return Z},b2:function(){return F},bt:function(){return k},eL:function(){return A},wg:function(){return X},wm:function(){return x}});var s=i(17922),n=i(72751),r=i(88497),a=i(13469),o=i(45454),h=i(83057),c=i(33204);if(666==i.j)var l=i(38798);var u=i(90631),d=i(95417),g=i(21324);if(666==i.j)var p=i(55858);if(666==i.j)var m=i(45666);if(666==i.j)var f=i(18265);var I=i(80462),E=i(26738);if(666==i.j)var S=i(99900);if(666==i.j)var T=i(39986);if(666==i.j)var D=i(42785);if(666==i.j)var M=i(16696);var C=i(51232),y=i(31286);const P="ellipsis",A=5,O=u.UKE,v={};v[h.U5n.BAD]="BAD",v[h.U5n.DRIVEN]="OK",v[h.U5n.SOLVED]="OK";const R={};R[O.SELECTED]="SELECTED_COLOR",R[O.PREHILITE]="PREHILITE_COLOR",R[O.MUTED]="MUTED_COLOR",R[O.NOT_SELECTED]="COLOR";const w=function(e,t,i,s){switch(t){case h.U5n.BAD:e+=":od";break;case h.U5n.DRIVEN:e+=":dr"}return i===u.UKE.SELECTED?e+=":s":i===u.UKE.PREHILITE?e+=":h":i===u.UKE.MUTED&&(e+=":m"),s&&(e+=":ex"),e};var _;!function(e){e[e.LINE=0]="LINE",e[e.TANGENT_ARC=1]="TANGENT_ARC"}(_||(_={}));const N=new Map([[_.LINE,"Sketch_Constraints_Grayscale_2_line.svg "],[_.TANGENT_ARC,"Sketch_Constraints_Grayscale_2_tangent-arc.svg "]]),b=new Map([[_.LINE,"line"],[_.TANGENT_ARC,"tangent_arc"]]);var L;!function(e){e[e.NOT_REQUIRED=0]="NOT_REQUIRED",e[e.REQUIRED=1]="REQUIRED"}(L||(L={}));class F{constructor(){this.id="",this.selectionId="",this.selected=u.UKE.NOT_SELECTED,this.constraintType=h.dI1.UNKNOWN,this.solveStatus=h.U5n.SOLVED,this._borderState=L.NOT_REQUIRED}static getIcon(e){const t=new F,i=w(b.get(e),h.U5n.UNKNOWN,u.UKE.MUTED,!1);return t.id=i,t}get borderState(){return this._borderState}set borderState(e){this._borderState=e}}const x=1,B=function(e,t,i,s){let r;switch(e){case h.dI1.QUADRANT:r="qad";break;case h.dI1.COINCIDENT:r="coi";break;case h.dI1.PARALLEL:r="par";break;case h.dI1.VERTICAL:r="ver";break;case h.dI1.HORIZONTAL:r="hoz";break;case h.dI1.PERPENDICULAR:r="prp";break;case h.dI1.CONCENTRIC:r="con";break;case h.dI1.MIDPOINT:r="mid";break;case h.dI1.TANGENT:r="tan";break;case h.dI1.PIERCE:r="prc";break;case h.dI1.EQUAL:r="equ";break;case h.dI1.NORMAL:r="nor";break;case h.dI1.FIX:r="fix";break;case h.dI1.PROJECTED:case h.dI1.SILHOUETTED:r="prj";break;case h.dI1.OFFSET:r="off";break;case h.dI1.MIRROR:r="mir";break;case h.dI1.CIRCULAR_PATTERN:r="cpt";break;case h.dI1.LINEAR_PATTERN:r="lin";break;case h.dI1.INTERSECTED:r="int";break;case h.dI1.EQUAL_CURVATURE:r="cur";break;default:r="???",n.log.error("Found a constraint with no atlas key.")}return w(r,t,i,s)},V=function(e,t,i,n,r){const a=s.default.getManager(),o=new d.ImageData;o.id=e;let c="CONSTRAINT_"+(v[t]||"OK")+"_"+(R[i]||"COLOR");return n&&(c+="_EXTERNAL"),o.backgroundColor=a.getColorString(c),t!==h.U5n.SOLVED||n||i?o.imageName=r:o.svgToStyle=r,o},U=function(e,t,i,s,n){s.forEach((function(s){for(let r=0;r<2;r++){const a=1===r;n.push(V(B(e,t,s,a),t,s,a,i))}}))},G=function(e){const t=[],i=[u.UKE.NOT_SELECTED,u.UKE.PREHILITE,u.UKE.SELECTED,u.UKE.MUTED],n={"Sketch_Constraints_Grayscale_2_Coincident.svg":h.dI1.COINCIDENT,"Sketch_Constraints_Grayscale_2_Parallel.svg":h.dI1.PARALLEL,"Sketch_Constraints_Grayscale_2_Vertical.svg":h.dI1.VERTICAL,"Sketch_Constraints_Grayscale_2_Horizontal.svg":h.dI1.HORIZONTAL,"Sketch_Constraints_Grayscale_2_Perpendicular.svg":h.dI1.PERPENDICULAR,"Sketch_Constraints_Grayscale_2_Concentric.svg":h.dI1.CONCENTRIC,"Sketch_Constraints_Grayscale_2_Midpoint.svg":h.dI1.MIDPOINT,"Sketch_Constraints_Grayscale_2_Tangent.svg":h.dI1.TANGENT,"Sketch_Constraints_Grayscale_2_Equal.svg":h.dI1.EQUAL,"Sketch_Constraints_Grayscale_2_Normal.svg":h.dI1.NORMAL,"Sketch_Constraints_Grayscale_2_Fix.svg":h.dI1.FIX,"Sketch_Constraints_Grayscale_2_Use.svg":h.dI1.PROJECTED,"Sketch_Constraints_Grayscale_2_Offset.svg":h.dI1.OFFSET,"Sketch_Constraints_Grayscale_2_Mirror.svg":h.dI1.MIRROR,"Sketch_Constraints_Grayscale_2_CircularPattern.svg":h.dI1.CIRCULAR_PATTERN,"Sketch_Constraints_Grayscale_2_LinearPattern.svg":h.dI1.LINEAR_PATTERN,"Sketch_Constraints_Grayscale_2_Pierce.svg":h.dI1.PIERCE,"Sketch_Constraints_Grayscale_2_Quadrant.svg":h.dI1.QUADRANT,"Sketch_Constraints_Grayscale_2_Intersection.svg":h.dI1.INTERSECTED,"Sketch_Constraints_Grayscale_2_equal-curvature.svg":h.dI1.EQUAL_CURVATURE};Object.entries(n).forEach((function([e,s]){U(s,h.U5n.SOLVED,e,i,t)}));const r={"Sketch_Constraints_OverDefined_Coincident.svg":h.dI1.COINCIDENT,"Sketch_Constraints_OverDefined_Parallel.svg":h.dI1.PARALLEL,"Sketch_Constraints_OverDefined_Vertical.svg":h.dI1.VERTICAL,"Sketch_Constraints_OverDefined_Horizontal.svg":h.dI1.HORIZONTAL,"Sketch_Constraints_OverDefined_Perpendicular.svg":h.dI1.PERPENDICULAR,"Sketch_Constraints_OverDefined_Concentric.svg":h.dI1.CONCENTRIC,"Sketch_Constraints_OverDefined_Midpoint.svg":h.dI1.MIDPOINT,"Sketch_Constraints_OverDefined_Tangent.svg":h.dI1.TANGENT,"Sketch_Constraints_OverDefined_Equal.svg":h.dI1.EQUAL,"Sketch_Constraints_OverDefined_Normal.svg":h.dI1.NORMAL,"Sketch_Constraints_OverDefined_Fix.svg":h.dI1.FIX,"Sketch_Constraints_OverDefined_Use.svg":h.dI1.PROJECTED,"Sketch_Constraints_OverDefined_Offset.svg":h.dI1.OFFSET,"Sketch_Constraints_OverDefined_Mirror.svg":h.dI1.MIRROR,"Sketch_Constraints_OverDefined_CircularPattern.svg":h.dI1.CIRCULAR_PATTERN,"Sketch_Constraints_OverDefined_LinearPattern.svg":h.dI1.LINEAR_PATTERN,"Sketch_Constraints_OverDefined_Pierce.svg":h.dI1.PIERCE,"Sketch_Constraints_OverDefined_Quadrant.svg":h.dI1.QUADRANT,"Sketch_Constraints_OverDefined_Intersection.svg":h.dI1.INTERSECTED,"Sketch_Constraints_OverDefined_equal-curvature.svg":h.dI1.EQUAL_CURVATURE};Object.entries(r).forEach((function([e,s]){U(s,h.U5n.BAD,e,i,t)})),i.forEach((function(e){t.push(V(w("...",h.U5n.SOLVED,e,!1),h.U5n.SOLVED,e,!1,"Sketch_Constraints_Ellipsis.svg"))}));const a=Object.values(_).filter((e=>"string"==typeof e));for(const e in a){const i=parseInt(e);t.push(V(w(b.get(i),h.U5n.UNKNOWN,u.UKE.MUTED,!1),h.U5n.UNKNOWN,u.UKE.MUTED,!1,N.get(i)))}const o=s.default.getManager().getNumber("CONSTRAINT_MAX_INDICATOR_SIZE")*(0,M.x_)();return(0,d.createAtlasFromResources)(e,o,t,{sourcesHaveTransparency:!1})};let H=0;function k(e){if(e.getResources().constraintAtlasCreationInitiated)return;e.getResources().constraintAtlasCreationInitiated=!0;const t=H++;e.getResources().constraintAtlasCreationId=t;e.getTextureAtlasFactory().getAtlas(d.SKETCH_CONSTRAINT_TEXTURE_ATLAS,G.bind(void 0,e)).then((function(i){t===e.getResources().constraintAtlasCreationId&&(i?(e.getResources().constraintAtlas=i,e.getResources().constraintMaterial.ambientTexture=i.texture,(0,d.requestDraw)()):n.log.warn("Could not load texture atlas"))}),(function(e){n.log.error(e)}))}const W=function(e){return e.selected===u.UKE.SELECTED};class z extends(666==i.j?d.UIElement:null){constructor(e,t,i,n,r,a){super(a,d.HUD_SCENEGRAPH_ID),this.permanent=r,this.activated=!1,this.isExpanded=!1,this.lastCameraXform=null,this.lastProjectionXform=null,this.hasLeader=!1,this.lastMouseDelta=null,this.isForInference=!1,this.material=a.getResources().constraintMaterial,this.nodeProperties=this.viewer.getResources().typeToNodeProperties[d.sketchinformation.nodePropertiesTypes.OK],this.leaderProperties=new d.NodeProperties({isPickable:!1,primitiveType:d.PrimitiveType.LINES,zOffset:5}),this.borderProperties=this.leaderProperties.clone(),this.model=e,this.reference=this.model.getReference(t),this.referenceIdsChangedSubscription=this.reference.getReferenceIdsChangedObservable().subscribe((([e,t])=>this.onReferenceConstraintIdsChanged(e,t))),this.anchorChangedSubscription=this.reference.getAnchorChangedObservable().subscribe((e=>this.resetLocation(e)));const o=this.reference.constraintIds,h=(0,S.T)(...o.map((e=>this.model.getConstraint(e))).filter((e=>!!e)).map((e=>e.getConstraintChangedObservable())));this.changeSolveStatusSubscription=h.pipe((0,T.h)((e=>"change:solveStatus"===e.name)),(0,D.U)((e=>e.constraint))).subscribe((e=>this.onConstraintStatusChanged(e))),this.changeTypeSubscription=h.pipe((0,T.h)((e=>"change:type"===e.name)),(0,D.U)((e=>e.constraint))).subscribe((e=>this.onConstraintTypeChanged(e))),this.changeBorderSubscription=h.pipe((0,T.h)((e=>"change:border"===e.name)),(0,D.U)((e=>e.constraint))).subscribe((e=>this.onConstraintBorderChanged(e))),this.iconData=[],this.worldLocation=i,this.leaderOffset=p.fromValues(0,0,0),this.ellipsisIcon=new F,this.ellipsisIcon.id=P,this.ellipsisIcon.selectionId=P;const c=s.default.getManager();this.iconSizeConstantName=r?"CONSTRAINT_PERMANENT_INDICATOR_PIXEL_SIZE":"CONSTRAINT_INDICATOR_PIXEL_SIZE",this.iconSize=c.getNumber(this.iconSizeConstantName),this.leaderColor=c.getColor("CONSTRAINT_INDICATOR_LEADER_COLOR"),this.borderColor=c.getColor("CONSTRAINT_INDICATOR_BORDER_COLOR");const l=E.Jq.CapabilitiesService.checkConstraintManagerCurrentlyEnabled();this.borderSize=l?c.getNumber("CONSTRAINT_INDICATOR_BORDER_SIZE"):0,this.borderSizeScaledToIconSize=this.borderSize/this.iconSize,this.userOffset=m.fromValues(0,0),this.worldGeometryDirection=n,this.model.constraints.forEach((e=>this.onConstraintAdded(e))),this.listenTo(this.viewer.getEventDispatcher(),d.VIEW_WILL_PICK,this.onViewWillDraw),this.showOnlyOverDefinedSubscription=this.model.showOnlyOverDefinedObservable().subscribe((()=>this.onShowOnlyOverdefinedChanged())),this.showAllConstraintsSubscription=this.model.showAllConstraintsObservable().subscribe((()=>this.onShowAllConstraintsChanged())),k(this.viewer)}showLeader(){this.hasLeader=!0}setUserOffset(e){this.userOffset=m.fromValues(e[0],-e[1]),this.invalidateDisplay()}getUserOffset(){return m.fromValues(this.userOffset[0],-this.userOffset[1])}setLocation(e){this.worldLocation=e,this.invalidateDisplay()}setMouseDelta(e){this.lastMouseDelta=e}onConstraintAdded(e){this.reference.constraintIds.indexOf(e.id)>=0&&this.addConstraintIcon(e)}invalidateDisplay(){this.lastCameraXform=null,this.lastProjectionXform=null,this.removeMeshIncrements(),(0,d.requestDraw)()}onConstraintStatusChanged(e){if(this.reference.constraintIds.indexOf(e.id)<0)return;const t=this.iconData.find((t=>t.id===e.id));t&&(t.solveStatus=e.displayStatus,t.constraintType=e.type,this.invalidateDisplay())}onReferenceConstraintIdsChanged(e,t){const i=(0,a.difference)(e,t),s=(0,a.difference)(t,e);i.length>0&&this.invalidateDisplay(),i.forEach((e=>{const t=this.iconData.findIndex((t=>t.id===e));t>-1&&this.iconData.splice(t,1)})),s.forEach((e=>{const t=this.model.getConstraint(e);this.addConstraintIcon(t)}))}onConstraintTypeChanged(e){const t=this.iconData.find((t=>t.id===e.id));t&&(t.constraintType=e.type,this.invalidateDisplay())}onConstraintBorderChanged(e){const t=this.iconData.find((t=>t.id===e.id));t&&(t.borderState=e.border,this.invalidateDisplay())}addIcon(e,t,i,s,n){const r=new F;r.id=e,t&&(r.constraintType=t),i&&(r.solveStatus=i),r.isExternal=!!s,n&&(r.borderState=n),this.iconData.push(r),this.invalidateDisplay()}getOffset(e,t){let i;if(this.isForInference)i=m.fromValues(1,-1);else if(this.lastMouseDelta)i=this.lastMouseDelta[0]>0?m.fromValues(-this.lastMouseDelta[1],this.lastMouseDelta[0]):m.fromValues(this.lastMouseDelta[1],-this.lastMouseDelta[0]);else{const t=e.projectWorldPointToViewport(this.worldLocation),s=I.S4.add(this.worldLocation,this.worldGeometryDirection,p.create()),n=e.projectWorldPointToViewport(s),r=I.S4.subtract(n,t,p.create());r[2]=0,i=I.S4.length(r)<x?m.fromValues(-1,1):m.fromValues(r[1],-r[0])}I.gv.normalize(i);const n=.5*t,r=function(e,t){return m.dot(m.fromValues(e,t),i)},a=-Math.abs(r(n,.5)),o=-Math.abs(r(n,-.5)),h=s.default.getManager(),c=(this.permanent?h.getNumber("PERMANENT_INFERENCE_OFFSET"):h.getNumber("TEMPORARY_INFERENCE_OFFSET"))-Math.min(a,o),l=-.99*(0,d.getHudLayerDepthRange)(e.getViewport())[1];return[i[0]*c,i[1]*c,l]}onDevicePixelRatioChanged(e){const t=s.default.getManager();this.iconSize=t.getNumber(this.iconSizeConstantName),k(this.viewer),this.invalidateDisplay()}onAppearanceConstantsUpdated(){k(this.viewer),this.leaderColor=s.default.getManager().getColor("CONSTRAINT_INDICATOR_LEADER_COLOR"),this.invalidateDisplay()}onViewWillDraw(e,t){if(!this.viewer.getResources().constraintAtlas)return;const i=e.getViewMatrixInverse(),s=e.getProjectionMatrix();if(this.lastCameraXform&&this.lastProjectionXform&&f.equals(i,this.lastCameraXform)&&f.equals(s,this.lastProjectionXform))return;this.lastCameraXform=i,this.lastProjectionXform=s;let n=e.projectWorldPointToViewport(this.worldLocation);n[2]=0;const r=p.fromValues(this.userOffset[0],this.userOffset[1],0);n=I.S4.add(n,r);const a=I.w$.translate(f.create(),n),o=this.iconSize;I.w$.scale(a,[o,o,1]);const h=this.getVisibleIcons(),c=this.getOffset(e,this.getDisplayedIconCount(h));I.w$.translate(a,c),a[12]=Math.floor(a[12]),a[13]=Math.floor(a[13]),this.leaderOffset=I.S4.subtract(I.S4.scale(r,-1/o,p.create()),c),this.leaderOffset[2]=0,this.setTransform(a),this.hasMeshIncrements()||this.updateIconGraphics(h),this.updateLeaderGraphics(h)}getNodePropertyType(e){let t=NaN;switch(e.solveStatus){case h.U5n.SOLVED:t=e.isExternal?d.sketchinformation.nodePropertiesTypes.EXTERNAL_AND_OK:d.sketchinformation.nodePropertiesTypes.OK;break;case h.U5n.BAD:t=d.sketchinformation.nodePropertiesTypes.OVERDEFINED;break;case h.U5n.DRIVEN:t=d.sketchinformation.nodePropertiesTypes.DRIVEN}return t}updateNodeProperties(e){if(this.isForInference)return void(this.nodeProperties=this.viewer.getResources().inferenceNodeProperties);this.nodeProperties=this.viewer.getResources().typeToNodeProperties[d.sketchinformation.nodePropertiesTypes.OK];let t=d.sketchinformation.nodePropertiesTypes.DRIVEN;const i=this;e.forEach((function(e){const s=i.getNodePropertyType(e);s<t&&(t=s)})),this.nodeProperties=this.viewer.getResources().typeToNodeProperties[t]}onShowOnlyOverdefinedChanged(){this.invalidateDisplay()}onShowAllConstraintsChanged(){this.model.constraintVisibilityOverride=[],this.invalidateDisplay()}showIconIfPermanent(e,t,i,s){return!!e&&(!!t&&(s||i&&e.solveStatus===h.U5n.BAD))}getVisibleIcons(){let e=[];if(this.isForInference)e=this.iconData;else{const t=this.reference.constraintVisibilities,i=this.reference.constraintIds;for(let s=0;s<i.length;s++){const n=this.iconData.find((e=>e.id===i[s]));if(!n)continue;if(0!==this.model.constraintVisibilityOverride.length&&!1===this.model.showAllConstraints){-1!==this.model.constraintVisibilityOverride.findIndex((e=>e===i[s]))&&e.push(n)}else this.permanent===this.showIconIfPermanent(n,t[s],this.model.showOnlyOverdefined,this.model.showAllConstraints)&&e.push(n)}}return(0,l.Z)(e,(function(e){return-2*e.solveStatus-(e.isExternal?1:0)}))}getDisplayedIconCount(e){return this.isExpanded?e.length:Math.min(e.length,A+1)}updateIconGraphics(e){if(!this.viewer.getResources().constraintAtlas)return;this.updateNodeProperties(e),this.viewer.getResources().constraintMaterial.ambientTexture=this.viewer.getResources().constraintAtlas.texture;const t=e.length>A+1&&!this.isExpanded,i=.5*-this.getDisplayedIconCount(e);e.forEach(((e,s)=>{if(e.selectionId=""+s,t){if(s>A)return void this.removeMeshIncrement(e.id);s===A&&(this.removeMeshIncrement(e.id),e=this.ellipsisIcon)}let n,r=e.selected;if(this.activated||(r=u.UKE.MUTED),e.id===P)n=w("...",h.U5n.SOLVED,r,!1);else{const t=e.constraintType,i=e.solveStatus,s=e.isExternal;n=B(t,i,r,s)}const a=this.viewer.getResources().constraintAtlas.getTextureCoords(n);if(!a)return;s+=s*this.borderSizeScaledToIconSize;const o=(0,d.createQuad)([i+s,-.5,0],[i+s+1,-.5,0],[i+s,.5,0],e.id,[a.lowS,a.highT],[a.highS,a.lowT]);this.updateMeshIncrement(e.id,e.selectionId,o,this.nodeProperties);const c=e.id+".border";if(!(e.borderState===L.REQUIRED))return void this.removeMeshIncrement(c);const l=this.borderSizeScaledToIconSize,g=l/2,p=[[i+s-l,-.5-g,0],[i+s+1+l,-.5-g,0],[i+s+1+g,-.5-l,0],[i+s+1+g,.5+l,0],[i+s+1+l,.5+g,0],[i+s-l,.5+g,0],[i+s-g,.5+l,0],[i+s-g,-.5-l,0]],m=(0,d.createLines)(p,c,this.borderColor,this.borderSize);this.updateMeshIncrement(c,d.NO_SELECTION_ID,m,this.borderProperties)}))}updateLeaderGraphics(e){if(this.hasLeader&&0!==e.length){const e=[0,0,0],t=this.leaderOffset,i=(0,d.createLine)(e,t,"leader",this.leaderColor,1);this.updateMeshIncrement("leader",d.NO_SELECTION_ID,i,this.leaderProperties)}}addConstraintIcon(e){e&&this.addIcon(e.id,e.type,e.displayStatus,e.isExternal,e.border)}onDelete(){if((0,r.yV)())return!1;const e=this.iconData.filter(W);return 0!==e.length&&this.deleteConstraints(e)}deleteConstraints(e){const t=(0,d.getDrawer)(),i=t.getUISelectionManager().getSelection(),s=t.getUISelectionManager().getHoveredSelection();let n=!1;if(e.forEach((e=>{const r=this.model.constraints.find((t=>t.id===e.id));r&&(i&&i.uiElement instanceof z&&i.uiElement.iconData.some((function(t){return t===e}))&&t.getUISelectionManager().setSelection(null),s&&s.uiElement instanceof z&&s.uiElement.iconData.some((function(t){return t===e}))&&t.getUISelectionManager().setHoveredSelection(null,{}),this.model.removeConstraints([r]),n=!0)})),n&&(this.deselectEntities(),!t.getUISelectionManager().getSelection())){const e=(0,g.uQ)().getLastMouseMovedEvent();t.doPick(e.offsetX,e.offsetY,!0,!0,null)}return n}expand(){this.isExpanded=!0,this.removeMeshIncrement(P),this.ellipsisIcon.selectionId="",this.invalidateDisplay()}activate(){this.activated||(this.activated=!0,this.invalidateDisplay())}isSelected(){return!!this.iconData.find((e=>e.selected===u.UKE.SELECTED))}select(e){if(e.selectionId===this.ellipsisIcon.selectionId)return void this.expand();const t=this.iconData.find((t=>t.selectionId===e.selectionId));if(t&&t.selected!==u.UKE.SELECTED){t.selected=u.UKE.SELECTED;E.Jq.CapabilitiesService.checkConstraintManagerCurrentlyEnabled()&&((0,u.xA2)().trigger(u.Mpj,e.sourcePick),(0,y.m)().trigger(C.C.CONSTRAINT_MANAGER_FOCUS_CONSTRAINT,t.id)),this.invalidateDisplay()}}deselectData(e){if(e&&e.selected===u.UKE.SELECTED){e.selected=u.UKE.NOT_SELECTED;E.Jq.CapabilitiesService.checkConstraintManagerCurrentlyEnabled()&&(0,y.m)().trigger(C.C.CONSTRAINT_MANAGER_UNFOCUS_CONSTRAINT,e.id),this.invalidateDisplay()}}deselect(e){const t=this.iconData.find((t=>t.selectionId===e.selectionId));this.deselectData(t)}deselectAll(){for(const e of this.iconData)this.deselectData(e)}hover(e){(0,o.Wf)().reset(),this.highlightConstraintIcon(e.selectionId)}highlightConstraintIcon(e){let t=null;if(e===this.ellipsisIcon.selectionId)t=this.ellipsisIcon;else{const i=Number(e);!isNaN(i)&&i>A&&!this.isExpanded&&this.expand(),t=this.iconData.find((t=>t.selectionId===e))}t&&t.selected===u.UKE.NOT_SELECTED&&(t.selected=u.UKE.PREHILITE,this.invalidateDisplay())}dehover(e){let t=null;t=e.selectionId===this.ellipsisIcon.selectionId?this.ellipsisIcon:this.iconData.find((t=>t.selectionId===e.selectionId)),t&&t.selected===u.UKE.PREHILITE&&(t.selected=u.UKE.NOT_SELECTED,this.invalidateDisplay())}getConstraint(e){const t=this.iconData.find((t=>t.selectionId===e));return t?this.model.getConstraint(t.id):null}deselectEntities(){Z()}selectEntities(e){this.deselectEntities();const t=this.model.id;let i;const s=this.getConstraint(e);if(s){i=s.referenceIds;for(const e of i){const i=this.model.getReference(e);i&&(0,r.XZ)(t,i,this.viewer)}}}getClearModelSelectionsOnPrehilite(){return!1}remove(){super.remove(),this.showOnlyOverDefinedSubscription.unsubscribe(),this.showAllConstraintsSubscription.unsubscribe(),this.changeSolveStatusSubscription.unsubscribe(),this.changeTypeSubscription.unsubscribe(),this.changeBorderSubscription.unsubscribe(),this.referenceIdsChangedSubscription.unsubscribe(),this.anchorChangedSubscription.unsubscribe()}resetLocation(e){e&&this.setLocation(e)}}function X(e,t,i){if(0===t.length)return null;const s=new z((0,c.bo)("inference",t),"inference",e,[0,0,0],!1,i);return s.isForInference=!0,s}function Z(){(0,o.Dk)().reset(),(0,o.wT)().reset()}},67777:function(e,t,i){i.d(t,{Bm:function(){return n},Fk:function(){return o},GH:function(){return s},Xh:function(){return r},di:function(){return a}});const s="sketch-constraints",n="mates",r="DIMENSION_ATLAS",a="MBD_ATLAS";class o{constructor(){this.creationPromises=new Map}getAtlas(e,t){let i=this.creationPromises.get(e);return i||(i=t(),this.creationPromises.set(e,i)),i}clearAtlas(e){this.creationPromises.delete(e)}}},64748:function(e,t,i){i.d(t,{L:function(){return d},_:function(){return b}});var s=i(17922),n=i(99826),r=i(90645),a=i(95417);if(666==i.j)var o=i(18265);if(666==i.j)var h=i(55858);if(666==i.j)var c=i(90342);var l=i(80462);const u=s.default.getManager(),d=new Map([[r.vn.X_ROTATION.toString(),r.tF.X],[r.vn.Y_ROTATION.toString(),r.tF.Y],[r.vn.Z_ROTATION.toString(),r.tF.Z]]),g=[{zeroAngle:[0,1,0],axis:[1,0,0]},{zeroAngle:[0,0,1],axis:[0,1,0]},{zeroAngle:[1,0,0],axis:[0,0,1]}],p=[r.vn.X_ROTATION,r.vn.Y_ROTATION,r.vn.Z_ROTATION],m=666==i.j?[[1,0,0],[0,1,0],[0,0,1]]:null,f=[r.vn.X_DIRECTION,r.vn.Y_DIRECTION,r.vn.Z_DIRECTION],I=666==i.j?[[[1,0,0],[0,1,0]],[[1,0,0],[0,0,1]],[[0,1,0],[0,0,1]]]:null,E=[r.vn.XY_PLANE,r.vn.XZ_PLANE,r.vn.YZ_PLANE],S=[{zeroAngle:[0,0,1],axis:[1,0,0]},{zeroAngle:[0,0,1],axis:[0,1,0]}],T=[r.vn.X_ROTATION,r.vn.Y_ROTATION],D=666==i.j?[[0,0,1]]:null,M=[r.vn.Z_DIRECTION],C=666==i.j?[]:null,y=666==i.j?[]:null,P=[{zeroAngle:[1,0,0],axis:[0,0,1]}],A=[r.vn.X_ROTATION],O=666==i.j?[[1,0,0],[0,1,0]]:null,v=[r.vn.X_DIRECTION,r.vn.Y_DIRECTION],R=666==i.j?[[[1,0,0],[0,1,0]]]:null,w=[r.vn.XY_PLANE],_=[{scaleDirection:[1,1,0],normal:[0,0,1]}],N=[r.vn.SCALING];class b extends(666==i.j?a.Manipulator:null){constructor(e,t,i){super(e,i),this.angularDirections=[],this.angularNames=[],this.linearDirections=[],this.linearNames=[],this.planarDirections=[],this.planarNames=[],this.scalingDirections=[],this.scalingNames=[],this.initialTransform=null,this.originalTransform=null,this.childComponents=[],this.scalingPreTransform=null,this.freeDragManipulator=null,this.linearManipulators=[],this.planarManipulators=[],this.angularManipulators=[],this.scalingManipulators=[],this.activeManipulator=null,this.preManipulationAngle=0,this.disableInactiveComponents=!0,this.disabledComponents=new Set,t||(t=n.Ak.FULL),i||(i={displayEditView:!1});let s,h=!0;switch(t){case n.Ak.FULL:this.angularDirections=g,this.angularNames=p,this.linearDirections=m,this.linearNames=f,this.planarDirections=I,this.planarNames=E;break;case n.Ak.PLANE:this.angularDirections=S,this.angularNames=T,this.linearDirections=D,this.linearNames=M,this.planarDirections=C,this.planarNames=y;break;case n.Ak.DRAG:this.angularDirections=[],this.angularNames=[],this.linearDirections=m,this.linearNames=f,this.planarDirections=I,this.planarNames=E,h=!1;break;case n.Ak.SKETCH:this.angularDirections=P,this.angularNames=A,this.linearDirections=O,this.linearNames=v,this.planarDirections=R,this.planarNames=w,this.scalingDirections=_,this.scalingNames=N;break;case n.Ak.EXPLODE_CONVENIENCE_MANIPULATOR:this.angularDirections=g,this.angularNames=p,this.linearDirections=m,this.linearNames=f,this.planarDirections=[],this.planarNames=[],h=!0}this.transform=o.create(),h&&(this.freeDragManipulator=new a.FreeDrag(this.viewer,i),this.freeDragManipulator.setId(r.vn.FREE_DRAG),this.freeDragManipulator.setTriadOwnerType(t),this.listenTo(this.freeDragManipulator,n.Wb.VALUE_CHANGED,this.onFreeDragChanged),this.listenTo(this.freeDragManipulator,n.Wb.MANIPULATION_STARTED,this.onFreeDragStarted),this.listenTo(this.freeDragManipulator,n.Wb.MANIPULATION_ENDED,this.onFreeDragEnded),this.childComponents.push(this.freeDragManipulator));const c=this,l=function(e){c.listenTo(c.linearManipulators[e],n.Wb.VALUE_CHANGED,(function(t,i){c.updateFromLinearManipulator(e,i)})),c.listenTo(c.linearManipulators[e],n.Wb.VALUE_EDITED,(function(){c.updateOnEditFromLinearManipulator(e)}))};for(s=0;s<this.linearDirections.length;++s){const e=new a.Linear(this.viewer,i);e.setVisualGap(this.freeDragManipulator?u.getNumber("MANIPULATOR_FREE_DRAG_RADIUS_PX"):0),e.setShaftLength(u.getNumber("MANIPULATOR_TRIAD_LINEAR_SHAFT_LENGTH_PX")),e.setFadeParameters(u.getNumber("MANIPULATOR_TRIAD_LINEAR_FADE_ANGLE_START"),u.getNumber("MANIPULATOR_TRIAD_LINEAR_FADE_ANGLE_END")),e.setId(this.linearNames[s]),e.setTriadOwnerType(t),this.linearManipulators.push(e),this.childComponents.push(e),l(s)}const d=function(e){c.listenTo(c.planarManipulators[e],n.Wb.VALUE_CHANGED,(function(t,i){c.updateFromPlanarManipulator(e,i)}))};for(s=0;s<this.planarDirections.length;++s){const e=new a.Planar(this.viewer,i);e.setVisualGap(u.getNumber("MANIPULATOR_TRIAD_PLANAR_OFFSET_PX")),e.setSideLength(u.getNumber("MANIPULATOR_TRIAD_PLANAR_SIDE_LENGTH_PX")),e.setId(this.planarNames[s]),e.setTriadOwnerType(t),this.planarManipulators.push(e),this.childComponents.push(e),d(s)}const b=function(e){c.listenTo(c.angularManipulators[e],n.Wb.VALUE_CHANGED,(function(){c.updateFromAngularManipulator(e)})),c.listenTo(c.angularManipulators[e],n.Wb.CACHE_TRANSFORM,(function(){c.initialTransform=o.clone(c.transform)})),c.listenTo(c.angularManipulators[e],n.Wb.VALUE_EDITED,(function(){c.updateOnEditFromAngularManipulator(e)}))},L=u.getNumber("MANIPULATOR_TRIAD_ANGULAR_GAP_PX")+u.getNumber("MANIPULATOR_FREE_DRAG_RADIUS_PX")+u.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX")+u.getNumber("MANIPULATOR_TRIAD_LINEAR_SHAFT_LENGTH_PX");for(s=0;s<this.angularDirections.length;++s){const e=new a.Angular(this.viewer,i);e.setRadialOffset(L),e.setFadeParameters(u.getNumber("MANIPULATOR_TRIAD_ANGULAR_FADE_ANGLE_START"),u.getNumber("MANIPULATOR_TRIAD_ANGULAR_FADE_ANGLE_END")),e.setId(this.angularNames[s]),e.setTriadOwnerType(t),this.angularManipulators.push(e),this.childComponents.push(e),b(s)}const F=function(e){c.listenTo(c.scalingManipulators[e],n.Wb.VALUE_CHANGED,(function(t,i){c.updateFromScalingManipulator(e,i)})),c.listenTo(c.scalingManipulators[e],n.Wb.VALUE_EDITED,(function(){c.updateOnEditFromScalingManipulator(e)}))};for(s=0;s<this.scalingDirections.length;++s){const e=new a.ScalingManipulator(this.viewer,i);e.setGapLength(u.getNumber("MANIPULATOR_TRIAD_LINEAR_SHAFT_LENGTH_PX")*Math.sqrt(2)),e.setHeadLength(u.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX")),e.setId(this.scalingNames[s]),e.setTriadOwnerType(t),this.scalingManipulators.push(e),this.childComponents.push(e),F(s)}for(s=0;s<this.childComponents.length;++s)this.listenTo(this.childComponents[s],n.Wb.MANIPULATION_STARTED,this.onManipulationStarted),this.listenTo(this.childComponents[s],n.Wb.MANIPULATION_ENDED,this.onManipulationEnded),this.listenTo(this.childComponents[s],a.UiEvents.COMMAND,this.onCommand),this.listenTo(this.childComponents[s],n.Wb.CLICKED,this.onManipulatorClicked),this.listenTo(this.childComponents[s],n.Wb.DOUBLE_CLICKED,this.onManipulatorDoubleClicked);this.preManipulationTransform=o.clone(this.transform),this.updateComponentManipulators()}onDevicePixelRatioChanged(e){for(let e=0;e<this.planarManipulators.length;++e)this.planarManipulators[e].setVisualGap(u.getNumber("MANIPULATOR_TRIAD_PLANAR_OFFSET_PX")),this.planarManipulators[e].setSideLength(u.getNumber("MANIPULATOR_TRIAD_PLANAR_SIDE_LENGTH_PX"));for(let e=0;e<this.linearManipulators.length;++e)this.linearManipulators[e].setVisualGap(this.freeDragManipulator?u.getNumber("MANIPULATOR_FREE_DRAG_RADIUS_PX"):0),this.linearManipulators[e].setShaftLength(u.getNumber("MANIPULATOR_TRIAD_LINEAR_SHAFT_LENGTH_PX"));const t=u.getNumber("MANIPULATOR_TRIAD_ANGULAR_GAP_PX")+u.getNumber("MANIPULATOR_FREE_DRAG_RADIUS_PX")+u.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX")+u.getNumber("MANIPULATOR_TRIAD_LINEAR_SHAFT_LENGTH_PX");for(let e=0;e<this.angularManipulators.length;++e)this.angularManipulators[e].setRadialOffset(t);for(let e=0;e<this.scalingManipulators.length;++e)this.scalingManipulators[e].setGapLength(u.getNumber("MANIPULATOR_TRIAD_LINEAR_SHAFT_LENGTH_PX")),this.scalingManipulators[e].setHeadLength(u.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX"))}remove(){super.remove();for(let e=0;e<this.childComponents.length;++e)this.childComponents[e].remove()}setIsEnabled(e){for(let t=0;t<this.childComponents.length;++t)this.childComponents[t].setIsEnabled(e)}setDisableInactiveComponents(e){this.disableInactiveComponents=e}setIsLocked(e){this.freeDragManipulator&&this.freeDragManipulator.setIsLocked(e)}onManipulationStarted(e){if(this.preManipulationTransform=o.clone(this.transform),this.initialTransform||(this.initialTransform=o.clone(this.transform)),this.originalTransform||(this.originalTransform=o.clone(this.transform)),this.activeManipulator=e,e!==this.freeDragManipulator&&this.disableInactiveComponents)for(let t=0;t<this.childComponents.length;++t)this.childComponents[t].setIsEnabled(e===this.childComponents[t]);for(let t=0;t<this.scalingManipulators.length;++t)this.scalingManipulators[t]!==e?(this.scalingManipulators[t].resetScale(),this.scalingPreTransform=void 0):this.scalingPreTransform||(this.scalingPreTransform=o.clone(this.transform));if(e instanceof a.Linear||e instanceof a.Planar)this.trigger(r.w0.TRANSLATION_START);else if(e instanceof a.Angular){const t=e.getAxis().direction;this.preManipulationAngle=e.getAngle();const i=[this.transform[12],this.transform[13],this.transform[14]];this.trigger(r.w0.ROTATION_START,i,t)}else e instanceof a.ScalingManipulator&&this.trigger(r.w0.SCALING_START);this.trigger(n.Wb.MANIPULATION_STARTED)}onManipulationEnded(){this.activeManipulator instanceof a.Angular?this.trigger(r.w0.ROTATION_END,this.transform):this.activeManipulator instanceof a.Linear||this.activeManipulator instanceof a.Planar?this.trigger(r.w0.TRANSLATION_END,this.transform):this.activeManipulator instanceof a.ScalingManipulator&&this.trigger(r.w0.SCALING_END),this.activeManipulator=null,this.preManipulationAngle=0;for(let e=0;e<this.childComponents.length;++e)this.disabledComponents.has(this.childComponents[e].getId())||this.childComponents[e].setIsEnabled(!0);this.updateComponentManipulators(),this.trigger(n.Wb.MANIPULATION_ENDED)}onCommand(e,t){if(t&&e){const i=[];i[r.tF.Origin]=[this.transform[12],this.transform[13],this.transform[14]],i[r.tF.X]=[this.transform[0],this.transform[1],this.transform[2]],i[r.tF.Y]=[this.transform[4],this.transform[5],this.transform[6]],i[r.tF.Z]=[this.transform[8],this.transform[9],this.transform[10]],this.trigger(r.w0.COMMAND,e,t.getId(),i)}}onManipulatorClicked(e){this.trigger(n.Wb.CLICKED,e)}onManipulatorDoubleClicked(e,t){this.trigger(r.w0.DOUBLE_CLICKED,e,t)}updateDefinition(e){this.transform=e,this.updateComponentManipulators()}getTranslationSinceManipulationBegan(){return l.jA.subtract(l.w$.multiplyVec4(this.transform,[0,0,0,1]),l.w$.multiplyVec4(this.preManipulationTransform,[0,0,0,1]))}getMouseRayForFreeDrag(){return this.activeManipulator instanceof a.FreeDrag?this.activeManipulator.getLastMouseRay():null}getActiveRotationAxis(){return this.activeManipulator instanceof a.Angular?this.activeManipulator.getAxis():null}getActiveRotationZeroAngleDirection(){return this.activeManipulator instanceof a.Angular?this.activeManipulator.getZeroAngleDirection():null}getActiveRotationAngle(){return this.activeManipulator instanceof a.Angular?this.activeManipulator.getAngle():0}setActiveRotationAngle(e){if(this.activeManipulator instanceof a.Angular){this.activeManipulator.setAngle(e);const t=l.w$.rotate(o.create(),e,this.activeManipulator.getAxis().direction),i=l.w$.toMat3(this.preManipulationTransform);l.xB.multiply(l.w$.toMat3(t),i,i);for(let e=0;e<3;++e){const t=l.S4.normalize([i[3*e+0],i[3*e+1],i[3*e+2]]);this.transform[4*e+0]=t[0],this.transform[4*e+1]=t[1],this.transform[4*e+2]=t[2]}this.updateComponentManipulators()}}updateFromLinearManipulator(e,t){this.updateOrigin(this.linearManipulators[e].getOffsetPosition()),this.trigger(r.w0.TRANSLATION_CHANGE,this.getTranslationSinceManipulationBegan(),this.linearManipulators[e],t)}updateOnEditFromLinearManipulator(e){const t=this.linearManipulators[e],i=l.S4.subtract(t.getEditOffsetPosition(),t.ray.point,h.create()),s=c.fromValues(i[0],i[1],i[2],0);this.updateOrigin(t.getEditOffsetPosition()),this.trigger(r.w0.TRANSLATION_EDIT,s)}updateFromPlanarManipulator(e,t){this.updateOrigin(this.planarManipulators[e].getOffsetPosition()),this.trigger(r.w0.TRANSLATION_CHANGE,this.getTranslationSinceManipulationBegan(),this.planarManipulators[e],t)}processUpdateFromAngularManipulator(e,t,i){const s=l.w$.rotate(o.create(),i,this.angularManipulators[e].getAxis().direction),n=l.w$.toMat3(t);l.xB.multiply(l.w$.toMat3(s),n,n);for(let e=0;e<3;++e)this.transform[4*e+0]=n[3*e],this.transform[4*e+1]=n[3*e+1],this.transform[4*e+2]=n[3*e+2];this.updateComponentManipulators()}updateFromAngularManipulator(e){this.processUpdateFromAngularManipulator(e,this.preManipulationTransform,this.angularManipulators[e].getAngle()),this.trigger(r.w0.ROTATION_CHANGE,this.getActiveRotationAngle(),this.getActiveRotationAxis(),this.getActiveRotationZeroAngleDirection())}updateOnEditFromAngularManipulator(e){const t=this.angularManipulators[e],i=t.getAxis().direction,s=[this.transform[12],this.transform[13],this.transform[14]],n=o.clone(this.transform),a=t.getEditAngleDisplacement();this.processUpdateFromAngularManipulator(e,this.transform,-a),this.trigger(r.w0.ROTATION_EDIT,n,a,i,s)}processScalingTransform(e,t){const i=o.fromValues(e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1);this.transform=l.w$.multiply(t,i,o.create())}updateFromScalingManipulator(e,t){this.processScalingTransform(this.scalingManipulators[e].getScale(),this.scalingPreTransform),this.trigger(r.w0.SCALING_CHANGE)}updateOnEditFromScalingManipulator(e){this.processScalingTransform(this.scalingManipulators[e].getScale(),this.scalingPreTransform),this.trigger(r.w0.SCALING_EDIT)}updateOrigin(e){for(let t=0;t<3;++t)this.transform[12+t]=e[t];this.updateComponentManipulators()}getOrigin(){return[this.transform[12],this.transform[13],this.transform[14]]}getOriginalOrigin(){return h.fromValues(this.originalTransform[12],this.originalTransform[13],this.originalTransform[14])}onFreeDragStarted(){this.trigger(r.w0.REPOSITION_START,this.transform)}onFreeDragChanged(e,t,i,s){this.updateOrigin(e),this.trigger(r.w0.REPOSITION,t,i,this.transform,s)}onFreeDragEnded(){this.trigger(r.w0.REPOSITION_END,this.transform)}updateComponentManipulators(){const e=h.fromValues(this.transform[12],this.transform[13],this.transform[14]);let t;this.freeDragManipulator&&(this.freeDragManipulator!==this.activeManipulator||this.freeDragManipulator.getIsLocked())&&this.freeDragManipulator.updateDefinition(e);const i=l.w$.toMat3(this.transform);for(t=0;t<this.linearManipulators.length;++t)if(this.linearManipulators[t]!==this.activeManipulator||this.linearManipulators[t].getIsLocked()){const s=l.S4.normalize(l.xB.multiplyVec3(i,this.linearDirections[t],h.create()));this.linearManipulators[t].updateDefinition(e,s)}for(t=0;t<this.planarManipulators.length;++t)if(this.planarManipulators[t]!==this.activeManipulator||this.planarManipulators[t].getIsLocked()){const s=l.S4.normalize(l.xB.multiplyVec3(i,this.planarDirections[t][0],h.create())),n=l.S4.normalize(l.xB.multiplyVec3(i,this.planarDirections[t][1],h.create()));this.planarManipulators[t].updateDefinition(e,s,n,[0,0])}for(t=0;t<this.angularManipulators.length;++t)(this.angularManipulators[t]!==this.activeManipulator||this.angularManipulators[t].getIsLocked())&&this.angularManipulators[t].updateDefinition(e,l.S4.normalize(l.xB.multiplyVec3(i,this.angularDirections[t].axis,h.create())),l.S4.normalize(l.xB.multiplyVec3(i,this.angularDirections[t].zeroAngle,h.create())),0);for(t=0;t<this.scalingManipulators.length;++t)if(this.scalingManipulators[t]!==this.activeManipulator||this.scalingManipulators[t].getIsLocked()){const s=l.S4.normalize(l.xB.multiplyVec3(i,this.scalingDirections[t].scaleDirection,h.create())),n=l.S4.normalize(l.xB.multiplyVec3(i,this.scalingDirections[t].normal,h.create()));this.scalingManipulators[t].updateDefinition(e,n,s)}}updateAngleRange(e,t){for(let i=0;i<this.angularManipulators.length;++i)this.angularManipulators[i].updateLimits(e,t)}updateEditAngleRange(e,t){for(let i=0;i<this.angularManipulators.length;++i)this.angularManipulators[i].updateEditLimits(e,t)}reset(e){this.originalTransform&&this.updateDefinition(o.clone(this.originalTransform));for(let e=0;e<this.linearManipulators.length;++e){const t=this.linearManipulators[e].initialRay;t&&(t.point=this.getOriginalOrigin())}e.removeEditViewAndHighlights()}disableComponent(e){this.disabledComponents.add(e)}disableXYManipulators(){this.linearManipulators.forEach((e=>{e.getId()!==r.vn.X_DIRECTION&&e.getId()!==r.vn.Y_DIRECTION||e.setIsEnabled(!1)})),this.angularManipulators.forEach((e=>{e.getId()!==r.vn.X_ROTATION&&e.getId()!==r.vn.Y_ROTATION||e.setIsEnabled(!1)})),this.scalingManipulators.forEach((e=>{e.setIsEnabled(!1)})),this.disableComponent(r.vn.X_DIRECTION),this.disableComponent(r.vn.Y_DIRECTION),this.disableComponent(r.vn.X_ROTATION),this.disableComponent(r.vn.Y_ROTATION)}enableXYManipulators(){this.disabledComponents.clear()}}},93103:function(e,t,i){i.d(t,{ZJ:function(){return d},_J:function(){return f},u1:function(){return m},zw:function(){return u}});var s=i(47178),n=i(17922);if(666==i.j)var r=i(18265);if(666==i.j)var a=i(55858);var o=i(72751),h=i(95417),c=i(80462);const l=n.default.getManager();var u;!function(e){e.MOUSE_ENTER="mouseenter:",e.MOUSE_MOVE="mousemove:",e.MOUSE_LEAVE="mouseleave:",e.DOUBLE_CLICK="doubleclick:",e.CLICK="click:",e.DRAG_START="dragstart:",e.DRAG="drag:",e.DRAG_STOP="dragstop:",e.SELECT="select:",e.DESELECT="deselect:",e.COMMAND="command:",e.LONG_PRESS_START="longpressstart:",e.LONG_PRESS_END="longpressend:",e.XR_DRAG_START="xrdragstart:",e.XR_DRAG="xrdrag:",e.XR_DRAG_STOP="xrdragstop:"}(u||(u={}));const d="",g=new h.IdManager;class p{constructor(e,t){this.nodeProperties=e,this.meshIncrement=t,this.selectionId=d}}class m extends(666==i.j?s.T:null){constructor(e,t){super(),this.viewer=e,this.SHARED_DELETION_DETAILS={wasHidden:!1,wasHiddenFromPick:!1,highlights:null},this.nameToMeshIncrement={},this.isHidden=!1,this.isTransparent=!1,this.transform=null,this.normalTransform=null,this.isBeingDragged=!1,this.id="",this.incrementRanges={},this.highlights=[],this.allocatedHighlights=[],this.hasBeenRemoved=!1,this.removeHighlightFromOccurrence=e=>{const t=""+this.graphicsOccurrenceId;let i=null,s=-1;for(let n=0;n<this.allocatedHighlights.length;++n){const r=this.allocatedHighlights[n];if(r.selectionId===t&&e===r.highlightType){i=r,s=n;break}}if(!i)return;this.allocatedHighlights.splice(s,1);const n=this.viewer.getHighlightManager(this.getUsage()),r=n.freeHighlightForSelection(i.highlightType,i.selectionId);if((0,h.idIsValid)(r)){const t=n.constructHighlightForTypeAndInstance(e,r);this.occurrenceData.updateOccurrenceHighlight(h.Action.REMOVE,t,this.getUsage())}},(0,h.viewerCheck)(e),this.sceneGraphId=t||h.MAIN_SCENEGRAPH_ID,this.collectionId=h.COLLECTION_ID_PREFIX+g.getId(),this.graphicsOccurrenceId=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(this.collectionId),this.meshOwnerId=(0,h.getNewOwnerId)(),this.occurrenceData=this.viewer.getOccurrenceDataManager().setOccurrenceTransform(this.graphicsOccurrenceId,r.create()),this.idManager=new h.NamedIdManager(h.IdSizes.ENTITY),this.viewer.addUIElement(this),this.listenTo(this.viewer.getEventDispatcher(),h.DEVICE_PIXEL_RATIO_CHANGED,this.onDevicePixelRatioChanged),this.occurrenceData.isUIElement=!0,this.occurrenceData.setIsolated(!0),this.occurrenceData.setCanIsolateChange(!1)}getDebugId(){return"UIElement"}getOccurrenceData(){return this.occurrenceData}setIsolated(e){this.occurrenceData.setIsolated(e)}onDevicePixelRatioChanged(e){}onAppearanceConstantsUpdated(){}remove(){this.hasBeenRemoved?o.log.warn("Attempted to remove ui element "+this.getDebugId()+"-"+this.meshOwnerId+" multiple times"):(this.hasBeenRemoved=!0,this.stopListening(),this.viewer&&this.viewer.removeUIElement(this),this.viewer.getOccurrenceDataManager().destroyOccurrenceData(this.graphicsOccurrenceId),this.viewer.getOccurrenceIdManager().removeName(this.collectionId),this.removeMeshIncrements(),this.freeAllocatedHighlights())}freeAllocatedHighlights(){const e=this.viewer.getHighlightManager(this.getUsage());for(let t=0;t<this.allocatedHighlights.length;++t){const i=this.allocatedHighlights[t];e.freeHighlightForSelection(i.highlightType,i.selectionId)}}getMeshManager(){return this.viewer.getUiResourceManager().getMeshManager()}getNode(){return this.viewer.getUiResourceManager().getNode(this.sceneGraphId)}getCollectionId(){return this.collectionId}removeMeshIncrements(){for(const e in this.nameToMeshIncrement)this.removeMeshIncrement(e);this.nameToMeshIncrement={},this.viewer.requestDraw()}hasMeshIncrements(){return!(0,h.isMapEmpty)(this.nameToMeshIncrement)}containsMeshIncrementWithName(e){return this.nameToMeshIncrement.hasOwnProperty(e)}getInstantiatedMeshIncrement(e){return this.nameToMeshIncrement[e]||null}getMeshIncrement(e){return this.getInstantiatedMeshIncrement(e)?.meshIncrement}shouldBeClearedWithSelections(){return!0}getId(){return this.id}setId(e){this.id=e}isVisibleToUser(){return!this.isTransparent&&!this.isHidden}hideIncrements(){for(const e in this.nameToMeshIncrement)this.hideInstantiatedMeshIncrement(e,this.nameToMeshIncrement[e])}showIncrements(){for(const e in this.nameToMeshIncrement)this.showInstantiatedMeshIncrement(e,this.nameToMeshIncrement[e])}hideIncrement(e){const t=this.nameToMeshIncrement[e];t&&this.hideInstantiatedMeshIncrement(e,t)}showIncrement(e){const t=this.nameToMeshIncrement[e];t&&this.showInstantiatedMeshIncrement(e,t)}hide(){(0,h.viewerCheck)(this.viewer),this.isVisibleToUser()&&this.hideIncrements(),this.isHidden=!0,this.viewer.requestDraw()}show(){(0,h.viewerCheck)(this.viewer);const e=this.isVisibleToUser();this.isHidden=!1,!e&&this.isVisibleToUser()&&this.showIncrements(),this.viewer.requestDraw()}makeTransparent(){this.isVisibleToUser()&&this.hideIncrements(),this.isTransparent=!0}makeOpaque(){const e=this.isVisibleToUser();this.isTransparent=!1,!e&&this.isVisibleToUser()&&this.showIncrements()}isInteractionEnabled(){return!0}getClearModelSelectionsOnPrehilite(){return!0}getTransform(){return this.transform}setTransform(e){e?(this.transform=r.clone(e),this.viewer.getOccurrenceDataManager().setOccurrenceTransform(this.graphicsOccurrenceId,e)):(this.transform=null,this.viewer.getOccurrenceDataManager().setOccurrenceTransform(this.graphicsOccurrenceId,r.create()))}transformPoint(e){return this.transform?c.w$.multiplyVec3(this.transform,e,a.create()):a.clone(e)}getSelection(e,t){if(this.graphicsOccurrenceId!==e)return o.log.warn("An attempt was made to get a selection from a ui element with the wrong occurrence id"),null;const i=this.idManager.getNameForId(t);if(!i)return null;const s=this.nameToMeshIncrement[i];return s?new h.UISelection(this,s.selectionId,i):null}canPickThrough(){return!1}getModelSelection(e){return null}getPickPriority(e){return null}getUsage(){return h.BTGraphicsUsage.BASE}setIncrementPickId(e,t){t.pickId=this.idManager.getOrCreateIdForName(e)}updateMeshIncrement(e,t,i,s){if(!s)return;f(i);const n=this.removeMeshIncrement(e);i.id=e,this.setIncrementPickId(e,i);const r=new p(s,i);r.selectionId=t;const a=this.getMeshManager().addMeshIncrement(i,this.meshOwnerId);if(a){let e=this.incrementRanges[s.id];if(!e){this.incrementRanges[s.id]=e=new h.IncrementRanges(this.getDebugId()+" - "+s.toString(!0));const t=new h.Style;this.getNode().addOccurrenceGeometryToNode(s,this.occurrenceData,t,e)}e.onIncrementAdded(a)}this.nameToMeshIncrement[e]=r,n&&(n.wasHidden&&this.hideIncrement(e),n.wasHiddenFromPick&&this.hideIncrementFromPick(e),n.highlights&&n.highlights.forEach((t=>{this.addHighlightToIncrement(e,t)}))),this.viewer.requestDraw()}updateIncrementAttribute(e,t,i){const s=this.nameToMeshIncrement[e];if(s){const e=this.getMeshManager().getMeshForIncrement(s.meshIncrement);e&&e.updateIncrementAttribute(t,s.meshIncrement.getFullId(),i)}}removeMeshIncrement(e){const t=this.nameToMeshIncrement[e];let i=null;return t&&(i=this.removeInstantiatedMeshIncrement(e,t),this.viewer.requestDraw()),i}removeInstantiatedMeshIncrement(e,t){this.idManager.removeName(e);const i=this.getMeshManager().getIncrementDetails(e,this.meshOwnerId),s=this.SHARED_DELETION_DETAILS;if(i){const e=this.getUsage();s.wasHidden=this.occurrenceData.isIncrementHidden(i,e),s.wasHiddenFromPick=this.occurrenceData.isIncrementHiddenFromPick(i,e),s.highlights=this.occurrenceData.getEntityHighlights(i,e),s.highlights&&this.occurrenceData.removeEntityHighlights(i,e)}else s.wasHidden=!1,s.wasHiddenFromPick=!1,s.highlights=null;if(this.getMeshManager().removeMeshIncrement(e,this.meshOwnerId),i){const e=this.incrementRanges[t.nodeProperties.id];e&&(e.onIncrementRemoved(i),e.isEmpty()&&(this.getNode().removeOccurrenceFromNode(t.nodeProperties,this.graphicsOccurrenceId),delete this.incrementRanges[t.nodeProperties.id]))}return delete this.nameToMeshIncrement[e],s}hideInstantiatedMeshIncrement(e,t){const i=this.getMeshManager().getIncrementDetails(e,this.meshOwnerId);i&&this.occurrenceData.hideIncrement(i,this.getUsage())}showInstantiatedMeshIncrement(e,t){const i=this.getMeshManager().getIncrementDetails(e,this.meshOwnerId);i&&this.occurrenceData.showIncrement(i,this.getUsage())}hideIncrementFromPick(e){const t=this.getMeshManager().getIncrementDetails(e,this.meshOwnerId);t&&this.occurrenceData.hideIncrementFromPick(t,this.getUsage())}addHighlight(e){(0,h.addHighlightToList)(e,this.highlights)}removeHighlight(e){return(0,h.removeHighlightFromList)(e,this.highlights,!1)>=0}isHighlighted(){return this.highlights.length>0}getHighlight(){return this.isHighlighted()?this.highlights[this.highlights.length-1]:null}triggerMouseEnter(e,t){this.isBeingDragged||this.trigger(u.MOUSE_ENTER+e.selectionId,e,t)}triggerMouseMove(e,t){this.isBeingDragged||this.trigger(u.MOUSE_MOVE+e.selectionId,e,t)}triggerMouseLeave(e,t){this.isBeingDragged||this.trigger(u.MOUSE_LEAVE+e.selectionId,e,t)}triggerClick(e,t){const i={requestSelectedStatus:!1};return this.trigger(u.CLICK+e.selectionId,e,t,i),i.requestSelectedStatus}triggerDoubleClick(e,t){const i={requestSelectedStatus:!1};return this.trigger(u.DOUBLE_CLICK+e.selectionId,e,t,i),i.requestSelectedStatus}triggerSelect(e){this.trigger(u.SELECT+e.selectionId,e)}triggerDeselect(e){this.trigger(u.DESELECT+e.selectionId,e)}triggerDragStart(e,t){const i={requestDrag:!1};return this.trigger(u.DRAG_START+e.selectionId,e,t,i),this.isBeingDragged=i.requestDrag,i.requestDrag}triggerDrag(e,t){this.trigger(u.DRAG+e.selectionId,e,t)}triggerDragStop(e,t){this.trigger(u.DRAG_STOP+e.selectionId,e,t),this.isBeingDragged=!1}triggerXrDragStart(e,t){const i={requestDrag:!1};return this.trigger(u.XR_DRAG_START+e.selectionId,e,t,i),this.isBeingDragged=i.requestDrag,i.requestDrag}triggerXrDrag(e,t){this.trigger(u.XR_DRAG+e.selectionId,e,t)}triggerXrDragStop(e,t){this.trigger(u.XR_DRAG_STOP+e.selectionId,e,t),this.isBeingDragged=!1}triggerLongPressStart(e,t){this.trigger(u.LONG_PRESS_START+e.selectionId,e,t)}triggerLongPressEnd(e,t){this.trigger(u.LONG_PRESS_END+e.selectionId,e,t)}addHighlightToIncrement(e,t){const i=this.getMeshManager().getIncrementDetails(e,this.meshOwnerId);i&&(this.occurrenceData.updateEntityHighlight(h.Action.ADD,t,i,this.getUsage()),this.viewer.requestDraw())}removeHighlightFromIncrement(e,t){const i=this.getMeshManager().getIncrementDetails(e,this.meshOwnerId);i&&(this.occurrenceData.updateEntityHighlight(h.Action.REMOVE,t,i,this.getUsage()),this.viewer.requestDraw())}addNewHighlightToIncrement(e,t){const i=e+"."+this.graphicsOccurrenceId,s=this.viewer.getHighlightManager(this.getUsage()).createHighlightForSelection(t,i);return this.addHighlightToIncrement(e,s),this.allocatedHighlights.push({selectionId:i,highlightType:t}),s}addNewHighlightToOccurrence(e){const t=""+this.graphicsOccurrenceId,i=this.viewer.getHighlightManager(this.getUsage()).createHighlightForSelection(e,t);this.occurrenceData.updateOccurrenceHighlight(h.Action.ADD,i,this.getUsage()),this.allocatedHighlights.push({selectionId:t,highlightType:e})}preventsSketching(){return!0}getFitBounds(){return null}onViewWillDraw(e,t){}isViewManipulator(){return!1}onDefaultUnitsChanged(e){}onIsolateChanged(){}isDimension(){return!1}isManipulator(){return!1}isAnnotation(){return!1}onHighlightColorUpdated(){}shouldTreatCtrlClickAsClick(e){return!1}}function f(e){if(e.primitiveType===h.PrimitiveType.TRIANGLES||e.primitiveType===h.PrimitiveType.TRIANGLE_STRIP){if(e.colors||(0,h.addColorToIncrement)(l.getColor("DEFAULT_TRIANGLE_COLOR"),e),!e.textureCoordinates){const t=[0,0];(0,h.addTextureCoordinateToIncrement)(t,e)}e.normals||(0,h.addNormalToIncrement)([0,0,1],e)}else e.primitiveType===h.PrimitiveType.LINES?(e.colors||(0,h.addColorToIncrement)(l.getColor("DEFAULT_MATERIAL_COLOR"),e),e.primitiveSizes||(0,h.addSizeToIncrement)(l.getNumber("DEFAULT_LINE_WIDTH"),e),e.primitiveStyles||(0,h.addStyleToIncrement)(l.getStipple("DEFAULT_LINE_STIPPLE"),e)):e.primitiveType===h.PrimitiveType.POINTS&&(e.colors||(0,h.addColorToIncrement)(l.getColor("DEFAULT_MATERIAL_COLOR"),e),e.primitiveSizes||(0,h.addSizeToIncrement)(l.getNumber("DEFAULT_POINT_SIZE"),e),e.primitiveStyles||(0,h.addStyleToIncrement)(l.getPointFont("DEFAULT_POINT_FONT"),e))}},55718:function(e,t,i){i.d(t,{E:function(){return n},Q:function(){return s}});const s="uielement.";function n(e){return!!e&&0===e.indexOf(s)}},63971:function(e,t,i){i.d(t,{i:function(){return n},z:function(){return r}});var s=i(45454);class n{constructor(e,t,i){this.selectionId=t,this.meshIncrementId=i,this.sourcePick=null,this.uiElement=e}equals(e){return!!e&&(this.uiElement===e.uiElement&&this.selectionId===e.selectionId)}hideFromPick(){this.uiElement.hideIncrementFromPick(this.meshIncrementId)}canPickThrough(){return this.uiElement.canPickThrough()}getModelSelection(){return this.uiElement.getModelSelection(this)}getPickPriority(){return this.uiElement.getPickPriority(this)}isInteractionEnabled(){return this.uiElement.isInteractionEnabled()}preventsSketching(){return this.uiElement.preventsSketching()}}class r{constructor(){this.hoveredSelection=null,this.selection=null}removeSelectionForUiElement(e){this.hoveredSelection&&this.hoveredSelection.uiElement===e&&(this.hoveredSelection.uiElement.triggerMouseLeave(this.hoveredSelection,{}),this.hoveredSelection=null),this.selection&&this.selection.uiElement===e&&(this.selection=null)}reset(){this.hoveredSelection=null,this.selection=null}getHoveredSelection(){return this.hoveredSelection}isHoveringOverViewManipulator(){return!!this.hoveredSelection&&!!this.hoveredSelection.uiElement&&this.hoveredSelection.uiElement.isViewManipulator()}getSelection(){return this.selection}uiSelectionShouldBeClearedWithSelections(){return!!this.selection&&!!this.selection.uiElement&&!!this.selection.uiElement.shouldBeClearedWithSelections()}overrideHoveredSelection(e){this.hoveredSelection&&e&&this.hoveredSelection.equals(e)||!this.hoveredSelection&&!e||(this.hoveredSelection=e)}setHoveredSelection(e,t){this.hoveredSelection&&e&&this.hoveredSelection.equals(e)||!this.hoveredSelection&&!e?this.hoveredSelection&&this.hoveredSelection.uiElement.triggerMouseMove(this.hoveredSelection,t):(this.hoveredSelection&&(t.nextSelection=e,this.hoveredSelection.uiElement.triggerMouseLeave(this.hoveredSelection,t)),this.hoveredSelection=e,this.hoveredSelection&&this.hoveredSelection.uiElement.triggerMouseEnter(this.hoveredSelection,t))}setSelection(e){(this.selection||e)&&(this.selection&&this.selection.uiElement.triggerDeselect(this.selection),e&&e.equals(this.selection)?this.selection=null:(this.selection=e,this.selection&&((0,s.vi)().reset(),this.selection.uiElement.triggerSelect(this.selection))))}processUiPick(e,t){let i=null,s=null,n=!1;e.isUIPick()&&e.uiSelection.isInteractionEnabled()&&(s=e.uiSelection),this.setHoveredSelection(s,t),s&&t.click?n=s.uiElement.triggerClick(s,t):s&&t.doubleClick&&(n=s.uiElement.triggerDoubleClick(s,t)),n&&(i=s);return(t.click||t.doubleClick)&&!(s&&!n)&&this.setSelection(i),!!s}handleEmptyUiPick(e,t){e?this.setHoveredSelection(null,t):t.click&&this.setSelection(null)}}},31126:function(e,t,i){i.d(t,{B2:function(){return pe},BG:function(){return W},C2:function(){return j},CF:function(){return f},Db:function(){return K},Dy:function(){return me},Dz:function(){return P},EE:function(){return u},EI:function(){return H},Ec:function(){return V},Es:function(){return ee},HB:function(){return C},HK:function(){return O},HL:function(){return de},Ir:function(){return De},J5:function(){return I},Jb:function(){return y},Lf:function(){return ie},Mz:function(){return te},NC:function(){return b},NP:function(){return X},Pm:function(){return q},R:function(){return ne},Rg:function(){return Z},SU:function(){return B},Sd:function(){return A},Wj:function(){return J},XD:function(){return z},XM:function(){return oe},Z:function(){return m},Z$:function(){return fe},_I:function(){return g},bN:function(){return Me},dV:function(){return ge},et:function(){return _},fA:function(){return U},hW:function(){return Y},iq:function(){return se},jo:function(){return D},km:function(){return x},n9:function(){return c},o0:function(){return k},o3:function(){return le},ow:function(){return G},p7:function(){return ue},pc:function(){return E},q7:function(){return S},rS:function(){return Se},sW:function(){return L},tj:function(){return w},u4:function(){return M},uP:function(){return p},uc:function(){return d},vm:function(){return R},x4:function(){return he},z4:function(){return Te},zF:function(){return Q}});var s=i(72751),n=i(26738),r=i(13469),a=i(1630),o=i(95417),h=i(17922);function c(e,t){t&&e.children.push(t.makeSceneDebugObject())}let l=!0;var u,d;function g(e){switch(e){case u.HIDDEN:return"hidden";case u.VISIBLE:return"visible"}return"unknown"}function p(e){l=e}function m(){return l}function f(){return(0,a.isPlatformWindows)()||(0,a.isPlatformMac)()}function I(e){if(!e)return!1;const t=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT);return!!t&&t.precision>0}function E(e){if((0,a.isPlatformMac)()){const t=(0,o.getRendererInfo)(e);if(new RegExp(".*intel.*[3|4]000.*","i").test(t.glRenderer))return!1}return I(e)}function S(e){return Math.ceil(e.length/5)}!function(e){e[e.HIDDEN=0]="HIDDEN",e[e.VISIBLE=1]="VISIBLE"}(u||(u={})),function(e){e[e.CULLED=0]="CULLED",e[e.VISIBLE=1]="VISIBLE"}(d||(d={}));const T={};function D(e,t){T[e]=t}function M(){return T}function C(){return(0,o.getActiveViewer)()}function y(e){return T[e]}function P(e){delete T[e]}function A(e){for(const t in T)T[t].requestDrawUsingTimer(null,null,e)}function O(e){for(const t in T)T[t].requestDrawUsingAnimationFrame(null,null,e)}let v=666==i.j?A:null;function R(e){return v(e)}function w(){R(!0)}function _(){A()}window.requestAnimationFrame&&(v=O);let N=!1;function b(e,t){N=t}function L(){return N}let F=!1;function x(e){F=e}function B(){return F}function V(){return L()||B()}function U(e){const t=new Uint8Array(4);return t[0]=e>>>24&255,t[1]=e>>>16&255,t[2]=e>>>8&255,t[3]=255&e,t}function G(e){const t=1/255;return[(e>>>24&255)*t,(e>>>16&255)*t,(e>>>8&255)*t,(255&e)*t]}function H(e,t,i,s){return(e<<24)+(t<<16)+(i<<8)+s}const k=666==i.j?[0,0,0,0]:null,W=666==i.j?-1:null,z=666==i.j?[1,1,1,0]:null;function X(e,t){let i;return t?(i=(e[2]<<16)+(e[1]<<8)+e[0],i/16777215):(i=(e[1]<<8)+e[0],i/16383)}function Z(e,t){return 255*z[3]===e[3]?W:X(e,t)}function q(e,t){return 0===e[3]?null:X(e,t)*Math.PI}function Y(e){let t;for(t in e)return!1;return!0}function K(e){return[(0,o.clamp)(Math.floor(255*e[0]),0,255),(0,o.clamp)(Math.floor(255*e[1]),0,255),(0,o.clamp)(Math.floor(255*e[2]),0,255),(0,o.clamp)(Math.floor(255*e[3]),0,255)]}function j(e){return[(0,o.clamp)(Math.floor(255*e[0]),0,255),(0,o.clamp)(Math.floor(255*e[1]),0,255),(0,o.clamp)(Math.floor(255*e[2]),0,255),255]}function Q(e){return[e[0]/255,e[1]/255,e[2]/255,e[3]/255]}window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)};let $=null;function J(){return $()}function ee(e){return J()-e}function te(e,t){const i=new Float32Array(e.length+t.length);return i.set(e),i.set(t,e.length),i}function ie(e,t){const i=new Uint8Array(e.length+t.length);return i.set(e),i.set(t,e.length),i}function se(e,t){return 0===e.length?[]:0===t.length?e:1===e.length&&1===t.length?e[0]===t[0]?[]:e:(0,r.difference)(e,t)}function ne(e,t){const i=new Set;return e.forEach((e=>{t.has(e)||i.add(e)})),i}$=window.performance&&window.performance.now?function(){return window.performance.now()}:function(){return(new Date).getTime()};let re=!1,ae=!1;function oe(){return re}function he(){return ae}const ce=666==i.j?["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"]:null;function le(e,t){if(e.length<3)return s.log.warn("Attempting to create a color string with a color of insufficient length"),"#000000";let i="#";for(let s=0;s<3;++s){const n=t?e[s]:0|Math.round(255*e[s]);i+=ce[n>>4&15],i+=ce[15&n]}return i}function ue(e){const t=[];for(let i=0;i<e.length;++i){const s=!0;t.push(le(e[i],s))}return t}function de(e,t,i){return e+"."+t+"."+i}function ge(e){const t=e.split(".");return t.length>1?t[1]:""}function pe(){n.Jq.CapabilitiesService.isFeatureQLVFacePatternEnabled().then((function(e){re=!0===e})),n.Jq.CapabilitiesService.isLongPressHandlerEnabled().then((function(e){ae=!0===e})),n.Jq.CapabilitiesService.checkLockBranchFunctionalityCurrentlyEnabled(),n.Jq.CapabilitiesService.checkNotifyThirdPartiesToSaveCurrentlyEnabled()}function me(e,t,i){const s=4*t,n=new Uint8Array(s),r=Math.floor(i/2);for(let t=0;t<r;++t){const r=e.subarray(t*s,(t+1)*s),a=i-1-t,o=e.subarray(a*s,(a+1)*s);n.set(o),o.set(r),r.set(n)}}function fe(e){const t=document.createElement("canvas"),i=t.getContext("2d");t.width=e.width,t.height=e.height;const s=i.createImageData(e.width,e.height);return s.data.set(e.data),i.putImageData(s,0,0),new Promise(((e,i)=>{t.toBlob((t=>{t?e(t):i("Canvas did not return blob")}),"image/jpeg",h.default.getManager().getNumber("MARKUP_JPG_IMAGE_QUALITY_VALUE"))}))}const Ie=new ArrayBuffer(1e4),Ee=new Uint8Array(Ie);function Se(e,t){const i=new Uint8Array(e);for(let e=0;e<t;e+=Ee.length){let t=Ee;t.length>i.length-e&&(t=new Uint8Array(Ie,0,i.length-e)),i.set(t,e)}}function Te(e,t){return{text:e+": ("+t+")",children:[]}}function De(e,t,i){for(const s in t)!t.hasOwnProperty(s)||i&&i.hasOwnProperty(s)||e.push(Te(s,t[s]));return e}function Me(e,t){return{text:t,children:De([],e)}}},66115:function(e,t,i){i.d(t,{GB:function(){return o},KX:function(){return l},P6:function(){return g},Xs:function(){return m},aN:function(){return h},f1:function(){return p},iM:function(){return r},lp:function(){return u},py:function(){return d},uQ:function(){return a},x:function(){return c}});var s=i(21324),n=i(95417);function r(e){const t=a();t&&t.setForceHideInteriorSelections(e)}function a(){return(0,s.uQ)()}function o(e){const t=a();t&&t.setBaseHighlightsEnabled(e)}function h(){const e=a();return!!e&&!!e.getSketch()}function c(){return a().getOccurrenceDataManager()}function l(){return a().getSceneGraphs()}const u=function(){a()&&a().onBeforePrint()},d=function(){a()&&a().onAfterPrint()};function g(e){const t=a();return t?t.getCanvasCoordinateFromEvent(e):[e.pageX,e.pageY]}function p(e){const t=(0,n.getCurrentActiveViewerSet)();return t?e?t.sheetMetalViewer:a():null}function m(e){if(!(0,n.getCurrentActiveViewerSet)())return null;const t=p(e.useFlattenedView);return t?e.usePrint?t.retrievePrintedCanvasPixels(e):t.retrieveViewportAsImage(e):null}},52728:function(e,t,i){i.d(t,{G$:function(){return p},TC:function(){return d},cv:function(){return f},fT:function(){return m},jB:function(){return E},w5:function(){return g}});var s=i(25889),n=i(83057),r=i(95417),a=i(8473),o=i(35692);let h=null,c=null;const l="#canvas",u="previous-version-canvas",d=666==i.j?`#${u}`:null;function g(){return h}function p(e){if(e=e||{},h)c=null,o(l).replaceWith(h.mainViewer.$el),h.previousVersionViewer?.$el&&o(d).replaceWith(h.previousVersionViewer.$el),h.mainViewer.onViewerReactivated(),h.previousVersionViewer&&h.previousVersionViewer.onViewerReactivated(),h.sheetMetalViewer&&h.sheetMetalViewer.onViewerReactivated();else{const t={mainViewer:new r.Viewer({el:l,contextMenuMgr:e.contextMenuMgr})};if(t.mainViewer.getWebGlSupport()!==a.c.SUPPORTED)return t;if(e.createSheetMetalViewer){t.partStudioToAlternateMapping=new s.e;const i=o("<canvas/>",{id:"sheetmetalcanvas","data-view-shown":"unknown"});t.sheetMetalViewer=new r.Viewer({el:i,dontSetActive:!0,isForFlattenedDisplay:!0,hidden:!0,contextMenuMgr:e.contextMenuMgr})}h=t}return h}function m(e,t){if(e.previousVersionViewer)return;const i=o("<canvas/>",{id:u,"data-view-shown":"unknown"});e.previousVersionViewer=new r.Viewer({el:i,dontSetActive:!0,isForFlattenedDisplay:!1,isForPreviousVersionDisplay:!0,hidden:!1,contextMenuMgr:t}),e.mainViewer.pairedViewer=e.previousVersionViewer,e.previousVersionViewer.pairedViewer=e.mainViewer,e.previousVersionViewer.setSuppressModelSelection(!0)}function f(e){c=e}function I(e){e&&(e.setActiveElement(null,n.GNh.UNKNOWN,!0,null,null),e.setUnitsReceived(!1),e.$el.detach())}function E(){h&&(I(h.mainViewer),I(h.sheetMetalViewer),I(h.previousVersionViewer))}},29500:function(e,t,i){if(i.d(t,{AA:function(){return h},CR:function(){return l},Dx:function(){return o},Fo:function(){return c},aD:function(){return u},tG:function(){return a}}),666==i.j)var s=i(97340);if(666==i.j)var n=i(28972);let r=null;class a{constructor(){this._zoomModifierEnabled=!1,this.zoomModeEnabledSubject=new s.X(!1)}get zoomModeEnabledObservable(){return this.zoomModeEnabledSubject.asObservable().pipe((0,n.x)())}get zoomModeEnabled(){return this.zoomModeEnabledSubject.getValue()}set zoomModeEnabled(e){this.zoomModeEnabledSubject.next(e)}}function o(){return r||(r=new a),r}function h(){const e=o().zoomModeEnabled;o().zoomModeEnabled=!e}function c(){return o().zoomModeEnabled}function l(e){o().zoomModeEnabled=e}function u(){return c()}}}]);